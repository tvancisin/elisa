var H4=Object.defineProperty;var GI=n=>{throw TypeError(n)};var Z4=(n,a,u)=>a in n?H4(n,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[a]=u;var qI=(n,a,u)=>Z4(n,typeof a!="symbol"?a+"":a,u),Rb=(n,a,u)=>a.has(n)||GI("Cannot "+u);var zl=(n,a,u)=>(Rb(n,a,"read from private field"),u?u.call(n):a.get(n)),Nm=(n,a,u)=>a.has(n)?GI("Cannot add the same private member more than once"):a instanceof WeakSet?a.add(n):a.set(n,u),Db=(n,a,u,m)=>(Rb(n,a,"write to private field"),m?m.call(n,u):a.set(n,u),u),HI=(n,a,u)=>(Rb(n,a,"access private method"),u);(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))m(y);new MutationObserver(y=>{for(const x of y)if(x.type==="childList")for(const E of x.addedNodes)E.tagName==="LINK"&&E.rel==="modulepreload"&&m(E)}).observe(document,{childList:!0,subtree:!0});function u(y){const x={};return y.integrity&&(x.integrity=y.integrity),y.referrerPolicy&&(x.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?x.credentials="include":y.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function m(y){if(y.ep)return;y.ep=!0;const x=u(y);fetch(y.href,x)}})();const ZI=!1;var E2=Array.isArray,W4=Array.prototype.indexOf,A2=Array.from,X4=Object.defineProperty,a_=Object.getOwnPropertyDescriptor,MC=Object.getOwnPropertyDescriptors,Y4=Object.prototype,K4=Array.prototype,I2=Object.getPrototypeOf,WI=Object.isExtensible;function J4(n){return n()}function ww(n){for(var a=0;a<n.length;a++)n[a]()}const ua=2,CC=4,Bv=8,M2=16,Zl=32,$d=64,ky=128,xs=256,Oy=512,No=1024,$a=2048,nu=4096,$l=8192,Nv=16384,Q4=32768,C2=65536,eO=1<<19,PC=1<<20,Tw=1<<21,vd=Symbol("$state"),tO=Symbol("");function zC(n){return n===this.v}function nO(n,a){return n!=n?a==a:n!==a||n!==null&&typeof n=="object"||typeof n=="function"}function RC(n){return!nO(n,this.v)}function iO(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function rO(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function oO(n){throw new Error("https://svelte.dev/e/effect_orphan")}function sO(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function aO(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function lO(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function cO(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let k_=!1,uO=!1;function hO(){k_=!0}const fO=1,dO=2,pO=16,mO=1,_O=2,es=Symbol(),gO="http://www.w3.org/1999/xhtml";function yO(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let gr=null;function XI(n){gr=n}function DC(n,a=!1,u){var m=gr={p:gr,c:null,d:!1,e:null,m:!1,s:n,x:null,l:null};k_&&!a&&(gr.l={s:null,u:null,r1:[],r2:Ad(!1)}),HC(()=>{m.d=!0})}function LC(n){const a=gr;if(a!==null){const E=a.e;if(E!==null){var u=cr,m=lr;a.e=null;try{for(var y=0;y<E.length;y++){var x=E[y];Yc(x.effect),Ga(x.reaction),Uv(x.fn)}}finally{Yc(u),Ga(m)}}gr=a.p,a.m=!0}return{}}function Vv(){return!k_||gr!==null&&gr.l===null}function md(n){if(typeof n!="object"||n===null||vd in n)return n;const a=I2(n);if(a!==Y4&&a!==K4)return n;var u=new Map,m=E2(n),y=Uc(0),x=lr,E=r=>{var P=lr;Ga(x);var M=r();return Ga(P),M};return m&&u.set("length",Uc(n.length)),new Proxy(n,{defineProperty(r,P,M){(!("value"in M)||M.configurable===!1||M.enumerable===!1||M.writable===!1)&&aO();var L=u.get(P);return L===void 0?(L=E(()=>Uc(M.value)),u.set(P,L)):Vr(L,E(()=>md(M.value))),!0},deleteProperty(r,P){var M=u.get(P);if(M===void 0)P in r&&(u.set(P,E(()=>Uc(es))),Lb(y));else{if(m&&typeof P=="string"){var L=u.get("length"),V=Number(P);Number.isInteger(V)&&V<L.v&&Vr(L,V)}Vr(M,es),Lb(y)}return!0},get(r,P,M){var j;if(P===vd)return n;var L=u.get(P),V=P in r;if(L===void 0&&(!V||(j=a_(r,P))!=null&&j.writable)&&(L=E(()=>Uc(md(V?r[P]:es))),u.set(P,L)),L!==void 0){var k=xi(L);return k===es?void 0:k}return Reflect.get(r,P,M)},getOwnPropertyDescriptor(r,P){var M=Reflect.getOwnPropertyDescriptor(r,P);if(M&&"value"in M){var L=u.get(P);L&&(M.value=xi(L))}else if(M===void 0){var V=u.get(P),k=V==null?void 0:V.v;if(V!==void 0&&k!==es)return{enumerable:!0,configurable:!0,value:k,writable:!0}}return M},has(r,P){var k;if(P===vd)return!0;var M=u.get(P),L=M!==void 0&&M.v!==es||Reflect.has(r,P);if(M!==void 0||cr!==null&&(!L||(k=a_(r,P))!=null&&k.writable)){M===void 0&&(M=E(()=>Uc(L?md(r[P]):es)),u.set(P,M));var V=xi(M);if(V===es)return!1}return L},set(r,P,M,L){var ue;var V=u.get(P),k=P in r;if(m&&P==="length")for(var j=M;j<V.v;j+=1){var te=u.get(j+"");te!==void 0?Vr(te,es):j in r&&(te=E(()=>Uc(es)),u.set(j+"",te))}V===void 0?(!k||(ue=a_(r,P))!=null&&ue.writable)&&(V=E(()=>Uc(void 0)),Vr(V,E(()=>md(M))),u.set(P,V)):(k=V.v!==es,Vr(V,E(()=>md(M))));var J=Reflect.getOwnPropertyDescriptor(r,P);if(J!=null&&J.set&&J.set.call(L,M),!k){if(m&&typeof P=="string"){var Q=u.get("length"),ee=Number(P);Number.isInteger(ee)&&ee>=Q.v&&Vr(Q,ee+1)}Lb(y)}return!0},ownKeys(r){xi(y);var P=Reflect.ownKeys(r).filter(V=>{var k=u.get(V);return k===void 0||k.v!==es});for(var[M,L]of u)L.v!==es&&!(M in r)&&P.push(M);return P},setPrototypeOf(){lO()}})}function Lb(n,a=1){Vr(n,n.v+a)}function P2(n){var a=ua|$a,u=lr!==null&&(lr.f&ua)!==0?lr:null;return cr===null||u!==null&&(u.f&xs)!==0?a|=xs:cr.f|=PC,{ctx:gr,deps:null,effects:null,equals:zC,f:a,fn:n,reactions:null,rv:0,v:null,wv:0,parent:u??cr}}function kC(n){const a=P2(n);return a.equals=RC,a}function OC(n){var a=n.effects;if(a!==null){n.effects=null;for(var u=0;u<a.length;u+=1)Xc(a[u])}}function vO(n){for(var a=n.parent;a!==null;){if((a.f&ua)===0)return a;a=a.parent}return null}function FC(n){var a,u=cr;Yc(vO(n));try{OC(n),a=nP(n)}finally{Yc(u)}return a}function BC(n){var a=FC(n),u=(Hc||(n.f&xs)!==0)&&n.deps!==null?nu:No;Ns(n,u),n.equals(a)||(n.v=a,n.wv=eP())}const p_=new Map;function Ad(n,a){var u={f:0,v:n,reactions:null,equals:zC,rv:0,wv:0};return u}function Uc(n,a){const u=Ad(n);return PO(u),u}function oa(n,a=!1){var m;const u=Ad(n);return a||(u.equals=RC),k_&&gr!==null&&gr.l!==null&&((m=gr.l).s??(m.s=[])).push(u),u}function Vr(n,a,u=!1){lr!==null&&!Fa&&Vv()&&(lr.f&(ua|M2))!==0&&!(Bo!=null&&Bo.includes(n))&&cO();let m=u?md(a):a;return NC(n,m)}function NC(n,a){if(!n.equals(a)){var u=n.v;O_?p_.set(n,a):p_.set(n,u),n.v=a,(n.f&ua)!==0&&((n.f&$a)!==0&&FC(n),Ns(n,(n.f&xs)===0?No:nu)),n.wv=eP(),VC(n,$a),Vv()&&cr!==null&&(cr.f&No)!==0&&(cr.f&(Zl|$d))===0&&(Ls===null?zO([n]):Ls.push(n))}return a}function VC(n,a){var u=n.reactions;if(u!==null)for(var m=Vv(),y=u.length,x=0;x<y;x++){var E=u[x],r=E.f;(r&$a)===0&&(!m&&E===cr||(Ns(E,a),(r&(No|xs))!==0&&((r&ua)!==0?VC(E,nu):qv(E))))}}let xO=!1;var YI,UC,jC,$C;function bO(){if(YI===void 0){YI=window,UC=/Firefox/.test(navigator.userAgent);var n=Element.prototype,a=Node.prototype,u=Text.prototype;jC=a_(a,"firstChild").get,$C=a_(a,"nextSibling").get,WI(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),WI(u)&&(u.__t=void 0)}}function GC(n=""){return document.createTextNode(n)}function m_(n){return jC.call(n)}function z2(n){return $C.call(n)}function Vm(n,a){return m_(n)}function Rl(n,a=1,u=!1){let m=n;for(;a--;)m=z2(m);return m}function wO(n){n.textContent=""}function qC(n){cr===null&&lr===null&&oO(),lr!==null&&(lr.f&xs)!==0&&cr===null&&rO(),O_&&iO()}function TO(n,a){var u=a.last;u===null?a.last=a.first=n:(u.next=n,n.prev=u,a.last=n)}function Gd(n,a,u,m=!0){var y=cr,x={ctx:gr,deps:null,nodes_start:null,nodes_end:null,f:n|$a,first:null,fn:a,last:null,next:null,parent:y,prev:null,teardown:null,transitions:null,wv:0};if(u)try{Gv(x),x.f|=Q4}catch(P){throw Xc(x),P}else a!==null&&qv(x);var E=u&&x.deps===null&&x.first===null&&x.nodes_start===null&&x.teardown===null&&(x.f&(PC|ky))===0;if(!E&&m&&(y!==null&&TO(x,y),lr!==null&&(lr.f&ua)!==0)){var r=lr;(r.effects??(r.effects=[])).push(x)}return x}function HC(n){const a=Gd(Bv,null,!1);return Ns(a,No),a.teardown=n,a}function Sw(n){qC();var a=cr!==null&&(cr.f&Zl)!==0&&gr!==null&&!gr.m;if(a){var u=gr;(u.e??(u.e=[])).push({fn:n,effect:cr,reaction:lr})}else{var m=Uv(n);return m}}function SO(n){return qC(),jv(n)}function EO(n){const a=Gd($d,n,!0);return(u={})=>new Promise(m=>{u.outro?Fy(a,()=>{Xc(a),m(void 0)}):(Xc(a),m(void 0))})}function Uv(n){return Gd(CC,n,!1)}function Y0(n,a){var u=gr,m={effect:null,ran:!1};u.l.r1.push(m),m.effect=jv(()=>{n(),!m.ran&&(m.ran=!0,Vr(u.l.r2,!0),F_(a))})}function AO(){var n=gr;jv(()=>{if(xi(n.l.r2)){for(var a of n.l.r1){var u=a.effect;(u.f&No)!==0&&Ns(u,nu),qd(u)&&Gv(u),a.ran=!1}n.l.r2.v=!1}})}function jv(n){return Gd(Bv,n,!0)}function KI(n,a=[],u=P2){const m=a.map(u);return R2(()=>n(...m.map(xi)))}function R2(n,a=0){return Gd(Bv|M2|a,n,!0)}function __(n,a=!0){return Gd(Bv|Zl,n,!0,a)}function ZC(n){var a=n.teardown;if(a!==null){const u=O_,m=lr;JI(!0),Ga(null);try{a.call(null)}finally{JI(u),Ga(m)}}}function WC(n,a=!1){var u=n.first;for(n.first=n.last=null;u!==null;){var m=u.next;(u.f&$d)!==0?u.parent=null:Xc(u,a),u=m}}function IO(n){for(var a=n.first;a!==null;){var u=a.next;(a.f&Zl)===0&&Xc(a),a=u}}function Xc(n,a=!0){var u=!1;(a||(n.f&eO)!==0)&&n.nodes_start!==null&&(MO(n.nodes_start,n.nodes_end),u=!0),WC(n,a&&!u),jy(n,0),Ns(n,Nv);var m=n.transitions;if(m!==null)for(const x of m)x.stop();ZC(n);var y=n.parent;y!==null&&y.first!==null&&XC(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes_start=n.nodes_end=null}function MO(n,a){for(;n!==null;){var u=n===a?null:z2(n);n.remove(),n=u}}function XC(n){var a=n.parent,u=n.prev,m=n.next;u!==null&&(u.next=m),m!==null&&(m.prev=u),a!==null&&(a.first===n&&(a.first=m),a.last===n&&(a.last=u))}function Fy(n,a){var u=[];D2(n,u,!0),YC(u,()=>{Xc(n),a&&a()})}function YC(n,a){var u=n.length;if(u>0){var m=()=>--u||a();for(var y of n)y.out(m)}else a()}function D2(n,a,u){if((n.f&$l)===0){if(n.f^=$l,n.transitions!==null)for(const E of n.transitions)(E.is_global||u)&&a.push(E);for(var m=n.first;m!==null;){var y=m.next,x=(m.f&C2)!==0||(m.f&Zl)!==0;D2(m,a,x?u:!1),m=y}}}function By(n){KC(n,!0)}function KC(n,a){if((n.f&$l)!==0){n.f^=$l,(n.f&No)===0&&(n.f^=No),qd(n)&&(Ns(n,$a),qv(n));for(var u=n.first;u!==null;){var m=u.next,y=(u.f&C2)!==0||(u.f&Zl)!==0;KC(u,y?a:!1),u=m}if(n.transitions!==null)for(const x of n.transitions)(x.is_global||a)&&x.in()}}let Ny=[];function CO(){var n=Ny;Ny=[],ww(n)}function JC(n){Ny.length===0&&queueMicrotask(CO),Ny.push(n)}let xy=!1,Ew=!1,Vy=null,gh=!1,O_=!1;function JI(n){O_=n}let by=[];let lr=null,Fa=!1;function Ga(n){lr=n}let cr=null;function Yc(n){cr=n}let Bo=null;function PO(n){lr!==null&&lr.f&Tw&&(Bo===null?Bo=[n]:Bo.push(n))}let Ro=null,_s=0,Ls=null;function zO(n){Ls=n}let QC=1,Uy=0,Hc=!1;function eP(){return++QC}function qd(n){var V;var a=n.f;if((a&$a)!==0)return!0;if((a&nu)!==0){var u=n.deps,m=(a&xs)!==0;if(u!==null){var y,x,E=(a&Oy)!==0,r=m&&cr!==null&&!Hc,P=u.length;if(E||r){var M=n,L=M.parent;for(y=0;y<P;y++)x=u[y],(E||!((V=x==null?void 0:x.reactions)!=null&&V.includes(M)))&&(x.reactions??(x.reactions=[])).push(M);E&&(M.f^=Oy),r&&L!==null&&(L.f&xs)===0&&(M.f^=xs)}for(y=0;y<P;y++)if(x=u[y],qd(x)&&BC(x),x.wv>n.wv)return!0}(!m||cr!==null&&!Hc)&&Ns(n,No)}return!1}function RO(n,a){for(var u=a;u!==null;){if((u.f&ky)!==0)try{u.fn(n);return}catch{u.f^=ky}u=u.parent}throw xy=!1,n}function QI(n){return(n.f&Nv)===0&&(n.parent===null||(n.parent.f&ky)===0)}function $v(n,a,u,m){if(xy){if(u===null&&(xy=!1),QI(a))throw n;return}if(u!==null&&(xy=!0),RO(n,a),QI(a))throw n}function tP(n,a,u=!0){var m=n.reactions;if(m!==null)for(var y=0;y<m.length;y++){var x=m[y];Bo!=null&&Bo.includes(n)||((x.f&ua)!==0?tP(x,a,!1):a===x&&(u?Ns(x,$a):(x.f&No)!==0&&Ns(x,nu),qv(x)))}}function nP(n){var j;var a=Ro,u=_s,m=Ls,y=lr,x=Hc,E=Bo,r=gr,P=Fa,M=n.f;Ro=null,_s=0,Ls=null,Hc=(M&xs)!==0&&(Fa||!gh||lr===null),lr=(M&(Zl|$d))===0?n:null,Bo=null,XI(n.ctx),Fa=!1,Uy++,n.f|=Tw;try{var L=(0,n.fn)(),V=n.deps;if(Ro!==null){var k;if(jy(n,_s),V!==null&&_s>0)for(V.length=_s+Ro.length,k=0;k<Ro.length;k++)V[_s+k]=Ro[k];else n.deps=V=Ro;if(!Hc)for(k=_s;k<V.length;k++)((j=V[k]).reactions??(j.reactions=[])).push(n)}else V!==null&&_s<V.length&&(jy(n,_s),V.length=_s);if(Vv()&&Ls!==null&&!Fa&&V!==null&&(n.f&(ua|nu|$a))===0)for(k=0;k<Ls.length;k++)tP(Ls[k],n);return y!==null&&y!==n&&(Uy++,Ls!==null&&(m===null?m=Ls:m.push(...Ls))),L}finally{Ro=a,_s=u,Ls=m,lr=y,Hc=x,Bo=E,XI(r),Fa=P,n.f^=Tw}}function DO(n,a){let u=a.reactions;if(u!==null){var m=W4.call(u,n);if(m!==-1){var y=u.length-1;y===0?u=a.reactions=null:(u[m]=u[y],u.pop())}}u===null&&(a.f&ua)!==0&&(Ro===null||!Ro.includes(a))&&(Ns(a,nu),(a.f&(xs|Oy))===0&&(a.f^=Oy),OC(a),jy(a,0))}function jy(n,a){var u=n.deps;if(u!==null)for(var m=a;m<u.length;m++)DO(n,u[m])}function Gv(n){var a=n.f;if((a&Nv)===0){Ns(n,No);var u=cr,m=gr,y=gh;cr=n,gh=!0;try{(a&M2)!==0?IO(n):WC(n),ZC(n);var x=nP(n);n.teardown=typeof x=="function"?x:null,n.wv=QC;var E=n.deps,r;ZI&&uO&&n.f&$a}catch(P){$v(P,n,u,m||n.ctx)}finally{gh=y,cr=u}}}function LO(){try{sO()}catch(n){if(Vy!==null)$v(n,Vy,null);else throw n}}function kO(){var n=gh;try{var a=0;for(gh=!0;by.length>0;){a++>1e3&&LO();var u=by,m=u.length;by=[];for(var y=0;y<m;y++){var x=FO(u[y]);OO(x)}p_.clear()}}finally{Ew=!1,gh=n,Vy=null}}function OO(n){var a=n.length;if(a!==0)for(var u=0;u<a;u++){var m=n[u];if((m.f&(Nv|$l))===0)try{qd(m)&&(Gv(m),m.deps===null&&m.first===null&&m.nodes_start===null&&(m.teardown===null?XC(m):m.fn=null))}catch(y){$v(y,m,null,m.ctx)}}}function qv(n){Ew||(Ew=!0,queueMicrotask(kO));for(var a=Vy=n;a.parent!==null;){a=a.parent;var u=a.f;if((u&($d|Zl))!==0){if((u&No)===0)return;a.f^=No}}by.push(a)}function FO(n){for(var a=[],u=n;u!==null;){var m=u.f,y=(m&(Zl|$d))!==0,x=y&&(m&No)!==0;if(!x&&(m&$l)===0){if((m&CC)!==0)a.push(u);else if(y)u.f^=No;else try{qd(u)&&Gv(u)}catch(P){$v(P,u,null,u.ctx)}var E=u.first;if(E!==null){u=E;continue}}var r=u.parent;for(u=u.next;u===null&&r!==null;)u=r.next,r=r.parent}return a}function xi(n){var a=n.f,u=(a&ua)!==0;if(lr!==null&&!Fa){if(!(Bo!=null&&Bo.includes(n))){var m=lr.deps;n.rv<Uy&&(n.rv=Uy,Ro===null&&m!==null&&m[_s]===n?_s++:Ro===null?Ro=[n]:(!Hc||!Ro.includes(n))&&Ro.push(n))}}else if(u&&n.deps===null&&n.effects===null){var y=n,x=y.parent;x!==null&&(x.f&xs)===0&&(y.f^=xs)}return u&&(y=n,qd(y)&&BC(y)),O_&&p_.has(n)?p_.get(n):n.v}function F_(n){var a=Fa;try{return Fa=!0,n()}finally{Fa=a}}const BO=-7169;function Ns(n,a){n.f=n.f&BO|a}function NO(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(vd in n)Aw(n);else if(!Array.isArray(n))for(let a in n){const u=n[a];typeof u=="object"&&u&&vd in u&&Aw(u)}}}function Aw(n,a=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!a.has(n)){a.add(n),n instanceof Date&&n.getTime();for(let m in n)try{Aw(n[m],a)}catch{}const u=I2(n);if(u!==Object.prototype&&u!==Array.prototype&&u!==Map.prototype&&u!==Set.prototype&&u!==Date.prototype){const m=MC(u);for(let y in m){const x=m[y].get;if(x)try{x.call(n)}catch{}}}}}const VO=["touchstart","touchmove"];function UO(n){return VO.includes(n)}function jO(n){var a=lr,u=cr;Ga(null),Yc(null);try{return n()}finally{Ga(a),Yc(u)}}const $O=new Set,eM=new Set;function GO(n,a,u,m={}){function y(x){if(m.capture||Xm.call(a,x),!x.cancelBubble)return jO(()=>u==null?void 0:u.call(this,x))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?JC(()=>{a.addEventListener(n,y,m)}):a.addEventListener(n,y,m),y}function ch(n,a,u,m,y){var x={capture:m,passive:y},E=GO(n,a,u,x);(a===document.body||a===window||a===document)&&HC(()=>{a.removeEventListener(n,E,x)})}function Xm(n){var ue;var a=this,u=a.ownerDocument,m=n.type,y=((ue=n.composedPath)==null?void 0:ue.call(n))||[],x=y[0]||n.target,E=0,r=n.__root;if(r){var P=y.indexOf(r);if(P!==-1&&(a===document||a===window)){n.__root=a;return}var M=y.indexOf(a);if(M===-1)return;P<=M&&(E=P)}if(x=y[E]||n.target,x!==a){X4(n,"currentTarget",{configurable:!0,get(){return x||u}});var L=lr,V=cr;Ga(null),Yc(null);try{for(var k,j=[];x!==null;){var te=x.assignedSlot||x.parentNode||x.host||null;try{var J=x["__"+m];if(J!=null&&(!x.disabled||n.target===x))if(E2(J)){var[Q,...ee]=J;Q.apply(x,[n,...ee])}else J.call(x,n)}catch(ce){k?j.push(ce):k=ce}if(n.cancelBubble||te===a||te===null)break;x=te}if(k){for(let ce of j)queueMicrotask(()=>{throw ce});throw k}}finally{n.__root=a,delete n.currentTarget,Ga(L),Yc(V)}}}function iP(n){var a=document.createElement("template");return a.innerHTML=n,a.content}function Iw(n,a){var u=cr;u.nodes_start===null&&(u.nodes_start=n,u.nodes_end=a)}function rP(n,a){var u=(a&mO)!==0,m=(a&_O)!==0,y,x=!n.startsWith("<!>");return()=>{y===void 0&&(y=iP(x?n:"<!>"+n),u||(y=m_(y)));var E=m||UC?document.importNode(y,!0):y.cloneNode(!0);if(u){var r=m_(E),P=E.lastChild;Iw(r,P)}else Iw(E,E);return E}}function qO(n,a,u="svg"){var m=!n.startsWith("<!>"),y=`<${u}>${m?n:"<!>"+n}</${u}>`,x;return()=>{if(!x){var E=iP(y),r=m_(E);x=m_(r)}var P=x.cloneNode(!0);return Iw(P,P),P}}function kb(n,a){n!==null&&n.before(a)}function HO(n,a){return ZO(n,a)}const id=new Map;function ZO(n,{target:a,anchor:u,props:m={},events:y,context:x,intro:E=!0}){bO();var r=new Set,P=V=>{for(var k=0;k<V.length;k++){var j=V[k];if(!r.has(j)){r.add(j);var te=UO(j);a.addEventListener(j,Xm,{passive:te});var J=id.get(j);J===void 0?(document.addEventListener(j,Xm,{passive:te}),id.set(j,1)):id.set(j,J+1)}}};P(A2($O)),eM.add(P);var M=void 0,L=EO(()=>{var V=u??a.appendChild(GC());return __(()=>{if(x){DC({});var k=gr;k.c=x}y&&(m.$$events=y),M=n(V,m)||{},x&&LC()}),()=>{var te;for(var k of r){a.removeEventListener(k,Xm);var j=id.get(k);--j===0?(document.removeEventListener(k,Xm),id.delete(k)):id.set(k,j)}eM.delete(P),V!==u&&((te=V.parentNode)==null||te.removeChild(V))}});return WO.set(M,L),M}let WO=new WeakMap;function XO(n,a,[u,m]=[0,0]){var y=n,x=null,E=null,r=es,P=u>0?C2:0,M=!1;const L=(k,j=!0)=>{M=!0,V(j,k)},V=(k,j)=>{r!==(r=k)&&(r?(x?By(x):j&&(x=__(()=>j(y))),E&&Fy(E,()=>{E=null})):(E?By(E):j&&(E=__(()=>j(y,[u+1,m]))),x&&Fy(x,()=>{x=null})))};R2(()=>{M=!1,a(L),M||V(null,null)},P)}function YO(n,a){return a}function KO(n,a,u,m){for(var y=[],x=a.length,E=0;E<x;E++)D2(a[E].e,y,!0);var r=x>0&&y.length===0&&u!==null;if(r){var P=u.parentNode;wO(P),P.append(u),m.clear(),jc(n,a[0].prev,a[x-1].next)}YC(y,()=>{for(var M=0;M<x;M++){var L=a[M];r||(m.delete(L.k),jc(n,L.prev,L.next)),Xc(L.e,!r)}})}function JO(n,a,u,m,y,x=null){var E=n,r={flags:a,items:new Map,first:null};{var P=n;E=P.appendChild(GC())}var M=null,L=!1,V=kC(()=>{var k=u();return E2(k)?k:k==null?[]:A2(k)});R2(()=>{var k=xi(V),j=k.length;L&&j===0||(L=j===0,QO(k,r,E,y,a,m,u),x!==null&&(j===0?M?By(M):M=__(()=>x(E)):M!==null&&Fy(M,()=>{M=null})),xi(V))})}function QO(n,a,u,m,y,x,E){var r=n.length,P=a.items,M=a.first,L=M,V,k=null,j=[],te=[],J,Q,ee,ue;for(ue=0;ue<r;ue+=1){if(J=n[ue],Q=x(J,ue),ee=P.get(Q),ee===void 0){var ce=L?L.e.nodes_start:u;k=tF(ce,a,k,k===null?a.first:k.next,J,Q,ue,m,y,E),P.set(Q,k),j=[],te=[],L=k.next;continue}if(eF(ee,J,ue),(ee.e.f&$l)!==0&&By(ee.e),ee!==L){if(V!==void 0&&V.has(ee)){if(j.length<te.length){var se=te[0],Ae;k=se.prev;var De=j[0],Qe=j[j.length-1];for(Ae=0;Ae<j.length;Ae+=1)tM(j[Ae],se,u);for(Ae=0;Ae<te.length;Ae+=1)V.delete(te[Ae]);jc(a,De.prev,Qe.next),jc(a,k,De),jc(a,Qe,se),L=se,k=Qe,ue-=1,j=[],te=[]}else V.delete(ee),tM(ee,L,u),jc(a,ee.prev,ee.next),jc(a,ee,k===null?a.first:k.next),jc(a,k,ee),k=ee;continue}for(j=[],te=[];L!==null&&L.k!==Q;)(L.e.f&$l)===0&&(V??(V=new Set)).add(L),te.push(L),L=L.next;if(L===null)continue;ee=L}j.push(ee),k=ee,L=ee.next}if(L!==null||V!==void 0){for(var nt=V===void 0?[]:A2(V);L!==null;)(L.e.f&$l)===0&&nt.push(L),L=L.next;var rt=nt.length;if(rt>0){var tt=r===0?u:null;KO(a,nt,tt,P)}}cr.first=a.first&&a.first.e,cr.last=k&&k.e}function eF(n,a,u,m){NC(n.v,a),n.i=u}function tF(n,a,u,m,y,x,E,r,P,M){var L=(P&fO)!==0,V=(P&pO)===0,k=L?V?oa(y):Ad(y):y,j=(P&dO)===0?E:Ad(E),te={i:j,v:k,k:x,a:null,e:null,prev:u,next:m};try{return te.e=__(()=>r(n,k,j,M),xO),te.e.prev=u&&u.e,te.e.next=m&&m.e,u===null?a.first=te:(u.next=te,u.e.next=te.e),m!==null&&(m.prev=te,m.e.prev=te.e),te}finally{}}function tM(n,a,u){for(var m=n.next?n.next.e.nodes_start:u,y=a?a.e.nodes_start:u,x=n.e.nodes_start;x!==m;){var E=z2(x);y.before(x),x=E}}function jc(n,a,u){a===null?n.first=u:(a.next=u,a.e.next=u&&u.e),u!==null&&(u.prev=a,u.e.prev=a&&a.e)}const nM=[...` 	
\r\fÂ \v\uFEFF`];function nF(n,a,u){var m=""+n;if(u){for(var y in u)if(u[y])m=m?m+" "+y:y;else if(m.length)for(var x=y.length,E=0;(E=m.indexOf(y,E))>=0;){var r=E+x;(E===0||nM.includes(m[E-1]))&&(r===m.length||nM.includes(m[r]))?m=(E===0?"":m.substring(0,E))+m.substring(r+1):E=r}}return m===""?null:m}function rd(n,a,u,m,y,x){var E=n.__className;if(E!==u||E===void 0){var r=nF(u,m,x);r==null?n.removeAttribute("class"):n.className=r,n.__className=u}else if(x&&y!==x)for(var P in x){var M=!!x[P];(y==null||M!==!!y[P])&&n.classList.toggle(P,M)}return x}const iF=Symbol("is custom element"),rF=Symbol("is html");function Ob(n,a,u,m){var y=oF(n);y[a]!==(y[a]=u)&&(a==="loading"&&(n[tO]=u),u==null?n.removeAttribute(a):typeof u!="string"&&sF(n).includes(a)?n[a]=u:n.setAttribute(a,u))}function oF(n){return n.__attributes??(n.__attributes={[iF]:n.nodeName.includes("-"),[rF]:n.namespaceURI===gO})}var iM=new Map;function sF(n){var a=iM.get(n.nodeName);if(a)return a;iM.set(n.nodeName,a=[]);for(var u,m=n,y=Element.prototype;y!==m;){u=MC(m);for(var x in u)u[x].set&&a.push(x);m=I2(m)}return a}var qc,Ed,L_,Ov,oP;const Fv=class Fv{constructor(a){Nm(this,Ov);Nm(this,qc,new WeakMap);Nm(this,Ed);Nm(this,L_);Db(this,L_,a)}observe(a,u){var m=zl(this,qc).get(a)||new Set;return m.add(u),zl(this,qc).set(a,m),HI(this,Ov,oP).call(this).observe(a,zl(this,L_)),()=>{var y=zl(this,qc).get(a);y.delete(u),y.size===0&&(zl(this,qc).delete(a),zl(this,Ed).unobserve(a))}}};qc=new WeakMap,Ed=new WeakMap,L_=new WeakMap,Ov=new WeakSet,oP=function(){return zl(this,Ed)??Db(this,Ed,new ResizeObserver(a=>{for(var u of a){Fv.entries.set(u.target,u);for(var m of zl(this,qc).get(u.target)||[])m(u)}}))},qI(Fv,"entries",new WeakMap);let Mw=Fv;var aF=new Mw({box:"border-box"});function rM(n,a,u){var m=aF.observe(n,()=>u(n[a]));Uv(()=>(F_(()=>u(n[a])),m))}function oM(n,a){return n===a||(n==null?void 0:n[vd])===a}function lF(n={},a,u,m){return Uv(()=>{var y,x;return jv(()=>{y=x,x=[],F_(()=>{n!==u(...x)&&(a(n,...x),y&&oM(u(...y),n)&&a(null,...y))})}),()=>{JC(()=>{x&&oM(u(...x),n)&&a(null,...x)})}}),n}function cF(n=!1){const a=gr,u=a.l.u;if(!u)return;let m=()=>NO(a.s);if(n){let y=0,x={};const E=P2(()=>{let r=!1;const P=a.s;for(const M in P)P[M]!==x[M]&&(x[M]=P[M],r=!0);return r&&y++,y});m=()=>xi(E)}u.b.length&&SO(()=>{sM(a,m),ww(u.b)}),Sw(()=>{const y=F_(()=>u.m.map(J4));return()=>{for(const x of y)typeof x=="function"&&x()}}),u.a.length&&Sw(()=>{sM(a,m),ww(u.a)})}function sM(n,a){if(n.l.s)for(const u of n.l.s)xi(u);a()}function uF(n){var a=Ad(0);return function(){return arguments.length===1?(Vr(a,xi(a)+1),arguments[0]):(xi(a),n())}}function hF(n){gr===null&&yO(),k_&&gr.l!==null?fF(gr).m.push(n):Sw(()=>{const a=F_(n);if(typeof a=="function")return a})}function fF(n){var a=n.l;return a.u??(a.u={a:[],b:[],m:[]})}const dF="5";var IC;typeof window<"u"&&((IC=window.__svelte??(window.__svelte={})).v??(IC.v=new Set)).add(dF);hO();function Ir(n,a){return n==null||a==null?NaN:n<a?-1:n>a?1:n>=a?0:NaN}function sP(n,a){return n==null||a==null?NaN:a<n?-1:a>n?1:a>=n?0:NaN}function Hv(n){let a,u,m;n.length!==2?(a=Ir,u=(r,P)=>Ir(n(r),P),m=(r,P)=>n(r)-P):(a=n===Ir||n===sP?n:pF,u=n,m=n);function y(r,P,M=0,L=r.length){if(M<L){if(a(P,P)!==0)return L;do{const V=M+L>>>1;u(r[V],P)<0?M=V+1:L=V}while(M<L)}return M}function x(r,P,M=0,L=r.length){if(M<L){if(a(P,P)!==0)return L;do{const V=M+L>>>1;u(r[V],P)<=0?M=V+1:L=V}while(M<L)}return M}function E(r,P,M=0,L=r.length){const V=y(r,P,M,L-1);return V>M&&m(r[V-1],P)>-m(r[V],P)?V-1:V}return{left:y,center:E,right:x}}function pF(){return 0}function $y(n){return n===null?NaN:+n}function*mF(n,a){if(a===void 0)for(let u of n)u!=null&&(u=+u)>=u&&(yield u);else{let u=-1;for(let m of n)(m=a(m,++u,n))!=null&&(m=+m)>=m&&(yield m)}}const aP=Hv(Ir),Kc=aP.right,_F=aP.left,gF=Hv($y).center;function yF(n,a){if(!((a=+a)>=0))throw new RangeError("invalid r");let u=n.length;if(!((u=Math.floor(u))>=0))throw new RangeError("invalid length");if(!u||!a)return n;const m=L2(a),y=n.slice();return m(n,y,0,u,1),m(y,n,0,u,1),m(n,y,0,u,1),n}const lP=cP(L2),vF=cP(xF);function cP(n){return function(a,u,m=u){if(!((u=+u)>=0))throw new RangeError("invalid rx");if(!((m=+m)>=0))throw new RangeError("invalid ry");let{data:y,width:x,height:E}=a;if(!((x=Math.floor(x))>=0))throw new RangeError("invalid width");if(!((E=Math.floor(E!==void 0?E:y.length/x))>=0))throw new RangeError("invalid height");if(!x||!E||!u&&!m)return a;const r=u&&n(u),P=m&&n(m),M=y.slice();return r&&P?(od(r,M,y,x,E),od(r,y,M,x,E),od(r,M,y,x,E),sd(P,y,M,x,E),sd(P,M,y,x,E),sd(P,y,M,x,E)):r?(od(r,y,M,x,E),od(r,M,y,x,E),od(r,y,M,x,E)):P&&(sd(P,y,M,x,E),sd(P,M,y,x,E),sd(P,y,M,x,E)),a}}function od(n,a,u,m,y){for(let x=0,E=m*y;x<E;)n(a,u,x,x+=m,1)}function sd(n,a,u,m,y){for(let x=0,E=m*y;x<m;++x)n(a,u,x,x+E,m)}function xF(n){const a=L2(n);return(u,m,y,x,E)=>{y<<=2,x<<=2,E<<=2,a(u,m,y+0,x+0,E),a(u,m,y+1,x+1,E),a(u,m,y+2,x+2,E),a(u,m,y+3,x+3,E)}}function L2(n){const a=Math.floor(n);if(a===n)return bF(n);const u=n-a,m=2*n+1;return(y,x,E,r,P)=>{if(!((r-=P)>=E))return;let M=a*x[E];const L=P*a,V=L+P;for(let k=E,j=E+L;k<j;k+=P)M+=x[Math.min(r,k)];for(let k=E,j=r;k<=j;k+=P)M+=x[Math.min(r,k+L)],y[k]=(M+u*(x[Math.max(E,k-V)]+x[Math.min(r,k+V)]))/m,M-=x[Math.max(E,k-L)]}}function bF(n){const a=2*n+1;return(u,m,y,x,E)=>{if(!((x-=E)>=y))return;let r=n*m[y];const P=E*n;for(let M=y,L=y+P;M<L;M+=E)r+=m[Math.min(x,M)];for(let M=y,L=x;M<=L;M+=E)r+=m[Math.min(x,M+P)],u[M]=r/a,r-=m[Math.max(y,M-P)]}}function Zv(n,a){let u=0;if(a===void 0)for(let m of n)m!=null&&(m=+m)>=m&&++u;else{let m=-1;for(let y of n)(y=a(y,++m,n))!=null&&(y=+y)>=y&&++u}return u}function wF(n){return n.length|0}function TF(n){return!(n>0)}function SF(n){return typeof n!="object"||"length"in n?n:Array.from(n)}function EF(n){return a=>n(...a)}function AF(...n){const a=typeof n[n.length-1]=="function"&&EF(n.pop());n=n.map(SF);const u=n.map(wF),m=n.length-1,y=new Array(m+1).fill(0),x=[];if(m<0||u.some(TF))return x;for(;;){x.push(y.map((r,P)=>n[P][r]));let E=m;for(;++y[E]===u[E];){if(E===0)return a?x.map(a):x;y[E--]=0}}}function IF(n,a){var u=0,m=0;return Float64Array.from(n,a===void 0?y=>u+=+y||0:y=>u+=+a(y,m++,n)||0)}function uP(n,a){let u=0,m,y=0,x=0;if(a===void 0)for(let E of n)E!=null&&(E=+E)>=E&&(m=E-y,y+=m/++u,x+=m*(E-y));else{let E=-1;for(let r of n)(r=a(r,++E,n))!=null&&(r=+r)>=r&&(m=r-y,y+=m/++u,x+=m*(r-y))}if(u>1)return x/(u-1)}function hP(n,a){const u=uP(n,a);return u&&Math.sqrt(u)}function l_(n,a){let u,m;if(a===void 0)for(const y of n)y!=null&&(u===void 0?y>=y&&(u=m=y):(u>y&&(u=y),m<y&&(m=y)));else{let y=-1;for(let x of n)(x=a(x,++y,n))!=null&&(u===void 0?x>=x&&(u=m=x):(u>x&&(u=x),m<x&&(m=x)))}return[u,m]}class Zr{constructor(){this._partials=new Float64Array(32),this._n=0}add(a){const u=this._partials;let m=0;for(let y=0;y<this._n&&y<32;y++){const x=u[y],E=a+x,r=Math.abs(a)<Math.abs(x)?a-(E-x):x-(E-a);r&&(u[m++]=r),a=E}return u[m]=a,this._n=m+1,this}valueOf(){const a=this._partials;let u=this._n,m,y,x,E=0;if(u>0){for(E=a[--u];u>0&&(m=E,y=a[--u],E=m+y,x=y-(E-m),!x););u>0&&(x<0&&a[u-1]<0||x>0&&a[u-1]>0)&&(y=x*2,m=E+y,y==m-E&&(E=m))}return E}}function MF(n,a){const u=new Zr;if(a===void 0)for(let m of n)(m=+m)&&u.add(m);else{let m=-1;for(let y of n)(y=+a(y,++m,n))&&u.add(y)}return+u}function CF(n,a){const u=new Zr;let m=-1;return Float64Array.from(n,a===void 0?y=>u.add(+y||0):y=>u.add(+a(y,++m,n)||0))}class g_ extends Map{constructor(a,u=pP){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:u}}),a!=null)for(const[m,y]of a)this.set(m,y)}get(a){return super.get(Cw(this,a))}has(a){return super.has(Cw(this,a))}set(a,u){return super.set(fP(this,a),u)}delete(a){return super.delete(dP(this,a))}}class bh extends Set{constructor(a,u=pP){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:u}}),a!=null)for(const m of a)this.add(m)}has(a){return super.has(Cw(this,a))}add(a){return super.add(fP(this,a))}delete(a){return super.delete(dP(this,a))}}function Cw({_intern:n,_key:a},u){const m=a(u);return n.has(m)?n.get(m):u}function fP({_intern:n,_key:a},u){const m=a(u);return n.has(m)?n.get(m):(n.set(m,u),u)}function dP({_intern:n,_key:a},u){const m=a(u);return n.has(m)&&(u=n.get(m),n.delete(m)),u}function pP(n){return n!==null&&typeof n=="object"?n.valueOf():n}function Id(n){return n}function mP(n,...a){return Hd(n,Id,Id,a)}function Gy(n,...a){return Hd(n,Array.from,Id,a)}function _P(n,a){for(let u=1,m=a.length;u<m;++u)n=n.flatMap(y=>y.pop().map(([x,E])=>[...y,x,E]));return n}function PF(n,...a){return _P(Gy(n,...a),a)}function zF(n,a,...u){return _P(yP(n,a,...u),u)}function gP(n,a,...u){return Hd(n,Id,a,u)}function yP(n,a,...u){return Hd(n,Array.from,a,u)}function RF(n,...a){return Hd(n,Id,vP,a)}function DF(n,...a){return Hd(n,Array.from,vP,a)}function vP(n){if(n.length!==1)throw new Error("duplicate key");return n[0]}function Hd(n,a,u,m){return function y(x,E){if(E>=m.length)return u(x);const r=new g_,P=m[E++];let M=-1;for(const L of x){const V=P(L,++M,x),k=r.get(V);k?k.push(L):r.set(V,[L])}for(const[L,V]of r)r.set(L,y(V,E));return a(r)}(n,0)}function xP(n,a){return Array.from(a,u=>n[u])}function Pw(n,...a){if(typeof n[Symbol.iterator]!="function")throw new TypeError("values is not iterable");n=Array.from(n);let[u]=a;if(u&&u.length!==2||a.length>1){const m=Uint32Array.from(n,(y,x)=>x);return a.length>1?(a=a.map(y=>n.map(y)),m.sort((y,x)=>{for(const E of a){const r=Md(E[y],E[x]);if(r)return r}})):(u=n.map(u),m.sort((y,x)=>Md(u[y],u[x]))),xP(n,m)}return n.sort(k2(u))}function k2(n=Ir){if(n===Ir)return Md;if(typeof n!="function")throw new TypeError("compare is not a function");return(a,u)=>{const m=n(a,u);return m||m===0?m:(n(u,u)===0)-(n(a,a)===0)}}function Md(n,a){return(n==null||!(n>=n))-(a==null||!(a>=a))||(n<a?-1:n>a?1:0)}function LF(n,a,u){return(a.length!==2?Pw(gP(n,a,u),([m,y],[x,E])=>Ir(y,E)||Ir(m,x)):Pw(mP(n,u),([m,y],[x,E])=>a(y,E)||Ir(m,x))).map(([m])=>m)}var kF=Array.prototype,OF=kF.slice;function Fb(n){return()=>n}const FF=Math.sqrt(50),BF=Math.sqrt(10),NF=Math.sqrt(2);function qy(n,a,u){const m=(a-n)/Math.max(0,u),y=Math.floor(Math.log10(m)),x=m/Math.pow(10,y),E=x>=FF?10:x>=BF?5:x>=NF?2:1;let r,P,M;return y<0?(M=Math.pow(10,-y)/E,r=Math.round(n*M),P=Math.round(a*M),r/M<n&&++r,P/M>a&&--P,M=-M):(M=Math.pow(10,y)*E,r=Math.round(n/M),P=Math.round(a/M),r*M<n&&++r,P*M>a&&--P),P<r&&.5<=u&&u<2?qy(n,a,u*2):[r,P,M]}function wh(n,a,u){if(a=+a,n=+n,u=+u,!(u>0))return[];if(n===a)return[n];const m=a<n,[y,x,E]=m?qy(a,n,u):qy(n,a,u);if(!(x>=y))return[];const r=x-y+1,P=new Array(r);if(m)if(E<0)for(let M=0;M<r;++M)P[M]=(x-M)/-E;else for(let M=0;M<r;++M)P[M]=(x-M)*E;else if(E<0)for(let M=0;M<r;++M)P[M]=(y+M)/-E;else for(let M=0;M<r;++M)P[M]=(y+M)*E;return P}function Th(n,a,u){return a=+a,n=+n,u=+u,qy(n,a,u)[2]}function Hy(n,a,u){a=+a,n=+n,u=+u;const m=a<n,y=m?Th(a,n,u):Th(n,a,u);return(m?-1:1)*(y<0?1/-y:y)}function O2(n,a,u){let m;for(;;){const y=Th(n,a,u);if(y===m||y===0||!isFinite(y))return[n,a];y>0?(n=Math.floor(n/y)*y,a=Math.ceil(a/y)*y):y<0&&(n=Math.ceil(n*y)/y,a=Math.floor(a*y)/y),m=y}}function F2(n){return Math.max(1,Math.ceil(Math.log(Zv(n))/Math.LN2)+1)}function aM(){var n=Id,a=l_,u=F2;function m(y){Array.isArray(y)||(y=Array.from(y));var x,E=y.length,r,P,M=new Array(E);for(x=0;x<E;++x)M[x]=n(y[x],x,y);var L=a(M),V=L[0],k=L[1],j=u(M,V,k);if(!Array.isArray(j)){const ce=k,se=+j;if(a===l_&&([V,k]=O2(V,k,se)),j=wh(V,k,se),j[0]<=V&&(P=Th(V,k,se)),j[j.length-1]>=k)if(ce>=k&&a===l_){const Ae=Th(V,k,se);isFinite(Ae)&&(Ae>0?k=(Math.floor(k/Ae)+1)*Ae:Ae<0&&(k=(Math.ceil(k*-Ae)+1)/-Ae))}else j.pop()}for(var te=j.length,J=0,Q=te;j[J]<=V;)++J;for(;j[Q-1]>k;)--Q;(J||Q<te)&&(j=j.slice(J,Q),te=Q-J);var ee=new Array(te+1),ue;for(x=0;x<=te;++x)ue=ee[x]=[],ue.x0=x>0?j[x-1]:V,ue.x1=x<te?j[x]:k;if(isFinite(P)){if(P>0)for(x=0;x<E;++x)(r=M[x])!=null&&V<=r&&r<=k&&ee[Math.min(te,Math.floor((r-V)/P))].push(y[x]);else if(P<0){for(x=0;x<E;++x)if((r=M[x])!=null&&V<=r&&r<=k){const ce=Math.floor((V-r)*P);ee[Math.min(te,ce+(j[ce]<=r))].push(y[x])}}}else for(x=0;x<E;++x)(r=M[x])!=null&&V<=r&&r<=k&&ee[Kc(j,r,0,te)].push(y[x]);return ee}return m.value=function(y){return arguments.length?(n=typeof y=="function"?y:Fb(y),m):n},m.domain=function(y){return arguments.length?(a=typeof y=="function"?y:Fb([y[0],y[1]]),m):a},m.thresholds=function(y){return arguments.length?(u=typeof y=="function"?y:Fb(Array.isArray(y)?OF.call(y):y),m):u},m}function y_(n,a){let u;if(a===void 0)for(const m of n)m!=null&&(u<m||u===void 0&&m>=m)&&(u=m);else{let m=-1;for(let y of n)(y=a(y,++m,n))!=null&&(u<y||u===void 0&&y>=y)&&(u=y)}return u}function B2(n,a){let u,m=-1,y=-1;if(a===void 0)for(const x of n)++y,x!=null&&(u<x||u===void 0&&x>=x)&&(u=x,m=y);else for(let x of n)(x=a(x,++y,n))!=null&&(u<x||u===void 0&&x>=x)&&(u=x,m=y);return m}function Zy(n,a){let u;if(a===void 0)for(const m of n)m!=null&&(u>m||u===void 0&&m>=m)&&(u=m);else{let m=-1;for(let y of n)(y=a(y,++m,n))!=null&&(u>y||u===void 0&&y>=y)&&(u=y)}return u}function N2(n,a){let u,m=-1,y=-1;if(a===void 0)for(const x of n)++y,x!=null&&(u>x||u===void 0&&x>=x)&&(u=x,m=y);else for(let x of n)(x=a(x,++y,n))!=null&&(u>x||u===void 0&&x>=x)&&(u=x,m=y);return m}function Wv(n,a,u=0,m=1/0,y){if(a=Math.floor(a),u=Math.floor(Math.max(0,u)),m=Math.floor(Math.min(n.length-1,m)),!(u<=a&&a<=m))return n;for(y=y===void 0?Md:k2(y);m>u;){if(m-u>600){const P=m-u+1,M=a-u+1,L=Math.log(P),V=.5*Math.exp(2*L/3),k=.5*Math.sqrt(L*V*(P-V)/P)*(M-P/2<0?-1:1),j=Math.max(u,Math.floor(a-M*V/P+k)),te=Math.min(m,Math.floor(a+(P-M)*V/P+k));Wv(n,a,j,te,y)}const x=n[a];let E=u,r=m;for(Um(n,u,a),y(n[m],x)>0&&Um(n,u,m);E<r;){for(Um(n,E,r),++E,--r;y(n[E],x)<0;)++E;for(;y(n[r],x)>0;)--r}y(n[u],x)===0?Um(n,u,r):(++r,Um(n,r,m)),r<=a&&(u=r+1),a<=r&&(m=r-1)}return n}function Um(n,a,u){const m=n[a];n[a]=n[u],n[u]=m}function bP(n,a=Ir){let u,m=!1;if(a.length===1){let y;for(const x of n){const E=a(x);(m?Ir(E,y)>0:Ir(E,E)===0)&&(u=x,y=E,m=!0)}}else for(const y of n)(m?a(y,u)>0:a(y,y)===0)&&(u=y,m=!0);return u}function v_(n,a,u){if(n=Float64Array.from(mF(n,u)),!(!(m=n.length)||isNaN(a=+a))){if(a<=0||m<2)return Zy(n);if(a>=1)return y_(n);var m,y=(m-1)*a,x=Math.floor(y),E=y_(Wv(n,x).subarray(0,x+1)),r=Zy(n.subarray(x+1));return E+(r-E)*(y-x)}}function wP(n,a,u=$y){if(!(!(m=n.length)||isNaN(a=+a))){if(a<=0||m<2)return+u(n[0],0,n);if(a>=1)return+u(n[m-1],m-1,n);var m,y=(m-1)*a,x=Math.floor(y),E=+u(n[x],x,n),r=+u(n[x+1],x+1,n);return E+(r-E)*(y-x)}}function TP(n,a,u=$y){if(!isNaN(a=+a)){if(m=Float64Array.from(n,(r,P)=>$y(u(n[P],P,n))),a<=0)return N2(m);if(a>=1)return B2(m);var m,y=Uint32Array.from(n,(r,P)=>P),x=m.length-1,E=Math.floor(x*a);return Wv(y,E,0,x,(r,P)=>Md(m[r],m[P])),E=bP(y.subarray(0,E+1),r=>m[r]),E>=0?E:-1}}function VF(n,a,u){const m=Zv(n),y=v_(n,.75)-v_(n,.25);return m&&y?Math.ceil((u-a)/(2*y*Math.pow(m,-1/3))):1}function UF(n,a,u){const m=Zv(n),y=hP(n);return m&&y?Math.ceil((u-a)*Math.cbrt(m)/(3.49*y)):1}function jF(n,a){let u=0,m=0;if(a===void 0)for(let y of n)y!=null&&(y=+y)>=y&&(++u,m+=y);else{let y=-1;for(let x of n)(x=a(x,++y,n))!=null&&(x=+x)>=x&&(++u,m+=x)}if(u)return m/u}function $F(n,a){return v_(n,.5,a)}function GF(n,a){return TP(n,.5,a)}function*qF(n){for(const a of n)yield*a}function V2(n){return Array.from(qF(n))}function HF(n,a){const u=new g_;if(a===void 0)for(let x of n)x!=null&&x>=x&&u.set(x,(u.get(x)||0)+1);else{let x=-1;for(let E of n)(E=a(E,++x,n))!=null&&E>=E&&u.set(E,(u.get(E)||0)+1)}let m,y=0;for(const[x,E]of u)E>y&&(y=E,m=x);return m}function ZF(n,a=WF){const u=[];let m,y=!1;for(const x of n)y&&u.push(a(m,x)),m=x,y=!0;return u}function WF(n,a){return[n,a]}function Nl(n,a,u){n=+n,a=+a,u=(y=arguments.length)<2?(a=n,n=0,1):y<3?1:+u;for(var m=-1,y=Math.max(0,Math.ceil((a-n)/u))|0,x=new Array(y);++m<y;)x[m]=n+m*u;return x}function XF(n,a=Ir){if(typeof n[Symbol.iterator]!="function")throw new TypeError("values is not iterable");let u=Array.from(n);const m=new Float64Array(u.length);a.length!==2&&(u=u.map(a),a=Ir);const y=(r,P)=>a(u[r],u[P]);let x,E;return n=Uint32Array.from(u,(r,P)=>P),n.sort(a===Ir?(r,P)=>Md(u[r],u[P]):k2(y)),n.forEach((r,P)=>{const M=y(r,x===void 0?r:x);M>=0?((x===void 0||M>0)&&(x=r,E=P),m[r]=E):m[r]=NaN}),m}function YF(n,a=Ir){let u,m=!1;if(a.length===1){let y;for(const x of n){const E=a(x);(m?Ir(E,y)<0:Ir(E,E)===0)&&(u=x,y=E,m=!0)}}else for(const y of n)(m?a(y,u)<0:a(y,y)===0)&&(u=y,m=!0);return u}function SP(n,a=Ir){if(a.length===1)return N2(n,a);let u,m=-1,y=-1;for(const x of n)++y,(m<0?a(x,x)===0:a(x,u)<0)&&(u=x,m=y);return m}function KF(n,a=Ir){if(a.length===1)return B2(n,a);let u,m=-1,y=-1;for(const x of n)++y,(m<0?a(x,x)===0:a(x,u)>0)&&(u=x,m=y);return m}function JF(n,a){const u=SP(n,a);return u<0?void 0:u}const QF=EP(Math.random);function EP(n){return function(u,m=0,y=u.length){let x=y-(m=+m);for(;x;){const E=n()*x--|0,r=u[x+m];u[x+m]=u[E+m],u[E+m]=r}return u}}function eB(n,a){let u=0;if(a===void 0)for(let m of n)(m=+m)&&(u+=m);else{let m=-1;for(let y of n)(y=+a(y,++m,n))&&(u+=y)}return u}function AP(n){if(!(x=n.length))return[];for(var a=-1,u=Zy(n,tB),m=new Array(u);++a<u;)for(var y=-1,x,E=m[a]=new Array(x);++y<x;)E[y]=n[y][a];return m}function tB(n){return n.length}function nB(){return AP(arguments)}function iB(n,a){if(typeof a!="function")throw new TypeError("test is not a function");let u=-1;for(const m of n)if(!a(m,++u,n))return!1;return!0}function rB(n,a){if(typeof a!="function")throw new TypeError("test is not a function");let u=-1;for(const m of n)if(a(m,++u,n))return!0;return!1}function oB(n,a){if(typeof a!="function")throw new TypeError("test is not a function");const u=[];let m=-1;for(const y of n)a(y,++m,n)&&u.push(y);return u}function sB(n,a){if(typeof n[Symbol.iterator]!="function")throw new TypeError("values is not iterable");if(typeof a!="function")throw new TypeError("mapper is not a function");return Array.from(n,(u,m)=>a(u,m,n))}function aB(n,a,u){if(typeof a!="function")throw new TypeError("reducer is not a function");const m=n[Symbol.iterator]();let y,x,E=-1;if(arguments.length<3){if({done:y,value:u}=m.next(),y)return;++E}for(;{done:y,value:x}=m.next(),!y;)u=a(u,x,++E,n);return u}function lB(n){if(typeof n[Symbol.iterator]!="function")throw new TypeError("values is not iterable");return Array.from(n).reverse()}function cB(n,...a){n=new bh(n);for(const u of a)for(const m of u)n.delete(m);return n}function uB(n,a){const u=a[Symbol.iterator](),m=new bh;for(const y of n){if(m.has(y))return!1;let x,E;for(;({value:x,done:E}=u.next())&&!E;){if(Object.is(y,x))return!1;m.add(x)}}return!0}function hB(n,...a){n=new bh(n),a=a.map(fB);e:for(const u of n)for(const m of a)if(!m.has(u)){n.delete(u);continue e}return n}function fB(n){return n instanceof bh?n:new bh(n)}function IP(n,a){const u=n[Symbol.iterator](),m=new Set;for(const y of a){const x=lM(y);if(m.has(x))continue;let E,r;for(;{value:E,done:r}=u.next();){if(r)return!1;const P=lM(E);if(m.add(P),Object.is(x,P))break}}return!0}function lM(n){return n!==null&&typeof n=="object"?n.valueOf():n}function dB(n,a){return IP(a,n)}function pB(...n){const a=new bh;for(const u of n)for(const m of u)a.add(m);return a}function mB(n){return n}var wy=1,Ty=2,zw=3,Ym=4,cM=1e-6;function _B(n){return"translate("+n+",0)"}function gB(n){return"translate(0,"+n+")"}function yB(n){return a=>+n(a)}function vB(n,a){return a=Math.max(0,n.bandwidth()-a*2)/2,n.round()&&(a=Math.round(a)),u=>+n(u)+a}function xB(){return!this.__axis}function Xv(n,a){var u=[],m=null,y=null,x=6,E=6,r=3,P=typeof window<"u"&&window.devicePixelRatio>1?0:.5,M=n===wy||n===Ym?-1:1,L=n===Ym||n===Ty?"x":"y",V=n===wy||n===zw?_B:gB;function k(j){var te=m??(a.ticks?a.ticks.apply(a,u):a.domain()),J=y??(a.tickFormat?a.tickFormat.apply(a,u):mB),Q=Math.max(x,0)+r,ee=a.range(),ue=+ee[0]+P,ce=+ee[ee.length-1]+P,se=(a.bandwidth?vB:yB)(a.copy(),P),Ae=j.selection?j.selection():j,De=Ae.selectAll(".domain").data([null]),Qe=Ae.selectAll(".tick").data(te,a).order(),nt=Qe.exit(),rt=Qe.enter().append("g").attr("class","tick"),tt=Qe.select("line"),Be=Qe.select("text");De=De.merge(De.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),Qe=Qe.merge(rt),tt=tt.merge(rt.append("line").attr("stroke","currentColor").attr(L+"2",M*x)),Be=Be.merge(rt.append("text").attr("fill","currentColor").attr(L,M*Q).attr("dy",n===wy?"0em":n===zw?"0.71em":"0.32em")),j!==Ae&&(De=De.transition(j),Qe=Qe.transition(j),tt=tt.transition(j),Be=Be.transition(j),nt=nt.transition(j).attr("opacity",cM).attr("transform",function(Rt){return isFinite(Rt=se(Rt))?V(Rt+P):this.getAttribute("transform")}),rt.attr("opacity",cM).attr("transform",function(Rt){var ut=this.parentNode.__axis;return V((ut&&isFinite(ut=ut(Rt))?ut:se(Rt))+P)})),nt.remove(),De.attr("d",n===Ym||n===Ty?E?"M"+M*E+","+ue+"H"+P+"V"+ce+"H"+M*E:"M"+P+","+ue+"V"+ce:E?"M"+ue+","+M*E+"V"+P+"H"+ce+"V"+M*E:"M"+ue+","+P+"H"+ce),Qe.attr("opacity",1).attr("transform",function(Rt){return V(se(Rt)+P)}),tt.attr(L+"2",M*x),Be.attr(L,M*Q).text(J),Ae.filter(xB).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",n===Ty?"start":n===Ym?"end":"middle"),Ae.each(function(){this.__axis=se})}return k.scale=function(j){return arguments.length?(a=j,k):a},k.ticks=function(){return u=Array.from(arguments),k},k.tickArguments=function(j){return arguments.length?(u=j==null?[]:Array.from(j),k):u.slice()},k.tickValues=function(j){return arguments.length?(m=j==null?null:Array.from(j),k):m&&m.slice()},k.tickFormat=function(j){return arguments.length?(y=j,k):y},k.tickSize=function(j){return arguments.length?(x=E=+j,k):x},k.tickSizeInner=function(j){return arguments.length?(x=+j,k):x},k.tickSizeOuter=function(j){return arguments.length?(E=+j,k):E},k.tickPadding=function(j){return arguments.length?(r=+j,k):r},k.offset=function(j){return arguments.length?(P=+j,k):P},k}function bB(n){return Xv(wy,n)}function wB(n){return Xv(Ty,n)}function TB(n){return Xv(zw,n)}function SB(n){return Xv(Ym,n)}var EB={value:()=>{}};function Rh(){for(var n=0,a=arguments.length,u={},m;n<a;++n){if(!(m=arguments[n]+"")||m in u||/[\s.]/.test(m))throw new Error("illegal type: "+m);u[m]=[]}return new Sy(u)}function Sy(n){this._=n}function AB(n,a){return n.trim().split(/^|\s+/).map(function(u){var m="",y=u.indexOf(".");if(y>=0&&(m=u.slice(y+1),u=u.slice(0,y)),u&&!a.hasOwnProperty(u))throw new Error("unknown type: "+u);return{type:u,name:m}})}Sy.prototype=Rh.prototype={constructor:Sy,on:function(n,a){var u=this._,m=AB(n+"",u),y,x=-1,E=m.length;if(arguments.length<2){for(;++x<E;)if((y=(n=m[x]).type)&&(y=IB(u[y],n.name)))return y;return}if(a!=null&&typeof a!="function")throw new Error("invalid callback: "+a);for(;++x<E;)if(y=(n=m[x]).type)u[y]=uM(u[y],n.name,a);else if(a==null)for(y in u)u[y]=uM(u[y],n.name,null);return this},copy:function(){var n={},a=this._;for(var u in a)n[u]=a[u].slice();return new Sy(n)},call:function(n,a){if((y=arguments.length-2)>0)for(var u=new Array(y),m=0,y,x;m<y;++m)u[m]=arguments[m+2];if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(x=this._[n],m=0,y=x.length;m<y;++m)x[m].value.apply(a,u)},apply:function(n,a,u){if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(var m=this._[n],y=0,x=m.length;y<x;++y)m[y].value.apply(a,u)}};function IB(n,a){for(var u=0,m=n.length,y;u<m;++u)if((y=n[u]).name===a)return y.value}function uM(n,a,u){for(var m=0,y=n.length;m<y;++m)if(n[m].name===a){n[m]=EB,n=n.slice(0,m).concat(n.slice(m+1));break}return u!=null&&n.push({name:a,value:u}),n}var Rw="http://www.w3.org/1999/xhtml";const Dw={svg:"http://www.w3.org/2000/svg",xhtml:Rw,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function B_(n){var a=n+="",u=a.indexOf(":");return u>=0&&(a=n.slice(0,u))!=="xmlns"&&(n=n.slice(u+1)),Dw.hasOwnProperty(a)?{space:Dw[a],local:n}:n}function MB(n){return function(){var a=this.ownerDocument,u=this.namespaceURI;return u===Rw&&a.documentElement.namespaceURI===Rw?a.createElement(n):a.createElementNS(u,n)}}function CB(n){return function(){return this.ownerDocument.createElementNS(n.space,n.local)}}function Yv(n){var a=B_(n);return(a.local?CB:MB)(a)}function PB(){}function Kv(n){return n==null?PB:function(){return this.querySelector(n)}}function zB(n){typeof n!="function"&&(n=Kv(n));for(var a=this._groups,u=a.length,m=new Array(u),y=0;y<u;++y)for(var x=a[y],E=x.length,r=m[y]=new Array(E),P,M,L=0;L<E;++L)(P=x[L])&&(M=n.call(P,P.__data__,L,x))&&("__data__"in P&&(M.__data__=P.__data__),r[L]=M);return new Vo(m,this._parents)}function MP(n){return n==null?[]:Array.isArray(n)?n:Array.from(n)}function RB(){return[]}function U2(n){return n==null?RB:function(){return this.querySelectorAll(n)}}function DB(n){return function(){return MP(n.apply(this,arguments))}}function LB(n){typeof n=="function"?n=DB(n):n=U2(n);for(var a=this._groups,u=a.length,m=[],y=[],x=0;x<u;++x)for(var E=a[x],r=E.length,P,M=0;M<r;++M)(P=E[M])&&(m.push(n.call(P,P.__data__,M,E)),y.push(P));return new Vo(m,y)}function j2(n){return function(){return this.matches(n)}}function CP(n){return function(a){return a.matches(n)}}var kB=Array.prototype.find;function OB(n){return function(){return kB.call(this.children,n)}}function FB(){return this.firstElementChild}function BB(n){return this.select(n==null?FB:OB(typeof n=="function"?n:CP(n)))}var NB=Array.prototype.filter;function VB(){return Array.from(this.children)}function UB(n){return function(){return NB.call(this.children,n)}}function jB(n){return this.selectAll(n==null?VB:UB(typeof n=="function"?n:CP(n)))}function $B(n){typeof n!="function"&&(n=j2(n));for(var a=this._groups,u=a.length,m=new Array(u),y=0;y<u;++y)for(var x=a[y],E=x.length,r=m[y]=[],P,M=0;M<E;++M)(P=x[M])&&n.call(P,P.__data__,M,x)&&r.push(P);return new Vo(m,this._parents)}function PP(n){return new Array(n.length)}function GB(){return new Vo(this._enter||this._groups.map(PP),this._parents)}function Wy(n,a){this.ownerDocument=n.ownerDocument,this.namespaceURI=n.namespaceURI,this._next=null,this._parent=n,this.__data__=a}Wy.prototype={constructor:Wy,appendChild:function(n){return this._parent.insertBefore(n,this._next)},insertBefore:function(n,a){return this._parent.insertBefore(n,a)},querySelector:function(n){return this._parent.querySelector(n)},querySelectorAll:function(n){return this._parent.querySelectorAll(n)}};function qB(n){return function(){return n}}function HB(n,a,u,m,y,x){for(var E=0,r,P=a.length,M=x.length;E<M;++E)(r=a[E])?(r.__data__=x[E],m[E]=r):u[E]=new Wy(n,x[E]);for(;E<P;++E)(r=a[E])&&(y[E]=r)}function ZB(n,a,u,m,y,x,E){var r,P,M=new Map,L=a.length,V=x.length,k=new Array(L),j;for(r=0;r<L;++r)(P=a[r])&&(k[r]=j=E.call(P,P.__data__,r,a)+"",M.has(j)?y[r]=P:M.set(j,P));for(r=0;r<V;++r)j=E.call(n,x[r],r,x)+"",(P=M.get(j))?(m[r]=P,P.__data__=x[r],M.delete(j)):u[r]=new Wy(n,x[r]);for(r=0;r<L;++r)(P=a[r])&&M.get(k[r])===P&&(y[r]=P)}function WB(n){return n.__data__}function XB(n,a){if(!arguments.length)return Array.from(this,WB);var u=a?ZB:HB,m=this._parents,y=this._groups;typeof n!="function"&&(n=qB(n));for(var x=y.length,E=new Array(x),r=new Array(x),P=new Array(x),M=0;M<x;++M){var L=m[M],V=y[M],k=V.length,j=YB(n.call(L,L&&L.__data__,M,m)),te=j.length,J=r[M]=new Array(te),Q=E[M]=new Array(te),ee=P[M]=new Array(k);u(L,V,J,Q,ee,j,a);for(var ue=0,ce=0,se,Ae;ue<te;++ue)if(se=J[ue]){for(ue>=ce&&(ce=ue+1);!(Ae=Q[ce])&&++ce<te;);se._next=Ae||null}}return E=new Vo(E,m),E._enter=r,E._exit=P,E}function YB(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function KB(){return new Vo(this._exit||this._groups.map(PP),this._parents)}function JB(n,a,u){var m=this.enter(),y=this,x=this.exit();return typeof n=="function"?(m=n(m),m&&(m=m.selection())):m=m.append(n+""),a!=null&&(y=a(y),y&&(y=y.selection())),u==null?x.remove():u(x),m&&y?m.merge(y).order():y}function QB(n){for(var a=n.selection?n.selection():n,u=this._groups,m=a._groups,y=u.length,x=m.length,E=Math.min(y,x),r=new Array(y),P=0;P<E;++P)for(var M=u[P],L=m[P],V=M.length,k=r[P]=new Array(V),j,te=0;te<V;++te)(j=M[te]||L[te])&&(k[te]=j);for(;P<y;++P)r[P]=u[P];return new Vo(r,this._parents)}function e6(){for(var n=this._groups,a=-1,u=n.length;++a<u;)for(var m=n[a],y=m.length-1,x=m[y],E;--y>=0;)(E=m[y])&&(x&&E.compareDocumentPosition(x)^4&&x.parentNode.insertBefore(E,x),x=E);return this}function t6(n){n||(n=n6);function a(V,k){return V&&k?n(V.__data__,k.__data__):!V-!k}for(var u=this._groups,m=u.length,y=new Array(m),x=0;x<m;++x){for(var E=u[x],r=E.length,P=y[x]=new Array(r),M,L=0;L<r;++L)(M=E[L])&&(P[L]=M);P.sort(a)}return new Vo(y,this._parents).order()}function n6(n,a){return n<a?-1:n>a?1:n>=a?0:NaN}function i6(){var n=arguments[0];return arguments[0]=this,n.apply(null,arguments),this}function r6(){return Array.from(this)}function o6(){for(var n=this._groups,a=0,u=n.length;a<u;++a)for(var m=n[a],y=0,x=m.length;y<x;++y){var E=m[y];if(E)return E}return null}function s6(){let n=0;for(const a of this)++n;return n}function a6(){return!this.node()}function l6(n){for(var a=this._groups,u=0,m=a.length;u<m;++u)for(var y=a[u],x=0,E=y.length,r;x<E;++x)(r=y[x])&&n.call(r,r.__data__,x,y);return this}function c6(n){return function(){this.removeAttribute(n)}}function u6(n){return function(){this.removeAttributeNS(n.space,n.local)}}function h6(n,a){return function(){this.setAttribute(n,a)}}function f6(n,a){return function(){this.setAttributeNS(n.space,n.local,a)}}function d6(n,a){return function(){var u=a.apply(this,arguments);u==null?this.removeAttribute(n):this.setAttribute(n,u)}}function p6(n,a){return function(){var u=a.apply(this,arguments);u==null?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,u)}}function m6(n,a){var u=B_(n);if(arguments.length<2){var m=this.node();return u.local?m.getAttributeNS(u.space,u.local):m.getAttribute(u)}return this.each((a==null?u.local?u6:c6:typeof a=="function"?u.local?p6:d6:u.local?f6:h6)(u,a))}function $2(n){return n.ownerDocument&&n.ownerDocument.defaultView||n.document&&n||n.defaultView}function _6(n){return function(){this.style.removeProperty(n)}}function g6(n,a,u){return function(){this.style.setProperty(n,a,u)}}function y6(n,a,u){return function(){var m=a.apply(this,arguments);m==null?this.style.removeProperty(n):this.style.setProperty(n,m,u)}}function v6(n,a,u){return arguments.length>1?this.each((a==null?_6:typeof a=="function"?y6:g6)(n,a,u??"")):Sh(this.node(),n)}function Sh(n,a){return n.style.getPropertyValue(a)||$2(n).getComputedStyle(n,null).getPropertyValue(a)}function x6(n){return function(){delete this[n]}}function b6(n,a){return function(){this[n]=a}}function w6(n,a){return function(){var u=a.apply(this,arguments);u==null?delete this[n]:this[n]=u}}function T6(n,a){return arguments.length>1?this.each((a==null?x6:typeof a=="function"?w6:b6)(n,a)):this.node()[n]}function zP(n){return n.trim().split(/^|\s+/)}function G2(n){return n.classList||new RP(n)}function RP(n){this._node=n,this._names=zP(n.getAttribute("class")||"")}RP.prototype={add:function(n){var a=this._names.indexOf(n);a<0&&(this._names.push(n),this._node.setAttribute("class",this._names.join(" ")))},remove:function(n){var a=this._names.indexOf(n);a>=0&&(this._names.splice(a,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(n){return this._names.indexOf(n)>=0}};function DP(n,a){for(var u=G2(n),m=-1,y=a.length;++m<y;)u.add(a[m])}function LP(n,a){for(var u=G2(n),m=-1,y=a.length;++m<y;)u.remove(a[m])}function S6(n){return function(){DP(this,n)}}function E6(n){return function(){LP(this,n)}}function A6(n,a){return function(){(a.apply(this,arguments)?DP:LP)(this,n)}}function I6(n,a){var u=zP(n+"");if(arguments.length<2){for(var m=G2(this.node()),y=-1,x=u.length;++y<x;)if(!m.contains(u[y]))return!1;return!0}return this.each((typeof a=="function"?A6:a?S6:E6)(u,a))}function M6(){this.textContent=""}function C6(n){return function(){this.textContent=n}}function P6(n){return function(){var a=n.apply(this,arguments);this.textContent=a??""}}function z6(n){return arguments.length?this.each(n==null?M6:(typeof n=="function"?P6:C6)(n)):this.node().textContent}function R6(){this.innerHTML=""}function D6(n){return function(){this.innerHTML=n}}function L6(n){return function(){var a=n.apply(this,arguments);this.innerHTML=a??""}}function k6(n){return arguments.length?this.each(n==null?R6:(typeof n=="function"?L6:D6)(n)):this.node().innerHTML}function O6(){this.nextSibling&&this.parentNode.appendChild(this)}function F6(){return this.each(O6)}function B6(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function N6(){return this.each(B6)}function V6(n){var a=typeof n=="function"?n:Yv(n);return this.select(function(){return this.appendChild(a.apply(this,arguments))})}function U6(){return null}function j6(n,a){var u=typeof n=="function"?n:Yv(n),m=a==null?U6:typeof a=="function"?a:Kv(a);return this.select(function(){return this.insertBefore(u.apply(this,arguments),m.apply(this,arguments)||null)})}function $6(){var n=this.parentNode;n&&n.removeChild(this)}function G6(){return this.each($6)}function q6(){var n=this.cloneNode(!1),a=this.parentNode;return a?a.insertBefore(n,this.nextSibling):n}function H6(){var n=this.cloneNode(!0),a=this.parentNode;return a?a.insertBefore(n,this.nextSibling):n}function Z6(n){return this.select(n?H6:q6)}function W6(n){return arguments.length?this.property("__data__",n):this.node().__data__}function X6(n){return function(a){n.call(this,a,this.__data__)}}function Y6(n){return n.trim().split(/^|\s+/).map(function(a){var u="",m=a.indexOf(".");return m>=0&&(u=a.slice(m+1),a=a.slice(0,m)),{type:a,name:u}})}function K6(n){return function(){var a=this.__on;if(a){for(var u=0,m=-1,y=a.length,x;u<y;++u)x=a[u],(!n.type||x.type===n.type)&&x.name===n.name?this.removeEventListener(x.type,x.listener,x.options):a[++m]=x;++m?a.length=m:delete this.__on}}}function J6(n,a,u){return function(){var m=this.__on,y,x=X6(a);if(m){for(var E=0,r=m.length;E<r;++E)if((y=m[E]).type===n.type&&y.name===n.name){this.removeEventListener(y.type,y.listener,y.options),this.addEventListener(y.type,y.listener=x,y.options=u),y.value=a;return}}this.addEventListener(n.type,x,u),y={type:n.type,name:n.name,value:a,listener:x,options:u},m?m.push(y):this.__on=[y]}}function Q6(n,a,u){var m=Y6(n+""),y,x=m.length,E;if(arguments.length<2){var r=this.node().__on;if(r){for(var P=0,M=r.length,L;P<M;++P)for(y=0,L=r[P];y<x;++y)if((E=m[y]).type===L.type&&E.name===L.name)return L.value}return}for(r=a?J6:K6,y=0;y<x;++y)this.each(r(m[y],a,u));return this}function kP(n,a,u){var m=$2(n),y=m.CustomEvent;typeof y=="function"?y=new y(a,u):(y=m.document.createEvent("Event"),u?(y.initEvent(a,u.bubbles,u.cancelable),y.detail=u.detail):y.initEvent(a,!1,!1)),n.dispatchEvent(y)}function eN(n,a){return function(){return kP(this,n,a)}}function tN(n,a){return function(){return kP(this,n,a.apply(this,arguments))}}function nN(n,a){return this.each((typeof a=="function"?tN:eN)(n,a))}function*iN(){for(var n=this._groups,a=0,u=n.length;a<u;++a)for(var m=n[a],y=0,x=m.length,E;y<x;++y)(E=m[y])&&(yield E)}var q2=[null];function Vo(n,a){this._groups=n,this._parents=a}function Dh(){return new Vo([[document.documentElement]],q2)}function rN(){return this}Vo.prototype=Dh.prototype={constructor:Vo,select:zB,selectAll:LB,selectChild:BB,selectChildren:jB,filter:$B,data:XB,enter:GB,exit:KB,join:JB,merge:QB,selection:rN,order:e6,sort:t6,call:i6,nodes:r6,node:o6,size:s6,empty:a6,each:l6,attr:m6,style:v6,property:T6,classed:I6,text:z6,html:k6,raise:F6,lower:N6,append:V6,insert:j6,remove:G6,clone:Z6,datum:W6,on:Q6,dispatch:nN,[Symbol.iterator]:iN};function Ao(n){return typeof n=="string"?new Vo([[document.querySelector(n)]],[document.documentElement]):new Vo([[n]],q2)}function oN(n){return Ao(Yv(n).call(document.documentElement))}var sN=0;function OP(){return new Lw}function Lw(){this._="@"+(++sN).toString(36)}Lw.prototype=OP.prototype={constructor:Lw,get:function(n){for(var a=this._;!(a in n);)if(!(n=n.parentNode))return;return n[a]},set:function(n,a){return n[this._]=a},remove:function(n){return this._ in n&&delete n[this._]},toString:function(){return this._}};function FP(n){let a;for(;a=n.sourceEvent;)n=a;return n}function ys(n,a){if(n=FP(n),a===void 0&&(a=n.currentTarget),a){var u=a.ownerSVGElement||a;if(u.createSVGPoint){var m=u.createSVGPoint();return m.x=n.clientX,m.y=n.clientY,m=m.matrixTransform(a.getScreenCTM().inverse()),[m.x,m.y]}if(a.getBoundingClientRect){var y=a.getBoundingClientRect();return[n.clientX-y.left-a.clientLeft,n.clientY-y.top-a.clientTop]}}return[n.pageX,n.pageY]}function aN(n,a){return n.target&&(n=FP(n),a===void 0&&(a=n.currentTarget),n=n.touches||[n]),Array.from(n,u=>ys(u,a))}function lN(n){return typeof n=="string"?new Vo([document.querySelectorAll(n)],[document.documentElement]):new Vo([MP(n)],q2)}const cN={passive:!1},x_={capture:!0,passive:!1};function Bb(n){n.stopImmediatePropagation()}function xd(n){n.preventDefault(),n.stopImmediatePropagation()}function Jv(n){var a=n.document.documentElement,u=Ao(n).on("dragstart.drag",xd,x_);"onselectstart"in a?u.on("selectstart.drag",xd,x_):(a.__noselect=a.style.MozUserSelect,a.style.MozUserSelect="none")}function Qv(n,a){var u=n.document.documentElement,m=Ao(n).on("dragstart.drag",null);a&&(m.on("click.drag",xd,x_),setTimeout(function(){m.on("click.drag",null)},0)),"onselectstart"in u?m.on("selectstart.drag",null):(u.style.MozUserSelect=u.__noselect,delete u.__noselect)}const K0=n=>()=>n;function kw(n,{sourceEvent:a,subject:u,target:m,identifier:y,active:x,x:E,y:r,dx:P,dy:M,dispatch:L}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:a,enumerable:!0,configurable:!0},subject:{value:u,enumerable:!0,configurable:!0},target:{value:m,enumerable:!0,configurable:!0},identifier:{value:y,enumerable:!0,configurable:!0},active:{value:x,enumerable:!0,configurable:!0},x:{value:E,enumerable:!0,configurable:!0},y:{value:r,enumerable:!0,configurable:!0},dx:{value:P,enumerable:!0,configurable:!0},dy:{value:M,enumerable:!0,configurable:!0},_:{value:L}})}kw.prototype.on=function(){var n=this._.on.apply(this._,arguments);return n===this._?this:n};function uN(n){return!n.ctrlKey&&!n.button}function hN(){return this.parentNode}function fN(n,a){return a??{x:n.x,y:n.y}}function dN(){return navigator.maxTouchPoints||"ontouchstart"in this}function pN(){var n=uN,a=hN,u=fN,m=dN,y={},x=Rh("start","drag","end"),E=0,r,P,M,L,V=0;function k(se){se.on("mousedown.drag",j).filter(m).on("touchstart.drag",Q).on("touchmove.drag",ee,cN).on("touchend.drag touchcancel.drag",ue).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function j(se,Ae){if(!(L||!n.call(this,se,Ae))){var De=ce(this,a.call(this,se,Ae),se,Ae,"mouse");De&&(Ao(se.view).on("mousemove.drag",te,x_).on("mouseup.drag",J,x_),Jv(se.view),Bb(se),M=!1,r=se.clientX,P=se.clientY,De("start",se))}}function te(se){if(xd(se),!M){var Ae=se.clientX-r,De=se.clientY-P;M=Ae*Ae+De*De>V}y.mouse("drag",se)}function J(se){Ao(se.view).on("mousemove.drag mouseup.drag",null),Qv(se.view,M),xd(se),y.mouse("end",se)}function Q(se,Ae){if(n.call(this,se,Ae)){var De=se.changedTouches,Qe=a.call(this,se,Ae),nt=De.length,rt,tt;for(rt=0;rt<nt;++rt)(tt=ce(this,Qe,se,Ae,De[rt].identifier,De[rt]))&&(Bb(se),tt("start",se,De[rt]))}}function ee(se){var Ae=se.changedTouches,De=Ae.length,Qe,nt;for(Qe=0;Qe<De;++Qe)(nt=y[Ae[Qe].identifier])&&(xd(se),nt("drag",se,Ae[Qe]))}function ue(se){var Ae=se.changedTouches,De=Ae.length,Qe,nt;for(L&&clearTimeout(L),L=setTimeout(function(){L=null},500),Qe=0;Qe<De;++Qe)(nt=y[Ae[Qe].identifier])&&(Bb(se),nt("end",se,Ae[Qe]))}function ce(se,Ae,De,Qe,nt,rt){var tt=x.copy(),Be=ys(rt||De,Ae),Rt,ut,Pe;if((Pe=u.call(se,new kw("beforestart",{sourceEvent:De,target:k,identifier:nt,active:E,x:Be[0],y:Be[1],dx:0,dy:0,dispatch:tt}),Qe))!=null)return Rt=Pe.x-Be[0]||0,ut=Pe.y-Be[1]||0,function Ve(qe,bt,Ht){var Dt=Be,Lt;switch(qe){case"start":y[nt]=Ve,Lt=E++;break;case"end":delete y[nt],--E;case"drag":Be=ys(Ht||bt,Ae),Lt=E;break}tt.call(qe,se,new kw(qe,{sourceEvent:bt,subject:Pe,target:k,identifier:nt,active:Lt,x:Be[0]+Rt,y:Be[1]+ut,dx:Be[0]-Dt[0],dy:Be[1]-Dt[1],dispatch:tt}),Qe)}}return k.filter=function(se){return arguments.length?(n=typeof se=="function"?se:K0(!!se),k):n},k.container=function(se){return arguments.length?(a=typeof se=="function"?se:K0(se),k):a},k.subject=function(se){return arguments.length?(u=typeof se=="function"?se:K0(se),k):u},k.touchable=function(se){return arguments.length?(m=typeof se=="function"?se:K0(!!se),k):m},k.on=function(){var se=x.on.apply(x,arguments);return se===x?k:se},k.clickDistance=function(se){return arguments.length?(V=(se=+se)*se,k):Math.sqrt(V)},k}function Zd(n,a,u){n.prototype=a.prototype=u,u.constructor=n}function N_(n,a){var u=Object.create(n.prototype);for(var m in a)u[m]=a[m];return u}function iu(){}var Eh=.7,Cd=1/Eh,bd="\\s*([+-]?\\d+)\\s*",b_="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ja="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",mN=/^#([0-9a-f]{3,8})$/,_N=new RegExp(`^rgb\\(${bd},${bd},${bd}\\)$`),gN=new RegExp(`^rgb\\(${ja},${ja},${ja}\\)$`),yN=new RegExp(`^rgba\\(${bd},${bd},${bd},${b_}\\)$`),vN=new RegExp(`^rgba\\(${ja},${ja},${ja},${b_}\\)$`),xN=new RegExp(`^hsl\\(${b_},${ja},${ja}\\)$`),bN=new RegExp(`^hsla\\(${b_},${ja},${ja},${b_}\\)$`),hM={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Zd(iu,Jc,{copy(n){return Object.assign(new this.constructor,this,n)},displayable(){return this.rgb().displayable()},hex:fM,formatHex:fM,formatHex8:wN,formatHsl:TN,formatRgb:dM,toString:dM});function fM(){return this.rgb().formatHex()}function wN(){return this.rgb().formatHex8()}function TN(){return BP(this).formatHsl()}function dM(){return this.rgb().formatRgb()}function Jc(n){var a,u;return n=(n+"").trim().toLowerCase(),(a=mN.exec(n))?(u=a[1].length,a=parseInt(a[1],16),u===6?pM(a):u===3?new no(a>>8&15|a>>4&240,a>>4&15|a&240,(a&15)<<4|a&15,1):u===8?J0(a>>24&255,a>>16&255,a>>8&255,(a&255)/255):u===4?J0(a>>12&15|a>>8&240,a>>8&15|a>>4&240,a>>4&15|a&240,((a&15)<<4|a&15)/255):null):(a=_N.exec(n))?new no(a[1],a[2],a[3],1):(a=gN.exec(n))?new no(a[1]*255/100,a[2]*255/100,a[3]*255/100,1):(a=yN.exec(n))?J0(a[1],a[2],a[3],a[4]):(a=vN.exec(n))?J0(a[1]*255/100,a[2]*255/100,a[3]*255/100,a[4]):(a=xN.exec(n))?gM(a[1],a[2]/100,a[3]/100,1):(a=bN.exec(n))?gM(a[1],a[2]/100,a[3]/100,a[4]):hM.hasOwnProperty(n)?pM(hM[n]):n==="transparent"?new no(NaN,NaN,NaN,0):null}function pM(n){return new no(n>>16&255,n>>8&255,n&255,1)}function J0(n,a,u,m){return m<=0&&(n=a=u=NaN),new no(n,a,u,m)}function H2(n){return n instanceof iu||(n=Jc(n)),n?(n=n.rgb(),new no(n.r,n.g,n.b,n.opacity)):new no}function Pd(n,a,u,m){return arguments.length===1?H2(n):new no(n,a,u,m??1)}function no(n,a,u,m){this.r=+n,this.g=+a,this.b=+u,this.opacity=+m}Zd(no,Pd,N_(iu,{brighter(n){return n=n==null?Cd:Math.pow(Cd,n),new no(this.r*n,this.g*n,this.b*n,this.opacity)},darker(n){return n=n==null?Eh:Math.pow(Eh,n),new no(this.r*n,this.g*n,this.b*n,this.opacity)},rgb(){return this},clamp(){return new no(yh(this.r),yh(this.g),yh(this.b),Xy(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:mM,formatHex:mM,formatHex8:SN,formatRgb:_M,toString:_M}));function mM(){return`#${mh(this.r)}${mh(this.g)}${mh(this.b)}`}function SN(){return`#${mh(this.r)}${mh(this.g)}${mh(this.b)}${mh((isNaN(this.opacity)?1:this.opacity)*255)}`}function _M(){const n=Xy(this.opacity);return`${n===1?"rgb(":"rgba("}${yh(this.r)}, ${yh(this.g)}, ${yh(this.b)}${n===1?")":`, ${n})`}`}function Xy(n){return isNaN(n)?1:Math.max(0,Math.min(1,n))}function yh(n){return Math.max(0,Math.min(255,Math.round(n)||0))}function mh(n){return n=yh(n),(n<16?"0":"")+n.toString(16)}function gM(n,a,u,m){return m<=0?n=a=u=NaN:u<=0||u>=1?n=a=NaN:a<=0&&(n=NaN),new sa(n,a,u,m)}function BP(n){if(n instanceof sa)return new sa(n.h,n.s,n.l,n.opacity);if(n instanceof iu||(n=Jc(n)),!n)return new sa;if(n instanceof sa)return n;n=n.rgb();var a=n.r/255,u=n.g/255,m=n.b/255,y=Math.min(a,u,m),x=Math.max(a,u,m),E=NaN,r=x-y,P=(x+y)/2;return r?(a===x?E=(u-m)/r+(u<m)*6:u===x?E=(m-a)/r+2:E=(a-u)/r+4,r/=P<.5?x+y:2-x-y,E*=60):r=P>0&&P<1?0:E,new sa(E,r,P,n.opacity)}function Yy(n,a,u,m){return arguments.length===1?BP(n):new sa(n,a,u,m??1)}function sa(n,a,u,m){this.h=+n,this.s=+a,this.l=+u,this.opacity=+m}Zd(sa,Yy,N_(iu,{brighter(n){return n=n==null?Cd:Math.pow(Cd,n),new sa(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?Eh:Math.pow(Eh,n),new sa(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=this.h%360+(this.h<0)*360,a=isNaN(n)||isNaN(this.s)?0:this.s,u=this.l,m=u+(u<.5?u:1-u)*a,y=2*u-m;return new no(Nb(n>=240?n-240:n+120,y,m),Nb(n,y,m),Nb(n<120?n+240:n-120,y,m),this.opacity)},clamp(){return new sa(yM(this.h),Q0(this.s),Q0(this.l),Xy(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const n=Xy(this.opacity);return`${n===1?"hsl(":"hsla("}${yM(this.h)}, ${Q0(this.s)*100}%, ${Q0(this.l)*100}%${n===1?")":`, ${n})`}`}}));function yM(n){return n=(n||0)%360,n<0?n+360:n}function Q0(n){return Math.max(0,Math.min(1,n||0))}function Nb(n,a,u){return(n<60?a+(u-a)*n/60:n<180?u:n<240?a+(u-a)*(240-n)/60:a)*255}const NP=Math.PI/180,VP=180/Math.PI,Ky=18,UP=.96422,jP=1,$P=.82521,GP=4/29,wd=6/29,qP=3*wd*wd,EN=wd*wd*wd;function HP(n){if(n instanceof ca)return new ca(n.l,n.a,n.b,n.opacity);if(n instanceof Va)return WP(n);n instanceof no||(n=H2(n));var a=$b(n.r),u=$b(n.g),m=$b(n.b),y=Vb((.2225045*a+.7168786*u+.0606169*m)/jP),x,E;return a===u&&u===m?x=E=y:(x=Vb((.4360747*a+.3850649*u+.1430804*m)/UP),E=Vb((.0139322*a+.0971045*u+.7141733*m)/$P)),new ca(116*y-16,500*(x-y),200*(y-E),n.opacity)}function AN(n,a){return new ca(n,0,0,a??1)}function Jy(n,a,u,m){return arguments.length===1?HP(n):new ca(n,a,u,m??1)}function ca(n,a,u,m){this.l=+n,this.a=+a,this.b=+u,this.opacity=+m}Zd(ca,Jy,N_(iu,{brighter(n){return new ca(this.l+Ky*(n??1),this.a,this.b,this.opacity)},darker(n){return new ca(this.l-Ky*(n??1),this.a,this.b,this.opacity)},rgb(){var n=(this.l+16)/116,a=isNaN(this.a)?n:n+this.a/500,u=isNaN(this.b)?n:n-this.b/200;return a=UP*Ub(a),n=jP*Ub(n),u=$P*Ub(u),new no(jb(3.1338561*a-1.6168667*n-.4906146*u),jb(-.9787684*a+1.9161415*n+.033454*u),jb(.0719453*a-.2289914*n+1.4052427*u),this.opacity)}}));function Vb(n){return n>EN?Math.pow(n,1/3):n/qP+GP}function Ub(n){return n>wd?n*n*n:qP*(n-GP)}function jb(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function $b(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function ZP(n){if(n instanceof Va)return new Va(n.h,n.c,n.l,n.opacity);if(n instanceof ca||(n=HP(n)),n.a===0&&n.b===0)return new Va(NaN,0<n.l&&n.l<100?0:NaN,n.l,n.opacity);var a=Math.atan2(n.b,n.a)*VP;return new Va(a<0?a+360:a,Math.sqrt(n.a*n.a+n.b*n.b),n.l,n.opacity)}function IN(n,a,u,m){return arguments.length===1?ZP(n):new Va(u,a,n,m??1)}function Qy(n,a,u,m){return arguments.length===1?ZP(n):new Va(n,a,u,m??1)}function Va(n,a,u,m){this.h=+n,this.c=+a,this.l=+u,this.opacity=+m}function WP(n){if(isNaN(n.h))return new ca(n.l,0,0,n.opacity);var a=n.h*NP;return new ca(n.l,Math.cos(a)*n.c,Math.sin(a)*n.c,n.opacity)}Zd(Va,Qy,N_(iu,{brighter(n){return new Va(this.h,this.c,this.l+Ky*(n??1),this.opacity)},darker(n){return new Va(this.h,this.c,this.l-Ky*(n??1),this.opacity)},rgb(){return WP(this).rgb()}}));var XP=-.14861,Z2=1.78277,W2=-.29227,ex=-.90649,w_=1.97294,vM=w_*ex,xM=w_*Z2,bM=Z2*W2-ex*XP;function MN(n){if(n instanceof vh)return new vh(n.h,n.s,n.l,n.opacity);n instanceof no||(n=H2(n));var a=n.r/255,u=n.g/255,m=n.b/255,y=(bM*m+vM*a-xM*u)/(bM+vM-xM),x=m-y,E=(w_*(u-y)-W2*x)/ex,r=Math.sqrt(E*E+x*x)/(w_*y*(1-y)),P=r?Math.atan2(E,x)*VP-120:NaN;return new vh(P<0?P+360:P,r,y,n.opacity)}function ha(n,a,u,m){return arguments.length===1?MN(n):new vh(n,a,u,m??1)}function vh(n,a,u,m){this.h=+n,this.s=+a,this.l=+u,this.opacity=+m}Zd(vh,ha,N_(iu,{brighter(n){return n=n==null?Cd:Math.pow(Cd,n),new vh(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?Eh:Math.pow(Eh,n),new vh(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=isNaN(this.h)?0:(this.h+120)*NP,a=+this.l,u=isNaN(this.s)?0:this.s*a*(1-a),m=Math.cos(n),y=Math.sin(n);return new no(255*(a+u*(XP*m+Z2*y)),255*(a+u*(W2*m+ex*y)),255*(a+u*(w_*m)),this.opacity)}}));function YP(n,a,u,m,y){var x=n*n,E=x*n;return((1-3*n+3*x-E)*a+(4-6*x+3*E)*u+(1+3*n+3*x-3*E)*m+E*y)/6}function KP(n){var a=n.length-1;return function(u){var m=u<=0?u=0:u>=1?(u=1,a-1):Math.floor(u*a),y=n[m],x=n[m+1],E=m>0?n[m-1]:2*y-x,r=m<a-1?n[m+2]:2*x-y;return YP((u-m/a)*a,E,y,x,r)}}function JP(n){var a=n.length;return function(u){var m=Math.floor(((u%=1)<0?++u:u)*a),y=n[(m+a-1)%a],x=n[m%a],E=n[(m+1)%a],r=n[(m+2)%a];return YP((u-m/a)*a,y,x,E,r)}}const tx=n=>()=>n;function QP(n,a){return function(u){return n+u*a}}function CN(n,a,u){return n=Math.pow(n,u),a=Math.pow(a,u)-n,u=1/u,function(m){return Math.pow(n+m*a,u)}}function nx(n,a){var u=a-n;return u?QP(n,u>180||u<-180?u-360*Math.round(u/360):u):tx(isNaN(n)?a:n)}function PN(n){return(n=+n)==1?io:function(a,u){return u-a?CN(a,u,n):tx(isNaN(a)?u:a)}}function io(n,a){var u=a-n;return u?QP(n,u):tx(isNaN(n)?a:n)}const T_=function n(a){var u=PN(a);function m(y,x){var E=u((y=Pd(y)).r,(x=Pd(x)).r),r=u(y.g,x.g),P=u(y.b,x.b),M=io(y.opacity,x.opacity);return function(L){return y.r=E(L),y.g=r(L),y.b=P(L),y.opacity=M(L),y+""}}return m.gamma=n,m}(1);function ez(n){return function(a){var u=a.length,m=new Array(u),y=new Array(u),x=new Array(u),E,r;for(E=0;E<u;++E)r=Pd(a[E]),m[E]=r.r||0,y[E]=r.g||0,x[E]=r.b||0;return m=n(m),y=n(y),x=n(x),r.opacity=1,function(P){return r.r=m(P),r.g=y(P),r.b=x(P),r+""}}}var tz=ez(KP),zN=ez(JP);function X2(n,a){a||(a=[]);var u=n?Math.min(a.length,n.length):0,m=a.slice(),y;return function(x){for(y=0;y<u;++y)m[y]=n[y]*(1-x)+a[y]*x;return m}}function nz(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function RN(n,a){return(nz(a)?X2:iz)(n,a)}function iz(n,a){var u=a?a.length:0,m=n?Math.min(u,n.length):0,y=new Array(m),x=new Array(u),E;for(E=0;E<m;++E)y[E]=ru(n[E],a[E]);for(;E<u;++E)x[E]=a[E];return function(r){for(E=0;E<m;++E)x[E]=y[E](r);return x}}function rz(n,a){var u=new Date;return n=+n,a=+a,function(m){return u.setTime(n*(1-m)+a*m),u}}function ks(n,a){return n=+n,a=+a,function(u){return n*(1-u)+a*u}}function oz(n,a){var u={},m={},y;(n===null||typeof n!="object")&&(n={}),(a===null||typeof a!="object")&&(a={});for(y in a)y in n?u[y]=ru(n[y],a[y]):m[y]=a[y];return function(x){for(y in u)m[y]=u[y](x);return m}}var Ow=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Gb=new RegExp(Ow.source,"g");function DN(n){return function(){return n}}function LN(n){return function(a){return n(a)+""}}function Y2(n,a){var u=Ow.lastIndex=Gb.lastIndex=0,m,y,x,E=-1,r=[],P=[];for(n=n+"",a=a+"";(m=Ow.exec(n))&&(y=Gb.exec(a));)(x=y.index)>u&&(x=a.slice(u,x),r[E]?r[E]+=x:r[++E]=x),(m=m[0])===(y=y[0])?r[E]?r[E]+=y:r[++E]=y:(r[++E]=null,P.push({i:E,x:ks(m,y)})),u=Gb.lastIndex;return u<a.length&&(x=a.slice(u),r[E]?r[E]+=x:r[++E]=x),r.length<2?P[0]?LN(P[0].x):DN(a):(a=P.length,function(M){for(var L=0,V;L<a;++L)r[(V=P[L]).i]=V.x(M);return r.join("")})}function ru(n,a){var u=typeof a,m;return a==null||u==="boolean"?tx(a):(u==="number"?ks:u==="string"?(m=Jc(a))?(a=m,T_):Y2:a instanceof Jc?T_:a instanceof Date?rz:nz(a)?X2:Array.isArray(a)?iz:typeof a.valueOf!="function"&&typeof a.toString!="function"||isNaN(a)?oz:ks)(n,a)}function kN(n){var a=n.length;return function(u){return n[Math.max(0,Math.min(a-1,Math.floor(u*a)))]}}function ON(n,a){var u=nx(+n,+a);return function(m){var y=u(m);return y-360*Math.floor(y/360)}}function ix(n,a){return n=+n,a=+a,function(u){return Math.round(n*(1-u)+a*u)}}var wM=180/Math.PI,Fw={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function sz(n,a,u,m,y,x){var E,r,P;return(E=Math.sqrt(n*n+a*a))&&(n/=E,a/=E),(P=n*u+a*m)&&(u-=n*P,m-=a*P),(r=Math.sqrt(u*u+m*m))&&(u/=r,m/=r,P/=r),n*m<a*u&&(n=-n,a=-a,P=-P,E=-E),{translateX:y,translateY:x,rotate:Math.atan2(a,n)*wM,skewX:Math.atan(P)*wM,scaleX:E,scaleY:r}}var ey;function FN(n){const a=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(n+"");return a.isIdentity?Fw:sz(a.a,a.b,a.c,a.d,a.e,a.f)}function BN(n){return n==null||(ey||(ey=document.createElementNS("http://www.w3.org/2000/svg","g")),ey.setAttribute("transform",n),!(n=ey.transform.baseVal.consolidate()))?Fw:(n=n.matrix,sz(n.a,n.b,n.c,n.d,n.e,n.f))}function az(n,a,u,m){function y(M){return M.length?M.pop()+" ":""}function x(M,L,V,k,j,te){if(M!==V||L!==k){var J=j.push("translate(",null,a,null,u);te.push({i:J-4,x:ks(M,V)},{i:J-2,x:ks(L,k)})}else(V||k)&&j.push("translate("+V+a+k+u)}function E(M,L,V,k){M!==L?(M-L>180?L+=360:L-M>180&&(M+=360),k.push({i:V.push(y(V)+"rotate(",null,m)-2,x:ks(M,L)})):L&&V.push(y(V)+"rotate("+L+m)}function r(M,L,V,k){M!==L?k.push({i:V.push(y(V)+"skewX(",null,m)-2,x:ks(M,L)}):L&&V.push(y(V)+"skewX("+L+m)}function P(M,L,V,k,j,te){if(M!==V||L!==k){var J=j.push(y(j)+"scale(",null,",",null,")");te.push({i:J-4,x:ks(M,V)},{i:J-2,x:ks(L,k)})}else(V!==1||k!==1)&&j.push(y(j)+"scale("+V+","+k+")")}return function(M,L){var V=[],k=[];return M=n(M),L=n(L),x(M.translateX,M.translateY,L.translateX,L.translateY,V,k),E(M.rotate,L.rotate,V,k),r(M.skewX,L.skewX,V,k),P(M.scaleX,M.scaleY,L.scaleX,L.scaleY,V,k),M=L=null,function(j){for(var te=-1,J=k.length,Q;++te<J;)V[(Q=k[te]).i]=Q.x(j);return V.join("")}}}var lz=az(FN,"px, ","px)","deg)"),cz=az(BN,", ",")",")"),NN=1e-12;function TM(n){return((n=Math.exp(n))+1/n)/2}function VN(n){return((n=Math.exp(n))-1/n)/2}function UN(n){return((n=Math.exp(2*n))-1)/(n+1)}const uz=function n(a,u,m){function y(x,E){var r=x[0],P=x[1],M=x[2],L=E[0],V=E[1],k=E[2],j=L-r,te=V-P,J=j*j+te*te,Q,ee;if(J<NN)ee=Math.log(k/M)/a,Q=function(Qe){return[r+Qe*j,P+Qe*te,M*Math.exp(a*Qe*ee)]};else{var ue=Math.sqrt(J),ce=(k*k-M*M+m*J)/(2*M*u*ue),se=(k*k-M*M-m*J)/(2*k*u*ue),Ae=Math.log(Math.sqrt(ce*ce+1)-ce),De=Math.log(Math.sqrt(se*se+1)-se);ee=(De-Ae)/a,Q=function(Qe){var nt=Qe*ee,rt=TM(Ae),tt=M/(u*ue)*(rt*UN(a*nt+Ae)-VN(Ae));return[r+tt*j,P+tt*te,M*rt/TM(a*nt+Ae)]}}return Q.duration=ee*1e3*a/Math.SQRT2,Q}return y.rho=function(x){var E=Math.max(.001,+x),r=E*E,P=r*r;return n(E,r,P)},y}(Math.SQRT2,2,4);function hz(n){return function(a,u){var m=n((a=Yy(a)).h,(u=Yy(u)).h),y=io(a.s,u.s),x=io(a.l,u.l),E=io(a.opacity,u.opacity);return function(r){return a.h=m(r),a.s=y(r),a.l=x(r),a.opacity=E(r),a+""}}}const jN=hz(nx);var $N=hz(io);function GN(n,a){var u=io((n=Jy(n)).l,(a=Jy(a)).l),m=io(n.a,a.a),y=io(n.b,a.b),x=io(n.opacity,a.opacity);return function(E){return n.l=u(E),n.a=m(E),n.b=y(E),n.opacity=x(E),n+""}}function fz(n){return function(a,u){var m=n((a=Qy(a)).h,(u=Qy(u)).h),y=io(a.c,u.c),x=io(a.l,u.l),E=io(a.opacity,u.opacity);return function(r){return a.h=m(r),a.c=y(r),a.l=x(r),a.opacity=E(r),a+""}}}const qN=fz(nx);var HN=fz(io);function dz(n){return function a(u){u=+u;function m(y,x){var E=n((y=ha(y)).h,(x=ha(x)).h),r=io(y.s,x.s),P=io(y.l,x.l),M=io(y.opacity,x.opacity);return function(L){return y.h=E(L),y.s=r(L),y.l=P(Math.pow(L,u)),y.opacity=M(L),y+""}}return m.gamma=a,m}(1)}const ZN=dz(nx);var rx=dz(io);function pz(n,a){a===void 0&&(a=n,n=ru);for(var u=0,m=a.length-1,y=a[0],x=new Array(m<0?0:m);u<m;)x[u]=n(y,y=a[++u]);return function(E){var r=Math.max(0,Math.min(m-1,Math.floor(E*=m)));return x[r](E-r)}}function WN(n,a){for(var u=new Array(a),m=0;m<a;++m)u[m]=n(m/(a-1));return u}var zd=0,Km=0,jm=0,mz=1e3,ev,Jm,tv=0,Ah=0,ox=0,S_=typeof performance=="object"&&performance.now?performance:Date,_z=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(n){setTimeout(n,17)};function V_(){return Ah||(_z(XN),Ah=S_.now()+ox)}function XN(){Ah=0}function E_(){this._call=this._time=this._next=null}E_.prototype=sx.prototype={constructor:E_,restart:function(n,a,u){if(typeof n!="function")throw new TypeError("callback is not a function");u=(u==null?V_():+u)+(a==null?0:+a),!this._next&&Jm!==this&&(Jm?Jm._next=this:ev=this,Jm=this),this._call=n,this._time=u,Bw()},stop:function(){this._call&&(this._call=null,this._time=1/0,Bw())}};function sx(n,a,u){var m=new E_;return m.restart(n,a,u),m}function gz(){V_(),++zd;for(var n=ev,a;n;)(a=Ah-n._time)>=0&&n._call.call(void 0,a),n=n._next;--zd}function SM(){Ah=(tv=S_.now())+ox,zd=Km=0;try{gz()}finally{zd=0,KN(),Ah=0}}function YN(){var n=S_.now(),a=n-tv;a>mz&&(ox-=a,tv=n)}function KN(){for(var n,a=ev,u,m=1/0;a;)a._call?(m>a._time&&(m=a._time),n=a,a=a._next):(u=a._next,a._next=null,a=n?n._next=u:ev=u);Jm=n,Bw(m)}function Bw(n){if(!zd){Km&&(Km=clearTimeout(Km));var a=n-Ah;a>24?(n<1/0&&(Km=setTimeout(SM,n-S_.now()-ox)),jm&&(jm=clearInterval(jm))):(jm||(tv=S_.now(),jm=setInterval(YN,mz)),zd=1,_z(SM))}}function Nw(n,a,u){var m=new E_;return a=a==null?0:+a,m.restart(y=>{m.stop(),n(y+a)},a,u),m}function JN(n,a,u){var m=new E_,y=a;return a==null?(m.restart(n,a,u),m):(m._restart=m.restart,m.restart=function(x,E,r){E=+E,r=r==null?V_():+r,m._restart(function P(M){M+=y,m._restart(P,y+=E,r),x(M)},E,r)},m.restart(n,a,u),m)}var QN=Rh("start","end","cancel","interrupt"),e8=[],yz=0,Vw=1,Uw=2,Ey=3,EM=4,jw=5,Ay=6;function ax(n,a,u,m,y,x){var E=n.__transition;if(!E)n.__transition={};else if(u in E)return;t8(n,u,{name:a,index:m,group:y,on:QN,tween:e8,time:x.time,delay:x.delay,duration:x.duration,ease:x.ease,timer:null,state:yz})}function K2(n,a){var u=fa(n,a);if(u.state>yz)throw new Error("too late; already scheduled");return u}function Xa(n,a){var u=fa(n,a);if(u.state>Ey)throw new Error("too late; already running");return u}function fa(n,a){var u=n.__transition;if(!u||!(u=u[a]))throw new Error("transition not found");return u}function t8(n,a,u){var m=n.__transition,y;m[a]=u,u.timer=sx(x,0,u.time);function x(M){u.state=Vw,u.timer.restart(E,u.delay,u.time),u.delay<=M&&E(M-u.delay)}function E(M){var L,V,k,j;if(u.state!==Vw)return P();for(L in m)if(j=m[L],j.name===u.name){if(j.state===Ey)return Nw(E);j.state===EM?(j.state=Ay,j.timer.stop(),j.on.call("interrupt",n,n.__data__,j.index,j.group),delete m[L]):+L<a&&(j.state=Ay,j.timer.stop(),j.on.call("cancel",n,n.__data__,j.index,j.group),delete m[L])}if(Nw(function(){u.state===Ey&&(u.state=EM,u.timer.restart(r,u.delay,u.time),r(M))}),u.state=Uw,u.on.call("start",n,n.__data__,u.index,u.group),u.state===Uw){for(u.state=Ey,y=new Array(k=u.tween.length),L=0,V=-1;L<k;++L)(j=u.tween[L].value.call(n,n.__data__,u.index,u.group))&&(y[++V]=j);y.length=V+1}}function r(M){for(var L=M<u.duration?u.ease.call(null,M/u.duration):(u.timer.restart(P),u.state=jw,1),V=-1,k=y.length;++V<k;)y[V].call(n,L);u.state===jw&&(u.on.call("end",n,n.__data__,u.index,u.group),P())}function P(){u.state=Ay,u.timer.stop(),delete m[a];for(var M in m)return;delete n.__transition}}function xh(n,a){var u=n.__transition,m,y,x=!0,E;if(u){a=a==null?null:a+"";for(E in u){if((m=u[E]).name!==a){x=!1;continue}y=m.state>Uw&&m.state<jw,m.state=Ay,m.timer.stop(),m.on.call(y?"interrupt":"cancel",n,n.__data__,m.index,m.group),delete u[E]}x&&delete n.__transition}}function n8(n){return this.each(function(){xh(this,n)})}function i8(n,a){var u,m;return function(){var y=Xa(this,n),x=y.tween;if(x!==u){m=u=x;for(var E=0,r=m.length;E<r;++E)if(m[E].name===a){m=m.slice(),m.splice(E,1);break}}y.tween=m}}function r8(n,a,u){var m,y;if(typeof u!="function")throw new Error;return function(){var x=Xa(this,n),E=x.tween;if(E!==m){y=(m=E).slice();for(var r={name:a,value:u},P=0,M=y.length;P<M;++P)if(y[P].name===a){y[P]=r;break}P===M&&y.push(r)}x.tween=y}}function o8(n,a){var u=this._id;if(n+="",arguments.length<2){for(var m=fa(this.node(),u).tween,y=0,x=m.length,E;y<x;++y)if((E=m[y]).name===n)return E.value;return null}return this.each((a==null?i8:r8)(u,n,a))}function J2(n,a,u){var m=n._id;return n.each(function(){var y=Xa(this,m);(y.value||(y.value={}))[a]=u.apply(this,arguments)}),function(y){return fa(y,m).value[a]}}function vz(n,a){var u;return(typeof a=="number"?ks:a instanceof Jc?T_:(u=Jc(a))?(a=u,T_):Y2)(n,a)}function s8(n){return function(){this.removeAttribute(n)}}function a8(n){return function(){this.removeAttributeNS(n.space,n.local)}}function l8(n,a,u){var m,y=u+"",x;return function(){var E=this.getAttribute(n);return E===y?null:E===m?x:x=a(m=E,u)}}function c8(n,a,u){var m,y=u+"",x;return function(){var E=this.getAttributeNS(n.space,n.local);return E===y?null:E===m?x:x=a(m=E,u)}}function u8(n,a,u){var m,y,x;return function(){var E,r=u(this),P;return r==null?void this.removeAttribute(n):(E=this.getAttribute(n),P=r+"",E===P?null:E===m&&P===y?x:(y=P,x=a(m=E,r)))}}function h8(n,a,u){var m,y,x;return function(){var E,r=u(this),P;return r==null?void this.removeAttributeNS(n.space,n.local):(E=this.getAttributeNS(n.space,n.local),P=r+"",E===P?null:E===m&&P===y?x:(y=P,x=a(m=E,r)))}}function f8(n,a){var u=B_(n),m=u==="transform"?cz:vz;return this.attrTween(n,typeof a=="function"?(u.local?h8:u8)(u,m,J2(this,"attr."+n,a)):a==null?(u.local?a8:s8)(u):(u.local?c8:l8)(u,m,a))}function d8(n,a){return function(u){this.setAttribute(n,a.call(this,u))}}function p8(n,a){return function(u){this.setAttributeNS(n.space,n.local,a.call(this,u))}}function m8(n,a){var u,m;function y(){var x=a.apply(this,arguments);return x!==m&&(u=(m=x)&&p8(n,x)),u}return y._value=a,y}function _8(n,a){var u,m;function y(){var x=a.apply(this,arguments);return x!==m&&(u=(m=x)&&d8(n,x)),u}return y._value=a,y}function g8(n,a){var u="attr."+n;if(arguments.length<2)return(u=this.tween(u))&&u._value;if(a==null)return this.tween(u,null);if(typeof a!="function")throw new Error;var m=B_(n);return this.tween(u,(m.local?m8:_8)(m,a))}function y8(n,a){return function(){K2(this,n).delay=+a.apply(this,arguments)}}function v8(n,a){return a=+a,function(){K2(this,n).delay=a}}function x8(n){var a=this._id;return arguments.length?this.each((typeof n=="function"?y8:v8)(a,n)):fa(this.node(),a).delay}function b8(n,a){return function(){Xa(this,n).duration=+a.apply(this,arguments)}}function w8(n,a){return a=+a,function(){Xa(this,n).duration=a}}function T8(n){var a=this._id;return arguments.length?this.each((typeof n=="function"?b8:w8)(a,n)):fa(this.node(),a).duration}function S8(n,a){if(typeof a!="function")throw new Error;return function(){Xa(this,n).ease=a}}function E8(n){var a=this._id;return arguments.length?this.each(S8(a,n)):fa(this.node(),a).ease}function A8(n,a){return function(){var u=a.apply(this,arguments);if(typeof u!="function")throw new Error;Xa(this,n).ease=u}}function I8(n){if(typeof n!="function")throw new Error;return this.each(A8(this._id,n))}function M8(n){typeof n!="function"&&(n=j2(n));for(var a=this._groups,u=a.length,m=new Array(u),y=0;y<u;++y)for(var x=a[y],E=x.length,r=m[y]=[],P,M=0;M<E;++M)(P=x[M])&&n.call(P,P.__data__,M,x)&&r.push(P);return new qa(m,this._parents,this._name,this._id)}function C8(n){if(n._id!==this._id)throw new Error;for(var a=this._groups,u=n._groups,m=a.length,y=u.length,x=Math.min(m,y),E=new Array(m),r=0;r<x;++r)for(var P=a[r],M=u[r],L=P.length,V=E[r]=new Array(L),k,j=0;j<L;++j)(k=P[j]||M[j])&&(V[j]=k);for(;r<m;++r)E[r]=a[r];return new qa(E,this._parents,this._name,this._id)}function P8(n){return(n+"").trim().split(/^|\s+/).every(function(a){var u=a.indexOf(".");return u>=0&&(a=a.slice(0,u)),!a||a==="start"})}function z8(n,a,u){var m,y,x=P8(a)?K2:Xa;return function(){var E=x(this,n),r=E.on;r!==m&&(y=(m=r).copy()).on(a,u),E.on=y}}function R8(n,a){var u=this._id;return arguments.length<2?fa(this.node(),u).on.on(n):this.each(z8(u,n,a))}function D8(n){return function(){var a=this.parentNode;for(var u in this.__transition)if(+u!==n)return;a&&a.removeChild(this)}}function L8(){return this.on("end.remove",D8(this._id))}function k8(n){var a=this._name,u=this._id;typeof n!="function"&&(n=Kv(n));for(var m=this._groups,y=m.length,x=new Array(y),E=0;E<y;++E)for(var r=m[E],P=r.length,M=x[E]=new Array(P),L,V,k=0;k<P;++k)(L=r[k])&&(V=n.call(L,L.__data__,k,r))&&("__data__"in L&&(V.__data__=L.__data__),M[k]=V,ax(M[k],a,u,k,M,fa(L,u)));return new qa(x,this._parents,a,u)}function O8(n){var a=this._name,u=this._id;typeof n!="function"&&(n=U2(n));for(var m=this._groups,y=m.length,x=[],E=[],r=0;r<y;++r)for(var P=m[r],M=P.length,L,V=0;V<M;++V)if(L=P[V]){for(var k=n.call(L,L.__data__,V,P),j,te=fa(L,u),J=0,Q=k.length;J<Q;++J)(j=k[J])&&ax(j,a,u,J,k,te);x.push(k),E.push(L)}return new qa(x,E,a,u)}var F8=Dh.prototype.constructor;function B8(){return new F8(this._groups,this._parents)}function N8(n,a){var u,m,y;return function(){var x=Sh(this,n),E=(this.style.removeProperty(n),Sh(this,n));return x===E?null:x===u&&E===m?y:y=a(u=x,m=E)}}function xz(n){return function(){this.style.removeProperty(n)}}function V8(n,a,u){var m,y=u+"",x;return function(){var E=Sh(this,n);return E===y?null:E===m?x:x=a(m=E,u)}}function U8(n,a,u){var m,y,x;return function(){var E=Sh(this,n),r=u(this),P=r+"";return r==null&&(P=r=(this.style.removeProperty(n),Sh(this,n))),E===P?null:E===m&&P===y?x:(y=P,x=a(m=E,r))}}function j8(n,a){var u,m,y,x="style."+a,E="end."+x,r;return function(){var P=Xa(this,n),M=P.on,L=P.value[x]==null?r||(r=xz(a)):void 0;(M!==u||y!==L)&&(m=(u=M).copy()).on(E,y=L),P.on=m}}function $8(n,a,u){var m=(n+="")=="transform"?lz:vz;return a==null?this.styleTween(n,N8(n,m)).on("end.style."+n,xz(n)):typeof a=="function"?this.styleTween(n,U8(n,m,J2(this,"style."+n,a))).each(j8(this._id,n)):this.styleTween(n,V8(n,m,a),u).on("end.style."+n,null)}function G8(n,a,u){return function(m){this.style.setProperty(n,a.call(this,m),u)}}function q8(n,a,u){var m,y;function x(){var E=a.apply(this,arguments);return E!==y&&(m=(y=E)&&G8(n,E,u)),m}return x._value=a,x}function H8(n,a,u){var m="style."+(n+="");if(arguments.length<2)return(m=this.tween(m))&&m._value;if(a==null)return this.tween(m,null);if(typeof a!="function")throw new Error;return this.tween(m,q8(n,a,u??""))}function Z8(n){return function(){this.textContent=n}}function W8(n){return function(){var a=n(this);this.textContent=a??""}}function X8(n){return this.tween("text",typeof n=="function"?W8(J2(this,"text",n)):Z8(n==null?"":n+""))}function Y8(n){return function(a){this.textContent=n.call(this,a)}}function K8(n){var a,u;function m(){var y=n.apply(this,arguments);return y!==u&&(a=(u=y)&&Y8(y)),a}return m._value=n,m}function J8(n){var a="text";if(arguments.length<1)return(a=this.tween(a))&&a._value;if(n==null)return this.tween(a,null);if(typeof n!="function")throw new Error;return this.tween(a,K8(n))}function Q8(){for(var n=this._name,a=this._id,u=wz(),m=this._groups,y=m.length,x=0;x<y;++x)for(var E=m[x],r=E.length,P,M=0;M<r;++M)if(P=E[M]){var L=fa(P,a);ax(P,n,u,M,E,{time:L.time+L.delay+L.duration,delay:0,duration:L.duration,ease:L.ease})}return new qa(m,this._parents,n,u)}function eV(){var n,a,u=this,m=u._id,y=u.size();return new Promise(function(x,E){var r={value:E},P={value:function(){--y===0&&x()}};u.each(function(){var M=Xa(this,m),L=M.on;L!==n&&(a=(n=L).copy(),a._.cancel.push(r),a._.interrupt.push(r),a._.end.push(P)),M.on=a}),y===0&&x()})}var tV=0;function qa(n,a,u,m){this._groups=n,this._parents=a,this._name=u,this._id=m}function bz(n){return Dh().transition(n)}function wz(){return++tV}var Dl=Dh.prototype;qa.prototype=bz.prototype={constructor:qa,select:k8,selectAll:O8,selectChild:Dl.selectChild,selectChildren:Dl.selectChildren,filter:M8,merge:C8,selection:B8,transition:Q8,call:Dl.call,nodes:Dl.nodes,node:Dl.node,size:Dl.size,empty:Dl.empty,each:Dl.each,on:R8,attr:f8,attrTween:g8,style:$8,styleTween:H8,text:X8,textTween:J8,remove:L8,tween:o8,delay:x8,duration:T8,ease:E8,easeVarying:I8,end:eV,[Symbol.iterator]:Dl[Symbol.iterator]};const nV=n=>+n;function iV(n){return n*n}function rV(n){return n*(2-n)}function AM(n){return((n*=2)<=1?n*n:--n*(2-n)+1)/2}function oV(n){return n*n*n}function sV(n){return--n*n*n+1}function $w(n){return((n*=2)<=1?n*n*n:(n-=2)*n*n+2)/2}var Q2=3,aV=function n(a){a=+a;function u(m){return Math.pow(m,a)}return u.exponent=n,u}(Q2),lV=function n(a){a=+a;function u(m){return 1-Math.pow(1-m,a)}return u.exponent=n,u}(Q2),IM=function n(a){a=+a;function u(m){return((m*=2)<=1?Math.pow(m,a):2-Math.pow(2-m,a))/2}return u.exponent=n,u}(Q2),Tz=Math.PI,Sz=Tz/2;function cV(n){return+n==1?1:1-Math.cos(n*Sz)}function uV(n){return Math.sin(n*Sz)}function MM(n){return(1-Math.cos(Tz*n))/2}function Qc(n){return(Math.pow(2,-10*n)-.0009765625)*1.0009775171065494}function hV(n){return Qc(1-+n)}function fV(n){return 1-Qc(n)}function CM(n){return((n*=2)<=1?Qc(1-n):2-Qc(n-1))/2}function dV(n){return 1-Math.sqrt(1-n*n)}function pV(n){return Math.sqrt(1- --n*n)}function PM(n){return((n*=2)<=1?1-Math.sqrt(1-n*n):Math.sqrt(1-(n-=2)*n)+1)/2}var Gw=4/11,mV=6/11,_V=8/11,gV=3/4,yV=9/11,vV=10/11,xV=15/16,bV=21/22,wV=63/64,ty=1/Gw/Gw;function TV(n){return 1-A_(1-n)}function A_(n){return(n=+n)<Gw?ty*n*n:n<_V?ty*(n-=mV)*n+gV:n<vV?ty*(n-=yV)*n+xV:ty*(n-=bV)*n+wV}function SV(n){return((n*=2)<=1?1-A_(1-n):A_(n-1)+1)/2}var eT=1.70158,EV=function n(a){a=+a;function u(m){return(m=+m)*m*(a*(m-1)+m)}return u.overshoot=n,u}(eT),AV=function n(a){a=+a;function u(m){return--m*m*((m+1)*a+m)+1}return u.overshoot=n,u}(eT),zM=function n(a){a=+a;function u(m){return((m*=2)<1?m*m*((a+1)*m-a):(m-=2)*m*((a+1)*m+a)+2)/2}return u.overshoot=n,u}(eT),Rd=2*Math.PI,tT=1,nT=.3,IV=function n(a,u){var m=Math.asin(1/(a=Math.max(1,a)))*(u/=Rd);function y(x){return a*Qc(- --x)*Math.sin((m-x)/u)}return y.amplitude=function(x){return n(x,u*Rd)},y.period=function(x){return n(a,x)},y}(tT,nT),RM=function n(a,u){var m=Math.asin(1/(a=Math.max(1,a)))*(u/=Rd);function y(x){return 1-a*Qc(x=+x)*Math.sin((x+m)/u)}return y.amplitude=function(x){return n(x,u*Rd)},y.period=function(x){return n(a,x)},y}(tT,nT),MV=function n(a,u){var m=Math.asin(1/(a=Math.max(1,a)))*(u/=Rd);function y(x){return((x=x*2-1)<0?a*Qc(-x)*Math.sin((m-x)/u):2-a*Qc(x)*Math.sin((m+x)/u))/2}return y.amplitude=function(x){return n(x,u*Rd)},y.period=function(x){return n(a,x)},y}(tT,nT),CV={time:null,delay:0,duration:250,ease:$w};function PV(n,a){for(var u;!(u=n.__transition)||!(u=u[a]);)if(!(n=n.parentNode))throw new Error(`transition ${a} not found`);return u}function zV(n){var a,u;n instanceof qa?(a=n._id,n=n._name):(a=wz(),(u=CV).time=V_(),n=n==null?null:n+"");for(var m=this._groups,y=m.length,x=0;x<y;++x)for(var E=m[x],r=E.length,P,M=0;M<r;++M)(P=E[M])&&ax(P,n,a,M,E,u||PV(P,a));return new qa(m,this._parents,n,a)}Dh.prototype.interrupt=n8;Dh.prototype.transition=zV;var RV=[null];function DV(n,a){var u=n.__transition,m,y;if(u){a=a==null?null:a+"";for(y in u)if((m=u[y]).state>Vw&&m.name===a)return new qa([[n]],RV,a,+y)}return null}const qb=n=>()=>n;function LV(n,{sourceEvent:a,target:u,selection:m,mode:y,dispatch:x}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:a,enumerable:!0,configurable:!0},target:{value:u,enumerable:!0,configurable:!0},selection:{value:m,enumerable:!0,configurable:!0},mode:{value:y,enumerable:!0,configurable:!0},_:{value:x}})}function kV(n){n.stopImmediatePropagation()}function Hb(n){n.preventDefault(),n.stopImmediatePropagation()}var DM={name:"drag"},Zb={name:"space"},ad={name:"handle"},ld={name:"center"};const{abs:LM,max:bo,min:wo}=Math;function kM(n){return[+n[0],+n[1]]}function qw(n){return[kM(n[0]),kM(n[1])]}var Iy={name:"x",handles:["w","e"].map(I_),input:function(n,a){return n==null?null:[[+n[0],a[0][1]],[+n[1],a[1][1]]]},output:function(n){return n&&[n[0][0],n[1][0]]}},My={name:"y",handles:["n","s"].map(I_),input:function(n,a){return n==null?null:[[a[0][0],+n[0]],[a[1][0],+n[1]]]},output:function(n){return n&&[n[0][1],n[1][1]]}},OV={name:"xy",handles:["n","w","e","s","nw","ne","sw","se"].map(I_),input:function(n){return n==null?null:qw(n)},output:function(n){return n}},Ll={overlay:"crosshair",selection:"move",n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},OM={e:"w",w:"e",nw:"ne",ne:"nw",se:"sw",sw:"se"},FM={n:"s",s:"n",nw:"sw",ne:"se",se:"ne",sw:"nw"},FV={overlay:1,selection:1,n:null,e:1,s:null,w:-1,nw:-1,ne:1,se:1,sw:-1},BV={overlay:1,selection:1,n:-1,e:null,s:1,w:null,nw:-1,ne:-1,se:1,sw:1};function I_(n){return{type:n}}function NV(n){return!n.ctrlKey&&!n.button}function VV(){var n=this.ownerSVGElement||this;return n.hasAttribute("viewBox")?(n=n.viewBox.baseVal,[[n.x,n.y],[n.x+n.width,n.y+n.height]]):[[0,0],[n.width.baseVal.value,n.height.baseVal.value]]}function UV(){return navigator.maxTouchPoints||"ontouchstart"in this}function Wb(n){for(;!n.__brush;)if(!(n=n.parentNode))return;return n.__brush}function jV(n){return n[0][0]===n[1][0]||n[0][1]===n[1][1]}function $V(n){var a=n.__brush;return a?a.dim.output(a.selection):null}function GV(){return iT(Iy)}function qV(){return iT(My)}function HV(){return iT(OV)}function iT(n){var a=VV,u=NV,m=UV,y=!0,x=Rh("start","brush","end"),E=6,r;function P(Q){var ee=Q.property("__brush",J).selectAll(".overlay").data([I_("overlay")]);ee.enter().append("rect").attr("class","overlay").attr("pointer-events","all").attr("cursor",Ll.overlay).merge(ee).each(function(){var ce=Wb(this).extent;Ao(this).attr("x",ce[0][0]).attr("y",ce[0][1]).attr("width",ce[1][0]-ce[0][0]).attr("height",ce[1][1]-ce[0][1])}),Q.selectAll(".selection").data([I_("selection")]).enter().append("rect").attr("class","selection").attr("cursor",Ll.selection).attr("fill","#777").attr("fill-opacity",.3).attr("stroke","#fff").attr("shape-rendering","crispEdges");var ue=Q.selectAll(".handle").data(n.handles,function(ce){return ce.type});ue.exit().remove(),ue.enter().append("rect").attr("class",function(ce){return"handle handle--"+ce.type}).attr("cursor",function(ce){return Ll[ce.type]}),Q.each(M).attr("fill","none").attr("pointer-events","all").on("mousedown.brush",k).filter(m).on("touchstart.brush",k).on("touchmove.brush",j).on("touchend.brush touchcancel.brush",te).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}P.move=function(Q,ee,ue){Q.tween?Q.on("start.brush",function(ce){L(this,arguments).beforestart().start(ce)}).on("interrupt.brush end.brush",function(ce){L(this,arguments).end(ce)}).tween("brush",function(){var ce=this,se=ce.__brush,Ae=L(ce,arguments),De=se.selection,Qe=n.input(typeof ee=="function"?ee.apply(this,arguments):ee,se.extent),nt=ru(De,Qe);function rt(tt){se.selection=tt===1&&Qe===null?null:nt(tt),M.call(ce),Ae.brush()}return De!==null&&Qe!==null?rt:rt(1)}):Q.each(function(){var ce=this,se=arguments,Ae=ce.__brush,De=n.input(typeof ee=="function"?ee.apply(ce,se):ee,Ae.extent),Qe=L(ce,se).beforestart();xh(ce),Ae.selection=De===null?null:De,M.call(ce),Qe.start(ue).brush(ue).end(ue)})},P.clear=function(Q,ee){P.move(Q,null,ee)};function M(){var Q=Ao(this),ee=Wb(this).selection;ee?(Q.selectAll(".selection").style("display",null).attr("x",ee[0][0]).attr("y",ee[0][1]).attr("width",ee[1][0]-ee[0][0]).attr("height",ee[1][1]-ee[0][1]),Q.selectAll(".handle").style("display",null).attr("x",function(ue){return ue.type[ue.type.length-1]==="e"?ee[1][0]-E/2:ee[0][0]-E/2}).attr("y",function(ue){return ue.type[0]==="s"?ee[1][1]-E/2:ee[0][1]-E/2}).attr("width",function(ue){return ue.type==="n"||ue.type==="s"?ee[1][0]-ee[0][0]+E:E}).attr("height",function(ue){return ue.type==="e"||ue.type==="w"?ee[1][1]-ee[0][1]+E:E})):Q.selectAll(".selection,.handle").style("display","none").attr("x",null).attr("y",null).attr("width",null).attr("height",null)}function L(Q,ee,ue){var ce=Q.__brush.emitter;return ce&&(!ue||!ce.clean)?ce:new V(Q,ee,ue)}function V(Q,ee,ue){this.that=Q,this.args=ee,this.state=Q.__brush,this.active=0,this.clean=ue}V.prototype={beforestart:function(){return++this.active===1&&(this.state.emitter=this,this.starting=!0),this},start:function(Q,ee){return this.starting?(this.starting=!1,this.emit("start",Q,ee)):this.emit("brush",Q),this},brush:function(Q,ee){return this.emit("brush",Q,ee),this},end:function(Q,ee){return--this.active===0&&(delete this.state.emitter,this.emit("end",Q,ee)),this},emit:function(Q,ee,ue){var ce=Ao(this.that).datum();x.call(Q,this.that,new LV(Q,{sourceEvent:ee,target:P,selection:n.output(this.state.selection),mode:ue,dispatch:x}),ce)}};function k(Q){if(r&&!Q.touches||!u.apply(this,arguments))return;var ee=this,ue=Q.target.__data__.type,ce=(y&&Q.metaKey?ue="overlay":ue)==="selection"?DM:y&&Q.altKey?ld:ad,se=n===My?null:FV[ue],Ae=n===Iy?null:BV[ue],De=Wb(ee),Qe=De.extent,nt=De.selection,rt=Qe[0][0],tt,Be,Rt=Qe[0][1],ut,Pe,Ve=Qe[1][0],qe,bt,Ht=Qe[1][1],Dt,Lt,rn=0,yn=0,pi,ti=se&&Ae&&y&&Q.shiftKey,hn,Nn,Pn=Array.from(Q.touches||[Q],vn=>{const wi=vn.identifier;return vn=ys(vn,ee),vn.point0=vn.slice(),vn.identifier=wi,vn});xh(ee);var Gi=L(ee,arguments,!0).beforestart();if(ue==="overlay"){nt&&(pi=!0);const vn=[Pn[0],Pn[1]||Pn[0]];De.selection=nt=[[tt=n===My?rt:wo(vn[0][0],vn[1][0]),ut=n===Iy?Rt:wo(vn[0][1],vn[1][1])],[qe=n===My?Ve:bo(vn[0][0],vn[1][0]),Dt=n===Iy?Ht:bo(vn[0][1],vn[1][1])]],Pn.length>1&&dn(Q)}else tt=nt[0][0],ut=nt[0][1],qe=nt[1][0],Dt=nt[1][1];Be=tt,Pe=ut,bt=qe,Lt=Dt;var Ct=Ao(ee).attr("pointer-events","none"),fn=Ct.selectAll(".overlay").attr("cursor",Ll[ue]);if(Q.touches)Gi.moved=It,Gi.ended=$n;else{var Tn=Ao(Q.view).on("mousemove.brush",It,!0).on("mouseup.brush",$n,!0);y&&Tn.on("keydown.brush",Qi,!0).on("keyup.brush",bi,!0),Jv(Q.view)}M.call(ee),Gi.start(Q,ce.name);function It(vn){for(const wi of vn.changedTouches||[vn])for(const tr of Pn)tr.identifier===wi.identifier&&(tr.cur=ys(wi,ee));if(ti&&!hn&&!Nn&&Pn.length===1){const wi=Pn[0];LM(wi.cur[0]-wi[0])>LM(wi.cur[1]-wi[1])?Nn=!0:hn=!0}for(const wi of Pn)wi.cur&&(wi[0]=wi.cur[0],wi[1]=wi.cur[1]);pi=!0,Hb(vn),dn(vn)}function dn(vn){const wi=Pn[0],tr=wi.point0;var yr;switch(rn=wi[0]-tr[0],yn=wi[1]-tr[1],ce){case Zb:case DM:{se&&(rn=bo(rt-tt,wo(Ve-qe,rn)),Be=tt+rn,bt=qe+rn),Ae&&(yn=bo(Rt-ut,wo(Ht-Dt,yn)),Pe=ut+yn,Lt=Dt+yn);break}case ad:{Pn[1]?(se&&(Be=bo(rt,wo(Ve,Pn[0][0])),bt=bo(rt,wo(Ve,Pn[1][0])),se=1),Ae&&(Pe=bo(Rt,wo(Ht,Pn[0][1])),Lt=bo(Rt,wo(Ht,Pn[1][1])),Ae=1)):(se<0?(rn=bo(rt-tt,wo(Ve-tt,rn)),Be=tt+rn,bt=qe):se>0&&(rn=bo(rt-qe,wo(Ve-qe,rn)),Be=tt,bt=qe+rn),Ae<0?(yn=bo(Rt-ut,wo(Ht-ut,yn)),Pe=ut+yn,Lt=Dt):Ae>0&&(yn=bo(Rt-Dt,wo(Ht-Dt,yn)),Pe=ut,Lt=Dt+yn));break}case ld:{se&&(Be=bo(rt,wo(Ve,tt-rn*se)),bt=bo(rt,wo(Ve,qe+rn*se))),Ae&&(Pe=bo(Rt,wo(Ht,ut-yn*Ae)),Lt=bo(Rt,wo(Ht,Dt+yn*Ae)));break}}bt<Be&&(se*=-1,yr=tt,tt=qe,qe=yr,yr=Be,Be=bt,bt=yr,ue in OM&&fn.attr("cursor",Ll[ue=OM[ue]])),Lt<Pe&&(Ae*=-1,yr=ut,ut=Dt,Dt=yr,yr=Pe,Pe=Lt,Lt=yr,ue in FM&&fn.attr("cursor",Ll[ue=FM[ue]])),De.selection&&(nt=De.selection),hn&&(Be=nt[0][0],bt=nt[1][0]),Nn&&(Pe=nt[0][1],Lt=nt[1][1]),(nt[0][0]!==Be||nt[0][1]!==Pe||nt[1][0]!==bt||nt[1][1]!==Lt)&&(De.selection=[[Be,Pe],[bt,Lt]],M.call(ee),Gi.brush(vn,ce.name))}function $n(vn){if(kV(vn),vn.touches){if(vn.touches.length)return;r&&clearTimeout(r),r=setTimeout(function(){r=null},500)}else Qv(vn.view,pi),Tn.on("keydown.brush keyup.brush mousemove.brush mouseup.brush",null);Ct.attr("pointer-events","all"),fn.attr("cursor",Ll.overlay),De.selection&&(nt=De.selection),jV(nt)&&(De.selection=null,M.call(ee)),Gi.end(vn,ce.name)}function Qi(vn){switch(vn.keyCode){case 16:{ti=se&&Ae;break}case 18:{ce===ad&&(se&&(qe=bt-rn*se,tt=Be+rn*se),Ae&&(Dt=Lt-yn*Ae,ut=Pe+yn*Ae),ce=ld,dn(vn));break}case 32:{(ce===ad||ce===ld)&&(se<0?qe=bt-rn:se>0&&(tt=Be-rn),Ae<0?Dt=Lt-yn:Ae>0&&(ut=Pe-yn),ce=Zb,fn.attr("cursor",Ll.selection),dn(vn));break}default:return}Hb(vn)}function bi(vn){switch(vn.keyCode){case 16:{ti&&(hn=Nn=ti=!1,dn(vn));break}case 18:{ce===ld&&(se<0?qe=bt:se>0&&(tt=Be),Ae<0?Dt=Lt:Ae>0&&(ut=Pe),ce=ad,dn(vn));break}case 32:{ce===Zb&&(vn.altKey?(se&&(qe=bt-rn*se,tt=Be+rn*se),Ae&&(Dt=Lt-yn*Ae,ut=Pe+yn*Ae),ce=ld):(se<0?qe=bt:se>0&&(tt=Be),Ae<0?Dt=Lt:Ae>0&&(ut=Pe),ce=ad),fn.attr("cursor",Ll[ue]),dn(vn));break}default:return}Hb(vn)}}function j(Q){L(this,arguments).moved(Q)}function te(Q){L(this,arguments).ended(Q)}function J(){var Q=this.__brush||{selection:null};return Q.extent=qw(a.apply(this,arguments)),Q.dim=n,Q}return P.extent=function(Q){return arguments.length?(a=typeof Q=="function"?Q:qb(qw(Q)),P):a},P.filter=function(Q){return arguments.length?(u=typeof Q=="function"?Q:qb(!!Q),P):u},P.touchable=function(Q){return arguments.length?(m=typeof Q=="function"?Q:qb(!!Q),P):m},P.handleSize=function(Q){return arguments.length?(E=+Q,P):E},P.keyModifiers=function(Q){return arguments.length?(y=!!Q,P):y},P.on=function(){var Q=x.on.apply(x,arguments);return Q===x?P:Q},P}var BM=Math.abs,cd=Math.cos,ud=Math.sin,Ez=Math.PI,ny=Ez/2,NM=Ez*2,VM=Math.max,Xb=1e-12;function Yb(n,a){return Array.from({length:a-n},(u,m)=>n+m)}function ZV(n){return function(a,u){return n(a.source.value+a.target.value,u.source.value+u.target.value)}}function WV(){return rT(!1,!1)}function XV(){return rT(!1,!0)}function YV(){return rT(!0,!1)}function rT(n,a){var u=0,m=null,y=null,x=null;function E(r){var P=r.length,M=new Array(P),L=Yb(0,P),V=new Array(P*P),k=new Array(P),j=0,te;r=Float64Array.from({length:P*P},a?(J,Q)=>r[Q%P][Q/P|0]:(J,Q)=>r[Q/P|0][Q%P]);for(let J=0;J<P;++J){let Q=0;for(let ee=0;ee<P;++ee)Q+=r[J*P+ee]+n*r[ee*P+J];j+=M[J]=Q}j=VM(0,NM-u*P)/j,te=j?u:NM/P;{let J=0;m&&L.sort((Q,ee)=>m(M[Q],M[ee]));for(const Q of L){const ee=J;if(n){const ue=Yb(~P+1,P).filter(ce=>ce<0?r[~ce*P+Q]:r[Q*P+ce]);y&&ue.sort((ce,se)=>y(ce<0?-r[~ce*P+Q]:r[Q*P+ce],se<0?-r[~se*P+Q]:r[Q*P+se]));for(const ce of ue)if(ce<0){const se=V[~ce*P+Q]||(V[~ce*P+Q]={source:null,target:null});se.target={index:Q,startAngle:J,endAngle:J+=r[~ce*P+Q]*j,value:r[~ce*P+Q]}}else{const se=V[Q*P+ce]||(V[Q*P+ce]={source:null,target:null});se.source={index:Q,startAngle:J,endAngle:J+=r[Q*P+ce]*j,value:r[Q*P+ce]}}k[Q]={index:Q,startAngle:ee,endAngle:J,value:M[Q]}}else{const ue=Yb(0,P).filter(ce=>r[Q*P+ce]||r[ce*P+Q]);y&&ue.sort((ce,se)=>y(r[Q*P+ce],r[Q*P+se]));for(const ce of ue){let se;if(Q<ce?(se=V[Q*P+ce]||(V[Q*P+ce]={source:null,target:null}),se.source={index:Q,startAngle:J,endAngle:J+=r[Q*P+ce]*j,value:r[Q*P+ce]}):(se=V[ce*P+Q]||(V[ce*P+Q]={source:null,target:null}),se.target={index:Q,startAngle:J,endAngle:J+=r[Q*P+ce]*j,value:r[Q*P+ce]},Q===ce&&(se.source=se.target)),se.source&&se.target&&se.source.value<se.target.value){const Ae=se.source;se.source=se.target,se.target=Ae}}k[Q]={index:Q,startAngle:ee,endAngle:J,value:M[Q]}}J+=te}}return V=Object.values(V),V.groups=k,x?V.sort(x):V}return E.padAngle=function(r){return arguments.length?(u=VM(0,r),E):u},E.sortGroups=function(r){return arguments.length?(m=r,E):m},E.sortSubgroups=function(r){return arguments.length?(y=r,E):y},E.sortChords=function(r){return arguments.length?(r==null?x=null:(x=ZV(r))._=r,E):x&&x._},E}const Hw=Math.PI,Zw=2*Hw,fh=1e-6,KV=Zw-fh;function Az(n){this._+=n[0];for(let a=1,u=n.length;a<u;++a)this._+=arguments[a]+n[a]}function JV(n){let a=Math.floor(n);if(!(a>=0))throw new Error(`invalid digits: ${n}`);if(a>15)return Az;const u=10**a;return function(m){this._+=m[0];for(let y=1,x=m.length;y<x;++y)this._+=Math.round(arguments[y]*u)/u+m[y]}}let U_=class{constructor(a){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=a==null?Az:JV(a)}moveTo(a,u){this._append`M${this._x0=this._x1=+a},${this._y0=this._y1=+u}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(a,u){this._append`L${this._x1=+a},${this._y1=+u}`}quadraticCurveTo(a,u,m,y){this._append`Q${+a},${+u},${this._x1=+m},${this._y1=+y}`}bezierCurveTo(a,u,m,y,x,E){this._append`C${+a},${+u},${+m},${+y},${this._x1=+x},${this._y1=+E}`}arcTo(a,u,m,y,x){if(a=+a,u=+u,m=+m,y=+y,x=+x,x<0)throw new Error(`negative radius: ${x}`);let E=this._x1,r=this._y1,P=m-a,M=y-u,L=E-a,V=r-u,k=L*L+V*V;if(this._x1===null)this._append`M${this._x1=a},${this._y1=u}`;else if(k>fh)if(!(Math.abs(V*P-M*L)>fh)||!x)this._append`L${this._x1=a},${this._y1=u}`;else{let j=m-E,te=y-r,J=P*P+M*M,Q=j*j+te*te,ee=Math.sqrt(J),ue=Math.sqrt(k),ce=x*Math.tan((Hw-Math.acos((J+k-Q)/(2*ee*ue)))/2),se=ce/ue,Ae=ce/ee;Math.abs(se-1)>fh&&this._append`L${a+se*L},${u+se*V}`,this._append`A${x},${x},0,0,${+(V*j>L*te)},${this._x1=a+Ae*P},${this._y1=u+Ae*M}`}}arc(a,u,m,y,x,E){if(a=+a,u=+u,m=+m,E=!!E,m<0)throw new Error(`negative radius: ${m}`);let r=m*Math.cos(y),P=m*Math.sin(y),M=a+r,L=u+P,V=1^E,k=E?y-x:x-y;this._x1===null?this._append`M${M},${L}`:(Math.abs(this._x1-M)>fh||Math.abs(this._y1-L)>fh)&&this._append`L${M},${L}`,m&&(k<0&&(k=k%Zw+Zw),k>KV?this._append`A${m},${m},0,1,${V},${a-r},${u-P}A${m},${m},0,1,${V},${this._x1=M},${this._y1=L}`:k>fh&&this._append`A${m},${m},0,${+(k>=Hw)},${V},${this._x1=a+m*Math.cos(x)},${this._y1=u+m*Math.sin(x)}`)}rect(a,u,m,y){this._append`M${this._x0=this._x1=+a},${this._y0=this._y1=+u}h${m=+m}v${+y}h${-m}Z`}toString(){return this._}};function oT(){return new U_}oT.prototype=U_.prototype;function QV(n=3){return new U_(+n)}var eU=Array.prototype.slice;function uh(n){return function(){return n}}function tU(n){return n.source}function nU(n){return n.target}function UM(n){return n.radius}function iU(n){return n.startAngle}function rU(n){return n.endAngle}function oU(){return 0}function sU(){return 10}function Iz(n){var a=tU,u=nU,m=UM,y=UM,x=iU,E=rU,r=oU,P=null;function M(){var L,V=a.apply(this,arguments),k=u.apply(this,arguments),j=r.apply(this,arguments)/2,te=eU.call(arguments),J=+m.apply(this,(te[0]=V,te)),Q=x.apply(this,te)-ny,ee=E.apply(this,te)-ny,ue=+y.apply(this,(te[0]=k,te)),ce=x.apply(this,te)-ny,se=E.apply(this,te)-ny;if(P||(P=L=oT()),j>Xb&&(BM(ee-Q)>j*2+Xb?ee>Q?(Q+=j,ee-=j):(Q-=j,ee+=j):Q=ee=(Q+ee)/2,BM(se-ce)>j*2+Xb?se>ce?(ce+=j,se-=j):(ce-=j,se+=j):ce=se=(ce+se)/2),P.moveTo(J*cd(Q),J*ud(Q)),P.arc(0,0,J,Q,ee),Q!==ce||ee!==se)if(n){var Ae=+n.apply(this,arguments),De=ue-Ae,Qe=(ce+se)/2;P.quadraticCurveTo(0,0,De*cd(ce),De*ud(ce)),P.lineTo(ue*cd(Qe),ue*ud(Qe)),P.lineTo(De*cd(se),De*ud(se))}else P.quadraticCurveTo(0,0,ue*cd(ce),ue*ud(ce)),P.arc(0,0,ue,ce,se);if(P.quadraticCurveTo(0,0,J*cd(Q),J*ud(Q)),P.closePath(),L)return P=null,L+""||null}return n&&(M.headRadius=function(L){return arguments.length?(n=typeof L=="function"?L:uh(+L),M):n}),M.radius=function(L){return arguments.length?(m=y=typeof L=="function"?L:uh(+L),M):m},M.sourceRadius=function(L){return arguments.length?(m=typeof L=="function"?L:uh(+L),M):m},M.targetRadius=function(L){return arguments.length?(y=typeof L=="function"?L:uh(+L),M):y},M.startAngle=function(L){return arguments.length?(x=typeof L=="function"?L:uh(+L),M):x},M.endAngle=function(L){return arguments.length?(E=typeof L=="function"?L:uh(+L),M):E},M.padAngle=function(L){return arguments.length?(r=typeof L=="function"?L:uh(+L),M):r},M.source=function(L){return arguments.length?(a=L,M):a},M.target=function(L){return arguments.length?(u=L,M):u},M.context=function(L){return arguments.length?(P=L??null,M):P},M}function aU(){return Iz()}function lU(){return Iz(sU)}var cU=Array.prototype,Mz=cU.slice;function uU(n,a){return n-a}function hU(n){for(var a=0,u=n.length,m=n[u-1][1]*n[0][0]-n[u-1][0]*n[0][1];++a<u;)m+=n[a-1][1]*n[a][0]-n[a-1][0]*n[a][1];return m}const $c=n=>()=>n;function fU(n,a){for(var u=-1,m=a.length,y;++u<m;)if(y=dU(n,a[u]))return y;return 0}function dU(n,a){for(var u=a[0],m=a[1],y=-1,x=0,E=n.length,r=E-1;x<E;r=x++){var P=n[x],M=P[0],L=P[1],V=n[r],k=V[0],j=V[1];if(pU(P,V,a))return 0;L>m!=j>m&&u<(k-M)*(m-L)/(j-L)+M&&(y=-y)}return y}function pU(n,a,u){var m;return mU(n,a,u)&&_U(n[m=+(n[0]===a[0])],u[m],a[m])}function mU(n,a,u){return(a[0]-n[0])*(u[1]-n[1])===(u[0]-n[0])*(a[1]-n[1])}function _U(n,a,u){return n<=a&&a<=u||u<=a&&a<=n}function gU(){}var kl=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function Ww(){var n=1,a=1,u=F2,m=P;function y(M){var L=u(M);if(Array.isArray(L))L=L.slice().sort(uU);else{const V=l_(M,yU);for(L=wh(...O2(V[0],V[1],L),L);L[L.length-1]>=V[1];)L.pop();for(;L[1]<V[0];)L.shift()}return L.map(V=>x(M,V))}function x(M,L){const V=L==null?NaN:+L;if(isNaN(V))throw new Error(`invalid value: ${L}`);var k=[],j=[];return E(M,V,function(te){m(te,M,V),hU(te)>0?k.push([te]):j.push(te)}),j.forEach(function(te){for(var J=0,Q=k.length,ee;J<Q;++J)if(fU((ee=k[J])[0],te)!==-1){ee.push(te);return}}),{type:"MultiPolygon",value:L,coordinates:k}}function E(M,L,V){var k=new Array,j=new Array,te,J,Q,ee,ue,ce;for(te=J=-1,ee=hh(M[0],L),kl[ee<<1].forEach(se);++te<n-1;)Q=ee,ee=hh(M[te+1],L),kl[Q|ee<<1].forEach(se);for(kl[ee<<0].forEach(se);++J<a-1;){for(te=-1,ee=hh(M[J*n+n],L),ue=hh(M[J*n],L),kl[ee<<1|ue<<2].forEach(se);++te<n-1;)Q=ee,ee=hh(M[J*n+n+te+1],L),ce=ue,ue=hh(M[J*n+te+1],L),kl[Q|ee<<1|ue<<2|ce<<3].forEach(se);kl[ee|ue<<3].forEach(se)}for(te=-1,ue=M[J*n]>=L,kl[ue<<2].forEach(se);++te<n-1;)ce=ue,ue=hh(M[J*n+te+1],L),kl[ue<<2|ce<<3].forEach(se);kl[ue<<3].forEach(se);function se(Ae){var De=[Ae[0][0]+te,Ae[0][1]+J],Qe=[Ae[1][0]+te,Ae[1][1]+J],nt=r(De),rt=r(Qe),tt,Be;(tt=j[nt])?(Be=k[rt])?(delete j[tt.end],delete k[Be.start],tt===Be?(tt.ring.push(Qe),V(tt.ring)):k[tt.start]=j[Be.end]={start:tt.start,end:Be.end,ring:tt.ring.concat(Be.ring)}):(delete j[tt.end],tt.ring.push(Qe),j[tt.end=rt]=tt):(tt=k[rt])?(Be=j[nt])?(delete k[tt.start],delete j[Be.end],tt===Be?(tt.ring.push(Qe),V(tt.ring)):k[Be.start]=j[tt.end]={start:Be.start,end:tt.end,ring:Be.ring.concat(tt.ring)}):(delete k[tt.start],tt.ring.unshift(De),k[tt.start=nt]=tt):k[nt]=j[rt]={start:nt,end:rt,ring:[De,Qe]}}}function r(M){return M[0]*2+M[1]*(n+1)*4}function P(M,L,V){M.forEach(function(k){var j=k[0],te=k[1],J=j|0,Q=te|0,ee=Kb(L[Q*n+J]);j>0&&j<n&&J===j&&(k[0]=jM(j,Kb(L[Q*n+J-1]),ee,V)),te>0&&te<a&&Q===te&&(k[1]=jM(te,Kb(L[(Q-1)*n+J]),ee,V))})}return y.contour=x,y.size=function(M){if(!arguments.length)return[n,a];var L=Math.floor(M[0]),V=Math.floor(M[1]);if(!(L>=0&&V>=0))throw new Error("invalid size");return n=L,a=V,y},y.thresholds=function(M){return arguments.length?(u=typeof M=="function"?M:Array.isArray(M)?$c(Mz.call(M)):$c(M),y):u},y.smooth=function(M){return arguments.length?(m=M?P:gU,y):m===P},y}function yU(n){return isFinite(n)?n:NaN}function hh(n,a){return n==null?!1:+n>=a}function Kb(n){return n==null||isNaN(n=+n)?-1/0:n}function jM(n,a,u,m){const y=m-a,x=u-a,E=isFinite(y)||isFinite(x)?y/x:Math.sign(y)/Math.sign(x);return isNaN(E)?n:n+E-.5}function vU(n){return n[0]}function xU(n){return n[1]}function bU(){return 1}function wU(){var n=vU,a=xU,u=bU,m=960,y=500,x=20,E=2,r=x*3,P=m+r*2>>E,M=y+r*2>>E,L=$c(20);function V(ue){var ce=new Float32Array(P*M),se=Math.pow(2,-E),Ae=-1;for(const ut of ue){var De=(n(ut,++Ae,ue)+r)*se,Qe=(a(ut,Ae,ue)+r)*se,nt=+u(ut,Ae,ue);if(nt&&De>=0&&De<P&&Qe>=0&&Qe<M){var rt=Math.floor(De),tt=Math.floor(Qe),Be=De-rt-.5,Rt=Qe-tt-.5;ce[rt+tt*P]+=(1-Be)*(1-Rt)*nt,ce[rt+1+tt*P]+=Be*(1-Rt)*nt,ce[rt+1+(tt+1)*P]+=Be*Rt*nt,ce[rt+(tt+1)*P]+=(1-Be)*Rt*nt}}return lP({data:ce,width:P,height:M},x*se),ce}function k(ue){var ce=V(ue),se=L(ce),Ae=Math.pow(2,2*E);return Array.isArray(se)||(se=wh(Number.MIN_VALUE,y_(ce)/Ae,se)),Ww().size([P,M]).thresholds(se.map(De=>De*Ae))(ce).map((De,Qe)=>(De.value=+se[Qe],j(De)))}k.contours=function(ue){var ce=V(ue),se=Ww().size([P,M]),Ae=Math.pow(2,2*E),De=Qe=>{Qe=+Qe;var nt=j(se.contour(ce,Qe*Ae));return nt.value=Qe,nt};return Object.defineProperty(De,"max",{get:()=>y_(ce)/Ae}),De};function j(ue){return ue.coordinates.forEach(te),ue}function te(ue){ue.forEach(J)}function J(ue){ue.forEach(Q)}function Q(ue){ue[0]=ue[0]*Math.pow(2,E)-r,ue[1]=ue[1]*Math.pow(2,E)-r}function ee(){return r=x*3,P=m+r*2>>E,M=y+r*2>>E,k}return k.x=function(ue){return arguments.length?(n=typeof ue=="function"?ue:$c(+ue),k):n},k.y=function(ue){return arguments.length?(a=typeof ue=="function"?ue:$c(+ue),k):a},k.weight=function(ue){return arguments.length?(u=typeof ue=="function"?ue:$c(+ue),k):u},k.size=function(ue){if(!arguments.length)return[m,y];var ce=+ue[0],se=+ue[1];if(!(ce>=0&&se>=0))throw new Error("invalid size");return m=ce,y=se,ee()},k.cellSize=function(ue){if(!arguments.length)return 1<<E;if(!((ue=+ue)>=1))throw new Error("invalid cell size");return E=Math.floor(Math.log(ue)/Math.LN2),ee()},k.thresholds=function(ue){return arguments.length?(L=typeof ue=="function"?ue:Array.isArray(ue)?$c(Mz.call(ue)):$c(ue),k):L},k.bandwidth=function(ue){if(!arguments.length)return Math.sqrt(x*(x+1));if(!((ue=+ue)>=0))throw new Error("invalid bandwidth");return x=(Math.sqrt(4*ue*ue+1)-1)/2,ee()},k}const Gl=11102230246251565e-32,To=134217729,TU=(3+8*Gl)*Gl;function Jb(n,a,u,m,y){let x,E,r,P,M=a[0],L=m[0],V=0,k=0;L>M==L>-M?(x=M,M=a[++V]):(x=L,L=m[++k]);let j=0;if(V<n&&k<u)for(L>M==L>-M?(E=M+x,r=x-(E-M),M=a[++V]):(E=L+x,r=x-(E-L),L=m[++k]),x=E,r!==0&&(y[j++]=r);V<n&&k<u;)L>M==L>-M?(E=x+M,P=E-x,r=x-(E-P)+(M-P),M=a[++V]):(E=x+L,P=E-x,r=x-(E-P)+(L-P),L=m[++k]),x=E,r!==0&&(y[j++]=r);for(;V<n;)E=x+M,P=E-x,r=x-(E-P)+(M-P),M=a[++V],x=E,r!==0&&(y[j++]=r);for(;k<u;)E=x+L,P=E-x,r=x-(E-P)+(L-P),L=m[++k],x=E,r!==0&&(y[j++]=r);return(x!==0||j===0)&&(y[j++]=x),j}function SU(n,a){let u=a[0];for(let m=1;m<n;m++)u+=a[m];return u}function j_(n){return new Float64Array(n)}const EU=(3+16*Gl)*Gl,AU=(2+12*Gl)*Gl,IU=(9+64*Gl)*Gl*Gl,hd=j_(4),$M=j_(8),GM=j_(12),qM=j_(16),zo=j_(4);function MU(n,a,u,m,y,x,E){let r,P,M,L,V,k,j,te,J,Q,ee,ue,ce,se,Ae,De,Qe,nt;const rt=n-y,tt=u-y,Be=a-x,Rt=m-x;se=rt*Rt,k=To*rt,j=k-(k-rt),te=rt-j,k=To*Rt,J=k-(k-Rt),Q=Rt-J,Ae=te*Q-(se-j*J-te*J-j*Q),De=Be*tt,k=To*Be,j=k-(k-Be),te=Be-j,k=To*tt,J=k-(k-tt),Q=tt-J,Qe=te*Q-(De-j*J-te*J-j*Q),ee=Ae-Qe,V=Ae-ee,hd[0]=Ae-(ee+V)+(V-Qe),ue=se+ee,V=ue-se,ce=se-(ue-V)+(ee-V),ee=ce-De,V=ce-ee,hd[1]=ce-(ee+V)+(V-De),nt=ue+ee,V=nt-ue,hd[2]=ue-(nt-V)+(ee-V),hd[3]=nt;let ut=SU(4,hd),Pe=AU*E;if(ut>=Pe||-ut>=Pe||(V=n-rt,r=n-(rt+V)+(V-y),V=u-tt,M=u-(tt+V)+(V-y),V=a-Be,P=a-(Be+V)+(V-x),V=m-Rt,L=m-(Rt+V)+(V-x),r===0&&P===0&&M===0&&L===0)||(Pe=IU*E+TU*Math.abs(ut),ut+=rt*L+Rt*r-(Be*M+tt*P),ut>=Pe||-ut>=Pe))return ut;se=r*Rt,k=To*r,j=k-(k-r),te=r-j,k=To*Rt,J=k-(k-Rt),Q=Rt-J,Ae=te*Q-(se-j*J-te*J-j*Q),De=P*tt,k=To*P,j=k-(k-P),te=P-j,k=To*tt,J=k-(k-tt),Q=tt-J,Qe=te*Q-(De-j*J-te*J-j*Q),ee=Ae-Qe,V=Ae-ee,zo[0]=Ae-(ee+V)+(V-Qe),ue=se+ee,V=ue-se,ce=se-(ue-V)+(ee-V),ee=ce-De,V=ce-ee,zo[1]=ce-(ee+V)+(V-De),nt=ue+ee,V=nt-ue,zo[2]=ue-(nt-V)+(ee-V),zo[3]=nt;const Ve=Jb(4,hd,4,zo,$M);se=rt*L,k=To*rt,j=k-(k-rt),te=rt-j,k=To*L,J=k-(k-L),Q=L-J,Ae=te*Q-(se-j*J-te*J-j*Q),De=Be*M,k=To*Be,j=k-(k-Be),te=Be-j,k=To*M,J=k-(k-M),Q=M-J,Qe=te*Q-(De-j*J-te*J-j*Q),ee=Ae-Qe,V=Ae-ee,zo[0]=Ae-(ee+V)+(V-Qe),ue=se+ee,V=ue-se,ce=se-(ue-V)+(ee-V),ee=ce-De,V=ce-ee,zo[1]=ce-(ee+V)+(V-De),nt=ue+ee,V=nt-ue,zo[2]=ue-(nt-V)+(ee-V),zo[3]=nt;const qe=Jb(Ve,$M,4,zo,GM);se=r*L,k=To*r,j=k-(k-r),te=r-j,k=To*L,J=k-(k-L),Q=L-J,Ae=te*Q-(se-j*J-te*J-j*Q),De=P*M,k=To*P,j=k-(k-P),te=P-j,k=To*M,J=k-(k-M),Q=M-J,Qe=te*Q-(De-j*J-te*J-j*Q),ee=Ae-Qe,V=Ae-ee,zo[0]=Ae-(ee+V)+(V-Qe),ue=se+ee,V=ue-se,ce=se-(ue-V)+(ee-V),ee=ce-De,V=ce-ee,zo[1]=ce-(ee+V)+(V-De),nt=ue+ee,V=nt-ue,zo[2]=ue-(nt-V)+(ee-V),zo[3]=nt;const bt=Jb(qe,GM,4,zo,qM);return qM[bt-1]}function iy(n,a,u,m,y,x){const E=(a-x)*(u-y),r=(n-y)*(m-x),P=E-r,M=Math.abs(E+r);return Math.abs(P)>=EU*M?P:-MU(n,a,u,m,y,x,M)}const HM=Math.pow(2,-52),ry=new Uint32Array(512);class nv{static from(a,u=DU,m=LU){const y=a.length,x=new Float64Array(y*2);for(let E=0;E<y;E++){const r=a[E];x[2*E]=u(r),x[2*E+1]=m(r)}return new nv(x)}constructor(a){const u=a.length>>1;if(u>0&&typeof a[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=a;const m=Math.max(2*u-5,0);this._triangles=new Uint32Array(m*3),this._halfedges=new Int32Array(m*3),this._hashSize=Math.ceil(Math.sqrt(u)),this._hullPrev=new Uint32Array(u),this._hullNext=new Uint32Array(u),this._hullTri=new Uint32Array(u),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(u),this._dists=new Float64Array(u),this.update()}update(){const{coords:a,_hullPrev:u,_hullNext:m,_hullTri:y,_hullHash:x}=this,E=a.length>>1;let r=1/0,P=1/0,M=-1/0,L=-1/0;for(let rt=0;rt<E;rt++){const tt=a[2*rt],Be=a[2*rt+1];tt<r&&(r=tt),Be<P&&(P=Be),tt>M&&(M=tt),Be>L&&(L=Be),this._ids[rt]=rt}const V=(r+M)/2,k=(P+L)/2;let j,te,J;for(let rt=0,tt=1/0;rt<E;rt++){const Be=Qb(V,k,a[2*rt],a[2*rt+1]);Be<tt&&(j=rt,tt=Be)}const Q=a[2*j],ee=a[2*j+1];for(let rt=0,tt=1/0;rt<E;rt++){if(rt===j)continue;const Be=Qb(Q,ee,a[2*rt],a[2*rt+1]);Be<tt&&Be>0&&(te=rt,tt=Be)}let ue=a[2*te],ce=a[2*te+1],se=1/0;for(let rt=0;rt<E;rt++){if(rt===j||rt===te)continue;const tt=zU(Q,ee,ue,ce,a[2*rt],a[2*rt+1]);tt<se&&(J=rt,se=tt)}let Ae=a[2*J],De=a[2*J+1];if(se===1/0){for(let Be=0;Be<E;Be++)this._dists[Be]=a[2*Be]-a[0]||a[2*Be+1]-a[1];gd(this._ids,this._dists,0,E-1);const rt=new Uint32Array(E);let tt=0;for(let Be=0,Rt=-1/0;Be<E;Be++){const ut=this._ids[Be],Pe=this._dists[ut];Pe>Rt&&(rt[tt++]=ut,Rt=Pe)}this.hull=rt.subarray(0,tt),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(iy(Q,ee,ue,ce,Ae,De)<0){const rt=te,tt=ue,Be=ce;te=J,ue=Ae,ce=De,J=rt,Ae=tt,De=Be}const Qe=RU(Q,ee,ue,ce,Ae,De);this._cx=Qe.x,this._cy=Qe.y;for(let rt=0;rt<E;rt++)this._dists[rt]=Qb(a[2*rt],a[2*rt+1],Qe.x,Qe.y);gd(this._ids,this._dists,0,E-1),this._hullStart=j;let nt=3;m[j]=u[J]=te,m[te]=u[j]=J,m[J]=u[te]=j,y[j]=0,y[te]=1,y[J]=2,x.fill(-1),x[this._hashKey(Q,ee)]=j,x[this._hashKey(ue,ce)]=te,x[this._hashKey(Ae,De)]=J,this.trianglesLen=0,this._addTriangle(j,te,J,-1,-1,-1);for(let rt=0,tt,Be;rt<this._ids.length;rt++){const Rt=this._ids[rt],ut=a[2*Rt],Pe=a[2*Rt+1];if(rt>0&&Math.abs(ut-tt)<=HM&&Math.abs(Pe-Be)<=HM||(tt=ut,Be=Pe,Rt===j||Rt===te||Rt===J))continue;let Ve=0;for(let Lt=0,rn=this._hashKey(ut,Pe);Lt<this._hashSize&&(Ve=x[(rn+Lt)%this._hashSize],!(Ve!==-1&&Ve!==m[Ve]));Lt++);Ve=u[Ve];let qe=Ve,bt;for(;bt=m[qe],iy(ut,Pe,a[2*qe],a[2*qe+1],a[2*bt],a[2*bt+1])>=0;)if(qe=bt,qe===Ve){qe=-1;break}if(qe===-1)continue;let Ht=this._addTriangle(qe,Rt,m[qe],-1,-1,y[qe]);y[Rt]=this._legalize(Ht+2),y[qe]=Ht,nt++;let Dt=m[qe];for(;bt=m[Dt],iy(ut,Pe,a[2*Dt],a[2*Dt+1],a[2*bt],a[2*bt+1])<0;)Ht=this._addTriangle(Dt,Rt,bt,y[Rt],-1,y[Dt]),y[Rt]=this._legalize(Ht+2),m[Dt]=Dt,nt--,Dt=bt;if(qe===Ve)for(;bt=u[qe],iy(ut,Pe,a[2*bt],a[2*bt+1],a[2*qe],a[2*qe+1])<0;)Ht=this._addTriangle(bt,Rt,qe,-1,y[qe],y[bt]),this._legalize(Ht+2),y[bt]=Ht,m[qe]=qe,nt--,qe=bt;this._hullStart=u[Rt]=qe,m[qe]=u[Dt]=Rt,m[Rt]=Dt,x[this._hashKey(ut,Pe)]=Rt,x[this._hashKey(a[2*qe],a[2*qe+1])]=qe}this.hull=new Uint32Array(nt);for(let rt=0,tt=this._hullStart;rt<nt;rt++)this.hull[rt]=tt,tt=m[tt];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(a,u){return Math.floor(CU(a-this._cx,u-this._cy)*this._hashSize)%this._hashSize}_legalize(a){const{_triangles:u,_halfedges:m,coords:y}=this;let x=0,E=0;for(;;){const r=m[a],P=a-a%3;if(E=P+(a+2)%3,r===-1){if(x===0)break;a=ry[--x];continue}const M=r-r%3,L=P+(a+1)%3,V=M+(r+2)%3,k=u[E],j=u[a],te=u[L],J=u[V];if(PU(y[2*k],y[2*k+1],y[2*j],y[2*j+1],y[2*te],y[2*te+1],y[2*J],y[2*J+1])){u[a]=J,u[r]=k;const ee=m[V];if(ee===-1){let ce=this._hullStart;do{if(this._hullTri[ce]===V){this._hullTri[ce]=a;break}ce=this._hullPrev[ce]}while(ce!==this._hullStart)}this._link(a,ee),this._link(r,m[E]),this._link(E,V);const ue=M+(r+1)%3;x<ry.length&&(ry[x++]=ue)}else{if(x===0)break;a=ry[--x]}}return E}_link(a,u){this._halfedges[a]=u,u!==-1&&(this._halfedges[u]=a)}_addTriangle(a,u,m,y,x,E){const r=this.trianglesLen;return this._triangles[r]=a,this._triangles[r+1]=u,this._triangles[r+2]=m,this._link(r,y),this._link(r+1,x),this._link(r+2,E),this.trianglesLen+=3,r}}function CU(n,a){const u=n/(Math.abs(n)+Math.abs(a));return(a>0?3-u:1+u)/4}function Qb(n,a,u,m){const y=n-u,x=a-m;return y*y+x*x}function PU(n,a,u,m,y,x,E,r){const P=n-E,M=a-r,L=u-E,V=m-r,k=y-E,j=x-r,te=P*P+M*M,J=L*L+V*V,Q=k*k+j*j;return P*(V*Q-J*j)-M*(L*Q-J*k)+te*(L*j-V*k)<0}function zU(n,a,u,m,y,x){const E=u-n,r=m-a,P=y-n,M=x-a,L=E*E+r*r,V=P*P+M*M,k=.5/(E*M-r*P),j=(M*L-r*V)*k,te=(E*V-P*L)*k;return j*j+te*te}function RU(n,a,u,m,y,x){const E=u-n,r=m-a,P=y-n,M=x-a,L=E*E+r*r,V=P*P+M*M,k=.5/(E*M-r*P),j=n+(M*L-r*V)*k,te=a+(E*V-P*L)*k;return{x:j,y:te}}function gd(n,a,u,m){if(m-u<=20)for(let y=u+1;y<=m;y++){const x=n[y],E=a[x];let r=y-1;for(;r>=u&&a[n[r]]>E;)n[r+1]=n[r--];n[r+1]=x}else{const y=u+m>>1;let x=u+1,E=m;$m(n,y,x),a[n[u]]>a[n[m]]&&$m(n,u,m),a[n[x]]>a[n[m]]&&$m(n,x,m),a[n[u]]>a[n[x]]&&$m(n,u,x);const r=n[x],P=a[r];for(;;){do x++;while(a[n[x]]<P);do E--;while(a[n[E]]>P);if(E<x)break;$m(n,x,E)}n[u+1]=n[E],n[E]=r,m-x+1>=E-u?(gd(n,a,x,m),gd(n,a,u,E-1)):(gd(n,a,u,E-1),gd(n,a,x,m))}}function $m(n,a,u){const m=n[a];n[a]=n[u],n[u]=m}function DU(n){return n[0]}function LU(n){return n[1]}const ZM=1e-6;class _h{constructor(){this._x0=this._y0=this._x1=this._y1=null,this._=""}moveTo(a,u){this._+=`M${this._x0=this._x1=+a},${this._y0=this._y1=+u}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")}lineTo(a,u){this._+=`L${this._x1=+a},${this._y1=+u}`}arc(a,u,m){a=+a,u=+u,m=+m;const y=a+m,x=u;if(m<0)throw new Error("negative radius");this._x1===null?this._+=`M${y},${x}`:(Math.abs(this._x1-y)>ZM||Math.abs(this._y1-x)>ZM)&&(this._+="L"+y+","+x),m&&(this._+=`A${m},${m},0,1,1,${a-m},${u}A${m},${m},0,1,1,${this._x1=y},${this._y1=x}`)}rect(a,u,m,y){this._+=`M${this._x0=this._x1=+a},${this._y0=this._y1=+u}h${+m}v${+y}h${-m}Z`}value(){return this._||null}}class Xw{constructor(){this._=[]}moveTo(a,u){this._.push([a,u])}closePath(){this._.push(this._[0].slice())}lineTo(a,u){this._.push([a,u])}value(){return this._.length?this._:null}}class Cz{constructor(a,[u,m,y,x]=[0,0,960,500]){if(!((y=+y)>=(u=+u))||!((x=+x)>=(m=+m)))throw new Error("invalid bounds");this.delaunay=a,this._circumcenters=new Float64Array(a.points.length*2),this.vectors=new Float64Array(a.points.length*2),this.xmax=y,this.xmin=u,this.ymax=x,this.ymin=m,this._init()}update(){return this.delaunay.update(),this._init(),this}_init(){const{delaunay:{points:a,hull:u,triangles:m},vectors:y}=this;let x,E;const r=this.circumcenters=this._circumcenters.subarray(0,m.length/3*2);for(let J=0,Q=0,ee=m.length,ue,ce;J<ee;J+=3,Q+=2){const se=m[J]*2,Ae=m[J+1]*2,De=m[J+2]*2,Qe=a[se],nt=a[se+1],rt=a[Ae],tt=a[Ae+1],Be=a[De],Rt=a[De+1],ut=rt-Qe,Pe=tt-nt,Ve=Be-Qe,qe=Rt-nt,bt=(ut*qe-Pe*Ve)*2;if(Math.abs(bt)<1e-9){if(x===void 0){x=E=0;for(const Dt of u)x+=a[Dt*2],E+=a[Dt*2+1];x/=u.length,E/=u.length}const Ht=1e9*Math.sign((x-Qe)*qe-(E-nt)*Ve);ue=(Qe+Be)/2-Ht*qe,ce=(nt+Rt)/2+Ht*Ve}else{const Ht=1/bt,Dt=ut*ut+Pe*Pe,Lt=Ve*Ve+qe*qe;ue=Qe+(qe*Dt-Pe*Lt)*Ht,ce=nt+(ut*Lt-Ve*Dt)*Ht}r[Q]=ue,r[Q+1]=ce}let P=u[u.length-1],M,L=P*4,V,k=a[2*P],j,te=a[2*P+1];y.fill(0);for(let J=0;J<u.length;++J)P=u[J],M=L,V=k,j=te,L=P*4,k=a[2*P],te=a[2*P+1],y[M+2]=y[L]=j-te,y[M+3]=y[L+1]=k-V}render(a){const u=a==null?a=new _h:void 0,{delaunay:{halfedges:m,inedges:y,hull:x},circumcenters:E,vectors:r}=this;if(x.length<=1)return null;for(let L=0,V=m.length;L<V;++L){const k=m[L];if(k<L)continue;const j=Math.floor(L/3)*2,te=Math.floor(k/3)*2,J=E[j],Q=E[j+1],ee=E[te],ue=E[te+1];this._renderSegment(J,Q,ee,ue,a)}let P,M=x[x.length-1];for(let L=0;L<x.length;++L){P=M,M=x[L];const V=Math.floor(y[M]/3)*2,k=E[V],j=E[V+1],te=P*4,J=this._project(k,j,r[te+2],r[te+3]);J&&this._renderSegment(k,j,J[0],J[1],a)}return u&&u.value()}renderBounds(a){const u=a==null?a=new _h:void 0;return a.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin),u&&u.value()}renderCell(a,u){const m=u==null?u=new _h:void 0,y=this._clip(a);if(y===null||!y.length)return;u.moveTo(y[0],y[1]);let x=y.length;for(;y[0]===y[x-2]&&y[1]===y[x-1]&&x>1;)x-=2;for(let E=2;E<x;E+=2)(y[E]!==y[E-2]||y[E+1]!==y[E-1])&&u.lineTo(y[E],y[E+1]);return u.closePath(),m&&m.value()}*cellPolygons(){const{delaunay:{points:a}}=this;for(let u=0,m=a.length/2;u<m;++u){const y=this.cellPolygon(u);y&&(y.index=u,yield y)}}cellPolygon(a){const u=new Xw;return this.renderCell(a,u),u.value()}_renderSegment(a,u,m,y,x){let E;const r=this._regioncode(a,u),P=this._regioncode(m,y);r===0&&P===0?(x.moveTo(a,u),x.lineTo(m,y)):(E=this._clipSegment(a,u,m,y,r,P))&&(x.moveTo(E[0],E[1]),x.lineTo(E[2],E[3]))}contains(a,u,m){return u=+u,u!==u||(m=+m,m!==m)?!1:this.delaunay._step(a,u,m)===a}*neighbors(a){const u=this._clip(a);if(u)for(const m of this.delaunay.neighbors(a)){const y=this._clip(m);if(y){e:for(let x=0,E=u.length;x<E;x+=2)for(let r=0,P=y.length;r<P;r+=2)if(u[x]===y[r]&&u[x+1]===y[r+1]&&u[(x+2)%E]===y[(r+P-2)%P]&&u[(x+3)%E]===y[(r+P-1)%P]){yield m;break e}}}}_cell(a){const{circumcenters:u,delaunay:{inedges:m,halfedges:y,triangles:x}}=this,E=m[a];if(E===-1)return null;const r=[];let P=E;do{const M=Math.floor(P/3);if(r.push(u[M*2],u[M*2+1]),P=P%3===2?P-2:P+1,x[P]!==a)break;P=y[P]}while(P!==E&&P!==-1);return r}_clip(a){if(a===0&&this.delaunay.hull.length===1)return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];const u=this._cell(a);if(u===null)return null;const{vectors:m}=this,y=a*4;return this._simplify(m[y]||m[y+1]?this._clipInfinite(a,u,m[y],m[y+1],m[y+2],m[y+3]):this._clipFinite(a,u))}_clipFinite(a,u){const m=u.length;let y=null,x,E,r=u[m-2],P=u[m-1],M,L=this._regioncode(r,P),V,k=0;for(let j=0;j<m;j+=2)if(x=r,E=P,r=u[j],P=u[j+1],M=L,L=this._regioncode(r,P),M===0&&L===0)V=k,k=0,y?y.push(r,P):y=[r,P];else{let te,J,Q,ee,ue;if(M===0){if((te=this._clipSegment(x,E,r,P,M,L))===null)continue;[J,Q,ee,ue]=te}else{if((te=this._clipSegment(r,P,x,E,L,M))===null)continue;[ee,ue,J,Q]=te,V=k,k=this._edgecode(J,Q),V&&k&&this._edge(a,V,k,y,y.length),y?y.push(J,Q):y=[J,Q]}V=k,k=this._edgecode(ee,ue),V&&k&&this._edge(a,V,k,y,y.length),y?y.push(ee,ue):y=[ee,ue]}if(y)V=k,k=this._edgecode(y[0],y[1]),V&&k&&this._edge(a,V,k,y,y.length);else if(this.contains(a,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2))return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];return y}_clipSegment(a,u,m,y,x,E){const r=x<E;for(r&&([a,u,m,y,x,E]=[m,y,a,u,E,x]);;){if(x===0&&E===0)return r?[m,y,a,u]:[a,u,m,y];if(x&E)return null;let P,M,L=x||E;L&8?(P=a+(m-a)*(this.ymax-u)/(y-u),M=this.ymax):L&4?(P=a+(m-a)*(this.ymin-u)/(y-u),M=this.ymin):L&2?(M=u+(y-u)*(this.xmax-a)/(m-a),P=this.xmax):(M=u+(y-u)*(this.xmin-a)/(m-a),P=this.xmin),x?(a=P,u=M,x=this._regioncode(a,u)):(m=P,y=M,E=this._regioncode(m,y))}}_clipInfinite(a,u,m,y,x,E){let r=Array.from(u),P;if((P=this._project(r[0],r[1],m,y))&&r.unshift(P[0],P[1]),(P=this._project(r[r.length-2],r[r.length-1],x,E))&&r.push(P[0],P[1]),r=this._clipFinite(a,r))for(let M=0,L=r.length,V,k=this._edgecode(r[L-2],r[L-1]);M<L;M+=2)V=k,k=this._edgecode(r[M],r[M+1]),V&&k&&(M=this._edge(a,V,k,r,M),L=r.length);else this.contains(a,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)&&(r=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]);return r}_edge(a,u,m,y,x){for(;u!==m;){let E,r;switch(u){case 5:u=4;continue;case 4:u=6,E=this.xmax,r=this.ymin;break;case 6:u=2;continue;case 2:u=10,E=this.xmax,r=this.ymax;break;case 10:u=8;continue;case 8:u=9,E=this.xmin,r=this.ymax;break;case 9:u=1;continue;case 1:u=5,E=this.xmin,r=this.ymin;break}(y[x]!==E||y[x+1]!==r)&&this.contains(a,E,r)&&(y.splice(x,0,E,r),x+=2)}return x}_project(a,u,m,y){let x=1/0,E,r,P;if(y<0){if(u<=this.ymin)return null;(E=(this.ymin-u)/y)<x&&(P=this.ymin,r=a+(x=E)*m)}else if(y>0){if(u>=this.ymax)return null;(E=(this.ymax-u)/y)<x&&(P=this.ymax,r=a+(x=E)*m)}if(m>0){if(a>=this.xmax)return null;(E=(this.xmax-a)/m)<x&&(r=this.xmax,P=u+(x=E)*y)}else if(m<0){if(a<=this.xmin)return null;(E=(this.xmin-a)/m)<x&&(r=this.xmin,P=u+(x=E)*y)}return[r,P]}_edgecode(a,u){return(a===this.xmin?1:a===this.xmax?2:0)|(u===this.ymin?4:u===this.ymax?8:0)}_regioncode(a,u){return(a<this.xmin?1:a>this.xmax?2:0)|(u<this.ymin?4:u>this.ymax?8:0)}_simplify(a){if(a&&a.length>4){for(let u=0;u<a.length;u+=2){const m=(u+2)%a.length,y=(u+4)%a.length;(a[u]===a[m]&&a[m]===a[y]||a[u+1]===a[m+1]&&a[m+1]===a[y+1])&&(a.splice(m,2),u-=2)}a.length||(a=null)}return a}}const kU=2*Math.PI,fd=Math.pow;function OU(n){return n[0]}function FU(n){return n[1]}function BU(n){const{triangles:a,coords:u}=n;for(let m=0;m<a.length;m+=3){const y=2*a[m],x=2*a[m+1],E=2*a[m+2];if((u[E]-u[y])*(u[x+1]-u[y+1])-(u[x]-u[y])*(u[E+1]-u[y+1])>1e-10)return!1}return!0}function NU(n,a,u){return[n+Math.sin(n+a)*u,a+Math.cos(n-a)*u]}class sT{static from(a,u=OU,m=FU,y){return new sT("length"in a?VU(a,u,m,y):Float64Array.from(UU(a,u,m,y)))}constructor(a){this._delaunator=new nv(a),this.inedges=new Int32Array(a.length/2),this._hullIndex=new Int32Array(a.length/2),this.points=this._delaunator.coords,this._init()}update(){return this._delaunator.update(),this._init(),this}_init(){const a=this._delaunator,u=this.points;if(a.hull&&a.hull.length>2&&BU(a)){this.collinear=Int32Array.from({length:u.length/2},(k,j)=>j).sort((k,j)=>u[2*k]-u[2*j]||u[2*k+1]-u[2*j+1]);const P=this.collinear[0],M=this.collinear[this.collinear.length-1],L=[u[2*P],u[2*P+1],u[2*M],u[2*M+1]],V=1e-8*Math.hypot(L[3]-L[1],L[2]-L[0]);for(let k=0,j=u.length/2;k<j;++k){const te=NU(u[2*k],u[2*k+1],V);u[2*k]=te[0],u[2*k+1]=te[1]}this._delaunator=new nv(u)}else delete this.collinear;const m=this.halfedges=this._delaunator.halfedges,y=this.hull=this._delaunator.hull,x=this.triangles=this._delaunator.triangles,E=this.inedges.fill(-1),r=this._hullIndex.fill(-1);for(let P=0,M=m.length;P<M;++P){const L=x[P%3===2?P-2:P+1];(m[P]===-1||E[L]===-1)&&(E[L]=P)}for(let P=0,M=y.length;P<M;++P)r[y[P]]=P;y.length<=2&&y.length>0&&(this.triangles=new Int32Array(3).fill(-1),this.halfedges=new Int32Array(3).fill(-1),this.triangles[0]=y[0],E[y[0]]=1,y.length===2&&(E[y[1]]=0,this.triangles[1]=y[1],this.triangles[2]=y[1]))}voronoi(a){return new Cz(this,a)}*neighbors(a){const{inedges:u,hull:m,_hullIndex:y,halfedges:x,triangles:E,collinear:r}=this;if(r){const V=r.indexOf(a);V>0&&(yield r[V-1]),V<r.length-1&&(yield r[V+1]);return}const P=u[a];if(P===-1)return;let M=P,L=-1;do{if(yield L=E[M],M=M%3===2?M-2:M+1,E[M]!==a)return;if(M=x[M],M===-1){const V=m[(y[a]+1)%m.length];V!==L&&(yield V);return}}while(M!==P)}find(a,u,m=0){if(a=+a,a!==a||(u=+u,u!==u))return-1;const y=m;let x;for(;(x=this._step(m,a,u))>=0&&x!==m&&x!==y;)m=x;return x}_step(a,u,m){const{inedges:y,hull:x,_hullIndex:E,halfedges:r,triangles:P,points:M}=this;if(y[a]===-1||!M.length)return(a+1)%(M.length>>1);let L=a,V=fd(u-M[a*2],2)+fd(m-M[a*2+1],2);const k=y[a];let j=k;do{let te=P[j];const J=fd(u-M[te*2],2)+fd(m-M[te*2+1],2);if(J<V&&(V=J,L=te),j=j%3===2?j-2:j+1,P[j]!==a)break;if(j=r[j],j===-1){if(j=x[(E[a]+1)%x.length],j!==te&&fd(u-M[j*2],2)+fd(m-M[j*2+1],2)<V)return j;break}}while(j!==k);return L}render(a){const u=a==null?a=new _h:void 0,{points:m,halfedges:y,triangles:x}=this;for(let E=0,r=y.length;E<r;++E){const P=y[E];if(P<E)continue;const M=x[E]*2,L=x[P]*2;a.moveTo(m[M],m[M+1]),a.lineTo(m[L],m[L+1])}return this.renderHull(a),u&&u.value()}renderPoints(a,u){u===void 0&&(!a||typeof a.moveTo!="function")&&(u=a,a=null),u=u==null?2:+u;const m=a==null?a=new _h:void 0,{points:y}=this;for(let x=0,E=y.length;x<E;x+=2){const r=y[x],P=y[x+1];a.moveTo(r+u,P),a.arc(r,P,u,0,kU)}return m&&m.value()}renderHull(a){const u=a==null?a=new _h:void 0,{hull:m,points:y}=this,x=m[0]*2,E=m.length;a.moveTo(y[x],y[x+1]);for(let r=1;r<E;++r){const P=2*m[r];a.lineTo(y[P],y[P+1])}return a.closePath(),u&&u.value()}hullPolygon(){const a=new Xw;return this.renderHull(a),a.value()}renderTriangle(a,u){const m=u==null?u=new _h:void 0,{points:y,triangles:x}=this,E=x[a*=3]*2,r=x[a+1]*2,P=x[a+2]*2;return u.moveTo(y[E],y[E+1]),u.lineTo(y[r],y[r+1]),u.lineTo(y[P],y[P+1]),u.closePath(),m&&m.value()}*trianglePolygons(){const{triangles:a}=this;for(let u=0,m=a.length/3;u<m;++u)yield this.trianglePolygon(u)}trianglePolygon(a){const u=new Xw;return this.renderTriangle(a,u),u.value()}}function VU(n,a,u,m){const y=n.length,x=new Float64Array(y*2);for(let E=0;E<y;++E){const r=n[E];x[E*2]=a.call(m,r,E,n),x[E*2+1]=u.call(m,r,E,n)}return x}function*UU(n,a,u,m){let y=0;for(const x of n)yield a.call(m,x,y,n),yield u.call(m,x,y,n),++y}var WM={},ew={},tw=34,Gm=10,nw=13;function Pz(n){return new Function("d","return {"+n.map(function(a,u){return JSON.stringify(a)+": d["+u+'] || ""'}).join(",")+"}")}function jU(n,a){var u=Pz(n);return function(m,y){return a(u(m),y,n)}}function XM(n){var a=Object.create(null),u=[];return n.forEach(function(m){for(var y in m)y in a||u.push(a[y]=y)}),u}function ts(n,a){var u=n+"",m=u.length;return m<a?new Array(a-m+1).join(0)+u:u}function $U(n){return n<0?"-"+ts(-n,6):n>9999?"+"+ts(n,6):ts(n,4)}function GU(n){var a=n.getUTCHours(),u=n.getUTCMinutes(),m=n.getUTCSeconds(),y=n.getUTCMilliseconds();return isNaN(n)?"Invalid Date":$U(n.getUTCFullYear())+"-"+ts(n.getUTCMonth()+1,2)+"-"+ts(n.getUTCDate(),2)+(y?"T"+ts(a,2)+":"+ts(u,2)+":"+ts(m,2)+"."+ts(y,3)+"Z":m?"T"+ts(a,2)+":"+ts(u,2)+":"+ts(m,2)+"Z":u||a?"T"+ts(a,2)+":"+ts(u,2)+"Z":"")}function lx(n){var a=new RegExp('["'+n+`
\r]`),u=n.charCodeAt(0);function m(V,k){var j,te,J=y(V,function(Q,ee){if(j)return j(Q,ee-1);te=Q,j=k?jU(Q,k):Pz(Q)});return J.columns=te||[],J}function y(V,k){var j=[],te=V.length,J=0,Q=0,ee,ue=te<=0,ce=!1;V.charCodeAt(te-1)===Gm&&--te,V.charCodeAt(te-1)===nw&&--te;function se(){if(ue)return ew;if(ce)return ce=!1,WM;var De,Qe=J,nt;if(V.charCodeAt(Qe)===tw){for(;J++<te&&V.charCodeAt(J)!==tw||V.charCodeAt(++J)===tw;);return(De=J)>=te?ue=!0:(nt=V.charCodeAt(J++))===Gm?ce=!0:nt===nw&&(ce=!0,V.charCodeAt(J)===Gm&&++J),V.slice(Qe+1,De-1).replace(/""/g,'"')}for(;J<te;){if((nt=V.charCodeAt(De=J++))===Gm)ce=!0;else if(nt===nw)ce=!0,V.charCodeAt(J)===Gm&&++J;else if(nt!==u)continue;return V.slice(Qe,De)}return ue=!0,V.slice(Qe,te)}for(;(ee=se())!==ew;){for(var Ae=[];ee!==WM&&ee!==ew;)Ae.push(ee),ee=se();k&&(Ae=k(Ae,Q++))==null||j.push(Ae)}return j}function x(V,k){return V.map(function(j){return k.map(function(te){return L(j[te])}).join(n)})}function E(V,k){return k==null&&(k=XM(V)),[k.map(L).join(n)].concat(x(V,k)).join(`
`)}function r(V,k){return k==null&&(k=XM(V)),x(V,k).join(`
`)}function P(V){return V.map(M).join(`
`)}function M(V){return V.map(L).join(n)}function L(V){return V==null?"":V instanceof Date?GU(V):a.test(V+="")?'"'+V.replace(/"/g,'""')+'"':V}return{parse:m,parseRows:y,format:E,formatBody:r,formatRows:P,formatRow:M,formatValue:L}}var Lh=lx(","),zz=Lh.parse,qU=Lh.parseRows,HU=Lh.format,ZU=Lh.formatBody,WU=Lh.formatRows,XU=Lh.formatRow,YU=Lh.formatValue,kh=lx("	"),Rz=kh.parse,KU=kh.parseRows,JU=kh.format,QU=kh.formatBody,e7=kh.formatRows,t7=kh.formatRow,n7=kh.formatValue;function i7(n){for(var a in n){var u=n[a].trim(),m,y;if(!u)u=null;else if(u==="true")u=!0;else if(u==="false")u=!1;else if(u==="NaN")u=NaN;else if(!isNaN(m=+u))u=m;else if(y=u.match(/^([-+]\d{2})?\d{4}(-\d{2}(-\d{2})?)?(T\d{2}:\d{2}(:\d{2}(\.\d{3})?)?(Z|[-+]\d{2}:\d{2})?)?$/))r7&&y[4]&&!y[7]&&(u=u.replace(/-/g,"/").replace(/T/," ")),u=new Date(u);else continue;n[a]=u}return n}const r7=new Date("2019-01-01T00:00").getHours()||new Date("2019-07-01T00:00").getHours();function o7(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);return n.blob()}function s7(n,a){return fetch(n,a).then(o7)}function a7(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);return n.arrayBuffer()}function l7(n,a){return fetch(n,a).then(a7)}function c7(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);return n.text()}function cx(n,a){return fetch(n,a).then(c7)}function Dz(n){return function(a,u,m){return arguments.length===2&&typeof u=="function"&&(m=u,u=void 0),cx(a,u).then(function(y){return n(y,m)})}}function u7(n,a,u,m){arguments.length===3&&typeof u=="function"&&(m=u,u=void 0);var y=lx(n);return cx(a,u).then(function(x){return y.parse(x,m)})}var Lz=Dz(zz),h7=Dz(Rz);function f7(n,a){return new Promise(function(u,m){var y=new Image;for(var x in a)y[x]=a[x];y.onerror=m,y.onload=function(){u(y)},y.src=n})}function d7(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);if(!(n.status===204||n.status===205))return n.json()}function p7(n,a){return fetch(n,a).then(d7)}function aT(n){return(a,u)=>cx(a,u).then(m=>new DOMParser().parseFromString(m,n))}const m7=aT("application/xml");var _7=aT("text/html"),g7=aT("image/svg+xml");function y7(n,a){var u,m=1;n==null&&(n=0),a==null&&(a=0);function y(){var x,E=u.length,r,P=0,M=0;for(x=0;x<E;++x)r=u[x],P+=r.x,M+=r.y;for(P=(P/E-n)*m,M=(M/E-a)*m,x=0;x<E;++x)r=u[x],r.x-=P,r.y-=M}return y.initialize=function(x){u=x},y.x=function(x){return arguments.length?(n=+x,y):n},y.y=function(x){return arguments.length?(a=+x,y):a},y.strength=function(x){return arguments.length?(m=+x,y):m},y}function v7(n){const a=+this._x.call(null,n),u=+this._y.call(null,n);return kz(this.cover(a,u),a,u,n)}function kz(n,a,u,m){if(isNaN(a)||isNaN(u))return n;var y,x=n._root,E={data:m},r=n._x0,P=n._y0,M=n._x1,L=n._y1,V,k,j,te,J,Q,ee,ue;if(!x)return n._root=E,n;for(;x.length;)if((J=a>=(V=(r+M)/2))?r=V:M=V,(Q=u>=(k=(P+L)/2))?P=k:L=k,y=x,!(x=x[ee=Q<<1|J]))return y[ee]=E,n;if(j=+n._x.call(null,x.data),te=+n._y.call(null,x.data),a===j&&u===te)return E.next=x,y?y[ee]=E:n._root=E,n;do y=y?y[ee]=new Array(4):n._root=new Array(4),(J=a>=(V=(r+M)/2))?r=V:M=V,(Q=u>=(k=(P+L)/2))?P=k:L=k;while((ee=Q<<1|J)===(ue=(te>=k)<<1|j>=V));return y[ue]=x,y[ee]=E,n}function x7(n){var a,u,m=n.length,y,x,E=new Array(m),r=new Array(m),P=1/0,M=1/0,L=-1/0,V=-1/0;for(u=0;u<m;++u)isNaN(y=+this._x.call(null,a=n[u]))||isNaN(x=+this._y.call(null,a))||(E[u]=y,r[u]=x,y<P&&(P=y),y>L&&(L=y),x<M&&(M=x),x>V&&(V=x));if(P>L||M>V)return this;for(this.cover(P,M).cover(L,V),u=0;u<m;++u)kz(this,E[u],r[u],n[u]);return this}function b7(n,a){if(isNaN(n=+n)||isNaN(a=+a))return this;var u=this._x0,m=this._y0,y=this._x1,x=this._y1;if(isNaN(u))y=(u=Math.floor(n))+1,x=(m=Math.floor(a))+1;else{for(var E=y-u||1,r=this._root,P,M;u>n||n>=y||m>a||a>=x;)switch(M=(a<m)<<1|n<u,P=new Array(4),P[M]=r,r=P,E*=2,M){case 0:y=u+E,x=m+E;break;case 1:u=y-E,x=m+E;break;case 2:y=u+E,m=x-E;break;case 3:u=y-E,m=x-E;break}this._root&&this._root.length&&(this._root=r)}return this._x0=u,this._y0=m,this._x1=y,this._y1=x,this}function w7(){var n=[];return this.visit(function(a){if(!a.length)do n.push(a.data);while(a=a.next)}),n}function T7(n){return arguments.length?this.cover(+n[0][0],+n[0][1]).cover(+n[1][0],+n[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function Oo(n,a,u,m,y){this.node=n,this.x0=a,this.y0=u,this.x1=m,this.y1=y}function S7(n,a,u){var m,y=this._x0,x=this._y0,E,r,P,M,L=this._x1,V=this._y1,k=[],j=this._root,te,J;for(j&&k.push(new Oo(j,y,x,L,V)),u==null?u=1/0:(y=n-u,x=a-u,L=n+u,V=a+u,u*=u);te=k.pop();)if(!(!(j=te.node)||(E=te.x0)>L||(r=te.y0)>V||(P=te.x1)<y||(M=te.y1)<x))if(j.length){var Q=(E+P)/2,ee=(r+M)/2;k.push(new Oo(j[3],Q,ee,P,M),new Oo(j[2],E,ee,Q,M),new Oo(j[1],Q,r,P,ee),new Oo(j[0],E,r,Q,ee)),(J=(a>=ee)<<1|n>=Q)&&(te=k[k.length-1],k[k.length-1]=k[k.length-1-J],k[k.length-1-J]=te)}else{var ue=n-+this._x.call(null,j.data),ce=a-+this._y.call(null,j.data),se=ue*ue+ce*ce;if(se<u){var Ae=Math.sqrt(u=se);y=n-Ae,x=a-Ae,L=n+Ae,V=a+Ae,m=j.data}}return m}function E7(n){if(isNaN(L=+this._x.call(null,n))||isNaN(V=+this._y.call(null,n)))return this;var a,u=this._root,m,y,x,E=this._x0,r=this._y0,P=this._x1,M=this._y1,L,V,k,j,te,J,Q,ee;if(!u)return this;if(u.length)for(;;){if((te=L>=(k=(E+P)/2))?E=k:P=k,(J=V>=(j=(r+M)/2))?r=j:M=j,a=u,!(u=u[Q=J<<1|te]))return this;if(!u.length)break;(a[Q+1&3]||a[Q+2&3]||a[Q+3&3])&&(m=a,ee=Q)}for(;u.data!==n;)if(y=u,!(u=u.next))return this;return(x=u.next)&&delete u.next,y?(x?y.next=x:delete y.next,this):a?(x?a[Q]=x:delete a[Q],(u=a[0]||a[1]||a[2]||a[3])&&u===(a[3]||a[2]||a[1]||a[0])&&!u.length&&(m?m[ee]=u:this._root=u),this):(this._root=x,this)}function A7(n){for(var a=0,u=n.length;a<u;++a)this.remove(n[a]);return this}function I7(){return this._root}function M7(){var n=0;return this.visit(function(a){if(!a.length)do++n;while(a=a.next)}),n}function C7(n){var a=[],u,m=this._root,y,x,E,r,P;for(m&&a.push(new Oo(m,this._x0,this._y0,this._x1,this._y1));u=a.pop();)if(!n(m=u.node,x=u.x0,E=u.y0,r=u.x1,P=u.y1)&&m.length){var M=(x+r)/2,L=(E+P)/2;(y=m[3])&&a.push(new Oo(y,M,L,r,P)),(y=m[2])&&a.push(new Oo(y,x,L,M,P)),(y=m[1])&&a.push(new Oo(y,M,E,r,L)),(y=m[0])&&a.push(new Oo(y,x,E,M,L))}return this}function P7(n){var a=[],u=[],m;for(this._root&&a.push(new Oo(this._root,this._x0,this._y0,this._x1,this._y1));m=a.pop();){var y=m.node;if(y.length){var x,E=m.x0,r=m.y0,P=m.x1,M=m.y1,L=(E+P)/2,V=(r+M)/2;(x=y[0])&&a.push(new Oo(x,E,r,L,V)),(x=y[1])&&a.push(new Oo(x,L,r,P,V)),(x=y[2])&&a.push(new Oo(x,E,V,L,M)),(x=y[3])&&a.push(new Oo(x,L,V,P,M))}u.push(m)}for(;m=u.pop();)n(m.node,m.x0,m.y0,m.x1,m.y1);return this}function z7(n){return n[0]}function R7(n){return arguments.length?(this._x=n,this):this._x}function D7(n){return n[1]}function L7(n){return arguments.length?(this._y=n,this):this._y}function ux(n,a,u){var m=new lT(a??z7,u??D7,NaN,NaN,NaN,NaN);return n==null?m:m.addAll(n)}function lT(n,a,u,m,y,x){this._x=n,this._y=a,this._x0=u,this._y0=m,this._x1=y,this._y1=x,this._root=void 0}function YM(n){for(var a={data:n.data},u=a;n=n.next;)u=u.next={data:n.data};return a}var Go=ux.prototype=lT.prototype;Go.copy=function(){var n=new lT(this._x,this._y,this._x0,this._y0,this._x1,this._y1),a=this._root,u,m;if(!a)return n;if(!a.length)return n._root=YM(a),n;for(u=[{source:a,target:n._root=new Array(4)}];a=u.pop();)for(var y=0;y<4;++y)(m=a.source[y])&&(m.length?u.push({source:m,target:a.target[y]=new Array(4)}):a.target[y]=YM(m));return n};Go.add=v7;Go.addAll=x7;Go.cover=b7;Go.data=w7;Go.extent=T7;Go.find=S7;Go.remove=E7;Go.removeAll=A7;Go.root=I7;Go.size=M7;Go.visit=C7;Go.visitAfter=P7;Go.x=R7;Go.y=L7;function Hr(n){return function(){return n}}function Zc(n){return(n()-.5)*1e-6}function k7(n){return n.x+n.vx}function O7(n){return n.y+n.vy}function F7(n){var a,u,m,y=1,x=1;typeof n!="function"&&(n=Hr(n==null?1:+n));function E(){for(var M,L=a.length,V,k,j,te,J,Q,ee=0;ee<x;++ee)for(V=ux(a,k7,O7).visitAfter(r),M=0;M<L;++M)k=a[M],J=u[k.index],Q=J*J,j=k.x+k.vx,te=k.y+k.vy,V.visit(ue);function ue(ce,se,Ae,De,Qe){var nt=ce.data,rt=ce.r,tt=J+rt;if(nt){if(nt.index>k.index){var Be=j-nt.x-nt.vx,Rt=te-nt.y-nt.vy,ut=Be*Be+Rt*Rt;ut<tt*tt&&(Be===0&&(Be=Zc(m),ut+=Be*Be),Rt===0&&(Rt=Zc(m),ut+=Rt*Rt),ut=(tt-(ut=Math.sqrt(ut)))/ut*y,k.vx+=(Be*=ut)*(tt=(rt*=rt)/(Q+rt)),k.vy+=(Rt*=ut)*tt,nt.vx-=Be*(tt=1-tt),nt.vy-=Rt*tt)}return}return se>j+tt||De<j-tt||Ae>te+tt||Qe<te-tt}}function r(M){if(M.data)return M.r=u[M.data.index];for(var L=M.r=0;L<4;++L)M[L]&&M[L].r>M.r&&(M.r=M[L].r)}function P(){if(a){var M,L=a.length,V;for(u=new Array(L),M=0;M<L;++M)V=a[M],u[V.index]=+n(V,M,a)}}return E.initialize=function(M,L){a=M,m=L,P()},E.iterations=function(M){return arguments.length?(x=+M,E):x},E.strength=function(M){return arguments.length?(y=+M,E):y},E.radius=function(M){return arguments.length?(n=typeof M=="function"?M:Hr(+M),P(),E):n},E}function B7(n){return n.index}function KM(n,a){var u=n.get(a);if(!u)throw new Error("node not found: "+a);return u}function N7(n){var a=B7,u=V,m,y=Hr(30),x,E,r,P,M,L=1;n==null&&(n=[]);function V(Q){return 1/Math.min(r[Q.source.index],r[Q.target.index])}function k(Q){for(var ee=0,ue=n.length;ee<L;++ee)for(var ce=0,se,Ae,De,Qe,nt,rt,tt;ce<ue;++ce)se=n[ce],Ae=se.source,De=se.target,Qe=De.x+De.vx-Ae.x-Ae.vx||Zc(M),nt=De.y+De.vy-Ae.y-Ae.vy||Zc(M),rt=Math.sqrt(Qe*Qe+nt*nt),rt=(rt-x[ce])/rt*Q*m[ce],Qe*=rt,nt*=rt,De.vx-=Qe*(tt=P[ce]),De.vy-=nt*tt,Ae.vx+=Qe*(tt=1-tt),Ae.vy+=nt*tt}function j(){if(E){var Q,ee=E.length,ue=n.length,ce=new Map(E.map((Ae,De)=>[a(Ae,De,E),Ae])),se;for(Q=0,r=new Array(ee);Q<ue;++Q)se=n[Q],se.index=Q,typeof se.source!="object"&&(se.source=KM(ce,se.source)),typeof se.target!="object"&&(se.target=KM(ce,se.target)),r[se.source.index]=(r[se.source.index]||0)+1,r[se.target.index]=(r[se.target.index]||0)+1;for(Q=0,P=new Array(ue);Q<ue;++Q)se=n[Q],P[Q]=r[se.source.index]/(r[se.source.index]+r[se.target.index]);m=new Array(ue),te(),x=new Array(ue),J()}}function te(){if(E)for(var Q=0,ee=n.length;Q<ee;++Q)m[Q]=+u(n[Q],Q,n)}function J(){if(E)for(var Q=0,ee=n.length;Q<ee;++Q)x[Q]=+y(n[Q],Q,n)}return k.initialize=function(Q,ee){E=Q,M=ee,j()},k.links=function(Q){return arguments.length?(n=Q,j(),k):n},k.id=function(Q){return arguments.length?(a=Q,k):a},k.iterations=function(Q){return arguments.length?(L=+Q,k):L},k.strength=function(Q){return arguments.length?(u=typeof Q=="function"?Q:Hr(+Q),te(),k):u},k.distance=function(Q){return arguments.length?(y=typeof Q=="function"?Q:Hr(+Q),J(),k):y},k}const V7=1664525,U7=1013904223,JM=4294967296;function j7(){let n=1;return()=>(n=(V7*n+U7)%JM)/JM}function $7(n){return n.x}function G7(n){return n.y}var q7=10,H7=Math.PI*(3-Math.sqrt(5));function Z7(n){var a,u=1,m=.001,y=1-Math.pow(m,1/300),x=0,E=.6,r=new Map,P=sx(V),M=Rh("tick","end"),L=j7();n==null&&(n=[]);function V(){k(),M.call("tick",a),u<m&&(P.stop(),M.call("end",a))}function k(J){var Q,ee=n.length,ue;J===void 0&&(J=1);for(var ce=0;ce<J;++ce)for(u+=(x-u)*y,r.forEach(function(se){se(u)}),Q=0;Q<ee;++Q)ue=n[Q],ue.fx==null?ue.x+=ue.vx*=E:(ue.x=ue.fx,ue.vx=0),ue.fy==null?ue.y+=ue.vy*=E:(ue.y=ue.fy,ue.vy=0);return a}function j(){for(var J=0,Q=n.length,ee;J<Q;++J){if(ee=n[J],ee.index=J,ee.fx!=null&&(ee.x=ee.fx),ee.fy!=null&&(ee.y=ee.fy),isNaN(ee.x)||isNaN(ee.y)){var ue=q7*Math.sqrt(.5+J),ce=J*H7;ee.x=ue*Math.cos(ce),ee.y=ue*Math.sin(ce)}(isNaN(ee.vx)||isNaN(ee.vy))&&(ee.vx=ee.vy=0)}}function te(J){return J.initialize&&J.initialize(n,L),J}return j(),a={tick:k,restart:function(){return P.restart(V),a},stop:function(){return P.stop(),a},nodes:function(J){return arguments.length?(n=J,j(),r.forEach(te),a):n},alpha:function(J){return arguments.length?(u=+J,a):u},alphaMin:function(J){return arguments.length?(m=+J,a):m},alphaDecay:function(J){return arguments.length?(y=+J,a):+y},alphaTarget:function(J){return arguments.length?(x=+J,a):x},velocityDecay:function(J){return arguments.length?(E=1-J,a):1-E},randomSource:function(J){return arguments.length?(L=J,r.forEach(te),a):L},force:function(J,Q){return arguments.length>1?(Q==null?r.delete(J):r.set(J,te(Q)),a):r.get(J)},find:function(J,Q,ee){var ue=0,ce=n.length,se,Ae,De,Qe,nt;for(ee==null?ee=1/0:ee*=ee,ue=0;ue<ce;++ue)Qe=n[ue],se=J-Qe.x,Ae=Q-Qe.y,De=se*se+Ae*Ae,De<ee&&(nt=Qe,ee=De);return nt},on:function(J,Q){return arguments.length>1?(M.on(J,Q),a):M.on(J)}}}function W7(){var n,a,u,m,y=Hr(-30),x,E=1,r=1/0,P=.81;function M(j){var te,J=n.length,Q=ux(n,$7,G7).visitAfter(V);for(m=j,te=0;te<J;++te)a=n[te],Q.visit(k)}function L(){if(n){var j,te=n.length,J;for(x=new Array(te),j=0;j<te;++j)J=n[j],x[J.index]=+y(J,j,n)}}function V(j){var te=0,J,Q,ee=0,ue,ce,se;if(j.length){for(ue=ce=se=0;se<4;++se)(J=j[se])&&(Q=Math.abs(J.value))&&(te+=J.value,ee+=Q,ue+=Q*J.x,ce+=Q*J.y);j.x=ue/ee,j.y=ce/ee}else{J=j,J.x=J.data.x,J.y=J.data.y;do te+=x[J.data.index];while(J=J.next)}j.value=te}function k(j,te,J,Q){if(!j.value)return!0;var ee=j.x-a.x,ue=j.y-a.y,ce=Q-te,se=ee*ee+ue*ue;if(ce*ce/P<se)return se<r&&(ee===0&&(ee=Zc(u),se+=ee*ee),ue===0&&(ue=Zc(u),se+=ue*ue),se<E&&(se=Math.sqrt(E*se)),a.vx+=ee*j.value*m/se,a.vy+=ue*j.value*m/se),!0;if(j.length||se>=r)return;(j.data!==a||j.next)&&(ee===0&&(ee=Zc(u),se+=ee*ee),ue===0&&(ue=Zc(u),se+=ue*ue),se<E&&(se=Math.sqrt(E*se)));do j.data!==a&&(ce=x[j.data.index]*m/se,a.vx+=ee*ce,a.vy+=ue*ce);while(j=j.next)}return M.initialize=function(j,te){n=j,u=te,L()},M.strength=function(j){return arguments.length?(y=typeof j=="function"?j:Hr(+j),L(),M):y},M.distanceMin=function(j){return arguments.length?(E=j*j,M):Math.sqrt(E)},M.distanceMax=function(j){return arguments.length?(r=j*j,M):Math.sqrt(r)},M.theta=function(j){return arguments.length?(P=j*j,M):Math.sqrt(P)},M}function X7(n,a,u){var m,y=Hr(.1),x,E;typeof n!="function"&&(n=Hr(+n)),a==null&&(a=0),u==null&&(u=0);function r(M){for(var L=0,V=m.length;L<V;++L){var k=m[L],j=k.x-a||1e-6,te=k.y-u||1e-6,J=Math.sqrt(j*j+te*te),Q=(E[L]-J)*x[L]*M/J;k.vx+=j*Q,k.vy+=te*Q}}function P(){if(m){var M,L=m.length;for(x=new Array(L),E=new Array(L),M=0;M<L;++M)E[M]=+n(m[M],M,m),x[M]=isNaN(E[M])?0:+y(m[M],M,m)}}return r.initialize=function(M){m=M,P()},r.strength=function(M){return arguments.length?(y=typeof M=="function"?M:Hr(+M),P(),r):y},r.radius=function(M){return arguments.length?(n=typeof M=="function"?M:Hr(+M),P(),r):n},r.x=function(M){return arguments.length?(a=+M,r):a},r.y=function(M){return arguments.length?(u=+M,r):u},r}function Y7(n){var a=Hr(.1),u,m,y;typeof n!="function"&&(n=Hr(n==null?0:+n));function x(r){for(var P=0,M=u.length,L;P<M;++P)L=u[P],L.vx+=(y[P]-L.x)*m[P]*r}function E(){if(u){var r,P=u.length;for(m=new Array(P),y=new Array(P),r=0;r<P;++r)m[r]=isNaN(y[r]=+n(u[r],r,u))?0:+a(u[r],r,u)}}return x.initialize=function(r){u=r,E()},x.strength=function(r){return arguments.length?(a=typeof r=="function"?r:Hr(+r),E(),x):a},x.x=function(r){return arguments.length?(n=typeof r=="function"?r:Hr(+r),E(),x):n},x}function K7(n){var a=Hr(.1),u,m,y;typeof n!="function"&&(n=Hr(n==null?0:+n));function x(r){for(var P=0,M=u.length,L;P<M;++P)L=u[P],L.vy+=(y[P]-L.y)*m[P]*r}function E(){if(u){var r,P=u.length;for(m=new Array(P),y=new Array(P),r=0;r<P;++r)m[r]=isNaN(y[r]=+n(u[r],r,u))?0:+a(u[r],r,u)}}return x.initialize=function(r){u=r,E()},x.strength=function(r){return arguments.length?(a=typeof r=="function"?r:Hr(+r),E(),x):a},x.y=function(r){return arguments.length?(n=typeof r=="function"?r:Hr(+r),E(),x):n},x}function J7(n){return Math.abs(n=Math.round(n))>=1e21?n.toLocaleString("en").replace(/,/g,""):n.toString(10)}function iv(n,a){if((u=(n=a?n.toExponential(a-1):n.toExponential()).indexOf("e"))<0)return null;var u,m=n.slice(0,u);return[m.length>1?m[0]+m.slice(2):m,+n.slice(u+1)]}function Dd(n){return n=iv(Math.abs(n)),n?n[1]:NaN}function Q7(n,a){return function(u,m){for(var y=u.length,x=[],E=0,r=n[0],P=0;y>0&&r>0&&(P+r+1>m&&(r=Math.max(1,m-P)),x.push(u.substring(y-=r,y+r)),!((P+=r+1)>m));)r=n[E=(E+1)%n.length];return x.reverse().join(a)}}function e9(n){return function(a){return a.replace(/[0-9]/g,function(u){return n[+u]})}}var t9=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Ld(n){if(!(a=t9.exec(n)))throw new Error("invalid format: "+n);var a;return new hx({fill:a[1],align:a[2],sign:a[3],symbol:a[4],zero:a[5],width:a[6],comma:a[7],precision:a[8]&&a[8].slice(1),trim:a[9],type:a[10]})}Ld.prototype=hx.prototype;function hx(n){this.fill=n.fill===void 0?" ":n.fill+"",this.align=n.align===void 0?">":n.align+"",this.sign=n.sign===void 0?"-":n.sign+"",this.symbol=n.symbol===void 0?"":n.symbol+"",this.zero=!!n.zero,this.width=n.width===void 0?void 0:+n.width,this.comma=!!n.comma,this.precision=n.precision===void 0?void 0:+n.precision,this.trim=!!n.trim,this.type=n.type===void 0?"":n.type+""}hx.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function n9(n){e:for(var a=n.length,u=1,m=-1,y;u<a;++u)switch(n[u]){case".":m=y=u;break;case"0":m===0&&(m=u),y=u;break;default:if(!+n[u])break e;m>0&&(m=0);break}return m>0?n.slice(0,m)+n.slice(y+1):n}var Oz;function i9(n,a){var u=iv(n,a);if(!u)return n+"";var m=u[0],y=u[1],x=y-(Oz=Math.max(-8,Math.min(8,Math.floor(y/3)))*3)+1,E=m.length;return x===E?m:x>E?m+new Array(x-E+1).join("0"):x>0?m.slice(0,x)+"."+m.slice(x):"0."+new Array(1-x).join("0")+iv(n,Math.max(0,a+x-1))[0]}function QM(n,a){var u=iv(n,a);if(!u)return n+"";var m=u[0],y=u[1];return y<0?"0."+new Array(-y).join("0")+m:m.length>y+1?m.slice(0,y+1)+"."+m.slice(y+1):m+new Array(y-m.length+2).join("0")}const e3={"%":(n,a)=>(n*100).toFixed(a),b:n=>Math.round(n).toString(2),c:n=>n+"",d:J7,e:(n,a)=>n.toExponential(a),f:(n,a)=>n.toFixed(a),g:(n,a)=>n.toPrecision(a),o:n=>Math.round(n).toString(8),p:(n,a)=>QM(n*100,a),r:QM,s:i9,X:n=>Math.round(n).toString(16).toUpperCase(),x:n=>Math.round(n).toString(16)};function t3(n){return n}var n3=Array.prototype.map,i3=["y","z","a","f","p","n","Âµ","m","","k","M","G","T","P","E","Z","Y"];function Fz(n){var a=n.grouping===void 0||n.thousands===void 0?t3:Q7(n3.call(n.grouping,Number),n.thousands+""),u=n.currency===void 0?"":n.currency[0]+"",m=n.currency===void 0?"":n.currency[1]+"",y=n.decimal===void 0?".":n.decimal+"",x=n.numerals===void 0?t3:e9(n3.call(n.numerals,String)),E=n.percent===void 0?"%":n.percent+"",r=n.minus===void 0?"â":n.minus+"",P=n.nan===void 0?"NaN":n.nan+"";function M(V){V=Ld(V);var k=V.fill,j=V.align,te=V.sign,J=V.symbol,Q=V.zero,ee=V.width,ue=V.comma,ce=V.precision,se=V.trim,Ae=V.type;Ae==="n"?(ue=!0,Ae="g"):e3[Ae]||(ce===void 0&&(ce=12),se=!0,Ae="g"),(Q||k==="0"&&j==="=")&&(Q=!0,k="0",j="=");var De=J==="$"?u:J==="#"&&/[boxX]/.test(Ae)?"0"+Ae.toLowerCase():"",Qe=J==="$"?m:/[%p]/.test(Ae)?E:"",nt=e3[Ae],rt=/[defgprs%]/.test(Ae);ce=ce===void 0?6:/[gprs]/.test(Ae)?Math.max(1,Math.min(21,ce)):Math.max(0,Math.min(20,ce));function tt(Be){var Rt=De,ut=Qe,Pe,Ve,qe;if(Ae==="c")ut=nt(Be)+ut,Be="";else{Be=+Be;var bt=Be<0||1/Be<0;if(Be=isNaN(Be)?P:nt(Math.abs(Be),ce),se&&(Be=n9(Be)),bt&&+Be==0&&te!=="+"&&(bt=!1),Rt=(bt?te==="("?te:r:te==="-"||te==="("?"":te)+Rt,ut=(Ae==="s"?i3[8+Oz/3]:"")+ut+(bt&&te==="("?")":""),rt){for(Pe=-1,Ve=Be.length;++Pe<Ve;)if(qe=Be.charCodeAt(Pe),48>qe||qe>57){ut=(qe===46?y+Be.slice(Pe+1):Be.slice(Pe))+ut,Be=Be.slice(0,Pe);break}}}ue&&!Q&&(Be=a(Be,1/0));var Ht=Rt.length+Be.length+ut.length,Dt=Ht<ee?new Array(ee-Ht+1).join(k):"";switch(ue&&Q&&(Be=a(Dt+Be,Dt.length?ee-ut.length:1/0),Dt=""),j){case"<":Be=Rt+Be+ut+Dt;break;case"=":Be=Rt+Dt+Be+ut;break;case"^":Be=Dt.slice(0,Ht=Dt.length>>1)+Rt+Be+ut+Dt.slice(Ht);break;default:Be=Dt+Rt+Be+ut;break}return x(Be)}return tt.toString=function(){return V+""},tt}function L(V,k){var j=M((V=Ld(V),V.type="f",V)),te=Math.max(-8,Math.min(8,Math.floor(Dd(k)/3)))*3,J=Math.pow(10,-te),Q=i3[8+te/3];return function(ee){return j(J*ee)+Q}}return{format:M,formatPrefix:L}}var oy,fx,cT;Bz({thousands:",",grouping:[3],currency:["$",""]});function Bz(n){return oy=Fz(n),fx=oy.format,cT=oy.formatPrefix,oy}function Nz(n){return Math.max(0,-Dd(Math.abs(n)))}function Vz(n,a){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(Dd(a)/3)))*3-Dd(Math.abs(n)))}function Uz(n,a){return n=Math.abs(n),a=Math.abs(a)-n,Math.max(0,Dd(a)-Dd(n))+1}var Wn=1e-6,rv=1e-12,Li=Math.PI,Rr=Li/2,ov=Li/4,Uo=Li*2,ar=180/Li,qn=Li/180,Vi=Math.abs,Wd=Math.atan,jo=Math.atan2,Bn=Math.cos,sy=Math.ceil,jz=Math.exp,Yw=Math.hypot,sv=Math.log,iw=Math.pow,En=Math.sin,Fs=Math.sign||function(n){return n>0?1:n<0?-1:0},ro=Math.sqrt,uT=Math.tan;function $z(n){return n>1?0:n<-1?Li:Math.acos(n)}function $o(n){return n>1?Rr:n<-1?-Rr:Math.asin(n)}function r3(n){return(n=En(n/2))*n}function Ar(){}function av(n,a){n&&s3.hasOwnProperty(n.type)&&s3[n.type](n,a)}var o3={Feature:function(n,a){av(n.geometry,a)},FeatureCollection:function(n,a){for(var u=n.features,m=-1,y=u.length;++m<y;)av(u[m].geometry,a)}},s3={Sphere:function(n,a){a.sphere()},Point:function(n,a){n=n.coordinates,a.point(n[0],n[1],n[2])},MultiPoint:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)n=u[m],a.point(n[0],n[1],n[2])},LineString:function(n,a){Kw(n.coordinates,a,0)},MultiLineString:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)Kw(u[m],a,0)},Polygon:function(n,a){a3(n.coordinates,a)},MultiPolygon:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)a3(u[m],a)},GeometryCollection:function(n,a){for(var u=n.geometries,m=-1,y=u.length;++m<y;)av(u[m],a)}};function Kw(n,a,u){var m=-1,y=n.length-u,x;for(a.lineStart();++m<y;)x=n[m],a.point(x[0],x[1],x[2]);a.lineEnd()}function a3(n,a){var u=-1,m=n.length;for(a.polygonStart();++u<m;)Kw(n[u],a,1);a.polygonEnd()}function aa(n,a){n&&o3.hasOwnProperty(n.type)?o3[n.type](n,a):av(n,a)}var lv=new Zr,cv=new Zr,Gz,qz,Jw,Qw,e2,Ha={point:Ar,lineStart:Ar,lineEnd:Ar,polygonStart:function(){lv=new Zr,Ha.lineStart=r9,Ha.lineEnd=o9},polygonEnd:function(){var n=+lv;cv.add(n<0?Uo+n:n),this.lineStart=this.lineEnd=this.point=Ar},sphere:function(){cv.add(Uo)}};function r9(){Ha.point=s9}function o9(){Hz(Gz,qz)}function s9(n,a){Ha.point=Hz,Gz=n,qz=a,n*=qn,a*=qn,Jw=n,Qw=Bn(a=a/2+ov),e2=En(a)}function Hz(n,a){n*=qn,a*=qn,a=a/2+ov;var u=n-Jw,m=u>=0?1:-1,y=m*u,x=Bn(a),E=En(a),r=e2*E,P=Qw*x+r*Bn(y),M=r*m*En(y);lv.add(jo(M,P)),Jw=n,Qw=x,e2=E}function a9(n){return cv=new Zr,aa(n,Ha),cv*2}function uv(n){return[jo(n[1],n[0]),$o(n[2])]}function Ih(n){var a=n[0],u=n[1],m=Bn(u);return[m*Bn(a),m*En(a),En(u)]}function ay(n,a){return n[0]*a[0]+n[1]*a[1]+n[2]*a[2]}function kd(n,a){return[n[1]*a[2]-n[2]*a[1],n[2]*a[0]-n[0]*a[2],n[0]*a[1]-n[1]*a[0]]}function rw(n,a){n[0]+=a[0],n[1]+=a[1],n[2]+=a[2]}function ly(n,a){return[n[0]*a,n[1]*a,n[2]*a]}function hv(n){var a=ro(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=a,n[1]/=a,n[2]/=a}var Er,is,zr,vs,dh,Zz,Wz,Td,c_,Gc,ql,Fl={point:t2,lineStart:l3,lineEnd:c3,polygonStart:function(){Fl.point=Yz,Fl.lineStart=l9,Fl.lineEnd=c9,c_=new Zr,Ha.polygonStart()},polygonEnd:function(){Ha.polygonEnd(),Fl.point=t2,Fl.lineStart=l3,Fl.lineEnd=c3,lv<0?(Er=-(zr=180),is=-(vs=90)):c_>Wn?vs=90:c_<-1e-6&&(is=-90),ql[0]=Er,ql[1]=zr},sphere:function(){Er=-(zr=180),is=-(vs=90)}};function t2(n,a){Gc.push(ql=[Er=n,zr=n]),a<is&&(is=a),a>vs&&(vs=a)}function Xz(n,a){var u=Ih([n*qn,a*qn]);if(Td){var m=kd(Td,u),y=[m[1],-m[0],0],x=kd(y,m);hv(x),x=uv(x);var E=n-dh,r=E>0?1:-1,P=x[0]*ar*r,M,L=Vi(E)>180;L^(r*dh<P&&P<r*n)?(M=x[1]*ar,M>vs&&(vs=M)):(P=(P+360)%360-180,L^(r*dh<P&&P<r*n)?(M=-x[1]*ar,M<is&&(is=M)):(a<is&&(is=a),a>vs&&(vs=a))),L?n<dh?gs(Er,n)>gs(Er,zr)&&(zr=n):gs(n,zr)>gs(Er,zr)&&(Er=n):zr>=Er?(n<Er&&(Er=n),n>zr&&(zr=n)):n>dh?gs(Er,n)>gs(Er,zr)&&(zr=n):gs(n,zr)>gs(Er,zr)&&(Er=n)}else Gc.push(ql=[Er=n,zr=n]);a<is&&(is=a),a>vs&&(vs=a),Td=u,dh=n}function l3(){Fl.point=Xz}function c3(){ql[0]=Er,ql[1]=zr,Fl.point=t2,Td=null}function Yz(n,a){if(Td){var u=n-dh;c_.add(Vi(u)>180?u+(u>0?360:-360):u)}else Zz=n,Wz=a;Ha.point(n,a),Xz(n,a)}function l9(){Ha.lineStart()}function c9(){Yz(Zz,Wz),Ha.lineEnd(),Vi(c_)>Wn&&(Er=-(zr=180)),ql[0]=Er,ql[1]=zr,Td=null}function gs(n,a){return(a-=n)<0?a+360:a}function u9(n,a){return n[0]-a[0]}function u3(n,a){return n[0]<=n[1]?n[0]<=a&&a<=n[1]:a<n[0]||n[1]<a}function h9(n){var a,u,m,y,x,E,r;if(vs=zr=-(Er=is=1/0),Gc=[],aa(n,Fl),u=Gc.length){for(Gc.sort(u9),a=1,m=Gc[0],x=[m];a<u;++a)y=Gc[a],u3(m,y[0])||u3(m,y[1])?(gs(m[0],y[1])>gs(m[0],m[1])&&(m[1]=y[1]),gs(y[0],m[1])>gs(m[0],m[1])&&(m[0]=y[0])):x.push(m=y);for(E=-1/0,u=x.length-1,a=0,m=x[u];a<=u;m=y,++a)y=x[a],(r=gs(m[1],y[0]))>E&&(E=r,Er=y[0],zr=m[1])}return Gc=ql=null,Er===1/0||is===1/0?[[NaN,NaN],[NaN,NaN]]:[[Er,is],[zr,vs]]}var Qm,fv,dv,pv,mv,_v,gv,yv,n2,i2,r2,Kz,Jz,Do,Lo,ko,la={sphere:Ar,point:hT,lineStart:h3,lineEnd:f3,polygonStart:function(){la.lineStart=p9,la.lineEnd=m9},polygonEnd:function(){la.lineStart=h3,la.lineEnd=f3}};function hT(n,a){n*=qn,a*=qn;var u=Bn(a);$_(u*Bn(n),u*En(n),En(a))}function $_(n,a,u){++Qm,dv+=(n-dv)/Qm,pv+=(a-pv)/Qm,mv+=(u-mv)/Qm}function h3(){la.point=f9}function f9(n,a){n*=qn,a*=qn;var u=Bn(a);Do=u*Bn(n),Lo=u*En(n),ko=En(a),la.point=d9,$_(Do,Lo,ko)}function d9(n,a){n*=qn,a*=qn;var u=Bn(a),m=u*Bn(n),y=u*En(n),x=En(a),E=jo(ro((E=Lo*x-ko*y)*E+(E=ko*m-Do*x)*E+(E=Do*y-Lo*m)*E),Do*m+Lo*y+ko*x);fv+=E,_v+=E*(Do+(Do=m)),gv+=E*(Lo+(Lo=y)),yv+=E*(ko+(ko=x)),$_(Do,Lo,ko)}function f3(){la.point=hT}function p9(){la.point=_9}function m9(){Qz(Kz,Jz),la.point=hT}function _9(n,a){Kz=n,Jz=a,n*=qn,a*=qn,la.point=Qz;var u=Bn(a);Do=u*Bn(n),Lo=u*En(n),ko=En(a),$_(Do,Lo,ko)}function Qz(n,a){n*=qn,a*=qn;var u=Bn(a),m=u*Bn(n),y=u*En(n),x=En(a),E=Lo*x-ko*y,r=ko*m-Do*x,P=Do*y-Lo*m,M=Yw(E,r,P),L=$o(M),V=M&&-L/M;n2.add(V*E),i2.add(V*r),r2.add(V*P),fv+=L,_v+=L*(Do+(Do=m)),gv+=L*(Lo+(Lo=y)),yv+=L*(ko+(ko=x)),$_(Do,Lo,ko)}function g9(n){Qm=fv=dv=pv=mv=_v=gv=yv=0,n2=new Zr,i2=new Zr,r2=new Zr,aa(n,la);var a=+n2,u=+i2,m=+r2,y=Yw(a,u,m);return y<rv&&(a=_v,u=gv,m=yv,fv<Wn&&(a=dv,u=pv,m=mv),y=Yw(a,u,m),y<rv)?[NaN,NaN]:[jo(u,a)*ar,$o(m/y)*ar]}function dd(n){return function(){return n}}function o2(n,a){function u(m,y){return m=n(m,y),a(m[0],m[1])}return n.invert&&a.invert&&(u.invert=function(m,y){return m=a.invert(m,y),m&&n.invert(m[0],m[1])}),u}function s2(n,a){return Vi(n)>Li&&(n-=Math.round(n/Uo)*Uo),[n,a]}s2.invert=s2;function fT(n,a,u){return(n%=Uo)?a||u?o2(p3(n),m3(a,u)):p3(n):a||u?m3(a,u):s2}function d3(n){return function(a,u){return a+=n,Vi(a)>Li&&(a-=Math.round(a/Uo)*Uo),[a,u]}}function p3(n){var a=d3(n);return a.invert=d3(-n),a}function m3(n,a){var u=Bn(n),m=En(n),y=Bn(a),x=En(a);function E(r,P){var M=Bn(P),L=Bn(r)*M,V=En(r)*M,k=En(P),j=k*u+L*m;return[jo(V*y-j*x,L*u-k*m),$o(j*y+V*x)]}return E.invert=function(r,P){var M=Bn(P),L=Bn(r)*M,V=En(r)*M,k=En(P),j=k*y-V*x;return[jo(V*y+k*x,L*u+j*m),$o(j*u-L*m)]},E}function eR(n){n=fT(n[0]*qn,n[1]*qn,n.length>2?n[2]*qn:0);function a(u){return u=n(u[0]*qn,u[1]*qn),u[0]*=ar,u[1]*=ar,u}return a.invert=function(u){return u=n.invert(u[0]*qn,u[1]*qn),u[0]*=ar,u[1]*=ar,u},a}function tR(n,a,u,m,y,x){if(u){var E=Bn(a),r=En(a),P=m*u;y==null?(y=a+m*Uo,x=a-P/2):(y=_3(E,y),x=_3(E,x),(m>0?y<x:y>x)&&(y+=m*Uo));for(var M,L=y;m>0?L>x:L<x;L-=P)M=uv([E,-r*Bn(L),-r*En(L)]),n.point(M[0],M[1])}}function _3(n,a){a=Ih(a),a[0]-=n,hv(a);var u=$z(-a[1]);return((-a[2]<0?-u:u)+Uo-Wn)%Uo}function y9(){var n=dd([0,0]),a=dd(90),u=dd(2),m,y,x={point:E};function E(P,M){m.push(P=y(P,M)),P[0]*=ar,P[1]*=ar}function r(){var P=n.apply(this,arguments),M=a.apply(this,arguments)*qn,L=u.apply(this,arguments)*qn;return m=[],y=fT(-P[0]*qn,-P[1]*qn,0).invert,tR(x,M,L,1),P={type:"Polygon",coordinates:[m]},m=y=null,P}return r.center=function(P){return arguments.length?(n=typeof P=="function"?P:dd([+P[0],+P[1]]),r):n},r.radius=function(P){return arguments.length?(a=typeof P=="function"?P:dd(+P),r):a},r.precision=function(P){return arguments.length?(u=typeof P=="function"?P:dd(+P),r):u},r}function nR(){var n=[],a;return{point:function(u,m,y){a.push([u,m,y])},lineStart:function(){n.push(a=[])},lineEnd:Ar,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var u=n;return n=[],a=null,u}}}function Cy(n,a){return Vi(n[0]-a[0])<Wn&&Vi(n[1]-a[1])<Wn}function cy(n,a,u,m){this.x=n,this.z=a,this.o=u,this.e=m,this.v=!1,this.n=this.p=null}function iR(n,a,u,m,y){var x=[],E=[],r,P;if(n.forEach(function(te){if(!((J=te.length-1)<=0)){var J,Q=te[0],ee=te[J],ue;if(Cy(Q,ee)){if(!Q[2]&&!ee[2]){for(y.lineStart(),r=0;r<J;++r)y.point((Q=te[r])[0],Q[1]);y.lineEnd();return}ee[0]+=2*Wn}x.push(ue=new cy(Q,te,null,!0)),E.push(ue.o=new cy(Q,null,ue,!1)),x.push(ue=new cy(ee,te,null,!1)),E.push(ue.o=new cy(ee,null,ue,!0))}}),!!x.length){for(E.sort(a),g3(x),g3(E),r=0,P=E.length;r<P;++r)E[r].e=u=!u;for(var M=x[0],L,V;;){for(var k=M,j=!0;k.v;)if((k=k.n)===M)return;L=k.z,y.lineStart();do{if(k.v=k.o.v=!0,k.e){if(j)for(r=0,P=L.length;r<P;++r)y.point((V=L[r])[0],V[1]);else m(k.x,k.n.x,1,y);k=k.n}else{if(j)for(L=k.p.z,r=L.length-1;r>=0;--r)y.point((V=L[r])[0],V[1]);else m(k.x,k.p.x,-1,y);k=k.p}k=k.o,L=k.z,j=!j}while(!k.v);y.lineEnd()}}}function g3(n){if(a=n.length){for(var a,u=0,m=n[0],y;++u<a;)m.n=y=n[u],y.p=m,m=y;m.n=y=n[0],y.p=m}}function ow(n){return Vi(n[0])<=Li?n[0]:Fs(n[0])*((Vi(n[0])+Li)%Uo-Li)}function rR(n,a){var u=ow(a),m=a[1],y=En(m),x=[En(u),-Bn(u),0],E=0,r=0,P=new Zr;y===1?m=Rr+Wn:y===-1&&(m=-Rr-Wn);for(var M=0,L=n.length;M<L;++M)if(k=(V=n[M]).length)for(var V,k,j=V[k-1],te=ow(j),J=j[1]/2+ov,Q=En(J),ee=Bn(J),ue=0;ue<k;++ue,te=se,Q=De,ee=Qe,j=ce){var ce=V[ue],se=ow(ce),Ae=ce[1]/2+ov,De=En(Ae),Qe=Bn(Ae),nt=se-te,rt=nt>=0?1:-1,tt=rt*nt,Be=tt>Li,Rt=Q*De;if(P.add(jo(Rt*rt*En(tt),ee*Qe+Rt*Bn(tt))),E+=Be?nt+rt*Uo:nt,Be^te>=u^se>=u){var ut=kd(Ih(j),Ih(ce));hv(ut);var Pe=kd(x,ut);hv(Pe);var Ve=(Be^nt>=0?-1:1)*$o(Pe[2]);(m>Ve||m===Ve&&(ut[0]||ut[1]))&&(r+=Be^nt>=0?1:-1)}}return(E<-1e-6||E<Wn&&P<-1e-12)^r&1}function oR(n,a,u,m){return function(y){var x=a(y),E=nR(),r=a(E),P=!1,M,L,V,k={point:j,lineStart:J,lineEnd:Q,polygonStart:function(){k.point=ee,k.lineStart=ue,k.lineEnd=ce,L=[],M=[]},polygonEnd:function(){k.point=j,k.lineStart=J,k.lineEnd=Q,L=V2(L);var se=rR(M,m);L.length?(P||(y.polygonStart(),P=!0),iR(L,x9,se,u,y)):se&&(P||(y.polygonStart(),P=!0),y.lineStart(),u(null,null,1,y),y.lineEnd()),P&&(y.polygonEnd(),P=!1),L=M=null},sphere:function(){y.polygonStart(),y.lineStart(),u(null,null,1,y),y.lineEnd(),y.polygonEnd()}};function j(se,Ae){n(se,Ae)&&y.point(se,Ae)}function te(se,Ae){x.point(se,Ae)}function J(){k.point=te,x.lineStart()}function Q(){k.point=j,x.lineEnd()}function ee(se,Ae){V.push([se,Ae]),r.point(se,Ae)}function ue(){r.lineStart(),V=[]}function ce(){ee(V[0][0],V[0][1]),r.lineEnd();var se=r.clean(),Ae=E.result(),De,Qe=Ae.length,nt,rt,tt;if(V.pop(),M.push(V),V=null,!!Qe){if(se&1){if(rt=Ae[0],(nt=rt.length-1)>0){for(P||(y.polygonStart(),P=!0),y.lineStart(),De=0;De<nt;++De)y.point((tt=rt[De])[0],tt[1]);y.lineEnd()}return}Qe>1&&se&2&&Ae.push(Ae.pop().concat(Ae.shift())),L.push(Ae.filter(v9))}}return k}}function v9(n){return n.length>1}function x9(n,a){return((n=n.x)[0]<0?n[1]-Rr-Wn:Rr-n[1])-((a=a.x)[0]<0?a[1]-Rr-Wn:Rr-a[1])}const a2=oR(function(){return!0},b9,T9,[-Li,-Rr]);function b9(n){var a=NaN,u=NaN,m=NaN,y;return{lineStart:function(){n.lineStart(),y=1},point:function(x,E){var r=x>0?Li:-Li,P=Vi(x-a);Vi(P-Li)<Wn?(n.point(a,u=(u+E)/2>0?Rr:-Rr),n.point(m,u),n.lineEnd(),n.lineStart(),n.point(r,u),n.point(x,u),y=0):m!==r&&P>=Li&&(Vi(a-m)<Wn&&(a-=m*Wn),Vi(x-r)<Wn&&(x-=r*Wn),u=w9(a,u,x,E),n.point(m,u),n.lineEnd(),n.lineStart(),n.point(r,u),y=0),n.point(a=x,u=E),m=r},lineEnd:function(){n.lineEnd(),a=u=NaN},clean:function(){return 2-y}}}function w9(n,a,u,m){var y,x,E=En(n-u);return Vi(E)>Wn?Wd((En(a)*(x=Bn(m))*En(u)-En(m)*(y=Bn(a))*En(n))/(y*x*E)):(a+m)/2}function T9(n,a,u,m){var y;if(n==null)y=u*Rr,m.point(-Li,y),m.point(0,y),m.point(Li,y),m.point(Li,0),m.point(Li,-y),m.point(0,-y),m.point(-Li,-y),m.point(-Li,0),m.point(-Li,y);else if(Vi(n[0]-a[0])>Wn){var x=n[0]<a[0]?Li:-Li;y=u*x/2,m.point(-x,y),m.point(0,y),m.point(x,y)}else m.point(a[0],a[1])}function sR(n){var a=Bn(n),u=2*qn,m=a>0,y=Vi(a)>Wn;function x(L,V,k,j){tR(j,n,u,k,L,V)}function E(L,V){return Bn(L)*Bn(V)>a}function r(L){var V,k,j,te,J;return{lineStart:function(){te=j=!1,J=1},point:function(Q,ee){var ue=[Q,ee],ce,se=E(Q,ee),Ae=m?se?0:M(Q,ee):se?M(Q+(Q<0?Li:-Li),ee):0;if(!V&&(te=j=se)&&L.lineStart(),se!==j&&(ce=P(V,ue),(!ce||Cy(V,ce)||Cy(ue,ce))&&(ue[2]=1)),se!==j)J=0,se?(L.lineStart(),ce=P(ue,V),L.point(ce[0],ce[1])):(ce=P(V,ue),L.point(ce[0],ce[1],2),L.lineEnd()),V=ce;else if(y&&V&&m^se){var De;!(Ae&k)&&(De=P(ue,V,!0))&&(J=0,m?(L.lineStart(),L.point(De[0][0],De[0][1]),L.point(De[1][0],De[1][1]),L.lineEnd()):(L.point(De[1][0],De[1][1]),L.lineEnd(),L.lineStart(),L.point(De[0][0],De[0][1],3)))}se&&(!V||!Cy(V,ue))&&L.point(ue[0],ue[1]),V=ue,j=se,k=Ae},lineEnd:function(){j&&L.lineEnd(),V=null},clean:function(){return J|(te&&j)<<1}}}function P(L,V,k){var j=Ih(L),te=Ih(V),J=[1,0,0],Q=kd(j,te),ee=ay(Q,Q),ue=Q[0],ce=ee-ue*ue;if(!ce)return!k&&L;var se=a*ee/ce,Ae=-a*ue/ce,De=kd(J,Q),Qe=ly(J,se),nt=ly(Q,Ae);rw(Qe,nt);var rt=De,tt=ay(Qe,rt),Be=ay(rt,rt),Rt=tt*tt-Be*(ay(Qe,Qe)-1);if(!(Rt<0)){var ut=ro(Rt),Pe=ly(rt,(-tt-ut)/Be);if(rw(Pe,Qe),Pe=uv(Pe),!k)return Pe;var Ve=L[0],qe=V[0],bt=L[1],Ht=V[1],Dt;qe<Ve&&(Dt=Ve,Ve=qe,qe=Dt);var Lt=qe-Ve,rn=Vi(Lt-Li)<Wn,yn=rn||Lt<Wn;if(!rn&&Ht<bt&&(Dt=bt,bt=Ht,Ht=Dt),yn?rn?bt+Ht>0^Pe[1]<(Vi(Pe[0]-Ve)<Wn?bt:Ht):bt<=Pe[1]&&Pe[1]<=Ht:Lt>Li^(Ve<=Pe[0]&&Pe[0]<=qe)){var pi=ly(rt,(-tt+ut)/Be);return rw(pi,Qe),[Pe,uv(pi)]}}}function M(L,V){var k=m?n:Li-n,j=0;return L<-k?j|=1:L>k&&(j|=2),V<-k?j|=4:V>k&&(j|=8),j}return oR(E,r,x,m?[0,-n]:[-Li,n-Li])}function S9(n,a,u,m,y,x){var E=n[0],r=n[1],P=a[0],M=a[1],L=0,V=1,k=P-E,j=M-r,te;if(te=u-E,!(!k&&te>0)){if(te/=k,k<0){if(te<L)return;te<V&&(V=te)}else if(k>0){if(te>V)return;te>L&&(L=te)}if(te=y-E,!(!k&&te<0)){if(te/=k,k<0){if(te>V)return;te>L&&(L=te)}else if(k>0){if(te<L)return;te<V&&(V=te)}if(te=m-r,!(!j&&te>0)){if(te/=j,j<0){if(te<L)return;te<V&&(V=te)}else if(j>0){if(te>V)return;te>L&&(L=te)}if(te=x-r,!(!j&&te<0)){if(te/=j,j<0){if(te>V)return;te>L&&(L=te)}else if(j>0){if(te<L)return;te<V&&(V=te)}return L>0&&(n[0]=E+L*k,n[1]=r+L*j),V<1&&(a[0]=E+V*k,a[1]=r+V*j),!0}}}}}var uy=1e9,hy=-1e9;function dx(n,a,u,m){function y(M,L){return n<=M&&M<=u&&a<=L&&L<=m}function x(M,L,V,k){var j=0,te=0;if(M==null||(j=E(M,V))!==(te=E(L,V))||P(M,L)<0^V>0)do k.point(j===0||j===3?n:u,j>1?m:a);while((j=(j+V+4)%4)!==te);else k.point(L[0],L[1])}function E(M,L){return Vi(M[0]-n)<Wn?L>0?0:3:Vi(M[0]-u)<Wn?L>0?2:1:Vi(M[1]-a)<Wn?L>0?1:0:L>0?3:2}function r(M,L){return P(M.x,L.x)}function P(M,L){var V=E(M,1),k=E(L,1);return V!==k?V-k:V===0?L[1]-M[1]:V===1?M[0]-L[0]:V===2?M[1]-L[1]:L[0]-M[0]}return function(M){var L=M,V=nR(),k,j,te,J,Q,ee,ue,ce,se,Ae,De,Qe={point:nt,lineStart:Rt,lineEnd:ut,polygonStart:tt,polygonEnd:Be};function nt(Ve,qe){y(Ve,qe)&&L.point(Ve,qe)}function rt(){for(var Ve=0,qe=0,bt=j.length;qe<bt;++qe)for(var Ht=j[qe],Dt=1,Lt=Ht.length,rn=Ht[0],yn,pi,ti=rn[0],hn=rn[1];Dt<Lt;++Dt)yn=ti,pi=hn,rn=Ht[Dt],ti=rn[0],hn=rn[1],pi<=m?hn>m&&(ti-yn)*(m-pi)>(hn-pi)*(n-yn)&&++Ve:hn<=m&&(ti-yn)*(m-pi)<(hn-pi)*(n-yn)&&--Ve;return Ve}function tt(){L=V,k=[],j=[],De=!0}function Be(){var Ve=rt(),qe=De&&Ve,bt=(k=V2(k)).length;(qe||bt)&&(M.polygonStart(),qe&&(M.lineStart(),x(null,null,1,M),M.lineEnd()),bt&&iR(k,r,Ve,x,M),M.polygonEnd()),L=M,k=j=te=null}function Rt(){Qe.point=Pe,j&&j.push(te=[]),Ae=!0,se=!1,ue=ce=NaN}function ut(){k&&(Pe(J,Q),ee&&se&&V.rejoin(),k.push(V.result())),Qe.point=nt,se&&L.lineEnd()}function Pe(Ve,qe){var bt=y(Ve,qe);if(j&&te.push([Ve,qe]),Ae)J=Ve,Q=qe,ee=bt,Ae=!1,bt&&(L.lineStart(),L.point(Ve,qe));else if(bt&&se)L.point(Ve,qe);else{var Ht=[ue=Math.max(hy,Math.min(uy,ue)),ce=Math.max(hy,Math.min(uy,ce))],Dt=[Ve=Math.max(hy,Math.min(uy,Ve)),qe=Math.max(hy,Math.min(uy,qe))];S9(Ht,Dt,n,a,u,m)?(se||(L.lineStart(),L.point(Ht[0],Ht[1])),L.point(Dt[0],Dt[1]),bt||L.lineEnd(),De=!1):bt&&(L.lineStart(),L.point(Ve,qe),De=!1)}ue=Ve,ce=qe,se=bt}return Qe}}function E9(){var n=0,a=0,u=960,m=500,y,x,E;return E={stream:function(r){return y&&x===r?y:y=dx(n,a,u,m)(x=r)},extent:function(r){return arguments.length?(n=+r[0][0],a=+r[0][1],u=+r[1][0],m=+r[1][1],y=x=null,E):[[n,a],[u,m]]}}}var l2,c2,Py,zy,Od={sphere:Ar,point:Ar,lineStart:A9,lineEnd:Ar,polygonStart:Ar,polygonEnd:Ar};function A9(){Od.point=M9,Od.lineEnd=I9}function I9(){Od.point=Od.lineEnd=Ar}function M9(n,a){n*=qn,a*=qn,c2=n,Py=En(a),zy=Bn(a),Od.point=C9}function C9(n,a){n*=qn,a*=qn;var u=En(a),m=Bn(a),y=Vi(n-c2),x=Bn(y),E=En(y),r=m*E,P=zy*u-Py*m*x,M=Py*u+zy*m*x;l2.add(jo(ro(r*r+P*P),M)),c2=n,Py=u,zy=m}function aR(n){return l2=new Zr,aa(n,Od),+l2}var u2=[null,null],P9={type:"LineString",coordinates:u2};function vv(n,a){return u2[0]=n,u2[1]=a,aR(P9)}var y3={Feature:function(n,a){return xv(n.geometry,a)},FeatureCollection:function(n,a){for(var u=n.features,m=-1,y=u.length;++m<y;)if(xv(u[m].geometry,a))return!0;return!1}},v3={Sphere:function(){return!0},Point:function(n,a){return x3(n.coordinates,a)},MultiPoint:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)if(x3(u[m],a))return!0;return!1},LineString:function(n,a){return b3(n.coordinates,a)},MultiLineString:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)if(b3(u[m],a))return!0;return!1},Polygon:function(n,a){return w3(n.coordinates,a)},MultiPolygon:function(n,a){for(var u=n.coordinates,m=-1,y=u.length;++m<y;)if(w3(u[m],a))return!0;return!1},GeometryCollection:function(n,a){for(var u=n.geometries,m=-1,y=u.length;++m<y;)if(xv(u[m],a))return!0;return!1}};function xv(n,a){return n&&v3.hasOwnProperty(n.type)?v3[n.type](n,a):!1}function x3(n,a){return vv(n,a)===0}function b3(n,a){for(var u,m,y,x=0,E=n.length;x<E;x++){if(m=vv(n[x],a),m===0||x>0&&(y=vv(n[x],n[x-1]),y>0&&u<=y&&m<=y&&(u+m-y)*(1-Math.pow((u-m)/y,2))<rv*y))return!0;u=m}return!1}function w3(n,a){return!!rR(n.map(z9),lR(a))}function z9(n){return n=n.map(lR),n.pop(),n}function lR(n){return[n[0]*qn,n[1]*qn]}function R9(n,a){return(n&&y3.hasOwnProperty(n.type)?y3[n.type]:xv)(n,a)}function T3(n,a,u){var m=Nl(n,a-Wn,u).concat(a);return function(y){return m.map(function(x){return[y,x]})}}function S3(n,a,u){var m=Nl(n,a-Wn,u).concat(a);return function(y){return m.map(function(x){return[x,y]})}}function cR(){var n,a,u,m,y,x,E,r,P=10,M=P,L=90,V=360,k,j,te,J,Q=2.5;function ee(){return{type:"MultiLineString",coordinates:ue()}}function ue(){return Nl(sy(m/L)*L,u,L).map(te).concat(Nl(sy(r/V)*V,E,V).map(J)).concat(Nl(sy(a/P)*P,n,P).filter(function(ce){return Vi(ce%L)>Wn}).map(k)).concat(Nl(sy(x/M)*M,y,M).filter(function(ce){return Vi(ce%V)>Wn}).map(j))}return ee.lines=function(){return ue().map(function(ce){return{type:"LineString",coordinates:ce}})},ee.outline=function(){return{type:"Polygon",coordinates:[te(m).concat(J(E).slice(1),te(u).reverse().slice(1),J(r).reverse().slice(1))]}},ee.extent=function(ce){return arguments.length?ee.extentMajor(ce).extentMinor(ce):ee.extentMinor()},ee.extentMajor=function(ce){return arguments.length?(m=+ce[0][0],u=+ce[1][0],r=+ce[0][1],E=+ce[1][1],m>u&&(ce=m,m=u,u=ce),r>E&&(ce=r,r=E,E=ce),ee.precision(Q)):[[m,r],[u,E]]},ee.extentMinor=function(ce){return arguments.length?(a=+ce[0][0],n=+ce[1][0],x=+ce[0][1],y=+ce[1][1],a>n&&(ce=a,a=n,n=ce),x>y&&(ce=x,x=y,y=ce),ee.precision(Q)):[[a,x],[n,y]]},ee.step=function(ce){return arguments.length?ee.stepMajor(ce).stepMinor(ce):ee.stepMinor()},ee.stepMajor=function(ce){return arguments.length?(L=+ce[0],V=+ce[1],ee):[L,V]},ee.stepMinor=function(ce){return arguments.length?(P=+ce[0],M=+ce[1],ee):[P,M]},ee.precision=function(ce){return arguments.length?(Q=+ce,k=T3(x,y,90),j=S3(a,n,Q),te=T3(r,E,90),J=S3(m,u,Q),ee):Q},ee.extentMajor([[-180,-90+Wn],[180,90-Wn]]).extentMinor([[-180,-80-Wn],[180,80+Wn]])}function D9(){return cR()()}function L9(n,a){var u=n[0]*qn,m=n[1]*qn,y=a[0]*qn,x=a[1]*qn,E=Bn(m),r=En(m),P=Bn(x),M=En(x),L=E*Bn(u),V=E*En(u),k=P*Bn(y),j=P*En(y),te=2*$o(ro(r3(x-m)+E*P*r3(y-u))),J=En(te),Q=te?function(ee){var ue=En(ee*=te)/J,ce=En(te-ee)/J,se=ce*L+ue*k,Ae=ce*V+ue*j,De=ce*r+ue*M;return[jo(Ae,se)*ar,jo(De,ro(se*se+Ae*Ae))*ar]}:function(){return[u*ar,m*ar]};return Q.distance=te,Q}const M_=n=>n;var sw=new Zr,h2=new Zr,uR,hR,f2,d2,Bl={point:Ar,lineStart:Ar,lineEnd:Ar,polygonStart:function(){Bl.lineStart=k9,Bl.lineEnd=F9},polygonEnd:function(){Bl.lineStart=Bl.lineEnd=Bl.point=Ar,sw.add(Vi(h2)),h2=new Zr},result:function(){var n=sw/2;return sw=new Zr,n}};function k9(){Bl.point=O9}function O9(n,a){Bl.point=fR,uR=f2=n,hR=d2=a}function fR(n,a){h2.add(d2*n-f2*a),f2=n,d2=a}function F9(){fR(uR,hR)}var Fd=1/0,bv=Fd,C_=-Fd,wv=C_,Tv={point:B9,lineStart:Ar,lineEnd:Ar,polygonStart:Ar,polygonEnd:Ar,result:function(){var n=[[Fd,bv],[C_,wv]];return C_=wv=-(bv=Fd=1/0),n}};function B9(n,a){n<Fd&&(Fd=n),n>C_&&(C_=n),a<bv&&(bv=a),a>wv&&(wv=a)}var p2=0,m2=0,e_=0,Sv=0,Ev=0,yd=0,_2=0,g2=0,t_=0,dR,pR,Ba,Na,Os={point:Mh,lineStart:E3,lineEnd:A3,polygonStart:function(){Os.lineStart=U9,Os.lineEnd=j9},polygonEnd:function(){Os.point=Mh,Os.lineStart=E3,Os.lineEnd=A3},result:function(){var n=t_?[_2/t_,g2/t_]:yd?[Sv/yd,Ev/yd]:e_?[p2/e_,m2/e_]:[NaN,NaN];return p2=m2=e_=Sv=Ev=yd=_2=g2=t_=0,n}};function Mh(n,a){p2+=n,m2+=a,++e_}function E3(){Os.point=N9}function N9(n,a){Os.point=V9,Mh(Ba=n,Na=a)}function V9(n,a){var u=n-Ba,m=a-Na,y=ro(u*u+m*m);Sv+=y*(Ba+n)/2,Ev+=y*(Na+a)/2,yd+=y,Mh(Ba=n,Na=a)}function A3(){Os.point=Mh}function U9(){Os.point=$9}function j9(){mR(dR,pR)}function $9(n,a){Os.point=mR,Mh(dR=Ba=n,pR=Na=a)}function mR(n,a){var u=n-Ba,m=a-Na,y=ro(u*u+m*m);Sv+=y*(Ba+n)/2,Ev+=y*(Na+a)/2,yd+=y,y=Na*n-Ba*a,_2+=y*(Ba+n),g2+=y*(Na+a),t_+=y*3,Mh(Ba=n,Na=a)}function _R(n){this._context=n}_R.prototype={_radius:4.5,pointRadius:function(n){return this._radius=n,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){this._line===0&&this._context.closePath(),this._point=NaN},point:function(n,a){switch(this._point){case 0:{this._context.moveTo(n,a),this._point=1;break}case 1:{this._context.lineTo(n,a);break}default:{this._context.moveTo(n+this._radius,a),this._context.arc(n,a,this._radius,0,Uo);break}}},result:Ar};var y2=new Zr,aw,gR,yR,n_,i_,P_={point:Ar,lineStart:function(){P_.point=G9},lineEnd:function(){aw&&vR(gR,yR),P_.point=Ar},polygonStart:function(){aw=!0},polygonEnd:function(){aw=null},result:function(){var n=+y2;return y2=new Zr,n}};function G9(n,a){P_.point=vR,gR=n_=n,yR=i_=a}function vR(n,a){n_-=n,i_-=a,y2.add(ro(n_*n_+i_*i_)),n_=n,i_=a}let I3,Av,M3,C3;class P3{constructor(a){this._append=a==null?xR:q9(a),this._radius=4.5,this._=""}pointRadius(a){return this._radius=+a,this}polygonStart(){this._line=0}polygonEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){this._line===0&&(this._+="Z"),this._point=NaN}point(a,u){switch(this._point){case 0:{this._append`M${a},${u}`,this._point=1;break}case 1:{this._append`L${a},${u}`;break}default:{if(this._append`M${a},${u}`,this._radius!==M3||this._append!==Av){const m=this._radius,y=this._;this._="",this._append`m0,${m}a${m},${m} 0 1,1 0,${-2*m}a${m},${m} 0 1,1 0,${2*m}z`,M3=m,Av=this._append,C3=this._,this._=y}this._+=C3;break}}}result(){const a=this._;return this._="",a.length?a:null}}function xR(n){let a=1;this._+=n[0];for(const u=n.length;a<u;++a)this._+=arguments[a]+n[a]}function q9(n){const a=Math.floor(n);if(!(a>=0))throw new RangeError(`invalid digits: ${n}`);if(a>15)return xR;if(a!==I3){const u=10**a;I3=a,Av=function(y){let x=1;this._+=y[0];for(const E=y.length;x<E;++x)this._+=Math.round(arguments[x]*u)/u+y[x]}}return Av}function H9(n,a){let u=3,m=4.5,y,x;function E(r){return r&&(typeof m=="function"&&x.pointRadius(+m.apply(this,arguments)),aa(r,y(x))),x.result()}return E.area=function(r){return aa(r,y(Bl)),Bl.result()},E.measure=function(r){return aa(r,y(P_)),P_.result()},E.bounds=function(r){return aa(r,y(Tv)),Tv.result()},E.centroid=function(r){return aa(r,y(Os)),Os.result()},E.projection=function(r){return arguments.length?(y=r==null?(n=null,M_):(n=r).stream,E):n},E.context=function(r){return arguments.length?(x=r==null?(a=null,new P3(u)):new _R(a=r),typeof m!="function"&&x.pointRadius(m),E):a},E.pointRadius=function(r){return arguments.length?(m=typeof r=="function"?r:(x.pointRadius(+r),+r),E):m},E.digits=function(r){if(!arguments.length)return u;if(r==null)u=null;else{const P=Math.floor(r);if(!(P>=0))throw new RangeError(`invalid digits: ${r}`);u=P}return a===null&&(x=new P3(u)),E},E.projection(n).digits(u).context(a)}function Z9(n){return{stream:G_(n)}}function G_(n){return function(a){var u=new v2;for(var m in n)u[m]=n[m];return u.stream=a,u}}function v2(){}v2.prototype={constructor:v2,point:function(n,a){this.stream.point(n,a)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function dT(n,a,u){var m=n.clipExtent&&n.clipExtent();return n.scale(150).translate([0,0]),m!=null&&n.clipExtent(null),aa(u,n.stream(Tv)),a(Tv.result()),m!=null&&n.clipExtent(m),n}function px(n,a,u){return dT(n,function(m){var y=a[1][0]-a[0][0],x=a[1][1]-a[0][1],E=Math.min(y/(m[1][0]-m[0][0]),x/(m[1][1]-m[0][1])),r=+a[0][0]+(y-E*(m[1][0]+m[0][0]))/2,P=+a[0][1]+(x-E*(m[1][1]+m[0][1]))/2;n.scale(150*E).translate([r,P])},u)}function pT(n,a,u){return px(n,[[0,0],a],u)}function mT(n,a,u){return dT(n,function(m){var y=+a,x=y/(m[1][0]-m[0][0]),E=(y-x*(m[1][0]+m[0][0]))/2,r=-x*m[0][1];n.scale(150*x).translate([E,r])},u)}function _T(n,a,u){return dT(n,function(m){var y=+a,x=y/(m[1][1]-m[0][1]),E=-x*m[0][0],r=(y-x*(m[1][1]+m[0][1]))/2;n.scale(150*x).translate([E,r])},u)}var z3=16,W9=Bn(30*qn);function R3(n,a){return+a?Y9(n,a):X9(n)}function X9(n){return G_({point:function(a,u){a=n(a,u),this.stream.point(a[0],a[1])}})}function Y9(n,a){function u(m,y,x,E,r,P,M,L,V,k,j,te,J,Q){var ee=M-m,ue=L-y,ce=ee*ee+ue*ue;if(ce>4*a&&J--){var se=E+k,Ae=r+j,De=P+te,Qe=ro(se*se+Ae*Ae+De*De),nt=$o(De/=Qe),rt=Vi(Vi(De)-1)<Wn||Vi(x-V)<Wn?(x+V)/2:jo(Ae,se),tt=n(rt,nt),Be=tt[0],Rt=tt[1],ut=Be-m,Pe=Rt-y,Ve=ue*ut-ee*Pe;(Ve*Ve/ce>a||Vi((ee*ut+ue*Pe)/ce-.5)>.3||E*k+r*j+P*te<W9)&&(u(m,y,x,E,r,P,Be,Rt,rt,se/=Qe,Ae/=Qe,De,J,Q),Q.point(Be,Rt),u(Be,Rt,rt,se,Ae,De,M,L,V,k,j,te,J,Q))}}return function(m){var y,x,E,r,P,M,L,V,k,j,te,J,Q={point:ee,lineStart:ue,lineEnd:se,polygonStart:function(){m.polygonStart(),Q.lineStart=Ae},polygonEnd:function(){m.polygonEnd(),Q.lineStart=ue}};function ee(nt,rt){nt=n(nt,rt),m.point(nt[0],nt[1])}function ue(){V=NaN,Q.point=ce,m.lineStart()}function ce(nt,rt){var tt=Ih([nt,rt]),Be=n(nt,rt);u(V,k,L,j,te,J,V=Be[0],k=Be[1],L=nt,j=tt[0],te=tt[1],J=tt[2],z3,m),m.point(V,k)}function se(){Q.point=ee,m.lineEnd()}function Ae(){ue(),Q.point=De,Q.lineEnd=Qe}function De(nt,rt){ce(y=nt,rt),x=V,E=k,r=j,P=te,M=J,Q.point=ce}function Qe(){u(V,k,L,j,te,J,x,E,y,r,P,M,z3,m),Q.lineEnd=se,se()}return Q}}var K9=G_({point:function(n,a){this.stream.point(n*qn,a*qn)}});function J9(n){return G_({point:function(a,u){var m=n(a,u);return this.stream.point(m[0],m[1])}})}function Q9(n,a,u,m,y){function x(E,r){return E*=m,r*=y,[a+n*E,u-n*r]}return x.invert=function(E,r){return[(E-a)/n*m,(u-r)/n*y]},x}function D3(n,a,u,m,y,x){if(!x)return Q9(n,a,u,m,y);var E=Bn(x),r=En(x),P=E*n,M=r*n,L=E/n,V=r/n,k=(r*u-E*a)/n,j=(r*a+E*u)/n;function te(J,Q){return J*=m,Q*=y,[P*J-M*Q+a,u-M*J-P*Q]}return te.invert=function(J,Q){return[m*(L*J-V*Q+k),y*(j-V*J-L*Q)]},te}function Ya(n){return gT(function(){return n})()}function gT(n){var a,u=150,m=480,y=250,x=0,E=0,r=0,P=0,M=0,L,V=0,k=1,j=1,te=null,J=a2,Q=null,ee,ue,ce,se=M_,Ae=.5,De,Qe,nt,rt,tt;function Be(Ve){return nt(Ve[0]*qn,Ve[1]*qn)}function Rt(Ve){return Ve=nt.invert(Ve[0],Ve[1]),Ve&&[Ve[0]*ar,Ve[1]*ar]}Be.stream=function(Ve){return rt&&tt===Ve?rt:rt=K9(J9(L)(J(De(se(tt=Ve)))))},Be.preclip=function(Ve){return arguments.length?(J=Ve,te=void 0,Pe()):J},Be.postclip=function(Ve){return arguments.length?(se=Ve,Q=ee=ue=ce=null,Pe()):se},Be.clipAngle=function(Ve){return arguments.length?(J=+Ve?sR(te=Ve*qn):(te=null,a2),Pe()):te*ar},Be.clipExtent=function(Ve){return arguments.length?(se=Ve==null?(Q=ee=ue=ce=null,M_):dx(Q=+Ve[0][0],ee=+Ve[0][1],ue=+Ve[1][0],ce=+Ve[1][1]),Pe()):Q==null?null:[[Q,ee],[ue,ce]]},Be.scale=function(Ve){return arguments.length?(u=+Ve,ut()):u},Be.translate=function(Ve){return arguments.length?(m=+Ve[0],y=+Ve[1],ut()):[m,y]},Be.center=function(Ve){return arguments.length?(x=Ve[0]%360*qn,E=Ve[1]%360*qn,ut()):[x*ar,E*ar]},Be.rotate=function(Ve){return arguments.length?(r=Ve[0]%360*qn,P=Ve[1]%360*qn,M=Ve.length>2?Ve[2]%360*qn:0,ut()):[r*ar,P*ar,M*ar]},Be.angle=function(Ve){return arguments.length?(V=Ve%360*qn,ut()):V*ar},Be.reflectX=function(Ve){return arguments.length?(k=Ve?-1:1,ut()):k<0},Be.reflectY=function(Ve){return arguments.length?(j=Ve?-1:1,ut()):j<0},Be.precision=function(Ve){return arguments.length?(De=R3(Qe,Ae=Ve*Ve),Pe()):ro(Ae)},Be.fitExtent=function(Ve,qe){return px(Be,Ve,qe)},Be.fitSize=function(Ve,qe){return pT(Be,Ve,qe)},Be.fitWidth=function(Ve,qe){return mT(Be,Ve,qe)},Be.fitHeight=function(Ve,qe){return _T(Be,Ve,qe)};function ut(){var Ve=D3(u,0,0,k,j,V).apply(null,a(x,E)),qe=D3(u,m-Ve[0],y-Ve[1],k,j,V);return L=fT(r,P,M),Qe=o2(a,qe),nt=o2(L,Qe),De=R3(Qe,Ae),Pe()}function Pe(){return rt=tt=null,Be}return function(){return a=n.apply(this,arguments),Be.invert=a.invert&&Rt,ut()}}function yT(n){var a=0,u=Li/3,m=gT(n),y=m(a,u);return y.parallels=function(x){return arguments.length?m(a=x[0]*qn,u=x[1]*qn):[a*ar,u*ar]},y}function ej(n){var a=Bn(n);function u(m,y){return[m*a,En(y)/a]}return u.invert=function(m,y){return[m/a,$o(y*a)]},u}function bR(n,a){var u=En(n),m=(u+En(a))/2;if(Vi(m)<Wn)return ej(n);var y=1+u*(2*m-u),x=ro(y)/m;function E(r,P){var M=ro(y-2*m*En(P))/m;return[M*En(r*=m),x-M*Bn(r)]}return E.invert=function(r,P){var M=x-P,L=jo(r,Vi(M))*Fs(M);return M*m<0&&(L-=Li*Fs(r)*Fs(M)),[L/m,$o((y-(r*r+M*M)*m*m)/(2*m))]},E}function Iv(){return yT(bR).scale(155.424).center([0,33.6442])}function wR(){return Iv().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}function tj(n){var a=n.length;return{point:function(u,m){for(var y=-1;++y<a;)n[y].point(u,m)},sphere:function(){for(var u=-1;++u<a;)n[u].sphere()},lineStart:function(){for(var u=-1;++u<a;)n[u].lineStart()},lineEnd:function(){for(var u=-1;++u<a;)n[u].lineEnd()},polygonStart:function(){for(var u=-1;++u<a;)n[u].polygonStart()},polygonEnd:function(){for(var u=-1;++u<a;)n[u].polygonEnd()}}}function nj(){var n,a,u=wR(),m,y=Iv().rotate([154,0]).center([-2,58.5]).parallels([55,65]),x,E=Iv().rotate([157,0]).center([-3,19.9]).parallels([8,18]),r,P,M={point:function(k,j){P=[k,j]}};function L(k){var j=k[0],te=k[1];return P=null,m.point(j,te),P||(x.point(j,te),P)||(r.point(j,te),P)}L.invert=function(k){var j=u.scale(),te=u.translate(),J=(k[0]-te[0])/j,Q=(k[1]-te[1])/j;return(Q>=.12&&Q<.234&&J>=-.425&&J<-.214?y:Q>=.166&&Q<.234&&J>=-.214&&J<-.115?E:u).invert(k)},L.stream=function(k){return n&&a===k?n:n=tj([u.stream(a=k),y.stream(k),E.stream(k)])},L.precision=function(k){return arguments.length?(u.precision(k),y.precision(k),E.precision(k),V()):u.precision()},L.scale=function(k){return arguments.length?(u.scale(k),y.scale(k*.35),E.scale(k),L.translate(u.translate())):u.scale()},L.translate=function(k){if(!arguments.length)return u.translate();var j=u.scale(),te=+k[0],J=+k[1];return m=u.translate(k).clipExtent([[te-.455*j,J-.238*j],[te+.455*j,J+.238*j]]).stream(M),x=y.translate([te-.307*j,J+.201*j]).clipExtent([[te-.425*j+Wn,J+.12*j+Wn],[te-.214*j-Wn,J+.234*j-Wn]]).stream(M),r=E.translate([te-.205*j,J+.212*j]).clipExtent([[te-.214*j+Wn,J+.166*j+Wn],[te-.115*j-Wn,J+.234*j-Wn]]).stream(M),V()},L.fitExtent=function(k,j){return px(L,k,j)},L.fitSize=function(k,j){return pT(L,k,j)},L.fitWidth=function(k,j){return mT(L,k,j)},L.fitHeight=function(k,j){return _T(L,k,j)};function V(){return n=a=null,L}return L.scale(1070)}function TR(n){return function(a,u){var m=Bn(a),y=Bn(u),x=n(m*y);return x===1/0?[2,0]:[x*y*En(a),x*En(u)]}}function q_(n){return function(a,u){var m=ro(a*a+u*u),y=n(m),x=En(y),E=Bn(y);return[jo(a*x,m*E),$o(m&&u*x/m)]}}var vT=TR(function(n){return ro(2/(1+n))});vT.invert=q_(function(n){return 2*$o(n/2)});function ij(){return Ya(vT).scale(124.75).clipAngle(180-.001)}var xT=TR(function(n){return(n=$z(n))&&n/En(n)});xT.invert=q_(function(n){return n});function rj(){return Ya(xT).scale(79.4188).clipAngle(180-.001)}function H_(n,a){return[n,sv(uT((Rr+a)/2))]}H_.invert=function(n,a){return[n,2*Wd(jz(a))-Rr]};function oj(){return SR(H_).scale(961/Uo)}function SR(n){var a=Ya(n),u=a.center,m=a.scale,y=a.translate,x=a.clipExtent,E=null,r,P,M;a.scale=function(V){return arguments.length?(m(V),L()):m()},a.translate=function(V){return arguments.length?(y(V),L()):y()},a.center=function(V){return arguments.length?(u(V),L()):u()},a.clipExtent=function(V){return arguments.length?(V==null?E=r=P=M=null:(E=+V[0][0],r=+V[0][1],P=+V[1][0],M=+V[1][1]),L()):E==null?null:[[E,r],[P,M]]};function L(){var V=Li*m(),k=a(eR(a.rotate()).invert([0,0]));return x(E==null?[[k[0]-V,k[1]-V],[k[0]+V,k[1]+V]]:n===H_?[[Math.max(k[0]-V,E),r],[Math.min(k[0]+V,P),M]]:[[E,Math.max(k[1]-V,r)],[P,Math.min(k[1]+V,M)]])}return L()}function fy(n){return uT((Rr+n)/2)}function ER(n,a){var u=Bn(n),m=n===a?En(n):sv(u/Bn(a))/sv(fy(a)/fy(n)),y=u*iw(fy(n),m)/m;if(!m)return H_;function x(E,r){y>0?r<-Rr+Wn&&(r=-Rr+Wn):r>Rr-Wn&&(r=Rr-Wn);var P=y/iw(fy(r),m);return[P*En(m*E),y-P*Bn(m*E)]}return x.invert=function(E,r){var P=y-r,M=Fs(m)*ro(E*E+P*P),L=jo(E,Vi(P))*Fs(P);return P*m<0&&(L-=Li*Fs(E)*Fs(P)),[L/m,2*Wd(iw(y/M,1/m))-Rr]},x}function sj(){return yT(ER).scale(109.5).parallels([30,30])}function z_(n,a){return[n,a]}z_.invert=z_;function aj(){return Ya(z_).scale(152.63)}function AR(n,a){var u=Bn(n),m=n===a?En(n):(u-Bn(a))/(a-n),y=u/m+n;if(Vi(m)<Wn)return z_;function x(E,r){var P=y-r,M=m*E;return[P*En(M),y-P*Bn(M)]}return x.invert=function(E,r){var P=y-r,M=jo(E,Vi(P))*Fs(P);return P*m<0&&(M-=Li*Fs(E)*Fs(P)),[M/m,y-Fs(m)*ro(E*E+P*P)]},x}function lj(){return yT(AR).scale(131.154).center([0,13.9389])}var u_=1.340264,h_=-.081106,f_=893e-6,d_=.003796,Mv=ro(3)/2,cj=12;function bT(n,a){var u=$o(Mv*En(a)),m=u*u,y=m*m*m;return[n*Bn(u)/(Mv*(u_+3*h_*m+y*(7*f_+9*d_*m))),u*(u_+h_*m+y*(f_+d_*m))]}bT.invert=function(n,a){for(var u=a,m=u*u,y=m*m*m,x=0,E,r,P;x<cj&&(r=u*(u_+h_*m+y*(f_+d_*m))-a,P=u_+3*h_*m+y*(7*f_+9*d_*m),u-=E=r/P,m=u*u,y=m*m*m,!(Vi(E)<rv));++x);return[Mv*n*(u_+3*h_*m+y*(7*f_+9*d_*m))/Bn(u),$o(En(u)/Mv)]};function uj(){return Ya(bT).scale(177.158)}function wT(n,a){var u=Bn(a),m=Bn(n)*u;return[u*En(n)/m,En(a)/m]}wT.invert=q_(Wd);function hj(){return Ya(wT).scale(144.049).clipAngle(60)}function fj(){var n=1,a=0,u=0,m=1,y=1,x=0,E,r,P=null,M,L,V,k=1,j=1,te=G_({point:function(se,Ae){var De=ce([se,Ae]);this.stream.point(De[0],De[1])}}),J=M_,Q,ee;function ue(){return k=n*m,j=n*y,Q=ee=null,ce}function ce(se){var Ae=se[0]*k,De=se[1]*j;if(x){var Qe=De*E-Ae*r;Ae=Ae*E+De*r,De=Qe}return[Ae+a,De+u]}return ce.invert=function(se){var Ae=se[0]-a,De=se[1]-u;if(x){var Qe=De*E+Ae*r;Ae=Ae*E-De*r,De=Qe}return[Ae/k,De/j]},ce.stream=function(se){return Q&&ee===se?Q:Q=te(J(ee=se))},ce.postclip=function(se){return arguments.length?(J=se,P=M=L=V=null,ue()):J},ce.clipExtent=function(se){return arguments.length?(J=se==null?(P=M=L=V=null,M_):dx(P=+se[0][0],M=+se[0][1],L=+se[1][0],V=+se[1][1]),ue()):P==null?null:[[P,M],[L,V]]},ce.scale=function(se){return arguments.length?(n=+se,ue()):n},ce.translate=function(se){return arguments.length?(a=+se[0],u=+se[1],ue()):[a,u]},ce.angle=function(se){return arguments.length?(x=se%360*qn,r=En(x),E=Bn(x),ue()):x*ar},ce.reflectX=function(se){return arguments.length?(m=se?-1:1,ue()):m<0},ce.reflectY=function(se){return arguments.length?(y=se?-1:1,ue()):y<0},ce.fitExtent=function(se,Ae){return px(ce,se,Ae)},ce.fitSize=function(se,Ae){return pT(ce,se,Ae)},ce.fitWidth=function(se,Ae){return mT(ce,se,Ae)},ce.fitHeight=function(se,Ae){return _T(ce,se,Ae)},ce}function TT(n,a){var u=a*a,m=u*u;return[n*(.8707-.131979*u+m*(-.013791+m*(.003971*u-.001529*m))),a*(1.007226+u*(.015085+m*(-.044475+.028874*u-.005916*m)))]}TT.invert=function(n,a){var u=a,m=25,y;do{var x=u*u,E=x*x;u-=y=(u*(1.007226+x*(.015085+E*(-.044475+.028874*x-.005916*E)))-a)/(1.007226+x*(.015085*3+E*(-.044475*7+.028874*9*x-.005916*11*E)))}while(Vi(y)>Wn&&--m>0);return[n/(.8707+(x=u*u)*(-.131979+x*(-.013791+x*x*x*(.003971-.001529*x)))),u]};function dj(){return Ya(TT).scale(175.295)}function ST(n,a){return[Bn(a)*En(n),En(a)]}ST.invert=q_($o);function pj(){return Ya(ST).scale(249.5).clipAngle(90+Wn)}function ET(n,a){var u=Bn(a),m=1+Bn(n)*u;return[u*En(n)/m,En(a)/m]}ET.invert=q_(function(n){return 2*Wd(n)});function mj(){return Ya(ET).scale(250).clipAngle(142)}function AT(n,a){return[sv(uT((Rr+a)/2)),-n]}AT.invert=function(n,a){return[-a,2*Wd(jz(n))-Rr]};function _j(){var n=SR(AT),a=n.center,u=n.rotate;return n.center=function(m){return arguments.length?a([-m[1],m[0]]):(m=a(),[m[1],-m[0]])},n.rotate=function(m){return arguments.length?u([m[0],m[1],m.length>2?m[2]+90:90]):(m=u(),[m[0],m[1],m[2]-90])},u([0,0,90]).scale(159.155)}function gj(n,a){return n.parent===a.parent?1:2}function yj(n){return n.reduce(vj,0)/n.length}function vj(n,a){return n+a.x}function xj(n){return 1+n.reduce(bj,0)}function bj(n,a){return Math.max(n,a.y)}function wj(n){for(var a;a=n.children;)n=a[0];return n}function Tj(n){for(var a;a=n.children;)n=a[a.length-1];return n}function Sj(){var n=gj,a=1,u=1,m=!1;function y(x){var E,r=0;x.eachAfter(function(k){var j=k.children;j?(k.x=yj(j),k.y=xj(j)):(k.x=E?r+=n(k,E):0,k.y=0,E=k)});var P=wj(x),M=Tj(x),L=P.x-n(P,M)/2,V=M.x+n(M,P)/2;return x.eachAfter(m?function(k){k.x=(k.x-x.x)*a,k.y=(x.y-k.y)*u}:function(k){k.x=(k.x-L)/(V-L)*a,k.y=(1-(x.y?k.y/x.y:1))*u})}return y.separation=function(x){return arguments.length?(n=x,y):n},y.size=function(x){return arguments.length?(m=!1,a=+x[0],u=+x[1],y):m?null:[a,u]},y.nodeSize=function(x){return arguments.length?(m=!0,a=+x[0],u=+x[1],y):m?[a,u]:null},y}function Ej(n){var a=0,u=n.children,m=u&&u.length;if(!m)a=1;else for(;--m>=0;)a+=u[m].value;n.value=a}function Aj(){return this.eachAfter(Ej)}function Ij(n,a){let u=-1;for(const m of this)n.call(a,m,++u,this);return this}function Mj(n,a){for(var u=this,m=[u],y,x,E=-1;u=m.pop();)if(n.call(a,u,++E,this),y=u.children)for(x=y.length-1;x>=0;--x)m.push(y[x]);return this}function Cj(n,a){for(var u=this,m=[u],y=[],x,E,r,P=-1;u=m.pop();)if(y.push(u),x=u.children)for(E=0,r=x.length;E<r;++E)m.push(x[E]);for(;u=y.pop();)n.call(a,u,++P,this);return this}function Pj(n,a){let u=-1;for(const m of this)if(n.call(a,m,++u,this))return m}function zj(n){return this.eachAfter(function(a){for(var u=+n(a.data)||0,m=a.children,y=m&&m.length;--y>=0;)u+=m[y].value;a.value=u})}function Rj(n){return this.eachBefore(function(a){a.children&&a.children.sort(n)})}function Dj(n){for(var a=this,u=Lj(a,n),m=[a];a!==u;)a=a.parent,m.push(a);for(var y=m.length;n!==u;)m.splice(y,0,n),n=n.parent;return m}function Lj(n,a){if(n===a)return n;var u=n.ancestors(),m=a.ancestors(),y=null;for(n=u.pop(),a=m.pop();n===a;)y=n,n=u.pop(),a=m.pop();return y}function kj(){for(var n=this,a=[n];n=n.parent;)a.push(n);return a}function Oj(){return Array.from(this)}function Fj(){var n=[];return this.eachBefore(function(a){a.children||n.push(a)}),n}function Bj(){var n=this,a=[];return n.each(function(u){u!==n&&a.push({source:u.parent,target:u})}),a}function*Nj(){var n=this,a,u=[n],m,y,x;do for(a=u.reverse(),u=[];n=a.pop();)if(yield n,m=n.children)for(y=0,x=m.length;y<x;++y)u.push(m[y]);while(u.length)}function IT(n,a){n instanceof Map?(n=[void 0,n],a===void 0&&(a=jj)):a===void 0&&(a=Uj);for(var u=new Ch(n),m,y=[u],x,E,r,P;m=y.pop();)if((E=a(m.data))&&(P=(E=Array.from(E)).length))for(m.children=E,r=P-1;r>=0;--r)y.push(x=E[r]=new Ch(E[r])),x.parent=m,x.depth=m.depth+1;return u.eachBefore(IR)}function Vj(){return IT(this).eachBefore($j)}function Uj(n){return n.children}function jj(n){return Array.isArray(n)?n[1]:null}function $j(n){n.data.value!==void 0&&(n.value=n.data.value),n.data=n.data.data}function IR(n){var a=0;do n.height=a;while((n=n.parent)&&n.height<++a)}function Ch(n){this.data=n,this.depth=this.height=0,this.parent=null}Ch.prototype=IT.prototype={constructor:Ch,count:Aj,each:Ij,eachAfter:Cj,eachBefore:Mj,find:Pj,sum:zj,sort:Rj,path:Dj,ancestors:kj,descendants:Oj,leaves:Fj,links:Bj,copy:Vj,[Symbol.iterator]:Nj};function Ry(n){return n==null?null:MR(n)}function MR(n){if(typeof n!="function")throw new Error;return n}function ph(){return 0}function _d(n){return function(){return n}}const Gj=1664525,qj=1013904223,L3=4294967296;function MT(){let n=1;return()=>(n=(Gj*n+qj)%L3)/L3}function Hj(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function Zj(n,a){let u=n.length,m,y;for(;u;)y=a()*u--|0,m=n[u],n[u]=n[y],n[y]=m;return n}function Wj(n){return CR(n,MT())}function CR(n,a){for(var u=0,m=(n=Zj(Array.from(n),a)).length,y=[],x,E;u<m;)x=n[u],E&&PR(E,x)?++u:(E=Yj(y=Xj(y,x)),u=0);return E}function Xj(n,a){var u,m;if(lw(a,n))return[a];for(u=0;u<n.length;++u)if(dy(a,n[u])&&lw(r_(n[u],a),n))return[n[u],a];for(u=0;u<n.length-1;++u)for(m=u+1;m<n.length;++m)if(dy(r_(n[u],n[m]),a)&&dy(r_(n[u],a),n[m])&&dy(r_(n[m],a),n[u])&&lw(zR(n[u],n[m],a),n))return[n[u],n[m],a];throw new Error}function dy(n,a){var u=n.r-a.r,m=a.x-n.x,y=a.y-n.y;return u<0||u*u<m*m+y*y}function PR(n,a){var u=n.r-a.r+Math.max(n.r,a.r,1)*1e-9,m=a.x-n.x,y=a.y-n.y;return u>0&&u*u>m*m+y*y}function lw(n,a){for(var u=0;u<a.length;++u)if(!PR(n,a[u]))return!1;return!0}function Yj(n){switch(n.length){case 1:return Kj(n[0]);case 2:return r_(n[0],n[1]);case 3:return zR(n[0],n[1],n[2])}}function Kj(n){return{x:n.x,y:n.y,r:n.r}}function r_(n,a){var u=n.x,m=n.y,y=n.r,x=a.x,E=a.y,r=a.r,P=x-u,M=E-m,L=r-y,V=Math.sqrt(P*P+M*M);return{x:(u+x+P/V*L)/2,y:(m+E+M/V*L)/2,r:(V+y+r)/2}}function zR(n,a,u){var m=n.x,y=n.y,x=n.r,E=a.x,r=a.y,P=a.r,M=u.x,L=u.y,V=u.r,k=m-E,j=m-M,te=y-r,J=y-L,Q=P-x,ee=V-x,ue=m*m+y*y-x*x,ce=ue-E*E-r*r+P*P,se=ue-M*M-L*L+V*V,Ae=j*te-k*J,De=(te*se-J*ce)/(Ae*2)-m,Qe=(J*Q-te*ee)/Ae,nt=(j*ce-k*se)/(Ae*2)-y,rt=(k*ee-j*Q)/Ae,tt=Qe*Qe+rt*rt-1,Be=2*(x+De*Qe+nt*rt),Rt=De*De+nt*nt-x*x,ut=-(Math.abs(tt)>1e-6?(Be+Math.sqrt(Be*Be-4*tt*Rt))/(2*tt):Rt/Be);return{x:m+De+Qe*ut,y:y+nt+rt*ut,r:ut}}function k3(n,a,u){var m=n.x-a.x,y,x,E=n.y-a.y,r,P,M=m*m+E*E;M?(x=a.r+u.r,x*=x,P=n.r+u.r,P*=P,x>P?(y=(M+P-x)/(2*M),r=Math.sqrt(Math.max(0,P/M-y*y)),u.x=n.x-y*m-r*E,u.y=n.y-y*E+r*m):(y=(M+x-P)/(2*M),r=Math.sqrt(Math.max(0,x/M-y*y)),u.x=a.x+y*m-r*E,u.y=a.y+y*E+r*m)):(u.x=a.x+u.r,u.y=a.y)}function O3(n,a){var u=n.r+a.r-1e-6,m=a.x-n.x,y=a.y-n.y;return u>0&&u*u>m*m+y*y}function F3(n){var a=n._,u=n.next._,m=a.r+u.r,y=(a.x*u.r+u.x*a.r)/m,x=(a.y*u.r+u.y*a.r)/m;return y*y+x*x}function py(n){this._=n,this.next=null,this.previous=null}function RR(n,a){if(!(x=(n=Hj(n)).length))return 0;var u,m,y,x,E,r,P,M,L,V,k;if(u=n[0],u.x=0,u.y=0,!(x>1))return u.r;if(m=n[1],u.x=-m.r,m.x=u.r,m.y=0,!(x>2))return u.r+m.r;k3(m,u,y=n[2]),u=new py(u),m=new py(m),y=new py(y),u.next=y.previous=m,m.next=u.previous=y,y.next=m.previous=u;e:for(P=3;P<x;++P){k3(u._,m._,y=n[P]),y=new py(y),M=m.next,L=u.previous,V=m._.r,k=u._.r;do if(V<=k){if(O3(M._,y._)){m=M,u.next=m,m.previous=u,--P;continue e}V+=M._.r,M=M.next}else{if(O3(L._,y._)){u=L,u.next=m,m.previous=u,--P;continue e}k+=L._.r,L=L.previous}while(M!==L.next);for(y.previous=u,y.next=m,u.next=m.previous=m=y,E=F3(u);(y=y.next)!==m;)(r=F3(y))<E&&(u=y,E=r);m=u.next}for(u=[m._],y=m;(y=y.next)!==m;)u.push(y._);for(y=CR(u,a),P=0;P<x;++P)u=n[P],u.x-=y.x,u.y-=y.y;return y.r}function Jj(n){return RR(n,MT()),n}function Qj(n){return Math.sqrt(n.value)}function e$(){var n=null,a=1,u=1,m=ph;function y(x){const E=MT();return x.x=a/2,x.y=u/2,n?x.eachBefore(B3(n)).eachAfter(cw(m,.5,E)).eachBefore(N3(1)):x.eachBefore(B3(Qj)).eachAfter(cw(ph,1,E)).eachAfter(cw(m,x.r/Math.min(a,u),E)).eachBefore(N3(Math.min(a,u)/(2*x.r))),x}return y.radius=function(x){return arguments.length?(n=Ry(x),y):n},y.size=function(x){return arguments.length?(a=+x[0],u=+x[1],y):[a,u]},y.padding=function(x){return arguments.length?(m=typeof x=="function"?x:_d(+x),y):m},y}function B3(n){return function(a){a.children||(a.r=Math.max(0,+n(a)||0))}}function cw(n,a,u){return function(m){if(y=m.children){var y,x,E=y.length,r=n(m)*a||0,P;if(r)for(x=0;x<E;++x)y[x].r+=r;if(P=RR(y,u),r)for(x=0;x<E;++x)y[x].r-=r;m.r=P+r}}}function N3(n){return function(a){var u=a.parent;a.r*=n,u&&(a.x=u.x+n*a.x,a.y=u.y+n*a.y)}}function DR(n){n.x0=Math.round(n.x0),n.y0=Math.round(n.y0),n.x1=Math.round(n.x1),n.y1=Math.round(n.y1)}function Z_(n,a,u,m,y){for(var x=n.children,E,r=-1,P=x.length,M=n.value&&(m-a)/n.value;++r<P;)E=x[r],E.y0=u,E.y1=y,E.x0=a,E.x1=a+=E.value*M}function t$(){var n=1,a=1,u=0,m=!1;function y(E){var r=E.height+1;return E.x0=E.y0=u,E.x1=n,E.y1=a/r,E.eachBefore(x(a,r)),m&&E.eachBefore(DR),E}function x(E,r){return function(P){P.children&&Z_(P,P.x0,E*(P.depth+1)/r,P.x1,E*(P.depth+2)/r);var M=P.x0,L=P.y0,V=P.x1-u,k=P.y1-u;V<M&&(M=V=(M+V)/2),k<L&&(L=k=(L+k)/2),P.x0=M,P.y0=L,P.x1=V,P.y1=k}}return y.round=function(E){return arguments.length?(m=!!E,y):m},y.size=function(E){return arguments.length?(n=+E[0],a=+E[1],y):[n,a]},y.padding=function(E){return arguments.length?(u=+E,y):u},y}var n$={depth:-1},V3={},uw={};function i$(n){return n.id}function r$(n){return n.parentId}function o$(){var n=i$,a=r$,u;function m(y){var x=Array.from(y),E=n,r=a,P,M,L,V,k,j,te,J,Q=new Map;if(u!=null){const ee=x.map((se,Ae)=>s$(u(se,Ae,y))),ue=ee.map(U3),ce=new Set(ee).add("");for(const se of ue)ce.has(se)||(ce.add(se),ee.push(se),ue.push(U3(se)),x.push(uw));E=(se,Ae)=>ee[Ae],r=(se,Ae)=>ue[Ae]}for(L=0,P=x.length;L<P;++L)M=x[L],j=x[L]=new Ch(M),(te=E(M,L,y))!=null&&(te+="")&&(J=j.id=te,Q.set(J,Q.has(J)?V3:j)),(te=r(M,L,y))!=null&&(te+="")&&(j.parent=te);for(L=0;L<P;++L)if(j=x[L],te=j.parent){if(k=Q.get(te),!k)throw new Error("missing: "+te);if(k===V3)throw new Error("ambiguous: "+te);k.children?k.children.push(j):k.children=[j],j.parent=k}else{if(V)throw new Error("multiple roots");V=j}if(!V)throw new Error("no root");if(u!=null){for(;V.data===uw&&V.children.length===1;)V=V.children[0],--P;for(let ee=x.length-1;ee>=0&&(j=x[ee],j.data===uw);--ee)j.data=null}if(V.parent=n$,V.eachBefore(function(ee){ee.depth=ee.parent.depth+1,--P}).eachBefore(IR),V.parent=null,P>0)throw new Error("cycle");return V}return m.id=function(y){return arguments.length?(n=Ry(y),m):n},m.parentId=function(y){return arguments.length?(a=Ry(y),m):a},m.path=function(y){return arguments.length?(u=Ry(y),m):u},m}function s$(n){n=`${n}`;let a=n.length;return x2(n,a-1)&&!x2(n,a-2)&&(n=n.slice(0,-1)),n[0]==="/"?n:`/${n}`}function U3(n){let a=n.length;if(a<2)return"";for(;--a>1&&!x2(n,a););return n.slice(0,a)}function x2(n,a){if(n[a]==="/"){let u=0;for(;a>0&&n[--a]==="\\";)++u;if((u&1)===0)return!0}return!1}function a$(n,a){return n.parent===a.parent?1:2}function hw(n){var a=n.children;return a?a[0]:n.t}function fw(n){var a=n.children;return a?a[a.length-1]:n.t}function l$(n,a,u){var m=u/(a.i-n.i);a.c-=m,a.s+=u,n.c+=m,a.z+=u,a.m+=u}function c$(n){for(var a=0,u=0,m=n.children,y=m.length,x;--y>=0;)x=m[y],x.z+=a,x.m+=a,a+=x.s+(u+=x.c)}function u$(n,a,u){return n.a.parent===a.parent?n.a:u}function Dy(n,a){this._=n,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=a}Dy.prototype=Object.create(Ch.prototype);function h$(n){for(var a=new Dy(n,0),u,m=[a],y,x,E,r;u=m.pop();)if(x=u._.children)for(u.children=new Array(r=x.length),E=r-1;E>=0;--E)m.push(y=u.children[E]=new Dy(x[E],E)),y.parent=u;return(a.parent=new Dy(null,0)).children=[a],a}function f$(){var n=a$,a=1,u=1,m=null;function y(M){var L=h$(M);if(L.eachAfter(x),L.parent.m=-L.z,L.eachBefore(E),m)M.eachBefore(P);else{var V=M,k=M,j=M;M.eachBefore(function(ue){ue.x<V.x&&(V=ue),ue.x>k.x&&(k=ue),ue.depth>j.depth&&(j=ue)});var te=V===k?1:n(V,k)/2,J=te-V.x,Q=a/(k.x+te+J),ee=u/(j.depth||1);M.eachBefore(function(ue){ue.x=(ue.x+J)*Q,ue.y=ue.depth*ee})}return M}function x(M){var L=M.children,V=M.parent.children,k=M.i?V[M.i-1]:null;if(L){c$(M);var j=(L[0].z+L[L.length-1].z)/2;k?(M.z=k.z+n(M._,k._),M.m=M.z-j):M.z=j}else k&&(M.z=k.z+n(M._,k._));M.parent.A=r(M,k,M.parent.A||V[0])}function E(M){M._.x=M.z+M.parent.m,M.m+=M.parent.m}function r(M,L,V){if(L){for(var k=M,j=M,te=L,J=k.parent.children[0],Q=k.m,ee=j.m,ue=te.m,ce=J.m,se;te=fw(te),k=hw(k),te&&k;)J=hw(J),j=fw(j),j.a=M,se=te.z+ue-k.z-Q+n(te._,k._),se>0&&(l$(u$(te,M,V),M,se),Q+=se,ee+=se),ue+=te.m,Q+=k.m,ce+=J.m,ee+=j.m;te&&!fw(j)&&(j.t=te,j.m+=ue-ee),k&&!hw(J)&&(J.t=k,J.m+=Q-ce,V=M)}return V}function P(M){M.x*=a,M.y=M.depth*u}return y.separation=function(M){return arguments.length?(n=M,y):n},y.size=function(M){return arguments.length?(m=!1,a=+M[0],u=+M[1],y):m?null:[a,u]},y.nodeSize=function(M){return arguments.length?(m=!0,a=+M[0],u=+M[1],y):m?[a,u]:null},y}function mx(n,a,u,m,y){for(var x=n.children,E,r=-1,P=x.length,M=n.value&&(y-u)/n.value;++r<P;)E=x[r],E.x0=a,E.x1=m,E.y0=u,E.y1=u+=E.value*M}var LR=(1+Math.sqrt(5))/2;function kR(n,a,u,m,y,x){for(var E=[],r=a.children,P,M,L=0,V=0,k=r.length,j,te,J=a.value,Q,ee,ue,ce,se,Ae,De;L<k;){j=y-u,te=x-m;do Q=r[V++].value;while(!Q&&V<k);for(ee=ue=Q,Ae=Math.max(te/j,j/te)/(J*n),De=Q*Q*Ae,se=Math.max(ue/De,De/ee);V<k;++V){if(Q+=M=r[V].value,M<ee&&(ee=M),M>ue&&(ue=M),De=Q*Q*Ae,ce=Math.max(ue/De,De/ee),ce>se){Q-=M;break}se=ce}E.push(P={value:Q,dice:j<te,children:r.slice(L,V)}),P.dice?Z_(P,u,m,y,J?m+=te*Q/J:x):mx(P,u,m,J?u+=j*Q/J:y,x),J-=Q,L=V}return E}const OR=function n(a){function u(m,y,x,E,r){kR(a,m,y,x,E,r)}return u.ratio=function(m){return n((m=+m)>1?m:1)},u}(LR);function d$(){var n=OR,a=!1,u=1,m=1,y=[0],x=ph,E=ph,r=ph,P=ph,M=ph;function L(k){return k.x0=k.y0=0,k.x1=u,k.y1=m,k.eachBefore(V),y=[0],a&&k.eachBefore(DR),k}function V(k){var j=y[k.depth],te=k.x0+j,J=k.y0+j,Q=k.x1-j,ee=k.y1-j;Q<te&&(te=Q=(te+Q)/2),ee<J&&(J=ee=(J+ee)/2),k.x0=te,k.y0=J,k.x1=Q,k.y1=ee,k.children&&(j=y[k.depth+1]=x(k)/2,te+=M(k)-j,J+=E(k)-j,Q-=r(k)-j,ee-=P(k)-j,Q<te&&(te=Q=(te+Q)/2),ee<J&&(J=ee=(J+ee)/2),n(k,te,J,Q,ee))}return L.round=function(k){return arguments.length?(a=!!k,L):a},L.size=function(k){return arguments.length?(u=+k[0],m=+k[1],L):[u,m]},L.tile=function(k){return arguments.length?(n=MR(k),L):n},L.padding=function(k){return arguments.length?L.paddingInner(k).paddingOuter(k):L.paddingInner()},L.paddingInner=function(k){return arguments.length?(x=typeof k=="function"?k:_d(+k),L):x},L.paddingOuter=function(k){return arguments.length?L.paddingTop(k).paddingRight(k).paddingBottom(k).paddingLeft(k):L.paddingTop()},L.paddingTop=function(k){return arguments.length?(E=typeof k=="function"?k:_d(+k),L):E},L.paddingRight=function(k){return arguments.length?(r=typeof k=="function"?k:_d(+k),L):r},L.paddingBottom=function(k){return arguments.length?(P=typeof k=="function"?k:_d(+k),L):P},L.paddingLeft=function(k){return arguments.length?(M=typeof k=="function"?k:_d(+k),L):M},L}function p$(n,a,u,m,y){var x=n.children,E,r=x.length,P,M=new Array(r+1);for(M[0]=P=E=0;E<r;++E)M[E+1]=P+=x[E].value;L(0,r,n.value,a,u,m,y);function L(V,k,j,te,J,Q,ee){if(V>=k-1){var ue=x[V];ue.x0=te,ue.y0=J,ue.x1=Q,ue.y1=ee;return}for(var ce=M[V],se=j/2+ce,Ae=V+1,De=k-1;Ae<De;){var Qe=Ae+De>>>1;M[Qe]<se?Ae=Qe+1:De=Qe}se-M[Ae-1]<M[Ae]-se&&V+1<Ae&&--Ae;var nt=M[Ae]-ce,rt=j-nt;if(Q-te>ee-J){var tt=j?(te*rt+Q*nt)/j:Q;L(V,Ae,nt,te,J,tt,ee),L(Ae,k,rt,tt,J,Q,ee)}else{var Be=j?(J*rt+ee*nt)/j:ee;L(V,Ae,nt,te,J,Q,Be),L(Ae,k,rt,te,Be,Q,ee)}}}function m$(n,a,u,m,y){(n.depth&1?mx:Z_)(n,a,u,m,y)}const _$=function n(a){function u(m,y,x,E,r){if((P=m._squarify)&&P.ratio===a)for(var P,M,L,V,k=-1,j,te=P.length,J=m.value;++k<te;){for(M=P[k],L=M.children,V=M.value=0,j=L.length;V<j;++V)M.value+=L[V].value;M.dice?Z_(M,y,x,E,J?x+=(r-x)*M.value/J:r):mx(M,y,x,J?y+=(E-y)*M.value/J:E,r),J-=M.value}else m._squarify=P=kR(a,m,y,x,E,r),P.ratio=a}return u.ratio=function(m){return n((m=+m)>1?m:1)},u}(LR);function g$(n){for(var a=-1,u=n.length,m,y=n[u-1],x=0;++a<u;)m=y,y=n[a],x+=m[1]*y[0]-m[0]*y[1];return x/2}function y$(n){for(var a=-1,u=n.length,m=0,y=0,x,E=n[u-1],r,P=0;++a<u;)x=E,E=n[a],P+=r=x[0]*E[1]-E[0]*x[1],m+=(x[0]+E[0])*r,y+=(x[1]+E[1])*r;return P*=3,[m/P,y/P]}function v$(n,a,u){return(a[0]-n[0])*(u[1]-n[1])-(a[1]-n[1])*(u[0]-n[0])}function x$(n,a){return n[0]-a[0]||n[1]-a[1]}function j3(n){const a=n.length,u=[0,1];let m=2,y;for(y=2;y<a;++y){for(;m>1&&v$(n[u[m-2]],n[u[m-1]],n[y])<=0;)--m;u[m++]=y}return u.slice(0,m)}function b$(n){if((u=n.length)<3)return null;var a,u,m=new Array(u),y=new Array(u);for(a=0;a<u;++a)m[a]=[+n[a][0],+n[a][1],a];for(m.sort(x$),a=0;a<u;++a)y[a]=[m[a][0],-m[a][1]];var x=j3(m),E=j3(y),r=E[0]===x[0],P=E[E.length-1]===x[x.length-1],M=[];for(a=x.length-1;a>=0;--a)M.push(n[m[x[a]][2]]);for(a=+r;a<E.length-P;++a)M.push(n[m[E[a]][2]]);return M}function w$(n,a){for(var u=n.length,m=n[u-1],y=a[0],x=a[1],E=m[0],r=m[1],P,M,L=!1,V=0;V<u;++V)m=n[V],P=m[0],M=m[1],M>x!=r>x&&y<(E-P)*(x-M)/(r-M)+P&&(L=!L),E=P,r=M;return L}function T$(n){for(var a=-1,u=n.length,m=n[u-1],y,x,E=m[0],r=m[1],P=0;++a<u;)y=E,x=r,m=n[a],E=m[0],r=m[1],y-=E,x-=r,P+=Math.hypot(y,x);return P}const fo=Math.random,S$=function n(a){function u(m,y){return m=m==null?0:+m,y=y==null?1:+y,arguments.length===1?(y=m,m=0):y-=m,function(){return a()*y+m}}return u.source=n,u}(fo),E$=function n(a){function u(m,y){return arguments.length<2&&(y=m,m=0),m=Math.floor(m),y=Math.floor(y)-m,function(){return Math.floor(a()*y+m)}}return u.source=n,u}(fo),CT=function n(a){function u(m,y){var x,E;return m=m==null?0:+m,y=y==null?1:+y,function(){var r;if(x!=null)r=x,x=null;else do x=a()*2-1,r=a()*2-1,E=x*x+r*r;while(!E||E>1);return m+y*r*Math.sqrt(-2*Math.log(E)/E)}}return u.source=n,u}(fo),A$=function n(a){var u=CT.source(a);function m(){var y=u.apply(this,arguments);return function(){return Math.exp(y())}}return m.source=n,m}(fo),FR=function n(a){function u(m){return(m=+m)<=0?()=>0:function(){for(var y=0,x=m;x>1;--x)y+=a();return y+x*a()}}return u.source=n,u}(fo),I$=function n(a){var u=FR.source(a);function m(y){if((y=+y)==0)return a;var x=u(y);return function(){return x()/y}}return m.source=n,m}(fo),M$=function n(a){function u(m){return function(){return-Math.log1p(-a())/m}}return u.source=n,u}(fo),C$=function n(a){function u(m){if((m=+m)<0)throw new RangeError("invalid alpha");return m=1/-m,function(){return Math.pow(1-a(),m)}}return u.source=n,u}(fo),P$=function n(a){function u(m){if((m=+m)<0||m>1)throw new RangeError("invalid p");return function(){return Math.floor(a()+m)}}return u.source=n,u}(fo),BR=function n(a){function u(m){if((m=+m)<0||m>1)throw new RangeError("invalid p");return m===0?()=>1/0:m===1?()=>1:(m=Math.log1p(-m),function(){return 1+Math.floor(Math.log1p(-a())/m)})}return u.source=n,u}(fo),PT=function n(a){var u=CT.source(a)();function m(y,x){if((y=+y)<0)throw new RangeError("invalid k");if(y===0)return()=>0;if(x=x==null?1:+x,y===1)return()=>-Math.log1p(-a())*x;var E=(y<1?y+1:y)-1/3,r=1/(3*Math.sqrt(E)),P=y<1?()=>Math.pow(a(),1/y):()=>1;return function(){do{do var M=u(),L=1+r*M;while(L<=0);L*=L*L;var V=1-a()}while(V>=1-.0331*M*M*M*M&&Math.log(V)>=.5*M*M+E*(1-L+Math.log(L)));return E*L*P()*x}}return m.source=n,m}(fo),NR=function n(a){var u=PT.source(a);function m(y,x){var E=u(y),r=u(x);return function(){var P=E();return P===0?0:P/(P+r())}}return m.source=n,m}(fo),VR=function n(a){var u=BR.source(a),m=NR.source(a);function y(x,E){return x=+x,(E=+E)>=1?()=>x:E<=0?()=>0:function(){for(var r=0,P=x,M=E;P*M>16&&P*(1-M)>16;){var L=Math.floor((P+1)*M),V=m(L,P-L+1)();V<=M?(r+=L,P-=L,M=(M-V)/(1-V)):(P=L-1,M/=V)}for(var k=M<.5,j=k?M:1-M,te=u(j),J=te(),Q=0;J<=P;++Q)J+=te();return r+(k?Q:P-Q)}}return y.source=n,y}(fo),z$=function n(a){function u(m,y,x){var E;return(m=+m)==0?E=r=>-Math.log(r):(m=1/m,E=r=>Math.pow(r,m)),y=y==null?0:+y,x=x==null?1:+x,function(){return y+x*E(-Math.log1p(-a()))}}return u.source=n,u}(fo),R$=function n(a){function u(m,y){return m=m==null?0:+m,y=y==null?1:+y,function(){return m+y*Math.tan(Math.PI*a())}}return u.source=n,u}(fo),D$=function n(a){function u(m,y){return m=m==null?0:+m,y=y==null?1:+y,function(){var x=a();return m+y*Math.log(x/(1-x))}}return u.source=n,u}(fo),L$=function n(a){var u=PT.source(a),m=VR.source(a);function y(x){return function(){for(var E=0,r=x;r>16;){var P=Math.floor(.875*r),M=u(P)();if(M>r)return E+m(P-1,r/M)();E+=P,r-=M}for(var L=-Math.log1p(-a()),V=0;L<=r;++V)L-=Math.log1p(-a());return E+V}}return y.source=n,y}(fo),k$=1664525,O$=1013904223,$3=1/4294967296;function F$(n=Math.random()){let a=(0<=n&&n<1?n/$3:Math.abs(n))|0;return()=>(a=k$*a+O$|0,$3*(a>>>0))}function Vs(n,a){switch(arguments.length){case 0:break;case 1:this.range(n);break;default:this.range(a).domain(n);break}return this}function Wl(n,a){switch(arguments.length){case 0:break;case 1:{typeof n=="function"?this.interpolator(n):this.range(n);break}default:{this.domain(n),typeof a=="function"?this.interpolator(a):this.range(a);break}}return this}const b2=Symbol("implicit");function zT(){var n=new g_,a=[],u=[],m=b2;function y(x){let E=n.get(x);if(E===void 0){if(m!==b2)return m;n.set(x,E=a.push(x)-1)}return u[E%u.length]}return y.domain=function(x){if(!arguments.length)return a.slice();a=[],n=new g_;for(const E of x)n.has(E)||n.set(E,a.push(E)-1);return y},y.range=function(x){return arguments.length?(u=Array.from(x),y):u.slice()},y.unknown=function(x){return arguments.length?(m=x,y):m},y.copy=function(){return zT(a,u).unknown(m)},Vs.apply(y,arguments),y}function RT(){var n=zT().unknown(void 0),a=n.domain,u=n.range,m=0,y=1,x,E,r=!1,P=0,M=0,L=.5;delete n.unknown;function V(){var k=a().length,j=y<m,te=j?y:m,J=j?m:y;x=(J-te)/Math.max(1,k-P+M*2),r&&(x=Math.floor(x)),te+=(J-te-x*(k-P))*L,E=x*(1-P),r&&(te=Math.round(te),E=Math.round(E));var Q=Nl(k).map(function(ee){return te+x*ee});return u(j?Q.reverse():Q)}return n.domain=function(k){return arguments.length?(a(k),V()):a()},n.range=function(k){return arguments.length?([m,y]=k,m=+m,y=+y,V()):[m,y]},n.rangeRound=function(k){return[m,y]=k,m=+m,y=+y,r=!0,V()},n.bandwidth=function(){return E},n.step=function(){return x},n.round=function(k){return arguments.length?(r=!!k,V()):r},n.padding=function(k){return arguments.length?(P=Math.min(1,M=+k),V()):P},n.paddingInner=function(k){return arguments.length?(P=Math.min(1,k),V()):P},n.paddingOuter=function(k){return arguments.length?(M=+k,V()):M},n.align=function(k){return arguments.length?(L=Math.max(0,Math.min(1,k)),V()):L},n.copy=function(){return RT(a(),[m,y]).round(r).paddingInner(P).paddingOuter(M).align(L)},Vs.apply(V(),arguments)}function UR(n){var a=n.copy;return n.padding=n.paddingOuter,delete n.paddingInner,delete n.paddingOuter,n.copy=function(){return UR(a())},n}function B$(){return UR(RT.apply(null,arguments).paddingInner(1))}function N$(n){return function(){return n}}function Cv(n){return+n}var G3=[0,1];function Fo(n){return n}function w2(n,a){return(a-=n=+n)?function(u){return(u-n)/a}:N$(isNaN(a)?NaN:.5)}function V$(n,a){var u;return n>a&&(u=n,n=a,a=u),function(m){return Math.max(n,Math.min(a,m))}}function U$(n,a,u){var m=n[0],y=n[1],x=a[0],E=a[1];return y<m?(m=w2(y,m),x=u(E,x)):(m=w2(m,y),x=u(x,E)),function(r){return x(m(r))}}function j$(n,a,u){var m=Math.min(n.length,a.length)-1,y=new Array(m),x=new Array(m),E=-1;for(n[m]<n[0]&&(n=n.slice().reverse(),a=a.slice().reverse());++E<m;)y[E]=w2(n[E],n[E+1]),x[E]=u(a[E],a[E+1]);return function(r){var P=Kc(n,r,1,m)-1;return x[P](y[P](r))}}function W_(n,a){return a.domain(n.domain()).range(n.range()).interpolate(n.interpolate()).clamp(n.clamp()).unknown(n.unknown())}function _x(){var n=G3,a=G3,u=ru,m,y,x,E=Fo,r,P,M;function L(){var k=Math.min(n.length,a.length);return E!==Fo&&(E=V$(n[0],n[k-1])),r=k>2?j$:U$,P=M=null,V}function V(k){return k==null||isNaN(k=+k)?x:(P||(P=r(n.map(m),a,u)))(m(E(k)))}return V.invert=function(k){return E(y((M||(M=r(a,n.map(m),ks)))(k)))},V.domain=function(k){return arguments.length?(n=Array.from(k,Cv),L()):n.slice()},V.range=function(k){return arguments.length?(a=Array.from(k),L()):a.slice()},V.rangeRound=function(k){return a=Array.from(k),u=ix,L()},V.clamp=function(k){return arguments.length?(E=k?!0:Fo,L()):E!==Fo},V.interpolate=function(k){return arguments.length?(u=k,L()):u},V.unknown=function(k){return arguments.length?(x=k,V):x},function(k,j){return m=k,y=j,L()}}function DT(){return _x()(Fo,Fo)}function jR(n,a,u,m){var y=Hy(n,a,u),x;switch(m=Ld(m??",f"),m.type){case"s":{var E=Math.max(Math.abs(n),Math.abs(a));return m.precision==null&&!isNaN(x=Vz(y,E))&&(m.precision=x),cT(m,E)}case"":case"e":case"g":case"p":case"r":{m.precision==null&&!isNaN(x=Uz(y,Math.max(Math.abs(n),Math.abs(a))))&&(m.precision=x-(m.type==="e"));break}case"f":case"%":{m.precision==null&&!isNaN(x=Nz(y))&&(m.precision=x-(m.type==="%")*2);break}}return fx(m)}function ou(n){var a=n.domain;return n.ticks=function(u){var m=a();return wh(m[0],m[m.length-1],u??10)},n.tickFormat=function(u,m){var y=a();return jR(y[0],y[y.length-1],u??10,m)},n.nice=function(u){u==null&&(u=10);var m=a(),y=0,x=m.length-1,E=m[y],r=m[x],P,M,L=10;for(r<E&&(M=E,E=r,r=M,M=y,y=x,x=M);L-- >0;){if(M=Th(E,r,u),M===P)return m[y]=E,m[x]=r,a(m);if(M>0)E=Math.floor(E/M)*M,r=Math.ceil(r/M)*M;else if(M<0)E=Math.ceil(E*M)/M,r=Math.floor(r*M)/M;else break;P=M}return n},n}function Pv(){var n=DT();return n.copy=function(){return W_(n,Pv())},Vs.apply(n,arguments),ou(n)}function $R(n){var a;function u(m){return m==null||isNaN(m=+m)?a:m}return u.invert=u,u.domain=u.range=function(m){return arguments.length?(n=Array.from(m,Cv),u):n.slice()},u.unknown=function(m){return arguments.length?(a=m,u):a},u.copy=function(){return $R(n).unknown(a)},n=arguments.length?Array.from(n,Cv):[0,1],ou(u)}function GR(n,a){n=n.slice();var u=0,m=n.length-1,y=n[u],x=n[m],E;return x<y&&(E=u,u=m,m=E,E=y,y=x,x=E),n[u]=a.floor(y),n[m]=a.ceil(x),n}function q3(n){return Math.log(n)}function H3(n){return Math.exp(n)}function $$(n){return-Math.log(-n)}function G$(n){return-Math.exp(-n)}function q$(n){return isFinite(n)?+("1e"+n):n<0?0:n}function H$(n){return n===10?q$:n===Math.E?Math.exp:a=>Math.pow(n,a)}function Z$(n){return n===Math.E?Math.log:n===10&&Math.log10||n===2&&Math.log2||(n=Math.log(n),a=>Math.log(a)/n)}function Z3(n){return(a,u)=>-n(-a,u)}function LT(n){const a=n(q3,H3),u=a.domain;let m=10,y,x;function E(){return y=Z$(m),x=H$(m),u()[0]<0?(y=Z3(y),x=Z3(x),n($$,G$)):n(q3,H3),a}return a.base=function(r){return arguments.length?(m=+r,E()):m},a.domain=function(r){return arguments.length?(u(r),E()):u()},a.ticks=r=>{const P=u();let M=P[0],L=P[P.length-1];const V=L<M;V&&([M,L]=[L,M]);let k=y(M),j=y(L),te,J;const Q=r==null?10:+r;let ee=[];if(!(m%1)&&j-k<Q){if(k=Math.floor(k),j=Math.ceil(j),M>0){for(;k<=j;++k)for(te=1;te<m;++te)if(J=k<0?te/x(-k):te*x(k),!(J<M)){if(J>L)break;ee.push(J)}}else for(;k<=j;++k)for(te=m-1;te>=1;--te)if(J=k>0?te/x(-k):te*x(k),!(J<M)){if(J>L)break;ee.push(J)}ee.length*2<Q&&(ee=wh(M,L,Q))}else ee=wh(k,j,Math.min(j-k,Q)).map(x);return V?ee.reverse():ee},a.tickFormat=(r,P)=>{if(r==null&&(r=10),P==null&&(P=m===10?"s":","),typeof P!="function"&&(!(m%1)&&(P=Ld(P)).precision==null&&(P.trim=!0),P=fx(P)),r===1/0)return P;const M=Math.max(1,m*r/a.ticks().length);return L=>{let V=L/x(Math.round(y(L)));return V*m<m-.5&&(V*=m),V<=M?P(L):""}},a.nice=()=>u(GR(u(),{floor:r=>x(Math.floor(y(r))),ceil:r=>x(Math.ceil(y(r)))})),a}function qR(){const n=LT(_x()).domain([1,10]);return n.copy=()=>W_(n,qR()).base(n.base()),Vs.apply(n,arguments),n}function W3(n){return function(a){return Math.sign(a)*Math.log1p(Math.abs(a/n))}}function X3(n){return function(a){return Math.sign(a)*Math.expm1(Math.abs(a))*n}}function kT(n){var a=1,u=n(W3(a),X3(a));return u.constant=function(m){return arguments.length?n(W3(a=+m),X3(a)):a},ou(u)}function HR(){var n=kT(_x());return n.copy=function(){return W_(n,HR()).constant(n.constant())},Vs.apply(n,arguments)}function Y3(n){return function(a){return a<0?-Math.pow(-a,n):Math.pow(a,n)}}function W$(n){return n<0?-Math.sqrt(-n):Math.sqrt(n)}function X$(n){return n<0?-n*n:n*n}function OT(n){var a=n(Fo,Fo),u=1;function m(){return u===1?n(Fo,Fo):u===.5?n(W$,X$):n(Y3(u),Y3(1/u))}return a.exponent=function(y){return arguments.length?(u=+y,m()):u},ou(a)}function FT(){var n=OT(_x());return n.copy=function(){return W_(n,FT()).exponent(n.exponent())},Vs.apply(n,arguments),n}function Y$(){return FT.apply(null,arguments).exponent(.5)}function K3(n){return Math.sign(n)*n*n}function K$(n){return Math.sign(n)*Math.sqrt(Math.abs(n))}function ZR(){var n=DT(),a=[0,1],u=!1,m;function y(x){var E=K$(n(x));return isNaN(E)?m:u?Math.round(E):E}return y.invert=function(x){return n.invert(K3(x))},y.domain=function(x){return arguments.length?(n.domain(x),y):n.domain()},y.range=function(x){return arguments.length?(n.range((a=Array.from(x,Cv)).map(K3)),y):a.slice()},y.rangeRound=function(x){return y.range(x).round(!0)},y.round=function(x){return arguments.length?(u=!!x,y):u},y.clamp=function(x){return arguments.length?(n.clamp(x),y):n.clamp()},y.unknown=function(x){return arguments.length?(m=x,y):m},y.copy=function(){return ZR(n.domain(),a).round(u).clamp(n.clamp()).unknown(m)},Vs.apply(y,arguments),ou(y)}function WR(){var n=[],a=[],u=[],m;function y(){var E=0,r=Math.max(1,a.length);for(u=new Array(r-1);++E<r;)u[E-1]=wP(n,E/r);return x}function x(E){return E==null||isNaN(E=+E)?m:a[Kc(u,E)]}return x.invertExtent=function(E){var r=a.indexOf(E);return r<0?[NaN,NaN]:[r>0?u[r-1]:n[0],r<u.length?u[r]:n[n.length-1]]},x.domain=function(E){if(!arguments.length)return n.slice();n=[];for(let r of E)r!=null&&!isNaN(r=+r)&&n.push(r);return n.sort(Ir),y()},x.range=function(E){return arguments.length?(a=Array.from(E),y()):a.slice()},x.unknown=function(E){return arguments.length?(m=E,x):m},x.quantiles=function(){return u.slice()},x.copy=function(){return WR().domain(n).range(a).unknown(m)},Vs.apply(x,arguments)}function XR(){var n=0,a=1,u=1,m=[.5],y=[0,1],x;function E(P){return P!=null&&P<=P?y[Kc(m,P,0,u)]:x}function r(){var P=-1;for(m=new Array(u);++P<u;)m[P]=((P+1)*a-(P-u)*n)/(u+1);return E}return E.domain=function(P){return arguments.length?([n,a]=P,n=+n,a=+a,r()):[n,a]},E.range=function(P){return arguments.length?(u=(y=Array.from(P)).length-1,r()):y.slice()},E.invertExtent=function(P){var M=y.indexOf(P);return M<0?[NaN,NaN]:M<1?[n,m[0]]:M>=u?[m[u-1],a]:[m[M-1],m[M]]},E.unknown=function(P){return arguments.length&&(x=P),E},E.thresholds=function(){return m.slice()},E.copy=function(){return XR().domain([n,a]).range(y).unknown(x)},Vs.apply(ou(E),arguments)}function YR(){var n=[.5],a=[0,1],u,m=1;function y(x){return x!=null&&x<=x?a[Kc(n,x,0,m)]:u}return y.domain=function(x){return arguments.length?(n=Array.from(x),m=Math.min(n.length,a.length-1),y):n.slice()},y.range=function(x){return arguments.length?(a=Array.from(x),m=Math.min(n.length,a.length-1),y):a.slice()},y.invertExtent=function(x){var E=a.indexOf(x);return[n[E-1],n[E]]},y.unknown=function(x){return arguments.length?(u=x,y):u},y.copy=function(){return YR().domain(n).range(a).unknown(u)},Vs.apply(y,arguments)}const dw=new Date,pw=new Date;function Ur(n,a,u,m){function y(x){return n(x=arguments.length===0?new Date:new Date(+x)),x}return y.floor=x=>(n(x=new Date(+x)),x),y.ceil=x=>(n(x=new Date(x-1)),a(x,1),n(x),x),y.round=x=>{const E=y(x),r=y.ceil(x);return x-E<r-x?E:r},y.offset=(x,E)=>(a(x=new Date(+x),E==null?1:Math.floor(E)),x),y.range=(x,E,r)=>{const P=[];if(x=y.ceil(x),r=r==null?1:Math.floor(r),!(x<E)||!(r>0))return P;let M;do P.push(M=new Date(+x)),a(x,r),n(x);while(M<x&&x<E);return P},y.filter=x=>Ur(E=>{if(E>=E)for(;n(E),!x(E);)E.setTime(E-1)},(E,r)=>{if(E>=E)if(r<0)for(;++r<=0;)for(;a(E,-1),!x(E););else for(;--r>=0;)for(;a(E,1),!x(E););}),u&&(y.count=(x,E)=>(dw.setTime(+x),pw.setTime(+E),n(dw),n(pw),Math.floor(u(dw,pw))),y.every=x=>(x=Math.floor(x),!isFinite(x)||!(x>0)?null:x>1?y.filter(m?E=>m(E)%x===0:E=>y.count(0,E)%x===0):y)),y}const Bd=Ur(()=>{},(n,a)=>{n.setTime(+n+a)},(n,a)=>a-n);Bd.every=n=>(n=Math.floor(n),!isFinite(n)||!(n>0)?null:n>1?Ur(a=>{a.setTime(Math.floor(a/n)*n)},(a,u)=>{a.setTime(+a+u*n)},(a,u)=>(u-a)/n):Bd);const J3=Bd.range,Vl=1e3,Bs=Vl*60,Ul=Bs*60,Hl=Ul*24,BT=Hl*7,Q3=Hl*30,mw=Hl*365,jl=Ur(n=>{n.setTime(n-n.getMilliseconds())},(n,a)=>{n.setTime(+n+a*Vl)},(n,a)=>(a-n)/Vl,n=>n.getUTCSeconds()),eC=jl.range,gx=Ur(n=>{n.setTime(n-n.getMilliseconds()-n.getSeconds()*Vl)},(n,a)=>{n.setTime(+n+a*Bs)},(n,a)=>(a-n)/Bs,n=>n.getMinutes()),J$=gx.range,yx=Ur(n=>{n.setUTCSeconds(0,0)},(n,a)=>{n.setTime(+n+a*Bs)},(n,a)=>(a-n)/Bs,n=>n.getUTCMinutes()),Q$=yx.range,vx=Ur(n=>{n.setTime(n-n.getMilliseconds()-n.getSeconds()*Vl-n.getMinutes()*Bs)},(n,a)=>{n.setTime(+n+a*Ul)},(n,a)=>(a-n)/Ul,n=>n.getHours()),eG=vx.range,xx=Ur(n=>{n.setUTCMinutes(0,0,0)},(n,a)=>{n.setTime(+n+a*Ul)},(n,a)=>(a-n)/Ul,n=>n.getUTCHours()),tG=xx.range,Xd=Ur(n=>n.setHours(0,0,0,0),(n,a)=>n.setDate(n.getDate()+a),(n,a)=>(a-n-(a.getTimezoneOffset()-n.getTimezoneOffset())*Bs)/Hl,n=>n.getDate()-1),nG=Xd.range,X_=Ur(n=>{n.setUTCHours(0,0,0,0)},(n,a)=>{n.setUTCDate(n.getUTCDate()+a)},(n,a)=>(a-n)/Hl,n=>n.getUTCDate()-1),iG=X_.range,NT=Ur(n=>{n.setUTCHours(0,0,0,0)},(n,a)=>{n.setUTCDate(n.getUTCDate()+a)},(n,a)=>(a-n)/Hl,n=>Math.floor(n/Hl)),rG=NT.range;function Oh(n){return Ur(a=>{a.setDate(a.getDate()-(a.getDay()+7-n)%7),a.setHours(0,0,0,0)},(a,u)=>{a.setDate(a.getDate()+u*7)},(a,u)=>(u-a-(u.getTimezoneOffset()-a.getTimezoneOffset())*Bs)/BT)}const Nd=Oh(0),R_=Oh(1),KR=Oh(2),JR=Oh(3),Ph=Oh(4),QR=Oh(5),eD=Oh(6),tC=Nd.range,oG=R_.range,sG=KR.range,aG=JR.range,lG=Ph.range,cG=QR.range,uG=eD.range;function Fh(n){return Ur(a=>{a.setUTCDate(a.getUTCDate()-(a.getUTCDay()+7-n)%7),a.setUTCHours(0,0,0,0)},(a,u)=>{a.setUTCDate(a.getUTCDate()+u*7)},(a,u)=>(u-a)/BT)}const Vd=Fh(0),D_=Fh(1),tD=Fh(2),nD=Fh(3),zh=Fh(4),iD=Fh(5),rD=Fh(6),nC=Vd.range,hG=D_.range,fG=tD.range,dG=nD.range,pG=zh.range,mG=iD.range,_G=rD.range,bx=Ur(n=>{n.setDate(1),n.setHours(0,0,0,0)},(n,a)=>{n.setMonth(n.getMonth()+a)},(n,a)=>a.getMonth()-n.getMonth()+(a.getFullYear()-n.getFullYear())*12,n=>n.getMonth()),gG=bx.range,wx=Ur(n=>{n.setUTCDate(1),n.setUTCHours(0,0,0,0)},(n,a)=>{n.setUTCMonth(n.getUTCMonth()+a)},(n,a)=>a.getUTCMonth()-n.getUTCMonth()+(a.getUTCFullYear()-n.getUTCFullYear())*12,n=>n.getUTCMonth()),yG=wx.range,Za=Ur(n=>{n.setMonth(0,1),n.setHours(0,0,0,0)},(n,a)=>{n.setFullYear(n.getFullYear()+a)},(n,a)=>a.getFullYear()-n.getFullYear(),n=>n.getFullYear());Za.every=n=>!isFinite(n=Math.floor(n))||!(n>0)?null:Ur(a=>{a.setFullYear(Math.floor(a.getFullYear()/n)*n),a.setMonth(0,1),a.setHours(0,0,0,0)},(a,u)=>{a.setFullYear(a.getFullYear()+u*n)});const vG=Za.range,Wa=Ur(n=>{n.setUTCMonth(0,1),n.setUTCHours(0,0,0,0)},(n,a)=>{n.setUTCFullYear(n.getUTCFullYear()+a)},(n,a)=>a.getUTCFullYear()-n.getUTCFullYear(),n=>n.getUTCFullYear());Wa.every=n=>!isFinite(n=Math.floor(n))||!(n>0)?null:Ur(a=>{a.setUTCFullYear(Math.floor(a.getUTCFullYear()/n)*n),a.setUTCMonth(0,1),a.setUTCHours(0,0,0,0)},(a,u)=>{a.setUTCFullYear(a.getUTCFullYear()+u*n)});const xG=Wa.range;function oD(n,a,u,m,y,x){const E=[[jl,1,Vl],[jl,5,5*Vl],[jl,15,15*Vl],[jl,30,30*Vl],[x,1,Bs],[x,5,5*Bs],[x,15,15*Bs],[x,30,30*Bs],[y,1,Ul],[y,3,3*Ul],[y,6,6*Ul],[y,12,12*Ul],[m,1,Hl],[m,2,2*Hl],[u,1,BT],[a,1,Q3],[a,3,3*Q3],[n,1,mw]];function r(M,L,V){const k=L<M;k&&([M,L]=[L,M]);const j=V&&typeof V.range=="function"?V:P(M,L,V),te=j?j.range(M,+L+1):[];return k?te.reverse():te}function P(M,L,V){const k=Math.abs(L-M)/V,j=Hv(([,,Q])=>Q).right(E,k);if(j===E.length)return n.every(Hy(M/mw,L/mw,V));if(j===0)return Bd.every(Math.max(Hy(M,L,V),1));const[te,J]=E[k/E[j-1][2]<E[j][2]/k?j-1:j];return te.every(J)}return[r,P]}const[sD,aD]=oD(Wa,wx,Vd,NT,xx,yx),[lD,cD]=oD(Za,bx,Nd,Xd,vx,gx);function _w(n){if(0<=n.y&&n.y<100){var a=new Date(-1,n.m,n.d,n.H,n.M,n.S,n.L);return a.setFullYear(n.y),a}return new Date(n.y,n.m,n.d,n.H,n.M,n.S,n.L)}function gw(n){if(0<=n.y&&n.y<100){var a=new Date(Date.UTC(-1,n.m,n.d,n.H,n.M,n.S,n.L));return a.setUTCFullYear(n.y),a}return new Date(Date.UTC(n.y,n.m,n.d,n.H,n.M,n.S,n.L))}function qm(n,a,u){return{y:n,m:a,d:u,H:0,M:0,S:0,L:0}}function uD(n){var a=n.dateTime,u=n.date,m=n.time,y=n.periods,x=n.days,E=n.shortDays,r=n.months,P=n.shortMonths,M=Hm(y),L=Zm(y),V=Hm(x),k=Zm(x),j=Hm(E),te=Zm(E),J=Hm(r),Q=Zm(r),ee=Hm(P),ue=Zm(P),ce={a:bt,A:Ht,b:Dt,B:Lt,c:null,d:lC,e:lC,f:$G,g:QG,G:tq,H:VG,I:UG,j:jG,L:hD,m:GG,M:qG,p:rn,q:yn,Q:hC,s:fC,S:HG,u:ZG,U:WG,V:XG,w:YG,W:KG,x:null,X:null,y:JG,Y:eq,Z:nq,"%":uC},se={a:pi,A:ti,b:hn,B:Nn,c:null,d:cC,e:cC,f:sq,g:_q,G:yq,H:iq,I:rq,j:oq,L:dD,m:aq,M:lq,p:Pn,q:Gi,Q:hC,s:fC,S:cq,u:uq,U:hq,V:fq,w:dq,W:pq,x:null,X:null,y:mq,Y:gq,Z:vq,"%":uC},Ae={a:tt,A:Be,b:Rt,B:ut,c:Pe,d:sC,e:sC,f:OG,g:oC,G:rC,H:aC,I:aC,j:RG,L:kG,m:zG,M:DG,p:rt,q:PG,Q:BG,s:NG,S:LG,u:EG,U:AG,V:IG,w:SG,W:MG,x:Ve,X:qe,y:oC,Y:rC,Z:CG,"%":FG};ce.x=De(u,ce),ce.X=De(m,ce),ce.c=De(a,ce),se.x=De(u,se),se.X=De(m,se),se.c=De(a,se);function De(Ct,fn){return function(Tn){var It=[],dn=-1,$n=0,Qi=Ct.length,bi,vn,wi;for(Tn instanceof Date||(Tn=new Date(+Tn));++dn<Qi;)Ct.charCodeAt(dn)===37&&(It.push(Ct.slice($n,dn)),(vn=iC[bi=Ct.charAt(++dn)])!=null?bi=Ct.charAt(++dn):vn=bi==="e"?" ":"0",(wi=fn[bi])&&(bi=wi(Tn,vn)),It.push(bi),$n=dn+1);return It.push(Ct.slice($n,dn)),It.join("")}}function Qe(Ct,fn){return function(Tn){var It=qm(1900,void 0,1),dn=nt(It,Ct,Tn+="",0),$n,Qi;if(dn!=Tn.length)return null;if("Q"in It)return new Date(It.Q);if("s"in It)return new Date(It.s*1e3+("L"in It?It.L:0));if(fn&&!("Z"in It)&&(It.Z=0),"p"in It&&(It.H=It.H%12+It.p*12),It.m===void 0&&(It.m="q"in It?It.q:0),"V"in It){if(It.V<1||It.V>53)return null;"w"in It||(It.w=1),"Z"in It?($n=gw(qm(It.y,0,1)),Qi=$n.getUTCDay(),$n=Qi>4||Qi===0?D_.ceil($n):D_($n),$n=X_.offset($n,(It.V-1)*7),It.y=$n.getUTCFullYear(),It.m=$n.getUTCMonth(),It.d=$n.getUTCDate()+(It.w+6)%7):($n=_w(qm(It.y,0,1)),Qi=$n.getDay(),$n=Qi>4||Qi===0?R_.ceil($n):R_($n),$n=Xd.offset($n,(It.V-1)*7),It.y=$n.getFullYear(),It.m=$n.getMonth(),It.d=$n.getDate()+(It.w+6)%7)}else("W"in It||"U"in It)&&("w"in It||(It.w="u"in It?It.u%7:"W"in It?1:0),Qi="Z"in It?gw(qm(It.y,0,1)).getUTCDay():_w(qm(It.y,0,1)).getDay(),It.m=0,It.d="W"in It?(It.w+6)%7+It.W*7-(Qi+5)%7:It.w+It.U*7-(Qi+6)%7);return"Z"in It?(It.H+=It.Z/100|0,It.M+=It.Z%100,gw(It)):_w(It)}}function nt(Ct,fn,Tn,It){for(var dn=0,$n=fn.length,Qi=Tn.length,bi,vn;dn<$n;){if(It>=Qi)return-1;if(bi=fn.charCodeAt(dn++),bi===37){if(bi=fn.charAt(dn++),vn=Ae[bi in iC?fn.charAt(dn++):bi],!vn||(It=vn(Ct,Tn,It))<0)return-1}else if(bi!=Tn.charCodeAt(It++))return-1}return It}function rt(Ct,fn,Tn){var It=M.exec(fn.slice(Tn));return It?(Ct.p=L.get(It[0].toLowerCase()),Tn+It[0].length):-1}function tt(Ct,fn,Tn){var It=j.exec(fn.slice(Tn));return It?(Ct.w=te.get(It[0].toLowerCase()),Tn+It[0].length):-1}function Be(Ct,fn,Tn){var It=V.exec(fn.slice(Tn));return It?(Ct.w=k.get(It[0].toLowerCase()),Tn+It[0].length):-1}function Rt(Ct,fn,Tn){var It=ee.exec(fn.slice(Tn));return It?(Ct.m=ue.get(It[0].toLowerCase()),Tn+It[0].length):-1}function ut(Ct,fn,Tn){var It=J.exec(fn.slice(Tn));return It?(Ct.m=Q.get(It[0].toLowerCase()),Tn+It[0].length):-1}function Pe(Ct,fn,Tn){return nt(Ct,a,fn,Tn)}function Ve(Ct,fn,Tn){return nt(Ct,u,fn,Tn)}function qe(Ct,fn,Tn){return nt(Ct,m,fn,Tn)}function bt(Ct){return E[Ct.getDay()]}function Ht(Ct){return x[Ct.getDay()]}function Dt(Ct){return P[Ct.getMonth()]}function Lt(Ct){return r[Ct.getMonth()]}function rn(Ct){return y[+(Ct.getHours()>=12)]}function yn(Ct){return 1+~~(Ct.getMonth()/3)}function pi(Ct){return E[Ct.getUTCDay()]}function ti(Ct){return x[Ct.getUTCDay()]}function hn(Ct){return P[Ct.getUTCMonth()]}function Nn(Ct){return r[Ct.getUTCMonth()]}function Pn(Ct){return y[+(Ct.getUTCHours()>=12)]}function Gi(Ct){return 1+~~(Ct.getUTCMonth()/3)}return{format:function(Ct){var fn=De(Ct+="",ce);return fn.toString=function(){return Ct},fn},parse:function(Ct){var fn=Qe(Ct+="",!1);return fn.toString=function(){return Ct},fn},utcFormat:function(Ct){var fn=De(Ct+="",se);return fn.toString=function(){return Ct},fn},utcParse:function(Ct){var fn=Qe(Ct+="",!0);return fn.toString=function(){return Ct},fn}}}var iC={"-":"",_:" ",0:"0"},oo=/^\s*\d+/,bG=/^%/,wG=/[\\^$*+?|[\]().{}]/g;function Ji(n,a,u){var m=n<0?"-":"",y=(m?-n:n)+"",x=y.length;return m+(x<u?new Array(u-x+1).join(a)+y:y)}function TG(n){return n.replace(wG,"\\$&")}function Hm(n){return new RegExp("^(?:"+n.map(TG).join("|")+")","i")}function Zm(n){return new Map(n.map((a,u)=>[a.toLowerCase(),u]))}function SG(n,a,u){var m=oo.exec(a.slice(u,u+1));return m?(n.w=+m[0],u+m[0].length):-1}function EG(n,a,u){var m=oo.exec(a.slice(u,u+1));return m?(n.u=+m[0],u+m[0].length):-1}function AG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.U=+m[0],u+m[0].length):-1}function IG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.V=+m[0],u+m[0].length):-1}function MG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.W=+m[0],u+m[0].length):-1}function rC(n,a,u){var m=oo.exec(a.slice(u,u+4));return m?(n.y=+m[0],u+m[0].length):-1}function oC(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.y=+m[0]+(+m[0]>68?1900:2e3),u+m[0].length):-1}function CG(n,a,u){var m=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(a.slice(u,u+6));return m?(n.Z=m[1]?0:-(m[2]+(m[3]||"00")),u+m[0].length):-1}function PG(n,a,u){var m=oo.exec(a.slice(u,u+1));return m?(n.q=m[0]*3-3,u+m[0].length):-1}function zG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.m=m[0]-1,u+m[0].length):-1}function sC(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.d=+m[0],u+m[0].length):-1}function RG(n,a,u){var m=oo.exec(a.slice(u,u+3));return m?(n.m=0,n.d=+m[0],u+m[0].length):-1}function aC(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.H=+m[0],u+m[0].length):-1}function DG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.M=+m[0],u+m[0].length):-1}function LG(n,a,u){var m=oo.exec(a.slice(u,u+2));return m?(n.S=+m[0],u+m[0].length):-1}function kG(n,a,u){var m=oo.exec(a.slice(u,u+3));return m?(n.L=+m[0],u+m[0].length):-1}function OG(n,a,u){var m=oo.exec(a.slice(u,u+6));return m?(n.L=Math.floor(m[0]/1e3),u+m[0].length):-1}function FG(n,a,u){var m=bG.exec(a.slice(u,u+1));return m?u+m[0].length:-1}function BG(n,a,u){var m=oo.exec(a.slice(u));return m?(n.Q=+m[0],u+m[0].length):-1}function NG(n,a,u){var m=oo.exec(a.slice(u));return m?(n.s=+m[0],u+m[0].length):-1}function lC(n,a){return Ji(n.getDate(),a,2)}function VG(n,a){return Ji(n.getHours(),a,2)}function UG(n,a){return Ji(n.getHours()%12||12,a,2)}function jG(n,a){return Ji(1+Xd.count(Za(n),n),a,3)}function hD(n,a){return Ji(n.getMilliseconds(),a,3)}function $G(n,a){return hD(n,a)+"000"}function GG(n,a){return Ji(n.getMonth()+1,a,2)}function qG(n,a){return Ji(n.getMinutes(),a,2)}function HG(n,a){return Ji(n.getSeconds(),a,2)}function ZG(n){var a=n.getDay();return a===0?7:a}function WG(n,a){return Ji(Nd.count(Za(n)-1,n),a,2)}function fD(n){var a=n.getDay();return a>=4||a===0?Ph(n):Ph.ceil(n)}function XG(n,a){return n=fD(n),Ji(Ph.count(Za(n),n)+(Za(n).getDay()===4),a,2)}function YG(n){return n.getDay()}function KG(n,a){return Ji(R_.count(Za(n)-1,n),a,2)}function JG(n,a){return Ji(n.getFullYear()%100,a,2)}function QG(n,a){return n=fD(n),Ji(n.getFullYear()%100,a,2)}function eq(n,a){return Ji(n.getFullYear()%1e4,a,4)}function tq(n,a){var u=n.getDay();return n=u>=4||u===0?Ph(n):Ph.ceil(n),Ji(n.getFullYear()%1e4,a,4)}function nq(n){var a=n.getTimezoneOffset();return(a>0?"-":(a*=-1,"+"))+Ji(a/60|0,"0",2)+Ji(a%60,"0",2)}function cC(n,a){return Ji(n.getUTCDate(),a,2)}function iq(n,a){return Ji(n.getUTCHours(),a,2)}function rq(n,a){return Ji(n.getUTCHours()%12||12,a,2)}function oq(n,a){return Ji(1+X_.count(Wa(n),n),a,3)}function dD(n,a){return Ji(n.getUTCMilliseconds(),a,3)}function sq(n,a){return dD(n,a)+"000"}function aq(n,a){return Ji(n.getUTCMonth()+1,a,2)}function lq(n,a){return Ji(n.getUTCMinutes(),a,2)}function cq(n,a){return Ji(n.getUTCSeconds(),a,2)}function uq(n){var a=n.getUTCDay();return a===0?7:a}function hq(n,a){return Ji(Vd.count(Wa(n)-1,n),a,2)}function pD(n){var a=n.getUTCDay();return a>=4||a===0?zh(n):zh.ceil(n)}function fq(n,a){return n=pD(n),Ji(zh.count(Wa(n),n)+(Wa(n).getUTCDay()===4),a,2)}function dq(n){return n.getUTCDay()}function pq(n,a){return Ji(D_.count(Wa(n)-1,n),a,2)}function mq(n,a){return Ji(n.getUTCFullYear()%100,a,2)}function _q(n,a){return n=pD(n),Ji(n.getUTCFullYear()%100,a,2)}function gq(n,a){return Ji(n.getUTCFullYear()%1e4,a,4)}function yq(n,a){var u=n.getUTCDay();return n=u>=4||u===0?zh(n):zh.ceil(n),Ji(n.getUTCFullYear()%1e4,a,4)}function vq(){return"+0000"}function uC(){return"%"}function hC(n){return+n}function fC(n){return Math.floor(+n/1e3)}var pd,VT,mD,Tx,UT;_D({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});function _D(n){return pd=uD(n),VT=pd.format,mD=pd.parse,Tx=pd.utcFormat,UT=pd.utcParse,pd}var gD="%Y-%m-%dT%H:%M:%S.%LZ";function xq(n){return n.toISOString()}var bq=Date.prototype.toISOString?xq:Tx(gD);function wq(n){var a=new Date(n);return isNaN(a)?null:a}var Tq=+new Date("2000-01-01T00:00:00.000Z")?wq:UT(gD);function Sq(n){return new Date(n)}function Eq(n){return n instanceof Date?+n:+new Date(+n)}function jT(n,a,u,m,y,x,E,r,P,M){var L=DT(),V=L.invert,k=L.domain,j=M(".%L"),te=M(":%S"),J=M("%I:%M"),Q=M("%I %p"),ee=M("%a %d"),ue=M("%b %d"),ce=M("%B"),se=M("%Y");function Ae(De){return(P(De)<De?j:r(De)<De?te:E(De)<De?J:x(De)<De?Q:m(De)<De?y(De)<De?ee:ue:u(De)<De?ce:se)(De)}return L.invert=function(De){return new Date(V(De))},L.domain=function(De){return arguments.length?k(Array.from(De,Eq)):k().map(Sq)},L.ticks=function(De){var Qe=k();return n(Qe[0],Qe[Qe.length-1],De??10)},L.tickFormat=function(De,Qe){return Qe==null?Ae:M(Qe)},L.nice=function(De){var Qe=k();return(!De||typeof De.range!="function")&&(De=a(Qe[0],Qe[Qe.length-1],De??10)),De?k(GR(Qe,De)):L},L.copy=function(){return W_(L,jT(n,a,u,m,y,x,E,r,P,M))},L}function Aq(){return Vs.apply(jT(lD,cD,Za,bx,Nd,Xd,vx,gx,jl,VT).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)}function Iq(){return Vs.apply(jT(sD,aD,Wa,wx,Vd,X_,xx,yx,jl,Tx).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)]),arguments)}function Sx(){var n=0,a=1,u,m,y,x,E=Fo,r=!1,P;function M(V){return V==null||isNaN(V=+V)?P:E(y===0?.5:(V=(x(V)-u)*y,r?Math.max(0,Math.min(1,V)):V))}M.domain=function(V){return arguments.length?([n,a]=V,u=x(n=+n),m=x(a=+a),y=u===m?0:1/(m-u),M):[n,a]},M.clamp=function(V){return arguments.length?(r=!!V,M):r},M.interpolator=function(V){return arguments.length?(E=V,M):E};function L(V){return function(k){var j,te;return arguments.length?([j,te]=k,E=V(j,te),M):[E(0),E(1)]}}return M.range=L(ru),M.rangeRound=L(ix),M.unknown=function(V){return arguments.length?(P=V,M):P},function(V){return x=V,u=V(n),m=V(a),y=u===m?0:1/(m-u),M}}function su(n,a){return a.domain(n.domain()).interpolator(n.interpolator()).clamp(n.clamp()).unknown(n.unknown())}function yD(){var n=ou(Sx()(Fo));return n.copy=function(){return su(n,yD())},Wl.apply(n,arguments)}function vD(){var n=LT(Sx()).domain([1,10]);return n.copy=function(){return su(n,vD()).base(n.base())},Wl.apply(n,arguments)}function xD(){var n=kT(Sx());return n.copy=function(){return su(n,xD()).constant(n.constant())},Wl.apply(n,arguments)}function $T(){var n=OT(Sx());return n.copy=function(){return su(n,$T()).exponent(n.exponent())},Wl.apply(n,arguments)}function Mq(){return $T.apply(null,arguments).exponent(.5)}function bD(){var n=[],a=Fo;function u(m){if(m!=null&&!isNaN(m=+m))return a((Kc(n,m,1)-1)/(n.length-1))}return u.domain=function(m){if(!arguments.length)return n.slice();n=[];for(let y of m)y!=null&&!isNaN(y=+y)&&n.push(y);return n.sort(Ir),u},u.interpolator=function(m){return arguments.length?(a=m,u):a},u.range=function(){return n.map((m,y)=>a(y/(n.length-1)))},u.quantiles=function(m){return Array.from({length:m+1},(y,x)=>v_(n,x/m))},u.copy=function(){return bD(a).domain(n)},Wl.apply(u,arguments)}function Ex(){var n=0,a=.5,u=1,m=1,y,x,E,r,P,M=Fo,L,V=!1,k;function j(J){return isNaN(J=+J)?k:(J=.5+((J=+L(J))-x)*(m*J<m*x?r:P),M(V?Math.max(0,Math.min(1,J)):J))}j.domain=function(J){return arguments.length?([n,a,u]=J,y=L(n=+n),x=L(a=+a),E=L(u=+u),r=y===x?0:.5/(x-y),P=x===E?0:.5/(E-x),m=x<y?-1:1,j):[n,a,u]},j.clamp=function(J){return arguments.length?(V=!!J,j):V},j.interpolator=function(J){return arguments.length?(M=J,j):M};function te(J){return function(Q){var ee,ue,ce;return arguments.length?([ee,ue,ce]=Q,M=pz(J,[ee,ue,ce]),j):[M(0),M(.5),M(1)]}}return j.range=te(ru),j.rangeRound=te(ix),j.unknown=function(J){return arguments.length?(k=J,j):k},function(J){return L=J,y=J(n),x=J(a),E=J(u),r=y===x?0:.5/(x-y),P=x===E?0:.5/(E-x),m=x<y?-1:1,j}}function wD(){var n=ou(Ex()(Fo));return n.copy=function(){return su(n,wD())},Wl.apply(n,arguments)}function TD(){var n=LT(Ex()).domain([.1,1,10]);return n.copy=function(){return su(n,TD()).base(n.base())},Wl.apply(n,arguments)}function SD(){var n=kT(Ex());return n.copy=function(){return su(n,SD()).constant(n.constant())},Wl.apply(n,arguments)}function GT(){var n=OT(Ex());return n.copy=function(){return su(n,GT()).exponent(n.exponent())},Wl.apply(n,arguments)}function Cq(){return GT.apply(null,arguments).exponent(.5)}function mi(n){for(var a=n.length/6|0,u=new Array(a),m=0;m<a;)u[m]="#"+n.slice(m*6,++m*6);return u}const Pq=mi("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),zq=mi("7fc97fbeaed4fdc086ffff99386cb0f0027fbf5b17666666"),Rq=mi("1b9e77d95f027570b3e7298a66a61ee6ab02a6761d666666"),Dq=mi("4269d0efb118ff725c6cc5b03ca951ff8ab7a463f297bbf59c6b4e9498a0"),Lq=mi("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928"),kq=mi("fbb4aeb3cde3ccebc5decbe4fed9a6ffffcce5d8bdfddaecf2f2f2"),Oq=mi("b3e2cdfdcdaccbd5e8f4cae4e6f5c9fff2aef1e2cccccccc"),Fq=mi("e41a1c377eb84daf4a984ea3ff7f00ffff33a65628f781bf999999"),Bq=mi("66c2a5fc8d628da0cbe78ac3a6d854ffd92fe5c494b3b3b3"),Nq=mi("8dd3c7ffffb3bebadafb807280b1d3fdb462b3de69fccde5d9d9d9bc80bdccebc5ffed6f"),Vq=mi("4e79a7f28e2ce1575976b7b259a14fedc949af7aa1ff9da79c755fbab0ab"),ur=n=>tz(n[n.length-1]);var ED=new Array(3).concat("d8b365f5f5f55ab4ac","a6611adfc27d80cdc1018571","a6611adfc27df5f5f580cdc1018571","8c510ad8b365f6e8c3c7eae55ab4ac01665e","8c510ad8b365f6e8c3f5f5f5c7eae55ab4ac01665e","8c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e","8c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e","5430058c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e003c30","5430058c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e003c30").map(mi);const Uq=ur(ED);var AD=new Array(3).concat("af8dc3f7f7f77fbf7b","7b3294c2a5cfa6dba0008837","7b3294c2a5cff7f7f7a6dba0008837","762a83af8dc3e7d4e8d9f0d37fbf7b1b7837","762a83af8dc3e7d4e8f7f7f7d9f0d37fbf7b1b7837","762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b7837","762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b7837","40004b762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b783700441b","40004b762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b783700441b").map(mi);const jq=ur(AD);var ID=new Array(3).concat("e9a3c9f7f7f7a1d76a","d01c8bf1b6dab8e1864dac26","d01c8bf1b6daf7f7f7b8e1864dac26","c51b7de9a3c9fde0efe6f5d0a1d76a4d9221","c51b7de9a3c9fde0eff7f7f7e6f5d0a1d76a4d9221","c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221","c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221","8e0152c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221276419","8e0152c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221276419").map(mi);const $q=ur(ID);var MD=new Array(3).concat("998ec3f7f7f7f1a340","5e3c99b2abd2fdb863e66101","5e3c99b2abd2f7f7f7fdb863e66101","542788998ec3d8daebfee0b6f1a340b35806","542788998ec3d8daebf7f7f7fee0b6f1a340b35806","5427888073acb2abd2d8daebfee0b6fdb863e08214b35806","5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b35806","2d004b5427888073acb2abd2d8daebfee0b6fdb863e08214b358067f3b08","2d004b5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b358067f3b08").map(mi);const Gq=ur(MD);var CD=new Array(3).concat("ef8a62f7f7f767a9cf","ca0020f4a58292c5de0571b0","ca0020f4a582f7f7f792c5de0571b0","b2182bef8a62fddbc7d1e5f067a9cf2166ac","b2182bef8a62fddbc7f7f7f7d1e5f067a9cf2166ac","b2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac","b2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac","67001fb2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac053061","67001fb2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac053061").map(mi);const qq=ur(CD);var PD=new Array(3).concat("ef8a62ffffff999999","ca0020f4a582bababa404040","ca0020f4a582ffffffbababa404040","b2182bef8a62fddbc7e0e0e09999994d4d4d","b2182bef8a62fddbc7ffffffe0e0e09999994d4d4d","b2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d","b2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d","67001fb2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d1a1a1a","67001fb2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d1a1a1a").map(mi);const Hq=ur(PD);var zD=new Array(3).concat("fc8d59ffffbf91bfdb","d7191cfdae61abd9e92c7bb6","d7191cfdae61ffffbfabd9e92c7bb6","d73027fc8d59fee090e0f3f891bfdb4575b4","d73027fc8d59fee090ffffbfe0f3f891bfdb4575b4","d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4","d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4","a50026d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4313695","a50026d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4313695").map(mi);const Zq=ur(zD);var RD=new Array(3).concat("fc8d59ffffbf91cf60","d7191cfdae61a6d96a1a9641","d7191cfdae61ffffbfa6d96a1a9641","d73027fc8d59fee08bd9ef8b91cf601a9850","d73027fc8d59fee08bffffbfd9ef8b91cf601a9850","d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850","d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850","a50026d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850006837","a50026d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850006837").map(mi);const Wq=ur(RD);var DD=new Array(3).concat("fc8d59ffffbf99d594","d7191cfdae61abdda42b83ba","d7191cfdae61ffffbfabdda42b83ba","d53e4ffc8d59fee08be6f59899d5943288bd","d53e4ffc8d59fee08bffffbfe6f59899d5943288bd","d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd","d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd","9e0142d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd5e4fa2","9e0142d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd5e4fa2").map(mi);const Xq=ur(DD);var LD=new Array(3).concat("e5f5f999d8c92ca25f","edf8fbb2e2e266c2a4238b45","edf8fbb2e2e266c2a42ca25f006d2c","edf8fbccece699d8c966c2a42ca25f006d2c","edf8fbccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45006d2c00441b").map(mi);const Yq=ur(LD);var kD=new Array(3).concat("e0ecf49ebcda8856a7","edf8fbb3cde38c96c688419d","edf8fbb3cde38c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d810f7c4d004b").map(mi);const Kq=ur(kD);var OD=new Array(3).concat("e0f3dba8ddb543a2ca","f0f9e8bae4bc7bccc42b8cbe","f0f9e8bae4bc7bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe0868ac084081").map(mi);const Jq=ur(OD);var FD=new Array(3).concat("fee8c8fdbb84e34a33","fef0d9fdcc8afc8d59d7301f","fef0d9fdcc8afc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301fb300007f0000").map(mi);const Qq=ur(FD);var BD=new Array(3).concat("ece2f0a6bddb1c9099","f6eff7bdc9e167a9cf02818a","f6eff7bdc9e167a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016c59014636").map(mi);const eH=ur(BD);var ND=new Array(3).concat("ece7f2a6bddb2b8cbe","f1eef6bdc9e174a9cf0570b0","f1eef6bdc9e174a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0045a8d023858").map(mi);const tH=ur(ND);var VD=new Array(3).concat("e7e1efc994c7dd1c77","f1eef6d7b5d8df65b0ce1256","f1eef6d7b5d8df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125698004367001f").map(mi);const nH=ur(VD);var UD=new Array(3).concat("fde0ddfa9fb5c51b8a","feebe2fbb4b9f768a1ae017e","feebe2fbb4b9f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a017749006a").map(mi);const iH=ur(UD);var jD=new Array(3).concat("edf8b17fcdbb2c7fb8","ffffcca1dab441b6c4225ea8","ffffcca1dab441b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea8253494081d58").map(mi);const rH=ur(jD);var $D=new Array(3).concat("f7fcb9addd8e31a354","ffffccc2e69978c679238443","ffffccc2e69978c67931a354006837","ffffccd9f0a3addd8e78c67931a354006837","ffffccd9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443006837004529").map(mi);const oH=ur($D);var GD=new Array(3).concat("fff7bcfec44fd95f0e","ffffd4fed98efe9929cc4c02","ffffd4fed98efe9929d95f0e993404","ffffd4fee391fec44ffe9929d95f0e993404","ffffd4fee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c02993404662506").map(mi);const sH=ur(GD);var qD=new Array(3).concat("ffeda0feb24cf03b20","ffffb2fecc5cfd8d3ce31a1c","ffffb2fecc5cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cbd0026800026").map(mi);const aH=ur(qD);var HD=new Array(3).concat("deebf79ecae13182bd","eff3ffbdd7e76baed62171b5","eff3ffbdd7e76baed63182bd08519c","eff3ffc6dbef9ecae16baed63182bd08519c","eff3ffc6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b508519c08306b").map(mi);const lH=ur(HD);var ZD=new Array(3).concat("e5f5e0a1d99b31a354","edf8e9bae4b374c476238b45","edf8e9bae4b374c47631a354006d2c","edf8e9c7e9c0a1d99b74c47631a354006d2c","edf8e9c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45006d2c00441b").map(mi);const cH=ur(ZD);var WD=new Array(3).concat("f0f0f0bdbdbd636363","f7f7f7cccccc969696525252","f7f7f7cccccc969696636363252525","f7f7f7d9d9d9bdbdbd969696636363252525","f7f7f7d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525000000").map(mi);const uH=ur(WD);var XD=new Array(3).concat("efedf5bcbddc756bb1","f2f0f7cbc9e29e9ac86a51a3","f2f0f7cbc9e29e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a354278f3f007d").map(mi);const hH=ur(XD);var YD=new Array(3).concat("fee0d2fc9272de2d26","fee5d9fcae91fb6a4acb181d","fee5d9fcae91fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181da50f1567000d").map(mi);const fH=ur(YD);var KD=new Array(3).concat("fee6cefdae6be6550d","feeddefdbe85fd8d3cd94701","feeddefdbe85fd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d94801a636037f2704").map(mi);const dH=ur(KD);function pH(n){return n=Math.max(0,Math.min(1,n)),"rgb("+Math.max(0,Math.min(255,Math.round(-4.54-n*(35.34-n*(2381.73-n*(6402.7-n*(7024.72-n*2710.57)))))))+", "+Math.max(0,Math.min(255,Math.round(32.49+n*(170.73+n*(52.82-n*(131.46-n*(176.58-n*67.37)))))))+", "+Math.max(0,Math.min(255,Math.round(81.24+n*(442.36-n*(2482.43-n*(6167.24-n*(6614.94-n*2475.67)))))))+")"}const mH=rx(ha(300,.5,0),ha(-240,.5,1));var _H=rx(ha(-100,.75,.35),ha(80,1.5,.8)),gH=rx(ha(260,.75,.35),ha(80,1.5,.8)),my=ha();function yH(n){(n<0||n>1)&&(n-=Math.floor(n));var a=Math.abs(n-.5);return my.h=360*n-100,my.s=1.5-1.5*a,my.l=.8-.9*a,my+""}var _y=Pd(),vH=Math.PI/3,xH=Math.PI*2/3;function bH(n){var a;return n=(.5-n)*Math.PI,_y.r=255*(a=Math.sin(n))*a,_y.g=255*(a=Math.sin(n+vH))*a,_y.b=255*(a=Math.sin(n+xH))*a,_y+""}function wH(n){return n=Math.max(0,Math.min(1,n)),"rgb("+Math.max(0,Math.min(255,Math.round(34.61+n*(1172.33-n*(10793.56-n*(33300.12-n*(38394.49-n*14825.05)))))))+", "+Math.max(0,Math.min(255,Math.round(23.31+n*(557.33+n*(1225.33-n*(3574.96-n*(1073.77+n*707.56)))))))+", "+Math.max(0,Math.min(255,Math.round(27.2+n*(3211.1-n*(15327.97-n*(27814-n*(22569.18-n*6838.66)))))))+")"}function Ax(n){var a=n.length;return function(u){return n[Math.max(0,Math.min(a-1,Math.floor(u*a)))]}}const TH=Ax(mi("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725"));var SH=Ax(mi("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf")),EH=Ax(mi("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4")),AH=Ax(mi("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921"));function di(n){return function(){return n}}const dC=Math.abs,So=Math.atan2,Ol=Math.cos,IH=Math.max,Sd=Math.min,ns=Math.sin,_r=Math.sqrt,Eo=1e-12,eu=Math.PI,zv=eu/2,Wc=2*eu;function MH(n){return n>1?0:n<-1?eu:Math.acos(n)}function pC(n){return n>=1?zv:n<=-1?-zv:Math.asin(n)}function Y_(n){let a=3;return n.digits=function(u){if(!arguments.length)return a;if(u==null)a=null;else{const m=Math.floor(u);if(!(m>=0))throw new RangeError(`invalid digits: ${u}`);a=m}return n},()=>new U_(a)}function CH(n){return n.innerRadius}function PH(n){return n.outerRadius}function zH(n){return n.startAngle}function RH(n){return n.endAngle}function DH(n){return n&&n.padAngle}function LH(n,a,u,m,y,x,E,r){var P=u-n,M=m-a,L=E-y,V=r-x,k=V*P-L*M;if(!(k*k<Eo))return k=(L*(a-x)-V*(n-y))/k,[n+k*P,a+k*M]}function gy(n,a,u,m,y,x,E){var r=n-u,P=a-m,M=(E?x:-x)/_r(r*r+P*P),L=M*P,V=-M*r,k=n+L,j=a+V,te=u+L,J=m+V,Q=(k+te)/2,ee=(j+J)/2,ue=te-k,ce=J-j,se=ue*ue+ce*ce,Ae=y-x,De=k*J-te*j,Qe=(ce<0?-1:1)*_r(IH(0,Ae*Ae*se-De*De)),nt=(De*ce-ue*Qe)/se,rt=(-De*ue-ce*Qe)/se,tt=(De*ce+ue*Qe)/se,Be=(-De*ue+ce*Qe)/se,Rt=nt-Q,ut=rt-ee,Pe=tt-Q,Ve=Be-ee;return Rt*Rt+ut*ut>Pe*Pe+Ve*Ve&&(nt=tt,rt=Be),{cx:nt,cy:rt,x01:-L,y01:-V,x11:nt*(y/Ae-1),y11:rt*(y/Ae-1)}}function kH(){var n=CH,a=PH,u=di(0),m=null,y=zH,x=RH,E=DH,r=null,P=Y_(M);function M(){var L,V,k=+n.apply(this,arguments),j=+a.apply(this,arguments),te=y.apply(this,arguments)-zv,J=x.apply(this,arguments)-zv,Q=dC(J-te),ee=J>te;if(r||(r=L=P()),j<k&&(V=j,j=k,k=V),!(j>Eo))r.moveTo(0,0);else if(Q>Wc-Eo)r.moveTo(j*Ol(te),j*ns(te)),r.arc(0,0,j,te,J,!ee),k>Eo&&(r.moveTo(k*Ol(J),k*ns(J)),r.arc(0,0,k,J,te,ee));else{var ue=te,ce=J,se=te,Ae=J,De=Q,Qe=Q,nt=E.apply(this,arguments)/2,rt=nt>Eo&&(m?+m.apply(this,arguments):_r(k*k+j*j)),tt=Sd(dC(j-k)/2,+u.apply(this,arguments)),Be=tt,Rt=tt,ut,Pe;if(rt>Eo){var Ve=pC(rt/k*ns(nt)),qe=pC(rt/j*ns(nt));(De-=Ve*2)>Eo?(Ve*=ee?1:-1,se+=Ve,Ae-=Ve):(De=0,se=Ae=(te+J)/2),(Qe-=qe*2)>Eo?(qe*=ee?1:-1,ue+=qe,ce-=qe):(Qe=0,ue=ce=(te+J)/2)}var bt=j*Ol(ue),Ht=j*ns(ue),Dt=k*Ol(Ae),Lt=k*ns(Ae);if(tt>Eo){var rn=j*Ol(ce),yn=j*ns(ce),pi=k*Ol(se),ti=k*ns(se),hn;if(Q<eu)if(hn=LH(bt,Ht,pi,ti,rn,yn,Dt,Lt)){var Nn=bt-hn[0],Pn=Ht-hn[1],Gi=rn-hn[0],Ct=yn-hn[1],fn=1/ns(MH((Nn*Gi+Pn*Ct)/(_r(Nn*Nn+Pn*Pn)*_r(Gi*Gi+Ct*Ct)))/2),Tn=_r(hn[0]*hn[0]+hn[1]*hn[1]);Be=Sd(tt,(k-Tn)/(fn-1)),Rt=Sd(tt,(j-Tn)/(fn+1))}else Be=Rt=0}Qe>Eo?Rt>Eo?(ut=gy(pi,ti,bt,Ht,j,Rt,ee),Pe=gy(rn,yn,Dt,Lt,j,Rt,ee),r.moveTo(ut.cx+ut.x01,ut.cy+ut.y01),Rt<tt?r.arc(ut.cx,ut.cy,Rt,So(ut.y01,ut.x01),So(Pe.y01,Pe.x01),!ee):(r.arc(ut.cx,ut.cy,Rt,So(ut.y01,ut.x01),So(ut.y11,ut.x11),!ee),r.arc(0,0,j,So(ut.cy+ut.y11,ut.cx+ut.x11),So(Pe.cy+Pe.y11,Pe.cx+Pe.x11),!ee),r.arc(Pe.cx,Pe.cy,Rt,So(Pe.y11,Pe.x11),So(Pe.y01,Pe.x01),!ee))):(r.moveTo(bt,Ht),r.arc(0,0,j,ue,ce,!ee)):r.moveTo(bt,Ht),!(k>Eo)||!(De>Eo)?r.lineTo(Dt,Lt):Be>Eo?(ut=gy(Dt,Lt,rn,yn,k,-Be,ee),Pe=gy(bt,Ht,pi,ti,k,-Be,ee),r.lineTo(ut.cx+ut.x01,ut.cy+ut.y01),Be<tt?r.arc(ut.cx,ut.cy,Be,So(ut.y01,ut.x01),So(Pe.y01,Pe.x01),!ee):(r.arc(ut.cx,ut.cy,Be,So(ut.y01,ut.x01),So(ut.y11,ut.x11),!ee),r.arc(0,0,k,So(ut.cy+ut.y11,ut.cx+ut.x11),So(Pe.cy+Pe.y11,Pe.cx+Pe.x11),ee),r.arc(Pe.cx,Pe.cy,Be,So(Pe.y11,Pe.x11),So(Pe.y01,Pe.x01),!ee))):r.arc(0,0,k,Ae,se,ee)}if(r.closePath(),L)return r=null,L+""||null}return M.centroid=function(){var L=(+n.apply(this,arguments)+ +a.apply(this,arguments))/2,V=(+y.apply(this,arguments)+ +x.apply(this,arguments))/2-eu/2;return[Ol(V)*L,ns(V)*L]},M.innerRadius=function(L){return arguments.length?(n=typeof L=="function"?L:di(+L),M):n},M.outerRadius=function(L){return arguments.length?(a=typeof L=="function"?L:di(+L),M):a},M.cornerRadius=function(L){return arguments.length?(u=typeof L=="function"?L:di(+L),M):u},M.padRadius=function(L){return arguments.length?(m=L==null?null:typeof L=="function"?L:di(+L),M):m},M.startAngle=function(L){return arguments.length?(y=typeof L=="function"?L:di(+L),M):y},M.endAngle=function(L){return arguments.length?(x=typeof L=="function"?L:di(+L),M):x},M.padAngle=function(L){return arguments.length?(E=typeof L=="function"?L:di(+L),M):E},M.context=function(L){return arguments.length?(r=L??null,M):r},M}var OH=Array.prototype.slice;function Ix(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function JD(n){this._context=n}JD.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2;default:this._context.lineTo(n,a);break}}};function Mx(n){return new JD(n)}function qT(n){return n[0]}function HT(n){return n[1]}function ZT(n,a){var u=di(!0),m=null,y=Mx,x=null,E=Y_(r);n=typeof n=="function"?n:n===void 0?qT:di(n),a=typeof a=="function"?a:a===void 0?HT:di(a);function r(P){var M,L=(P=Ix(P)).length,V,k=!1,j;for(m==null&&(x=y(j=E())),M=0;M<=L;++M)!(M<L&&u(V=P[M],M,P))===k&&((k=!k)?x.lineStart():x.lineEnd()),k&&x.point(+n(V,M,P),+a(V,M,P));if(j)return x=null,j+""||null}return r.x=function(P){return arguments.length?(n=typeof P=="function"?P:di(+P),r):n},r.y=function(P){return arguments.length?(a=typeof P=="function"?P:di(+P),r):a},r.defined=function(P){return arguments.length?(u=typeof P=="function"?P:di(!!P),r):u},r.curve=function(P){return arguments.length?(y=P,m!=null&&(x=y(m)),r):y},r.context=function(P){return arguments.length?(P==null?m=x=null:x=y(m=P),r):m},r}function QD(n,a,u){var m=null,y=di(!0),x=null,E=Mx,r=null,P=Y_(M);n=typeof n=="function"?n:n===void 0?qT:di(+n),a=typeof a=="function"?a:di(a===void 0?0:+a),u=typeof u=="function"?u:u===void 0?HT:di(+u);function M(V){var k,j,te,J=(V=Ix(V)).length,Q,ee=!1,ue,ce=new Array(J),se=new Array(J);for(x==null&&(r=E(ue=P())),k=0;k<=J;++k){if(!(k<J&&y(Q=V[k],k,V))===ee)if(ee=!ee)j=k,r.areaStart(),r.lineStart();else{for(r.lineEnd(),r.lineStart(),te=k-1;te>=j;--te)r.point(ce[te],se[te]);r.lineEnd(),r.areaEnd()}ee&&(ce[k]=+n(Q,k,V),se[k]=+a(Q,k,V),r.point(m?+m(Q,k,V):ce[k],u?+u(Q,k,V):se[k]))}if(ue)return r=null,ue+""||null}function L(){return ZT().defined(y).curve(E).context(x)}return M.x=function(V){return arguments.length?(n=typeof V=="function"?V:di(+V),m=null,M):n},M.x0=function(V){return arguments.length?(n=typeof V=="function"?V:di(+V),M):n},M.x1=function(V){return arguments.length?(m=V==null?null:typeof V=="function"?V:di(+V),M):m},M.y=function(V){return arguments.length?(a=typeof V=="function"?V:di(+V),u=null,M):a},M.y0=function(V){return arguments.length?(a=typeof V=="function"?V:di(+V),M):a},M.y1=function(V){return arguments.length?(u=V==null?null:typeof V=="function"?V:di(+V),M):u},M.lineX0=M.lineY0=function(){return L().x(n).y(a)},M.lineY1=function(){return L().x(n).y(u)},M.lineX1=function(){return L().x(m).y(a)},M.defined=function(V){return arguments.length?(y=typeof V=="function"?V:di(!!V),M):y},M.curve=function(V){return arguments.length?(E=V,x!=null&&(r=E(x)),M):E},M.context=function(V){return arguments.length?(V==null?x=r=null:r=E(x=V),M):x},M}function FH(n,a){return a<n?-1:a>n?1:a>=n?0:NaN}function BH(n){return n}function NH(){var n=BH,a=FH,u=null,m=di(0),y=di(Wc),x=di(0);function E(r){var P,M=(r=Ix(r)).length,L,V,k=0,j=new Array(M),te=new Array(M),J=+m.apply(this,arguments),Q=Math.min(Wc,Math.max(-Wc,y.apply(this,arguments)-J)),ee,ue=Math.min(Math.abs(Q)/M,x.apply(this,arguments)),ce=ue*(Q<0?-1:1),se;for(P=0;P<M;++P)(se=te[j[P]=P]=+n(r[P],P,r))>0&&(k+=se);for(a!=null?j.sort(function(Ae,De){return a(te[Ae],te[De])}):u!=null&&j.sort(function(Ae,De){return u(r[Ae],r[De])}),P=0,V=k?(Q-M*ce)/k:0;P<M;++P,J=ee)L=j[P],se=te[L],ee=J+(se>0?se*V:0)+ce,te[L]={data:r[L],index:P,value:se,startAngle:J,endAngle:ee,padAngle:ue};return te}return E.value=function(r){return arguments.length?(n=typeof r=="function"?r:di(+r),E):n},E.sortValues=function(r){return arguments.length?(a=r,u=null,E):a},E.sort=function(r){return arguments.length?(u=r,a=null,E):u},E.startAngle=function(r){return arguments.length?(m=typeof r=="function"?r:di(+r),E):m},E.endAngle=function(r){return arguments.length?(y=typeof r=="function"?r:di(+r),E):y},E.padAngle=function(r){return arguments.length?(x=typeof r=="function"?r:di(+r),E):x},E}var eL=WT(Mx);function tL(n){this._curve=n}tL.prototype={areaStart:function(){this._curve.areaStart()},areaEnd:function(){this._curve.areaEnd()},lineStart:function(){this._curve.lineStart()},lineEnd:function(){this._curve.lineEnd()},point:function(n,a){this._curve.point(a*Math.sin(n),a*-Math.cos(n))}};function WT(n){function a(u){return new tL(n(u))}return a._curve=n,a}function o_(n){var a=n.curve;return n.angle=n.x,delete n.x,n.radius=n.y,delete n.y,n.curve=function(u){return arguments.length?a(WT(u)):a()._curve},n}function mC(){return o_(ZT().curve(eL))}function _C(){var n=QD().curve(eL),a=n.curve,u=n.lineX0,m=n.lineX1,y=n.lineY0,x=n.lineY1;return n.angle=n.x,delete n.x,n.startAngle=n.x0,delete n.x0,n.endAngle=n.x1,delete n.x1,n.radius=n.y,delete n.y,n.innerRadius=n.y0,delete n.y0,n.outerRadius=n.y1,delete n.y1,n.lineStartAngle=function(){return o_(u())},delete n.lineX0,n.lineEndAngle=function(){return o_(m())},delete n.lineX1,n.lineInnerRadius=function(){return o_(y())},delete n.lineY0,n.lineOuterRadius=function(){return o_(x())},delete n.lineY1,n.curve=function(E){return arguments.length?a(WT(E)):a()._curve},n}function s_(n,a){return[(a=+a)*Math.cos(n-=Math.PI/2),a*Math.sin(n)]}class nL{constructor(a,u){this._context=a,this._x=u}areaStart(){this._line=0}areaEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line}point(a,u){switch(a=+a,u=+u,this._point){case 0:{this._point=1,this._line?this._context.lineTo(a,u):this._context.moveTo(a,u);break}case 1:this._point=2;default:{this._x?this._context.bezierCurveTo(this._x0=(this._x0+a)/2,this._y0,this._x0,u,a,u):this._context.bezierCurveTo(this._x0,this._y0=(this._y0+u)/2,a,this._y0,a,u);break}}this._x0=a,this._y0=u}}class VH{constructor(a){this._context=a}lineStart(){this._point=0}lineEnd(){}point(a,u){if(a=+a,u=+u,this._point===0)this._point=1;else{const m=s_(this._x0,this._y0),y=s_(this._x0,this._y0=(this._y0+u)/2),x=s_(a,this._y0),E=s_(a,u);this._context.moveTo(...m),this._context.bezierCurveTo(...y,...x,...E)}this._x0=a,this._y0=u}}function iL(n){return new nL(n,!0)}function rL(n){return new nL(n,!1)}function UH(n){return new VH(n)}function jH(n){return n.source}function $H(n){return n.target}function Cx(n){let a=jH,u=$H,m=qT,y=HT,x=null,E=null,r=Y_(P);function P(){let M;const L=OH.call(arguments),V=a.apply(this,L),k=u.apply(this,L);if(x==null&&(E=n(M=r())),E.lineStart(),L[0]=V,E.point(+m.apply(this,L),+y.apply(this,L)),L[0]=k,E.point(+m.apply(this,L),+y.apply(this,L)),E.lineEnd(),M)return E=null,M+""||null}return P.source=function(M){return arguments.length?(a=M,P):a},P.target=function(M){return arguments.length?(u=M,P):u},P.x=function(M){return arguments.length?(m=typeof M=="function"?M:di(+M),P):m},P.y=function(M){return arguments.length?(y=typeof M=="function"?M:di(+M),P):y},P.context=function(M){return arguments.length?(M==null?x=E=null:E=n(x=M),P):x},P}function GH(){return Cx(iL)}function qH(){return Cx(rL)}function HH(){const n=Cx(UH);return n.angle=n.x,delete n.x,n.radius=n.y,delete n.y,n}const ZH=_r(3),oL={draw(n,a){const u=_r(a+Sd(a/28,.75))*.59436,m=u/2,y=m*ZH;n.moveTo(0,u),n.lineTo(0,-u),n.moveTo(-y,-m),n.lineTo(y,m),n.moveTo(-y,m),n.lineTo(y,-m)}},Px={draw(n,a){const u=_r(a/eu);n.moveTo(u,0),n.arc(0,0,u,0,Wc)}},sL={draw(n,a){const u=_r(a/5)/2;n.moveTo(-3*u,-u),n.lineTo(-u,-u),n.lineTo(-u,-3*u),n.lineTo(u,-3*u),n.lineTo(u,-u),n.lineTo(3*u,-u),n.lineTo(3*u,u),n.lineTo(u,u),n.lineTo(u,3*u),n.lineTo(-u,3*u),n.lineTo(-u,u),n.lineTo(-3*u,u),n.closePath()}},aL=_r(1/3),WH=aL*2,lL={draw(n,a){const u=_r(a/WH),m=u*aL;n.moveTo(0,-u),n.lineTo(m,0),n.lineTo(0,u),n.lineTo(-m,0),n.closePath()}},cL={draw(n,a){const u=_r(a)*.62625;n.moveTo(0,-u),n.lineTo(u,0),n.lineTo(0,u),n.lineTo(-u,0),n.closePath()}},uL={draw(n,a){const u=_r(a-Sd(a/7,2))*.87559;n.moveTo(-u,0),n.lineTo(u,0),n.moveTo(0,u),n.lineTo(0,-u)}},hL={draw(n,a){const u=_r(a),m=-u/2;n.rect(m,m,u,u)}},fL={draw(n,a){const u=_r(a)*.4431;n.moveTo(u,u),n.lineTo(u,-u),n.lineTo(-u,-u),n.lineTo(-u,u),n.closePath()}},XH=.8908130915292852,dL=ns(eu/10)/ns(7*eu/10),YH=ns(Wc/10)*dL,KH=-Ol(Wc/10)*dL,pL={draw(n,a){const u=_r(a*XH),m=YH*u,y=KH*u;n.moveTo(0,-u),n.lineTo(m,y);for(let x=1;x<5;++x){const E=Wc*x/5,r=Ol(E),P=ns(E);n.lineTo(P*u,-r*u),n.lineTo(r*m-P*y,P*m+r*y)}n.closePath()}},yw=_r(3),mL={draw(n,a){const u=-_r(a/(yw*3));n.moveTo(0,u*2),n.lineTo(-yw*u,-u),n.lineTo(yw*u,-u),n.closePath()}},JH=_r(3),_L={draw(n,a){const u=_r(a)*.6824,m=u/2,y=u*JH/2;n.moveTo(0,-u),n.lineTo(y,m),n.lineTo(-y,m),n.closePath()}},Rs=-.5,Ds=_r(3)/2,T2=1/_r(12),QH=(T2/2+1)*3,gL={draw(n,a){const u=_r(a/QH),m=u/2,y=u*T2,x=m,E=u*T2+u,r=-x,P=E;n.moveTo(m,y),n.lineTo(x,E),n.lineTo(r,P),n.lineTo(Rs*m-Ds*y,Ds*m+Rs*y),n.lineTo(Rs*x-Ds*E,Ds*x+Rs*E),n.lineTo(Rs*r-Ds*P,Ds*r+Rs*P),n.lineTo(Rs*m+Ds*y,Rs*y-Ds*m),n.lineTo(Rs*x+Ds*E,Rs*E-Ds*x),n.lineTo(Rs*r+Ds*P,Rs*P-Ds*r),n.closePath()}},S2={draw(n,a){const u=_r(a-Sd(a/6,1.7))*.6189;n.moveTo(-u,-u),n.lineTo(u,u),n.moveTo(-u,u),n.lineTo(u,-u)}},gC=[Px,sL,lL,hL,pL,mL,gL],eZ=[Px,uL,S2,_L,oL,fL,cL];function tZ(n,a){let u=null,m=Y_(y);n=typeof n=="function"?n:di(n||Px),a=typeof a=="function"?a:di(a===void 0?64:+a);function y(){let x;if(u||(u=x=m()),n.apply(this,arguments).draw(u,+a.apply(this,arguments)),x)return u=null,x+""||null}return y.type=function(x){return arguments.length?(n=typeof x=="function"?x:di(x),y):n},y.size=function(x){return arguments.length?(a=typeof x=="function"?x:di(+x),y):a},y.context=function(x){return arguments.length?(u=x??null,y):u},y}function tu(){}function Rv(n,a,u){n._context.bezierCurveTo((2*n._x0+n._x1)/3,(2*n._y0+n._y1)/3,(n._x0+2*n._x1)/3,(n._y0+2*n._y1)/3,(n._x0+4*n._x1+a)/6,(n._y0+4*n._y1+u)/6)}function zx(n){this._context=n}zx.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:Rv(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1);break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:Rv(this,n,a);break}this._x0=this._x1,this._x1=n,this._y0=this._y1,this._y1=a}};function nZ(n){return new zx(n)}function yL(n){this._context=n}yL.prototype={areaStart:tu,areaEnd:tu,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._y0=this._y1=this._y2=this._y3=this._y4=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:{this._context.moveTo(this._x2,this._y2),this._context.closePath();break}case 2:{this._context.moveTo((this._x2+2*this._x3)/3,(this._y2+2*this._y3)/3),this._context.lineTo((this._x3+2*this._x2)/3,(this._y3+2*this._y2)/3),this._context.closePath();break}case 3:{this.point(this._x2,this._y2),this.point(this._x3,this._y3),this.point(this._x4,this._y4);break}}},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._x2=n,this._y2=a;break;case 1:this._point=2,this._x3=n,this._y3=a;break;case 2:this._point=3,this._x4=n,this._y4=a,this._context.moveTo((this._x0+4*this._x1+n)/6,(this._y0+4*this._y1+a)/6);break;default:Rv(this,n,a);break}this._x0=this._x1,this._x1=n,this._y0=this._y1,this._y1=a}};function iZ(n){return new yL(n)}function vL(n){this._context=n}vL.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===3)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;var u=(this._x0+4*this._x1+n)/6,m=(this._y0+4*this._y1+a)/6;this._line?this._context.lineTo(u,m):this._context.moveTo(u,m);break;case 3:this._point=4;default:Rv(this,n,a);break}this._x0=this._x1,this._x1=n,this._y0=this._y1,this._y1=a}};function rZ(n){return new vL(n)}function xL(n,a){this._basis=new zx(n),this._beta=a}xL.prototype={lineStart:function(){this._x=[],this._y=[],this._basis.lineStart()},lineEnd:function(){var n=this._x,a=this._y,u=n.length-1;if(u>0)for(var m=n[0],y=a[0],x=n[u]-m,E=a[u]-y,r=-1,P;++r<=u;)P=r/u,this._basis.point(this._beta*n[r]+(1-this._beta)*(m+P*x),this._beta*a[r]+(1-this._beta)*(y+P*E));this._x=this._y=null,this._basis.lineEnd()},point:function(n,a){this._x.push(+n),this._y.push(+a)}};const oZ=function n(a){function u(m){return a===1?new zx(m):new xL(m,a)}return u.beta=function(m){return n(+m)},u}(.85);function Dv(n,a,u){n._context.bezierCurveTo(n._x1+n._k*(n._x2-n._x0),n._y1+n._k*(n._y2-n._y0),n._x2+n._k*(n._x1-a),n._y2+n._k*(n._y1-u),n._x2,n._y2)}function XT(n,a){this._context=n,this._k=(1-a)/6}XT.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:Dv(this,this._x1,this._y1);break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2,this._x1=n,this._y1=a;break;case 2:this._point=3;default:Dv(this,n,a);break}this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const sZ=function n(a){function u(m){return new XT(m,a)}return u.tension=function(m){return n(+m)},u}(0);function YT(n,a){this._context=n,this._k=(1-a)/6}YT.prototype={areaStart:tu,areaEnd:tu,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:{this._context.moveTo(this._x3,this._y3),this._context.closePath();break}case 2:{this._context.lineTo(this._x3,this._y3),this._context.closePath();break}case 3:{this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5);break}}},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._x3=n,this._y3=a;break;case 1:this._point=2,this._context.moveTo(this._x4=n,this._y4=a);break;case 2:this._point=3,this._x5=n,this._y5=a;break;default:Dv(this,n,a);break}this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const aZ=function n(a){function u(m){return new YT(m,a)}return u.tension=function(m){return n(+m)},u}(0);function KT(n,a){this._context=n,this._k=(1-a)/6}KT.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===3)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:Dv(this,n,a);break}this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const lZ=function n(a){function u(m){return new KT(m,a)}return u.tension=function(m){return n(+m)},u}(0);function JT(n,a,u){var m=n._x1,y=n._y1,x=n._x2,E=n._y2;if(n._l01_a>Eo){var r=2*n._l01_2a+3*n._l01_a*n._l12_a+n._l12_2a,P=3*n._l01_a*(n._l01_a+n._l12_a);m=(m*r-n._x0*n._l12_2a+n._x2*n._l01_2a)/P,y=(y*r-n._y0*n._l12_2a+n._y2*n._l01_2a)/P}if(n._l23_a>Eo){var M=2*n._l23_2a+3*n._l23_a*n._l12_a+n._l12_2a,L=3*n._l23_a*(n._l23_a+n._l12_a);x=(x*M+n._x1*n._l23_2a-a*n._l12_2a)/L,E=(E*M+n._y1*n._l23_2a-u*n._l12_2a)/L}n._context.bezierCurveTo(m,y,x,E,n._x2,n._y2)}function bL(n,a){this._context=n,this._alpha=a}bL.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2);break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){if(n=+n,a=+a,this._point){var u=this._x2-n,m=this._y2-a;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(u*u+m*m,this._alpha))}switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2;break;case 2:this._point=3;default:JT(this,n,a);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const cZ=function n(a){function u(m){return a?new bL(m,a):new XT(m,0)}return u.alpha=function(m){return n(+m)},u}(.5);function wL(n,a){this._context=n,this._alpha=a}wL.prototype={areaStart:tu,areaEnd:tu,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 1:{this._context.moveTo(this._x3,this._y3),this._context.closePath();break}case 2:{this._context.lineTo(this._x3,this._y3),this._context.closePath();break}case 3:{this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5);break}}},point:function(n,a){if(n=+n,a=+a,this._point){var u=this._x2-n,m=this._y2-a;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(u*u+m*m,this._alpha))}switch(this._point){case 0:this._point=1,this._x3=n,this._y3=a;break;case 1:this._point=2,this._context.moveTo(this._x4=n,this._y4=a);break;case 2:this._point=3,this._x5=n,this._y5=a;break;default:JT(this,n,a);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const uZ=function n(a){function u(m){return a?new wL(m,a):new YT(m,0)}return u.alpha=function(m){return n(+m)},u}(.5);function TL(n,a){this._context=n,this._alpha=a}TL.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===3)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){if(n=+n,a=+a,this._point){var u=this._x2-n,m=this._y2-a;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(u*u+m*m,this._alpha))}switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:JT(this,n,a);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=n,this._y0=this._y1,this._y1=this._y2,this._y2=a}};const hZ=function n(a){function u(m){return a?new TL(m,a):new KT(m,0)}return u.alpha=function(m){return n(+m)},u}(.5);function SL(n){this._context=n}SL.prototype={areaStart:tu,areaEnd:tu,lineStart:function(){this._point=0},lineEnd:function(){this._point&&this._context.closePath()},point:function(n,a){n=+n,a=+a,this._point?this._context.lineTo(n,a):(this._point=1,this._context.moveTo(n,a))}};function fZ(n){return new SL(n)}function yC(n){return n<0?-1:1}function vC(n,a,u){var m=n._x1-n._x0,y=a-n._x1,x=(n._y1-n._y0)/(m||y<0&&-0),E=(u-n._y1)/(y||m<0&&-0),r=(x*y+E*m)/(m+y);return(yC(x)+yC(E))*Math.min(Math.abs(x),Math.abs(E),.5*Math.abs(r))||0}function xC(n,a){var u=n._x1-n._x0;return u?(3*(n._y1-n._y0)/u-a)/2:a}function vw(n,a,u){var m=n._x0,y=n._y0,x=n._x1,E=n._y1,r=(x-m)/3;n._context.bezierCurveTo(m+r,y+r*a,x-r,E-r*u,x,E)}function Lv(n){this._context=n}Lv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:vw(this,this._t0,xC(this,this._t0));break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,a){var u=NaN;if(n=+n,a=+a,!(n===this._x1&&a===this._y1)){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2;break;case 2:this._point=3,vw(this,xC(this,u=vC(this,n,a)),u);break;default:vw(this,this._t0,u=vC(this,n,a));break}this._x0=this._x1,this._x1=n,this._y0=this._y1,this._y1=a,this._t0=u}}};function EL(n){this._context=new AL(n)}(EL.prototype=Object.create(Lv.prototype)).point=function(n,a){Lv.prototype.point.call(this,a,n)};function AL(n){this._context=n}AL.prototype={moveTo:function(n,a){this._context.moveTo(a,n)},closePath:function(){this._context.closePath()},lineTo:function(n,a){this._context.lineTo(a,n)},bezierCurveTo:function(n,a,u,m,y,x){this._context.bezierCurveTo(a,n,m,u,x,y)}};function dZ(n){return new Lv(n)}function pZ(n){return new EL(n)}function IL(n){this._context=n}IL.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=[],this._y=[]},lineEnd:function(){var n=this._x,a=this._y,u=n.length;if(u)if(this._line?this._context.lineTo(n[0],a[0]):this._context.moveTo(n[0],a[0]),u===2)this._context.lineTo(n[1],a[1]);else for(var m=bC(n),y=bC(a),x=0,E=1;E<u;++x,++E)this._context.bezierCurveTo(m[0][x],y[0][x],m[1][x],y[1][x],n[E],a[E]);(this._line||this._line!==0&&u===1)&&this._context.closePath(),this._line=1-this._line,this._x=this._y=null},point:function(n,a){this._x.push(+n),this._y.push(+a)}};function bC(n){var a,u=n.length-1,m,y=new Array(u),x=new Array(u),E=new Array(u);for(y[0]=0,x[0]=2,E[0]=n[0]+2*n[1],a=1;a<u-1;++a)y[a]=1,x[a]=4,E[a]=4*n[a]+2*n[a+1];for(y[u-1]=2,x[u-1]=7,E[u-1]=8*n[u-1]+n[u],a=1;a<u;++a)m=y[a]/x[a-1],x[a]-=m,E[a]-=m*E[a-1];for(y[u-1]=E[u-1]/x[u-1],a=u-2;a>=0;--a)y[a]=(E[a]-y[a+1])/x[a];for(x[u-1]=(n[u]+y[u-1])/2,a=0;a<u-1;++a)x[a]=2*n[a+1]-y[a+1];return[y,x]}function mZ(n){return new IL(n)}function Rx(n,a){this._context=n,this._t=a}Rx.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN,this._point=0},lineEnd:function(){0<this._t&&this._t<1&&this._point===2&&this._context.lineTo(this._x,this._y),(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line>=0&&(this._t=1-this._t,this._line=1-this._line)},point:function(n,a){switch(n=+n,a=+a,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,a):this._context.moveTo(n,a);break;case 1:this._point=2;default:{if(this._t<=0)this._context.lineTo(this._x,a),this._context.lineTo(n,a);else{var u=this._x*(1-this._t)+n*this._t;this._context.lineTo(u,this._y),this._context.lineTo(u,a)}break}}this._x=n,this._y=a}};function _Z(n){return new Rx(n,.5)}function gZ(n){return new Rx(n,0)}function yZ(n){return new Rx(n,1)}function Ud(n,a){if((E=n.length)>1)for(var u=1,m,y,x=n[a[0]],E,r=x.length;u<E;++u)for(y=x,x=n[a[u]],m=0;m<r;++m)x[m][1]+=x[m][0]=isNaN(y[m][1])?y[m][0]:y[m][1]}function jd(n){for(var a=n.length,u=new Array(a);--a>=0;)u[a]=a;return u}function vZ(n,a){return n[a]}function xZ(n){const a=[];return a.key=n,a}function bZ(){var n=di([]),a=jd,u=Ud,m=vZ;function y(x){var E=Array.from(n.apply(this,arguments),xZ),r,P=E.length,M=-1,L;for(const V of x)for(r=0,++M;r<P;++r)(E[r][M]=[0,+m(V,E[r].key,M,x)]).data=V;for(r=0,L=Ix(a(E));r<P;++r)E[L[r]].index=r;return u(E,L),E}return y.keys=function(x){return arguments.length?(n=typeof x=="function"?x:di(Array.from(x)),y):n},y.value=function(x){return arguments.length?(m=typeof x=="function"?x:di(+x),y):m},y.order=function(x){return arguments.length?(a=x==null?jd:typeof x=="function"?x:di(Array.from(x)),y):a},y.offset=function(x){return arguments.length?(u=x??Ud,y):u},y}function wZ(n,a){if((m=n.length)>0){for(var u,m,y=0,x=n[0].length,E;y<x;++y){for(E=u=0;u<m;++u)E+=n[u][y][1]||0;if(E)for(u=0;u<m;++u)n[u][y][1]/=E}Ud(n,a)}}function TZ(n,a){if((P=n.length)>0)for(var u,m=0,y,x,E,r,P,M=n[a[0]].length;m<M;++m)for(E=r=0,u=0;u<P;++u)(x=(y=n[a[u]][m])[1]-y[0])>0?(y[0]=E,y[1]=E+=x):x<0?(y[1]=r,y[0]=r+=x):(y[0]=0,y[1]=x)}function SZ(n,a){if((y=n.length)>0){for(var u=0,m=n[a[0]],y,x=m.length;u<x;++u){for(var E=0,r=0;E<y;++E)r+=n[E][u][1]||0;m[u][1]+=m[u][0]=-r/2}Ud(n,a)}}function EZ(n,a){if(!(!((E=n.length)>0)||!((x=(y=n[a[0]]).length)>0))){for(var u=0,m=1,y,x,E;m<x;++m){for(var r=0,P=0,M=0;r<E;++r){for(var L=n[a[r]],V=L[m][1]||0,k=L[m-1][1]||0,j=(V-k)/2,te=0;te<r;++te){var J=n[a[te]],Q=J[m][1]||0,ee=J[m-1][1]||0;j+=Q-ee}P+=V,M+=j*V}y[m-1][1]+=y[m-1][0]=u,P&&(u-=M/P)}y[m-1][1]+=y[m-1][0]=u,Ud(n,a)}}function ML(n){var a=n.map(AZ);return jd(n).sort(function(u,m){return a[u]-a[m]})}function AZ(n){for(var a=-1,u=0,m=n.length,y,x=-1/0;++a<m;)(y=+n[a][1])>x&&(x=y,u=a);return u}function CL(n){var a=n.map(PL);return jd(n).sort(function(u,m){return a[u]-a[m]})}function PL(n){for(var a=0,u=-1,m=n.length,y;++u<m;)(y=+n[u][1])&&(a+=y);return a}function IZ(n){return CL(n).reverse()}function MZ(n){var a=n.length,u,m,y=n.map(PL),x=ML(n),E=0,r=0,P=[],M=[];for(u=0;u<a;++u)m=x[u],E<r?(E+=y[m],P.push(m)):(r+=y[m],M.push(m));return M.reverse().concat(P)}function CZ(n){return jd(n).reverse()}const yy=n=>()=>n;function PZ(n,{sourceEvent:a,target:u,transform:m,dispatch:y}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:a,enumerable:!0,configurable:!0},target:{value:u,enumerable:!0,configurable:!0},transform:{value:m,enumerable:!0,configurable:!0},_:{value:y}})}function Ua(n,a,u){this.k=n,this.x=a,this.y=u}Ua.prototype={constructor:Ua,scale:function(n){return n===1?this:new Ua(this.k*n,this.x,this.y)},translate:function(n,a){return n===0&a===0?this:new Ua(this.k,this.x+this.k*n,this.y+this.k*a)},apply:function(n){return[n[0]*this.k+this.x,n[1]*this.k+this.y]},applyX:function(n){return n*this.k+this.x},applyY:function(n){return n*this.k+this.y},invert:function(n){return[(n[0]-this.x)/this.k,(n[1]-this.y)/this.k]},invertX:function(n){return(n-this.x)/this.k},invertY:function(n){return(n-this.y)/this.k},rescaleX:function(n){return n.copy().domain(n.range().map(this.invertX,this).map(n.invert,n))},rescaleY:function(n){return n.copy().domain(n.range().map(this.invertY,this).map(n.invert,n))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Dx=new Ua(1,0,0);zL.prototype=Ua.prototype;function zL(n){for(;!n.__zoom;)if(!(n=n.parentNode))return Dx;return n.__zoom}function xw(n){n.stopImmediatePropagation()}function Wm(n){n.preventDefault(),n.stopImmediatePropagation()}function zZ(n){return(!n.ctrlKey||n.type==="wheel")&&!n.button}function RZ(){var n=this;return n instanceof SVGElement?(n=n.ownerSVGElement||n,n.hasAttribute("viewBox")?(n=n.viewBox.baseVal,[[n.x,n.y],[n.x+n.width,n.y+n.height]]):[[0,0],[n.width.baseVal.value,n.height.baseVal.value]]):[[0,0],[n.clientWidth,n.clientHeight]]}function wC(){return this.__zoom||Dx}function DZ(n){return-n.deltaY*(n.deltaMode===1?.05:n.deltaMode?1:.002)*(n.ctrlKey?10:1)}function LZ(){return navigator.maxTouchPoints||"ontouchstart"in this}function kZ(n,a,u){var m=n.invertX(a[0][0])-u[0][0],y=n.invertX(a[1][0])-u[1][0],x=n.invertY(a[0][1])-u[0][1],E=n.invertY(a[1][1])-u[1][1];return n.translate(y>m?(m+y)/2:Math.min(0,m)||Math.max(0,y),E>x?(x+E)/2:Math.min(0,x)||Math.max(0,E))}function OZ(){var n=zZ,a=RZ,u=kZ,m=DZ,y=LZ,x=[0,1/0],E=[[-1/0,-1/0],[1/0,1/0]],r=250,P=uz,M=Rh("start","zoom","end"),L,V,k,j=500,te=150,J=0,Q=10;function ee(Pe){Pe.property("__zoom",wC).on("wheel.zoom",nt,{passive:!1}).on("mousedown.zoom",rt).on("dblclick.zoom",tt).filter(y).on("touchstart.zoom",Be).on("touchmove.zoom",Rt).on("touchend.zoom touchcancel.zoom",ut).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}ee.transform=function(Pe,Ve,qe,bt){var Ht=Pe.selection?Pe.selection():Pe;Ht.property("__zoom",wC),Pe!==Ht?Ae(Pe,Ve,qe,bt):Ht.interrupt().each(function(){De(this,arguments).event(bt).start().zoom(null,typeof Ve=="function"?Ve.apply(this,arguments):Ve).end()})},ee.scaleBy=function(Pe,Ve,qe,bt){ee.scaleTo(Pe,function(){var Ht=this.__zoom.k,Dt=typeof Ve=="function"?Ve.apply(this,arguments):Ve;return Ht*Dt},qe,bt)},ee.scaleTo=function(Pe,Ve,qe,bt){ee.transform(Pe,function(){var Ht=a.apply(this,arguments),Dt=this.__zoom,Lt=qe==null?se(Ht):typeof qe=="function"?qe.apply(this,arguments):qe,rn=Dt.invert(Lt),yn=typeof Ve=="function"?Ve.apply(this,arguments):Ve;return u(ce(ue(Dt,yn),Lt,rn),Ht,E)},qe,bt)},ee.translateBy=function(Pe,Ve,qe,bt){ee.transform(Pe,function(){return u(this.__zoom.translate(typeof Ve=="function"?Ve.apply(this,arguments):Ve,typeof qe=="function"?qe.apply(this,arguments):qe),a.apply(this,arguments),E)},null,bt)},ee.translateTo=function(Pe,Ve,qe,bt,Ht){ee.transform(Pe,function(){var Dt=a.apply(this,arguments),Lt=this.__zoom,rn=bt==null?se(Dt):typeof bt=="function"?bt.apply(this,arguments):bt;return u(Dx.translate(rn[0],rn[1]).scale(Lt.k).translate(typeof Ve=="function"?-Ve.apply(this,arguments):-Ve,typeof qe=="function"?-qe.apply(this,arguments):-qe),Dt,E)},bt,Ht)};function ue(Pe,Ve){return Ve=Math.max(x[0],Math.min(x[1],Ve)),Ve===Pe.k?Pe:new Ua(Ve,Pe.x,Pe.y)}function ce(Pe,Ve,qe){var bt=Ve[0]-qe[0]*Pe.k,Ht=Ve[1]-qe[1]*Pe.k;return bt===Pe.x&&Ht===Pe.y?Pe:new Ua(Pe.k,bt,Ht)}function se(Pe){return[(+Pe[0][0]+ +Pe[1][0])/2,(+Pe[0][1]+ +Pe[1][1])/2]}function Ae(Pe,Ve,qe,bt){Pe.on("start.zoom",function(){De(this,arguments).event(bt).start()}).on("interrupt.zoom end.zoom",function(){De(this,arguments).event(bt).end()}).tween("zoom",function(){var Ht=this,Dt=arguments,Lt=De(Ht,Dt).event(bt),rn=a.apply(Ht,Dt),yn=qe==null?se(rn):typeof qe=="function"?qe.apply(Ht,Dt):qe,pi=Math.max(rn[1][0]-rn[0][0],rn[1][1]-rn[0][1]),ti=Ht.__zoom,hn=typeof Ve=="function"?Ve.apply(Ht,Dt):Ve,Nn=P(ti.invert(yn).concat(pi/ti.k),hn.invert(yn).concat(pi/hn.k));return function(Pn){if(Pn===1)Pn=hn;else{var Gi=Nn(Pn),Ct=pi/Gi[2];Pn=new Ua(Ct,yn[0]-Gi[0]*Ct,yn[1]-Gi[1]*Ct)}Lt.zoom(null,Pn)}})}function De(Pe,Ve,qe){return!qe&&Pe.__zooming||new Qe(Pe,Ve)}function Qe(Pe,Ve){this.that=Pe,this.args=Ve,this.active=0,this.sourceEvent=null,this.extent=a.apply(Pe,Ve),this.taps=0}Qe.prototype={event:function(Pe){return Pe&&(this.sourceEvent=Pe),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(Pe,Ve){return this.mouse&&Pe!=="mouse"&&(this.mouse[1]=Ve.invert(this.mouse[0])),this.touch0&&Pe!=="touch"&&(this.touch0[1]=Ve.invert(this.touch0[0])),this.touch1&&Pe!=="touch"&&(this.touch1[1]=Ve.invert(this.touch1[0])),this.that.__zoom=Ve,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(Pe){var Ve=Ao(this.that).datum();M.call(Pe,this.that,new PZ(Pe,{sourceEvent:this.sourceEvent,target:ee,transform:this.that.__zoom,dispatch:M}),Ve)}};function nt(Pe,...Ve){if(!n.apply(this,arguments))return;var qe=De(this,Ve).event(Pe),bt=this.__zoom,Ht=Math.max(x[0],Math.min(x[1],bt.k*Math.pow(2,m.apply(this,arguments)))),Dt=ys(Pe);if(qe.wheel)(qe.mouse[0][0]!==Dt[0]||qe.mouse[0][1]!==Dt[1])&&(qe.mouse[1]=bt.invert(qe.mouse[0]=Dt)),clearTimeout(qe.wheel);else{if(bt.k===Ht)return;qe.mouse=[Dt,bt.invert(Dt)],xh(this),qe.start()}Wm(Pe),qe.wheel=setTimeout(Lt,te),qe.zoom("mouse",u(ce(ue(bt,Ht),qe.mouse[0],qe.mouse[1]),qe.extent,E));function Lt(){qe.wheel=null,qe.end()}}function rt(Pe,...Ve){if(k||!n.apply(this,arguments))return;var qe=Pe.currentTarget,bt=De(this,Ve,!0).event(Pe),Ht=Ao(Pe.view).on("mousemove.zoom",yn,!0).on("mouseup.zoom",pi,!0),Dt=ys(Pe,qe),Lt=Pe.clientX,rn=Pe.clientY;Jv(Pe.view),xw(Pe),bt.mouse=[Dt,this.__zoom.invert(Dt)],xh(this),bt.start();function yn(ti){if(Wm(ti),!bt.moved){var hn=ti.clientX-Lt,Nn=ti.clientY-rn;bt.moved=hn*hn+Nn*Nn>J}bt.event(ti).zoom("mouse",u(ce(bt.that.__zoom,bt.mouse[0]=ys(ti,qe),bt.mouse[1]),bt.extent,E))}function pi(ti){Ht.on("mousemove.zoom mouseup.zoom",null),Qv(ti.view,bt.moved),Wm(ti),bt.event(ti).end()}}function tt(Pe,...Ve){if(n.apply(this,arguments)){var qe=this.__zoom,bt=ys(Pe.changedTouches?Pe.changedTouches[0]:Pe,this),Ht=qe.invert(bt),Dt=qe.k*(Pe.shiftKey?.5:2),Lt=u(ce(ue(qe,Dt),bt,Ht),a.apply(this,Ve),E);Wm(Pe),r>0?Ao(this).transition().duration(r).call(Ae,Lt,bt,Pe):Ao(this).call(ee.transform,Lt,bt,Pe)}}function Be(Pe,...Ve){if(n.apply(this,arguments)){var qe=Pe.touches,bt=qe.length,Ht=De(this,Ve,Pe.changedTouches.length===bt).event(Pe),Dt,Lt,rn,yn;for(xw(Pe),Lt=0;Lt<bt;++Lt)rn=qe[Lt],yn=ys(rn,this),yn=[yn,this.__zoom.invert(yn),rn.identifier],Ht.touch0?!Ht.touch1&&Ht.touch0[2]!==yn[2]&&(Ht.touch1=yn,Ht.taps=0):(Ht.touch0=yn,Dt=!0,Ht.taps=1+!!L);L&&(L=clearTimeout(L)),Dt&&(Ht.taps<2&&(V=yn[0],L=setTimeout(function(){L=null},j)),xh(this),Ht.start())}}function Rt(Pe,...Ve){if(this.__zooming){var qe=De(this,Ve).event(Pe),bt=Pe.changedTouches,Ht=bt.length,Dt,Lt,rn,yn;for(Wm(Pe),Dt=0;Dt<Ht;++Dt)Lt=bt[Dt],rn=ys(Lt,this),qe.touch0&&qe.touch0[2]===Lt.identifier?qe.touch0[0]=rn:qe.touch1&&qe.touch1[2]===Lt.identifier&&(qe.touch1[0]=rn);if(Lt=qe.that.__zoom,qe.touch1){var pi=qe.touch0[0],ti=qe.touch0[1],hn=qe.touch1[0],Nn=qe.touch1[1],Pn=(Pn=hn[0]-pi[0])*Pn+(Pn=hn[1]-pi[1])*Pn,Gi=(Gi=Nn[0]-ti[0])*Gi+(Gi=Nn[1]-ti[1])*Gi;Lt=ue(Lt,Math.sqrt(Pn/Gi)),rn=[(pi[0]+hn[0])/2,(pi[1]+hn[1])/2],yn=[(ti[0]+Nn[0])/2,(ti[1]+Nn[1])/2]}else if(qe.touch0)rn=qe.touch0[0],yn=qe.touch0[1];else return;qe.zoom("touch",u(ce(Lt,rn,yn),qe.extent,E))}}function ut(Pe,...Ve){if(this.__zooming){var qe=De(this,Ve).event(Pe),bt=Pe.changedTouches,Ht=bt.length,Dt,Lt;for(xw(Pe),k&&clearTimeout(k),k=setTimeout(function(){k=null},j),Dt=0;Dt<Ht;++Dt)Lt=bt[Dt],qe.touch0&&qe.touch0[2]===Lt.identifier?delete qe.touch0:qe.touch1&&qe.touch1[2]===Lt.identifier&&delete qe.touch1;if(qe.touch1&&!qe.touch0&&(qe.touch0=qe.touch1,delete qe.touch1),qe.touch0)qe.touch0[1]=this.__zoom.invert(qe.touch0[0]);else if(qe.end(),qe.taps===2&&(Lt=ys(Lt,this),Math.hypot(V[0]-Lt[0],V[1]-Lt[1])<Q)){var rn=Ao(this).on("dblclick.zoom");rn&&rn.apply(this,arguments)}}}return ee.wheelDelta=function(Pe){return arguments.length?(m=typeof Pe=="function"?Pe:yy(+Pe),ee):m},ee.filter=function(Pe){return arguments.length?(n=typeof Pe=="function"?Pe:yy(!!Pe),ee):n},ee.touchable=function(Pe){return arguments.length?(y=typeof Pe=="function"?Pe:yy(!!Pe),ee):y},ee.extent=function(Pe){return arguments.length?(a=typeof Pe=="function"?Pe:yy([[+Pe[0][0],+Pe[0][1]],[+Pe[1][0],+Pe[1][1]]]),ee):a},ee.scaleExtent=function(Pe){return arguments.length?(x[0]=+Pe[0],x[1]=+Pe[1],ee):[x[0],x[1]]},ee.translateExtent=function(Pe){return arguments.length?(E[0][0]=+Pe[0][0],E[1][0]=+Pe[1][0],E[0][1]=+Pe[0][1],E[1][1]=+Pe[1][1],ee):[[E[0][0],E[0][1]],[E[1][0],E[1][1]]]},ee.constrain=function(Pe){return arguments.length?(u=Pe,ee):u},ee.duration=function(Pe){return arguments.length?(r=+Pe,ee):r},ee.interpolate=function(Pe){return arguments.length?(P=Pe,ee):P},ee.on=function(){var Pe=M.on.apply(M,arguments);return Pe===M?ee:Pe},ee.clickDistance=function(Pe){return arguments.length?(J=(Pe=+Pe)*Pe,ee):Math.sqrt(J)},ee.tapDistance=function(Pe){return arguments.length?(Q=+Pe,ee):Q},ee}const FZ=Object.freeze(Object.defineProperty({__proto__:null,Adder:Zr,Delaunay:sT,FormatSpecifier:hx,InternMap:g_,InternSet:bh,Node:Ch,Path:U_,Voronoi:Cz,ZoomTransform:Ua,active:DV,arc:kH,area:QD,areaRadial:_C,ascending:Ir,autoType:i7,axisBottom:TB,axisLeft:SB,axisRight:wB,axisTop:bB,bin:aM,bisect:Kc,bisectCenter:gF,bisectLeft:_F,bisectRight:Kc,bisector:Hv,blob:s7,blur:yF,blur2:lP,blurImage:vF,brush:HV,brushSelection:$V,brushX:GV,brushY:qV,buffer:l7,chord:WV,chordDirected:YV,chordTranspose:XV,cluster:Sj,color:Jc,contourDensity:wU,contours:Ww,count:Zv,create:oN,creator:Yv,cross:AF,csv:Lz,csvFormat:HU,csvFormatBody:ZU,csvFormatRow:XU,csvFormatRows:WU,csvFormatValue:YU,csvParse:zz,csvParseRows:qU,cubehelix:ha,cumsum:IF,curveBasis:nZ,curveBasisClosed:iZ,curveBasisOpen:rZ,curveBumpX:iL,curveBumpY:rL,curveBundle:oZ,curveCardinal:sZ,curveCardinalClosed:aZ,curveCardinalOpen:lZ,curveCatmullRom:cZ,curveCatmullRomClosed:uZ,curveCatmullRomOpen:hZ,curveLinear:Mx,curveLinearClosed:fZ,curveMonotoneX:dZ,curveMonotoneY:pZ,curveNatural:mZ,curveStep:_Z,curveStepAfter:yZ,curveStepBefore:gZ,descending:sP,deviation:hP,difference:cB,disjoint:uB,dispatch:Rh,drag:pN,dragDisable:Jv,dragEnable:Qv,dsv:u7,dsvFormat:lx,easeBack:zM,easeBackIn:EV,easeBackInOut:zM,easeBackOut:AV,easeBounce:A_,easeBounceIn:TV,easeBounceInOut:SV,easeBounceOut:A_,easeCircle:PM,easeCircleIn:dV,easeCircleInOut:PM,easeCircleOut:pV,easeCubic:$w,easeCubicIn:oV,easeCubicInOut:$w,easeCubicOut:sV,easeElastic:RM,easeElasticIn:IV,easeElasticInOut:MV,easeElasticOut:RM,easeExp:CM,easeExpIn:hV,easeExpInOut:CM,easeExpOut:fV,easeLinear:nV,easePoly:IM,easePolyIn:aV,easePolyInOut:IM,easePolyOut:lV,easeQuad:AM,easeQuadIn:iV,easeQuadInOut:AM,easeQuadOut:rV,easeSin:MM,easeSinIn:cV,easeSinInOut:MM,easeSinOut:uV,every:iB,extent:l_,fcumsum:CF,filter:oB,flatGroup:PF,flatRollup:zF,forceCenter:y7,forceCollide:F7,forceLink:N7,forceManyBody:W7,forceRadial:X7,forceSimulation:Z7,forceX:Y7,forceY:K7,get format(){return fx},formatDefaultLocale:Bz,formatLocale:Fz,get formatPrefix(){return cT},formatSpecifier:Ld,fsum:MF,geoAlbers:wR,geoAlbersUsa:nj,geoArea:a9,geoAzimuthalEqualArea:ij,geoAzimuthalEqualAreaRaw:vT,geoAzimuthalEquidistant:rj,geoAzimuthalEquidistantRaw:xT,geoBounds:h9,geoCentroid:g9,geoCircle:y9,geoClipAntimeridian:a2,geoClipCircle:sR,geoClipExtent:E9,geoClipRectangle:dx,geoConicConformal:sj,geoConicConformalRaw:ER,geoConicEqualArea:Iv,geoConicEqualAreaRaw:bR,geoConicEquidistant:lj,geoConicEquidistantRaw:AR,geoContains:R9,geoDistance:vv,geoEqualEarth:uj,geoEqualEarthRaw:bT,geoEquirectangular:aj,geoEquirectangularRaw:z_,geoGnomonic:hj,geoGnomonicRaw:wT,geoGraticule:cR,geoGraticule10:D9,geoIdentity:fj,geoInterpolate:L9,geoLength:aR,geoMercator:oj,geoMercatorRaw:H_,geoNaturalEarth1:dj,geoNaturalEarth1Raw:TT,geoOrthographic:pj,geoOrthographicRaw:ST,geoPath:H9,geoProjection:Ya,geoProjectionMutator:gT,geoRotation:eR,geoStereographic:mj,geoStereographicRaw:ET,geoStream:aa,geoTransform:Z9,geoTransverseMercator:_j,geoTransverseMercatorRaw:AT,gray:AN,greatest:bP,greatestIndex:KF,group:mP,groupSort:LF,groups:Gy,hcl:Qy,hierarchy:IT,histogram:aM,hsl:Yy,html:_7,image:f7,index:RF,indexes:DF,interpolate:ru,interpolateArray:RN,interpolateBasis:KP,interpolateBasisClosed:JP,interpolateBlues:lH,interpolateBrBG:Uq,interpolateBuGn:Yq,interpolateBuPu:Kq,interpolateCividis:pH,interpolateCool:gH,interpolateCubehelix:ZN,interpolateCubehelixDefault:mH,interpolateCubehelixLong:rx,interpolateDate:rz,interpolateDiscrete:kN,interpolateGnBu:Jq,interpolateGreens:cH,interpolateGreys:uH,interpolateHcl:qN,interpolateHclLong:HN,interpolateHsl:jN,interpolateHslLong:$N,interpolateHue:ON,interpolateInferno:EH,interpolateLab:GN,interpolateMagma:SH,interpolateNumber:ks,interpolateNumberArray:X2,interpolateObject:oz,interpolateOrRd:Qq,interpolateOranges:dH,interpolatePRGn:jq,interpolatePiYG:$q,interpolatePlasma:AH,interpolatePuBu:tH,interpolatePuBuGn:eH,interpolatePuOr:Gq,interpolatePuRd:nH,interpolatePurples:hH,interpolateRainbow:yH,interpolateRdBu:qq,interpolateRdGy:Hq,interpolateRdPu:iH,interpolateRdYlBu:Zq,interpolateRdYlGn:Wq,interpolateReds:fH,interpolateRgb:T_,interpolateRgbBasis:tz,interpolateRgbBasisClosed:zN,interpolateRound:ix,interpolateSinebow:bH,interpolateSpectral:Xq,interpolateString:Y2,interpolateTransformCss:lz,interpolateTransformSvg:cz,interpolateTurbo:wH,interpolateViridis:TH,interpolateWarm:_H,interpolateYlGn:oH,interpolateYlGnBu:rH,interpolateYlOrBr:sH,interpolateYlOrRd:aH,interpolateZoom:uz,interrupt:xh,intersection:hB,interval:JN,isoFormat:bq,isoParse:Tq,json:p7,lab:Jy,lch:IN,least:YF,leastIndex:SP,line:ZT,lineRadial:mC,link:Cx,linkHorizontal:GH,linkRadial:HH,linkVertical:qH,local:OP,map:sB,matcher:j2,max:y_,maxIndex:B2,mean:jF,median:$F,medianIndex:GF,merge:V2,min:Zy,minIndex:N2,mode:HF,namespace:B_,namespaces:Dw,nice:O2,now:V_,pack:e$,packEnclose:Wj,packSiblings:Jj,pairs:ZF,partition:t$,path:oT,pathRound:QV,permute:xP,pie:NH,piecewise:pz,pointRadial:s_,pointer:ys,pointers:aN,polygonArea:g$,polygonCentroid:y$,polygonContains:w$,polygonHull:b$,polygonLength:T$,precisionFixed:Nz,precisionPrefix:Vz,precisionRound:Uz,quadtree:ux,quantile:v_,quantileIndex:TP,quantileSorted:wP,quantize:WN,quickselect:Wv,radialArea:_C,radialLine:mC,randomBates:I$,randomBernoulli:P$,randomBeta:NR,randomBinomial:VR,randomCauchy:R$,randomExponential:M$,randomGamma:PT,randomGeometric:BR,randomInt:E$,randomIrwinHall:FR,randomLcg:F$,randomLogNormal:A$,randomLogistic:D$,randomNormal:CT,randomPareto:C$,randomPoisson:L$,randomUniform:S$,randomWeibull:z$,range:Nl,rank:XF,reduce:aB,reverse:lB,rgb:Pd,ribbon:aU,ribbonArrow:lU,rollup:gP,rollups:yP,scaleBand:RT,scaleDiverging:wD,scaleDivergingLog:TD,scaleDivergingPow:GT,scaleDivergingSqrt:Cq,scaleDivergingSymlog:SD,scaleIdentity:$R,scaleImplicit:b2,scaleLinear:Pv,scaleLog:qR,scaleOrdinal:zT,scalePoint:B$,scalePow:FT,scaleQuantile:WR,scaleQuantize:XR,scaleRadial:ZR,scaleSequential:yD,scaleSequentialLog:vD,scaleSequentialPow:$T,scaleSequentialQuantile:bD,scaleSequentialSqrt:Mq,scaleSequentialSymlog:xD,scaleSqrt:Y$,scaleSymlog:HR,scaleThreshold:YR,scaleTime:Aq,scaleUtc:Iq,scan:JF,schemeAccent:zq,schemeBlues:HD,schemeBrBG:ED,schemeBuGn:LD,schemeBuPu:kD,schemeCategory10:Pq,schemeDark2:Rq,schemeGnBu:OD,schemeGreens:ZD,schemeGreys:WD,schemeObservable10:Dq,schemeOrRd:FD,schemeOranges:KD,schemePRGn:AD,schemePaired:Lq,schemePastel1:kq,schemePastel2:Oq,schemePiYG:ID,schemePuBu:ND,schemePuBuGn:BD,schemePuOr:MD,schemePuRd:VD,schemePurples:XD,schemeRdBu:CD,schemeRdGy:PD,schemeRdPu:UD,schemeRdYlBu:zD,schemeRdYlGn:RD,schemeReds:YD,schemeSet1:Fq,schemeSet2:Bq,schemeSet3:Nq,schemeSpectral:DD,schemeTableau10:Vq,schemeYlGn:$D,schemeYlGnBu:jD,schemeYlOrBr:GD,schemeYlOrRd:qD,select:Ao,selectAll:lN,selection:Dh,selector:Kv,selectorAll:U2,shuffle:QF,shuffler:EP,some:rB,sort:Pw,stack:bZ,stackOffsetDiverging:TZ,stackOffsetExpand:wZ,stackOffsetNone:Ud,stackOffsetSilhouette:SZ,stackOffsetWiggle:EZ,stackOrderAppearance:ML,stackOrderAscending:CL,stackOrderDescending:IZ,stackOrderInsideOut:MZ,stackOrderNone:jd,stackOrderReverse:CZ,stratify:o$,style:Sh,subset:dB,sum:eB,superset:IP,svg:g7,symbol:tZ,symbolAsterisk:oL,symbolCircle:Px,symbolCross:sL,symbolDiamond:lL,symbolDiamond2:cL,symbolPlus:uL,symbolSquare:hL,symbolSquare2:fL,symbolStar:pL,symbolTimes:S2,symbolTriangle:mL,symbolTriangle2:_L,symbolWye:gL,symbolX:S2,symbols:gC,symbolsFill:gC,symbolsStroke:eZ,text:cx,thresholdFreedmanDiaconis:VF,thresholdScott:UF,thresholdSturges:F2,tickFormat:jR,tickIncrement:Th,tickStep:Hy,ticks:wh,timeDay:Xd,timeDays:nG,get timeFormat(){return VT},timeFormatDefaultLocale:_D,timeFormatLocale:uD,timeFriday:QR,timeFridays:cG,timeHour:vx,timeHours:eG,timeInterval:Ur,timeMillisecond:Bd,timeMilliseconds:J3,timeMinute:gx,timeMinutes:J$,timeMonday:R_,timeMondays:oG,timeMonth:bx,timeMonths:gG,get timeParse(){return mD},timeSaturday:eD,timeSaturdays:uG,timeSecond:jl,timeSeconds:eC,timeSunday:Nd,timeSundays:tC,timeThursday:Ph,timeThursdays:lG,timeTickInterval:cD,timeTicks:lD,timeTuesday:KR,timeTuesdays:sG,timeWednesday:JR,timeWednesdays:aG,timeWeek:Nd,timeWeeks:tC,timeYear:Za,timeYears:vG,timeout:Nw,timer:sx,timerFlush:gz,transition:bz,transpose:AP,tree:f$,treemap:d$,treemapBinary:p$,treemapDice:Z_,treemapResquarify:_$,treemapSlice:mx,treemapSliceDice:m$,treemapSquarify:OR,tsv:h7,tsvFormat:JU,tsvFormatBody:QU,tsvFormatRow:t7,tsvFormatRows:e7,tsvFormatValue:n7,tsvParse:Rz,tsvParseRows:KU,union:pB,unixDay:NT,unixDays:rG,utcDay:X_,utcDays:iG,get utcFormat(){return Tx},utcFriday:iD,utcFridays:mG,utcHour:xx,utcHours:tG,utcMillisecond:Bd,utcMilliseconds:J3,utcMinute:yx,utcMinutes:Q$,utcMonday:D_,utcMondays:hG,utcMonth:wx,utcMonths:yG,get utcParse(){return UT},utcSaturday:rD,utcSaturdays:_G,utcSecond:jl,utcSeconds:eC,utcSunday:Vd,utcSundays:nC,utcThursday:zh,utcThursdays:pG,utcTickInterval:aD,utcTicks:sD,utcTuesday:tD,utcTuesdays:fG,utcWednesday:nD,utcWednesdays:dG,utcWeek:Vd,utcWeeks:nC,utcYear:Wa,utcYears:xG,variance:uP,window:$2,xml:m7,zip:nB,zoom:OZ,zoomIdentity:Dx,zoomTransform:zL},Symbol.toStringTag,{value:"Module"}));async function BZ(n){return await Lz(n)}async function NZ(n){const a=n.map(m=>BZ(m));return await Promise.all(a)}async function VZ(n){return await(await fetch("/elisa/"+n)).json()}async function UZ(n){const a=n.map(m=>VZ(m));return await Promise.all(a)}function TC(n){return{type:"FeatureCollection",features:n.map(a=>({type:"Feature",geometry:{type:"Point",coordinates:[+a.med_loc_x,+a.med_loc_y]},properties:{conflict_country:a.conflict_country,mediation_count:+a.mediation_count,fatalities_best:+a.fatalities_best,agreements_sum:+a.agreements_sum,dist_mediation_conflict:+a.dist_mediation_conflict}}))}}function SC(n){return{type:"FeatureCollection",features:n.map(a=>{const u=[+a.longitude_con,+a.latitude_con],m=[+a.med_loc_x,+a.med_loc_y];return{type:"Feature",geometry:{type:"LineString",coordinates:jZ(u,m,.2,100)},properties:{conflict_country:a.conflict_country,mediation_count:+a.mediation_count,fatalities_best:+a.fatalities_best,agreements_sum:+a.agreements_sum,dist_mediation_conflict:+a.dist_mediation_conflict}}})}}function vy(n,a,u){u||(u=100);for(var m={latitude:n[1],longitude:n[0]},y=a,x=[],E=y/(111.32*Math.cos(m.latitude*Math.PI/180)),r=y/110.574,P,M,L,V=0;V<u;V++)P=V/u*(2*Math.PI),M=E*Math.cos(P),L=r*Math.sin(P),x.push([m.longitude+M,m.latitude+L]);return x.push(x[0]),{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[x]},properties:{}}]}}function jZ(n,a,u,m){let y=$Z(n,a,u),x=RL(y,n),E=Math.atan2(n[1]-y[1],n[0]-y[0]),r=Math.atan2(a[1]-y[1],a[0]-y[0]);E>r&&(r+=2*Math.PI);let P=Nl(E,r,(r-E)/m).map(M=>[Math.cos(M)*x+y[0],Math.sin(M)*x+y[1]]);return P.push(a),P}function $Z(n,a,u){let m=qZ(n,a,u),y=EC(n,a),x=EC(n,m),E=kv(n,a),r=kv(n,m),P=(x-y)/(E-r),M=E*P+y;return[P,M]}function EC(n,a){let u=kv(n,a),m=DL(n,a),y=m[0];return m[1]-u*y}function kv(n,a){return-1*(1/GZ(n,a))}function GZ(n,a){return(a[1]-n[1])/(a[0]-n[0])}function qZ(n,a,u){let m=DL(n,a),y=kv(n,a),x=a[1]<n[1]?-1:1,r=.5*RL(n,a)*u/Math.sqrt(1+Math.pow(y,2)),P=y*r;return[x*r+m[0],x*P+m[1]]}function RL(n,a){return Math.sqrt(Math.pow(n[0]-a[0],2)+Math.pow(n[1]-a[1],2))}function DL(n,a){return[(n[0]+a[0])/2,(n[1]+a[1])/2]}function HZ(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Ly={exports:{}},ZZ=Ly.exports,AC;function WZ(){return AC||(AC=1,function(n,a){(function(u,m){n.exports=m()})(ZZ,function(){var u,m,y;function x(r,P){if(!u)u=P;else if(!m)m=P;else{var M="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+u+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",L={};u(L),y=P(L),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(y.workerUrl=window.URL.createObjectURL(new Blob([M],{type:"text/javascript"})))}}x(["exports"],function(r){var P=1e-6,M=typeof Float32Array<"u"?Float32Array:Array;function L(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=i*d-c*l;return p?(o[0]=d*(p=1/p),o[1]=-l*p,o[2]=-c*p,o[3]=i*p,o):null}function V(){var o=new M(9);return M!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[5]=0,o[6]=0,o[7]=0),o[0]=1,o[4]=1,o[8]=1,o}function k(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=e[4],v=e[5],w=e[6],S=e[7],I=e[8];return o[0]=p*I-v*S,o[1]=c*S-l*I,o[2]=l*v-c*p,o[3]=v*w-d*I,o[4]=i*I-c*w,o[5]=c*d-i*v,o[6]=d*S-p*w,o[7]=l*w-i*S,o[8]=i*p-l*d,o}function j(o,e,i){var l=e[0],c=e[1],d=e[2],p=e[3],v=e[4],w=e[5],S=e[6],I=e[7],C=e[8],R=i[0],B=i[1],N=i[2],$=i[3],X=i[4],K=i[5],le=i[6],re=i[7],G=i[8];return o[0]=R*l+B*p+N*S,o[1]=R*c+B*v+N*I,o[2]=R*d+B*w+N*C,o[3]=$*l+X*p+K*S,o[4]=$*c+X*v+K*I,o[5]=$*d+X*w+K*C,o[6]=le*l+re*p+G*S,o[7]=le*c+re*v+G*I,o[8]=le*d+re*w+G*C,o}function te(){var o=new M(16);return M!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=0,o[12]=0,o[13]=0,o[14]=0),o[0]=1,o[5]=1,o[10]=1,o[15]=1,o}function J(o){return o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function Q(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=e[4],v=e[5],w=e[6],S=e[7],I=e[8],C=e[9],R=e[10],B=e[11],N=e[12],$=e[13],X=e[14],K=e[15],le=i*v-l*p,re=i*w-c*p,G=i*S-d*p,ne=l*w-c*v,ae=l*S-d*v,de=c*S-d*w,be=I*$-C*N,Ie=I*X-R*N,Me=I*K-B*N,ke=C*X-R*$,Ye=C*K-B*$,ft=R*K-B*X,at=le*ft-re*Ye+G*ke+ne*Me-ae*Ie+de*be;return at?(o[0]=(v*ft-w*Ye+S*ke)*(at=1/at),o[1]=(c*Ye-l*ft-d*ke)*at,o[2]=($*de-X*ae+K*ne)*at,o[3]=(R*ae-C*de-B*ne)*at,o[4]=(w*Me-p*ft-S*Ie)*at,o[5]=(i*ft-c*Me+d*Ie)*at,o[6]=(X*G-N*de-K*re)*at,o[7]=(I*de-R*G+B*re)*at,o[8]=(p*Ye-v*Me+S*be)*at,o[9]=(l*Me-i*Ye-d*be)*at,o[10]=(N*ae-$*G+K*le)*at,o[11]=(C*G-I*ae-B*le)*at,o[12]=(v*Ie-p*ke-w*be)*at,o[13]=(i*ke-l*Ie+c*be)*at,o[14]=($*re-N*ne-X*le)*at,o[15]=(I*ne-C*re+R*le)*at,o):null}function ee(o,e,i){var l=e[0],c=e[1],d=e[2],p=e[3],v=e[4],w=e[5],S=e[6],I=e[7],C=e[8],R=e[9],B=e[10],N=e[11],$=e[12],X=e[13],K=e[14],le=e[15],re=i[0],G=i[1],ne=i[2],ae=i[3];return o[0]=re*l+G*v+ne*C+ae*$,o[1]=re*c+G*w+ne*R+ae*X,o[2]=re*d+G*S+ne*B+ae*K,o[3]=re*p+G*I+ne*N+ae*le,o[4]=(re=i[4])*l+(G=i[5])*v+(ne=i[6])*C+(ae=i[7])*$,o[5]=re*c+G*w+ne*R+ae*X,o[6]=re*d+G*S+ne*B+ae*K,o[7]=re*p+G*I+ne*N+ae*le,o[8]=(re=i[8])*l+(G=i[9])*v+(ne=i[10])*C+(ae=i[11])*$,o[9]=re*c+G*w+ne*R+ae*X,o[10]=re*d+G*S+ne*B+ae*K,o[11]=re*p+G*I+ne*N+ae*le,o[12]=(re=i[12])*l+(G=i[13])*v+(ne=i[14])*C+(ae=i[15])*$,o[13]=re*c+G*w+ne*R+ae*X,o[14]=re*d+G*S+ne*B+ae*K,o[15]=re*p+G*I+ne*N+ae*le,o}function ue(o,e,i){var l,c,d,p,v,w,S,I,C,R,B,N,$=i[0],X=i[1],K=i[2];return e===o?(o[12]=e[0]*$+e[4]*X+e[8]*K+e[12],o[13]=e[1]*$+e[5]*X+e[9]*K+e[13],o[14]=e[2]*$+e[6]*X+e[10]*K+e[14],o[15]=e[3]*$+e[7]*X+e[11]*K+e[15]):(c=e[1],d=e[2],p=e[3],v=e[4],w=e[5],S=e[6],I=e[7],C=e[8],R=e[9],B=e[10],N=e[11],o[0]=l=e[0],o[1]=c,o[2]=d,o[3]=p,o[4]=v,o[5]=w,o[6]=S,o[7]=I,o[8]=C,o[9]=R,o[10]=B,o[11]=N,o[12]=l*$+v*X+C*K+e[12],o[13]=c*$+w*X+R*K+e[13],o[14]=d*$+S*X+B*K+e[14],o[15]=p*$+I*X+N*K+e[15]),o}function ce(o,e,i){var l=i[0],c=i[1],d=i[2];return o[0]=e[0]*l,o[1]=e[1]*l,o[2]=e[2]*l,o[3]=e[3]*l,o[4]=e[4]*c,o[5]=e[5]*c,o[6]=e[6]*c,o[7]=e[7]*c,o[8]=e[8]*d,o[9]=e[9]*d,o[10]=e[10]*d,o[11]=e[11]*d,o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15],o}function se(o,e,i){var l=Math.sin(i),c=Math.cos(i),d=e[4],p=e[5],v=e[6],w=e[7],S=e[8],I=e[9],C=e[10],R=e[11];return e!==o&&(o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[3],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[4]=d*c+S*l,o[5]=p*c+I*l,o[6]=v*c+C*l,o[7]=w*c+R*l,o[8]=S*c-d*l,o[9]=I*c-p*l,o[10]=C*c-v*l,o[11]=R*c-w*l,o}function Ae(o,e,i){var l=Math.sin(i),c=Math.cos(i),d=e[0],p=e[1],v=e[2],w=e[3],S=e[8],I=e[9],C=e[10],R=e[11];return e!==o&&(o[4]=e[4],o[5]=e[5],o[6]=e[6],o[7]=e[7],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[0]=d*c-S*l,o[1]=p*c-I*l,o[2]=v*c-C*l,o[3]=w*c-R*l,o[8]=d*l+S*c,o[9]=p*l+I*c,o[10]=v*l+C*c,o[11]=w*l+R*c,o}function De(o,e,i){var l=Math.sin(i),c=Math.cos(i),d=e[0],p=e[1],v=e[2],w=e[3],S=e[4],I=e[5],C=e[6],R=e[7];return e!==o&&(o[8]=e[8],o[9]=e[9],o[10]=e[10],o[11]=e[11],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[0]=d*c+S*l,o[1]=p*c+I*l,o[2]=v*c+C*l,o[3]=w*c+R*l,o[4]=S*c-d*l,o[5]=I*c-p*l,o[6]=C*c-v*l,o[7]=R*c-w*l,o}function Qe(o,e){return o[0]=e[0],o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=e[1],o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=e[2],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function nt(o,e,i){var l,c,d,p=i[0],v=i[1],w=i[2],S=Math.hypot(p,v,w);return S<P?null:(p*=S=1/S,v*=S,w*=S,l=Math.sin(e),c=Math.cos(e),o[0]=p*p*(d=1-c)+c,o[1]=v*p*d+w*l,o[2]=w*p*d-v*l,o[3]=0,o[4]=p*v*d-w*l,o[5]=v*v*d+c,o[6]=w*v*d+p*l,o[7]=0,o[8]=p*w*d+v*l,o[9]=v*w*d-p*l,o[10]=w*w*d+c,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o)}function rt(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=i+i,v=l+l,w=c+c,S=i*p,I=l*p,C=l*v,R=c*p,B=c*v,N=c*w,$=d*p,X=d*v,K=d*w;return o[0]=1-C-N,o[1]=I+K,o[2]=R-X,o[3]=0,o[4]=I-K,o[5]=1-S-N,o[6]=B+$,o[7]=0,o[8]=R+X,o[9]=B-$,o[10]=1-S-C,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}Math.hypot||(Math.hypot=function(){for(var o=0,e=arguments.length;e--;)o+=arguments[e]*arguments[e];return Math.sqrt(o)});var tt=ee;function Be(){var o=new M(3);return M!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o}function Rt(o){var e=new M(3);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e}function ut(o){return Math.hypot(o[0],o[1],o[2])}function Pe(o,e,i){var l=new M(3);return l[0]=o,l[1]=e,l[2]=i,l}function Ve(o,e,i){return o[0]=e[0]+i[0],o[1]=e[1]+i[1],o[2]=e[2]+i[2],o}function qe(o,e,i){return o[0]=e[0]-i[0],o[1]=e[1]-i[1],o[2]=e[2]-i[2],o}function bt(o,e,i){return o[0]=e[0]*i[0],o[1]=e[1]*i[1],o[2]=e[2]*i[2],o}function Ht(o,e,i){return o[0]=Math.min(e[0],i[0]),o[1]=Math.min(e[1],i[1]),o[2]=Math.min(e[2],i[2]),o}function Dt(o,e,i){return o[0]=Math.max(e[0],i[0]),o[1]=Math.max(e[1],i[1]),o[2]=Math.max(e[2],i[2]),o}function Lt(o,e,i){return o[0]=e[0]*i,o[1]=e[1]*i,o[2]=e[2]*i,o}function rn(o,e,i,l){return o[0]=e[0]+i[0]*l,o[1]=e[1]+i[1]*l,o[2]=e[2]+i[2]*l,o}function yn(o,e){var i=e[0]-o[0],l=e[1]-o[1],c=e[2]-o[2];return i*i+l*l+c*c}function pi(o){var e=o[0],i=o[1],l=o[2];return e*e+i*i+l*l}function ti(o,e){return o[0]=-e[0],o[1]=-e[1],o[2]=-e[2],o}function hn(o,e){var i=e[0],l=e[1],c=e[2],d=i*i+l*l+c*c;return d>0&&(d=1/Math.sqrt(d)),o[0]=e[0]*d,o[1]=e[1]*d,o[2]=e[2]*d,o}function Nn(o,e){return o[0]*e[0]+o[1]*e[1]+o[2]*e[2]}function Pn(o,e,i){var l=e[0],c=e[1],d=e[2],p=i[0],v=i[1],w=i[2];return o[0]=c*w-d*v,o[1]=d*p-l*w,o[2]=l*v-c*p,o}function Gi(o,e,i,l){var c=e[0],d=e[1],p=e[2];return o[0]=c+l*(i[0]-c),o[1]=d+l*(i[1]-d),o[2]=p+l*(i[2]-p),o}function Ct(o,e,i){var l=e[0],c=e[1],d=e[2],p=i[3]*l+i[7]*c+i[11]*d+i[15];return o[0]=(i[0]*l+i[4]*c+i[8]*d+i[12])/(p=p||1),o[1]=(i[1]*l+i[5]*c+i[9]*d+i[13])/p,o[2]=(i[2]*l+i[6]*c+i[10]*d+i[14])/p,o}function fn(o,e,i){var l=e[0],c=e[1],d=e[2];return o[0]=l*i[0]+c*i[3]+d*i[6],o[1]=l*i[1]+c*i[4]+d*i[7],o[2]=l*i[2]+c*i[5]+d*i[8],o}function Tn(o,e,i){var l=i[0],c=i[1],d=i[2],p=e[0],v=e[1],w=e[2],S=c*w-d*v,I=d*p-l*w,C=l*v-c*p,R=c*C-d*I,B=d*S-l*C,N=l*I-c*S,$=2*i[3];return I*=$,C*=$,B*=2,N*=2,o[0]=p+(S*=$)+(R*=2),o[1]=v+I+B,o[2]=w+C+N,o}function It(o,e){return o[0]===e[0]&&o[1]===e[1]&&o[2]===e[2]}var dn=qe,$n=bt,Qi=ut;function bi(){var o=new M(4);return M!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0,o[3]=0),o}function vn(o,e,i){return o[0]=e[0]*i,o[1]=e[1]*i,o[2]=e[2]*i,o[3]=e[3]*i,o}function wi(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=i*i+l*l+c*c+d*d;return p>0&&(p=1/Math.sqrt(p)),o[0]=i*p,o[1]=l*p,o[2]=c*p,o[3]=d*p,o}function tr(o,e,i){var l=e[0],c=e[1],d=e[2],p=e[3];return o[0]=i[0]*l+i[4]*c+i[8]*d+i[12]*p,o[1]=i[1]*l+i[5]*c+i[9]*d+i[13]*p,o[2]=i[2]*l+i[6]*c+i[10]*d+i[14]*p,o[3]=i[3]*l+i[7]*c+i[11]*d+i[15]*p,o}function yr(){var o=new M(4);return M!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o[3]=1,o}function da(o){return o[0]=0,o[1]=0,o[2]=0,o[3]=1,o}function Us(o,e,i){i*=.5;var l=e[0],c=e[1],d=e[2],p=e[3],v=Math.sin(i),w=Math.cos(i);return o[0]=l*w+p*v,o[1]=c*w+d*v,o[2]=d*w-c*v,o[3]=p*w-l*v,o}function Ka(o,e,i){i*=.5;var l=e[0],c=e[1],d=e[2],p=e[3],v=Math.sin(i),w=Math.cos(i);return o[0]=l*w-d*v,o[1]=c*w+p*v,o[2]=d*w+l*v,o[3]=p*w-c*v,o}Be(),bi();var so,Io,au,Ja,Xl,bs=wi,js=(so=Be(),Io=Pe(1,0,0),au=Pe(0,1,0),function(o,e,i){var l=Nn(e,i);return l<-.999999?(Pn(so,Io,e),Qi(so)<1e-6&&Pn(so,au,e),hn(so,so),function(c,d,p){p*=.5;var v=Math.sin(p);c[0]=v*d[0],c[1]=v*d[1],c[2]=v*d[2],c[3]=Math.cos(p)}(o,so,Math.PI),o):l>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(Pn(so,e,i),o[0]=so[0],o[1]=so[1],o[2]=so[2],o[3]=1+l,bs(o,o))});function ao(){var o=new M(2);return M!=Float32Array&&(o[0]=0,o[1]=0),o}function Qa(o,e){var i=new M(2);return i[0]=o,i[1]=e,i}function pa(o,e,i){return o[0]=e[0]+i[0],o[1]=e[1]+i[1],o}function ws(o,e,i){return o[0]=e[0]-i[0],o[1]=e[1]-i[1],o}function el(o,e,i){return o[0]=e[0]*i,o[1]=e[1]*i,o}function tl(o){return Math.hypot(o[0],o[1])}function lu(o,e){var i=e[0],l=e[1],c=i*i+l*l;return c>0&&(c=1/Math.sqrt(c)),o[0]=e[0]*c,o[1]=e[1]*c,o}function Bi(o,e){return o[0]*e[0]+o[1]*e[1]}function Ts(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}yr(),yr(),V(),ao();var Yl,qo,cu=function(){if(Xl)return Ja;function o(e,i,l,c){this.cx=3*e,this.bx=3*(l-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(c-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=l,this.p2y=c}return Xl=1,Ja=o,o.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var l=e,c=0;c<8;c++){var d=this.sampleCurveX(l)-e;if(Math.abs(d)<i)return l;var p=this.sampleCurveDerivativeX(l);if(Math.abs(p)<1e-6)break;l-=d/p}var v=0,w=1;for(l=e,c=0;c<20&&(d=this.sampleCurveX(l),!(Math.abs(d-e)<i));c++)e>d?v=l:w=l,l=.5*(w-v)+v;return l},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Ja}(),Bh=Ts(cu);function uu(){if(qo)return Yl;function o(e,i){this.x=e,this.y=i}return qo=1,Yl=o,o.prototype={clone:function(){return new o(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,i){return this.clone()._rotateAround(e,i)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var i=e.x-this.x,l=e.y-this.y;return i*i+l*l},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,i){return Math.atan2(this.x*i-this.y*e,this.x*e+this.y*i)},_matMult:function(e){var i=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=i,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var i=Math.cos(e),l=Math.sin(e),c=l*this.x+i*this.y;return this.x=i*this.x-l*this.y,this.y=c,this},_rotateAround:function(e,i){var l=Math.cos(e),c=Math.sin(e),d=i.y+c*(this.x-i.x)+l*(this.y-i.y);return this.x=i.x+l*(this.x-i.x)-c*(this.y-i.y),this.y=d,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},o.convert=function(e){return e instanceof o?e:Array.isArray(e)?new o(e[0],e[1]):e},Yl}var St=Ts(uu());function $s(o,e){if(Array.isArray(o)){if(!Array.isArray(e)||o.length!==e.length)return!1;for(let i=0;i<o.length;i++)if(!$s(o[i],e[i]))return!1;return!0}if(typeof o=="object"&&o!==null&&e!==null){if(typeof e!="object"||Object.keys(o).length!==Object.keys(e).length)return!1;for(const i in o)if(!$s(o[i],e[i]))return!1;return!0}return o===e}const Nh=Math.PI/180,Ke=180/Math.PI;function W(o){return o*Nh}function ie(o){return o*Ke}const ge=[[0,0],[1,0],[1,1],[0,1]];function Ee(o){if(o<=0)return 0;if(o>=1)return 1;const e=o*o,i=e*o;return 4*(o<.5?i:3*(o-e)+i-.75)}function Se(o,e,i,l){const c=new Bh(o,e,i,l);return function(d){return c.solve(d)}}const Ce=Se(.25,.1,.25,1);function ze(o,e,i){return Math.min(i,Math.max(e,o))}function Re(o,e,i){return(i=ze((i-o)/(e-o),0,1))*i*(3-2*i)}function He(o,e,i){const l=i-e,c=((o-e)%l+l)%l+e;return c===e?i:c}function it(o,e,i){if(!o.length)return i(null,[]);let l=o.length;const c=new Array(o.length);let d=null;o.forEach((p,v)=>{e(p,(w,S)=>{w&&(d=w),c[v]=S,--l==0&&i(d,c)})})}function $e(o,...e){for(const i of e)for(const l in i)o[l]=i[l];return o}let Et=1;function kt(){return Et++}function Zt(o){return o<=1?1:Math.pow(2,Math.ceil(Math.log(o)/Math.LN2))}function un(o,e){o.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function _n(o,e,i){const l={};for(const c in o)l[c]=e.call(this,o[c],c,o);return l}function An(o,e,i){const l={};for(const c in o)e.call(this,o[c],c,o)&&(l[c]=o[c]);return l}function zn(o){return Array.isArray(o)?o.map(zn):typeof o=="object"&&o?_n(o,zn):o}const qi={};function Dn(o){qi[o]||(typeof console<"u"&&console.warn(o),qi[o]=!0)}function _i(o,e,i){return(i.y-o.y)*(e.x-o.x)>(e.y-o.y)*(i.x-o.x)}function Xn(o){let e=0;for(let i,l,c=0,d=o.length,p=d-1;c<d;p=c++)i=o[c],l=o[p],e+=(l.x-i.x)*(i.y+l.y);return e}function gi([o,e,i]){const l=W(e+90),c=W(i);return{x:o*Math.cos(l)*Math.sin(c),y:o*Math.sin(l)*Math.sin(c),z:o*Math.cos(c),azimuthal:e,polar:i}}function Ti(o){return(typeof self<"u"||o!==void 0)&&typeof WorkerGlobalScope<"u"&&(o!==void 0?o:self)instanceof WorkerGlobalScope}function er(o){const e={};if(o.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,l,c,d)=>{const p=c||d;return e[l]=!p||p.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let hr=null;function br(o,e){return[o[4*e],o[4*e+1],o[4*e+2],o[4*e+3]]}function Dr(o,e,i,l){for(;e<i;){const c=e+i>>1;o[c]<l?e=c+1:i=c}return e}function Gs(o,e,i,l){for(;e<i;){const c=e+i>>1;o[c]<=l?e=c+1:i=c}return e}function jr(o){return o>0?1/(1.001-o):1+o}function $r(o){return o>0?1-1/(1.001-o):-o}function Mr(o,e,i){return(o-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const Or={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Or.API_URL)return null;try{const o=new URL(Or.API_URL);return o.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":o.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Ss(o){return Or.API_URL_REGEX.test(o)}function nl(o){return Or.API_SPRITE_REGEX.test(o)}let hu,Kl,Vh,fu,il,du;function Yd(){return hu==null&&(hu=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),hu}const rs={now:()=>fu!==void 0?fu:performance.now(),setNow(o){fu=o},restoreNow(){fu=void 0},frame(o){const e=requestAnimationFrame(o);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(o,e=0){const{width:i,height:l}=o;il||(il=document.createElement("canvas"));const c=il.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(i>il.width||l>il.height)&&(il.width=i,il.height=l),c.clearRect(-e,-e,i+2*e,l+2*e),c.drawImage(o,0,0,i,l),c.getImageData(-e,-e,i+2*e,l+2*e)},resolveURL:o=>(Kl||(Kl=document.createElement("a")),Kl.href=o,Kl.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Vh==null&&(Vh=window.matchMedia("(prefers-reduced-motion: reduce)")),Vh.matches)},hasCanvasFingerprintNoise(){if(du!==void 0)return du;if(!Yd())return du=!1,!1;const o=new OffscreenCanvas(85,1),e=o.getContext("2d",{willReadFrequently:!0});let i=0;for(let c=0;c<o.width;++c)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(c,0,1,1);const l=e.getImageData(0,0,o.width,o.height);i=0;for(let c=0;c<l.data.length;++c)if(c%4!=3&&i++!==l.data[c])return du=!0,!0;return du=!1,!1}};function Kd(o,e){const i=o.indexOf("?");if(i<0)return`${o}?${new URLSearchParams(e).toString()}`;const l=new URLSearchParams(o.slice(i));for(const c in e)l.set(c,e[c]);return`${o.slice(0,i)}?${l.toString()}`}function po(o,e={persistentParams:[]}){const i=o.indexOf("?");if(i<0)return o;const l=new URLSearchParams,c=new URLSearchParams(o.slice(i));for(const p of e.persistentParams){const v=c.get(p);v&&l.set(p,v)}const d=l.toString();return`${o.slice(0,i)}${d.length>0?`?${d}`:""}`}const os="mapbox-tiles";let qs=500,ss=50;const Hs=["language","worldview","jobid"];let Ho,pu;function Jd(){try{return caches}catch{}}function Zs(){const o=Jd();o&&Ho==null&&(Ho=o.open(os))}let mu=1/0;const Qd={supported:!1,testSupport:function(o){!Uh&&Wr&&(jh?K_(o):_u=o)}};let _u,Wr,Uh=!1,jh=!1;const Jl=typeof self<"u"?self:{};function K_(o){const e=o.createTexture();o.bindTexture(o.TEXTURE_2D,e);try{if(o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,Wr),o.isContextLost())return;Qd.supported=!0}catch{}o.deleteTexture(e),Uh=!0}Jl.document&&(Wr=Jl.document.createElement("img"),Wr.onload=function(){_u&&K_(_u),_u=null,jh=!0},Wr.onerror=function(){Uh=!0,_u=null},Wr.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const $h={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze($h);class Gh extends Error{constructor(e,i,l){i===401&&Ss(l)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=l}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Hn=Ti()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Ql=function(o,e){if(!(/^file:/.test(i=o.url)||/^file:/.test(Hn())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(l,c){const d=new AbortController,p=new Request(l.url,{method:l.method||"GET",body:l.body,credentials:l.credentials,headers:l.headers,referrer:Hn(),referrerPolicy:l.referrerPolicy,signal:d.signal});let v=!1,w=!1;const S=(I=p.url).indexOf("sku=")>0&&Ss(I);var I;l.type==="json"&&p.headers.set("Accept","application/json");const C=(B,N,$)=>{if(w)return;if(B&&B.message!=="SecurityError"&&Dn(B.toString()),N&&$)return R(N);const X=Date.now();fetch(p).then(K=>{if(K.ok){const le=S?K.clone():null;return R(K,le,X)}return c(new Gh(K.statusText,K.status,l.url))}).catch(K=>{K.name!=="AbortError"&&c(new Error(`${K.message} ${l.url}`))})},R=(B,N,$)=>{(l.type==="arrayBuffer"?B.arrayBuffer():l.type==="json"?B.json():B.text()).then(X=>{w||(N&&$&&function(K,le,re){if(Zs(),Ho==null)return;const G=er(le.headers.get("Cache-Control")||"");if(G["no-store"])return;const ne={status:le.status,statusText:le.statusText,headers:new Headers};le.headers.forEach((be,Ie)=>ne.headers.set(Ie,be)),G["max-age"]&&ne.headers.set("Expires",new Date(re+1e3*G["max-age"]).toUTCString());const ae=ne.headers.get("Expires");if(!ae||new Date(ae).getTime()-re<42e4)return;let de=po(K.url,{persistentParams:Hs});if(le.status===206){const be=K.headers.get("Range");if(!be)return;ne.status=200,de=Kd(de,{range:be})}(function(be,Ie){if(pu===void 0)try{new Response(new ReadableStream),pu=!0}catch{pu=!1}pu?Ie(be.body):be.blob().then(Ie).catch(Me=>Dn(Me.message))})(le,be=>{const Ie=new Response((Me=le.status)!==200&&Me!==404&&[101,103,204,205,304].includes(Me)?null:be,ne);var Me;Zs(),Ho!=null&&Ho.then(ke=>ke.put(de,Ie)).catch(ke=>Dn(ke.message))})}(p,N,$),v=!0,c(null,X,B.headers.get("Cache-Control"),B.headers.get("Expires")))}).catch(X=>{w||c(new Error(X.message))})};return S?function(B,N){if(Zs(),Ho==null)return N(null);Ho.then($=>{let X=po(B.url,{persistentParams:Hs});const K=B.headers.get("Range");K&&(X=Kd(X,{range:K})),$.match(X).then(le=>{const re=function(G){if(!G)return!1;const ne=new Date(G.headers.get("Expires")||0),ae=er(G.headers.get("Cache-Control")||"");return Number(ne)>Date.now()&&!ae["no-cache"]}(le);$.delete(X).catch(N),re&&$.put(X,le.clone()).catch(N),N(null,le,re)}).catch(N)}).catch(N)}(p,C):C(null,null),{cancel:()=>{w=!0,v||d.abort()}}}(o,e);if(Ti(self)&&self.worker.actor)return self.worker.actor.send("getResource",o,e,void 0,!0)}var i;return function(l,c){const d=new XMLHttpRequest;d.open(l.method||"GET",l.url,!0),l.type==="arrayBuffer"&&(d.responseType="arraybuffer");for(const p in l.headers)d.setRequestHeader(p,l.headers[p]);return l.type==="json"&&(d.responseType="text",d.setRequestHeader("Accept","application/json")),d.withCredentials=l.credentials==="include",d.onerror=()=>{c(new Error(d.statusText))},d.onload=()=>{if((d.status>=200&&d.status<300||d.status===0)&&d.response!==null){let p=d.response;if(l.type==="json")try{p=JSON.parse(d.response)}catch(v){return c(v)}c(null,p,d.getResponseHeader("Cache-Control"),d.getResponseHeader("Expires"))}else c(new Gh(d.statusText,d.status,l.url))},d.send(l.body),{cancel:()=>d.abort()}}(o,e)},ec=function(o,e){return Ql($e(o,{type:"arrayBuffer"}),e)};function Lx(o){const e=document.createElement("a");return e.href=o,e.protocol===location.protocol&&e.host===location.host}const J_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let rl,ma;rl=[],ma=0;const tc=function(o,e){if(Qd.supported&&(o.headers||(o.headers={}),o.headers.accept="image/webp,*/*"),ma>=Or.MAX_PARALLEL_IMAGE_REQUESTS){const d={requestParameters:o,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return rl.push(d),d}ma++;let i=!1;const l=()=>{if(!i)for(i=!0,ma--;rl.length&&ma<Or.MAX_PARALLEL_IMAGE_REQUESTS;){const d=rl.shift(),{requestParameters:p,callback:v,cancelled:w}=d;w||(d.cancel=tc(p,v).cancel)}},c=ec(o,(d,p,v,w)=>{l(),d?e(d):p&&(self.createImageBitmap?function(S,I){const C=new Blob([new Uint8Array(S)],{type:"image/png"});createImageBitmap(C).then(R=>{I(null,R)}).catch(R=>{I(new Error(`Could not load image because of ${R.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(S,I)=>e(S,I,v,w)):function(S,I){const C=new Image;C.onload=()=>{I(null,C),URL.revokeObjectURL(C.src),C.onload=null,requestAnimationFrame(()=>{C.src=J_})},C.onerror=()=>I(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const R=new Blob([new Uint8Array(S)],{type:"image/png"});C.src=S.byteLength?URL.createObjectURL(R):J_}(p,(S,I)=>e(S,I,v,w)))});return{cancel:()=>{c.cancel(),l()}}};var Q_,ep,ol,gu={exports:{}},nc={exports:{}},qh={exports:{}},tp=function(){if(ol)return gu.exports;ol=1;var o=(Q_||(Q_=1,nc.exports=function(i,l){var c,d,p,v,w,S,I,C;for(d=i.length-(c=3&i.length),p=l,w=3432918353,S=461845907,C=0;C<d;)I=255&i.charCodeAt(C)|(255&i.charCodeAt(++C))<<8|(255&i.charCodeAt(++C))<<16|(255&i.charCodeAt(++C))<<24,++C,p=27492+(65535&(v=5*(65535&(p=(p^=I=(65535&(I=(I=(65535&I)*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*S+(((I>>>16)*S&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(v>>>16)&65535)<<16);switch(I=0,c){case 3:I^=(255&i.charCodeAt(C+2))<<16;case 2:I^=(255&i.charCodeAt(C+1))<<8;case 1:p^=I=(65535&(I=(I=(65535&(I^=255&i.charCodeAt(C)))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*S+(((I>>>16)*S&65535)<<16)&4294967295}return p^=i.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),nc.exports),e=(ep||(ep=1,qh.exports=function(i,l){for(var c,d=i.length,p=l^d,v=0;d>=4;)c=1540483477*(65535&(c=255&i.charCodeAt(v)|(255&i.charCodeAt(++v))<<8|(255&i.charCodeAt(++v))<<16|(255&i.charCodeAt(++v))<<24))+((1540483477*(c>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),d-=4,++v;switch(d){case 3:p^=(255&i.charCodeAt(v+2))<<16;case 2:p^=(255&i.charCodeAt(v+1))<<8;case 1:p=1540483477*(65535&(p^=255&i.charCodeAt(v)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),qh.exports);return gu.exports=o,gu.exports.murmur3=o,gu.exports.murmur2=e,gu.exports}(),mo=Ts(tp);class _a{constructor(e,...i){$e(this,i[0]||{}),this.type=e}}class np extends _a{constructor(e,i={}){super("error",$e({error:e},i))}}function ip(o,e,i){i[o]&&i[o].indexOf(e)!==-1||(i[o]=i[o]||[],i[o].push(e))}function Hh(o,e,i){if(i&&i[o]){const l=i[o].indexOf(e);l!==-1&&i[o].splice(l,1)}}class sl{on(e,i){return this._listeners=this._listeners||{},ip(e,i,this._listeners),this}off(e,i){return Hh(e,i,this._listeners),Hh(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},ip(e,i,this._oneTimeListeners),this):new Promise(l=>{this.once(e,l)})}fire(e,i){const l=typeof e=="string"?new _a(e,i):e,c=l.type;if(this.listens(c)){l.target=this;const d=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(const w of d)w.call(this,l);const p=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(const w of p)Hh(c,w,this._oneTimeListeners),w.call(this,l);const v=this._eventedParent;v&&($e(l,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),v.fire(l))}else l instanceof np&&console.error(l.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class _o{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new _o(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,l]=e.split("");return new _o({name:i,iconsetId:l})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return _o.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var rp,Zh={},yu=function(){if(rp)return Zh;rp=1;var o={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(d){return(d=Math.round(d))<0?0:d>255?255:d}function i(d){return e(d[d.length-1]==="%"?parseFloat(d)/100*255:parseInt(d))}function l(d){return(p=d[d.length-1]==="%"?parseFloat(d)/100:parseFloat(d))<0?0:p>1?1:p;var p}function c(d,p,v){return v<0?v+=1:v>1&&(v-=1),6*v<1?d+(p-d)*v*6:2*v<1?p:3*v<2?d+(p-d)*(2/3-v)*6:d}try{Zh.parseCSSColor=function(d){var p,v=d.replace(/ /g,"").toLowerCase();if(v in o)return o[v].slice();if(v[0]==="#")return v.length===4?(p=parseInt(v.substr(1),16))>=0&&p<=4095?[(3840&p)>>4|(3840&p)>>8,240&p|(240&p)>>4,15&p|(15&p)<<4,1]:null:v.length===7&&(p=parseInt(v.substr(1),16))>=0&&p<=16777215?[(16711680&p)>>16,(65280&p)>>8,255&p,1]:null;var w=v.indexOf("("),S=v.indexOf(")");if(w!==-1&&S+1===v.length){var I=v.substr(0,w),C=v.substr(w+1,S-(w+1)).split(","),R=1;switch(I){case"rgba":if(C.length!==4)return null;R=l(C.pop());case"rgb":return C.length!==3?null:[i(C[0]),i(C[1]),i(C[2]),R];case"hsla":if(C.length!==4)return null;R=l(C.pop());case"hsl":if(C.length!==3)return null;var B=(parseFloat(C[0])%360+360)%360/360,N=l(C[1]),$=l(C[2]),X=$<=.5?$*(N+1):$+N-$*N,K=2*$-X;return[e(255*c(K,X,B+1/3)),e(255*c(K,X,B)),e(255*c(K,X,B-1/3)),R];default:return null}}return null}}catch{}return Zh}();class Kn{constructor(e,i,l,c=1){this.r=e,this.g=i,this.b=l,this.a=c}static parse(e){if(!e)return;if(e instanceof Kn)return e;if(typeof e!="string")return;const i=yu.parseCSSColor(e);return i?new Kn(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toStringPremultipliedAlpha(){const[e,i,l,c]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(i)},${Math.round(l)},${c})`}toString(){const[e,i,l,c]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*l)},${c})`}toRenderColor(e){const{r:i,g:l,b:c,a:d}=this;return new eg(e,i,l,c,d)}clone(){return new Kn(this.r,this.g,this.b,this.a)}}class eg{constructor(e,i,l,c,d){if(e){const p=e.image.height,v=p*p;i=d===0?0:i/d*(p-1),l=d===0?0:l/d*(p-1),c=d===0?0:c/d*(p-1);const w=Math.floor(i),S=Math.floor(l),I=Math.floor(c),C=Math.ceil(i),R=Math.ceil(l),B=Math.ceil(c),N=i-w,$=l-S,X=c-I,K=e.image.data,le=4*(w+S*v+I*p),re=4*(w+S*v+B*p),G=4*(w+R*v+I*p),ne=4*(w+R*v+B*p),ae=4*(C+S*v+I*p),de=4*(C+S*v+B*p),be=4*(C+R*v+I*p),Ie=4*(C+R*v+B*p);if(le<0||Ie>=K.length)throw new Error("out of range");this.r=Jt(Jt(Jt(K[le],K[re],X),Jt(K[G],K[ne],X),$),Jt(Jt(K[ae],K[de],X),Jt(K[be],K[Ie],X),$),N)/255*d,this.g=Jt(Jt(Jt(K[le+1],K[re+1],X),Jt(K[G+1],K[ne+1],X),$),Jt(Jt(K[ae+1],K[de+1],X),Jt(K[be+1],K[Ie+1],X),$),N)/255*d,this.b=Jt(Jt(Jt(K[le+2],K[re+2],X),Jt(K[G+2],K[ne+2],X),$),Jt(Jt(K[ae+2],K[de+2],X),Jt(K[be+2],K[Ie+2],X),$),N)/255*d,this.a=d}else this.r=i,this.g=l,this.b=c,this.a=d}toArray(){const{r:e,g:i,b:l,a:c}=this;return c===0?[0,0,0,0]:[255*e/c,255*i/c,255*l/c,c]}toHslaArray(){if(this.a===0)return[0,0,0,0];const{r:e,g:i,b:l,a:c}=this,d=Math.min(Math.max(e/c,0),1),p=Math.min(Math.max(i/c,0),1),v=Math.min(Math.max(l/c,0),1),w=Math.min(d,p,v),S=Math.max(d,p,v),I=(w+S)/2;if(w===S)return[0,0,100*I,c];const C=S-w,R=I>.5?C/(2-S-w):C/(S+w);let B=0;return S===d?B=(p-v)/C+(p<v?6:0):S===p?B=(v-d)/C+2:S===v&&(B=(d-p)/C+4),B*=60,[Math.min(Math.max(B,0),360),Math.min(Math.max(100*R,0),100),Math.min(Math.max(100*I,0),100),c]}toArray01(){const{r:e,g:i,b:l,a:c}=this;return c===0?[0,0,0,0]:[e/c,i/c,l/c,c]}toArray01Scaled(e){const{r:i,g:l,b:c,a:d}=this;return d===0?[0,0,0]:[i/d*e,l/d*e,c/d*e]}toArray01PremultipliedAlpha(){const{r:e,g:i,b:l,a:c}=this;return[e,i,l,c]}toArray01Linear(){const{r:e,g:i,b:l,a:c}=this;return c===0?[0,0,0,0]:[Math.pow(e/c,2.2),Math.pow(i/c,2.2),Math.pow(l/c,2.2),c]}}function Jt(o,e,i){return o*(1-i)+e*i}function tg(o,e,i){return o.map((l,c)=>Jt(l,e[c],i))}function Wh(o){return o*o*o*o*o}Kn.black=new Kn(0,0,0,1),Kn.white=new Kn(1,1,1,1),Kn.transparent=new Kn(0,0,0,0),Kn.red=new Kn(1,0,0,1),Kn.blue=new Kn(0,0,1,1);var Xh=Object.freeze({__proto__:null,array:tg,color:function(o,e,i){return new Kn(Jt(o.r,e.r,i),Jt(o.g,e.g,i),Jt(o.b,e.b,i),Jt(o.a,e.a,i))},easeIn:Wh,number:Jt});function vu(o,...e){for(const i of e)for(const l in i)o[l]=i[l];return o}class Zo extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class al{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[l,c]of i)this.bindings[l]=c}concat(e){return new al(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const ga={kind:"null"},Kt={kind:"number"},ui={kind:"string"},ni={kind:"boolean"},lo={kind:"color"},ya={kind:"object"},Qn={kind:"value"},ll={kind:"collator"},xu={kind:"formatted"},bu={kind:"resolvedImage"};function Xr(o,e){return{kind:"array",itemType:o,N:e}}function fr(o){if(o.kind==="array"){const e=fr(o.itemType);return typeof o.N=="number"?`array<${e}, ${o.N}>`:o.itemType.kind==="value"?"array":`array<${e}>`}return o.kind}const kx=[ga,Kt,ui,ni,lo,xu,ya,Xr(Qn),bu];function wu(o,e){if(e.kind==="error")return null;if(o.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!wu(o.itemType,e.itemType))&&(typeof o.N!="number"||o.N===e.N))return null}else{if(o.kind===e.kind)return null;if(o.kind==="value"){for(const i of kx)if(!wu(i,e))return null}}return`Expected ${fr(o)} but found ${fr(e)} instead.`}function op(o,e){return e.some(i=>i.kind===o.kind)}function ic(o,e){return e.some(i=>i==="null"?o===null:i==="array"?Array.isArray(o):i==="object"?o&&!Array.isArray(o)&&typeof o=="object":i===typeof o)}class va{constructor(e,i,l){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=l,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Yh{constructor(e,i,l,c,d){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=l,this.fontStack=c,this.textColor=d}}class Yr{constructor(e){this.sections=e}static fromString(e){return new Yr([new Yh(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Yr?e:Yr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const c=i.image.getPrimary().id.toString();e.push(["image",c]);continue}e.push(i.text);const l={};i.fontStack&&(l["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(l["font-scale"]=i.scale),i.textColor&&(l["text-color"]=["rgba"].concat(i.textColor.toRenderColor(null).toArray())),e.push(l)}return e}}class as{constructor(e,i={}){if(this.id=_o.from(e),this.options=Object.assign({},i),i.transform){const{a:l,b:c,c:d,d:p,e:v,f:w}=i.transform;this.options.transform=new DOMMatrix([l,c,d,p,v,w])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:l,d:c,e:d,f:p}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:l,d:c,e:d,f:p}})}static parse(e){let i,l,c,d;try{({name:i,iconsetId:l,params:c,transform:d}=JSON.parse(e)||{})}catch{return null}if(!i)return null;const{a:p,b:v,c:w,d:S,e:I,f:C}=d||{};return new as({name:i,iconsetId:l},{params:c,transform:new DOMMatrix([p,v,w,S,I,C])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class co{constructor(e,i,l,c,d=!1){this.primaryId=_o.from(e),this.primaryOptions=i,l&&(this.secondaryId=_o.from(l)),this.secondaryOptions=c,this.available=d}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new as(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new as(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?co.build({name:e}):e}static build(e,i,l,c){return!e||typeof e=="object"&&!("name"in e)?null:new co(e,l,i,c)}}function ng(o,e,i,l){return typeof o=="number"&&o>=0&&o<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?l===void 0||typeof l=="number"&&l>=0&&l<=1?null:`Invalid rgba value [${[o,e,i,l].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof l=="number"?[o,e,i,l]:[o,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function rc(o){if(o===null||typeof o=="string"||typeof o=="boolean"||typeof o=="number"||o instanceof Kn||o instanceof va||o instanceof Yr||o instanceof co)return!0;if(Array.isArray(o)){for(const e of o)if(!rc(e))return!1;return!0}if(typeof o=="object"){for(const e in o)if(!rc(o[e]))return!1;return!0}return!1}function vr(o){if(o===null)return ga;if(typeof o=="string")return ui;if(typeof o=="boolean")return ni;if(typeof o=="number")return Kt;if(o instanceof Kn)return lo;if(o instanceof va)return ll;if(o instanceof Yr)return xu;if(o instanceof co)return bu;if(Array.isArray(o)){const e=o.length;let i;for(const l of o){const c=vr(l);if(i){if(i===c)continue;i=Qn;break}i=c}return Xr(i||Qn,e)}return ya}function Kr(o){const e=typeof o;return o===null?"":e==="string"||e==="number"||e==="boolean"?String(o):o instanceof Kn?o.toStringPremultipliedAlpha():o instanceof Yr||o instanceof co?o.toString():JSON.stringify(o)}class In{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!rc(e[1]))return i.error("invalid value");const l=e[1];let c=vr(l);const d=i.expectedType;return c.kind!=="array"||c.N!==0||!d||d.kind!=="array"||typeof d.N=="number"&&d.N!==0||(c=d),new In(c,l)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Kn?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Yr?this.value.serialize():this.value}}class Ut{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Tu={string:ui,number:Kt,boolean:ni,object:ya};class sn{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let l,c=1;const d=e[0];if(d==="array"){let v,w;if(e.length>2){const S=e[1];if(typeof S!="string"||!(S in Tu)||S==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);v=Tu[S],c++}else v=Qn;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);w=e[2],c++}l=Xr(v,w)}else l=Tu[d];const p=[];for(;c<e.length;c++){const v=i.parse(e[c],c,Qn);if(!v)return null;p.push(v)}return new sn(l,p)}evaluate(e){for(let i=0;i<this.args.length;i++){const l=this.args[i].evaluate(e);if(!wu(this.type,vr(l)))return l;if(i===this.args.length-1)throw new Ut(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${fr(vr(l))} but was expected to be of type ${fr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const l=e.itemType;if(l.kind==="string"||l.kind==="number"||l.kind==="boolean"){i.push(l.kind);const c=e.N;(typeof c=="number"||this.args.length>1)&&i.push(c)}}return i.concat(this.args.map(l=>l.serialize()))}}class cl{constructor(e){this.type=xu,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const l=e[1];if(!Array.isArray(l)&&typeof l=="object")return i.error("First argument must be an image or text section.");const c=[];let d=!1;for(let p=1;p<=e.length-1;++p){const v=e[p];if(d&&typeof v=="object"&&!Array.isArray(v)){d=!1;let w=null;if(v["font-scale"]&&(w=i.parseObjectValue(v["font-scale"],p,"font-scale",Kt),!w))return null;let S=null;if(v["text-font"]&&(S=i.parseObjectValue(v["text-font"],p,"text-font",Xr(ui)),!S))return null;let I=null;if(v["text-color"]&&(I=i.parseObjectValue(v["text-color"],p,"text-color",lo),!I))return null;const C=c[c.length-1];C.scale=w,C.font=S,C.textColor=I}else{const w=i.parse(e[p],p,Qn);if(!w)return null;const S=w.type.kind;if(S!=="string"&&S!=="value"&&S!=="null"&&S!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");d=!0,c.push({content:w,scale:null,font:null,textColor:null})}}return new cl(c)}evaluate(e){return new Yr(this.sections.map(i=>{const l=i.content.evaluate(e);return vr(l)===bu?new Yh("",l,null,null,null):new Yh(Kr(l),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const l={};i.scale&&(l["font-scale"]=i.scale.serialize()),i.font&&(l["text-font"]=i.font.serialize()),i.textColor&&(l["text-color"]=i.textColor.serialize()),e.push(l)}return e}}class oc{constructor(e,i,l,c){this._imageWarnHistory={},this.type=bu,this.namePrimary=e,this.nameSecondary=i,l&&(this.paramsPrimary=l.params,this.iconsetIdPrimary=l.iconset?l.iconset.id:void 0),c&&(this.paramsSecondary=c.params,this.iconsetIdSecondary=c.iconset?c.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let l=1;const c=[];function d(){if(l<e.length){const v=i.parse(e[l],l++,ui);return v?(c.push({image:v,options:{}}),!0):(i.error(c.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function p(){if(l<e.length){const w=e[l];if((v=w)===null||typeof v!="object"||Array.isArray(v))return!0;const S=w.params,I=w.iconset,C=i.concat(l);if(!S&&!I)return l++,!0;if(S){if(typeof S!="object"||S.constructor!==Object)return C.error('Image options "params" should be an object'),!1;const R={},B=C.concat(void 0,"params");for(const N in S){if(!N)return B.error("Image parameter name should be non-empty"),!1;const $=B.concat(void 0,N).parse(S[N],void 0,lo,void 0,{typeAnnotation:"coerce"});if(!$)return!1;R[N]=$}c[c.length-1].options.params=R}if(I){if(typeof I!="object"||I.constructor!==Object)return C.error('Image options "iconset" should be an object'),!1;if(!I.id)return C.error('Image options "iconset" should have an "id" property'),!1;c[c.length-1].options.iconset=I}return l++,!0}var v;return!0}for(let v=0;v<2;v++)if(!d()||!p())return;return new oc(c[0].image,c[1]?c[1].image:void 0,c[0].options,c[1]?c[1].options:void 0)}evaluateParams(e,i){const l={};if(i){for(const c in i)if(i[c])try{l[c]=i[c].evaluate(e)}catch{continue}if(Object.keys(l).length!==0)return{params:l}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},l=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,c=co.build(i,l,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(c&&e.availableImages){const d=c.getPrimary().id;if(c.available=e.availableImages.some(p=>_o.isEqual(p,d)),c.available){const p=c.getSecondary()?c.getSecondary().id:null;p&&(c.available=e.availableImages.some(v=>_o.isEqual(v,p)))}}return c}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const l={};if(i&&(l.iconset={id:i}),e){l.params={};for(const c in e)e[c]&&(l.params[c]=e[c].serialize())}return Object.keys(l).length>0?l:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function an(o){return o instanceof Number?"number":o instanceof String?"string":o instanceof Boolean?"boolean":Array.isArray(o)?"array":o===null?"null":typeof o}const ig={"to-boolean":ni,"to-color":lo,"to-number":Kt,"to-string":ui};class ls{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const l=e[0],c=[];let d=ga;if(l==="to-array"){if(!Array.isArray(e[1]))return null;const p=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);d=Xr(i.expectedType.itemType,p)}else{if(!(p>0&&rc(e[1][0])))return null;d=Xr(vr(e[1][0]),p)}for(let v=0;v<p;v++){const w=e[1][v];let S;if(an(w)==="array")S=i.parse(w,void 0,d.itemType);else{const I=an(w);if(I!==d.itemType.kind)return i.error(`Expected ${d.itemType.kind} but found ${I}.`);S=i.registry.literal.parse(["literal",w===void 0?null:w],i)}if(!S)return null;c.push(S)}}else{if((l==="to-boolean"||l==="to-string")&&e.length!==2)return i.error("Expected one argument.");d=ig[l];for(let p=1;p<e.length;p++){const v=i.parse(e[p],p,Qn);if(!v)return null;c.push(v)}}return new ls(d,c)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,l;for(const c of this.args){if(i=c.evaluate(e),l=null,i instanceof Kn)return i;if(typeof i=="string"){const d=e.parseColor(i);if(d)return d}else if(Array.isArray(i)&&(l=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:ng(i[0],i[1],i[2],i[3]),!l))return new Kn(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Ut(l||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const l of this.args){if(i=l.evaluate(e),i===null)return 0;const c=Number(i);if(!isNaN(c))return c}throw new Ut(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?Yr.fromString(Kr(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?co.build(Kr(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Kr(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new cl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new oc(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const rg=["Unknown","Point","LineString","Polygon"];class Kh{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?rg[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:l,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*i-e[0])+this.featureDistanceData.bearing[1]*(c*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Kn.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Gr{constructor(e,i,l,c,d){this.name=e,this.type=i,this._evaluate=l,this.args=c,this._overloadIndex=d}evaluate(e){if(!this._evaluate){const i=Gr.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const l=e[0],c=Gr.definitions[l];if(!c)return i.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0);const d=Array.isArray(c)?c[0]:c.type,p=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,v=[];let w=null,S=-1;for(const[I,C]of p){if(Array.isArray(I)&&I.length!==e.length-1)continue;v.push(I),S++,w=new pg(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const R=[];let B=!1;for(let N=1;N<e.length;N++){const $=e[N],X=Array.isArray(I)?I[N-1]:I.type,K=w.parse($,1+R.length,X);if(!K){B=!0;break}R.push(K)}if(!B)if(Array.isArray(I)&&I.length!==R.length)w.error(`Expected ${I.length} arguments, but found ${R.length} instead.`);else{for(let N=0;N<R.length;N++){const $=Array.isArray(I)?I[N]:I.type,X=R[N];w.concat(N+1).checkSubtype($,X.type)}if(w.errors.length===0)return new Gr(l,d,C,R,S)}}if(v.length===1)i.errors.push(...w.errors);else{const I=(v.length?v:p.map(([R])=>R)).map(Jr).join(" | "),C=[];for(let R=1;R<e.length;R++){const B=i.parse(e[R],1+C.length);if(!B)return null;C.push(fr(B.type))}i.error(`Expected arguments of type ${I}, but found (${C.join(", ")}) instead.`)}return null}static register(e,i){Gr.definitions=i;for(const l in i)e[l]=Gr}}function Jr(o){return Array.isArray(o)?`(${o.map(fr).join(", ")})`:`(${fr(o.type)}...)`}class sc{constructor(e,i,l){this.type=ll,this.locale=l,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const l=e[1];if(typeof l!="object"||Array.isArray(l))return i.error("Collator options argument must be an object.");const c=l["case-sensitive"]===void 0?i.parse(!1,1,ni):i.parseObjectValue(l["case-sensitive"],1,"case-sensitive",ni);if(!c)return null;const d=l["diacritic-sensitive"]===void 0?i.parse(!1,1,ni):i.parseObjectValue(l["diacritic-sensitive"],1,"diacritic-sensitive",ni);if(!d)return null;let p=null;return l.locale&&(p=i.parseObjectValue(l.locale,1,"locale",ui),!p)?null:new sc(c,d,p)}evaluate(e){return new va(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function xa(o,e,i=0,l=o.length-1,c=hl){for(;l>i;){if(l-i>600){const w=l-i+1,S=e-i+1,I=Math.log(w),C=.5*Math.exp(2*I/3),R=.5*Math.sqrt(I*C*(w-C)/w)*(S-w/2<0?-1:1);xa(o,e,Math.max(i,Math.floor(e-S*C/w+R)),Math.min(l,Math.floor(e+(w-S)*C/w+R)),c)}const d=o[e];let p=i,v=l;for(ul(o,i,e),c(o[l],d)>0&&ul(o,i,l);p<v;){for(ul(o,p,v),p++,v--;c(o[p],d)<0;)p++;for(;c(o[v],d)>0;)v--}c(o[i],d)===0?ul(o,i,v):(v++,ul(o,v,l)),v<=e&&(i=v+1),e<=v&&(l=v-1)}}function ul(o,e,i){const l=o[e];o[e]=o[i],o[i]=l}function hl(o,e){return o<e?-1:o>e?1:0}function Qr(o){let e=0;for(let i,l,c=0,d=o.length,p=d-1;c<d;p=c++)i=o[c],l=o[p],e+=(l.x-i.x)*(i.y+l.y);return e}function Su(o,e){o[0]=Math.min(o[0],e[0]),o[1]=Math.min(o[1],e[1]),o[2]=Math.max(o[2],e[0]),o[3]=Math.max(o[3],e[1])}function Eu(o,e){return!(o[0]<=e[0]||o[2]>=e[2]||o[1]<=e[1]||o[3]>=e[3])}function Ox(o,e,i){const l=o[0]-e[0],c=o[1]-e[1],d=o[0]-i[0],p=o[1]-i[1];return l*p-d*c==0&&l*d<=0&&c*p<=0}function Ws(o,e,i=!1){let l=!1;for(let v=0,w=e.length;v<w;v++){const S=e[v];for(let I=0,C=S.length,R=C-1;I<C;R=I++){const B=S[R],N=S[I];if(Ox(o,B,N))return i;(d=B)[1]>(c=o)[1]!=(p=N)[1]>c[1]&&c[0]<(p[0]-d[0])*(c[1]-d[1])/(p[1]-d[1])+d[0]&&(l=!l)}}var c,d,p;return l}function sp(o,e,i,l){const c=l[0]-i[0],d=l[1]-i[1],p=(o[0]-i[0])*d-c*(o[1]-i[1]),v=(e[0]-i[0])*d-c*(e[1]-i[1]);return p>0&&v<0||p<0&&v>0}function Es(o,e,i,l){return(c=[l[0]-i[0],l[1]-i[1]])[0]*(d=[e[0]-o[0],e[1]-o[1]])[1]-c[1]*d[0]!=0&&!(!sp(o,e,i,l)||!sp(i,l,o,e));var c,d}function ap(o){const e=new St(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new St(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const l of o[0])e.x>l.x&&(e.x=l.x),e.y>l.y&&(e.y=l.y),i.x<l.x&&(i.x=l.x),i.y<l.y&&(i.y=l.y);return{min:e,max:i}}const ba=8192;function Fx(o,e){const i=(180+o[0])/360,l=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+o[1]*Math.PI/360)))/360,c=Math.pow(2,e.z);return[Math.round(i*c*ba),Math.round(l*c*ba)]}function Bx(o,e){for(let i=0;i<e.length;i++)if(Ws(o,e[i]))return!0;return!1}function og(o,e,i){for(const l of i)for(let c=0,d=l.length,p=d-1;c<d;p=c++)if(Es(o,e,l[p],l[c]))return!0;return!1}function sg(o,e){for(let i=0;i<o.length;++i)if(!Ws(o[i],e))return!1;for(let i=0;i<o.length-1;++i)if(og(o[i],o[i+1],e))return!1;return!0}function Nx(o,e){for(let i=0;i<e.length;i++)if(sg(o,e[i]))return!0;return!1}function Jh(o,e,i){const l=[];for(let c=0;c<o.length;c++){const d=[];for(let p=0;p<o[c].length;p++){const v=Fx(o[c][p],i);Su(e,v),d.push(v)}l.push(d)}return l}function ag(o,e,i){const l=[];for(let c=0;c<o.length;c++){const d=Jh(o[c],e,i);l.push(d)}return l}function wa(o,e,i,l){if(o[0]<i[0]||o[0]>i[2]){const c=.5*l;let d=o[0]-i[0]>c?-l:i[0]-o[0]>c?l:0;d===0&&(d=o[0]-i[2]>c?-l:i[2]-o[0]>c?l:0),o[0]+=d}Su(e,o)}function lg(o,e,i,l){const c=Math.pow(2,l.z)*ba,d=[l.x*ba,l.y*ba],p=[];if(!o)return p;for(const v of o)for(const w of v){const S=[w.x+d[0],w.y+d[1]];wa(S,e,i,c),p.push(S)}return p}function cg(o,e,i,l){const c=Math.pow(2,l.z)*ba,d=[l.x*ba,l.y*ba],p=[];if(!o)return p;for(const w of o){const S=[];for(const I of w){const C=[I.x+d[0],I.y+d[1]];Su(e,C),S.push(C)}p.push(S)}if(e[2]-e[0]<=c/2){(v=e)[0]=v[1]=1/0,v[2]=v[3]=-1/0;for(const w of p)for(const S of w)wa(S,e,i,c)}var v;return p}class Xs{constructor(e,i){this.type=ni,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(rc(e[1])){const l=e[1];if(l.type==="FeatureCollection")for(let c=0;c<l.features.length;++c){const d=l.features[c].geometry.type;if(d==="Polygon"||d==="MultiPolygon")return new Xs(l,l.features[c].geometry)}else if(l.type==="Feature"){const c=l.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new Xs(l,l.geometry)}else if(l.type==="Polygon"||l.type==="MultiPolygon")return new Xs(l,l)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,l){const c=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(l.type==="Polygon"){const v=Jh(l.coordinates,d,p),w=lg(i.geometry(),c,d,p);if(!Eu(c,d))return!1;for(const S of w)if(!Ws(S,v))return!1}if(l.type==="MultiPolygon"){const v=ag(l.coordinates,d,p),w=lg(i.geometry(),c,d,p);if(!Eu(c,d))return!1;for(const S of w)if(!Bx(S,v))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,l){const c=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(l.type==="Polygon"){const v=Jh(l.coordinates,d,p),w=cg(i.geometry(),c,d,p);if(!Eu(c,d))return!1;for(const S of w)if(!sg(S,v))return!1}if(l.type==="MultiPolygon"){const v=ag(l.coordinates,d,p),w=cg(i.geometry(),c,d,p);if(!Eu(c,d))return!1;for(const S of w)if(!Nx(S,v))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Au={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},lp=1/298.257223563,Wo=lp*(2-lp),ac=Math.PI/180;class lc{static fromTile(e,i,l){const c=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),d=Math.atan(.5*(Math.exp(c)-Math.exp(-c)))/ac;return new lc(d,l)}static get units(){return Au}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Au[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Au).join(", ")}`);const l=6378.137*ac*(i?Au[i]:1),c=Math.cos(e*ac),d=1/(1-Wo*(1-c*c)),p=Math.sqrt(d);this.kx=l*p*c,this.ky=l*p*d*(1-Wo)}distance(e,i){const l=Mo(e[0]-i[0])*this.kx,c=(e[1]-i[1])*this.ky;return Math.sqrt(l*l+c*c)}bearing(e,i){const l=Mo(i[0]-e[0])*this.kx;return Math.atan2(l,(i[1]-e[1])*this.ky)/ac}destination(e,i,l){const c=l*ac;return this.offset(e,Math.sin(c)*i,Math.cos(c)*i)}offset(e,i,l){return[e[0]+i/this.kx,e[1]+l/this.ky]}lineDistance(e){let i=0;for(let l=0;l<e.length-1;l++)i+=this.distance(e[l],e[l+1]);return i}area(e){let i=0;for(let l=0;l<e.length;l++){const c=e[l];for(let d=0,p=c.length,v=p-1;d<p;v=d++)i+=Mo(c[d][0]-c[v][0])*(c[d][1]+c[v][1])*(l?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let l=0;if(i<=0)return e[0];for(let c=0;c<e.length-1;c++){const d=e[c],p=e[c+1],v=this.distance(d,p);if(l+=v,l>i)return Qh(d,p,(i-(l-v))/v)}return e[e.length-1]}pointToSegmentDistance(e,i,l){let[c,d]=i,p=Mo(l[0]-c)*this.kx,v=(l[1]-d)*this.ky;if(p!==0||v!==0){const w=(Mo(e[0]-c)*this.kx*p+(e[1]-d)*this.ky*v)/(p*p+v*v);w>1?(c=l[0],d=l[1]):w>0&&(c+=p/this.kx*w,d+=v/this.ky*w)}return p=Mo(e[0]-c)*this.kx,v=(e[1]-d)*this.ky,Math.sqrt(p*p+v*v)}pointOnLine(e,i){let l=1/0,c=e[0][0],d=e[0][1],p=0,v=0;for(let w=0;w<e.length-1;w++){let S=e[w][0],I=e[w][1],C=Mo(e[w+1][0]-S)*this.kx,R=(e[w+1][1]-I)*this.ky,B=0;C===0&&R===0||(B=(Mo(i[0]-S)*this.kx*C+(i[1]-I)*this.ky*R)/(C*C+R*R),B>1?(S=e[w+1][0],I=e[w+1][1]):B>0&&(S+=C/this.kx*B,I+=R/this.ky*B)),C=Mo(i[0]-S)*this.kx,R=(i[1]-I)*this.ky;const N=C*C+R*R;N<l&&(l=N,c=S,d=I,p=w,v=B)}return{point:[c,d],index:p,t:Math.max(0,Math.min(1,v))}}lineSlice(e,i,l){let c=this.pointOnLine(l,e),d=this.pointOnLine(l,i);if(c.index>d.index||c.index===d.index&&c.t>d.t){const S=c;c=d,d=S}const p=[c.point],v=c.index+1,w=d.index;!cp(l[v],p[0])&&v<=w&&p.push(l[v]);for(let S=v+1;S<=w;S++)p.push(l[S]);return cp(l[w],d.point)||p.push(d.point),p}lineSliceAlong(e,i,l){let c=0;const d=[];for(let p=0;p<l.length-1;p++){const v=l[p],w=l[p+1],S=this.distance(v,w);if(c+=S,c>e&&d.length===0&&d.push(Qh(v,w,(e-(c-S))/S)),c>=i)return d.push(Qh(v,w,(i-(c-S))/S)),d;c>e&&d.push(w)}return d}bufferPoint(e,i){const l=i/this.ky,c=i/this.kx;return[e[0]-c,e[1]-l,e[0]+c,e[1]+l]}bufferBBox(e,i){const l=i/this.ky,c=i/this.kx;return[e[0]-c,e[1]-l,e[2]+c,e[3]+l]}insideBBox(e,i){return Mo(e[0]-i[0])>=0&&Mo(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function cp(o,e){return o[0]===e[0]&&o[1]===e[1]}function Qh(o,e,i){const l=Mo(e[0]-o[0]);return[o[0]+l*i,o[1]+(e[1]-o[1])*i]}function Mo(o){for(;o<-180;)o+=360;for(;o>180;)o-=360;return o}class ef{constructor(e=[],i=(l,c)=>l<c?-1:l>c?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let l=(this.length>>1)-1;l>=0;l--)this._down(l)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:l}=this,c=i[e];for(;e>0;){const d=e-1>>1,p=i[d];if(l(c,p)>=0)break;i[e]=p,e=d}i[e]=c}_down(e){const{data:i,compare:l}=this,c=this.length>>1,d=i[e];for(;e<c;){let p=1+(e<<1);const v=p+1;if(v<this.length&&l(i[v],i[p])<0&&(p=v),l(i[p],d)>=0)break;i[e]=i[p],e=p}i[e]=d}}var At=8192;function up(o,e){return e.dist-o.dist}const tf=100,nf=50;function hp(o){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==o.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==o[i])return!1;return!0}function fl(o){return o[1]-o[0]+1}function Xo(o,e){const i=o[1]>=o[0]&&o[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function cc(o,e){if(o[0]>o[1])return[null,null];const i=fl(o);if(e){if(i===2)return[o,null];const l=Math.floor(i/2);return[[o[0],o[0]+l],[o[0]+l,o[1]]]}{if(i===1)return[o,null];const l=Math.floor(i/2)-1;return[[o[0],o[0]+l],[o[0]+l+1,o[1]]]}}function Ta(o,e){const i=[1/0,1/0,-1/0,-1/0];if(!Xo(e,o.length))return i;for(let l=e[0];l<=e[1];++l)Su(i,o[l]);return i}function Iu(o){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<o.length;++i)for(let l=0;l<o[i].length;++l)Su(e,o[i][l]);return e}function dl(o,e,i){if(hp(o)||hp(e))return NaN;let l=0,c=0;return o[2]<e[0]&&(l=e[0]-o[2]),o[0]>e[2]&&(l=o[0]-e[2]),o[1]>e[3]&&(c=o[1]-e[3]),o[3]<e[1]&&(c=e[1]-o[3]),i.distance([0,0],[l,c])}function uc(o){return 360*o-180}function Un(o){return 360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90}function fp(o,e){const i=Math.pow(2,e.z),l=(o.y/At+e.y)/i;return[uc((o.x/At+e.x)/i),Un(l)]}function Vx(o,e){const i=[];for(let l=0;l<o.length;++l)i.push(fp(o[l],e));return i}function ug(o,e,i){const l=i.pointOnLine(e,o).point;return i.distance(o,l)}function dp(o,e,i,l,c){const d=i.slice(l[0],l[1]+1);let p=1/0;for(let v=e[0];v<=e[1];++v)if((p=Math.min(p,ug(o[v],d,c)))===0)return 0;return p}function pp(o,e,i,l,c){const d=Math.min(c.pointToSegmentDistance(o,i,l),c.pointToSegmentDistance(e,i,l)),p=Math.min(c.pointToSegmentDistance(i,o,e),c.pointToSegmentDistance(l,o,e));return Math.min(d,p)}function Hi(o,e,i,l,c){if(!Xo(e,o.length)||!Xo(l,i.length))return NaN;let d=1/0;for(let p=e[0];p<e[1];++p)for(let v=l[0];v<l[1];++v){if(Es(o[p],o[p+1],i[v],i[v+1]))return 0;d=Math.min(d,pp(o[p],o[p+1],i[v],i[v+1],c))}return d}function Ux(o,e,i,l,c){if(!Xo(e,o.length)||!Xo(l,i.length))return NaN;let d=1/0;for(let p=e[0];p<=e[1];++p)for(let v=l[0];v<=l[1];++v)if((d=Math.min(d,c.distance(o[p],i[v])))===0)return d;return d}function jx(o,e,i){if(Ws(o,e,!0))return 0;let l=1/0;for(const c of e){const d=c.length;if(d<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[d-1]&&(l=Math.min(l,i.pointToSegmentDistance(o,c[d-1],c[0])))===0||(l=Math.min(l,ug(o,c,i)))===0)return l}return l}function $x(o,e,i,l){if(!Xo(e,o.length))return NaN;for(let d=e[0];d<=e[1];++d)if(Ws(o[d],i,!0))return 0;let c=1/0;for(let d=e[0];d<e[1];++d)for(const p of i)for(let v=0,w=p.length,S=w-1;v<w;S=v++){if(Es(o[d],o[d+1],p[S],p[v]))return 0;c=Math.min(c,pp(o[d],o[d+1],p[S],p[v],l))}return c}function hg(o,e){for(const i of o)for(let l=0;l<=i.length-1;++l)if(Ws(i[l],e,!0))return!0;return!1}function Gx(o,e,i,l=1/0){const c=Iu(o),d=Iu(e);if(l!==1/0&&dl(c,d,i)>=l)return l;if(Eu(c,d)){if(hg(o,e))return 0}else if(hg(e,o))return 0;let p=l;for(const v of o)for(let w=0,S=v.length,I=S-1;w<S;I=w++)for(const C of e)for(let R=0,B=C.length,N=B-1;R<B;N=R++){if(Es(v[I],v[w],C[N],C[R]))return 0;p=Math.min(p,pp(v[I],v[w],C[N],C[R],i))}return p}function rf(o,e,i,l,c,d,p){if(d===null||p===null)return;const v=dl(Ta(l,d),Ta(c,p),i);v<e&&o.push({dist:v,range1:d,range2:p})}function qx(o,e,i,l,c=1/0){let d=Math.min(l.distance(o[0],i[0][0]),c);if(d===0)return d;const p=new ef([{dist:0,range1:[0,o.length-1],range2:[0,0]}],up),v=e?nf:tf,w=Iu(i);for(;p.length;){const S=p.pop();if(S.dist>=d)continue;const I=S.range1;if(fl(I)<=v){if(!Xo(I,o.length))return NaN;if(e){const C=$x(o,I,i,l);if((d=Math.min(d,C))===0)return d}else for(let C=I[0];C<=I[1];++C){const R=jx(o[C],i,l);if((d=Math.min(d,R))===0)return d}}else{const C=cc(I,e);if(C[0]!==null){const R=dl(Ta(o,C[0]),w,l);R<d&&p.push({dist:R,range1:C[0],range2:[0,0]})}if(C[1]!==null){const R=dl(Ta(o,C[1]),w,l);R<d&&p.push({dist:R,range1:C[1],range2:[0,0]})}}}return d}function fg(o,e,i,l,c,d=1/0){let p=Math.min(d,c.distance(o[0],i[0]));if(p===0)return p;const v=new ef([{dist:0,range1:[0,o.length-1],range2:[0,i.length-1]}],up),w=e?nf:tf,S=l?nf:tf;for(;v.length;){const I=v.pop();if(I.dist>=p)continue;const C=I.range1,R=I.range2;if(fl(C)<=w&&fl(R)<=S){if(!Xo(C,o.length)||!Xo(R,i.length))return NaN;if(e&&l?p=Math.min(p,Hi(o,C,i,R,c)):e||l?e&&!l?p=Math.min(p,dp(i,R,o,C,c)):!e&&l&&(p=Math.min(p,dp(o,C,i,R,c))):p=Math.min(p,Ux(o,C,i,R,c)),p===0)return p}else{const B=cc(C,e),N=cc(R,l);rf(v,p,c,o,i,B[0],N[0]),rf(v,p,c,o,i,B[0],N[1]),rf(v,p,c,o,i,B[1],N[0]),rf(v,p,c,o,i,B[1],N[1])}}return p}function mp(o,e,i,l,c=1/0){let d=c;const p=Ta(o,[0,o.length-1]);for(const v of i)if(!(d!==1/0&&dl(p,Ta(v,[0,v.length-1]),l)>=d)&&(d=Math.min(d,fg(o,e,v,!0,l,d)),d===0))return d;return d}function of(o,e,i,l,c=1/0){let d=c;const p=Ta(o,[0,o.length-1]);for(const v of i){if(d!==1/0&&dl(p,Iu(v),l)>=d)continue;const w=qx(o,e,v,l,d);if(isNaN(w))return w;if((d=Math.min(d,w))===0)return d}return d}function _p(o){return o==="Point"||o==="MultiPoint"||o==="LineString"||o==="MultiLineString"||o==="Polygon"||o==="MultiPolygon"}class pl{constructor(e,i){this.type=Kt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(rc(e[1])){const l=e[1];if(l.type==="FeatureCollection"){for(let c=0;c<l.features.length;++c)if(_p(l.features[c].geometry.type))return new pl(l,l.features[c].geometry)}else if(l.type==="Feature"){if(_p(l.geometry.type))return new pl(l,l.geometry)}else if(_p(l.type))return new pl(l,l)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),l=e.canonicalID();if(i!=null&&l!=null){if(e.geometryType()==="Point")return function(c,d,p){const v=[];for(const S of c)for(const I of S)v.push(fp(I,d));const w=new lc(v[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?fg(v,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",w):p.type==="MultiLineString"?mp(v,!1,p.coordinates,w):p.type==="Polygon"||p.type==="MultiPolygon"?of(v,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,w):null}(i,l,this.geometries);if(e.geometryType()==="LineString")return function(c,d,p){const v=[];for(const S of c){const I=[];for(const C of S)I.push(fp(C,d));v.push(I)}const w=new lc(v[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return mp(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",v,w);if(p.type==="MultiLineString"){let S=1/0;for(let I=0;I<p.coordinates.length;I++){const C=mp(p.coordinates[I],!0,v,w,S);if(isNaN(C))return C;if((S=Math.min(S,C))===0)return S}return S}if(p.type==="Polygon"||p.type==="MultiPolygon"){let S=1/0;for(let I=0;I<v.length;I++){const C=of(v[I],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,w,S);if(isNaN(C))return C;if((S=Math.min(S,C))===0)return S}return S}return null}(i,l,this.geometries);if(e.geometryType()==="Polygon")return function(c,d,p){const v=[];for(const S of function(I,C){const R=I.length;if(R<=1)return[I];const B=[];let N,$;for(let X=0;X<R;X++){const K=Qr(I[X]);K!==0&&(I[X].area=Math.abs(K),$===void 0&&($=K<0),$===K<0?(N&&B.push(N),N=[I[X]]):N.push(I[X]))}return N&&B.push(N),B}(c)){const I=[];for(let C=0;C<S.length;++C)I.push(Vx(S[C],d));v.push(I)}const w=new lc(v[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return of(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",v,w);if(p.type==="MultiLineString"){let S=1/0;for(let I=0;I<p.coordinates.length;I++){const C=of(p.coordinates[I],!0,v,w,S);if(isNaN(C))return C;if((S=Math.min(S,C))===0)return S}return S}return p.type==="Polygon"||p.type==="MultiPolygon"?function(S,I,C){let R=1/0;for(const B of S)for(const N of I){const $=Gx(B,N,C,R);if(isNaN($))return $;if((R=Math.min(R,$))===0)return R}return R}(p.type==="Polygon"?[p.coordinates]:p.coordinates,v,w):null}(i,l,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function gp(o,e){switch(o){case"string":return Kr(e);case"number":return+e;case"boolean":return!!e;case"color":return Kn.parse(e);case"formatted":return Yr.fromString(Kr(e));case"resolvedImage":return co.build(Kr(e))}return e}function dg(o,e,i,l){return l!==void 0&&(o=l*Math.round(o/l)),e!==void 0&&o<e&&(o=e),i!==void 0&&o>i&&(o=i),o}class hc{constructor(e,i,l){this.type=e,this.key=i,this.scope=l}static parse(e,i){let l=i.expectedType;if(l==null&&(l=Qn),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const c=i.parse(e[1],1);if(!(c instanceof In))return i.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const d=i.parse(e[2],2);return d instanceof In?new hc(l,Kr(c.value),Kr(d.value)):i.error("Scope of 'config' expression must be a string literal.")}return new hc(l,Kr(c.value))}evaluate(e){const i=[this.key,this.scope,e.scope].filter(Boolean).join(""),l=e.getConfig(i);if(!l)return null;const{type:c,value:d,values:p,minValue:v,maxValue:w,stepValue:S}=l,I=l.default.evaluate(e);let C=I;if(d){const R=e.scope;e.scope=(R||"").split("").slice(1).join(""),C=d.evaluate(e),e.scope=R}return c&&(C=gp(c,C)),C===void 0||v===void 0&&w===void 0&&S===void 0||(typeof C=="number"?C=dg(C,v,w,S):Array.isArray(C)&&(C=C.map(R=>typeof R=="number"?dg(R,v,w,S):R))),d!==void 0&&C!==void 0&&p&&!p.includes(C)&&(C=I,c&&(C=gp(c,C))),(c&&c!==this.type||C!==void 0&&vr(C)!==this.type)&&(C=gp(this.type.kind,C)),C}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function Mu(o){if(o instanceof Gr&&(o.name==="get"&&o.args.length===1||o.name==="feature-state"||o.name==="has"&&o.args.length===1||o.name==="properties"||o.name==="geometry-type"||o.name==="id"||/^filter-/.test(o.name))||o instanceof Xs||o instanceof pl)return!1;let e=!0;return o.eachChild(i=>{e&&!Mu(i)&&(e=!1)}),e}function sf(o){if(o instanceof Gr&&o.name==="feature-state")return!1;let e=!0;return o.eachChild(i=>{e&&!sf(i)&&(e=!1)}),e}function af(o){if(o instanceof hc)return new Set([o.key]);let e=new Set;return o.eachChild(i=>{e=new Set([...e,...af(i)])}),e}function fc(o,e){if(o instanceof Gr&&e.indexOf(o.name)>=0)return!1;let i=!0;return o.eachChild(l=>{i&&!fc(l,e)&&(i=!1)}),i}class lf{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const l=e[1];return i.scope.has(l)?new lf(l,i.scope.get(l)):i.error(`Unknown variable "${l}". Make sure "${l}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class yp{constructor(e,i=[],l,c=new al,d=[],p,v){this.registry=e,this.path=i,this.key=i.map(w=>typeof w=="string"?`['${w}']`:`[${w}]`).join(""),this.scope=c,this.errors=d,this.expectedType=l,this._scope=p,this.options=v}parse(e,i,l,c,d={}){return i||l?this.concat(i,null,l,c)._parse(e,d):this._parse(e,d)}parseObjectValue(e,i,l,c,d,p={}){return this.concat(i,l,c,d)._parse(e,p)}_parse(e,i){function l(c,d,p){return p==="assert"?new sn(d,[c]):p==="coerce"?new ls(d,[c]):c}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const c=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(c){let d=c.parse(e,this);if(!d)return null;if(this.expectedType){const p=this.expectedType,v=d.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||v.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||v.kind!=="value"&&v.kind!=="string"){if(this.checkSubtype(p,v))return null}else d=l(d,p,i.typeAnnotation||"coerce");else d=l(d,p,i.typeAnnotation||"assert")}if(!(d instanceof In)&&d.type.kind!=="resolvedImage"&&vp(d)){const p=new Kh(this._scope,this.options);try{d=new In(d.type,d.evaluate(p))}catch(v){return this.error(v.message),null}}return d}return ls.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,l,c){let d=typeof e=="number"?this.path.concat(e):this.path;d=typeof i=="string"?d.concat(i):d;const p=c?this.scope.concat(c):this.scope;return new yp(this.registry,d,l||null,p,this.errors,this._scope,this.options)}error(e,...i){const l=`${this.key}${i.map(c=>`[${c}]`).join("")}`;this.errors.push(new Zo(l,e))}checkSubtype(e,i){const l=wu(e,i);return l&&this.error(l),l}}var pg=yp;function vp(o){if(o instanceof lf)return vp(o.boundExpression);if(o instanceof Gr&&o.name==="error"||o instanceof sc||o instanceof Xs||o instanceof pl||o instanceof hc)return!1;const e=o instanceof ls||o instanceof sn;let i=!0;return o.eachChild(l=>{i=e?i&&vp(l):i&&l instanceof In}),!!i&&Mu(o)&&fc(o,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function cf(o,e){const i=o.length-1;let l,c,d=0,p=i,v=0;for(;d<=p;)if(v=Math.floor((d+p)/2),l=o[v],c=o[v+1],l<=e){if(v===i||e<c)return v;d=v+1}else{if(!(l>e))throw new Ut("Input is not a number.");p=v-1}return 0}class Cu{constructor(e,i,l){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[c,d]of l)this.labels.push(c),this.outputs.push(d)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const l=i.parse(e[1],1,Kt);if(!l)return null;const c=[];let d=null;i.expectedType&&i.expectedType.kind!=="value"&&(d=i.expectedType);for(let p=1;p<e.length;p+=2){const v=p===1?-1/0:e[p],w=e[p+1],S=p,I=p+1;if(typeof v!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',S);if(c.length&&c[c.length-1][0]>=v)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',S);const C=i.parse(w,I,d);if(!C)return null;d=d||C.type,c.push([v,C])}return new Cu(d,l,c)}evaluate(e){const i=this.labels,l=this.outputs;if(i.length===1)return l[0].evaluate(e);const c=this.input.evaluate(e);if(c<=i[0])return l[0].evaluate(e);const d=i.length;return c>=i[d-1]?l[d-1].evaluate(e):l[cf(i,c)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const mg=.95047,_g=1.08883,gg=4/29,dc=6/29,yg=3*dc*dc,Hx=dc*dc*dc,xp=Math.PI/180,Zx=180/Math.PI;function uf(o){return o>Hx?Math.pow(o,1/3):o/yg+gg}function bp(o){return o>dc?o*o*o:yg*(o-gg)}function wp(o){return 255*(o<=.0031308?12.92*o:1.055*Math.pow(o,1/2.4)-.055)}function Tp(o){return(o/=255)<=.04045?o/12.92:Math.pow((o+.055)/1.055,2.4)}function Sp(o){const e=Tp(o.r),i=Tp(o.g),l=Tp(o.b),c=uf((.4124564*e+.3575761*i+.1804375*l)/mg),d=uf((.2126729*e+.7151522*i+.072175*l)/1);return{l:116*d-16,a:500*(c-d),b:200*(d-uf((.0193339*e+.119192*i+.9503041*l)/_g)),alpha:o.a}}function Ep(o){let e=(o.l+16)/116,i=isNaN(o.a)?e:e+o.a/500,l=isNaN(o.b)?e:e-o.b/200;return e=1*bp(e),i=mg*bp(i),l=_g*bp(l),new Kn(wp(3.2404542*i-1.5371385*e-.4985314*l),wp(-.969266*i+1.8760108*e+.041556*l),wp(.0556434*i-.2040259*e+1.0572252*l),o.alpha)}function pc(o,e,i){const l=e-o;return o+i*(l>180||l<-180?l-360*Math.round(l/360):l)}const mc={forward:Sp,reverse:Ep,interpolate:function(o,e,i){return{l:Jt(o.l,e.l,i),a:Jt(o.a,e.a,i),b:Jt(o.b,e.b,i),alpha:Jt(o.alpha,e.alpha,i)}}},_c={forward:function(o){const{l:e,a:i,b:l}=Sp(o),c=Math.atan2(l,i)*Zx;return{h:c<0?c+360:c,c:Math.sqrt(i*i+l*l),l:e,alpha:o.a}},reverse:function(o){const e=o.h*xp,i=o.c;return Ep({l:o.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:o.alpha})},interpolate:function(o,e,i){return{h:pc(o.h,e.h,i),c:Jt(o.c,e.c,i),l:Jt(o.l,e.l,i),alpha:Jt(o.alpha,e.alpha,i)}}};var vg=Object.freeze({__proto__:null,hcl:_c,lab:mc});class uo{constructor(e,i,l,c,d){this.type=e,this.operator=i,this.interpolation=l,this.input=c,this.labels=[],this.outputs=[];for(const[p,v]of d)this.labels.push(p),this.outputs.push(v)}static interpolationFactor(e,i,l,c){let d=0;if(e.name==="exponential")d=Pu(i,e.base,l,c);else if(e.name==="linear")d=Pu(i,1,l,c);else if(e.name==="cubic-bezier"){const p=e.controlPoints;d=new Bh(p[0],p[1],p[2],p[3]).solve(Pu(i,1,l,c))}return d}static parse(e,i){let[l,c,d,...p]=e;if(!Array.isArray(c)||c.length===0)return i.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){const S=c[1];if(typeof S!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:S}}else{if(c[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(c[0])}`,1,0);{const S=c.slice(1);if(S.length!==4||S.some(I=>typeof I!="number"||I<0||I>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:S}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(d=i.parse(d,2,Kt),!d)return null;const v=[];let w=null;l==="interpolate-hcl"||l==="interpolate-lab"?w=lo:i.expectedType&&i.expectedType.kind!=="value"&&(w=i.expectedType);for(let S=0;S<p.length;S+=2){const I=p[S],C=p[S+1],R=S+3,B=S+4;if(typeof I!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',R);if(v.length&&v[v.length-1][0]>=I)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',R);const N=i.parse(C,B,w);if(!N)return null;w=w||N.type,v.push([I,N])}return w.kind==="number"||w.kind==="color"||w.kind==="array"&&w.itemType.kind==="number"&&typeof w.N=="number"?new uo(w,l,c,d,v):i.error(`Type ${fr(w)} is not interpolatable.`)}evaluate(e){const i=this.labels,l=this.outputs;if(i.length===1)return l[0].evaluate(e);const c=this.input.evaluate(e);if(c<=i[0])return l[0].evaluate(e);const d=i.length;if(c>=i[d-1])return l[d-1].evaluate(e);const p=cf(i,c),v=uo.interpolationFactor(this.interpolation,c,i[p],i[p+1]),w=l[p].evaluate(e),S=l[p+1].evaluate(e);return this.operator==="interpolate"?Xh[this.type.kind.toLowerCase()](w,S,v):this.operator==="interpolate-hcl"?_c.reverse(_c.interpolate(_c.forward(w),_c.forward(S),v)):mc.reverse(mc.interpolate(mc.forward(w),mc.forward(S),v))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let l=0;l<this.labels.length;l++)i.push(this.labels[l],this.outputs[l].serialize());return i}}function Pu(o,e,i,l){const c=l-i,d=o-i;return c===0?0:e===1?d/c:(Math.pow(e,d)-1)/(Math.pow(e,c)-1)}class hf{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let l=null;const c=i.expectedType;c&&c.kind!=="value"&&(l=c);const d=[];for(const v of e.slice(1)){const w=i.parse(v,1+d.length,l,void 0,{typeAnnotation:"omit"});if(!w)return null;l=l||w.type,d.push(w)}const p=c&&d.some(v=>wu(c,v.type));return new hf(p?Qn:l,d)}evaluate(e){let i,l=null,c=0;for(const d of this.args){if(c++,l=d.evaluate(e),l&&l instanceof co&&!l.available&&(i||(i=l),l=null,c===this.args.length))return i;if(l!==null)break}return l}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class ff{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const l=[];for(let d=1;d<e.length-1;d+=2){const p=e[d];if(typeof p!="string")return i.error(`Expected string, but found ${typeof p} instead.`,d);if(/[^a-zA-Z0-9_]/.test(p))return i.error("Variable names must contain only alphanumeric characters or '_'.",d);const v=i.parse(e[d+1],d+1);if(!v)return null;l.push([p,v])}const c=i.parse(e[e.length-1],e.length-1,i.expectedType,l);return c?new ff(l,c):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,l]of this.bindings)e.push(i,l.serialize());return e.push(this.result.serialize()),e}}class df{constructor(e,i,l){this.type=e,this.index=i,this.input=l}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Kt),c=i.parse(e[2],2,Xr(i.expectedType||Qn));return l&&c?new df(c.type.itemType,l,c):null}evaluate(e){const i=this.index.evaluate(e),l=this.input.evaluate(e);if(i<0)throw new Ut(`Array index out of bounds: ${i} < 0.`);if(i>=l.length)throw new Ut(`Array index out of bounds: ${i} > ${l.length-1}.`);if(i!==Math.floor(i))throw new Ut(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return l[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class pf{constructor(e,i,l){this.type=e,this.index=i,this.input=l}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Kt),c=i.parse(e[2],2,Xr(i.expectedType||Qn));return l&&c?new pf(c.type.itemType,l,c):null}evaluate(e){const i=this.index.evaluate(e),l=this.input.evaluate(e);if(i<0)throw new Ut(`Array index out of bounds: ${i} < 0.`);if(i>l.length-1)throw new Ut(`Array index out of bounds: ${i} > ${l.length-1}.`);if(i===Math.floor(i))return l[i];const c=Math.floor(i),d=Math.ceil(i),p=l[c],v=l[d];if(typeof p!="number"||typeof v!="number")throw new Ut(`Cannot interpolate between non-number values at index ${i}.`);const w=i-c;return p*(1-w)+v*w}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Ap{constructor(e,i){this.type=ni,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Qn),c=i.parse(e[2],2,Qn);return l&&c?op(l.type,[ni,ui,Kt,ga,Qn])?new Ap(l,c):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${fr(l.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(l==null)return!1;if(!ic(i,["boolean","string","number","null"]))throw new Ut(`Expected first argument to be of type boolean, string, number or null, but found ${fr(vr(i))} instead.`);if(!ic(l,["string","array"]))throw new Ut(`Expected second argument to be of type array or string, but found ${fr(vr(l))} instead.`);return l.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class mf{constructor(e,i,l){this.type=Kt,this.needle=e,this.haystack=i,this.fromIndex=l}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Qn),c=i.parse(e[2],2,Qn);if(!l||!c)return null;if(!op(l.type,[ni,ui,Kt,ga,Qn]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${fr(l.type)} instead`);if(e.length===4){const d=i.parse(e[3],3,Kt);return d?new mf(l,c,d):null}return new mf(l,c)}evaluate(e){const i=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(!ic(i,["boolean","string","number","null"]))throw new Ut(`Expected first argument to be of type boolean, string, number or null, but found ${fr(vr(i))} instead.`);if(!ic(l,["string","array"]))throw new Ut(`Expected second argument to be of type array or string, but found ${fr(vr(l))} instead.`);if(this.fromIndex){const c=this.fromIndex.evaluate(e);return l.indexOf(i,c)}return l.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ip{constructor(e,i,l,c,d,p){this.inputType=e,this.type=i,this.input=l,this.cases=c,this.outputs=d,this.otherwise=p}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let l,c;i.expectedType&&i.expectedType.kind!=="value"&&(c=i.expectedType);const d={},p=[];for(let S=2;S<e.length-1;S+=2){let I=e[S];const C=e[S+1];Array.isArray(I)||(I=[I]);const R=i.concat(S);if(I.length===0)return R.error("Expected at least one branch label.");for(const N of I){if(typeof N!="number"&&typeof N!="string")return R.error("Branch labels must be numbers or strings.");if(typeof N=="number"&&Math.abs(N)>Number.MAX_SAFE_INTEGER)return R.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof N=="number"&&Math.floor(N)!==N)return R.error("Numeric branch labels must be integer values.");if(l){if(R.checkSubtype(l,vr(N)))return null}else l=vr(N);if(d[String(N)]!==void 0)return R.error("Branch labels must be unique.");d[String(N)]=p.length}const B=i.parse(C,S,c);if(!B)return null;c=c||B.type,p.push(B)}const v=i.parse(e[1],1,Qn);if(!v)return null;const w=i.parse(e[e.length-1],e.length-1,c);return w?v.type.kind!=="value"&&i.concat(1).checkSubtype(l,v.type)?null:new Ip(l,c,v,d,p,w):null}evaluate(e){const i=this.input.evaluate(e);return(vr(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),l=[],c={};for(const p of i){const v=c[this.cases[p]];v===void 0?(c[this.cases[p]]=l.length,l.push([this.cases[p],[p]])):l[v][1].push(p)}const d=p=>this.inputType.kind==="number"?Number(p):p;for(const[p,v]of l)e.push(v.length===1?d(v[0]):v.map(d)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class _f{constructor(e,i,l){this.type=e,this.branches=i,this.otherwise=l}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let l;i.expectedType&&i.expectedType.kind!=="value"&&(l=i.expectedType);const c=[];for(let p=1;p<e.length-1;p+=2){const v=i.parse(e[p],p,ni);if(!v)return null;const w=i.parse(e[p+1],p+1,l);if(!w)return null;c.push([v,w]),l=l||w.type}const d=i.parse(e[e.length-1],e.length-1,l);return d?new _f(l,c,d):null}evaluate(e){for(const[i,l]of this.branches)if(i.evaluate(e))return l.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,l]of this.branches)e(i),e(l);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class zu{constructor(e,i,l,c){this.type=e,this.input=i,this.beginIndex=l,this.endIndex=c}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Qn),c=i.parse(e[2],2,Kt);if(!l||!c)return null;if(!op(l.type,[Xr(Qn),ui,Qn]))return i.error(`Expected first argument to be of type array or string, but found ${fr(l.type)} instead`);if(e.length===4){const d=i.parse(e[3],3,Kt);return d?new zu(l.type,l,c,d):null}return new zu(l.type,l,c)}evaluate(e){const i=this.input.evaluate(e),l=this.beginIndex.evaluate(e);if(!ic(i,["string","array"]))throw new Ut(`Expected first argument to be of type array or string, but found ${fr(vr(i))} instead.`);if(this.endIndex){const c=this.endIndex.evaluate(e);return i.slice(l,c)}return i.slice(l)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Ru(o,e){return o==="=="||o==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function xg(o,e,i,l){return l.compare(e,i)===0}function ml(o,e,i){const l=o!=="=="&&o!=="!=";return class LL{constructor(d,p,v){this.type=ni,this.lhs=d,this.rhs=p,this.collator=v,this.hasUntypedArgument=d.type.kind==="value"||p.type.kind==="value"}static parse(d,p){if(d.length!==3&&d.length!==4)return p.error("Expected two or three arguments.");const v=d[0];let w=p.parse(d[1],1,Qn);if(!w)return null;if(!Ru(v,w.type))return p.concat(1).error(`"${v}" comparisons are not supported for type '${fr(w.type)}'.`);let S=p.parse(d[2],2,Qn);if(!S)return null;if(!Ru(v,S.type))return p.concat(2).error(`"${v}" comparisons are not supported for type '${fr(S.type)}'.`);if(w.type.kind!==S.type.kind&&w.type.kind!=="value"&&S.type.kind!=="value")return p.error(`Cannot compare types '${fr(w.type)}' and '${fr(S.type)}'.`);l&&(w.type.kind==="value"&&S.type.kind!=="value"?w=new sn(S.type,[w]):w.type.kind!=="value"&&S.type.kind==="value"&&(S=new sn(w.type,[S])));let I=null;if(d.length===4){if(w.type.kind!=="string"&&S.type.kind!=="string"&&w.type.kind!=="value"&&S.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(I=p.parse(d[3],3,ll),!I)return null}return new LL(w,S,I)}evaluate(d){const p=this.lhs.evaluate(d),v=this.rhs.evaluate(d);if(l&&this.hasUntypedArgument){const w=vr(p),S=vr(v);if(w.kind!==S.kind||w.kind!=="string"&&w.kind!=="number")throw new Ut(`Expected arguments for "${o}" to be (string, string) or (number, number), but found (${w.kind}, ${S.kind}) instead.`)}if(this.collator&&!l&&this.hasUntypedArgument){const w=vr(p),S=vr(v);if(w.kind!=="string"||S.kind!=="string")return e(d,p,v)}return this.collator?i(d,p,v,this.collator.evaluate(d)):e(d,p,v)}eachChild(d){d(this.lhs),d(this.rhs),this.collator&&d(this.collator)}outputDefined(){return!0}serialize(){const d=[o];return this.eachChild(p=>{d.push(p.serialize())}),d}}}const Wx=ml("==",function(o,e,i){return e===i},xg),Xx=ml("!=",function(o,e,i){return e!==i},function(o,e,i,l){return!xg(0,e,i,l)}),bg=ml("<",function(o,e,i){return e<i},function(o,e,i,l){return l.compare(e,i)<0}),wg=ml(">",function(o,e,i){return e>i},function(o,e,i,l){return l.compare(e,i)>0}),Yx=ml("<=",function(o,e,i){return e<=i},function(o,e,i,l){return l.compare(e,i)<=0}),Kx=ml(">=",function(o,e,i){return e>=i},function(o,e,i,l){return l.compare(e,i)>=0});class Mp{constructor(e,i,l,c,d,p){this.type=ui,this.number=e,this.locale=i,this.currency=l,this.unit=c,this.minFractionDigits=d,this.maxFractionDigits=p}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const l=i.parse(e[1],1,Kt);if(!l)return null;const c=e[2];if(typeof c!="object"||Array.isArray(c))return i.error("NumberFormat options argument must be an object.");let d=null;if(c.locale&&(d=i.parseObjectValue(c.locale,2,"locale",ui),!d))return null;let p=null;if(c.currency&&(p=i.parseObjectValue(c.currency,2,"currency",ui),!p))return null;let v=null;if(c.unit&&(v=i.parseObjectValue(c.unit,2,"unit",ui),!v))return null;let w=null;if(c["min-fraction-digits"]&&(w=i.parseObjectValue(c["min-fraction-digits"],2,"min-fraction-digits",Kt),!w))return null;let S=null;return c["max-fraction-digits"]&&(S=i.parseObjectValue(c["max-fraction-digits"],2,"max-fraction-digits",Kt),!S)?null:new Mp(l,d,p,v,w,S)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Du{constructor(e){this.type=Kt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const l=i.parse(e[1],1);return l?l.type.kind!=="array"&&l.type.kind!=="string"&&l.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${fr(l.type)} instead.`):new Du(l):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Ut(`Expected value to be of type string or array, but found ${fr(vr(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Tg(o){return function(){o=1831565813+(o|=0)|0;let e=Math.imul(o^o>>>15,1|o);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const _l={"==":Wx,"!=":Xx,">":wg,"<":bg,">=":Kx,"<=":Yx,array:sn,at:df,"at-interpolated":pf,boolean:sn,case:_f,coalesce:hf,collator:sc,format:cl,image:oc,in:Ap,"index-of":mf,interpolate:uo,"interpolate-hcl":uo,"interpolate-lab":uo,length:Du,let:ff,literal:In,match:Ip,number:sn,"number-format":Mp,object:sn,slice:zu,step:Cu,string:sn,"to-boolean":ls,"to-color":ls,"to-number":ls,"to-string":ls,var:lf,within:Xs,distance:pl,config:hc};function Sg(o,[e,i,l,c]){e=e.evaluate(o),i=i.evaluate(o),l=l.evaluate(o);const d=c?c.evaluate(o):1,p=ng(e,i,l,d);if(p)throw new Ut(p);return new Kn(e/255*d,i/255*d,l/255*d,d)}function Eg(o,[e,i,l,c]){e=e.evaluate(o),i=i.evaluate(o),l=l.evaluate(o);const d=c?c.evaluate(o):1,p=function(S,I,C,R){return typeof S=="number"&&S>=0&&S<=360?typeof I=="number"&&I>=0&&I<=100&&typeof C=="number"&&C>=0&&C<=100?R===void 0||typeof R=="number"&&R>=0&&R<=1?null:`Invalid hsla value [${[S,I,C,R].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof R=="number"?[S,I,C,R]:[S,I,C]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof R=="number"?[S,I,C,R]:[S,I,C]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,l,d);if(p)throw new Ut(p);const v=`hsla(${e}, ${i}%, ${l}%, ${d})`,w=Kn.parse(v);if(!w)throw new Ut(`Failed to parse HSLA color: ${v}`);return w}function Cp(o,e){return o in e}function gf(o,e){const i=e[o];return i===void 0?null:i}function Sa(o){return{type:o}}function Ag(o){return{result:"success",value:o}}function Co(o){return{result:"error",value:o}}function Pp(o,e){return!!o&&!!o.parameters&&o.parameters.indexOf(e)>-1}function yf(o){return o["property-type"]==="data-driven"}function Ig(o){return Pp(o.expression,"measure-light")}function zp(o){return Pp(o.expression,"zoom")}function vf(o){return!!o.expression&&o.expression.interpolated}function xf(o){return typeof o=="object"&&o!==null&&!Array.isArray(o)}function Mg(o){return o}function bf(o,e){const i=e.type==="color",l=o.stops&&typeof o.stops[0][0]=="object",c=l||!(l||o.property!==void 0),d=o.type||(vf(e)?"exponential":"interval");if(i&&((o=vu({},o)).stops&&(o.stops=o.stops.map(S=>[S[0],Kn.parse(S[1])])),o.default=Kn.parse(o.default?o.default:e.default)),o.colorSpace&&o.colorSpace!=="rgb"&&!vg[o.colorSpace])throw new Error(`Unknown color space: ${o.colorSpace}`);let p,v,w;if(d==="exponential")p=Ys;else if(d==="interval")p=Jx;else if(d==="categorical"){p=Cg,v=Object.create(null);for(const S of o.stops)v[S[0]]=S[1];w=typeof o.stops[0][0]}else{if(d!=="identity")throw new Error(`Unknown function type "${d}"`);p=Qx}if(l){const S={},I=[];for(let B=0;B<o.stops.length;B++){const N=o.stops[B],$=N[0].zoom;S[$]===void 0&&(S[$]={zoom:$,type:o.type,property:o.property,default:o.default,stops:[]},I.push($)),S[$].stops.push([N[0].value,N[1]])}const C=[];for(const B of I)C.push([S[B].zoom,bf(S[B],e)]);const R={name:"linear"};return{kind:"composite",interpolationType:R,interpolationFactor:uo.interpolationFactor.bind(void 0,R),zoomStops:C.map(B=>B[0]),evaluate:({zoom:B},N)=>Ys({stops:C,base:o.base},e,B).evaluate(B,N)}}if(c){const S=d==="exponential"?{name:"exponential",base:o.base!==void 0?o.base:1}:null;return{kind:"camera",interpolationType:S,interpolationFactor:uo.interpolationFactor.bind(void 0,S),zoomStops:o.stops.map(I=>I[0]),evaluate:({zoom:I})=>p(o,e,I,v,w)}}return{kind:"source",evaluate(S,I){const C=I&&I.properties?I.properties[o.property]:void 0;return C===void 0?gl(o.default,e.default):p(o,e,C,v,w)}}}function gl(o,e,i){return o!==void 0?o:e!==void 0?e:i!==void 0?i:void 0}function Cg(o,e,i,l,c){return gl(typeof i===c?l[i]:void 0,o.default,e.default)}function Jx(o,e,i){if(an(i)!=="number")return gl(o.default,e.default);const l=o.stops.length;if(l===1||i<=o.stops[0][0])return o.stops[0][1];if(i>=o.stops[l-1][0])return o.stops[l-1][1];const c=cf(o.stops.map(d=>d[0]),i);return o.stops[c][1]}function Ys(o,e,i){const l=o.base!==void 0?o.base:1;if(an(i)!=="number")return gl(o.default,e.default);const c=o.stops.length;if(c===1||i<=o.stops[0][0])return o.stops[0][1];if(i>=o.stops[c-1][0])return o.stops[c-1][1];const d=cf(o.stops.map(I=>I[0]),i),p=function(I,C,R,B){const N=B-R,$=I-R;return N===0?0:C===1?$/N:(Math.pow(C,$)-1)/(Math.pow(C,N)-1)}(i,l,o.stops[d][0],o.stops[d+1][0]),v=o.stops[d][1],w=o.stops[d+1][1];let S=Xh[e.type]||Mg;if(o.colorSpace&&o.colorSpace!=="rgb"){const I=vg[o.colorSpace];S=(C,R)=>I.reverse(I.interpolate(I.forward(C),I.forward(R),p))}return typeof v.evaluate=="function"?{evaluate(...I){const C=v.evaluate.apply(void 0,I),R=w.evaluate.apply(void 0,I);if(C!==void 0&&R!==void 0)return S(C,R,p)}}:S(v,w,p)}function Qx(o,e,i){return e.type==="color"?i=Kn.parse(i):e.type==="formatted"?i=Yr.fromString(i.toString()):e.type==="resolvedImage"?i=co.build(i.toString()):an(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),gl(i,o.default,e.default)}Gr.register(_l,{error:[{kind:"error"},[ui],(o,[e])=>{throw new Ut(e.evaluate(o))}],typeof:[ui,[Qn],(o,[e])=>fr(vr(e.evaluate(o)))],"to-rgba":[Xr(Kt,4),[lo],(o,[e])=>e.evaluate(o).toRenderColor(null).toArray()],"to-hsla":[Xr(Kt,4),[lo],(o,[e])=>e.evaluate(o).toRenderColor(null).toHslaArray()],rgb:[lo,[Kt,Kt,Kt],Sg],rgba:[lo,[Kt,Kt,Kt,Kt],Sg],hsl:[lo,[Kt,Kt,Kt],Eg],hsla:[lo,[Kt,Kt,Kt,Kt],Eg],has:{type:ni,overloads:[[[ui],(o,[e])=>Cp(e.evaluate(o),o.properties())],[[ui,ya],(o,[e,i])=>Cp(e.evaluate(o),i.evaluate(o))]]},get:{type:Qn,overloads:[[[ui],(o,[e])=>gf(e.evaluate(o),o.properties())],[[ui,ya],(o,[e,i])=>gf(e.evaluate(o),i.evaluate(o))]]},"feature-state":[Qn,[ui],(o,[e])=>gf(e.evaluate(o),o.featureState||{})],properties:[ya,[],o=>o.properties()],"geometry-type":[ui,[],o=>o.geometryType()],id:[Qn,[],o=>o.id()],zoom:[Kt,[],o=>o.globals.zoom],pitch:[Kt,[],o=>o.globals.pitch||0],"distance-from-center":[Kt,[],o=>o.distanceFromCenter()],"measure-light":[Kt,[ui],(o,[e])=>o.measureLight(e.evaluate(o))],"heatmap-density":[Kt,[],o=>o.globals.heatmapDensity||0],"line-progress":[Kt,[],o=>o.globals.lineProgress||0],"raster-value":[Kt,[],o=>o.globals.rasterValue||0],"raster-particle-speed":[Kt,[],o=>o.globals.rasterParticleSpeed||0],"sky-radial-progress":[Kt,[],o=>o.globals.skyRadialProgress||0],accumulated:[Qn,[],o=>o.globals.accumulated===void 0?null:o.globals.accumulated],"+":[Kt,Sa(Kt),(o,e)=>{let i=0;for(const l of e)i+=l.evaluate(o);return i}],"*":[Kt,Sa(Kt),(o,e)=>{let i=1;for(const l of e)i*=l.evaluate(o);return i}],"-":{type:Kt,overloads:[[[Kt,Kt],(o,[e,i])=>e.evaluate(o)-i.evaluate(o)],[[Kt],(o,[e])=>-e.evaluate(o)]]},"/":[Kt,[Kt,Kt],(o,[e,i])=>e.evaluate(o)/i.evaluate(o)],"%":[Kt,[Kt,Kt],(o,[e,i])=>e.evaluate(o)%i.evaluate(o)],ln2:[Kt,[],()=>Math.LN2],pi:[Kt,[],()=>Math.PI],e:[Kt,[],()=>Math.E],"^":[Kt,[Kt,Kt],(o,[e,i])=>Math.pow(e.evaluate(o),i.evaluate(o))],sqrt:[Kt,[Kt],(o,[e])=>Math.sqrt(e.evaluate(o))],log10:[Kt,[Kt],(o,[e])=>Math.log(e.evaluate(o))/Math.LN10],ln:[Kt,[Kt],(o,[e])=>Math.log(e.evaluate(o))],log2:[Kt,[Kt],(o,[e])=>Math.log(e.evaluate(o))/Math.LN2],sin:[Kt,[Kt],(o,[e])=>Math.sin(e.evaluate(o))],cos:[Kt,[Kt],(o,[e])=>Math.cos(e.evaluate(o))],tan:[Kt,[Kt],(o,[e])=>Math.tan(e.evaluate(o))],asin:[Kt,[Kt],(o,[e])=>Math.asin(e.evaluate(o))],acos:[Kt,[Kt],(o,[e])=>Math.acos(e.evaluate(o))],atan:[Kt,[Kt],(o,[e])=>Math.atan(e.evaluate(o))],min:[Kt,Sa(Kt),(o,e)=>Math.min(...e.map(i=>i.evaluate(o)))],max:[Kt,Sa(Kt),(o,e)=>Math.max(...e.map(i=>i.evaluate(o)))],abs:[Kt,[Kt],(o,[e])=>Math.abs(e.evaluate(o))],round:[Kt,[Kt],(o,[e])=>{const i=e.evaluate(o);return i<0?-Math.round(-i):Math.round(i)}],floor:[Kt,[Kt],(o,[e])=>Math.floor(e.evaluate(o))],ceil:[Kt,[Kt],(o,[e])=>Math.ceil(e.evaluate(o))],"filter-==":[ni,[ui,Qn],(o,[e,i])=>o.properties()[e.value]===i.value],"filter-id-==":[ni,[Qn],(o,[e])=>o.id()===e.value],"filter-type-==":[ni,[ui],(o,[e])=>o.geometryType()===e.value],"filter-<":[ni,[ui,Qn],(o,[e,i])=>{const l=o.properties()[e.value],c=i.value;return typeof l==typeof c&&l<c}],"filter-id-<":[ni,[Qn],(o,[e])=>{const i=o.id(),l=e.value;return typeof i==typeof l&&i<l}],"filter->":[ni,[ui,Qn],(o,[e,i])=>{const l=o.properties()[e.value],c=i.value;return typeof l==typeof c&&l>c}],"filter-id->":[ni,[Qn],(o,[e])=>{const i=o.id(),l=e.value;return typeof i==typeof l&&i>l}],"filter-<=":[ni,[ui,Qn],(o,[e,i])=>{const l=o.properties()[e.value],c=i.value;return typeof l==typeof c&&l<=c}],"filter-id-<=":[ni,[Qn],(o,[e])=>{const i=o.id(),l=e.value;return typeof i==typeof l&&i<=l}],"filter->=":[ni,[ui,Qn],(o,[e,i])=>{const l=o.properties()[e.value],c=i.value;return typeof l==typeof c&&l>=c}],"filter-id->=":[ni,[Qn],(o,[e])=>{const i=o.id(),l=e.value;return typeof i==typeof l&&i>=l}],"filter-has":[ni,[Qn],(o,[e])=>e.value in o.properties()],"filter-has-id":[ni,[],o=>o.id()!==null&&o.id()!==void 0],"filter-type-in":[ni,[Xr(ui)],(o,[e])=>e.value.indexOf(o.geometryType())>=0],"filter-id-in":[ni,[Xr(Qn)],(o,[e])=>e.value.indexOf(o.id())>=0],"filter-in-small":[ni,[ui,Xr(Qn)],(o,[e,i])=>i.value.indexOf(o.properties()[e.value])>=0],"filter-in-large":[ni,[ui,Xr(Qn)],(o,[e,i])=>function(l,c,d,p){for(;d<=p;){const v=d+p>>1;if(c[v]===l)return!0;c[v]>l?p=v-1:d=v+1}return!1}(o.properties()[e.value],i.value,0,i.value.length-1)],all:{type:ni,overloads:[[[ni,ni],(o,[e,i])=>e.evaluate(o)&&i.evaluate(o)],[Sa(ni),(o,e)=>{for(const i of e)if(!i.evaluate(o))return!1;return!0}]]},any:{type:ni,overloads:[[[ni,ni],(o,[e,i])=>e.evaluate(o)||i.evaluate(o)],[Sa(ni),(o,e)=>{for(const i of e)if(i.evaluate(o))return!0;return!1}]]},"!":[ni,[ni],(o,[e])=>!e.evaluate(o)],"is-supported-script":[ni,[ui],(o,[e])=>{const i=o.globals&&o.globals.isSupportedScript;return!i||i(e.evaluate(o))}],upcase:[ui,[ui],(o,[e])=>e.evaluate(o).toUpperCase()],downcase:[ui,[ui],(o,[e])=>e.evaluate(o).toLowerCase()],concat:[ui,Sa(Qn),(o,e)=>e.map(i=>Kr(i.evaluate(o))).join("")],"resolved-locale":[ui,[ll],(o,[e])=>e.evaluate(o).resolvedLocale()],random:[Kt,[Kt,Kt,Qn],(o,e)=>{const[i,l,c]=e.map(p=>p.evaluate(o));if(i>l||i===l)return i;let d;if(typeof c=="string")d=function(p){let v=0;if(p.length===0)return v;for(let w=0;w<p.length;w++)v=(v<<5)-v+p.charCodeAt(w),v|=0;return v}(c);else{if(typeof c!="number")throw new Ut(`Invalid seed input: ${c}`);d=c}return i+Tg(d)()*(l-i)}]});class Rp{constructor(e,i,l,c){this.expression=e,this._warningHistory={},this._evaluator=new Kh(l,c),this._defaultValue=i?function(d){return d.type==="color"&&(xf(d.default)||Array.isArray(d.default))?new Kn(0,0,0,0):d.type==="color"?Kn.parse(d.default)||null:d.default===void 0?null:d.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=af(e)}evaluateWithoutErrorHandling(e,i,l,c,d,p,v,w){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=l,this._evaluator.canonical=c||null,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,l,c,d,p,v,w){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=l||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=v||null,this._evaluator.featureDistanceData=w||null;try{const S=this.expression.evaluate(this._evaluator);if(S==null||typeof S=="number"&&S!=S)return this._defaultValue;if(this._enumValues&&!(S in this._enumValues))throw new Ut(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(S)} instead.`);return S}catch(S){return this._warningHistory[S.message]||(this._warningHistory[S.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${S.message}`)),this._defaultValue}}}function wf(o){return Array.isArray(o)&&o.length>0&&typeof o[0]=="string"&&o[0]in _l}function gc(o,e,i,l){const c=new pg(_l,[],e?function(p){const v={color:lo,string:ui,number:Kt,enum:ui,boolean:ni,formatted:xu,resolvedImage:bu};return p.type==="array"?Xr(v[p.value]||Qn,p.length):v[p.type]}(e):void 0,void 0,void 0,i,l),d=c.parse(o,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return d?Ag(new Rp(d,e,i,l)):Co(c.errors)}class yl{constructor(e,i,l,c){this.kind=e,this._styleExpression=i,this.isLightConstant=l,this.isLineProgressConstant=c,this.isStateDependent=e!=="constant"&&!sf(i.expression),this.configDependencies=af(i.expression)}evaluateWithoutErrorHandling(e,i,l,c,d,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,l,c,d,p)}evaluate(e,i,l,c,d,p){return this._styleExpression.evaluate(e,i,l,c,d,p)}}class yc{constructor(e,i,l,c,d,p){this.kind=e,this.zoomStops=l,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!sf(i.expression),this.isLightConstant=d,this.isLineProgressConstant=p,this.configDependencies=af(i.expression),this.interpolationType=c}evaluateWithoutErrorHandling(e,i,l,c,d,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,l,c,d,p)}evaluate(e,i,l,c,d,p){return this._styleExpression.evaluate(e,i,l,c,d,p)}interpolationFactor(e,i,l){return this.interpolationType?uo.interpolationFactor(this.interpolationType,e,i,l):0}}function Lu(o,e,i,l){if((o=gc(o,e,i,l)).result==="error")return o;const c=o.value.expression,d=Mu(c);if(!d&&!yf(e))return Co([new Zo("","data expressions not supported")]);const p=fc(c,["zoom","pitch","distance-from-center"]);if(!p&&!zp(e))return Co([new Zo("","zoom expressions not supported")]);const v=fc(c,["measure-light"]);if(!v&&!Ig(e))return Co([new Zo("","measure-light expression not supported")]);const w=fc(c,["line-progress"]);if(!w&&!function(C){return Pp(C.expression,"line-progress")}(e))return Co([new Zo("","line-progress expression not supported")]);const S=e.expression&&e.expression.relaxZoomRestriction,I=Tf(c);return I||p||S?I instanceof Zo?Co([I]):I instanceof uo&&!vf(e)?Co([new Zo("",'"interpolate" expressions cannot be used with this property')]):Ag(I?new yc(d&&w?"camera":"composite",o.value,I.labels,I instanceof uo?I.interpolation:void 0,v,w):new yl(d&&w?"constant":"source",o.value,v,w)):Co([new Zo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ku{constructor(e,i){this._parameters=e,this._specification=i,vu(this,bf(this._parameters,this._specification))}static deserialize(e){return new ku(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Tf(o){let e=null;if(o instanceof ff)e=Tf(o.result);else if(o instanceof hf){for(const i of o.args)if(e=Tf(i),e)break}else(o instanceof Cu||o instanceof uo)&&o.input instanceof Gr&&o.input.name==="zoom"&&(e=o);return e instanceof Zo||o.eachChild(i=>{const l=Tf(i);l instanceof Zo?e=l:e&&l&&e!==l&&(e=new Zo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Dp,Sf,Lp=function(){if(Sf)return Dp;Sf=1,Dp=e;var o=3;function e(i,l,c){var d=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var p=new Int32Array(this.arrayBuffer);i=p[0],this.d=(l=p[1])+2*(c=p[2]);for(var v=0;v<this.d*this.d;v++){var w=p[o+v],S=p[o+v+1];d.push(w===S?null:p.subarray(w,S))}var I=p[o+d.length+1];this.keys=p.subarray(p[o+d.length],I),this.bboxes=p.subarray(I),this.insert=this._insertReadonly}else{this.d=l+2*c;for(var C=0;C<this.d*this.d;C++)d.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=i,this.padding=c,this.scale=l/i,this.uid=0;var R=c/l*i;this.min=-R,this.max=i+R}return e.prototype.insert=function(i,l,c,d,p){this._forEachCell(l,c,d,p,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(l),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,l,c,d,p,v){this.cells[p].push(v)},e.prototype.query=function(i,l,c,d,p){var v=this.min,w=this.max;if(i<=v&&l<=v&&w<=c&&w<=d&&!p)return Array.prototype.slice.call(this.keys);var S=[];return this._forEachCell(i,l,c,d,this._queryCell,S,{},p),S},e.prototype._queryCell=function(i,l,c,d,p,v,w,S){var I=this.cells[p];if(I!==null)for(var C=this.keys,R=this.bboxes,B=0;B<I.length;B++){var N=I[B];if(w[N]===void 0){var $=4*N;(S?S(R[$+0],R[$+1],R[$+2],R[$+3]):i<=R[$+2]&&l<=R[$+3]&&c>=R[$+0]&&d>=R[$+1])?(w[N]=!0,v.push(C[N])):w[N]=!1}}},e.prototype._forEachCell=function(i,l,c,d,p,v,w,S){for(var I=this._convertToCellCoord(i),C=this._convertToCellCoord(l),R=this._convertToCellCoord(c),B=this._convertToCellCoord(d),N=I;N<=R;N++)for(var $=C;$<=B;$++){var X=this.d*$+N;if((!S||S(this._convertFromCellCoord(N),this._convertFromCellCoord($),this._convertFromCellCoord(N+1),this._convertFromCellCoord($+1)))&&p.call(this,i,l,c,d,X,v,w,S))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,l=o+this.cells.length+1+1,c=0,d=0;d<this.cells.length;d++)c+=this.cells[d].length;var p=new Int32Array(l+c+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;for(var v=l,w=0;w<i.length;w++){var S=i[w];p[o+w]=v,p.set(S,v),v+=S.length}return p[o+i.length]=v,p.set(this.keys,v),p[o+i.length+1]=v+=this.keys.length,p.set(this.bboxes,v),v+=this.bboxes.length,p.buffer},Dp}(),vc=Ts(Lp);const Ou={};function Ft(o,e,i={}){Object.defineProperty(o,"_classRegistryKey",{value:e,writable:!1}),Ou[e]={klass:o,omit:i.omit||[]}}Ft(Object,"Object"),vc.serialize=function(o,e){const i=o.toArrayBuffer();return e&&e.add(i),{buffer:i}},vc.deserialize=function(o){return new vc(o.buffer)},Object.defineProperty(vc,"name",{value:"Grid"}),Ft(vc,"Grid"),typeof DOMMatrix<"u"&&Ft(DOMMatrix,"DOMMatrix"),Ft(Kn,"Color"),Ft(Error,"Error"),Ft(Yr,"Formatted"),Ft(Yh,"FormattedSection"),Ft(Gh,"AJAXError"),Ft(co,"ResolvedImage"),Ft(ku,"StylePropertyFunction"),Ft(Rp,"StyleExpression",{omit:["_evaluator"]}),Ft(_o,"ImageId"),Ft(as,"ImageVariant"),Ft(yc,"ZoomDependentExpression"),Ft(yl,"ZoomConstantExpression"),Ft(Gr,"CompoundExpression",{omit:["_evaluate"]});for(const o in _l)Ou[_l[o]._classRegistryKey]||Ft(_l[o],`Expression${o}`);function Fu(o){return o&&typeof ArrayBuffer<"u"&&(o instanceof ArrayBuffer||o.constructor&&o.constructor.name==="ArrayBuffer")}function vl(o){return self.ImageBitmap&&o instanceof ImageBitmap}function Ea(o,e){if(o==null||typeof o=="boolean"||typeof o=="number"||typeof o=="string"||o instanceof Boolean||o instanceof Number||o instanceof String||o instanceof Date||o instanceof RegExp)return o;if(Fu(o)||vl(o))return e&&e.add(o),o;if(ArrayBuffer.isView(o))return e&&e.add(o.buffer),o;if(o instanceof ImageData)return e&&e.add(o.data.buffer),o;if(Array.isArray(o)){const i=[];for(const l of o)i.push(Ea(l,e));return i}if(o instanceof Map){const i={$name:"Map",entries:[]};for(const[l,c]of o.entries())i.entries.push(Ea(l),Ea(c,e));return i}if(o instanceof Set){const i={$name:"Set"};let l=0;for(const c of o.values())i[++l]=Ea(c);return i}if(o instanceof DOMMatrix){const i={$name:"DOMMatrix"},l=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const c of l)i[c]=o[c];return i}if(typeof o=="bigint")return{$name:"BigInt",value:o.toString()};if(typeof o=="object"){const i=o.constructor,l=i._classRegistryKey;if(!l)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const c=i.serialize?i.serialize(o,e):{};if(!i.serialize){for(const d in o)o.hasOwnProperty(d)&&(Ou[l].omit.indexOf(d)>=0||(c[d]=Ea(o[d],e)));o instanceof Error&&(c.message=o.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return l!=="Object"&&(c.$name=l),c}throw new Error("can't serialize object of type "+typeof o)}function Aa(o){if(o==null||typeof o=="boolean"||typeof o=="number"||typeof o=="string"||o instanceof Boolean||o instanceof Number||o instanceof String||o instanceof Date||o instanceof RegExp||Fu(o)||vl(o)||ArrayBuffer.isView(o)||o instanceof ImageData)return o;if(Array.isArray(o))return o.map(Aa);if(typeof o=="object"){const e=o.$name||"Object";if(e==="Map"){const c=o.entries||[],d=new Map;for(let p=0;p<c.length;p+=2)d.set(Aa(c[p]),Aa(c[p+1]));return d}if(e==="Set"){const c=new Set;for(const d of Object.keys(o))d!=="$name"&&c.add(Aa(o[d]));return c}if(e==="DOMMatrix"){let c;return c=o.is2D?[o.a,o.b,o.c,o.d,o.e,o.f]:[o.m11,o.m12,o.m13,o.m14,o.m21,o.m22,o.m23,o.m24,o.m31,o.m32,o.m33,o.m34,o.m41,o.m42,o.m43,o.m44],new DOMMatrix(c)}if(e==="BigInt")return BigInt(o.value);const{klass:i}=Ou[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(o);const l=Object.create(i.prototype);for(const c of Object.keys(o))c!=="$name"&&(l[c]=Aa(o[c]));return l}throw new Error("can't deserialize object of type "+typeof o)}const Qt={"Latin-1 Supplement":o=>o>=128&&o<=255,Arabic:o=>o>=1536&&o<=1791,"Arabic Supplement":o=>o>=1872&&o<=1919,"Arabic Extended-A":o=>o>=2208&&o<=2303,"Hangul Jamo":o=>o>=4352&&o<=4607,"Unified Canadian Aboriginal Syllabics":o=>o>=5120&&o<=5759,Khmer:o=>o>=6016&&o<=6143,"Unified Canadian Aboriginal Syllabics Extended":o=>o>=6320&&o<=6399,"General Punctuation":o=>o>=8192&&o<=8303,"Letterlike Symbols":o=>o>=8448&&o<=8527,"Number Forms":o=>o>=8528&&o<=8591,"Miscellaneous Technical":o=>o>=8960&&o<=9215,"Control Pictures":o=>o>=9216&&o<=9279,"Optical Character Recognition":o=>o>=9280&&o<=9311,"Enclosed Alphanumerics":o=>o>=9312&&o<=9471,"Geometric Shapes":o=>o>=9632&&o<=9727,"Miscellaneous Symbols":o=>o>=9728&&o<=9983,"Miscellaneous Symbols and Arrows":o=>o>=11008&&o<=11263,"CJK Radicals Supplement":o=>o>=11904&&o<=12031,"Kangxi Radicals":o=>o>=12032&&o<=12255,"Ideographic Description Characters":o=>o>=12272&&o<=12287,"CJK Symbols and Punctuation":o=>o>=12288&&o<=12351,Hiragana:o=>o>=12352&&o<=12447,Katakana:o=>o>=12448&&o<=12543,Bopomofo:o=>o>=12544&&o<=12591,"Hangul Compatibility Jamo":o=>o>=12592&&o<=12687,Kanbun:o=>o>=12688&&o<=12703,"Bopomofo Extended":o=>o>=12704&&o<=12735,"CJK Strokes":o=>o>=12736&&o<=12783,"Katakana Phonetic Extensions":o=>o>=12784&&o<=12799,"Enclosed CJK Letters and Months":o=>o>=12800&&o<=13055,"CJK Compatibility":o=>o>=13056&&o<=13311,"CJK Unified Ideographs Extension A":o=>o>=13312&&o<=19903,"Yijing Hexagram Symbols":o=>o>=19904&&o<=19967,"CJK Unified Ideographs":o=>o>=19968&&o<=40959,"Yi Syllables":o=>o>=40960&&o<=42127,"Yi Radicals":o=>o>=42128&&o<=42191,"Hangul Jamo Extended-A":o=>o>=43360&&o<=43391,"Hangul Syllables":o=>o>=44032&&o<=55215,"Hangul Jamo Extended-B":o=>o>=55216&&o<=55295,"Private Use Area":o=>o>=57344&&o<=63743,"CJK Compatibility Ideographs":o=>o>=63744&&o<=64255,"Arabic Presentation Forms-A":o=>o>=64336&&o<=65023,"Vertical Forms":o=>o>=65040&&o<=65055,"CJK Compatibility Forms":o=>o>=65072&&o<=65103,"Small Form Variants":o=>o>=65104&&o<=65135,"Arabic Presentation Forms-B":o=>o>=65136&&o<=65279,"Halfwidth and Fullwidth Forms":o=>o>=65280&&o<=65519,Osage:o=>o>=66736&&o<=66815,"CJK Unified Ideographs Extension B":o=>o>=131072&&o<=173791};function kp(o){for(const e of o)if(Bu(e.charCodeAt(0)))return!0;return!1}function e1(o){for(const e of o)if(!Pg(e.charCodeAt(0)))return!1;return!0}function Pg(o){return!(Qt.Arabic(o)||Qt["Arabic Supplement"](o)||Qt["Arabic Extended-A"](o)||Qt["Arabic Presentation Forms-A"](o)||Qt["Arabic Presentation Forms-B"](o))}function Bu(o){return!(o!==746&&o!==747&&(o<4352||!(Qt["Bopomofo Extended"](o)||Qt.Bopomofo(o)||Qt["CJK Compatibility Forms"](o)&&!(o>=65097&&o<=65103)||Qt["CJK Compatibility Ideographs"](o)||Qt["CJK Compatibility"](o)||Qt["CJK Radicals Supplement"](o)||Qt["CJK Strokes"](o)||!(!Qt["CJK Symbols and Punctuation"](o)||o>=12296&&o<=12305||o>=12308&&o<=12319||o===12336)||Qt["CJK Unified Ideographs Extension A"](o)||Qt["CJK Unified Ideographs"](o)||Qt["Enclosed CJK Letters and Months"](o)||Qt["Hangul Compatibility Jamo"](o)||Qt["Hangul Jamo Extended-A"](o)||Qt["Hangul Jamo Extended-B"](o)||Qt["Hangul Jamo"](o)||Qt["Hangul Syllables"](o)||Qt.Hiragana(o)||Qt["Ideographic Description Characters"](o)||Qt.Kanbun(o)||Qt["Kangxi Radicals"](o)||Qt["Katakana Phonetic Extensions"](o)||Qt.Katakana(o)&&o!==12540||!(!Qt["Halfwidth and Fullwidth Forms"](o)||o===65288||o===65289||o===65293||o>=65306&&o<=65310||o===65339||o===65341||o===65343||o>=65371&&o<=65503||o===65507||o>=65512&&o<=65519)||!(!Qt["Small Form Variants"](o)||o>=65112&&o<=65118||o>=65123&&o<=65126)||Qt["Unified Canadian Aboriginal Syllabics"](o)||Qt["Unified Canadian Aboriginal Syllabics Extended"](o)||Qt["Vertical Forms"](o)||Qt["Yijing Hexagram Symbols"](o)||Qt["Yi Syllables"](o)||Qt["Yi Radicals"](o))))}function zg(o){return!(Bu(o)||function(e){return!!(Qt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Qt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Qt["Letterlike Symbols"](e)||Qt["Number Forms"](e)||Qt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Qt["Control Pictures"](e)&&e!==9251||Qt["Optical Character Recognition"](e)||Qt["Enclosed Alphanumerics"](e)||Qt["Geometric Shapes"](e)||Qt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Qt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Qt["CJK Symbols and Punctuation"](e)||Qt.Katakana(e)||Qt["Private Use Area"](e)||Qt["CJK Compatibility Forms"](e)||Qt["Small Form Variants"](e)||Qt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(o))}function t1(o){return Qt.Arabic(o)||Qt["Arabic Supplement"](o)||Qt["Arabic Extended-A"](o)||Qt["Arabic Presentation Forms-A"](o)||Qt["Arabic Presentation Forms-B"](o)}function Rg(o){return o>=1424&&o<=2303||Qt["Arabic Presentation Forms-A"](o)||Qt["Arabic Presentation Forms-B"](o)}function n1(o,e){return!(!e&&Rg(o)||o>=2304&&o<=3583||o>=3840&&o<=4255||Qt.Khmer(o))}function i1(o){for(const e of o)if(Rg(e.charCodeAt(0)))return!0;return!1}const Op="deferred",Fp="loading",Bp="loaded";let Np=null,go="unavailable",Ia=null;const xl=function(o){o&&typeof o=="string"&&o.indexOf("NetworkError")>-1&&(go="error"),Np&&Np(o)};function Ef(){Af.fire(new _a("pluginStateChange",{pluginStatus:go,pluginURL:Ia}))}const Af=new sl,xc=function(){return go},Dg=function(){if(go!==Op||!Ia)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");go=Fp,Ef(),Ia&&ec({url:Ia},o=>{o?xl(o):(go=Bp,Ef())})},Yo={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>go===Bp||Yo.applyArabicShaping!=null,isLoading:()=>go===Fp,setState(o){go=o.pluginStatus,Ia=o.pluginURL},isParsed:()=>Yo.applyArabicShaping!=null&&Yo.processBidirectionalText!=null&&Yo.processStyledBidirectionalText!=null,getPluginURL:()=>Ia};class si{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,l){for(const c of i)if(!n1(c.charCodeAt(0),l))return!1;return!0}(e,Yo.isLoaded())}}class Nu{constructor(e,i,l,c){this.property=e,this.value=i,this.expression=function(d,p,v,w){if(xf(d))return new ku(d,p);if(wf(d)||Array.isArray(d)&&d.length>0){const S=Lu(d,p,v,w);if(S.result==="error")throw new Error(S.value.map(I=>`${I.key}: ${I.message}`).join(", "));return S.value}{let S=d;return typeof d=="string"&&p.type==="color"&&(S=Kn.parse(d)),{kind:"constant",configDependencies:new Set,evaluate:()=>S}}}(i===void 0?e.specification.default:i,e.specification,l,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,l){return this.property.possiblyEvaluate(this,e,i,l)}}class Ma{constructor(e,i,l){this.property=e,this.value=new Nu(e,void 0,i,l)}transitioned(e,i){return new kg(this.property,this.value,i,$e({},e.transition,this.transition),e.now)}untransitioned(){return new kg(this.property,this.value,null,{},0)}}class Lg{constructor(e,i,l){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=l,this.configDependencies=new Set}getValue(e){return zn(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Ma(this._values[e].property,this._scope,this._options)),this._values[e].value=new Nu(this._values[e].property,i===null?void 0:zn(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const l=this._properties.properties;if(e)for(const c in e){const d=e[c];if(c.endsWith("-transition")){const p=c.slice(0,-11);l[p]&&this.setTransition(p,d)}else l.hasOwnProperty(c)&&this.setValue(c,d)}}getTransition(e){return zn(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Ma(this._values[e].property)),this._values[e].transition=zn(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const l=this.getValue(i);l!==void 0&&(e[i]=l);const c=this.getTransition(i);c!==void 0&&(e[`${i}-transition`]=c)}return e}transitioned(e,i){const l=new Og(this._properties);for(const c of Object.keys(this._values))l._values[c]=this._values[c].transitioned(e,i._values[c]);return l}untransitioned(){const e=new Og(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class kg{constructor(e,i,l,c,d){const p=c.delay||0,v=c.duration||0;d=d||0,this.property=e,this.value=i,this.begin=d+p,this.end=this.begin+v,e.specification.transition&&(c.delay||c.duration)&&(this.prior=l)}possiblyEvaluate(e,i,l){const c=e.now||0,d=this.value.possiblyEvaluate(e,i,l),p=this.prior;if(p){if(c>this.end)return this.prior=null,d;if(this.value.isDataDriven())return this.prior=null,d;if(c<this.begin)return p.possiblyEvaluate(e,i,l);{const v=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,i,l),d,Ee(v))}}return d}}class Og{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,l){const c=new bl(this._properties);for(const d of Object.keys(this._values))c._values[d]=this._values[d].possiblyEvaluate(e,i,l);return c}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class r1{constructor(e,i,l){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=l,this.configDependencies=new Set}getValue(e){return zn(this._values[e].value)}setValue(e,i){this._values[e]=new Nu(this._values[e].property,i===null?void 0:zn(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const l=this.getValue(i);l!==void 0&&(e[i]=l)}return e}possiblyEvaluate(e,i,l){const c=new bl(this._properties);for(const d of Object.keys(this._values))c._values[d]=this._values[d].possiblyEvaluate(e,i,l);return c}}class bc{constructor(e,i,l){this.property=e,this.value=i,this.parameters=l}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,l,c){return this.property.evaluate(this.value,this.parameters,e,i,l,c)}}class bl{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class wt{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,l){const c=Xh[this.specification.type];return c?c(e,i,l):e}}class Ot{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,l,c){return new bc(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},l,c)}:e.expression,i)}interpolate(e,i,l){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new bc(this,{kind:"constant",value:void 0},e.parameters);const c=Xh[this.specification.type];return c?new bc(this,{kind:"constant",value:c(e.value.value,i.value.value,l)},e.parameters):e}evaluate(e,i,l,c,d,p){return e.kind==="constant"?e.value:e.evaluate(i,l,c,d,p)}}class wl{constructor(e){this.specification=e}possiblyEvaluate(e,i,l,c){return!!e.expression.evaluate(i,null,{},l,c)}interpolate(){return!1}}class Xi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new si(0,{});for(const l in e){const c=e[l];c.specification.overridable&&this.overridableProperties.push(l);const d=this.defaultPropertyValues[l]=new Nu(c,void 0),p=this.defaultTransitionablePropertyValues[l]=new Ma(c);this.defaultTransitioningPropertyValues[l]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[l]=d.possiblyEvaluate(i)}}}Ft(Ot,"DataDrivenProperty"),Ft(wt,"DataConstantProperty"),Ft(wl,"ColorRampProperty");var Ne=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-wall-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white"},"sky-atmosphere-color":{"type":"color","default":"white"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function cs(o){return o instanceof Number||o instanceof String||o instanceof Boolean?o.valueOf():o}function If(o){if(Array.isArray(o))return o.map(If);if(o instanceof Object&&!(o instanceof Number||o instanceof String||o instanceof Boolean)){const e={};for(const i in o)e[i]=If(o[i]);return e}return cs(o)}function Mf(o){if(o===!0||o===!1)return!0;if(!Array.isArray(o)||o.length===0)return!1;switch(o[0]){case"has":return o.length>=2&&o[1]!=="$id"&&o[1]!=="$type";case"in":return o.length>=3&&(typeof o[1]!="string"||Array.isArray(o[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return o.length!==3||Array.isArray(o[1])||Array.isArray(o[2]);case"any":case"all":for(const e of o.slice(1))if(!Mf(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Vp(o,e="",i=null,l="fill"){if(o==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Mf(o)||(o=Cf(o));const c=o;let d=!0;try{d=function(I){if(!wc(I))return I;let C=If(I);return Bg(C),C=Fg(C),C}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}let p=null,v=null;if(l!=="background"&&l!=="sky"&&l!=="slot"){v=Ne[`filter_${l}`];const I=gc(d,v,e,i);if(I.result==="error")throw new Error(I.value.map(C=>`${C.key}: ${C.message}`).join(", "));p=(C,R,B)=>I.value.evaluate(C,R,{},B)}let w=null,S=null;if(d!==c){const I=gc(c,v,e,i);if(I.result==="error")throw new Error(I.value.map(C=>`${C.key}: ${C.message}`).join(", "));w=(C,R,B,N,$)=>I.value.evaluate(C,R,{},B,void 0,void 0,N,$),S=!Mu(I.value.expression)}return{filter:p,dynamicFilter:w||void 0,needGeometry:Ng(d),needFeature:!!S}}function Fg(o){if(!Array.isArray(o))return o;const e=function(i){if(o1.has(i[0])){for(let l=1;l<i.length;l++)if(wc(i[l]))return!0}return i}(o);return e===!0?e:e.map(i=>Fg(i))}function Bg(o){let e=!1;const i=[];if(o[0]==="case"){for(let l=1;l<o.length-1;l+=2)e=e||wc(o[l]),i.push(o[l+1]);i.push(o[o.length-1])}else if(o[0]==="match"){e=e||wc(o[1]);for(let l=2;l<o.length-1;l+=2)i.push(o[l+1]);i.push(o[o.length-1])}else if(o[0]==="step"){e=e||wc(o[1]);for(let l=1;l<o.length-1;l+=2)i.push(o[l+1])}e&&(o.length=0,o.push("any",...i));for(let l=1;l<o.length;l++)Bg(o[l])}function wc(o){if(!Array.isArray(o))return!1;if((e=o[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<o.length;i++)if(wc(o[i]))return!0;return!1}const o1=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function s1(o,e){return o<e?-1:o>e?1:0}function Ng(o){if(!Array.isArray(o))return!1;if(o[0]==="within"||o[0]==="distance")return!0;for(let e=1;e<o.length;e++)if(Ng(o[e]))return!0;return!1}function Cf(o){if(!o)return!0;const e=o[0];return o.length<=1?e!=="any":e==="=="?Up(o[1],o[2],"=="):e==="!="?Pf(Up(o[1],o[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Up(o[1],o[2],e):e==="any"?(i=o.slice(1),["any"].concat(i.map(Cf))):e==="all"?["all"].concat(o.slice(1).map(Cf)):e==="none"?["all"].concat(o.slice(1).map(Cf).map(Pf)):e==="in"?jp(o[1],o.slice(2)):e==="!in"?Pf(jp(o[1],o.slice(2))):e==="has"?Vg(o[1]):e!=="!has"||Pf(Vg(o[1]));var i}function Up(o,e,i){switch(o){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,o,e]}}function jp(o,e){if(e.length===0)return!1;switch(o){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",o,["literal",e.sort(s1)]]:["filter-in-small",o,["literal",e]]}}function Vg(o){switch(o){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",o]}}function Pf(o){return["!",o]}const Vu="";function Tl(o,e){return e?`${o}${Vu}${e}`:o}const $p="-transition",Ca=new Set(["fill","line","background","hillshade","raster"]);class eo extends sl{constructor(e,i,l,c,d){if(super(),this.id=e.id,this.fqid=Tl(this.id,l),this.type=e.type,this.scope=l,this.lut=c,this.options=d,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const p=gc(this.filter,Ne[`filter_${e.type}`]);p.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...p.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new r1(i.layout,this.scope,d),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new Lg(i.paint,this.scope,d);for(const p in e.paint)this.setPaintProperty(p,e.paint[p]);for(const p in e.layout)this.setLayoutProperty(p,e.layout[p]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new bl(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Ca.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const l=this._unevaluatedLayout;l._properties.properties[e]&&(l.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith($p)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const l=this._transitionablePaint,c=l._properties.properties;if(e.endsWith($p)){const C=e.slice(0,-11);return c[C]&&l.setTransition(C,i||void 0),!1}if(!c[e])return!1;const d=l._values[e],p=d.value.isDataDriven(),v=d.value;l.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const w=l._values[e].value,S=w.isDataDriven(),I=e.endsWith("pattern")||e==="line-dasharray";return S||p||I||this._handleOverridablePaintPropertyUpdate(e,v,w)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,l){return null}_handleOverridablePaintPropertyUpdate(e,i,l){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return An({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof bc&&yf(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Vp(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,l,c,d,p,v,w,S){}}const a1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Uu{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ki{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&(e.isTransferred=!0,i.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Yn(o,e=1){let i=0,l=0;return{members:o.map(c=>{const d=a1[c.type].BYTES_PER_ELEMENT,p=i=Gp(i,Math.max(e,d)),v=c.components||1;return l=Math.max(l,d),i+=d*v,{name:c.name,type:c.type,components:v,offset:p}}),size:Gp(i,Math.max(l,e)),alignment:e}}function Gp(o,e){return Math.ceil(o/e)*e}class Ks extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const c=2*e;return this.int16[c+0]=i,this.int16[c+1]=l,e}}Ks.prototype.bytesPerElement=4,Ft(Ks,"StructArrayLayout2i4");class zf extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,l)}emplace(e,i,l,c){const d=3*e;return this.int16[d+0]=i,this.int16[d+1]=l,this.int16[d+2]=c,e}}zf.prototype.bytesPerElement=6,Ft(zf,"StructArrayLayout3i6");class Sl extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,l,c)}emplace(e,i,l,c,d){const p=4*e;return this.int16[p+0]=i,this.int16[p+1]=l,this.int16[p+2]=c,this.int16[p+3]=d,e}}Sl.prototype.bytesPerElement=8,Ft(Sl,"StructArrayLayout4i8");class Tc extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Tc.prototype.bytesPerElement=4,Ft(Tc,"StructArrayLayout1f4");class Rf extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,l)}emplace(e,i,l,c){const d=4*e,p=2*e;return this.int16[d+0]=i,this.int16[d+1]=l,this.float32[p+1]=c,e}}Rf.prototype.bytesPerElement=8,Ft(Rf,"StructArrayLayout2i1f8");class Sc extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,l)}emplace(e,i,l,c){const d=4*e;return this.int16[d+0]=i,this.int16[d+1]=l,this.int16[d+2]=c,e}}Sc.prototype.bytesPerElement=8,Ft(Sc,"StructArrayLayout3i8");class qp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,c,d)}emplace(e,i,l,c,d,p){const v=5*e;return this.int16[v+0]=i,this.int16[v+1]=l,this.int16[v+2]=c,this.int16[v+3]=d,this.int16[v+4]=p,e}}qp.prototype.bytesPerElement=10,Ft(qp,"StructArrayLayout5i10");class Hp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,c,d,p,v)}emplace(e,i,l,c,d,p,v,w){const S=6*e,I=12*e,C=3*e;return this.int16[S+0]=i,this.int16[S+1]=l,this.uint8[I+4]=c,this.uint8[I+5]=d,this.uint8[I+6]=p,this.uint8[I+7]=v,this.float32[C+2]=w,e}}Hp.prototype.bytesPerElement=12,Ft(Hp,"StructArrayLayout2i4ub1f12");class As extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,l)}emplace(e,i,l,c){const d=3*e;return this.float32[d+0]=i,this.float32[d+1]=l,this.float32[d+2]=c,e}}As.prototype.bytesPerElement=12,Ft(As,"StructArrayLayout3f12");class Js extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,c,d)}emplace(e,i,l,c,d,p){const v=6*e,w=3*e;return this.uint16[v+0]=i,this.uint16[v+1]=l,this.uint16[v+2]=c,this.uint16[v+3]=d,this.float32[w+2]=p,e}}Js.prototype.bytesPerElement=12,Ft(Js,"StructArrayLayout4ui1f12");class Df extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,l,c)}emplace(e,i,l,c,d){const p=4*e;return this.uint16[p+0]=i,this.uint16[p+1]=l,this.uint16[p+2]=c,this.uint16[p+3]=d,e}}Df.prototype.bytesPerElement=8,Ft(Df,"StructArrayLayout4ui8");class El extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,l,c,d,p)}emplace(e,i,l,c,d,p,v){const w=6*e;return this.int16[w+0]=i,this.int16[w+1]=l,this.int16[w+2]=c,this.int16[w+3]=d,this.int16[w+4]=p,this.int16[w+5]=v,e}}El.prototype.bytesPerElement=12,Ft(El,"StructArrayLayout6i12");class Ec extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C,R){const B=this.length;return this.resize(B+1),this.emplace(B,e,i,l,c,d,p,v,w,S,I,C,R)}emplace(e,i,l,c,d,p,v,w,S,I,C,R,B){const N=12*e;return this.int16[N+0]=i,this.int16[N+1]=l,this.int16[N+2]=c,this.int16[N+3]=d,this.uint16[N+4]=p,this.uint16[N+5]=v,this.uint16[N+6]=w,this.uint16[N+7]=S,this.int16[N+8]=I,this.int16[N+9]=C,this.int16[N+10]=R,this.int16[N+11]=B,e}}Ec.prototype.bytesPerElement=24,Ft(Ec,"StructArrayLayout4i4ui4i24");class ho extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,l,c,d,p)}emplace(e,i,l,c,d,p,v){const w=10*e,S=5*e;return this.int16[w+0]=i,this.int16[w+1]=l,this.int16[w+2]=c,this.float32[S+2]=d,this.float32[S+3]=p,this.float32[S+4]=v,e}}ho.prototype.bytesPerElement=20,Ft(ho,"StructArrayLayout3i3f20");class Is extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,l,c)}emplace(e,i,l,c,d){const p=4*e;return this.float32[p+0]=i,this.float32[p+1]=l,this.float32[p+2]=c,this.float32[p+3]=d,e}}Is.prototype.bytesPerElement=16,Ft(Is,"StructArrayLayout4f16");class Zp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}Zp.prototype.bytesPerElement=4,Ft(Zp,"StructArrayLayout1ul4");class Pa extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const c=2*e;return this.uint16[c+0]=i,this.uint16[c+1]=l,e}}Pa.prototype.bytesPerElement=4,Ft(Pa,"StructArrayLayout2ui4");class Wp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C,R,B){const N=this.length;return this.resize(N+1),this.emplace(N,e,i,l,c,d,p,v,w,S,I,C,R,B)}emplace(e,i,l,c,d,p,v,w,S,I,C,R,B,N){const $=20*e,X=10*e;return this.int16[$+0]=i,this.int16[$+1]=l,this.int16[$+2]=c,this.int16[$+3]=d,this.int16[$+4]=p,this.float32[X+3]=v,this.float32[X+4]=w,this.float32[X+5]=S,this.float32[X+6]=I,this.int16[$+14]=C,this.uint32[X+8]=R,this.uint16[$+18]=B,this.uint16[$+19]=N,e}}Wp.prototype.bytesPerElement=40,Ft(Wp,"StructArrayLayout5i4f1i1ul2ui40");class Lf extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,c,d,p,v)}emplace(e,i,l,c,d,p,v,w){const S=8*e;return this.int16[S+0]=i,this.int16[S+1]=l,this.int16[S+2]=c,this.int16[S+4]=d,this.int16[S+5]=p,this.int16[S+6]=v,this.int16[S+7]=w,e}}Lf.prototype.bytesPerElement=16,Ft(Lf,"StructArrayLayout3i2i2i16");class ju extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,c,d)}emplace(e,i,l,c,d,p){const v=4*e,w=8*e;return this.float32[v+0]=i,this.float32[v+1]=l,this.float32[v+2]=c,this.int16[w+6]=d,this.int16[w+7]=p,e}}ju.prototype.bytesPerElement=16,Ft(ju,"StructArrayLayout2f1f2i16");class Xp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,l,c,d,p)}emplace(e,i,l,c,d,p,v){const w=20*e,S=5*e;return this.uint8[w+0]=i,this.uint8[w+1]=l,this.float32[S+1]=c,this.float32[S+2]=d,this.float32[S+3]=p,this.float32[S+4]=v,e}}Xp.prototype.bytesPerElement=20,Ft(Xp,"StructArrayLayout2ub4f20");class wr extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,l)}emplace(e,i,l,c){const d=3*e;return this.uint16[d+0]=i,this.uint16[d+1]=l,this.uint16[d+2]=c,e}}wr.prototype.bytesPerElement=6,Ft(wr,"StructArrayLayout3ui6");class Yp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne){const ae=this.length;return this.resize(ae+1),this.emplace(ae,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne)}emplace(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne,ae){const de=30*e,be=15*e,Ie=60*e;return this.int16[de+0]=i,this.int16[de+1]=l,this.int16[de+2]=c,this.float32[be+2]=d,this.float32[be+3]=p,this.uint16[de+8]=v,this.uint16[de+9]=w,this.uint32[be+5]=S,this.uint32[be+6]=I,this.uint32[be+7]=C,this.uint16[de+16]=R,this.uint16[de+17]=B,this.uint16[de+18]=N,this.float32[be+10]=$,this.float32[be+11]=X,this.uint8[Ie+48]=K,this.uint8[Ie+49]=le,this.uint8[Ie+50]=re,this.uint32[be+13]=G,this.int16[de+28]=ne,this.uint8[Ie+58]=ae,e}}Yp.prototype.bytesPerElement=60,Ft(Yp,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Kp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne,ae,de,be,Ie,Me,ke,Ye,ft,at,ht,_t,We){const ct=this.length;return this.resize(ct+1),this.emplace(ct,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne,ae,de,be,Ie,Me,ke,Ye,ft,at,ht,_t,We)}emplace(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re,G,ne,ae,de,be,Ie,Me,ke,Ye,ft,at,ht,_t,We,ct){const Ge=20*e,Xe=40*e,yt=80*e;return this.float32[Ge+0]=i,this.float32[Ge+1]=l,this.int16[Xe+4]=c,this.int16[Xe+5]=d,this.int16[Xe+6]=p,this.int16[Xe+7]=v,this.int16[Xe+8]=w,this.int16[Xe+9]=S,this.int16[Xe+10]=I,this.int16[Xe+11]=C,this.int16[Xe+12]=R,this.uint16[Xe+13]=B,this.uint16[Xe+14]=N,this.uint16[Xe+15]=$,this.uint16[Xe+16]=X,this.uint16[Xe+17]=K,this.uint16[Xe+18]=le,this.uint16[Xe+19]=re,this.uint16[Xe+20]=G,this.uint16[Xe+21]=ne,this.uint16[Xe+22]=ae,this.uint16[Xe+23]=de,this.uint16[Xe+24]=be,this.uint16[Xe+25]=Ie,this.uint16[Xe+26]=Me,this.uint16[Xe+27]=ke,this.uint32[Ge+14]=Ye,this.float32[Ge+15]=ft,this.float32[Ge+16]=at,this.float32[Ge+17]=ht,this.float32[Ge+18]=_t,this.uint8[yt+76]=We,this.uint16[Xe+39]=ct,e}}Kp.prototype.bytesPerElement=80,Ft(Kp,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class za extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,c,d)}emplace(e,i,l,c,d,p){const v=5*e;return this.float32[v+0]=i,this.float32[v+1]=l,this.float32[v+2]=c,this.float32[v+3]=d,this.float32[v+4]=p,e}}za.prototype.bytesPerElement=20,Ft(za,"StructArrayLayout5f20");class $u extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,c,d,p,v)}emplace(e,i,l,c,d,p,v,w){const S=7*e;return this.float32[S+0]=i,this.float32[S+1]=l,this.float32[S+2]=c,this.float32[S+3]=d,this.float32[S+4]=p,this.float32[S+5]=v,this.float32[S+6]=w,e}}$u.prototype.bytesPerElement=28,Ft($u,"StructArrayLayout7f28");class Jp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C){const R=this.length;return this.resize(R+1),this.emplace(R,e,i,l,c,d,p,v,w,S,I,C)}emplace(e,i,l,c,d,p,v,w,S,I,C,R){const B=11*e;return this.float32[B+0]=i,this.float32[B+1]=l,this.float32[B+2]=c,this.float32[B+3]=d,this.float32[B+4]=p,this.float32[B+5]=v,this.float32[B+6]=w,this.float32[B+7]=S,this.float32[B+8]=I,this.float32[B+9]=C,this.float32[B+10]=R,e}}Jp.prototype.bytesPerElement=44,Ft(Jp,"StructArrayLayout11f44");class kf extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S){const I=this.length;return this.resize(I+1),this.emplace(I,e,i,l,c,d,p,v,w,S)}emplace(e,i,l,c,d,p,v,w,S,I){const C=9*e;return this.float32[C+0]=i,this.float32[C+1]=l,this.float32[C+2]=c,this.float32[C+3]=d,this.float32[C+4]=p,this.float32[C+5]=v,this.float32[C+6]=w,this.float32[C+7]=S,this.float32[C+8]=I,e}}kf.prototype.bytesPerElement=36,Ft(kf,"StructArrayLayout9f36");class Al extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const c=2*e;return this.float32[c+0]=i,this.float32[c+1]=l,e}}Al.prototype.bytesPerElement=8,Ft(Al,"StructArrayLayout2f8");class Qp extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,c){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,l,c)}emplace(e,i,l,c,d){const p=6*e;return this.uint32[3*e+0]=i,this.uint16[p+2]=l,this.uint16[p+3]=c,this.uint16[p+4]=d,e}}Qp.prototype.bytesPerElement=12,Ft(Qp,"StructArrayLayout1ul3ui12");class Gu extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Gu.prototype.bytesPerElement=2,Ft(Gu,"StructArrayLayout1ui2");class Ac extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X){const K=this.length;return this.resize(K+1),this.emplace(K,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X)}emplace(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K){const le=16*e;return this.float32[le+0]=i,this.float32[le+1]=l,this.float32[le+2]=c,this.float32[le+3]=d,this.float32[le+4]=p,this.float32[le+5]=v,this.float32[le+6]=w,this.float32[le+7]=S,this.float32[le+8]=I,this.float32[le+9]=C,this.float32[le+10]=R,this.float32[le+11]=B,this.float32[le+12]=N,this.float32[le+13]=$,this.float32[le+14]=X,this.float32[le+15]=K,e}}Ac.prototype.bytesPerElement=64,Ft(Ac,"StructArrayLayout16f64");class qu extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,c,d,p,v){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,c,d,p,v)}emplace(e,i,l,c,d,p,v,w){const S=10*e,I=5*e;return this.uint16[S+0]=i,this.uint16[S+1]=l,this.uint16[S+2]=c,this.uint16[S+3]=d,this.float32[I+2]=p,this.float32[I+3]=v,this.float32[I+4]=w,e}}qu.prototype.bytesPerElement=20,Ft(qu,"StructArrayLayout4ui3f20");class em extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}em.prototype.bytesPerElement=2,Ft(em,"StructArrayLayout1i2");class Of extends ki{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Of.prototype.bytesPerElement=1,Ft(Of,"StructArrayLayout1ub1");class Ug extends Uu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Ug.prototype.size=40;class Ff extends Wp{get(e){return new Ug(this,e)}}Ft(Ff,"CollisionBoxArray");class jg extends Uu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}jg.prototype.size=60;class $g extends Yp{get(e){return new jg(this,e)}}Ft($g,"PlacedSymbolArray");class Gg extends Uu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Gg.prototype.size=80;class qg extends Kp{get(e){return new Gg(this,e)}}Ft(qg,"SymbolInstanceArray");class tm extends Tc{getoffsetX(e){return this.float32[1*e+0]}}Ft(tm,"GlyphOffsetArray");class Hg extends Ks{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Ft(Hg,"SymbolLineVertexArray");class Zg extends Uu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Zg.prototype.size=12;class Wg extends Qp{get(e){return new Zg(this,e)}}Ft(Wg,"FeatureIndexArray");class Xg extends Pa{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Ft(Xg,"FillExtrusionCentroidArray");class Yg extends Uu{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Yg.prototype.size=6;class Kg extends zf{get(e){return new Yg(this,e)}}Ft(Kg,"FillExtrusionWallArray");const l1=Yn([{name:"a_pos",components:2,type:"Int16"}],4),c1=Yn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ui{constructor(e=[]){this.segments=e}_prepareSegment(e,i,l,c){let d=this.segments[this.segments.length-1];return e>Ui.MAX_VERTEX_ARRAY_LENGTH&&Dn(`Max vertices per segment is ${Ui.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!d||d.vertexLength+e>Ui.MAX_VERTEX_ARRAY_LENGTH||d.sortKey!==c)&&(d={vertexOffset:i,primitiveOffset:l,vertexLength:0,primitiveLength:0},c!==void 0&&(d.sortKey=c),this.segments.push(d)),d}prepareSegment(e,i,l,c){return this._prepareSegment(e,i.length,l.length,c)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,l,c){return new Ui([{vertexOffset:e,primitiveOffset:i,vertexLength:l,primitiveLength:c,vaos:{},sortKey:0}])}}function Jg(o,e){return 256*(o=ze(Math.floor(o),0,255))+ze(Math.floor(e),0,255)}Ui.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ft(Ui,"SegmentVector");const u1=Yn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Ic=Yn([{name:"a_pattern_b",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),h1=Yn([{name:"a_dash",components:4,type:"Uint16"}]);class Mc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,l,c){this.ids.push(Qg(e)),this.positions.push(i,l,c)}eachPosition(e,i){const l=Qg(e);let c=0,d=this.ids.length-1;for(;c<d;){const p=c+d>>1;this.ids[p]>=l?d=p:c=p+1}for(;this.ids[c]===l;)i(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(e,i){const l=new Float64Array(e.ids),c=new Uint32Array(e.positions);return Bf(l,c,0,l.length-1),i&&(i.add(l.buffer),i.add(c.buffer)),{ids:l,positions:c}}static deserialize(e){const i=new Mc;let l;i.ids=e.ids,i.positions=e.positions;for(const c of i.ids)c!==l&&i.uniqueIds.push(c),l=c;return i.indexed=!0,i}}function Qg(o){const e=+o;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:mo(String(o))}function Bf(o,e,i,l){for(;i<l;){const c=o[i+l>>1];let d=i-1,p=l+1;for(;;){do d++;while(o[d]<c);do p--;while(o[p]>c);if(d>=p)break;Hu(o,d,p),Hu(e,3*d,3*p),Hu(e,3*d+1,3*p+1),Hu(e,3*d+2,3*p+2)}p-i<l-p?(Bf(o,e,i,p),i=p+1):(Bf(o,e,p+1,l),l=p)}}function Hu(o,e,i){const l=o[e];o[e]=o[i],o[i]=l}Ft(Mc,"FeaturePositionMap");class Ms{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,l){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Nf extends Ms{constructor(e){super(e),this.current=0}set(e,i,l){this.fetchUniformLocation(e,i)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}}class ir extends Ms{constructor(e){super(e),this.current=0}set(e,i,l){this.fetchUniformLocation(e,i)&&this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class us extends Ms{constructor(e){super(e),this.current=[0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}}class Zu extends Ms{constructor(e){super(e),this.current=[0,0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}}class Vf extends Ms{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3])))}}class e0 extends Ms{constructor(e){super(e),this.current=Kn.transparent.toRenderColor(null)}set(e,i,l){this.fetchUniformLocation(e,i)&&(l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a)))}}const f1=new Float32Array(16);class Wu extends Ms{constructor(e){super(e),this.current=f1}set(e,i,l){if(this.fetchUniformLocation(e,i)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let c=1;c<16;c++)if(l[c]!==this.current[c]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}}const t0=new Float32Array(9),nm=new Float32Array(4);class Ko extends Ms{constructor(e){super(e),this.current=nm}set(e,i,l){if(this.fetchUniformLocation(e,i)){for(let c=0;c<4;c++)if(l[c]!==this.current[c]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}}function Xu(o){return[Jg(255*o.r,255*o.g),Jg(255*o.b,255*o.a)]}class Yu{constructor(e,i,l,c){this.value=e,this.uniformNames=i.map(d=>`u_${d}`),this.type=l,this.context=c}setUniform(e,i,l,c,d){const p=c.constantOr(this.value);i.set(e,d,p instanceof Kn?p.toRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):p)}getBinding(e,i){return this.type==="color"?new e0(e):new ir(e)}}class Cc{constructor(e,i){this.uniformNames=i.map(l=>`u_${l}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,l,c,d){let p=null;d!=="u_pattern"&&d!=="u_dash"||(p=this.pattern),d==="u_pattern_b"&&(p=this.patternTransition),d==="u_pixel_ratio"&&(p=this.pixelRatio),p&&i.set(e,d,p)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Vf(e):new ir(e)}}class Qs{constructor(e,i,l,c){this.expression=e,this.type=l,this.maxValue=0,this.paintVertexAttributes=i.map(d=>({name:`a_${d}`,type:"Float32",components:l==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(e,i,l,c,d,p,v){const w=this.paintVertexArray.length,S=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new si(0,{brightness:p}),i,{},d,c,v):this.expression.kind==="constant"&&this.expression.value,I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new si(0,{brightness:p}),i,{},d,c,v):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(w,e,S,I?null:this.context.lut)}updatePaintArray(e,i,l,c,d,p,v){const w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:v},l,c,void 0,d):this.expression.kind==="constant"&&this.expression.value,S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new si(0,{brightness:v}),l,c,void 0,d):this.lutExpression.value)==="none";this._setPaintValue(e,i,w,S?null:this.context.lut)}_setPaintValue(e,i,l,c){if(this.type==="color"){const d=Xu(l.toRenderColor(c));for(let p=e;p<i;p++)this.paintVertexArray.emplace(p,d[0],d[1])}else{for(let d=e;d<i;d++)this.paintVertexArray.emplace(d,l);this.maxValue=Math.max(this.maxValue,Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class hs{constructor(e,i,l,c,d,p){this.expression=e,this.uniformNames=i.map(v=>`u_${v}_t`),this.type=l,this.useIntegerZoom=c,this.context=d,this.maxValue=0,this.paintVertexAttributes=i.map(v=>({name:`a_${v}`,type:"Float32",components:l==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,i,l,c,d,p,v){const w=this.expression.evaluate(new si(this.context.zoom,{brightness:p}),i,{},d,c,v),S=this.expression.evaluate(new si(this.context.zoom+1,{brightness:p}),i,{},d,c,v),I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new si(0,{brightness:p}),i,{},d,c,v):this.lutExpression.value)==="none",C=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(C,e,w,S,I?null:this.context.lut)}updatePaintArray(e,i,l,c,d,p,v){const w=this.expression.evaluate({zoom:this.context.zoom,brightness:v},l,c,void 0,d),S=this.expression.evaluate({zoom:this.context.zoom+1,brightness:v},l,c,void 0,d),I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new si(0,{brightness:v}),l,c,void 0,d):this.lutExpression.value)==="none";this._setPaintValue(e,i,w,S,I?null:this.context.lut)}_setPaintValue(e,i,l,c,d){if(this.type==="color"){const p=Xu(l.toRenderColor(d)),v=Xu(l.toRenderColor(d));for(let w=e;w<i;w++)this.paintVertexArray.emplace(w,p[0],p[1],v[0],v[1])}else{for(let p=e;p<i;p++)this.paintVertexArray.emplace(p,l,c);this.maxValue=Math.max(this.maxValue,Math.abs(l),Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,l,c,d){const p=this.useIntegerZoom?Math.floor(l.zoom):l.zoom,v=ze(this.expression.interpolationFactor(p,this.context.zoom,this.context.zoom+1),0,1);i.set(e,d,v)}getBinding(e,i){return new ir(e)}}class fs{constructor(e,i,l,c,d){this.expression=e,this.layerId=d,this.paintVertexAttributes=(l==="array"?h1:u1).members;for(let p=0;p<i.length;++p);this.paintVertexArray=new c,this.paintTransitionVertexArray=new Js}populatePaintArray(e,i,l,c){const d=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(d,e,i.patterns&&i.patterns[this.layerId],l)}updatePaintArray(e,i,l,c,d,p,v){this._setPaintValues(e,i,l.patterns&&l.patterns[this.layerId],p)}_setPaintValues(e,i,l,c){if(!c||!l)return;const d=c[l[0]],p=c[l[1]];if(d){if(d){const{tl:v,br:w,pixelRatio:S}=d;for(let I=e;I<i;I++)this.paintVertexArray.emplace(I,v[0],v[1],w[0],w[1],S)}if(p){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:v,br:w,pixelRatio:S}=p;for(let I=e;I<i;I++)this.paintTransitionVertexArray.emplace(I,v[0],v[1],w[0],w[1],S)}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Ic.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Ra{constructor(e,i,l=()=>!0){this.binders={},this._buffers=[],this.context=i;const c=[];for(const d in e.paint._values){const p=e.paint.get(d);if(d.endsWith("-use-theme")||!l(d)||!(p instanceof bc&&yf(p.property.specification)))continue;const v=t(d,e.type),w=p.value,S=p.property.specification.type,I=!!p.property.useIntegerZoom,C=d==="line-dasharray"||d.endsWith("pattern"),R=e.paint.get(`${d}-use-theme`),B=d==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||R&&R.value.kind!=="constant";if(w.kind!=="constant"||B)if(w.kind==="source"||B||C){const N=_(d,S,"source");this.binders[d]=C?new fs(w,v,S,N,e.id):new Qs(w,v,S,N),c.push(`/a_${d}`)}else{const N=_(d,S,"composite");this.binders[d]=new hs(w,v,S,I,i,N),c.push(`/z_${d}`)}else this.binders[d]=C?new Cc(w.value,v):new Yu(w.value,v,S,i),c.push(`/u_${d}`);R&&(this.binders[d].lutExpression=R.value)}this.cacheKey=c.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Qs||i instanceof hs?i.maxValue:0}populatePaintArrays(e,i,l,c,d,p,v){for(const w in this.binders){const S=this.binders[w];S.context=this.context,(S instanceof Qs||S instanceof hs||S instanceof fs)&&S.populatePaintArray(e,i,l,c,d,p,v)}}setConstantPatternPositions(e,i){for(const l in this.binders){const c=this.binders[l];c instanceof Cc&&c.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof fs?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,l,c,d,p,v,w,S){let I=!1;const C=Object.keys(e),R=C.length!==0&&!w,B=R?C:i.uniqueIds;this.context.lut=d.lut;for(const N in this.binders){const $=this.binders[N];if($.context=this.context,($ instanceof Qs||$ instanceof hs||$ instanceof fs)&&$.expression&&$.expression.kind&&$.expression.kind!=="constant"&&($.expression.isStateDependent===!0||$.expression.isLightConstant===!1)){const X=d.paint.get(N);$.expression=X.value;for(const K of B){const le=e[K.toString()];i.eachPosition(K,(re,G,ne)=>{const ae=c.feature(re);$.updatePaintArray(G,ne,ae,le,p,v,S)})}if(!R)for(const K of l.uniqueIds){const le=e[K.toString()];l.eachPosition(K,(re,G,ne)=>{const ae=c.feature(re);$.updatePaintArray(G,ne,ae,le,p,v,S)})}I=!0}}return I}defines(){const e=[];for(const i in this.binders){const l=this.binders[i];(l instanceof Yu||l instanceof Cc)&&e.push(...l.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const l=this.binders[i];if(l instanceof Qs||l instanceof hs||l instanceof fs)for(let c=0;c<l.paintVertexAttributes.length;c++)e.push(l.paintVertexAttributes[c].name);if(l instanceof fs)for(let c=0;c<Ic.members.length;c++)e.push(Ic.members[c].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const l=this.binders[i];if(l instanceof Yu||l instanceof Cc||l instanceof hs)for(const c of l.uniformNames)e.push(c)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const l in this.binders){const c=this.binders[l];if(c instanceof Yu||c instanceof Cc||c instanceof hs)for(const d of c.uniformNames)i.push({name:d,property:l,binding:c.getBinding(e,d)})}return i}setUniforms(e,i,l,c,d){for(const{name:p,property:v,binding:w}of l)this.binders[v].setUniform(e,w,d,c.get(v),p)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Qs||i instanceof hs||i instanceof fs)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof fs&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const l=this.binders[i];(l instanceof Qs||l instanceof hs||l instanceof fs)&&l.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Qs||i instanceof hs||i instanceof fs)&&i.destroy()}}}class Il{constructor(e,i,l=()=>!0){this.programConfigurations={};for(const c of e)this.programConfigurations[c.id]=new Ra(c,i,l);this.needsUpload=!1,this._featureMap=new Mc,this._featureMapWithoutIds=new Mc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,l,c,d,p,v,w){for(const S in this.programConfigurations)this.programConfigurations[S].populatePaintArrays(e,i,c,d,p,v,w);i.id!==void 0?this._featureMap.add(i.id,l,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,l,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,l,c,d,p,v){for(const w of l)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,w,c,d,p,v||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const h={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"]};function t(o,e){return h[o]||[o.replace(`${e}-`,"").replace(/-/g,"_")]}const s={"line-pattern":{source:Js,composite:Js},"fill-pattern":{source:Js,composite:Js},"fill-extrusion-pattern":{source:Js,composite:Js},"line-dasharray":{source:Df,composite:Df}},f={color:{source:Al,composite:Is},number:{source:Tc,composite:Al}};function _(o,e,i){const l=s[o];return l&&l[i]||f[e][i]}Ft(Yu,"ConstantBinder"),Ft(Cc,"PatternConstantBinder"),Ft(Qs,"SourceExpressionBinder"),Ft(fs,"PatternCompositeBinder"),Ft(hs,"CompositeExpressionBinder"),Ft(Ra,"ProgramConfiguration",{omit:["_buffers"]}),Ft(Il,"ProgramConfigurationSet");const g=At/Math.PI/2,b=5,T=6,A=16383,z=64,D=[z,32,16],F=-g,O=g;function U(o,e,i,l=g){return i=W(i),[o*Math.sin(i)*l,-e*l,o*Math.cos(i)*l]}function H(o,e,i){return U(Math.cos(W(o)),Math.sin(W(o)),e,i)}const q=63710088e-1,Y=2*Math.PI*q;class Z{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Z(He(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,l=this.lat*i,c=e.lat*i,d=Math.sin(l)*Math.sin(c)+Math.cos(l)*Math.cos(c)*Math.cos((e.lng-this.lng)*i);return q*Math.acos(Math.min(d,1))}toBounds(e=0){const i=360*e/40075017,l=i/Math.cos(Math.PI/180*this.lat);return new oe({lng:this.lng-l,lat:this.lat-i},{lng:this.lng+l,lat:this.lat+i})}toEcef(e){return H(this.lat,this.lng,g+e*g/q)}static convert(e){if(e instanceof Z)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Z(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Z(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class oe{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const l=e;this.setSouthWest([l[0],l[1]]).setNorthEast([l[2],l[3]])}else{const l=e;this.setSouthWest(l[0]).setNorthEast(l[1])}}setNorthEast(e){return this._ne=e instanceof Z?new Z(e.lng,e.lat):Z.convert(e),this}setSouthWest(e){return this._sw=e instanceof Z?new Z(e.lng,e.lat):Z.convert(e),this}extend(e){const i=this._sw,l=this._ne;let c,d;if(e instanceof Z)c=e,d=e;else{if(!(e instanceof oe))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(oe.convert(e)):this.extend(Z.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Z.convert(e)):this;if(c=e._sw,d=e._ne,!c||!d)return this}return i||l?(i.lng=Math.min(c.lng,i.lng),i.lat=Math.min(c.lat,i.lat),l.lng=Math.max(d.lng,l.lng),l.lat=Math.max(d.lat,l.lat)):(this._sw=new Z(c.lng,c.lat),this._ne=new Z(d.lng,d.lat)),this}getCenter(){return new Z((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Z(this.getWest(),this.getNorth())}getSouthEast(){return new Z(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:l}=Z.convert(e);let c=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&c}static convert(e){if(e)return e instanceof oe?e:new oe(e)}}const fe=0,me=25.5;function xe(o){return Y*Math.cos(o*Math.PI/180)}function ye(o){return(180+o)/360}function ve(o){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+o*Math.PI/360)))/360}function _e(o,e){return o/xe(e)}function we(o){return 360*o-180}function Te(o){return 360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90}function Ue(o,e){return o*xe(Te(e))}const Fe=85.051129;function ot(o){return Math.cos(W(ze(o,-85.051129,Fe)))}function et(o,e){const i=ze(e,fe,me),l=Math.pow(2,i);return ot(o)*Y/(512*l)}function xt(o){return 1/Math.cos(o*Math.PI/180)}function Oe(o,e=0){const i=Math.exp(Math.PI*(1-(o.y+e/At)/(1<<o.z)*2));return 80150034*i/(i*i+1)/At/(1<<o.z)}class je{constructor(e,i,l=0){this.x=+e,this.y=+i,this.z=+l}static fromLngLat(e,i=0){const l=Z.convert(e);return new je(ye(l.lng),ve(l.lat),_e(i,l.lat))}toLngLat(){return new Z(we(this.x),Te(this.y))}toAltitude(){return Ue(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Y*xt(Te(this.y))}}function Le(o,e,i,l,c,d,p,v,w){const S=(e+l)/2,I=(i+c)/2,C=new St(S,I);v(C),function(R,B,N,$,X,K){const le=N-X,re=$-K;return Math.abs(($-B)*le-(N-R)*re)/Math.hypot(le,re)}(C.x,C.y,d.x,d.y,p.x,p.y)>=w?(Le(o,e,i,S,I,d,C,v,w),Le(o,S,I,l,c,C,p,v,w)):o.push(p)}function lt(o,e,i){let l=o[0],c=l.x,d=l.y;e(l);const p=[l];for(let v=1;v<o.length;v++){const w=o[v],{x:S,y:I}=w;e(w),Le(p,c,d,S,I,l,w,e,i),c=S,d=I,l=w}return p}function Ze(o,e,i,l){if(l(e,i)){const c=e.add(i)._mult(.5);Ze(o,e,c,l),Ze(o,c,i,l)}else o.push(i)}function dt(o,e){let i=o[0];const l=[i];for(let c=1;c<o.length;c++){const d=o[c];Ze(l,i,d,e),i=d}return l}const st=Math.pow(2,14)-1,pt=-st-1;function mt(o,e){const i=Math.round(o.x*e),l=Math.round(o.y*e);return o.x=ze(i,pt,st),o.y=ze(l,pt,st),(i<o.x||i>o.x+1||l<o.y||l>o.y+1)&&Dn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),o}function Vt(o,e,i){const l=o.loadGeometry(),c=o.extent,d=At/c;if(e&&i&&i.projection.isReprojectedInTileSpace){const p=1<<e.z,{scale:v,x:w,y:S,projection:I}=i,C=R=>{const B=we((e.x+R.x/c)/p),N=Te((e.y+R.y/c)/p),$=I.project(B,N);R.x=($.x*v-w)*c,R.y=($.y*v-S)*c};for(let R=0;R<l.length;R++)if(o.type!==1)l[R]=lt(l[R],C,1);else{const B=[];for(const N of l[R])N.x<0||N.x>=c||N.y<0||N.y>=c||(C(N),B.push(N));l[R]=B}}for(const p of l)for(const v of p)mt(v,d);return l}function Xt(o,e){return{type:o.type,id:o.id,properties:o.properties,geometry:e?Vt(o):[]}}function Bt(o,e,i,l,c){o.emplaceBack(2*e+(l+1)/2,2*i+(c+1)/2)}function Yt(o,e,i){o.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class jt{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ks,this.indexArray=new wr,this.segments=new Ui,this.programConfigurations=new Il(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}updateFootprints(e,i){}populate(e,i,l,c){const d=this.layers[0],p=[];let v=null;d.type==="circle"&&(v=d.layout.get("circle-sort-key"));for(const{feature:S,id:I,index:C,sourceLayerIndex:R}of e){const B=this.layers[0]._featureFilter.needGeometry,N=Xt(S,B);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),N,l))continue;const $=v?v.evaluate(N,{},l):void 0,X={id:I,properties:S.properties,type:S.type,sourceLayerIndex:R,index:C,geometry:B?N.geometry:Vt(S,l,c),patterns:{},sortKey:$};p.push(X)}v&&p.sort((S,I)=>S.sortKey-I.sortKey);let w=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new El,w=c.projection);for(const S of p){const{geometry:I,index:C,sourceLayerIndex:R}=S,B=e[C].feature;this.addFeature(S,I,C,i.availableImages,l,w,i.brightness),i.featureIndex.insert(B,I,C,R,this.index)}}update(e,i,l,c,d,p,v){this.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,l1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,c1.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,i,l,c,d,p,v){for(const w of i)for(const S of w){const I=S.x,C=S.y;if(I<0||I>=At||C<0||C>=At)continue;if(p){const N=p.projectTilePoint(I,C,d),$=p.upVector(d,I,C),X=this.globeExtVertexArray;Yt(X,N,$),Yt(X,N,$),Yt(X,N,$),Yt(X,N,$)}const R=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),B=R.vertexLength;Bt(this.layoutVertexArray,I,C,-1,-1),Bt(this.layoutVertexArray,I,C,1,-1),Bt(this.layoutVertexArray,I,C,1,1),Bt(this.layoutVertexArray,I,C,-1,1),this.indexArray.emplaceBack(B,B+1,B+2),this.indexArray.emplaceBack(B,B+2,B+3),R.vertexLength+=4,R.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,{},c,d,v)}}function en(o,e){for(let i=0;i<o.length;i++)if(li(e,o[i]))return!0;for(let i=0;i<e.length;i++)if(li(o,e[i]))return!0;return!!ii(o,e)}function cn(o,e,i){return!!li(o,e)||!!pn(e,o,i)}function Rn(o,e){if(o.length===1)return Zn(e,o[0]);for(let i=0;i<e.length;i++){const l=e[i];for(let c=0;c<l.length;c++)if(li(o,l[c]))return!0}for(let i=0;i<o.length;i++)if(Zn(e,o[i]))return!0;for(let i=0;i<e.length;i++)if(ii(o,e[i]))return!0;return!1}function ai(o,e,i){if(o.length>1){if(ii(o,e))return!0;for(let l=0;l<e.length;l++)if(pn(e[l],o,i))return!0}for(let l=0;l<o.length;l++)if(pn(o[l],e,i))return!0;return!1}function ii(o,e){if(o.length===0||e.length===0)return!1;for(let i=0;i<o.length-1;i++){const l=o[i],c=o[i+1];for(let d=0;d<e.length-1;d++)if(Ln(l,c,e[d],e[d+1]))return!0}return!1}function Ln(o,e,i,l){return _i(o,i,l)!==_i(e,i,l)&&_i(o,e,i)!==_i(o,e,l)}function Zi(o,e,i){return(o.x-i.x)*(e.y-i.y)-(o.y-i.y)*(e.x-i.x)}function Ni(o,e,i,l){const c=Zi(o,e,l),d=Zi(o,e,i);if(Math.sign(c)===Math.sign(d))return;const p=Zi(i,l,o),v=p+d-c;return Math.sign(p)!==Math.sign(v)?[p/(p-v),d/(d-c)]:void 0}function pn(o,e,i){const l=i*i;if(e.length===1)return o.distSqr(e[0])<l;for(let c=1;c<e.length;c++)if(Vn(o,e[c-1],e[c])<l)return!0;return!1}function Vn(o,e,i){const l=e.distSqr(i);if(l===0)return o.distSqr(e);const c=((o.x-e.x)*(i.x-e.x)+(o.y-e.y)*(i.y-e.y))/l;return o.distSqr(c<0?e:c>1?i:i.sub(e)._mult(c)._add(e))}function Zn(o,e){let i,l,c,d=!1;for(let p=0;p<o.length;p++){i=o[p];for(let v=0,w=i.length-1;v<i.length;w=v++)l=i[v],c=i[w],l.y>e.y!=c.y>e.y&&e.x<(c.x-l.x)*(e.y-l.y)/(c.y-l.y)+l.x&&(d=!d)}return d}function li(o,e){let i=!1;for(let l=0,c=o.length-1;l<o.length;c=l++){const d=o[l],p=o[c];d.y>e.y!=p.y>e.y&&e.x<(p.x-d.x)*(e.y-d.y)/(p.y-d.y)+d.x&&(i=!i)}return i}function or(o,e,i,l,c){for(const p of o)if(e<=p.x&&i<=p.y&&l>=p.x&&c>=p.y)return!0;const d=[new St(e,i),new St(e,c),new St(l,c),new St(l,i)];if(o.length>2){for(const p of d)if(li(o,p))return!0}for(let p=0;p<o.length-1;p++)if(Yi(o[p],o[p+1],d))return!0;return!1}function Yi(o,e,i){const l=i[0],c=i[2];if(o.x<l.x&&e.x<l.x||o.x>c.x&&e.x>c.x||o.y<l.y&&e.y<l.y||o.y>c.y&&e.y>c.y)return!1;const d=_i(o,e,i[0]);return d!==_i(o,e,i[1])||d!==_i(o,e,i[2])||d!==_i(o,e,i[3])}function rr(o,e,i,l,c,d){let p=e.y-o.y,v=o.x-e.x;if(d=d||0){const w=p*p+v*v;if(w===0)return!0;const S=Math.sqrt(w);p/=S,v/=S}return!((i.x-o.x)*p+(i.y-o.y)*v-d<0||(l.x-o.x)*p+(l.y-o.y)*v-d<0||(c.x-o.x)*p+(c.y-o.y)*v-d<0)}function Oi(o,e,i,l,c,d,p){return!(rr(o,e,l,c,d,p)||rr(e,i,l,c,d,p)||rr(i,o,l,c,d,p)||rr(l,c,o,e,i,p)||rr(c,d,o,e,i,p)||rr(d,l,o,e,i,p))}function xn(o,e,i){const l=e.paint.get(o).value;return l.kind==="constant"?l.value:i.programConfigurations.get(e.id).getMaxValue(o)}function Pi(o){return Math.sqrt(o[0]*o[0]+o[1]*o[1])}function Gn(o,e,i,l,c){if(!e[0]&&!e[1])return o;const d=St.convert(e)._mult(c);i==="viewport"&&d._rotate(-l);const p=[];for(let v=0;v<o.length;v++)p.push(o[v].sub(d));return p}function zi(o,e,i,l){const c=St.convert(o)._mult(l);return e==="viewport"&&c._rotate(-i),c}let Jn,Fi;function Tr(o,e,i){var l=2*Math.PI*6378137/256/Math.pow(2,i);return[o*l-2*Math.PI*6378137/2,e*l-2*Math.PI*6378137/2]}Ft(jt,"CircleBucket",{omit:["layers"]});class Si{constructor(e,i,l){this.z=e,this.x=i,this.y=l,this.key=Lr(0,e,e,i,l)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const l=function(d,p,v){var w=Tr(256*d,256*(p=Math.pow(2,v)-p-1),v),S=Tr(256*(d+1),256*(p+1),v);return w[0]+","+w[1]+","+S[0]+","+S[1]}(this.x,this.y,this.z),c=function(d,p,v){let w,S="";for(let I=d;I>0;I--)w=1<<I-1,S+=(p&w?1:0)+(v&w?2:0);return S}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",l)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Cr{constructor(e,i){this.wrap=e,this.canonical=i,this.key=Lr(e,i.z,i.z,i.x,i.y)}}class nr{constructor(e,i,l,c,d){this.overscaledZ=e,this.wrap=i,this.canonical=new Si(l,+c,+d),this.key=i===0&&e===l?this.canonical.key:Lr(i,e,l,c,d)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new nr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new nr(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return Lr(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const l=this.canonical.z-e;return Lr(this.wrap*+i,e,e,this.canonical.x>>l,this.canonical.y>>l)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new nr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,l=2*this.canonical.x,c=2*this.canonical.y;return[new nr(i,this.wrap,i,l,c),new nr(i,this.wrap,i,l+1,c),new nr(i,this.wrap,i,l,c+1),new nr(i,this.wrap,i,l+1,c+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new nr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new nr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Cr(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Lr(o,e,i,l,c){const d=1<<Math.min(i,22);let p=d*(c%d)+l%d;return o&&i<22&&(p+=d*d*((o<0?-2*o-1:2*o)%(1<<2*(22-i)))),16*(32*p+i)+(e-i)}const ds=[o=>{let e=o.canonical.x-1,i=o.wrap;return e<0&&(e=(1<<o.canonical.z)-1,i--),new nr(o.overscaledZ,i,o.canonical.z,e,o.canonical.y)},o=>{let e=o.canonical.x+1,i=o.wrap;return e===1<<o.canonical.z&&(e=0,i++),new nr(o.overscaledZ,i,o.canonical.z,e,o.canonical.y)},o=>new nr(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,(o.canonical.y===0?1<<o.canonical.z:o.canonical.y)-1),o=>new nr(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,o.canonical.y===(1<<o.canonical.z)-1?0:o.canonical.y+1)];Ft(Si,"CanonicalTileID"),Ft(nr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const ea=Yn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:yo}=ea,Jo=Yn([{name:"a_pos_3",components:3,type:"Int16"}]);var Cs=Yn([{name:"a_pos",type:"Int16",components:2}]);class Ps{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,l){const c=Bi(i,this.dir);if(Math.abs(c)<1e-6)return!1;const d=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/c;return l[0]=this.pos[0]+this.dir[0]*d,l[1]=this.pos[1]+this.dir[1]*d,!0}}class ps{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,l){const c=Nn(i,this.dir);if(Math.abs(c)<1e-6)return!1;const d=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/c;return l[0]=this.pos[0]+this.dir[0]*d,l[1]=this.pos[1]+this.dir[1]*d,l[2]=this.pos[2]+this.dir[2]*d,!0}closestPointOnSphere(e,i,l){if(function(B,N){var $=B[0],X=B[1],K=B[2],le=N[0],re=N[1],G=N[2];return Math.abs($-le)<=P*Math.max(1,Math.abs($),Math.abs(le))&&Math.abs(X-re)<=P*Math.max(1,Math.abs(X),Math.abs(re))&&Math.abs(K-G)<=P*Math.max(1,Math.abs(K),Math.abs(G))}(this.pos,e)||i===0)return l[0]=l[1]=l[2]=0,!1;const[c,d,p]=this.dir,v=this.pos[0]-e[0],w=this.pos[1]-e[1],S=this.pos[2]-e[2],I=c*c+d*d+p*p,C=2*(v*c+w*d+S*p),R=C*C-4*I*(v*v+w*w+S*S-i*i);if(R<0){const B=Math.max(-C/2,0),N=v+c*B,$=w+d*B,X=S+p*B,K=Math.hypot(N,$,X);return l[0]=N*i/K,l[1]=$*i/K,l[2]=X*i/K,!1}{const B=(-C-Math.sqrt(R))/(2*I);if(B<0){const N=Math.hypot(v,w,S);return l[0]=v*i/N,l[1]=w*i/N,l[2]=S*i/N,!1}return l[0]=v+c*B,l[1]=w+d*B,l[2]=S+p*B,!0}}}class Pc{constructor(e,i,l,c,d){this.TL=e,this.TR=i,this.BR=l,this.BL=c,this.horizon=d}static fromInvProjectionMatrix(e,i,l){const c=[-1,1,1],d=[1,1,1],p=[1,-1,1],v=[-1,-1,1],w=Ct(c,c,e),S=Ct(d,d,e),I=Ct(p,p,e),C=Ct(v,v,e);return new Pc(w,S,I,C,i/l)}}function Ml(o,e,i){let l=1/0,c=-1/0;const d=[];for(const p of o){dn(d,p,e);const v=Nn(d,i);l=Math.min(l,v),c=Math.max(c,v)}return[l,c]}function Uf(o,e){let i=!0;for(let l=0;l<o.planes.length;l++){const c=o.planes[l];let d=0;for(let p=0;p<e.length;p++)d+=Nn(c,e[p])+c[3]>=0;if(d===0)return 0;d!==e.length&&(i=!1)}return i?2:1}function jf(o,e){for(const i of o.projections){const l=Ml(e,o.points[0],i.axis);if(i.projection[1]<l[0]||i.projection[0]>l[1])return 0}return 1}function $f(o,e){let i=0;const l=[0,0,0,0];for(let p=0;p<o.length;p++)l[0]=o[p][0],l[1]=o[p][1],l[2]=o[p][2],l[3]=1,(c=l)[0]*(d=e)[0]+c[1]*d[1]+c[2]*d[2]+c[3]*d[3]>=0&&i++;var c,d;return i}class Ku{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Ri.fromPoints(this.points),this.projections=[],this.frustumEdges=[dn([],this.points[2],this.points[3]),dn([],this.points[0],this.points[3]),dn([],this.points[4],this.points[0]),dn([],this.points[5],this.points[1]),dn([],this.points[6],this.points[2]),dn([],this.points[7],this.points[3])];for(const l of this.frustumEdges){const c=[0,-l[2],l[1]],d=[l[2],0,-l[0]];this.projections.push({axis:c,projection:Ml(this.points,this.points[0],c)}),this.projections.push({axis:d,projection:Ml(this.points,this.points[0],d)})}}static fromInvProjectionMatrix(e,i,l,c){const d=Math.pow(2,l),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(S=>{const I=tr([],S,e),C=1/I[3]/i*d;return(R=I)[0]=(B=I)[0]*(N=[C,C,c?1/I[3]:C,C])[0],R[1]=B[1]*N[1],R[2]=B[2]*N[2],R[3]=B[3]*N[3],R;var R,B,N}),v=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(S=>{const I=hn([],Pn([],dn([],p[S[0]],p[S[1]]),dn([],p[S[2]],p[S[1]]))),C=-Nn(I,p[S[1]]);return I.concat(C)}),w=[];for(let S=0;S<p.length;S++)w.push([p[S][0],p[S][1],p[S][2]]);return new Ku(w,v)}intersectsPrecise(e,i,l){for(let c=0;c<i.length;c++)if(!$f(e,i[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!$f(e,this.planes[c]))return 0;for(const c of l)for(const d of this.frustumEdges){const p=Pn([],c,d),v=ut(p);if(v===0)continue;Lt(p,p,1/v);const w=Ml(this.points,this.points[0],p),S=Ml(e,this.points[0],p);if(w[0]>S[1]||S[0]>w[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const l=i[3];if(Nn([i[0],i[1],i[2]],e)+l<0)return!1}return!0}}class Ri{static fromPoints(e){const i=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(const c of e)Ht(i,i,c),Dt(l,l,c);return new Ri(i,l)}static fromTileIdAndHeight(e,i,l){const c=1<<e.canonical.z,d=e.canonical.x,p=e.canonical.y;return new Ri([d/c,p/c,i],[(d+1)/c,(p+1)/c,l])}static applyTransform(e,i){const l=e.getCorners();for(let c=0;c<l.length;++c)Ct(l[c],l[c],i);return Ri.fromPoints(l)}static applyTransformFast(e,i){const l=[i[12],i[13],i[14]],c=[...l];for(let d=0;d<3;d++)for(let p=0;p<3;p++){const v=i[4*p+d],w=v*e.min[p],S=v*e.max[p];l[d]+=Math.min(w,S),c[d]+=Math.max(w,S)}return new Ri(l,c)}static projectAabbCorners(e,i){const l=e.getCorners();for(let c=0;c<l.length;++c)Ct(l[c],l[c],i);return l}constructor(e,i){this.min=e,this.max=i,this.center=Lt([],Ve([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],l=Rt(this.min),c=Rt(this.max);for(let d=0;d<i.length;d++)l[d]=i[d]?this.min[d]:this.center[d],c[d]=i[d]?this.center[d]:this.max[d];return c[2]=this.max[2],new Ri(l,c)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Uf(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Uf(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?jf(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?jf(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}function zc(o){return o*g/q}Ft(Ri,"Aabb");const im=[new Ri([F,F,F],[O,O,O]),new Ri([F,F,F],[0,0,O]),new Ri([0,F,F],[O,0,O]),new Ri([F,0,F],[0,O,O]),new Ri([0,0,F],[O,O,O])];function QT(o,e,i,l=!0){const c=Lt([],o._camera.position,o.worldSize),d=[e,i,1,1];tr(d,d,o.pixelMatrixInverse),vn(d,d,1/d[3]);const p=hn([],dn([],d,c)),v=o.globeMatrix,w=[v[12],v[13],v[14]],S=dn([],w,c),I=ut(S),C=hn([],S),R=o.worldSize/(2*Math.PI),B=Nn(C,p),N=Math.asin(R/I);if(N<Math.acos(B)){if(!l)return null;const Me=[],ke=[];Lt(Me,p,I/B),hn(ke,dn(ke,Me,S)),hn(p,Ve(p,S,Lt(p,ke,Math.tan(N)*I)))}const $=[];new ps(c,p).closestPointOnSphere(w,R,$);const X=hn([],br(v,0)),K=hn([],br(v,1)),le=hn([],br(v,2)),re=Nn(X,$),G=Nn(K,$),ne=Nn(le,$),ae=ie(Math.asin(-G/R));let de=ie(Math.atan2(re,ne));de=o.center.lng+function(Me,ke){const Ye=(ke-Me+180)%360-180;return Ye<-180?Ye+360:Ye}(o.center.lng,de);const be=ye(de),Ie=ze(ve(ae),0,1);return new je(be,Ie)}class kL{constructor(e,i,l){this.a=dn([],e,l),this.b=dn([],i,l),this.center=l;const c=hn([],this.a),d=hn([],this.b);this.angle=Math.acos(Nn(c,d))}}function d1(o,e){if(o.angle===0)return null;let i;return i=o.a[e]===0?1/o.angle*.5*Math.PI:1/o.angle*Math.atan(o.b[e]/o.a[e]/Math.sin(o.angle)-1/Math.tan(o.angle)),i<0||i>1?null:function(l,c,d,p){const v=Math.sin(d);return l*(Math.sin((1-p)*d)/v)+c*(Math.sin(p*d)/v)}(o.a[e],o.b[e],o.angle,ze(i,0,1))+o.center[e]}function Da(o){if(o.z<=1)return im[o.z+2*o.y+o.x];const e=p1(n0(o));return Ri.fromPoints(e)}function Cl(o,e,i){return Lt(o,o,1-i),rn(o,o,e,i)}function eS(o,e,i){for(const l of o)Ct(l,l,e),Lt(l,l,i)}function tS(o,e,i,l){const c=e/o.worldSize,d=o.globeMatrix;if(i.z<=1){const Ie=Da(i).getCorners();return eS(Ie,d,c),Ri.fromPoints(Ie)}const p=n0(i,l),v=p1(p,g+zc(o._tileCoverLift));eS(v,d,c);const w=Number.MAX_VALUE,S=[-w,-w,-w],I=[w,w,w];if(p.contains(o.center)){for(const ke of v)Ht(I,I,ke),Dt(S,S,ke);S[2]=0;const Ie=o.point,Me=[Ie.x*c,Ie.y*c,0];return Ht(I,I,Me),Dt(S,S,Me),new Ri(I,S)}if(o._tileCoverLift>0){for(const Ie of v)Ht(I,I,Ie),Dt(S,S,Ie);return new Ri(I,S)}const C=[d[12]*c,d[13]*c,d[14]*c],R=p.getCenter(),B=ze(o.center.lat,-85.051129,Fe),N=ze(R.lat,-85.051129,Fe),$=ye(o.center.lng),X=ve(B);let K=$-ye(R.lng);const le=X-ve(N);K>.5?K-=1:K<-.5&&(K+=1);let re=0;Math.abs(K)>Math.abs(le)?re=K>=0?1:3:(re=le>=0?0:2,rn(C,C,[d[4]*c,d[5]*c,d[6]*c],-Math.sin(W(le>=0?p.getSouth():p.getNorth()))*g));const G=v[re],ne=v[(re+1)%4],ae=new kL(G,ne,C),de=[d1(ae,0)||G[0],d1(ae,1)||G[1],d1(ae,2)||G[2]],be=Rc(o.zoom);if(be>0){const Ie=function({x:ke,y:Ye,z:ft},at,ht,_t,We){const ct=1/(1<<ft);let Ge=ke*ct,Xe=Ge+ct,yt=Ye*ct,vt=yt+ct,Wt=0;const Nt=(Ge+Xe)/2-_t;return Nt>.5?Wt=-1:Nt<-.5&&(Wt=1),Ge=((Ge+Wt)*at-(_t*=at))*ht+_t,Xe=((Xe+Wt)*at-_t)*ht+_t,yt=(yt*at-(We*=at))*ht+We,vt=(vt*at-We)*ht+We,[[Ge,vt,0],[Xe,vt,0],[Xe,yt,0],[Ge,yt,0]]}(i,e,o._pixelsPerMercatorPixel,$,X);for(let ke=0;ke<v.length;ke++)Cl(v[ke],Ie[ke],be);const Me=Ve([],Ie[re],Ie[(re+1)%4]);Lt(Me,Me,.5),Cl(de,Me,be)}for(const Ie of v)Ht(I,I,Ie),Dt(S,S,Ie);return I[2]=Math.min(G[2],ne[2]),Ht(I,I,de),Dt(S,S,de),new Ri(I,S)}function n0({x:o,y:e,z:i},l=!1){const c=1/(1<<i),d=new Z(we(o*c),e===(1<<i)-1&&l?-90:Te((e+1)*c)),p=new Z(we((o+1)*c),e===0&&l?90:Te(e*c));return new oe(d,p)}function p1(o,e=g){const i=W(o.getNorth()),l=W(o.getSouth()),c=Math.cos(i),d=Math.cos(l),p=Math.sin(i),v=Math.sin(l),w=o.getWest(),S=o.getEast();return[U(d,v,w,e),U(d,v,S,e),U(c,p,S,e),U(c,p,w,e)]}function rm(o,e,i,l){const c=1<<i.z,d=(o/At+i.x)/c;return H(Te((e/At+i.y)/c),we(d),l)}function i0({min:o,max:e}){return A/Math.max(e[0]-o[0],e[1]-o[1],e[2]-o[2])}const nS=new Float64Array(16);function r0(o){const e=i0(o),i=Qe(nS,[e,e,e]);return ue(i,i,ti([],o.min))}function m1(o){const e=(l=o.min,(i=nS)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=l[0],i[13]=l[1],i[14]=l[2],i[15]=1,i);var i,l;const c=1/i0(o);return ce(e,e,[c,c,c])}function _1(o){const e=At/(2*Math.PI);return o/(2*Math.PI)/e}function iS(o,e){return At/(512*Math.pow(2,o))*i0(Da(e))}function rS(o,e,i,l,c){const d=_1(i),p=[o,e,-i/(2*Math.PI)],v=J(new Float64Array(16));return ue(v,v,p),ce(v,v,[d,d,d]),se(v,v,W(-c)),Ae(v,v,W(-l)),v}function Rc(o){return Re(b,T,o)}function oS(o,e){const i=H(e.lat,e.lng),l=function(N){const $=H(N._center.lat,N._center.lng);let X=Pn([],Pe(0,1,0),$);const K=nt([],-N.angle,$);X=Ct(X,X,K),nt(K,-N._pitch,X);const le=hn([],$);return Lt(le,le,zc(N.cameraToCenterDistance/N.pixelsPerMeter)),Ct(le,le,K),Ve([],$,le)}(o);return p=(c=qe([],l,i))[0],v=c[1],w=c[2],S=(d=i)[0],I=d[1],C=d[2],B=(R=Math.sqrt(p*p+v*v+w*w)*Math.sqrt(S*S+I*I+C*C))&&Nn(c,d)/R,Math.acos(Math.min(Math.max(B,-1),1));var c,d,p,v,w,S,I,C,R,B}function g1(o,e){return oS(o,e)>Math.PI/2*1.01}const sS=W(85),OL=Math.cos(sS),FL=Math.sin(sS),BL=te(),aS=o=>{const e=[];return o.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),o.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function lS(o,e,i,l,c,d,p,v,w){if(d&&o.queryGeometry.isAboveHorizon)return!1;d&&(w*=o.pixelToTileUnitsFactor);const S=o.tileID.canonical,I=i.projection.upVectorScale(S,i.center.lat,i.worldSize).metersToTile;for(const C of e)for(const R of C){const B=R.add(v),N=c&&i.elevation?i.elevation.exaggeration()*c.getElevationAt(B.x,B.y,!0):0,$=i.projection.projectTilePoint(B.x,B.y,S);if(N>0){const re=i.projection.upVector(S,B.x,B.y);$.x+=re[0]*I*N,$.y+=re[1]*I*N,$.z+=re[2]*I*N}const X=d?B:NL($.x,$.y,$.z,l),K=d?o.tilespaceRays.map(re=>UL(re,N)):o.queryGeometry.screenGeometry,le=tr([],[$.x,$.y,$.z,1],l);if(!p&&d?w*=le[3]/i.cameraToCenterDistance:p&&!d&&(w*=i.cameraToCenterDistance/le[3]),d){const re=Te((R.y/At+S.y)/(1<<S.z));w/=i.projection.pixelsPerMeter(re,1)/_e(1,re)}if(cn(K,X,w))return!0}return!1}function NL(o,e,i,l){const c=tr([],[o,e,i,1],l);return new St(c[0]/c[3],c[1]/c[3])}const cS=Pe(0,0,0),VL=Pe(0,0,1);function UL(o,e){const i=Be();return cS[2]=e,o.intersectsPlane(cS,VL,i),new St(i[0],i[1])}class uS extends jt{}let hS,fS,dS,pS;function mS(o,{width:e,height:i},l,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==e*i*l)throw new RangeError("mismatched image size")}else c=new Uint8Array(e*i*l);return o.width=e,o.height=i,o.data=c,o}function _S(o,e,i){const{width:l,height:c}=e;l===o.width&&c===o.height||(y1(o,e,{x:0,y:0},{x:0,y:0},{width:Math.min(o.width,l),height:Math.min(o.height,c)},i,null),o.width=l,o.height=c,o.data=e.data)}function y1(o,e,i,l,c,d,p,v){if(c.width===0||c.height===0)return e;if(c.width>o.width||c.height>o.height||i.x>o.width-c.width||i.y>o.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>e.width||c.height>e.height||l.x>e.width-c.width||l.y>e.height-c.height)throw new RangeError("out of range destination coordinates for image copy");const w=o.data,S=e.data,I=d===4&&v;for(let C=0;C<c.height;C++){const R=((i.y+C)*o.width+i.x)*d,B=((l.y+C)*e.width+l.x)*d;if(I)for(let N=0;N<c.width;N++){const $=R+N*d+3,X=B+N*d;S[X+0]=255,S[X+1]=255,S[X+2]=255,S[X+3]=w[$]}else if(p)for(let N=0;N<c.width;N++){const $=R+N*d,X=B+N*d,K=w[$+3],le=new Kn(w[$+0]/255*K,w[$+1]/255*K,w[$+2]/255*K,K).toRenderColor(p).toArray();S[X+0]=le[0],S[X+1]=le[1],S[X+2]=le[2],S[X+3]=le[3]}else for(let N=0;N<c.width*d;N++)S[B+N]=w[R+N]}return e}Ft(uS,"HeatmapBucket",{omit:["layers"]});class Dc{constructor(e,i){mS(this,e,1,i)}resize(e){_S(this,new Dc(e),1)}clone(){return new Dc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,l,c,d){y1(e,i,l,c,d,1,null)}}class Fr{constructor(e,i){mS(this,e,4,i)}resize(e){_S(this,new Fr(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Fr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,l,c,d,p,v){y1(e,i,l,c,d,4,p,v)}}class gS{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function om(o){const e={},i=o.resolution||256,l=o.clips?o.clips.length:1,c=o.image||new Fr({width:i,height:l}),d=(p,v,w)=>{e[o.evaluationKey]=w;const S=o.expression.evaluate(e);S&&(c.data[p+v+0]=Math.floor(255*S.r/S.a),c.data[p+v+1]=Math.floor(255*S.g/S.a),c.data[p+v+2]=Math.floor(255*S.b/S.a),c.data[p+v+3]=Math.floor(255*S.a))};if(o.clips)for(let p=0,v=0;p<l;++p,v+=4*i)for(let w=0,S=0;w<i;w++,S+=4){const I=w/(i-1),{start:C,end:R}=o.clips[p];d(v,S,C*(1-I)+R*I)}else for(let p=0,v=0;p<i;p++,v+=4)d(0,v,p/(i-1));return c}Ft(Dc,"AlphaImage"),Ft(Fr,"RGBAImage");const jL=Yn([{name:"a_pos",components:2,type:"Int16"}],4),$L=Yn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),GL=Yn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),qL=Yn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function sm(o,e,i=2){const l=e&&e.length,c=l?e[0]*i:o.length;let d=yS(o,0,c,i,!0);const p=[];if(!d||d.next===d.prev)return p;let v,w,S;if(l&&(d=function(I,C,R,B){const N=[];for(let $=0,X=C.length;$<X;$++){const K=yS(I,C[$]*B,$<X-1?C[$+1]*B:I.length,B,!1);K===K.next&&(K.steiner=!0),N.push(QL(K))}N.sort(YL);for(let $=0;$<N.length;$++)R=KL(N[$],R);return R}(o,e,d,i)),o.length>80*i){v=1/0,w=1/0;let I=-1/0,C=-1/0;for(let R=i;R<c;R+=i){const B=o[R],N=o[R+1];B<v&&(v=B),N<w&&(w=N),B>I&&(I=B),N>C&&(C=N)}S=Math.max(I-v,C-w),S=S!==0?32767/S:0}return am(d,p,i,v,w,S,0),p}function yS(o,e,i,l,c){let d;if(c===function(p,v,w,S){let I=0;for(let C=v,R=w-S;C<w;C+=S)I+=(p[R]-p[C])*(p[C+1]+p[R+1]),R=C;return I}(o,e,i,l)>0)for(let p=e;p<i;p+=l)d=wS(p/l|0,o[p],o[p+1],d);else for(let p=i-l;p>=e;p-=l)d=wS(p/l|0,o[p],o[p+1],d);return d&&Gf(d,d.next)&&(um(d),d=d.next),d}function Ju(o,e){if(!o)return o;e||(e=o);let i,l=o;do if(i=!1,l.steiner||!Gf(l,l.next)&&Sr(l.prev,l,l.next)!==0)l=l.next;else{if(um(l),l=e=l.prev,l===l.next)break;i=!0}while(i||l!==e);return e}function am(o,e,i,l,c,d,p){if(!o)return;!p&&d&&function(w,S,I,C){let R=w;do R.z===0&&(R.z=v1(R.x,R.y,S,I,C)),R.prevZ=R.prev,R.nextZ=R.next,R=R.next;while(R!==w);R.prevZ.nextZ=null,R.prevZ=null,function(B){let N,$=1;do{let X,K=B;B=null;let le=null;for(N=0;K;){N++;let re=K,G=0;for(let ae=0;ae<$&&(G++,re=re.nextZ,re);ae++);let ne=$;for(;G>0||ne>0&&re;)G!==0&&(ne===0||!re||K.z<=re.z)?(X=K,K=K.nextZ,G--):(X=re,re=re.nextZ,ne--),le?le.nextZ=X:B=X,X.prevZ=le,le=X;K=re}le.nextZ=null,$*=2}while(N>1)}(R)}(o,l,c,d);let v=o;for(;o.prev!==o.next;){const w=o.prev,S=o.next;if(d?ZL(o,l,c,d):HL(o))e.push(w.i,o.i,S.i),um(o),o=S.next,v=S.next;else if((o=S)===v){p?p===1?am(o=WL(Ju(o),e),e,i,l,c,d,2):p===2&&XL(o,e,i,l,c,d):am(Ju(o),e,i,l,c,d,1);break}}}function HL(o){const e=o.prev,i=o,l=o.next;if(Sr(e,i,l)>=0)return!1;const c=e.x,d=i.x,p=l.x,v=e.y,w=i.y,S=l.y,I=Math.min(c,d,p),C=Math.min(v,w,S),R=Math.max(c,d,p),B=Math.max(v,w,S);let N=l.next;for(;N!==e;){if(N.x>=I&&N.x<=R&&N.y>=C&&N.y<=B&&lm(c,v,d,w,p,S,N.x,N.y)&&Sr(N.prev,N,N.next)>=0)return!1;N=N.next}return!0}function ZL(o,e,i,l){const c=o.prev,d=o,p=o.next;if(Sr(c,d,p)>=0)return!1;const v=c.x,w=d.x,S=p.x,I=c.y,C=d.y,R=p.y,B=Math.min(v,w,S),N=Math.min(I,C,R),$=Math.max(v,w,S),X=Math.max(I,C,R),K=v1(B,N,e,i,l),le=v1($,X,e,i,l);let re=o.prevZ,G=o.nextZ;for(;re&&re.z>=K&&G&&G.z<=le;){if(re.x>=B&&re.x<=$&&re.y>=N&&re.y<=X&&re!==c&&re!==p&&lm(v,I,w,C,S,R,re.x,re.y)&&Sr(re.prev,re,re.next)>=0||(re=re.prevZ,G.x>=B&&G.x<=$&&G.y>=N&&G.y<=X&&G!==c&&G!==p&&lm(v,I,w,C,S,R,G.x,G.y)&&Sr(G.prev,G,G.next)>=0))return!1;G=G.nextZ}for(;re&&re.z>=K;){if(re.x>=B&&re.x<=$&&re.y>=N&&re.y<=X&&re!==c&&re!==p&&lm(v,I,w,C,S,R,re.x,re.y)&&Sr(re.prev,re,re.next)>=0)return!1;re=re.prevZ}for(;G&&G.z<=le;){if(G.x>=B&&G.x<=$&&G.y>=N&&G.y<=X&&G!==c&&G!==p&&lm(v,I,w,C,S,R,G.x,G.y)&&Sr(G.prev,G,G.next)>=0)return!1;G=G.nextZ}return!0}function WL(o,e){let i=o;do{const l=i.prev,c=i.next.next;!Gf(l,c)&&xS(l,i,i.next,c)&&cm(l,c)&&cm(c,l)&&(e.push(l.i,i.i,c.i),um(i),um(i.next),i=o=c),i=i.next}while(i!==o);return Ju(i)}function XL(o,e,i,l,c,d){let p=o;do{let v=p.next.next;for(;v!==p.prev;){if(p.i!==v.i&&e5(p,v)){let w=bS(p,v);return p=Ju(p,p.next),w=Ju(w,w.next),am(p,e,i,l,c,d,0),void am(w,e,i,l,c,d,0)}v=v.next}p=p.next}while(p!==o)}function YL(o,e){let i=o.x-e.x;return i===0&&(i=o.y-e.y,i===0)&&(i=(o.next.y-o.y)/(o.next.x-o.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function KL(o,e){const i=function(c,d){let p=d;const v=c.x,w=c.y;let S,I=-1/0;if(Gf(c,p))return p;do{if(Gf(c,p.next))return p.next;if(w<=p.y&&w>=p.next.y&&p.next.y!==p.y){const $=p.x+(w-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if($<=v&&$>I&&(I=$,S=p.x<p.next.x?p:p.next,$===v))return S}p=p.next}while(p!==d);if(!S)return null;const C=S,R=S.x,B=S.y;let N=1/0;p=S;do{if(v>=p.x&&p.x>=R&&v!==p.x&&vS(w<B?v:I,w,R,B,w<B?I:v,w,p.x,p.y)){const $=Math.abs(w-p.y)/(v-p.x);cm(p,c)&&($<N||$===N&&(p.x>S.x||p.x===S.x&&JL(S,p)))&&(S=p,N=$)}p=p.next}while(p!==C);return S}(o,e);if(!i)return e;const l=bS(i,o);return Ju(l,l.next),Ju(i,i.next)}function JL(o,e){return Sr(o.prev,o,e.prev)<0&&Sr(e.next,o,o.next)<0}function v1(o,e,i,l,c){return(o=1431655765&((o=858993459&((o=252645135&((o=16711935&((o=(o-i)*c|0)|o<<8))|o<<4))|o<<2))|o<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-l)*c|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function QL(o){let e=o,i=o;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==o);return i}function vS(o,e,i,l,c,d,p,v){return(c-p)*(e-v)>=(o-p)*(d-v)&&(o-p)*(l-v)>=(i-p)*(e-v)&&(i-p)*(d-v)>=(c-p)*(l-v)}function lm(o,e,i,l,c,d,p,v){return!(o===p&&e===v)&&vS(o,e,i,l,c,d,p,v)}function e5(o,e){return o.next.i!==e.i&&o.prev.i!==e.i&&!function(i,l){let c=i;do{if(c.i!==i.i&&c.next.i!==i.i&&c.i!==l.i&&c.next.i!==l.i&&xS(c,c.next,i,l))return!0;c=c.next}while(c!==i);return!1}(o,e)&&(cm(o,e)&&cm(e,o)&&function(i,l){let c=i,d=!1;const p=(i.x+l.x)/2,v=(i.y+l.y)/2;do c.y>v!=c.next.y>v&&c.next.y!==c.y&&p<(c.next.x-c.x)*(v-c.y)/(c.next.y-c.y)+c.x&&(d=!d),c=c.next;while(c!==i);return d}(o,e)&&(Sr(o.prev,o,e.prev)||Sr(o,e.prev,e))||Gf(o,e)&&Sr(o.prev,o,o.next)>0&&Sr(e.prev,e,e.next)>0)}function Sr(o,e,i){return(e.y-o.y)*(i.x-e.x)-(e.x-o.x)*(i.y-e.y)}function Gf(o,e){return o.x===e.x&&o.y===e.y}function xS(o,e,i,l){const c=s0(Sr(o,e,i)),d=s0(Sr(o,e,l)),p=s0(Sr(i,l,o)),v=s0(Sr(i,l,e));return c!==d&&p!==v||!(c!==0||!o0(o,i,e))||!(d!==0||!o0(o,l,e))||!(p!==0||!o0(i,o,l))||!(v!==0||!o0(i,e,l))}function o0(o,e,i){return e.x<=Math.max(o.x,i.x)&&e.x>=Math.min(o.x,i.x)&&e.y<=Math.max(o.y,i.y)&&e.y>=Math.min(o.y,i.y)}function s0(o){return o>0?1:o<0?-1:0}function cm(o,e){return Sr(o.prev,o,o.next)<0?Sr(o,e,o.next)>=0&&Sr(o,o.prev,e)>=0:Sr(o,e,o.prev)<0||Sr(o,o.next,e)<0}function bS(o,e){const i=x1(o.i,o.x,o.y),l=x1(e.i,e.x,e.y),c=o.next,d=e.prev;return o.next=e,e.prev=o,i.next=c,c.prev=i,l.next=i,i.prev=l,d.next=l,l.prev=d,l}function wS(o,e,i,l){const c=x1(o,e,i);return l?(c.next=l.next,c.prev=l,l.next.prev=c,l.next=c):(c.prev=c,c.next=c),c}function um(o){o.next.prev=o.prev,o.prev.next=o.next,o.prevZ&&(o.prevZ.nextZ=o.nextZ),o.nextZ&&(o.nextZ.prevZ=o.prevZ)}function x1(o,e,i){return{i:o,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function a0(o,e){const i=o.length;if(i<=1)return[o];const l=[];let c,d;for(let p=0;p<i;p++){const v=Xn(o[p]);v!==0&&(o[p].area=Math.abs(v),d===void 0&&(d=v<0),d===v<0?(c&&l.push(c),c=[o[p]]):c.push(o[p]))}if(c&&l.push(c),e>1)for(let p=0;p<l.length;p++)l[p].length<=e||(xa(l[p],e,1,l[p].length-1,t5),l[p]=l[p].slice(0,e));return l}function t5(o,e){return e.area-o.area}function TS(o,e,i=1){if(!o)return null;const l=typeof o=="string"?co.from(o).getPrimary():o.getPrimary(),c=typeof o=="string"?null:o.getSecondary();for(const d of[l,c]){if(!d)continue;const p=d.id.toString();e.has(p)||e.set(p,[]),d.scaleSelf(i),e.get(p).push(d)}return{primary:l.toString(),secondary:c?c.toString():null}}function b1(o,e,i,l){const c=l.patternDependencies;let d=!1;for(const p of e){const v=p.paint.get(`${o}-pattern`);v.isConstant()||(d=!0),TS(v.constantOr(null),c,i)&&(d=!0)}return d}function w1(o,e,i,l,c,d){const p=d.patternDependencies;for(const v of e){const w=v.paint.get(`${o}-pattern`).value;if(w.kind!=="constant"){let S=w.evaluate({zoom:l},i,{},d.availableImages);S=S&&S.name?S.name:S;const I=TS(S,p,c);if(!I)continue;const{primary:C,secondary:R}=I;C&&(i.patterns[v.id]=[C,R].filter(Boolean))}}return i}var T1,SS,S1,ES,E1,AS,IS,l0={};function MS(){if(SS)return T1;SS=1;var o=uu();function e(c,d,p,v,w){this.properties={},this.extent=p,this.type=0,this._pbf=c,this._geometry=-1,this._keys=v,this._values=w,c.readFields(i,this,d)}function i(c,d,p){c==1?d.id=p.readVarint():c==2?function(v,w){for(var S=v.readVarint()+v.pos;v.pos<S;){var I=w._keys[v.readVarint()],C=w._values[v.readVarint()];w.properties[I]=C}}(p,d):c==3?d.type=p.readVarint():c==4&&(d._geometry=p.pos)}function l(c){for(var d,p,v=0,w=0,S=c.length,I=S-1;w<S;I=w++)v+=((p=c[I]).x-(d=c[w]).x)*(d.y+p.y);return v}return T1=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var c=this._pbf;c.pos=this._geometry;for(var d,p=c.readVarint()+c.pos,v=1,w=0,S=0,I=0,C=[];c.pos<p;){if(w<=0){var R=c.readVarint();v=7&R,w=R>>3}if(w--,v===1||v===2)S+=c.readSVarint(),I+=c.readSVarint(),v===1&&(d&&C.push(d),d=[]),d.push(new o(S,I));else{if(v!==7)throw new Error("unknown command "+v);d&&d.push(d[0].clone())}}return d&&C.push(d),C},e.prototype.bbox=function(){var c=this._pbf;c.pos=this._geometry;for(var d=c.readVarint()+c.pos,p=1,v=0,w=0,S=0,I=1/0,C=-1/0,R=1/0,B=-1/0;c.pos<d;){if(v<=0){var N=c.readVarint();p=7&N,v=N>>3}if(v--,p===1||p===2)(w+=c.readSVarint())<I&&(I=w),w>C&&(C=w),(S+=c.readSVarint())<R&&(R=S),S>B&&(B=S);else if(p!==7)throw new Error("unknown command "+p)}return[I,R,C,B]},e.prototype.toGeoJSON=function(c,d,p){var v,w,S=this.extent*Math.pow(2,p),I=this.extent*c,C=this.extent*d,R=this.loadGeometry(),B=e.types[this.type];function N(K){for(var le=0;le<K.length;le++){var re=K[le];K[le]=[360*(re.x+I)/S-180,360/Math.PI*Math.atan(Math.exp((180-360*(re.y+C)/S)*Math.PI/180))-90]}}switch(this.type){case 1:var $=[];for(v=0;v<R.length;v++)$[v]=R[v][0];N(R=$);break;case 2:for(v=0;v<R.length;v++)N(R[v]);break;case 3:for(R=function(K){var le=K.length;if(le<=1)return[K];for(var re,G,ne=[],ae=0;ae<le;ae++){var de=l(K[ae]);de!==0&&(G===void 0&&(G=de<0),G===de<0?(re&&ne.push(re),re=[K[ae]]):re.push(K[ae]))}return re&&ne.push(re),ne}(R),v=0;v<R.length;v++)for(w=0;w<R[v].length;w++)N(R[v][w])}R.length===1?R=R[0]:B="Multi"+B;var X={type:"Feature",geometry:{type:B,coordinates:R},properties:this.properties};return"id"in this&&(X.id=this.id),X},T1}function CS(){if(ES)return S1;ES=1;var o=MS();function e(l,c){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=l,this._keys=[],this._values=[],this._features=[],l.readFields(i,this,c),this.length=this._features.length}function i(l,c,d){l===15?c.version=d.readVarint():l===1?c.name=d.readString():l===5?c.extent=d.readVarint():l===2?c._features.push(d.pos):l===3?c._keys.push(d.readString()):l===4&&c._values.push(function(p){for(var v=null,w=p.readVarint()+p.pos;p.pos<w;){var S=p.readVarint()>>3;v=S===1?p.readString():S===2?p.readFloat():S===3?p.readDouble():S===4?p.readVarint64():S===5?p.readVarint():S===6?p.readSVarint():S===7?p.readBoolean():null}return v}(d))}return S1=e,e.prototype.feature=function(l){if(l<0||l>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[l];var c=this._pbf.readVarint()+this._pbf.pos;return new o(this._pbf,c,this.extent,this._keys,this._values)},S1}function PS(){return IS||(IS=1,l0.VectorTile=function(){if(AS)return E1;AS=1;var o=CS();function e(i,l,c){if(i===3){var d=new o(c,c.readVarint()+c.pos);d.length&&(l[d.name]=d)}}return E1=function(i,l){this.layers=i.readFields(e,{},l)},E1}(),l0.VectorTileFeature=MS(),l0.VectorTileLayer=CS()),l0}var Lc=PS();const Qu="3d_elevation_id",zS="level";class n5{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,l){return this.get(e,!0,i,l)}optional(e,i,l){return this.get(e,!1,i,l)}success(){return this._valid}get(e,i,l,c){const d=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&d!==void 0&&!Number.isNaN(d)?l(c?c(d):d):i&&(this._valid=!1),this}}class RS{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,l){return this.featureFunc(e,i,l)}parseVertex(e,i,l){return this.vertexFunc(e,i,l)}}const i5=new RS((o,e,i)=>o.reset(e).require(Qu,l=>{i.id=l}).optional("fixed_height_relative",l=>{i.constantHeight=l},eh.decodeRelativeHeight).geometry(l=>{i.bounds=l},ap).success(),(o,e,i)=>o.reset(e).require(Qu,l=>{i.id=l}).require("elevation_idx",l=>{i.idx=l}).require("extent",l=>{i.extent=l}).require("height_relative",l=>{i.height=l},eh.decodeRelativeHeight).geometry(l=>{i.position=l},eh.getPoint).success()),r5=new RS((o,e,i)=>o.reset(e).require(Qu,l=>{i.id=l}).optional("fixed_height",l=>{i.constantHeight=l},eh.decodeMetricHeight).geometry(l=>{i.bounds=l},ap).success(),(o,e,i)=>o.reset(e).require(Qu,l=>{i.id=l}).require("elevation_idx",l=>{i.idx=l}).require("extent",l=>{i.extent=l}).require("height",l=>{i.height=l},eh.decodeMetricHeight).geometry(l=>{i.position=l},eh.getPoint).success());class eh{static getPoint(e){return Qa(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){const i=[],l=[],c=e.length,d=new n5;for(let v=0;v<c;v++){const w=e.feature(v),S=w.properties.hasOwnProperty("version")?String(w.properties.version):void 0,I=(p=S)?p==="1.0.1"?r5:void 0:i5;if(I===void 0){Dn(`Unknown elevation feature version number ${S||"(unknown)"}`);continue}const C=w.properties.hasOwnProperty("type")?w.properties.type:void 0;if(C){if(Lc.VectorTileFeature.types[w.type]==="Point"&&C==="curve_point"){const R={};I.parseVertex(d,w,R)&&i.push(R)}else if(Lc.VectorTileFeature.types[w.type]==="Polygon"&&C==="curve_meta"){const R={};I.parseFeature(d,w,R)&&l.push(R)}}}var p;return{vertices:i,features:l}}}class DS{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,l=i[1],c=-i[0],d=(e.extent+1)*this.metersToTile;return[new St(Math.trunc(e.position[0]+l*d),Math.trunc(e.position[1]+c*d)),new St(Math.trunc(e.position[0]-l*d),Math.trunc(e.position[1]-c*d))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class A1{constructor(e,i,l,c,d,p){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:l,max:l},this.safeArea=i,this.constantHeight=l,this.constantHeight==null&&(this.constantHeight!=null||c.length!==0)){this.vertices=c,this.edges=d,this.edges=this.edges.filter(v=>{return v.a<this.vertices.length&&v.b<this.vertices.length&&!((w=this.vertices[v.a].position)[0]===(S=this.vertices[v.b].position)[0]&&w[1]===S[1]);var w,S}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const v of this.vertices)this.vertexProps.push({dir:Qa(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,v.height),this.heightRange.max=Math.max(this.heightRange.max,v.height);for(const v of this.edges){const w=this.vertices[v.a].position,S=this.vertices[v.b].position,I=ws(ao(),S,w),C=tl(I),R=el(ao(),I,1/C);this.edgeProps.push({vec:I,dir:R,len:C});const B=this.vertexProps[v.a].dir,N=this.vertexProps[v.b].dir;pa(B,B,R),pa(N,N,R)}for(const v of this.vertexProps)v.dir[0]===0&&v.dir[1]===0||lu(v.dir,v.dir);this.tessellate(p)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[l,c]=i;return((d,p,v)=>(1-v)*d+v*p)(this.vertices[this.edges[l].a].height,this.vertices[this.edges[l].b].height,c)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,l=Number.POSITIVE_INFINITY,c=0;const d=Qa(e.x,e.y);for(let p=0;p<this.edges.length;p++){const v=this.edges[p],w=this.edgeProps[p].dir,S=new Ps(d,this.edgeProps[p].dir),I=this.vertices[v.a].position,C=this.vertices[v.b].position,R=ao(),B=ao(),N=S.intersectsPlane(I,this.vertexProps[v.a].dir,R),$=S.intersectsPlane(C,this.vertexProps[v.b].dir,B);if(!N||!$)continue;const X=ws(ao(),B,R),K=ws(ao(),d,R),le=Bi(X,X),re=le>0?Bi(K,X)/le:0,G=ze(re,0,1),ne=Math.abs((re-G)*this.edgeProps[p].len),ae=ws(ao(),d,I),de=ne+Math.abs(Bi(ae,Qa(w[1],-w[0])));de<l&&(i=p,l=de,c=G)}return[i,c]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){const l=this.edges[i].a,c=this.edges[i].b,{position:d,height:p,extent:v}=this.vertices[l],{position:w,height:S,extent:I}=this.vertices[c],C=this.vertexProps[l].dir,R=this.vertexProps[c].dir,B=Pe(d[0]/e,d[1]/e,p),N=Pe(w[0]/e,w[1]/e,S),$=Pe(C[1],-C[0],0);Lt($,$,v);const X=Pe(R[1],-R[0],0);if(Lt(X,X,I),this.distSqLines(Pe(B[0]+.5*$[0],B[1]+.5*$[1],B[2]+.5*$[2]),Pe(N[0]-.5*X[0],N[1]-.5*X[1],N[2]-.5*X[2]),Pe(B[0]-.5*$[0],B[1]-.5*$[1],B[2]-.5*$[2]),Pe(N[0]+.5*X[0],N[1]+.5*X[1],N[2]+.5*X[2]))<=.0025000000000000005)continue;const K=this.vertices.length,le=pa(ao(),d,w);this.vertices.push({position:el(le,le,.5),height:.5*(p+S),extent:.5*(v+I)});const re=pa(ao(),C,R);this.vertexProps.push({dir:lu(re,re)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:l,b:K}),this.edges.push({a:K,b:c});const G=ws(ao(),this.vertices[K].position,d),ne=tl(G),ae={vec:G,dir:el(ao(),G,1/ne),len:ne};this.edgeProps.push(ae),this.edgeProps.push(ae)}}distSqLines(e,i,l,c){const d=qe(Be(),i,e),p=qe(Be(),c,l),v=qe(Be(),e,l),w=Nn(d,d),S=Nn(d,p),I=Nn(d,v),C=Nn(p,p),R=Nn(p,v),B=w*C-S*S;if(B===0){const X=Nn(v,p)/Nn(p,p);return yn(Gi(Be(),l,c,X),e)}const N=(S*R-I*C)/B,$=(w*R-S*I)/B;return yn(Gi(Be(),e,i,N),Gi(Be(),l,c,$))}}class I1{static parseFrom(e,i){const l=eh.parse(e);if(!l)return[];let{vertices:c,features:d}=l;const p=1/Oe(i);d.sort((I,C)=>I.id-C.id),c.sort((I,C)=>I.id-C.id||I.idx-C.idx),c=c.filter((I,C,R)=>C===R.findIndex(B=>B.id===I.id&&B.idx===I.idx));const v=new Array;let w=0;const S=c.length;for(const I of d){if(I.constantHeight){v.push(new A1(I.id,I.bounds,I.constantHeight));continue}for(;w!==S&&c[w].id<I.id;)w++;if(w===S||c[w].id!==I.id)continue;const C=new Array,R=new Array,B=w;for(;w!==S&&c[w].id===I.id;){const N=c[w];if(C.push({position:N.position,height:N.height,extent:N.extent}),w!==B&&c[w-1].idx===N.idx-1){const $=w-B;R.push({a:$-1,b:$})}w++}v.push(new A1(I.id,I.bounds,void 0,C,R,p))}return v}static getElevationFeature(e,i){if(!i)return;const l=+e.properties[Qu];return Number.isNaN(l)?void 0:i.find(c=>c.id===l)}}class LS{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*At,this.yOffset=(e.y*this.zScale-i.y)*At)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,l){const c=this.constantElevation(i,l);return c??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),l))}computeBiasedHeight(e,i){return i<=0?e:e+i*Re(0,i,e>=0?e:Math.abs(.5*e))}}Ft(A1,"ElevationFeature");class kS{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(const[i,l]of e.polygons)this.add(i,...l)}}class th{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new th;let i=[];for(const S of e)i.push(...S.portals);if(i.length===0)return new th;const l=(S,I)=>S<=0&&I<=0||S>=At&&I>=At;for(const S of i){const I=S.va,C=S.vb;(l(I.x,C.x)||l(I.y,C.y))&&(S.type="border")}const c=i.filter(S=>S.type!=="unevaluated"),d=i.filter(S=>S.type==="unevaluated");if(d.length===0)return new th;d.sort((S,I)=>S.hash===I.hash?S.isTunnel===I.isTunnel?0:S.isTunnel?-1:1:S.hash<I.hash?1:-1),i=c.concat(d);let p=c.length,v=p,w=p;do if(v++,v===i.length||i[p].hash!==i[v].hash){if(v-p==2){w<p&&(i[w]=i[p],i[p]=null);const S=i[w],I=i[v-1];S.type=S.isTunnel!==I.isTunnel?"tunnel":"polygon",S.connection={a:S.connection.a,b:I.connection.a},w++}p=v}while(p!==i.length);return i.splice(w),i.sort((S,I)=>S.hash<I.hash?1:-1),{portals:i}}}Ft(th,"ElevationPortalGraph"),Ft(kS,"ElevationPolygons");class o5{constructor(e,i,l){this.outPositions=e,this.outNormals=i,this.outIndices=l,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,l){let c=e[2];l!=null&&(c*=l);const d=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),p=this.vertexLookup.get(d);if(p!=null)return p;const v=this.outPositions.length;this.vertexLookup.set(d,v);const w=Math.trunc(16384*i[0]),S=Math.trunc(16384*i[1]),I=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],c),this.outNormals.emplaceBack(w,S,I),v}addVertices(e,i,...l){const c=[];for(const d of l){const p=this.addVertex(d,e,i);c.push(p)}return c}addTriangles(e,i,l){if(i&&l){const c=l.length===1,d=Pe(0,0,0);for(let p=0;p<e.length;p+=3){const v=i[e[p+0]],w=i[e[p+1]],S=i[e[p+2]],I=c?l[0]:l[e[p+1]],C=c?l[0]:l[e[p+2]],R=this.addVertex(Pe(v.x,v.y,c?l[0]:l[e[p+0]]),d),B=this.addVertex(Pe(w.x,w.y,I),d),N=this.addVertex(Pe(S.x,S.y,C),d);this.outIndices.emplaceBack(R,B,N)}}else for(let c=0;c<e.length;c+=3)this.outIndices.emplaceBack(e[c+0],e[c+1],e[c+2])}addQuad(e,i){const l=this.addVertices(i,void 0,...e.map(w=>Pe(w.coord.x,w.coord.y,w.height))),[c,d,p,v]=l;this.addTriangles([c,d,p,p,v,c])}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Qo{constructor(e){this.unevaluatedPortals=new th,this.portalPolygons=new kS,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Rf,this.vertexNormals=new Sc,this.indexArray=new wr,this.tileToMeters=Oe(e)}addVertices(e,i){const l=this.unevalVertices.length;for(let c=0;c<e.length;c++)this.unevalVertices.push(e[c]),this.unevalHeights.push(i[c]);return l}addTriangles(e,i,l){const c=l?this.unevalTunnelTriangles:this.unevalTriangles;for(const d of e)c.push(d+i)}addRenderableRing(e,i,l,c,d){const p=[new St(d.min.x,d.min.y),new St(d.max.x,d.min.y),new St(d.max.x,d.max.y),new St(d.min.x,d.max.y)];for(let v=0;v<l-1;v++){const w=i+v,S=w+1,I=this.unevalVertices[w],C=this.unevalVertices[S];if(!(I.x>=d.min.x&&I.x<=d.max.x&&I.y>=d.min.y&&I.y<=d.max.y||C.x>=d.min.x&&C.x<=d.max.x&&C.y>=d.min.y&&C.y<=d.max.y||Yi(I,C,p))||this.isOnBorder(I.x,C.x)||this.isOnBorder(I.y,C.y))continue;const R=Qo.computeEdgeHash(this.unevalVertices[w],this.unevalVertices[S]);let B,N=this.vertexHashLookup.get(Qo.computePosHash(I));N!=null?B=N.next:(N=this.vertexHashLookup.get(Qo.computePosHash(C)),B=N!=null?N.prev:R),this.unevalEdges.push({polygonIdx:e,a:w,b:S,hash:R,portalHash:B,isTunnel:c,type:"unevaluated"})}}addPortalCandidates(e,i,l,c,d){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:d});const p=i[0];this.vertexHashLookup.clear();let v=Qo.computeEdgeHash(p[p.length-2],p[p.length-1]);for(let w=0;w<p.length-1;w++){const S=p[w+0],I=p[w+1],C=Qa(I.x-S.x,I.y-S.y),R=tl(C);if(R===0)continue;let B="unevaluated";const N=c.pointElevation(S),$=c.pointElevation(I);Math.abs(N)<.01&&Math.abs($)<.01?B="entrance":(this.isOnBorder(S.x,I.x)||this.isOnBorder(S.y,I.y))&&(B="border");const X=Qo.computeEdgeHash(S,I);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:S,vb:I,vab:C,length:R,hash:X,isTunnel:l,type:B});const K=Qo.computePosHash(S);this.vertexHashLookup.set(K,{prev:v,next:X}),v=X}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),l=C=>{C.primitiveLength=this.indexArray.length-C.primitiveOffset},c=new o5(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const d=i(),p=i(),v=i(),w=(C,R)=>{C.sort((N,$)=>N.type===R&&$.type!==R?-1:N.type!==R&&$.type===R?1:0);const B=C.findIndex(N=>N.type!==R);return B>=0?B:C.length};let S=0;this.unevalEdges.length>0&&(S=w(this.unevalEdges,"none"),this.constructBridgeStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:S},this.tileToMeters));const I=i();if(this.unevalEdges.length>0){const C=this.unevalEdges.splice(S),R=w(C,"tunnel")+S;this.unevalEdges.push(...C),this.constructTunnelStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:S},{min:S,max:R})}l(v),c.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),l(I),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),l(p),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),l(d),this.maskSegments=Ui.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.depthSegments=Ui.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableSegments=Ui.simpleSegment(0,v.primitiveOffset,0,v.primitiveLength),this.shadowCasterSegments=Ui.simpleSegment(0,d.primitiveOffset,0,d.primitiveLength)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,GL.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,qL.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(e,i,l,c,d){const p=new Map;for(let v=c;v<d;v++){const w=l[v],S=w.a,I=w.b,C=Qo.computePosHash(e[S]),R=Qo.computePosHash(e[I]);p.has(C)||p.set(C,{}),p.has(R)||p.set(R,{});const B=p.get(C),N=p.get(R);i[S]<=0&&i[I]<=0||(B.to=I,N.from=S)}return p}constructBridgeStructures(e,i,l,c,d,p){const v=this.computeVertexConnections(i,l,c,d.min,d.max),w=1/p,S=.5*w,I=R=>Pe(i[R].x,i[R].y,l[R]*w),C=R=>{const B=v.get(Qo.computePosHash(i[R])),N=B.from,$=B.to;if(!N||!$)return;const X=I(N),K=I(R),le=I($),re=Pe(0,0,0);if(!It(X,K)){const ne=dn(Be(),K,X);Ve(re,re,hn(ne,ne))}if(!It(le,K)){const ne=dn(Be(),le,K);Ve(re,re,hn(ne,ne))}const G=Qi(re);return G>0?Lt(re,re,1/G):void 0};for(let R=d.min;R<d.max;R++){const B=c[R],N=this.prepareEdgePoints(i,l,B,(gt,ln)=>gt>ln);if(N==null)continue;const $=N[0],X=N[1],K=Pe($.coord.x,$.coord.y,w*$.height),le=Pe(X.coord.x,X.coord.y,w*X.height);if(It(K,le))continue;const re=dn(Be(),le,K);hn(re,re);const G=gt=>hn(gt,gt),ne=C(B.a)||re,ae=C(B.b)||re,de=G(Pe(ne[1],-ne[0],0)),be=G(Pe(ae[1],-ae[0],0)),Ie=G(Pn(Be(),de,ne)),Me=G(Pn(Be(),be,ae)),ke=Be(),Ye=[Ve(Be(),K,Lt(ke,dn(ke,de,Ie),S)),Ve(Be(),K,Lt(ke,Ve(ke,de,Ie),S)),Ve(Be(),K,Lt(ke,Ie,S)),K],ft=[Ve(Be(),le,Lt(ke,dn(ke,be,Me),S)),Ve(Be(),le,Lt(ke,Ve(ke,be,Me),S)),Ve(Be(),le,Lt(ke,Me,S)),le],[at,ht]=e.addVertices(de,p,Ye[0],Ye[1]),[_t,We]=e.addVertices(be,p,ft[0],ft[1]);e.addTriangles([at,ht,_t,ht,We,_t]);const[ct,Ge]=e.addVertices(Ie,p,Ye[1],Ye[2]),[Xe,yt]=e.addVertices(Me,p,ft[1],ft[2]);e.addTriangles([ct,Ge,Xe,Ge,yt,Xe]);const[vt,Wt]=e.addVertices(ti(de,de),p,Ye[2],Ye[3]),[Nt,Mt]=e.addVertices(ti(be,be),p,ft[2],ft[3]);e.addTriangles([vt,Wt,Nt,Wt,Mt,Nt])}}constructTunnelStructures(e,i,l,c,d,p){const v=w=>hn(w,w);for(let w=d.min;w<d.max;w++){const S=this.prepareEdgePoints(i,l,c[w],(B,N)=>B<N);if(S==null)continue;const[I,C]=S,R=v(Pe(C.coord.y-I.coord.y,-(C.coord.x-I.coord.x),0));e.addQuad([I,C,{coord:C.coord,height:c[w].isTunnel?-.1:0},{coord:I.coord,height:c[w].isTunnel?-.1:0}],R)}for(let w=p.min;w<p.max;w++){const S=c[w],I=i[S.a],C=i[S.b],R=v(Pe(C.y-I.y,-(C.x-I.x),0));e.addQuad([{coord:C,height:0},{coord:I,height:0},{coord:I,height:l[S.a]+4},{coord:C,height:l[S.b]+4}],R),e.addQuad([{coord:I,height:0},{coord:C,height:0},{coord:C,height:l[S.b]+4},{coord:I,height:l[S.a]+4}],R)}}prepareEdgePoints(e,i,l,c){let d=i[l.a],p=i[l.b];const v=c(d,0),w=c(p,0);if(v&&w)return[{coord:e[l.a],height:d},{coord:e[l.b],height:p}];if(!v&&!w)return;const S=e[l.a].clone(),I=e[l.b].clone();if(v){if(!w){const C=p/(p-d);I.x=Jt(I.x,S.x,C),I.y=Jt(I.y,S.y,C),p=Jt(p,d,C)}}else{const C=d/(d-p);S.x=Jt(S.x,I.x,C),S.y=Jt(S.y,I.y,C),d=Jt(d,p,C)}return[{coord:S,height:d},{coord:I,height:p}]}prepareEdges(e,i){if(i.length===0)return;i.sort((v,w)=>v.hash===w.hash?w.polygonIdx-v.polygonIdx:w.hash>v.hash?1:-1);let l=0,c=0,d=0,p=i[l].polygonIdx;do c++,(c===i.length||i[l].hash!==i[c].hash)&&((c-l==1||i[c-1].polygonIdx!==p)&&(d<l&&(i[d]=i[l],i[l]=null),i[d].type="none",d++),l=c,l!==i.length&&(p=i[l].polygonIdx));while(l!==i.length);if(i.splice(d),i.length!==0&&e.length!==0){i.sort((S,I)=>S.portalHash<I.portalHash?1:-1);let v=0,w=0;for(;v!==i.length&&w!==e.length;){const S=i[v],I=e[w];S.portalHash>I.hash?v++:I.hash>S.portalHash?w++:(S.type=I.type,v++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=At&&i>=At}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(Qo.computePosHash(e))<<32n|BigInt(Qo.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var OS,FS={exports:{}},BS=(OS||(OS=1,function(o,e){(function(i){function l(he,pe){return he>pe?1:he<pe?-1:0}var c=function(he,pe){he===void 0&&(he=l),pe===void 0&&(pe=!1),this._compare=he,this._root=null,this._size=0,this._noDuplicates=!!pe},d={size:{configurable:!0}};function p(he,pe,Je,Tt,zt){var Pt=zt-Tt;if(Pt>0){var qt=Tt+Math.floor(Pt/2),nn={key:pe[qt],data:Je[qt],parent:he};return nn.left=p(nn,pe,Je,Tt,qt),nn.right=p(nn,pe,Je,qt+1,zt),nn}return null}function v(he,pe,Je,Tt,zt){if(!(Je>=Tt)){for(var Pt=he[Je+Tt>>1],qt=Je-1,nn=Tt+1;;){do qt++;while(zt(he[qt],Pt)<0);do nn--;while(zt(he[nn],Pt)>0);if(qt>=nn)break;var kn=he[qt];he[qt]=he[nn],he[nn]=kn,kn=pe[qt],pe[qt]=pe[nn],pe[nn]=kn}v(he,pe,Je,nn,zt),v(he,pe,nn+1,Tt,zt)}}c.prototype.rotateLeft=function(he){var pe=he.right;pe&&(he.right=pe.left,pe.left&&(pe.left.parent=he),pe.parent=he.parent),he.parent?he===he.parent.left?he.parent.left=pe:he.parent.right=pe:this._root=pe,pe&&(pe.left=he),he.parent=pe},c.prototype.rotateRight=function(he){var pe=he.left;pe&&(he.left=pe.right,pe.right&&(pe.right.parent=he),pe.parent=he.parent),he.parent?he===he.parent.left?he.parent.left=pe:he.parent.right=pe:this._root=pe,pe&&(pe.right=he),he.parent=pe},c.prototype._splay=function(he){for(;he.parent;){var pe=he.parent;pe.parent?pe.left===he&&pe.parent.left===pe?(this.rotateRight(pe.parent),this.rotateRight(pe)):pe.right===he&&pe.parent.right===pe?(this.rotateLeft(pe.parent),this.rotateLeft(pe)):pe.left===he&&pe.parent.right===pe?(this.rotateRight(pe),this.rotateLeft(pe)):(this.rotateLeft(pe),this.rotateRight(pe)):pe.left===he?this.rotateRight(pe):this.rotateLeft(pe)}},c.prototype.splay=function(he){for(var pe,Je,Tt,zt,Pt;he.parent;)(Je=(pe=he.parent).parent)&&Je.parent?((Tt=Je.parent).left===Je?Tt.left=he:Tt.right=he,he.parent=Tt):(he.parent=null,this._root=he),zt=he.left,Pt=he.right,he===pe.left?(Je&&(Je.left===pe?(pe.right?(Je.left=pe.right,Je.left.parent=Je):Je.left=null,pe.right=Je,Je.parent=pe):(zt?(Je.right=zt,zt.parent=Je):Je.right=null,he.left=Je,Je.parent=he)),Pt?(pe.left=Pt,Pt.parent=pe):pe.left=null,he.right=pe,pe.parent=he):(Je&&(Je.right===pe?(pe.left?(Je.right=pe.left,Je.right.parent=Je):Je.right=null,pe.left=Je,Je.parent=pe):(Pt?(Je.left=Pt,Pt.parent=Je):Je.left=null,he.right=Je,Je.parent=he)),zt?(pe.right=zt,zt.parent=pe):pe.right=null,he.left=pe,pe.parent=he)},c.prototype.replace=function(he,pe){he.parent?he===he.parent.left?he.parent.left=pe:he.parent.right=pe:this._root=pe,pe&&(pe.parent=he.parent)},c.prototype.minNode=function(he){if(he===void 0&&(he=this._root),he)for(;he.left;)he=he.left;return he},c.prototype.maxNode=function(he){if(he===void 0&&(he=this._root),he)for(;he.right;)he=he.right;return he},c.prototype.insert=function(he,pe){var Je=this._root,Tt=null,zt=this._compare;if(this._noDuplicates)for(;Je;){if(Tt=Je,zt(Je.key,he)===0)return;Je=zt(Je.key,he)<0?Je.right:Je.left}else for(;Je;)Tt=Je,Je=zt(Je.key,he)<0?Je.right:Je.left;return Je={key:he,data:pe,left:null,right:null,parent:Tt},Tt?zt(Tt.key,Je.key)<0?Tt.right=Je:Tt.left=Je:this._root=Je,this.splay(Je),this._size++,Je},c.prototype.find=function(he){for(var pe=this._root,Je=this._compare;pe;){var Tt=Je(pe.key,he);if(Tt<0)pe=pe.right;else{if(!(Tt>0))return pe;pe=pe.left}}return null},c.prototype.contains=function(he){for(var pe=this._root,Je=this._compare;pe;){var Tt=Je(he,pe.key);if(Tt===0)return!0;pe=Tt<0?pe.left:pe.right}return!1},c.prototype.remove=function(he){var pe=this.find(he);if(!pe)return!1;if(this.splay(pe),pe.left)if(pe.right){var Je=this.minNode(pe.right);Je.parent!==pe&&(this.replace(Je,Je.right),Je.right=pe.right,Je.right.parent=Je),this.replace(pe,Je),Je.left=pe.left,Je.left.parent=Je}else this.replace(pe,pe.left);else this.replace(pe,pe.right);return this._size--,!0},c.prototype.removeNode=function(he){if(!he)return!1;if(this.splay(he),he.left)if(he.right){var pe=this.minNode(he.right);pe.parent!==he&&(this.replace(pe,pe.right),pe.right=he.right,pe.right.parent=pe),this.replace(he,pe),pe.left=he.left,pe.left.parent=pe}else this.replace(he,he.left);else this.replace(he,he.right);return this._size--,!0},c.prototype.erase=function(he){var pe=this.find(he);if(pe){this.splay(pe);var Je=pe.left,Tt=pe.right,zt=null;Je&&(Je.parent=null,zt=this.maxNode(Je),this.splay(zt),this._root=zt),Tt&&(Je?zt.right=Tt:this._root=Tt,Tt.parent=zt),this._size--}},c.prototype.pop=function(){var he=this._root,pe=null;if(he){for(;he.left;)he=he.left;pe={key:he.key,data:he.data},this.remove(he.key)}return pe},c.prototype.next=function(he){var pe=he;if(pe)if(pe.right)for(pe=pe.right;pe&&pe.left;)pe=pe.left;else for(pe=he.parent;pe&&pe.right===he;)he=pe,pe=pe.parent;return pe},c.prototype.prev=function(he){var pe=he;if(pe)if(pe.left)for(pe=pe.left;pe&&pe.right;)pe=pe.right;else for(pe=he.parent;pe&&pe.left===he;)he=pe,pe=pe.parent;return pe},c.prototype.forEach=function(he){for(var pe=this._root,Je=[],Tt=!1,zt=0;!Tt;)pe?(Je.push(pe),pe=pe.left):Je.length>0?(he(pe=Je.pop(),zt++),pe=pe.right):Tt=!0;return this},c.prototype.range=function(he,pe,Je,Tt){for(var zt=[],Pt=this._compare,qt=this._root;zt.length!==0||qt;)if(qt)zt.push(qt),qt=qt.left;else{if(Pt((qt=zt.pop()).key,pe)>0)break;if(Pt(qt.key,he)>=0&&Je.call(Tt,qt))return this;qt=qt.right}return this},c.prototype.keys=function(){for(var he=this._root,pe=[],Je=[],Tt=!1;!Tt;)he?(pe.push(he),he=he.left):pe.length>0?(he=pe.pop(),Je.push(he.key),he=he.right):Tt=!0;return Je},c.prototype.values=function(){for(var he=this._root,pe=[],Je=[],Tt=!1;!Tt;)he?(pe.push(he),he=he.left):pe.length>0?(he=pe.pop(),Je.push(he.data),he=he.right):Tt=!0;return Je},c.prototype.at=function(he){for(var pe=this._root,Je=[],Tt=!1,zt=0;!Tt;)if(pe)Je.push(pe),pe=pe.left;else if(Je.length>0){if(pe=Je.pop(),zt===he)return pe;zt++,pe=pe.right}else Tt=!0;return null},c.prototype.load=function(he,pe,Je){if(he===void 0&&(he=[]),pe===void 0&&(pe=[]),Je===void 0&&(Je=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var Tt=he.length;return Je&&v(he,pe,0,Tt-1,this._compare),this._root=p(null,he,pe,0,Tt),this._size=Tt,this},c.prototype.min=function(){var he=this.minNode(this._root);return he?he.key:null},c.prototype.max=function(){var he=this.maxNode(this._root);return he?he.key:null},c.prototype.isEmpty=function(){return this._root===null},d.size.get=function(){return this._size},c.createTree=function(he,pe,Je,Tt,zt){return new c(Je,zt).load(he,pe,Tt)},Object.defineProperties(c.prototype,d);var w=0,S=1,I=2,C=3,R=0,B=1,N=2,$=3;function X(he,pe,Je){pe===null?(he.inOut=!1,he.otherInOut=!0):(he.isSubject===pe.isSubject?(he.inOut=!pe.inOut,he.otherInOut=pe.otherInOut):(he.inOut=!pe.otherInOut,he.otherInOut=pe.isVertical()?!pe.inOut:pe.inOut),pe&&(he.prevInResult=!K(pe,Je)||pe.isVertical()?pe.prevInResult:pe));var Tt=K(he,Je);he.resultTransition=Tt?function(zt,Pt){var qt,nn=!zt.inOut,kn=!zt.otherInOut;switch(Pt){case R:qt=nn&&kn;break;case B:qt=nn||kn;break;case $:qt=nn^kn;break;case N:qt=zt.isSubject?nn&&!kn:kn&&!nn}return qt?1:-1}(he,Je):0}function K(he,pe){switch(he.type){case w:switch(pe){case R:return!he.otherInOut;case B:return he.otherInOut;case N:return he.isSubject&&he.otherInOut||!he.isSubject&&!he.otherInOut;case $:return!0}break;case I:return pe===R||pe===B;case C:return pe===N;case S:return!1}return!1}var le=function(he,pe,Je,Tt,zt){this.left=pe,this.point=he,this.otherEvent=Je,this.isSubject=Tt,this.type=zt||w,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},re={inResult:{configurable:!0}};function G(he,pe){return he[0]===pe[0]&&he[1]===pe[1]}le.prototype.isBelow=function(he){var pe=this.point,Je=this.otherEvent.point;return this.left?(pe[0]-he[0])*(Je[1]-he[1])-(Je[0]-he[0])*(pe[1]-he[1])>0:(Je[0]-he[0])*(pe[1]-he[1])-(pe[0]-he[0])*(Je[1]-he[1])>0},le.prototype.isAbove=function(he){return!this.isBelow(he)},le.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},re.inResult.get=function(){return this.resultTransition!==0},le.prototype.clone=function(){var he=new le(this.point,this.left,this.otherEvent,this.isSubject,this.type);return he.contourId=this.contourId,he.resultTransition=this.resultTransition,he.prevInResult=this.prevInResult,he.isExteriorRing=this.isExteriorRing,he.inOut=this.inOut,he.otherInOut=this.otherInOut,he},Object.defineProperties(le.prototype,re);var ne=11102230246251565e-32,ae=134217729,de=(3+8*ne)*ne;function be(he,pe,Je,Tt,zt){var Pt,qt,nn,kn,On=pe[0],wn=Tt[0],ri=0,yi=0;wn>On==wn>-On?(Pt=On,On=pe[++ri]):(Pt=wn,wn=Tt[++yi]);var Fn=0;if(ri<he&&yi<Je)for(wn>On==wn>-On?(nn=Pt-((qt=On+Pt)-On),On=pe[++ri]):(nn=Pt-((qt=wn+Pt)-wn),wn=Tt[++yi]),Pt=qt,nn!==0&&(zt[Fn++]=nn);ri<he&&yi<Je;)wn>On==wn>-On?(nn=Pt-((qt=Pt+On)-(kn=qt-Pt))+(On-kn),On=pe[++ri]):(nn=Pt-((qt=Pt+wn)-(kn=qt-Pt))+(wn-kn),wn=Tt[++yi]),Pt=qt,nn!==0&&(zt[Fn++]=nn);for(;ri<he;)nn=Pt-((qt=Pt+On)-(kn=qt-Pt))+(On-kn),On=pe[++ri],Pt=qt,nn!==0&&(zt[Fn++]=nn);for(;yi<Je;)nn=Pt-((qt=Pt+wn)-(kn=qt-Pt))+(wn-kn),wn=Tt[++yi],Pt=qt,nn!==0&&(zt[Fn++]=nn);return Pt===0&&Fn!==0||(zt[Fn++]=Pt),Fn}function Ie(he){return new Float64Array(he)}var Me=33306690738754716e-32,ke=22204460492503146e-32,Ye=11093356479670487e-47,ft=Ie(4),at=Ie(8),ht=Ie(12),_t=Ie(16),We=Ie(4);function ct(he,pe,Je){var Tt=function(zt,Pt,qt,nn,kn,On){var wn=(Pt-On)*(qt-kn),ri=(zt-kn)*(nn-On),yi=wn-ri;if(wn===0||ri===0||wn>0!=ri>0)return yi;var Fn=Math.abs(wn+ri);return Math.abs(yi)>=Me*Fn?yi:-function(ji,Ai,ei,Ki,Mi,vi,Ii){var oi,Mn,ci,$i,tn,jn,Ci,Wi,Di,dr,fi,sr,vo,Br,kr,xo,Oa,pr,xr=ji-Mi,Nr=ei-Mi,to=Ai-vi,qr=Ki-vi;ft[0]=(kr=(Wi=xr-(Ci=(jn=ae*xr)-(jn-xr)))*(dr=qr-(Di=(jn=ae*qr)-(jn-qr)))-((Br=xr*qr)-Ci*Di-Wi*Di-Ci*dr))-((fi=kr-(Oa=(Wi=to-(Ci=(jn=ae*to)-(jn-to)))*(dr=Nr-(Di=(jn=ae*Nr)-(jn-Nr)))-((xo=to*Nr)-Ci*Di-Wi*Di-Ci*dr)))+(tn=kr-fi))+(tn-Oa),ft[1]=(vo=Br-((sr=Br+fi)-(tn=sr-Br))+(fi-tn))-((fi=vo-xo)+(tn=vo-fi))+(tn-xo),ft[2]=sr-((pr=sr+fi)-(tn=pr-sr))+(fi-tn),ft[3]=pr;var Vc=function(tW,jI){for(var $I=jI[0],zb=1;zb<4;zb++)$I+=jI[zb];return $I}(0,ft),Bm=ke*Ii;if(Vc>=Bm||-Vc>=Bm||(oi=ji-(xr+(tn=ji-xr))+(tn-Mi),ci=ei-(Nr+(tn=ei-Nr))+(tn-Mi),Mn=Ai-(to+(tn=Ai-to))+(tn-vi),$i=Ki-(qr+(tn=Ki-qr))+(tn-vi),oi===0&&Mn===0&&ci===0&&$i===0)||(Bm=Ye*Ii+de*Math.abs(Vc),(Vc+=xr*$i+qr*oi-(to*ci+Nr*Mn))>=Bm||-Vc>=Bm))return Vc;We[0]=(kr=(Wi=oi-(Ci=(jn=ae*oi)-(jn-oi)))*(dr=qr-(Di=(jn=ae*qr)-(jn-qr)))-((Br=oi*qr)-Ci*Di-Wi*Di-Ci*dr))-((fi=kr-(Oa=(Wi=Mn-(Ci=(jn=ae*Mn)-(jn-Mn)))*(dr=Nr-(Di=(jn=ae*Nr)-(jn-Nr)))-((xo=Mn*Nr)-Ci*Di-Wi*Di-Ci*dr)))+(tn=kr-fi))+(tn-Oa),We[1]=(vo=Br-((sr=Br+fi)-(tn=sr-Br))+(fi-tn))-((fi=vo-xo)+(tn=vo-fi))+(tn-xo),We[2]=sr-((pr=sr+fi)-(tn=pr-sr))+(fi-tn),We[3]=pr;var $4=be(4,ft,4,We,at);We[0]=(kr=(Wi=xr-(Ci=(jn=ae*xr)-(jn-xr)))*(dr=$i-(Di=(jn=ae*$i)-(jn-$i)))-((Br=xr*$i)-Ci*Di-Wi*Di-Ci*dr))-((fi=kr-(Oa=(Wi=to-(Ci=(jn=ae*to)-(jn-to)))*(dr=ci-(Di=(jn=ae*ci)-(jn-ci)))-((xo=to*ci)-Ci*Di-Wi*Di-Ci*dr)))+(tn=kr-fi))+(tn-Oa),We[1]=(vo=Br-((sr=Br+fi)-(tn=sr-Br))+(fi-tn))-((fi=vo-xo)+(tn=vo-fi))+(tn-xo),We[2]=sr-((pr=sr+fi)-(tn=pr-sr))+(fi-tn),We[3]=pr;var G4=be($4,at,4,We,ht);We[0]=(kr=(Wi=oi-(Ci=(jn=ae*oi)-(jn-oi)))*(dr=$i-(Di=(jn=ae*$i)-(jn-$i)))-((Br=oi*$i)-Ci*Di-Wi*Di-Ci*dr))-((fi=kr-(Oa=(Wi=Mn-(Ci=(jn=ae*Mn)-(jn-Mn)))*(dr=ci-(Di=(jn=ae*ci)-(jn-ci)))-((xo=Mn*ci)-Ci*Di-Wi*Di-Ci*dr)))+(tn=kr-fi))+(tn-Oa),We[1]=(vo=Br-((sr=Br+fi)-(tn=sr-Br))+(fi-tn))-((fi=vo-xo)+(tn=vo-fi))+(tn-xo),We[2]=sr-((pr=sr+fi)-(tn=pr-sr))+(fi-tn),We[3]=pr;var q4=be(G4,ht,4,We,_t);return _t[q4-1]}(zt,Pt,qt,nn,kn,On,Fn)}(he[0],he[1],pe[0],pe[1],Je[0],Je[1]);return Tt>0?-1:Tt<0?1:0}function Ge(he,pe){var Je=he.point,Tt=pe.point;return Je[0]>Tt[0]?1:Je[0]<Tt[0]?-1:Je[1]!==Tt[1]?Je[1]>Tt[1]?1:-1:function(zt,Pt,qt,nn){return zt.left!==Pt.left?zt.left?1:-1:ct(qt,zt.otherEvent.point,Pt.otherEvent.point)!==0?zt.isBelow(Pt.otherEvent.point)?-1:1:!zt.isSubject&&Pt.isSubject?1:-1}(he,pe,Je)}function Xe(he,pe,Je){var Tt=new le(pe,!1,he,he.isSubject),zt=new le(pe,!0,he.otherEvent,he.isSubject);return G(he.point,he.otherEvent.point)&&console.warn("what is that, a collapsed segment?",he),Tt.contourId=zt.contourId=he.contourId,Ge(zt,he.otherEvent)>0&&(he.otherEvent.left=!0,zt.left=!1),he.otherEvent.otherEvent=zt,he.otherEvent=Tt,Je.push(zt),Je.push(Tt),Je}function yt(he,pe){return he[0]*pe[1]-he[1]*pe[0]}function vt(he,pe){return he[0]*pe[0]+he[1]*pe[1]}function Wt(he,pe,Je){var Tt=function(kn,On,wn,ri,yi){var Fn=[On[0]-kn[0],On[1]-kn[1]],ji=[ri[0]-wn[0],ri[1]-wn[1]];function Ai(jn,Ci,Wi){return[jn[0]+Ci*Wi[0],jn[1]+Ci*Wi[1]]}var ei=[wn[0]-kn[0],wn[1]-kn[1]],Ki=yt(Fn,ji),Mi=Ki*Ki,vi=vt(Fn,Fn);if(Mi>0){var Ii=yt(ei,ji)/Ki;if(Ii<0||Ii>1)return null;var oi=yt(ei,Fn)/Ki;return oi<0||oi>1?null:Ii===0||Ii===1?[Ai(kn,Ii,Fn)]:oi===0||oi===1?[Ai(wn,oi,ji)]:[Ai(kn,Ii,Fn)]}if((Mi=(Ki=yt(ei,Fn))*Ki)>0)return null;var Mn=vt(Fn,ei)/vi,ci=Mn+vt(Fn,ji)/vi,$i=Math.min(Mn,ci),tn=Math.max(Mn,ci);return $i<=1&&tn>=0?$i===1?[Ai(kn,$i>0?$i:0,Fn)]:tn===0?[Ai(kn,tn<1?tn:1,Fn)]:[Ai(kn,$i>0?$i:0,Fn),Ai(kn,tn<1?tn:1,Fn)]:null}(he.point,he.otherEvent.point,pe.point,pe.otherEvent.point),zt=Tt?Tt.length:0;if(zt===0||zt===1&&(G(he.point,pe.point)||G(he.otherEvent.point,pe.otherEvent.point))||zt===2&&he.isSubject===pe.isSubject)return 0;if(zt===1)return G(he.point,Tt[0])||G(he.otherEvent.point,Tt[0])||Xe(he,Tt[0],Je),G(pe.point,Tt[0])||G(pe.otherEvent.point,Tt[0])||Xe(pe,Tt[0],Je),1;var Pt=[],qt=!1,nn=!1;return G(he.point,pe.point)?qt=!0:Ge(he,pe)===1?Pt.push(pe,he):Pt.push(he,pe),G(he.otherEvent.point,pe.otherEvent.point)?nn=!0:Ge(he.otherEvent,pe.otherEvent)===1?Pt.push(pe.otherEvent,he.otherEvent):Pt.push(he.otherEvent,pe.otherEvent),qt&&nn||qt?(pe.type=S,he.type=pe.inOut===he.inOut?I:C,qt&&!nn&&Xe(Pt[1].otherEvent,Pt[0].point,Je),2):nn?(Xe(Pt[0],Pt[1].point,Je),3):Pt[0]!==Pt[3].otherEvent?(Xe(Pt[0],Pt[1].point,Je),Xe(Pt[1],Pt[2].point,Je),3):(Xe(Pt[0],Pt[1].point,Je),Xe(Pt[3].otherEvent,Pt[2].point,Je),3)}function Nt(he,pe){if(he===pe)return 0;if(ct(he.point,he.otherEvent.point,pe.point)!==0||ct(he.point,he.otherEvent.point,pe.otherEvent.point)!==0)return G(he.point,pe.point)?he.isBelow(pe.otherEvent.point)?-1:1:he.point[0]===pe.point[0]?he.point[1]<pe.point[1]?-1:1:Ge(he,pe)===1?pe.isAbove(he.point)?-1:1:he.isBelow(pe.point)?-1:1;if(he.isSubject!==pe.isSubject)return he.isSubject?-1:1;var Je=he.point,Tt=pe.point;return Je[0]===Tt[0]&&Je[1]===Tt[1]?(Je=he.otherEvent.point)[0]===(Tt=pe.otherEvent.point)[0]&&Je[1]===Tt[1]?0:he.contourId>pe.contourId?1:-1:Ge(he,pe)===1?1:-1}var Mt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function gt(he,pe,Je,Tt){var zt,Pt=he+1,qt=pe[he].point,nn=pe.length;for(Pt<nn&&(zt=pe[Pt].point);Pt<nn&&zt[0]===qt[0]&&zt[1]===qt[1];){if(!Je[Pt])return Pt;++Pt<nn&&(zt=pe[Pt].point)}for(Pt=he-1;Je[Pt]&&Pt>Tt;)Pt--;return Pt}Mt.prototype.isExterior=function(){return this.holeOf==null};var ln=Gt,$t=Gt;function Gt(he,pe){if(!(this instanceof Gt))return new Gt(he,pe);if(this.data=he||[],this.length=this.data.length,this.compare=pe||on,this.length>0)for(var Je=(this.length>>1)-1;Je>=0;Je--)this._down(Je)}function on(he,pe){return he<pe?-1:he>pe?1:0}Gt.prototype={push:function(he){this.data.push(he),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var he=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),he}},peek:function(){return this.data[0]},_up:function(he){for(var pe=this.data,Je=this.compare,Tt=pe[he];he>0;){var zt=he-1>>1,Pt=pe[zt];if(Je(Tt,Pt)>=0)break;pe[he]=Pt,he=zt}pe[he]=Tt},_down:function(he){for(var pe=this.data,Je=this.compare,Tt=this.length>>1,zt=pe[he];he<Tt;){var Pt=1+(he<<1),qt=Pt+1,nn=pe[Pt];if(qt<this.length&&Je(pe[qt],nn)<0&&(Pt=qt,nn=pe[qt]),Je(nn,zt)>=0)break;pe[he]=nn,he=Pt}pe[he]=zt}},ln.default=$t;var mn=Math.max,gn=Math.min,Cn=0;function Sn(he,pe,Je,Tt,zt,Pt){var qt,nn,kn,On,wn,ri;for(qt=0,nn=he.length-1;qt<nn;qt++)if(On=he[qt+1],wn=new le(kn=he[qt],!1,void 0,pe),ri=new le(On,!1,wn,pe),wn.otherEvent=ri,kn[0]!==On[0]||kn[1]!==On[1]){wn.contourId=ri.contourId=Je,Pt||(wn.isExteriorRing=!1,ri.isExteriorRing=!1),Ge(wn,ri)>0?ri.left=!0:wn.left=!0;var yi=kn[0],Fn=kn[1];zt[0]=gn(zt[0],yi),zt[1]=gn(zt[1],Fn),zt[2]=mn(zt[2],yi),zt[3]=mn(zt[3],Fn),Tt.push(wn),Tt.push(ri)}}var bn=[];function hi(he,pe,Je){typeof he[0][0][0]=="number"&&(he=[he]),typeof pe[0][0][0]=="number"&&(pe=[pe]);var Tt=function(Fn,ji,Ai){var ei=null;return Fn.length*ji.length==0&&(Ai===R?ei=bn:Ai===N?ei=Fn:Ai!==B&&Ai!==$||(ei=Fn.length===0?ji:Fn)),ei}(he,pe,Je);if(Tt)return Tt===bn?null:Tt;var zt=[1/0,1/0,-1/0,-1/0],Pt=[1/0,1/0,-1/0,-1/0],qt=function(Fn,ji,Ai,ei,Ki){var Mi,vi,Ii,oi,Mn,ci,$i=new ln(null,Ge);for(Ii=0,oi=Fn.length;Ii<oi;Ii++)for(Mn=0,ci=(Mi=Fn[Ii]).length;Mn<ci;Mn++)(vi=Mn===0)&&Cn++,Sn(Mi[Mn],!0,Cn,$i,Ai,vi);for(Ii=0,oi=ji.length;Ii<oi;Ii++)for(Mn=0,ci=(Mi=ji[Ii]).length;Mn<ci;Mn++)vi=Mn===0,Ki===N&&(vi=!1),vi&&Cn++,Sn(Mi[Mn],!1,Cn,$i,ei,vi);return $i}(he,pe,zt,Pt,Je);if(Tt=function(Fn,ji,Ai,ei,Ki){var Mi=null;return(Ai[0]>ei[2]||ei[0]>Ai[2]||Ai[1]>ei[3]||ei[1]>Ai[3])&&(Ki===R?Mi=bn:Ki===N?Mi=Fn:Ki!==B&&Ki!==$||(Mi=Fn.concat(ji))),Mi}(he,pe,zt,Pt,Je))return Tt===bn?null:Tt;for(var nn=function(Fn){var ji,Ai,ei=function(Ii){var oi,Mn,ci,$i,tn=[];for(Mn=0,ci=Ii.length;Mn<ci;Mn++)((oi=Ii[Mn]).left&&oi.inResult||!oi.left&&oi.otherEvent.inResult)&&tn.push(oi);for(var jn=!1;!jn;)for(jn=!0,Mn=0,ci=tn.length;Mn<ci;Mn++)Mn+1<ci&&Ge(tn[Mn],tn[Mn+1])===1&&($i=tn[Mn],tn[Mn]=tn[Mn+1],tn[Mn+1]=$i,jn=!1);for(Mn=0,ci=tn.length;Mn<ci;Mn++)(oi=tn[Mn]).otherPos=Mn;for(Mn=0,ci=tn.length;Mn<ci;Mn++)(oi=tn[Mn]).left||($i=oi.otherPos,oi.otherPos=oi.otherEvent.otherPos,oi.otherEvent.otherPos=$i);return tn}(Fn),Ki={},Mi=[],vi=function(){if(!Ki[ji]){var Ii=Mi.length,oi=function(tn,jn,Ci){var Wi=new Mt;if(tn.prevInResult!=null){var Di=tn.prevInResult,dr=Di.outputContourId;if(Di.resultTransition>0){var fi=jn[dr];if(fi.holeOf!=null){var sr=fi.holeOf;jn[sr].holeIds.push(Ci),Wi.holeOf=sr,Wi.depth=jn[dr].depth}else jn[dr].holeIds.push(Ci),Wi.holeOf=dr,Wi.depth=jn[dr].depth+1}else Wi.holeOf=null,Wi.depth=jn[dr].depth}else Wi.holeOf=null,Wi.depth=0;return Wi}(ei[ji],Mi,Ii),Mn=function(tn){Ki[tn]=!0,tn<ei.length&&ei[tn]&&(ei[tn].outputContourId=Ii)},ci=ji,$i=ji;for(oi.points.push(ei[ji].point);Mn(ci),Mn(ci=ei[ci].otherPos),oi.points.push(ei[ci].point),!((ci=gt(ci,ei,Ki,$i))==$i||ci>=ei.length)&&ei[ci];);Mi.push(oi)}};for(ji=0,Ai=ei.length;ji<Ai;ji++)vi();return Mi}(function(Fn,ji,Ai,ei,Ki,Mi){for(var vi,Ii,oi,Mn=new c(Nt),ci=[],$i=Math.min(ei[2],Ki[2]);Fn.length!==0;){var tn=Fn.pop();if(ci.push(tn),Mi===R&&tn.point[0]>$i||Mi===N&&tn.point[0]>ei[2])break;if(tn.left){Ii=vi=Mn.insert(tn),vi=vi!==(oi=Mn.minNode())?Mn.prev(vi):null,Ii=Mn.next(Ii);var jn=vi?vi.key:null;if(X(tn,jn,Mi),Ii&&Wt(tn,Ii.key,Fn)===2&&(X(tn,jn,Mi),X(Ii.key,tn,Mi)),vi&&Wt(vi.key,tn,Fn)===2){var Ci=vi;X(jn,(Ci=Ci!==oi?Mn.prev(Ci):null)?Ci.key:null,Mi),X(tn,jn,Mi)}}else Ii=vi=Mn.find(tn=tn.otherEvent),vi&&Ii&&(vi=vi!==oi?Mn.prev(vi):null,Ii=Mn.next(Ii),Mn.remove(tn),Ii&&vi&&Wt(vi.key,Ii.key,Fn))}return ci}(qt,0,0,zt,Pt,Je)),kn=[],On=0;On<nn.length;On++){var wn=nn[On];if(wn.isExterior()){for(var ri=[wn.points],yi=0;yi<wn.holeIds.length;yi++)ri.push(nn[wn.holeIds[yi]].points);kn.push(ri)}}return kn}var Ei={UNION:B,DIFFERENCE:N,INTERSECTION:R,XOR:$};i.diff=function(he,pe){return hi(he,pe,N)},i.intersection=function(he,pe){return hi(he,pe,R)},i.operations=Ei,i.union=function(he,pe){return hi(he,pe,B)},i.xor=function(he,pe){return hi(he,pe,$)},Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,FS.exports)),FS.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function c0(o,e,i,l){const c=[],d=l===0?(p,v,w,S,I,C)=>{p.push(new St(C,w+(C-v)/(S-v)*(I-w)))}:(p,v,w,S,I,C)=>{p.push(new St(v+(C-w)/(I-w)*(S-v),C))};for(const p of o){const v=[];for(const w of p){if(w.length<=2)continue;const S=[];for(let R=0;R<w.length-1;R++){const B=w[R].x,N=w[R].y,$=w[R+1].x,X=w[R+1].y,K=l===0?B:N,le=l===0?$:X;K<e?le>e&&d(S,B,N,$,X,e):K>i?le<i&&d(S,B,N,$,X,i):S.push(w[R]),le<e&&K>=e&&d(S,B,N,$,X,e),le>i&&K<=i&&d(S,B,N,$,X,i)}let I=w[w.length-1];const C=l===0?I.x:I.y;C>=e&&C<=i&&S.push(I),S.length&&(I=S[S.length-1],S[0].x===I.x&&S[0].y===I.y||S.push(S[0]),v.push(S))}v.length&&c.push(v)}return c}function s5(o,e){const i=M1(o),l=M1([e]),c=BS.intersection(i,l);return c==null?[]:NS(c)}function a5(o,e){let l=M1(o,65536);for(;e.valid();e.next()){const[c,d]=e.get(),p=c.x*65536,v=c.y*65536,w=d.x*65536,S=d.y*65536,I=w-p,C=S-v,R=Math.hypot(I,C),B=Math.trunc(C/R*3),N=-Math.trunc(I/R*3);l=BS.diff(l,[[[p,v],[w,S],[w+B,S+N],[p+B,v+N],[p,v]]])}return NS(l,1/65536)}function M1(o,e=1){return[o.map(i=>i.map(l=>[l.x*e,l.y*e]))]}function NS(o,e=1){return o.map(i=>i.map((l,c)=>{const d=l.map(p=>new St(p[0]*e,p[1]*e).round());return c>0&&d.reverse(),d}))}class C1{constructor(e,i){this.layoutVertexArray=new Ks,this.indexArray=new wr,this.lineIndexArray=new Pa,this.triangleSegments=new Ui,this.lineSegments=new Ui,this.programConfigurations=new Il(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Tc)}update(e,i,l,c,d,p,v){this.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,jL.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,$L.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,l,c,d,p){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,l,c,d,p)}}class P1{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new C1(e,!1),this.elevationBufferData=new C1(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(e,i){}populate(e,i,l,c){this.hasPattern=b1("fill",this.layers,this.pixelRatio,i);const d=this.layers[0].layout.get("fill-sort-key"),p=[];for(const{feature:v,id:w,index:S,sourceLayerIndex:I}of e){const C=this.layers[0]._featureFilter.needGeometry,R=Xt(v,C);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),R,l))continue;const B=d?d.evaluate(R,{},l,i.availableImages):void 0,N={id:w,properties:v.properties,type:v.type,sourceLayerIndex:I,index:S,geometry:C?R.geometry:Vt(v,l,c),patterns:{},sortKey:B};p.push(N)}d&&p.sort((v,w)=>v.sortKey-w.sortKey);for(const v of p){const{geometry:w,index:S,sourceLayerIndex:I}=v;if(this.hasPattern){const C=w1("fill",this.layers,v,this.zoom,this.pixelRatio,i);this.patternFeatures.push(C)}else this.addFeature(v,w,S,l,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[S].feature,w,S,I,this.index)}}update(e,i,l,c,d,p,v){this.bufferData.update(e,i,l,c,d,p,v),this.elevationBufferData.update(e,i,l,c,d,p,v)}addFeatures(e,i,l,c,d,p){for(const v of this.patternFeatures)this.addFeature(v,v.geometry,v.index,i,l,c,p,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,l,c,d,p=[],v,w){const S=a0(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,S,c,l,w):this.addGeometry(S,this.bufferData),this.bufferData.populatePaintArrays(e,l,d,p,c,v),this.elevationBufferData.populatePaintArrays(e,l,d,p,c,v)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e){this.elevatedStructures&&this.elevatedStructures.construct(e)}addElevatedRoadFeature(e,i,l,c,d){const p=new Array,v=I1.getElevationFeature(e,d);if(v){{const w=this.clipPolygonsToTile(i,1);w.length>0&&p.push({polygons:w,elevationFeature:v,elevationTileID:l})}for(const w of p)if(w.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Qo(w.elevationTileID));const I=w.elevationFeature.isTunnel();let C=0;e.properties.hasOwnProperty(zS)&&(C=+e.properties[zS]);for(const R of w.polygons)this.elevatedStructures.addPortalCandidates(w.elevationFeature.id,R,I,w.elevationFeature,C)}w.elevationFeature.constantHeight==null&&(w.polygons=this.prepareElevatedPolygons(w.polygons,w.elevationFeature,w.elevationTileID));const S=new LS(l,w.elevationTileID);this.addElevatedGeometry(w.polygons,S,w.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,c)}}else this.addGeometry(i,this.bufferData)}addElevatedGeometry(e,i,l,c,d){const p={elevation:l,elevationSampler:i,bias:c,index:d},[v,w]=this.addGeometry(e,this.elevationBufferData,p);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:v,max:w}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,v),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,w))}addGeometry(e,i,l){let c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,p=null;l&&(p=l.elevationSampler.constantElevation(l.elevation,l.bias),p!=null&&(c=p,d=p));const v=(w,S,I)=>{if(l!=null)if(S.push(w),p!=null)i.elevatedLayoutVertexArray.emplaceBack(p),I.push(p);else{const C=l.elevationSampler.pointElevation(w,l.elevation,l.bias);i.elevatedLayoutVertexArray.emplaceBack(C),I.push(C),c=Math.min(c,C),d=Math.max(d,C)}};for(const w of e){let S=0;for(const re of w)S+=re.length;const I=i.triangleSegments.prepareSegment(S,i.layoutVertexArray,i.indexArray),C=I.vertexLength,R=[],B=[],N=[],$=[],X=[],K=i.layoutVertexArray.length;for(const re of w){if(re.length===0)continue;re!==w[0]&&B.push(R.length/2);const G=i.lineSegments.prepareSegment(re.length,i.layoutVertexArray,i.lineIndexArray),ne=G.vertexLength;l&&X.push(i.layoutVertexArray.length-K),v(re[0],N,$),i.layoutVertexArray.emplaceBack(re[0].x,re[0].y),i.lineIndexArray.emplaceBack(ne+re.length-1,ne),R.push(re[0].x),R.push(re[0].y);for(let ae=1;ae<re.length;ae++)v(re[ae],N,$),i.layoutVertexArray.emplaceBack(re[ae].x,re[ae].y),i.lineIndexArray.emplaceBack(ne+ae-1,ne+ae),R.push(re[ae].x),R.push(re[ae].y);G.vertexLength+=re.length,G.primitiveLength+=re.length}const le=sm(R,B);for(let re=0;re<le.length;re+=3)i.indexArray.emplaceBack(C+le[re],C+le[re+1],C+le[re+2]);if(le.length>0&&l&&this.elevationMode==="hd-road-base"){const re=l.elevation.isTunnel(),G=l.elevation.safeArea,ne=this.elevatedStructures.addVertices(N,$);this.elevatedStructures.addTriangles(le,ne,re);const ae=X.length;if(ae>0){for(let de=0;de<ae-1;de++)this.elevatedStructures.addRenderableRing(l.index,X[de]+ne,X[de+1]-X[de],re,G);this.elevatedStructures.addRenderableRing(l.index,X[ae-1]+ne,N.length-X[ae-1],re,G)}}I.vertexLength+=S,I.primitiveLength+=le.length/3}return[c,d]}prepareElevatedPolygons(e,i,l){const c=1/Oe(l),d=[];for(const p of e){const v=a5(p,new DS(i,c));d.push(...v)}return d}clipPolygonsToTile(e,i){const l=-i,c=-i,d=At+i,p=At+i;let v=0;const w=[],S=[];for(;v<e.length;v++){const R=e[v],B=ap(R);(B.min.x>=l&&B.max.x<=d&&B.min.y>=c&&B.max.y<=p?w:S).push(R)}if(w.length===e.length)return e;const I=[new St(l,c),new St(d,c),new St(d,p),new St(l,p),new St(l,c)],C=w;for(const R of S)C.push(...s5(R,I));return C}}let VS,US,jS,$S;Ft(P1,"FillBucket",{omit:["layers","patternFeatures"]}),Ft(C1,"FillBufferData"),Ft(Qo,"ElevatedStructures");class z1{constructor(e,i,l,c){if(this.triangleCount=i.length/3,this.min=new St(0,0),this.max=new St(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[d,p]=[e[0].clone(),e[0].clone()];for(let C=1;C<e.length;++C){const R=e[C];d.x=Math.min(d.x,R.x),d.y=Math.min(d.y,R.y),p.x=Math.max(p.x,R.x),p.y=Math.max(p.y,R.y)}if(c){const C=Math.ceil(Math.max(p.x-d.x,p.y-d.y)/c);l=Math.max(l,C)}if(l===0)return;this.min=d,this.max=p;const v=this.max.sub(this.min);v.x=Math.max(v.x,1),v.y=Math.max(v.y,1);const w=Math.max(v.x,v.y)/l;this.cellsX=Math.max(1,Math.ceil(v.x/w)),this.cellsY=Math.max(1,Math.ceil(v.y/w)),this.xScale=1/w,this.yScale=1/w;const S=[];for(let C=0;C<this.triangleCount;C++){const R=e[i[3*C+0]].sub(this.min),B=e[i[3*C+1]].sub(this.min),N=e[i[3*C+2]].sub(this.min),$=La(Math.floor(Math.min(R.x,B.x,N.x)),this.xScale,this.cellsX),X=La(Math.floor(Math.max(R.x,B.x,N.x)),this.xScale,this.cellsX),K=La(Math.floor(Math.min(R.y,B.y,N.y)),this.yScale,this.cellsY),le=La(Math.floor(Math.max(R.y,B.y,N.y)),this.yScale,this.cellsY),re=new St(0,0),G=new St(0,0),ne=new St(0,0),ae=new St(0,0);for(let de=K;de<=le;++de){re.y=G.y=de*w,ne.y=ae.y=(de+1)*w;for(let be=$;be<=X;++be)re.x=ne.x=be*w,G.x=ae.x=(be+1)*w,(Oi(R,B,N,re,G,ae)||Oi(R,B,N,re,ae,ne))&&S.push({cellIdx:de*this.cellsX+be,triIdx:C})}}if(S.length===0)return;S.sort((C,R)=>C.cellIdx-R.cellIdx||C.triIdx-R.triIdx);let I=0;for(;I<S.length;){const C=S[I].cellIdx,R={start:this.payload.length,len:0};for(;I<S.length&&S[I].cellIdx===C;)++R.len,this.payload.push(S[I++].triIdx);this.cells[C]=R}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const l=La(e.x-this.min.x,this.xScale,this.cellsX),c=La(e.y-this.min.y,this.yScale,this.cellsY),d=this.cells[c*this.cellsX+l];if(d){this._lazyInitLookup();for(let p=0;p<d.len;p++){const v=this.payload[d.start+p],w=Math.floor(v/8),S=1<<v%8;if(!(this.lookup[w]&S)&&(this.lookup[w]|=S,i.push(v),i.length===this.triangleCount))return}}}query(e,i,l){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const c=La(e.x-this.min.x,this.xScale,this.cellsX),d=La(i.x-this.min.x,this.xScale,this.cellsX),p=La(e.y-this.min.y,this.yScale,this.cellsY),v=La(i.y-this.min.y,this.yScale,this.cellsY);for(let w=p;w<=v;w++)for(let S=c;S<=d;S++){const I=this.cells[w*this.cellsX+S];if(I)for(let C=0;C<I.len;C++){const R=this.payload[I.start+C],B=Math.floor(R/8),N=1<<R%8;if(!(this.lookup[B]&N)&&(this.lookup[B]|=N,l.push(R),l.length===this.triangleCount))return}}}}function La(o,e,i){return Math.max(0,Math.min(i-1,Math.floor(o*e)))}Ft(z1,"TriangleGridIndex");class GS{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[]}updateFootprints(e,i){for(const l of this.footprints)i.push({footprint:l,id:e})}populate(e,i,l,c){const d=[];for(const{feature:p,id:v,index:w,sourceLayerIndex:S}of e){const I=this.layers[0]._featureFilter.needGeometry,C=Xt(p,I);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),C,l))continue;const R={id:v,properties:p.properties,type:p.type,sourceLayerIndex:S,index:w,geometry:I?C.geometry:Vt(p,l,c),patterns:{}};d.push(R)}for(const p of d){const{geometry:v,index:w,sourceLayerIndex:S}=p;this.addFeature(p,v,w,l,{},i.availableImages,i.brightness),i.featureIndex.insert(e[w].feature,v,w,S,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,l,c,d,p,v){}destroy(){}addFeature(e,i,l,c,d,p=[],v){for(const w of a0(i,2)){const S=[],I=[],C=[],R=new St(1/0,1/0),B=new St(-1/0,-1/0);for(const X of w)if(X.length!==0){X!==w[0]&&C.push(I.length/2);for(let K=0;K<X.length;K++)I.push(X[K].x),I.push(X[K].y),S.push(X[K]),R.x=Math.min(R.x,X[K].x),R.y=Math.min(R.y,X[K].y),B.x=Math.max(B.x,X[K].x),B.y=Math.max(B.y,X[K].y)}const N=sm(I,C),$=new z1(S,N,8,256);this.footprints.push({vertices:S,indices:N,grid:$,min:R,max:B})}}}Ft(GS,"ClipBucket",{omit:["layers"]});const l5=Yn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),c5=Yn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),u5=Yn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),h5=Yn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),f5=Yn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),d5=Yn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:p5}=l5,u0=Number.MAX_SAFE_INTEGER;function qS(o,e,i,l){return o.order<e||o.order===u0||!(o.clipMask&i)||function(c,d){return d.length!==0&&d.find(p=>p===c)===void 0}(l,o.clipScope)}function h0(o,e){return o.x-e.x||o.y-e.y}function HS(o,e){return h0(o.min,e.min)===0&&h0(o.max,e.max)===0}function R1(o,e){return!(o.min.x>e.max.x||o.max.x<e.min.x||o.min.y>e.max.y||o.max.y<e.min.y)}function D1(o,e){if(o.length!==e.length)return!1;for(let i=0;i<o.length;i++)if(o[i].sourceId!==e[i].sourceId||!HS(o[i],e[i])||o[i].order!==e[i].order||o[i].clipMask!==e[i].clipMask||!$s(o[i].clipScope,e[i].clipScope))return!1;return!0}function ZS(o,e,i){const l=1/At,c=1/(1<<i.canonical.z),d=(e.x*l+i.canonical.x)*c+i.wrap,p=(e.y*l+i.canonical.y)*c;return{min:new St((o.x*l+i.canonical.x)*c+i.wrap,(o.y*l+i.canonical.y)*c),max:new St(d,p)}}function m5(o,e,i){const l=1<<i.canonical.z,c=((e.x-i.wrap)*l-i.canonical.x)*At,d=(e.y*l-i.canonical.y)*At;return{min:new St(((o.x-i.wrap)*l-i.canonical.x)*At,(o.y*l-i.canonical.y)*At),max:new St(c,d)}}function WS(o,e,i,l,c,d,p){const v=o.indices,w=o.vertices,S=[];for(let I=l;I<l+c;I+=3){const C=e[i[I+0]+d],R=e[i[I+1]+d],B=e[i[I+2]+d],N=Math.min(C.x,R.x,B.x),$=Math.max(C.x,R.x,B.x),X=Math.min(C.y,R.y,B.y),K=Math.max(C.y,R.y,B.y);S.length=0,o.grid.query(new St(N,X),new St($,K),S);for(let le=0;le<S.length;le++){const re=S[le];if(Oi(w[v[3*re+0]],w[v[3*re+1]],w[v[3*re+2]],C,R,B,p))return!0}}return!1}function XS(o,e,i,l){if(!o||!i)return!1;let c=o.vertices;if(!e.canonical.equals(l.canonical)||e.wrap!==l.wrap){if(i.vertices.length<o.vertices.length)return XS(i,l,o,e);const d=e.canonical,p=l.canonical,v=Math.pow(2,p.z-d.z);c=o.vertices.map(w=>new St((w.x+d.x*At)*v-p.x*At,(w.y+d.y*At)*v-p.y*At))}return WS(i,c,o.indices,0,o.indices.length,0,0)}function YS(o,e,i,l){const c=Math.pow(2,l.z-i.z);return new St((o+i.x*At)*c-l.x*At,(e+i.y*At)*c-l.y*At)}function KS(o,e){const i=[];e.grid.queryPoint(o,i);const l=e.indices,c=e.vertices;for(let d=0;d<i.length;d++){const p=i[d];if(li([c[l[3*p+0]],c[l[3*p+1]],c[l[3*p+2]]],o))return!0}return!1}const L1=[new St(0,0),new St(At,0),new St(At,At),new St(0,At)];function JS(o,e){const i=[];let l=[];if(!e||o.length<2)return[o];if(o.length===2)return Yi(o[0],o[1],L1)?[o]:[];for(let c=0;c<o.length+2;c++){const d=o[c%o.length],p=o[(c+1)%o.length],v=Yi(c===0?o[o.length-1]:o[(c-1)%o.length],d,L1),w=Yi(d,p,L1),S=v||w;S&&l.push(d),S&&w||l.length>0&&(l.length>1&&i.push(l),l=[])}return l.length>1&&i.push(l),i}const k1=Lc.VectorTileFeature.types,_5=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],g5=["fill-extrusion-flood-light-ground-radius"],y5=Math.pow(2,13),v5=Math.pow(2,15)-1,QS=new St(0,1),kc=2147483648;function hm(o,e,i,l,c,d,p,v){o.emplaceBack((e<<1)+p,(i<<1)+d,(Math.floor(l*y5)<<1)+c,Math.round(v))}function fm(o,e,i){o.emplaceBack(e.x*At,e.y*At,i?1:0)}function f0(o,e,i,l,c,d){o.emplaceBack(e.x,e.y,(i.x<<1)+l,(i.y<<1)+c,d)}function dm(o,e,i){o.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class eE{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class tE{constructor(){this.centroidXY=new St(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new St(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new St(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new St(this.max.x-this.min.x,this.max.y-this.min.y)}}class nE{constructor(){this.acc=new St(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,l){this.accCount++,this.acc._add(i);let c=!!this.borders;i.x<e.min.x?(e.min.x=i.x,c=!0):i.x>e.max.x&&(e.max.x=i.x,c=!0),i.y<e.min.y?(e.min.y=i.y,c=!0):i.y>e.max.y&&(e.max.y=i.y,c=!0),((i.x===0||i.x===At)&&i.x===l.x)!=((i.y===0||i.y===At)&&i.y===l.y)&&this.processBorderOverlap(i,l),c&&this.checkBorderIntersection(i,l)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Jt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>At!=e.x>At&&this.addBorderIntersection(1,Jt(i.y,e.y,(At-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Jt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>At!=e.y>At&&this.addBorderIntersection(3,Jt(i.x,e.x,(At-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const l=this.borders[e];i<l[0]&&(l[0]=i),i>l[1]&&(l[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const l=e.x===0?0:1;this.addBorderIntersection(l,i.y),this.addBorderIntersection(l,e.y)}else{const l=e.y===0?2:3;this.addBorderIntersection(l,i.x),this.addBorderIntersection(l,e.x)}}centroid(){return this.accCount===0?new St(0,0):new St(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function iE(o,e){const i=o.add(e)._unit(),l=ze(o.x*i.x+o.y*i.y,-1,1);var c,d,p;return c=Math.acos(l),Math.min(4,Math.max(-4,Math.tan(c)))/4*v5*((d=o).x*(p=e).y-d.y*p.x<0?-1:1)}const x5=[o=>o.x<0,o=>o.x>At,o=>o.y<0,o=>o.y>At];function b5(o,e,i,l){const c=[4];if(l===0)return c;i._mult(l);const d=o.sub(i),p=e.sub(i),v=[o,e,d,p];for(let w=0;w<4;w++)for(const S of v)if(x5[w](S)){c.push(w);break}return c}class rE{constructor(e){this.vertexArray=new qp,this.indexArray=new wr,this.programConfigurations=new Il(e.layers,{zoom:e.zoom,lut:e.lut},i=>g5.includes(i)),this._segments=new Ui,this.hiddenByLandmarkVertexArray=new Of,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ui}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,l,c=!1){const d=e.length;if(d>2){let p=Math.max(0,this._segments.get().length-1);const v=this._segments._prepareSegment(4*d,this.vertexArray.length,2*this._segmentToGroundQuads[p].length);let w;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{const S=e[0],I=e[1];w=iE(S.sub(e[d-1])._perp()._unit(),I.sub(S)._perp()._unit())}for(let S=0;S<d;S++){const I=S===d-1?0:S+1,C=e[S],R=e[I],B=e[I===d-1?0:I+1],N=R.sub(C)._perp()._unit(),$=iE(N,B.sub(R)._perp()._unit()),X=w,K=$;if(O1(C,R,i)||c&&aE(C,i)&&aE(R,i)){w=$;continue}const le=v.vertexLength;f0(this.vertexArray,C,R,1,1,X),f0(this.vertexArray,C,R,1,0,X),f0(this.vertexArray,C,R,0,1,K),f0(this.vertexArray,C,R,0,0,K),v.vertexLength+=4;const re=b5(C,R,N,l);for(const G of re)this._segmentToGroundQuads[p].push({id:le,region:G}),this._segmentToRegionTriCounts[p][G]+=2,v.primitiveLength+=2;w=$}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let l=0;l<i;l++)this._segmentToGroundQuads[l].sort((c,d)=>c.region-d.region);for(let l=0;l<i;l++){const c=this._segmentToGroundQuads[l],d=e[l],p=this._segmentToRegionTriCounts[l];p.reduce((w,S)=>w+S,0);let v=0;for(let w=0;w<=4;w++){const S=p[w];if(S!==0){let I=this.regionSegments[w];I||(I=this.regionSegments[w]=new Ui);const C={vertexOffset:d.vertexOffset,primitiveOffset:d.primitiveOffset+v,vertexLength:d.vertexLength,primitiveLength:S};I.get().push(C)}v+=S}for(let w=0;w<c.length;w++){const S=c[w].id;this.indexArray.emplaceBack(S,S+1,S+3),this.indexArray.emplaceBack(S,S+3,S+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,l,c,d,p){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,l,c,d,p)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,c5.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,l,c,d,p,v){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,l,c,d,p,v)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const l=e.flags&kc?1:0;for(let c=e.groundVertexArrayOffset;c<i;++c)this.hiddenByLandmarkVertexArray.emplace(c,l);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,f5.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class d0{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new wr,this.footprintVertices=new Ks,this.footprintSegments=[],this.layoutVertexArray=new Sl,this.centroidVertexArray=new Xg,this.wallVertexArray=new Kg,this.indexArray=new wr,this.programConfigurations=new Il(e.layers,{zoom:e.zoom,lut:e.lut},i=>_5.includes(i)),this.segments=new Ui,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new rE(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,i){}populate(e,i,l,c){this.features=[],this.hasPattern=b1("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Oe(l),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:d,id:p,index:v,sourceLayerIndex:w}of e){const S=this.layers[0]._featureFilter.needGeometry,I=Xt(d,S);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),I,l))continue;const C={id:p,sourceLayerIndex:w,index:v,geometry:S?I.geometry:Vt(d,l,c),properties:d.properties,type:d.type,patterns:{}},R=this.layoutVertexArray.length,B=k1[C.type]==="Polygon";if(this.hasPattern)this.features.push(w1("fill-extrusion",this.layers,C,this.zoom,this.pixelRatio,i));else if(this.wallMode)for(const N of C.geometry)for(const $ of JS(N,B))this.addFeature(C,[$],v,l,{},i.availableImages,c,i.brightness);else this.addFeature(C,C.geometry,v,l,{},i.availableImages,c,i.brightness);i.featureIndex.insert(d,C.geometry,v,w,this.index,R)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,l,c,d,p){for(const v of this.features){const w=k1[v.type]==="Polygon",{geometry:S}=v;if(this.wallMode)for(const I of S)for(const C of JS(I,w))this.addFeature(v,[C],v.index,i,l,c,d,p);else this.addFeature(v,S,v.index,i,l,c,d,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,l,c,d,p,v){this.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v),this.groundEffect.update(e,i,d,l,c,p,v)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,p5),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,h5.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,d5.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,u5.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,l,c,d,p,v,w){const S=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,I=[new St(0,0),new St(At,At)],C=v.projection,R=C.name==="globe",B=this.wallMode||k1[e.type]==="Polygon",N=new nE;N.centroidDataIndex=this.centroidData.length;const $=new tE,X=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},c)<=0,K=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},c);let le;if($.height=K,$.vertexArrayOffset=this.layoutVertexArray.length,$.groundVertexArrayOffset=this.groundEffect.vertexArray.length,R&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new El),this.wallMode){if(R)return void Dn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(i.length!==1)return;le=function(Me){const ke=Me[0].x===Me[Me.length-1].x&&Me[0].y===Me[Me.length-1].y;(function(Mt){let gt=0;const ln=Mt.length;for(let $t=0;$t<ln;$t++)gt+=(Mt[($t+1)%ln].x-Mt[$t].x)*(Mt[($t+1)%ln].y+Mt[$t].y);return gt>=0})(Me)||(Me=Me.reverse());const ft={geometry:[],joinNormals:[],indices:[]},at=[],ht=[],_t=[];let We=Me.length;for(;We>=2&&Me[We-1].equals(Me[We-2]);)We--;if(We<(ke?3:2))return ft;let ct,Ge,Xe,yt,vt,Wt=0;for(;Wt<We-1&&Me[Wt].equals(Me[Wt+1]);)Wt++;ke&&(ct=Me[We-2],vt=Me[Wt].sub(ct)._unit()._perp());for(let Mt=Wt;Mt<We;Mt++){if(Xe=Mt===We-1?ke?Me[Wt+1]:void 0:Me[Mt+1],Xe&&Me[Mt].equals(Xe))continue;vt&&(yt=vt),ct&&(Ge=ct),ct=Me[Mt],vt=Xe?Xe.sub(ct)._unit()._perp():yt,yt=yt||vt;let gt=yt.add(vt);gt.x===0&&gt.y===0||gt._unit();const ln=gt.x*vt.x+gt.y*vt.y,$t=ln!==0?1/ln:1/0,Gt=yt.x*vt.y-yt.y*vt.x>0;let on="miter";const mn=2;on==="miter"&&$t>mn&&(on="bevel"),on==="bevel"&&($t>100&&(on="flipbevel"),$t<mn&&(on="miter"));const gn=(Cn,Sn,bn,hi)=>{const Ei=new St(Cn.x,Cn.y),he=new St(Cn.x,Cn.y);Ei.x+=Sn.x*hi,Ei.y+=Sn.y*hi,he.x-=Sn.x*Math.max(bn,1),he.y-=Sn.y*Math.max(bn,1),_t.push(Sn),at.push(Ei),ht.push(he)};if(on==="miter")gt._mult($t),gn(ct,gt,0,0);else if(on==="flipbevel")gt=vt.mult(-1),gn(ct,gt,0,0),gn(ct,gt.mult(-1),0,0);else{const Cn=-Math.sqrt($t*$t-1),Sn=Gt?Cn:0,bn=Gt?0:Cn;Ge&&gn(ct,yt,Sn,bn),Xe&&gn(ct,vt,Sn,bn)}}ft.geometry=[...at,...ht.reverse(),at[0]],ft.joinNormals=[..._t,..._t.reverse(),_t[_t.length-1]];const Nt=ft.geometry.length-1;for(let Mt=0;Mt<Nt/2;Mt++)if(Mt+1<Nt/2){let gt=Mt,ln=Mt+1,$t=Nt-1-Mt,Gt=Nt-2-Mt;gt=gt===0?Nt-1:gt-1,ln=ln===0?Nt-1:ln-1,$t=$t===0?Nt-1:$t-1,Gt=Gt===0?Nt-1:Gt-1,ft.indices.push($t),ft.indices.push(ln),ft.indices.push(gt),ft.indices.push($t),ft.indices.push(Gt),ft.indices.push(ln)}return ft}(i[0]),i=[le.geometry]}const re=(Me,ke)=>Me<(ke.length-1)/2||Me===ke.length-1,G=this.wallMode?[i]:a0(i,500);for(let Me=G.length-1;Me>=0;Me--){const ke=G[Me];(ke.length===0||(ne=ke[0]).every(Ye=>Ye.x<=0)||ne.every(Ye=>Ye.x>=At)||ne.every(Ye=>Ye.y<=0)||ne.every(Ye=>Ye.y>=At))&&G.splice(Me,1)}var ne;let ae;if(R)ae=hE(G,I,c);else{ae=[];for(const Me of G)ae.push({polygon:Me,bounds:I})}const de=B?this.edgeRadius:0,be=de>0&&this.zoom<17,Ie=(Me,ke)=>{if(Me.length===0)return!1;const Ye=Me[Me.length-1];return ke.x===Ye.x&&ke.y===Ye.y};for(const{polygon:Me,bounds:ke}of ae){let Ye=0,ft=0;for(const We of Me)B&&!We[0].equals(We[We.length-1])&&We.push(We[0]),ft+=B?We.length-1:We.length;const at=this.segments.prepareSegment((B?5:4)*ft,this.layoutVertexArray,this.indexArray);$.footprintSegIdx<0&&($.footprintSegIdx=this.footprintSegments.length),$.polygonSegIdx<0&&($.polygonSegIdx=this.polygonSegments.length);const ht={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},_t=new eE;if(_t.vertexOffset=this.footprintVertices.length,_t.indexOffset=3*this.footprintIndices.length,_t.ringIndices=[],B){const We=[],ct=[];Ye=at.vertexLength;for(let Xe=0;Xe<Me.length;Xe++){const yt=Me[Xe];yt.length&&Xe!==0&&ct.push(We.length/2);const vt=[];let Wt,Nt;Wt=yt[1].sub(yt[0])._perp()._unit(),_t.ringIndices.push(yt.length-1);for(let Mt=1;Mt<yt.length;Mt++){const gt=yt[Mt],ln=yt[Mt===yt.length-1?1:Mt+1],$t=gt.clone();if(de){Nt=ln.sub(gt)._perp()._unit();const Gt=Wt.add(Nt)._unit(),on=de*Math.min(4,1/(Wt.x*Gt.x+Wt.y*Gt.y));$t.x+=on*Gt.x,$t.y+=on*Gt.y,$t.x=Math.round($t.x),$t.y=Math.round($t.y),Wt=Nt}if(!X||de!==0&&!be||Ie(vt,$t)||vt.push($t),hm(this.layoutVertexArray,$t.x,$t.y,0,0,1,1,0),this.wallMode){const Gt=re(Mt,yt);fm(this.wallVertexArray,le.joinNormals[Mt],!Gt)}at.vertexLength++,this.footprintVertices.emplaceBack(gt.x,gt.y),We.push(gt.x,gt.y),R&&dm(this.layoutVertexExtArray,C.projectTilePoint($t.x,$t.y,c),C.upVector(c,$t.x,$t.y))}X&&(de===0||be)&&(vt.length!==0&&Ie(vt,vt[0])&&vt.pop(),this.groundEffect.addData(vt,ke,S))}const Ge=this.wallMode?le.indices:sm(We,ct);for(let Xe=0;Xe<Ge.length;Xe+=3)this.footprintIndices.emplaceBack(_t.vertexOffset+Ge[Xe+0],_t.vertexOffset+Ge[Xe+1],_t.vertexOffset+Ge[Xe+2]),this.indexArray.emplaceBack(Ye+Ge[Xe],Ye+Ge[Xe+2],Ye+Ge[Xe+1]),at.primitiveLength++;_t.indexCount+=Ge.length,_t.vertexCount+=this.footprintVertices.length-_t.vertexOffset}for(let We=0;We<Me.length;We++){const ct=Me[We];N.startRing($,ct[0]);let Ge=ct.length>4&&lE(ct[ct.length-2],ct[0],ct[1]),Xe=de?w5(ct[ct.length-2],ct[0],ct[1],de):0;const yt=[];let vt,Wt,Nt;Wt=ct[1].sub(ct[0])._perp()._unit();let Mt=!0;for(let gt=1,ln=0;gt<ct.length;gt++){let $t=ct[gt-1],Gt=ct[gt];const on=ct[gt===ct.length-1?1:gt+1];if(N.appendEdge($,Gt,$t),O1(Gt,$t,ke)){de&&(Wt=on.sub(Gt)._perp()._unit(),Mt=!Mt);continue}const mn=Gt.sub($t)._perp(),gn=mn.x/(Math.abs(mn.x)+Math.abs(mn.y)),Cn=mn.y>0?1:0,Sn=$t.dist(Gt);if(ln+Sn>32768&&(ln=0),de){Nt=on.sub(Gt)._perp()._unit();let he=sE($t,Gt,on,oE(Wt,Nt),de);isNaN(he)&&(he=0);const pe=Gt.sub($t)._unit();$t=$t.add(pe.mult(Xe))._round(),Gt=Gt.add(pe.mult(-he))._round(),Xe=he,Wt=Nt,X&&this.zoom>=17&&(Ie(yt,$t)||yt.push($t),Ie(yt,Gt)||yt.push(Gt))}const bn=at.vertexLength,hi=ct.length>4&&lE($t,Gt,on);let Ei=cE(ln,Ge,Mt);if(hm(this.layoutVertexArray,$t.x,$t.y,gn,Cn,0,0,Ei),hm(this.layoutVertexArray,$t.x,$t.y,gn,Cn,0,1,Ei),this.wallMode){const he=re(gt-1,ct),pe=le.joinNormals[gt-1];fm(this.wallVertexArray,pe,he),fm(this.wallVertexArray,pe,he)}if(ln+=Sn,Ei=cE(ln,hi,!Mt),Ge=hi,hm(this.layoutVertexArray,Gt.x,Gt.y,gn,Cn,0,0,Ei),hm(this.layoutVertexArray,Gt.x,Gt.y,gn,Cn,0,1,Ei),this.wallMode){const he=re(gt,ct),pe=le.joinNormals[gt];fm(this.wallVertexArray,pe,he),fm(this.wallVertexArray,pe,he)}if(at.vertexLength+=4,this.indexArray.emplaceBack(bn+0,bn+1,bn+2),this.indexArray.emplaceBack(bn+1,bn+3,bn+2),at.primitiveLength+=2,de){const he=Ye+(gt===1?ct.length-2:gt-2),pe=gt===1?Ye:he+1;if(this.indexArray.emplaceBack(bn+1,he,bn+3),this.indexArray.emplaceBack(he,pe,bn+3),at.primitiveLength+=2,vt===void 0&&(vt=bn),!O1(on,ct[gt],ke)){const Je=gt===ct.length-1?vt:at.vertexLength;this.indexArray.emplaceBack(bn+2,bn+3,Je),this.indexArray.emplaceBack(bn+3,Je+1,Je),this.indexArray.emplaceBack(bn+3,pe,Je+1),at.primitiveLength+=3}Mt=!Mt}if(R){const he=this.layoutVertexExtArray,pe=C.projectTilePoint($t.x,$t.y,c),Je=C.projectTilePoint(Gt.x,Gt.y,c),Tt=C.upVector(c,$t.x,$t.y),zt=C.upVector(c,Gt.x,Gt.y);dm(he,pe,Tt),dm(he,pe,Tt),dm(he,Je,zt),dm(he,Je,zt)}}B&&(Ye+=ct.length-1),X&&de&&this.zoom>=17&&(yt.length!==0&&Ie(yt,yt[0])&&yt.pop(),this.groundEffect.addData(yt,ke,S,de>0))}this.footprintSegments.push(_t),ht.triangleCount=this.indexArray.length-ht.triangleArrayOffset,this.polygonSegments.push(ht),++$.footprintSegLen,++$.polygonSegLen}if($.vertexCount=this.layoutVertexArray.length-$.vertexArrayOffset,$.groundVertexCount=this.groundEffect.vertexArray.length-$.groundVertexArrayOffset,$.vertexCount!==0){if($.centroidXY=N.borders?QS:this.encodeCentroid(N,$),this.centroidData.push($),N.borders){this.featuresOnBorder.push(N);const Me=this.featuresOnBorder.length-1;for(let ke=0;ke<N.borders.length;ke++)N.borders[ke][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ke].push(Me)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,d,p,c,w),this.groundEffect.addPaintPropertiesData(e,l,d,p,c,w),this.maxHeight=Math.max(this.maxHeight,K)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,l)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[l].borders[e][0])}splitToSubtiles(){const e=[];for(let v=0;v<this.centroidData.length;v++){const w=this.centroidData[v],S=+(w.min.y+w.max.y>At),I=2*S+(+(w.min.x+w.max.x>At)^S);for(let C=0;C<w.polygonSegLen;C++){const R=w.polygonSegIdx+C;e.push({centroidIdx:v,subtile:I,polygonSegmentIdx:R,triangleSegmentIdx:this.polygonSegments[R].triangleSegIdx})}}const i=new wr;e.sort((v,w)=>v.triangleSegmentIdx===w.triangleSegmentIdx?v.subtile-w.subtile:v.triangleSegmentIdx-w.triangleSegmentIdx);let l=0,c=0,d=0;for(const v of e){if(v.triangleSegmentIdx!==l)break;d++}const p=e.length;for(;c!==e.length;){l=e[c].triangleSegmentIdx;let v=0,w=c,S=c;for(let I=w;I<d&&e[I].subtile===v;I++)S++;for(;w!==d;){const I=e[w];v=I.subtile;const C=this.centroidData[I.centroidIdx].min.clone(),R=this.centroidData[I.centroidIdx].max.clone(),B={vertexOffset:this.segments.segments[l].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[l].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let N=w;N<S;N++){const $=e[N],X=this.polygonSegments[$.polygonSegmentIdx],K=this.centroidData[$.centroidIdx].min,le=this.centroidData[$.centroidIdx].max,re=this.indexArray.uint16;for(let G=X.triangleArrayOffset;G<X.triangleArrayOffset+X.triangleCount;G++)i.emplaceBack(re[3*G],re[3*G+1],re[3*G+2]);B.primitiveLength+=X.triangleCount,C.x=Math.min(C.x,K.x),C.y=Math.min(C.y,K.y),R.x=Math.max(R.x,le.x),R.y=Math.max(R.y,le.y)}B.primitiveLength>0&&this.triangleSubSegments.push({segment:B,min:C,max:R}),w=S;for(let N=w;N<d&&e[N].subtile===e[w].subtile;N++)S++}c=d;for(let I=c;I<p&&e[I].triangleSegmentIdx===e[c].triangleSegmentIdx;I++)d++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,l){const c=new Ui;if(this.wallMode){for(const $ of this.triangleSubSegments)c.segments.push($.segment);return c}let d=0,p=0;const v=1<<e.canonical.z;if(i){const $=i.getMinMaxForTile(e);$&&(d=$.min,p=$.max)}p+=this.maxHeight;const w=e.toUnwrapped();let S;const I=[w.canonical.x/v+w.wrap,w.canonical.y/v],C=[(w.canonical.x+1)/v+w.wrap,(w.canonical.y+1)/v],R=($,X,K)=>[$[0]*(1-K[0])+X[0]*K[0],$[1]*(1-K[1])+X[1]*K[1]],B=[],N=[];for(const $ of this.triangleSubSegments){B[0]=$.min.x/At,B[1]=$.min.y/At,N[0]=$.max.x/At,N[1]=$.max.y/At;const X=R(I,C,B),K=R(I,C,N);if(new Ri([X[0],X[1],d],[K[0],K[1],p]).intersectsPrecise(l)===0){S&&(c.segments.push(S),S=void 0);continue}const le=$.segment;S&&S.vertexOffset!==le.vertexOffset&&(c.segments.push(S),S=void 0),S?(S.vertexLength+=le.vertexLength,S.primitiveLength+=le.primitiveLength):S={vertexOffset:le.vertexOffset,primitiveLength:le.primitiveLength,vertexLength:le.vertexLength,primitiveOffset:le.primitiveOffset,sortKey:void 0,vaos:{}}}return S&&c.segments.push(S),c}encodeCentroid(e,i){const l=e.centroid(),c=i.span(),d=Math.min(7,Math.round(c.x*this.tileToMeter/10)),p=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new St(ze(l.x,1,At-1)<<3|d,ze(l.y,1,At-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new St(0,0);const i=e.borders,l=Number.MAX_VALUE;if(i[0][0]!==l||i[1][0]!==l){const c=i[0][0]!==l?0:1;return new St(6|(i[0][0]!==l?0:65528),(i[c][0]+i[c][1])/2<<3|6)}{const c=i[2][0]!==l?2:3;return new St((i[c][0]+i[c][1])/2<<3|6,6|(i[2][0]!==l?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=kc,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,l=e.vertexCount+e.vertexArrayOffset,c=e.flags&kc?QS:e.centroidXY,d=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==c.y||d!==c.x){for(let p=i;p<l;++p)this.centroidVertexArray.emplace(p,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,l){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const c=i.getReplacementRegionsForTile(e.toUnwrapped());if(D1(this.activeReplacements,c))return;if(this.activeReplacements=c,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const p of this.centroidData)p.flags&=2147483647;const d=[];for(const p of this.activeReplacements){if(p.order<l)continue;const v=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));for(const w of this.centroidData)if(!(w.flags&kc||p.min.x>w.max.x||w.min.x>p.max.x||p.min.y>w.max.y||w.min.y>p.max.y))for(let S=0;S<w.footprintSegLen;S++){const I=this.footprintSegments[w.footprintSegIdx+S];if(d.length=0,T5(this.footprintVertices,I.vertexOffset,I.vertexCount,p.footprintTileId.canonical,e.canonical,d),WS(p.footprint,d,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-v)){w.flags|=kc;break}}}for(const p of this.centroidData)this.writeCentroidToBuffer(p);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,l){let c=!1;for(let d=0;d<l.footprintSegLen;d++){const p=this.footprintSegments[l.footprintSegIdx+d];let v=0;for(const w of p.ringIndices){for(let S=v,I=w+v-1;S<w+v;I=S++){const C=this.footprintVertices.int16[2*(S+p.vertexOffset)+0],R=this.footprintVertices.int16[2*(S+p.vertexOffset)+1],B=this.footprintVertices.int16[2*(I+p.vertexOffset)+1];R>i!=B>i&&e<(this.footprintVertices.int16[2*(I+p.vertexOffset)+0]-C)*(i-R)/(B-R)+C&&(c=!c)}v=w}}return c}getHeightAtTileCoord(e,i){let l=Number.NEGATIVE_INFINITY,c=!0;const d=4*(e+At)*At+(i+At);if(this.partLookup.hasOwnProperty(d)){const p=this.partLookup[d];return p?{height:p.height,hidden:!!(p.flags&kc)}:void 0}for(const p of this.centroidData)e>p.max.x||p.min.x>e||i>p.max.y||p.min.y>i||this.footprintContainsPoint(e,i,p)&&p&&p.height>l&&(l=p.height,this.partLookup[d]=p,c=!!(p.flags&kc));if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:c};this.partLookup[d]=void 0}}function oE(o,e){const i=o.add(e)._unit();return o.x*i.x+o.y*i.y}function w5(o,e,i,l){const c=e.sub(o)._perp()._unit(),d=i.sub(e)._perp()._unit();return sE(o,e,i,oE(c,d),l)}function sE(o,e,i,l,c){const d=Math.sqrt(1-l*l);return Math.min(o.dist(e)/3,e.dist(i)/3,c*d/l)}function O1(o,e,i){return o.x<i[0].x&&e.x<i[0].x||o.x>i[1].x&&e.x>i[1].x||o.y<i[0].y&&e.y<i[0].y||o.y>i[1].y&&e.y>i[1].y}function aE(o,e){return o.x<e[0].x||o.x>e[1].x||o.y<e[0].y||o.y>e[1].y}function lE(o,e,i){if(o.x<0||o.x>=At||e.x<0||e.x>=At||i.x<0||i.x>=At)return!1;const l=i.sub(e),c=l.perp(),d=o.sub(e);return(l.x*d.x+l.y*d.y)/Math.sqrt((l.x*l.x+l.y*l.y)*(d.x*d.x+d.y*d.y))>-.866&&c.x*d.x+c.y*d.y<0}function cE(o,e,i){const l=e?2|o:-3&o;return i?1|l:-2&l}function uE(){const o=Math.PI/32,e=Math.tan(o),i=q;return i*Math.sqrt(1+2*e*e)-i}function hE(o,e,i){const l=1<<i.z,c=we(i.x/l),d=we((i.x+1)/l),p=Te(i.y/l),v=Te((i.y+1)/l);return function(w,S,I,C,R=0,B){const N=[];if(!w.length||!I||!C)return N;const $=(ae,de)=>{for(const be of ae)N.push({polygon:be,bounds:de})},X=Math.ceil(Math.log2(I)),K=Math.ceil(Math.log2(C)),le=X-K,re=[];for(let ae=0;ae<Math.abs(le);ae++)re.push(le>0?0:1);for(let ae=0;ae<Math.min(X,K);ae++)re.push(0),re.push(1);let G=w;if(G=c0(G,S[0].y-R,S[1].y+R,1),G=c0(G,S[0].x-R,S[1].x+R,0),!G.length)return N;const ne=[];for(re.length?ne.push({polygons:G,bounds:S,depth:0}):$(G,S);ne.length;){const ae=ne.pop(),de=ae.depth,be=re[de],Ie=ae.bounds[0],Me=ae.bounds[1],ke=be===0?Ie.x:Ie.y,Ye=be===0?Me.x:Me.y,ft=B?B(be,ke,Ye):.5*(ke+Ye),at=c0(ae.polygons,ke-R,ft+R,be),ht=c0(ae.polygons,ft-R,Ye+R,be);if(at.length){const _t=[Ie,new St(be===0?ft:Me.x,be===1?ft:Me.y)];re.length>de+1?ne.push({polygons:at,bounds:_t,depth:de+1}):$(at,_t)}if(ht.length){const _t=[new St(be===0?ft:Ie.x,be===1?ft:Ie.y),Me];re.length>de+1?ne.push({polygons:ht,bounds:_t,depth:de+1}):$(ht,_t)}}return N}(o,e,Math.ceil((d-c)/11.25),Math.ceil((p-v)/11.25),1,(w,S,I)=>{if(w===0)return .5*(S+I);{const C=Te((i.y+S/At)/l);return(ve(.5*(Te((i.y+I/At)/l)+C))*l-i.y)*At}})}function T5(o,e,i,l,c,d){const p=Math.pow(2,l.z-c.z);for(let v=0;v<i;v++){let w=o.int16[2*(v+e)+0],S=o.int16[2*(v+e)+1];w=(w+c.x*At)*p-l.x*At,S=(S+c.y*At)*p-l.y*At,d.push(new St(w,S))}}let fE,dE;Ft(d0,"FillExtrusionBucket",{omit:["layers","features"]}),Ft(tE,"PartData"),Ft(eE,"FootprintSegment"),Ft(nE,"BorderCentroidData"),Ft(rE,"GroundEffect");class nh extends St{constructor(e,i,l){super(e,i),this.z=l}}class pE extends nh{constructor(e,i,l,c){super(e,i,l),this.w=c}}function mE(o,e,i,l){const c=i==="x"?"y":"x",d=(l-o[i])/(e[i]-o[i]);o[c]=Math.round(o[c]+(e[c]-o[c])*d),o[i]=l,o.hasOwnProperty("z")&&(o.z=Jt(o.z,e.z,d)),o.hasOwnProperty("w")&&(o.w=Jt(o.w,e.w,d))}function _E(o,e,i,l){const c=i,d=l;for(const p of["x","y"]){let v=o,w=e;v[p]>=w[p]&&(v=e,w=o),v[p]<c&&w[p]>c&&mE(v,w,p,c),v[p]<d&&w[p]>d&&mE(w,v,p,d)}}function p0(o,e,i,l,c,d){const p=[];for(let v=0;v<o.length;v++){const w=o[v];let S;const I=p.length;let C=0;for(let R=0;R<w.length-1;R++){let B=w[R],N=w[R+1],$=0;const X=C;let K,le;d&&($=Math.hypot(N.x-B.x,N.y-B.y),C+=$,K=B,le=N),B.x<e&&N.x<e||(B.x<e?B=new St(e,B.y+(e-B.x)/(N.x-B.x)*(N.y-B.y))._round():N.x<e&&(N=new St(e,B.y+(e-B.x)/(N.x-B.x)*(N.y-B.y))._round()),B.y<i&&N.y<i||(B.y<i?B=new St(B.x+(i-B.y)/(N.y-B.y)*(N.x-B.x),i)._round():N.y<i&&(N=new St(B.x+(i-B.y)/(N.y-B.y)*(N.x-B.x),i)._round()),B.x>=l&&N.x>=l||(B.x>=l?B=new St(l,B.y+(l-B.x)/(N.x-B.x)*(N.y-B.y))._round():N.x>=l&&(N=new St(l,B.y+(l-B.x)/(N.x-B.x)*(N.y-B.y))._round()),B.y>=c&&N.y>=c||(B.y>=c?B=new St(B.x+(c-B.y)/(N.y-B.y)*(N.x-B.x),c)._round():N.y>=c&&(N=new St(B.x+(c-B.y)/(N.y-B.y)*(N.x-B.x),c)._round()),S&&B.equals(S[S.length-1])||(S=[B],p.push(S),d&&d.push({progress:{min:X+gE(K,le,B)*$,max:1},parentIndex:v,prevPoint:K,nextPoint:le})),S.push(N),d&&(d[d.length-1].progress.max=X+gE(K,le,N)*$,d[d.length-1].nextPoint=le)))))}if(d&&C>0)for(let R=I;R<p.length;R++)d[R].progress.min/=C,d[R].progress.max/=C}return p}function S5(o,e,i,l,c){if(o.length<2)return void l.push(o);const d=[];for(;e.valid();){const[S,I]=e.get();for(let C=0;C<o.length-1;C++){const R=o[C],B=o[C+1],N=Ni(R,B,S,I);if(N){const[$]=N,X=new St(Jt(R.x,B.x,$),Jt(R.y,B.y,$));d.push({t:C+$,distance:0,point:X})}}e.next()}if(d.length===0)return void l.push(o);d.sort((S,I)=>S.t-I.t);let p=0,v=0,w=[];for(l.push(w);p!==o.length;){if(v===d.length){for(;p!==o.length;)w.length!==0&&w[w.length-1].equals(o[p])||w.push(o[p]),p++;break}d[v].t<=p?(w.length!==0&&w[w.length-1].equals(d[v].point)||w.push(d[v].point),Math.trunc(d[v].t),v++):(w.length!==0&&w[w.length-1].equals(o[p])||w.push(o[p]),p++)}}function gE(o,e,i){return o.x!==e.x?(i.x-o.x)/(e.x-o.x):o.y!==e.y?(i.y-o.y)/(e.y-o.y):0}function pm(o,e){return o.x*e.x+o.y*e.y}function yE(o,e){if(o.length===1){let i=0;const l=e[i++];let c;for(;!c||l.equals(c);)if(c=e[i++],!c)return 1/0;for(;i<e.length;i++){const d=e[i],p=o[0],v=c.sub(l),w=d.sub(l),S=p.sub(l),I=pm(v,v),C=pm(v,w),R=pm(w,w),B=pm(S,v),N=pm(S,w),$=I*R-C*C,X=(R*B-C*N)/$,K=(I*N-C*B)/$,le=l.z*(1-X-K)+c.z*X+d.z*K;if(isFinite(le))return le}return 1/0}{let i=1/0;for(const l of e)i=Math.min(i,l.z);return i}}function vE(o,e,i,l,c,d,p,v){const w=p*c.getElevationAt(o,e,!0,!0),S=d[0]!==0,I=S?d[1]===0?p*(d[0]/7-450):p*function(C,R,B){const N=Math.floor(R[0]/8),$=Math.floor(R[1]/8),X=10*(R[0]-8*N),K=10*(R[1]-8*$),le=C.getElevationAt(N,$,!0,!0),re=C.getMeterToDEM(B),G=Math.floor(.5*(X*re-1)),ne=Math.floor(.5*(K*re-1)),ae=C.tileCoordToPixel(N,$),de=2*G+1,be=2*ne+1,Ie=function(ht,_t,We,ct,Ge){return[ht.getElevationAtPixel(_t,We,!0),ht.getElevationAtPixel(_t+Ge,We,!0),ht.getElevationAtPixel(_t,We+Ge,!0),ht.getElevationAtPixel(_t+ct,We+Ge,!0)]}(C,ae.x-G,ae.y-ne,de,be),Me=Math.abs(Ie[0]-Ie[1]),ke=Math.abs(Ie[2]-Ie[3]),Ye=Math.abs(Ie[0]-Ie[2])+Math.abs(Ie[1]-Ie[3]),ft=Math.min(.25,.5*re*(Me+ke)/de),at=Math.min(.25,.5*re*Ye/be);return le+Math.max(ft*X,at*K)}(c,d,v):w;return{base:w+(i===0?-1:i),top:S?Math.max(I+l,w+i+2):w+l}}const E5=Yn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),A5=Yn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:I5}=E5,M5=Yn([{name:"a_packed",components:3,type:"Float32"}]),{members:C5}=M5,P5=Yn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:z5}=P5;class xE{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Dc({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const l=this.getKey(e,i);return this.positions[l]}trim(){const e=this.width,i=this.height=Zt(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,l){const c=[];let d=e.length%2==1?-e[e.length-1]*l:0,p=e[0]*l,v=!0;c.push({left:d,right:p,isDash:v,zeroLength:e[0]===0});let w=e[0];for(let S=1;S<e.length;S++){v=!v;const I=e[S];d=w*l,w+=I,p=w*l,c.push({left:d,right:p,isDash:v,zeroLength:I===0})}return c}addRoundDash(e,i,l){const c=i/2;for(let d=-l;d<=l;d++){const p=this.width*(this.nextRow+l+d);let v=0,w=e[v];for(let S=0;S<this.width;S++){S/w.right>1&&(w=e[++v]);const I=Math.abs(S-w.left),C=Math.abs(S-w.right),R=Math.min(I,C);let B;const N=d/l*(c+1);if(w.isDash){const $=c-Math.abs(N);B=Math.sqrt(R*R+$*$)}else B=c-Math.sqrt(R*R+N*N);this.image.data[p+S]=Math.max(0,Math.min(255,B+128))}}}addRegularDash(e,i){for(let w=e.length-1;w>=0;--w){const S=e[w],I=e[w+1];S.zeroLength?e.splice(w,1):I&&I.isDash===S.isDash&&(I.left=S.left,e.splice(w,1))}const l=e[0],c=e[e.length-1];l.isDash===c.isDash&&(l.left=c.left-this.width,c.right=l.right+this.width);const d=this.width*this.nextRow;let p=0,v=e[p];for(let w=0;w<this.width;w++){w/v.right>1&&(v=e[++p]);const S=Math.abs(w-v.left),I=Math.abs(w-v.right),C=Math.min(S,I);this.image.data[d+w]=Math.max(0,Math.min(255,(v.isDash?C:-C)+i+128))}}addDash(e,i){const l=this.getKey(e,i);if(this.positions[l])return this.positions[l];const c=i==="round",d=c?7:0,p=2*d+1;if(this.nextRow+p>this.height)return Dn("LineAtlas out of space"),null;e.length===0&&e.push(1);let v=0;for(let I=0;I<e.length;I++)e[I]<0&&(Dn("Negative value is found in line dasharray, replacing values with 0"),e[I]=0),v+=e[I];if(v!==0){const I=this.width/v,C=this.getDashRanges(e,this.width,I);c?this.addRoundDash(C,I,d):this.addRegularDash(C,i==="square"?.5*I:0)}const w=this.nextRow+d;this.nextRow+=p;const S={tl:[w,d],br:[v,0]};return this.positions[l]=S,S}}Ft(xE,"LineAtlas");const R5=Lc.VectorTileFeature.types,D5=Math.cos(Math.PI/180*37.5),L5=Math.cos(Math.PI/180*5);class F1{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Hp,this.layoutVertexArray2=new As,this.patternVertexArray=new As,this.indexArray=new wr,this.programConfigurations=new Il(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ui,this.maxLineLength=0,this.zOffsetVertexArray=new As,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:At/64}updateFootprints(e,i){}populate(e,i,l,c){this.hasPattern=b1("line",this.layers,this.pixelRatio,i);const d=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Oe(l);const p=this.layers[0].layout.get("line-elevation-reference");if(p==="hd-road-markup")this.elevationType="road";else{const R=this.layers[0].layout.get("line-z-offset"),B=R.isConstant()&&!R.constantOr(0);this.elevationType=p!=="sea"&&p!=="ground"&&B?"none":"offset",this.elevationType==="offset"&&p==="none"&&Dn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const v=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&v!==void 0;const w=[];for(const{feature:R,id:B,index:N,sourceLayerIndex:$}of e){const X=this.layers[0]._featureFilter.needGeometry,K=Xt(R,X);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),K,l))continue;const le=d?d.evaluate(K,{},l):void 0,re={id:B,properties:R.properties,type:R.type,sourceLayerIndex:$,index:N,geometry:X?K.geometry:Vt(R,l,c),patterns:{},sortKey:le};w.push(re)}d&&w.sort((R,B)=>R.sortKey-B.sortKey);const{lineAtlas:S,featureIndex:I}=i,C=this.addConstantDashes(S);for(const R of w){const{geometry:B,index:N,sourceLayerIndex:$}=R;if(C&&this.addFeatureDashes(R,S),this.hasPattern){const X=w1("line",this.layers,R,this.zoom,this.pixelRatio,i);this.patternFeatures.push(X)}else this.addFeature(R,B,N,l,S.positions,i.availableImages,i.brightness,i.elevationFeatures);I.insert(e[N].feature,B,N,$,this.index)}}addConstantDashes(e){let i=!1;for(const l of this.layers){const c=l.paint.get("line-dasharray").value,d=l.layout.get("line-cap").value;if(c.kind!=="constant"||d.kind!=="constant")i=!0;else{const p=d.value,v=c.value;if(!v)continue;e.addDash(v,p)}}return i}addFeatureDashes(e,i){const l=this.zoom;for(const c of this.layers){const d=c.paint.get("line-dasharray").value,p=c.layout.get("line-cap").value;if(d.kind==="constant"&&p.kind==="constant")continue;let v,w;if(d.kind==="constant"){if(v=d.value,!v)continue}else v=d.evaluate({zoom:l},e);w=p.kind==="constant"?p.value:p.evaluate({zoom:l},e),i.addDash(v,w),e.patterns[c.id]=[i.getKey(v,w)]}}update(e,i,l,c,d,p,v){this.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v)}addFeatures(e,i,l,c,d,p){for(const v of this.patternFeatures)this.addFeature(v,v.geometry,v.index,i,l,c,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,C5)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,z5)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,A5.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,I5),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,l,c,d,p,v,w){const S=this.layers[0].layout,I=S.get("line-join").evaluate(e,{}),C=S.get("line-cap").evaluate(e,{}),R=S.get("line-miter-limit"),B=S.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=S.get("line-z-offset").value;const N=this.layers[0].paint.get("line-width").value;if(N.kind!=="constant"&&N.isLineProgressConstant===!1&&(this.variableWidthValue=N),this.elevationType==="road"){const $=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,c,w,I,C,R,B)){const[X,K]=this.clipRuntimeLinesToTile(i,1);for(let le=0;le<X.length;le++){const re=X[le],G=K[le],ne={progress:{min:G.progress.min,max:G.progress.max},nextDir:this.computeSegNextDir(G,re),prevDir:this.computeSegPrevDir(G,re)};this.addLine(re,e,c,I,C,R,B,ne)}this.fillNonElevatedRoadSegment($)}}else for(const $ of i)this.addLine($,e,c,I,C,R,B);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,d,p,c,v)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return p0(e,-i,-i,At+i,At+i)}clipRuntimeLinesToTile(e,i){const l=[];return[p0(e,-i,-i,At+i,At+i,l),l]}addElevatedRoadFeature(e,i,l,c,d,p,v,w){const S=[],I=I1.getElevationFeature(e,c);if(I){const C=this.clipLinesToTile(i,1),R=this.prepareElevatedLines(C,I,l);for(const B of R)S.push({geometry:B,elevation:I,elevationTileID:l,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(S.length===0)return!1;for(const C of S){const R=this.layoutVertexArray.length;this.addLine(C.geometry,e,l,d,p,v,w);const B=new LS(l,C.elevationTileID);if(C.elevation)for(let N=R;N<this.layoutVertexArray.length;N++){const $=new St(this.layoutVertexArray.int16[6*N]>>1,this.layoutVertexArray.int16[6*N+1]>>1),X=B.pointElevation($,C.elevation,.05);this.updateHeightRange(X),this.zOffsetVertexArray.emplaceBack(X,0,0)}else this.fillNonElevatedRoadSegment(R)}return!0}prepareElevatedLines(e,i,l){if(i.constantHeight!=null)return e;const c=[],d=1/Oe(l);for(const p of e)S5(p,new DS(i,d),0,c);return c}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,l,c,d,p,v,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const S=c==="none";this.patternJoinNone=this.hasPattern&&S,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const I=w&&w.progress.min>0,C=w&&w.progress.max<1;if(this.lineClips){let be={min:this.lineClips.start,max:this.lineClips.end},Ie=1;if(w){const Ye=this.lineClips.end-this.lineClips.start;be=function(ft,at,ht){return{min:Mr(ft.min,at,ht),max:Mr(ft.max,at,ht)}}(w.progress,{min:0,max:1},be),Ye>0&&(Ie=(be.max-be.min)/Ye)}const Me=+i.properties.mapbox_clip_feature_len,ke=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(Me)||Number.isNaN(ke)){for(let ft=0;ft<e.length-1;ft++)this.totalDistance+=e[ft].dist(e[ft+1]);const Ye=this.totalDistance/(be.max-be.min);this.totalFeatureLength=Number.isFinite(Ye)?Ye:0,this.lineClips.start=be.min,this.lineClips.end=be.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Me,this.distance=ke*Ie,this.lineClips.start=be.min,this.lineClips.end=be.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const R=R5[i.type]==="Polygon";let B=e.length;for(;B>=2&&e[B-1].equals(e[B-2]);)B--;let N=0;for(;N<B-1&&e[N].equals(e[N+1]);)N++;if(B<(R?3:2))return;c==="bevel"&&(p=1.05);const $=this.segments.prepareSegment(10*B,this.layoutVertexArray,this.indexArray);let X,K,le,re,G,ne,ae,de;w&&w.prevDir&&(ne=w.prevDir.perp()),w&&w.nextDir&&(ae=w.nextDir.perp()),this.e1=this.e2=-1,R&&(X=e[B-2],G=e[N].sub(X)._unit()._perp());for(let be=N;be<B;be++){if(le=be===B-1?R?e[N+1]:void 0:e[be+1],le&&e[be].equals(le))continue;G&&(re=G),X&&(K=X),X=e[be],de=this.evaluateLineProgressFeatures(K?K.dist(X):0),G=le?le.sub(X)._unit()._perp():re,re=re||G;const Ie=K&&le;let Me=Ie?c:R||S?"butt":d;const ke=re.x*G.x+re.y*G.y;if(S){const Ge=function(Xe){if(Xe.patternJoinNone){const yt=Xe.segmentPoints.length/2,vt=Xe.lineSoFar-Xe.segmentStart;for(let Wt=0;Wt<yt;++Wt){const Nt=Xe.segmentPoints[2*Wt+1],Mt=Math.round(Xe.segmentPoints[2*Wt])+.5+.25*Nt;Xe.patternVertexArray.emplaceBack(Mt,vt,Xe.segmentStart),Xe.patternVertexArray.emplaceBack(Mt,vt,Xe.segmentStart)}Xe.segmentPoints.length=0}Xe.e1=Xe.e2=-1};if(Ie&&ke<L5){this.updateDistance(K,X),this.addCurrentVertex(X,re,1,1,$,de),Ge(this),this.addCurrentVertex(X,G,-1,-1,$,de);continue}if(K){if(!le){this.updateDistance(K,X),this.addCurrentVertex(X,re,1,1,$,de),Ge(this);continue}Me="miter"}}let Ye=re.add(G);Ye.x===0&&Ye.y===0||Ye._unit();const ft=Ye.x*G.x+Ye.y*G.y,at=ft!==0?1/ft:1/0,ht=2*Math.sqrt(2-2*ft),_t=ft<D5&&K&&le,We=re.x*G.y-re.y*G.x>0,ct=this.overscaling<=16?15*At/(512*this.overscaling):0;if(Ie&&Me==="round"){if(at<v)Me="miter";else if(at<=2){const Ge=B1(X,-10,At+10);Me=this.elevationType==="offset"&&(Ge||this.hasCrossSlope)?"miter":"fakeround"}}if(Me==="miter"&&at>p&&(Me="bevel"),Me==="bevel"&&(at>2&&(Me="flipbevel"),at<p&&(Me="miter")),K&&!(Me==="miter"&&_t)&&this.updateDistance(K,X),Me==="miter")if(_t){const Ge=X.dist(K);if(Ge>2*ct){const yt=X.sub(X.sub(K)._mult(ct/Ge)._round());this.updateDistance(K,yt),this.addCurrentVertex(yt,re,0,0,$,de),K=yt}this.updateDistance(K,X),Ye._mult(at),this.addCurrentVertex(X,Ye,0,0,$,de);const Xe=X.dist(le);if(Xe>2*ct){const yt=X.add(le.sub(X)._mult(ct/Xe)._round());this.updateDistance(X,yt),this.addCurrentVertex(yt,G,0,0,$,de),X=yt}}else Ye._mult(at),this.addCurrentVertex(X,Ye,0,0,$,de);else if(Me==="flipbevel"){if(at>100)Ye=G.mult(-1);else{const Ge=at*re.add(G).mag()/re.sub(G).mag();Ye._perp()._mult(Ge*(We?-1:1))}this.addCurrentVertex(X,Ye,0,0,$,de),this.addCurrentVertex(X,Ye.mult(-1),0,0,$,de)}else if(Me==="bevel"||Me==="fakeround"){de!=null&&K&&this.addCurrentVertex(X,ae||re,-1,-1,$,de);const Ge=X.dist(K)<=2*ct&&Me!=="bevel",Xe=Ye.mult(We?1:-1);Xe._mult(at);const yt=G.mult(We?-1:1),vt=re.mult(We?-1:1),Wt=this.evaluateLineProgressFeatures(this.distance);if(de==null&&(this.addHalfVertex(X,Xe.x,Xe.y,!1,!We,0,$,Wt),Ge||this.addHalfVertex(X,Xe.x+2*vt.x,Xe.y+2*vt.y,!1,We,0,$,Wt)),Me==="fakeround"){const Nt=Math.round(180*ht/Math.PI/20);this.addHalfVertex(X,vt.x,vt.y,!1,We,0,$,Wt);for(let Mt=0;Mt<Nt;Mt++){let gt=Mt/Nt;if(gt!==.5){const $t=gt-.5;gt+=gt*$t*(gt-1)*((1.0904+ke*(ke*(3.55645-1.43519*ke)-3.2452))*$t*$t+(.848013+ke*(.215638*ke-1.06021)))}const ln=yt.sub(vt)._mult(gt)._add(vt)._unit();this.addHalfVertex(X,ln.x,ln.y,!1,We,0,$,Wt)}this.addHalfVertex(X,yt.x,yt.y,!1,We,0,$,Wt)}Ge||de!=null||this.addHalfVertex(X,Xe.x+2*yt.x,Xe.y+2*yt.y,!1,We,0,$,Wt),de!=null&&le&&this.addCurrentVertex(X,ne||G,1,1,$,de)}else if(Me==="butt")this.addCurrentVertex(X,Ye,0,0,$,de);else if(Me==="square"){if(!K){const Ge=I?0:-1;this.addCurrentVertex(X,Ye,Ge,Ge,$,de)}if(this.addCurrentVertex(X,Ye,0,0,$,de),K){const Ge=C?0:1;this.addCurrentVertex(X,Ye,Ge,Ge,$,de)}}else if(Me==="round"){if(K){const Ge=!Ie&&ae?ae:re;this.addCurrentVertex(X,Ge,0,0,$,de),!Ie&&C||this.addCurrentVertex(X,Ge,1,1,$,de,!0)}if(le){const Ge=!Ie&&ne?ne:G;!Ie&&I||this.addCurrentVertex(X,Ge,-1,-1,$,de,!0),this.addCurrentVertex(X,Ge,0,0,$,de)}}}}addVerticesTo(e,i,l,c,d,p,v,w,S,I){const C=(i.w-e.w)/this.tessellationStep|0;let R=0;const B=this.scaledDistance;if(C>1){this.lineSoFar=e.w;const $=(i.x-e.x)/C,X=(i.y-e.y)/C,K=(i.z-e.z)/C,le=(i.w-e.w)/C;for(let re=1;re<C;++re){e.x+=$,e.y+=X,e.z+=K,this.lineSoFar+=le,R+=le;const G=this.evaluateLineProgressFeatures(this.prevDistance+R);this.scaledDistance=(this.prevDistance+R)/this.totalDistance,this.addHalfVertex(e,l,c,I,!1,v,S,G),this.addHalfVertex(e,d,p,I,!0,-w,S,G)}}this.lineSoFar=i.w,this.scaledDistance=B;const N=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,l,c,I,!1,v,S,N),this.addHalfVertex(i,d,p,I,!0,-w,S,N)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Dn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,l,c,d,p,v=!1){const w=i.x+i.y*l,S=i.y-i.x*l,I=i.y*c-i.x,C=-i.y-i.x*c;if(p!=null){const R=this.elevationType==="offset",B=-10,N=At+10,$=p.zOffset,X=new pE(e.x,e.y,$,this.lineSoFar),K=!!R&&B1(e,B,N),le=this.lineSoFar,re=this.distance;if(this.currentVertex)if(K){const G=this.currentVertexIsOutside,ne=this.currentVertex,ae=new pE(e.x,e.y,$,this.lineSoFar);if(_E(ne,ae,B,N),!B1(ae,B,N)){if(G){this.e1=this.e2=-1,this.distance-=ne.dist(X),this.lineSoFar=ne.w;const de=this.evaluateLineProgressFeatures(ne.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(ne,w,S,v,!1,l,d,de),this.addHalfVertex(ne,I,C,v,!0,-c,d,de),this.prevDistance=this.distance}this.distance=this.prevDistance+ne.dist(ae),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(ne,ae,w,S,I,C,l,c,d,v),this.distance=re,this.scaledDistance=this.distance/this.totalDistance}}else{const G=this.currentVertex;if(this.currentVertexIsOutside){_E(G,X,B,N),this.e1=this.e2=-1,this.distance-=G.dist(X),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=G.w;const ne=this.evaluateLineProgressFeatures(G.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(G,w,S,v,!1,l,d,ne),this.addHalfVertex(G,I,C,v,!0,-c,d,ne),this.prevDistance=this.distance,this.distance=re,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(G,X,w,S,I,C,l,c,d,v)}else K||(this.addHalfVertex(e,w,S,v,!1,l,d,p),this.addHalfVertex(e,I,C,v,!0,-c,d,p));this.currentVertex=X,this.currentVertexIsOutside=K,this.lineSoFar=le}else this.addHalfVertex(e,w,S,v,!1,l,d,p),this.addHalfVertex(e,I,C,v,!0,-c,d,p)}addHalfVertex({x:e,y:i},l,c,d,p,v,w,S){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),p||this.segmentPoints.push(this.lineSoFar-this.segmentStart,v)),this.layoutVertexArray.emplaceBack((e<<1)+(d?1:0),(i<<1)+(p?1:0),Math.round(63*l)+128,Math.round(63*c)+128,1+(v===0?0:v<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const C=Jt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,C)}const I=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),w.primitiveLength++),p?this.e2=I:this.e1=I,S!=null&&this.zOffsetVertexArray.emplaceBack(S.zOffset,S.variableWidth,S.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function B1(o,e,i){return o.x<e||o.x>i||o.y<e||o.y>i}let bE,wE;function TE(o,e,i){return e*(At/(o.tileSize*Math.pow(2,i-o.tileID.overscaledZ)))}Ft(F1,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const SE=(o,e,i)=>(1-i)*o+i*e;function EE(o,e){return 1/TE(o,1,e.tileZoom)}function AE(o,e,i,l){return o.translatePosMatrix(l||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const IE=o=>{const e=[];ME(o)&&e.push("RENDER_LINE_DASH"),o.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=o.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),o.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const l=o.layout.get("line-join").constantOr("miter")==="none",c=!!o.paint.get("line-pattern").constantOr(1);return l&&c&&e.push("LINE_JOIN_NONE"),e};function ME(o){const e=o.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let N1;const CE=()=>N1||(N1={layout:bE||(bE=new Xi({"line-cap":new Ot(Ne.layout_line["line-cap"]),"line-join":new Ot(Ne.layout_line["line-join"]),"line-miter-limit":new wt(Ne.layout_line["line-miter-limit"]),"line-round-limit":new wt(Ne.layout_line["line-round-limit"]),"line-sort-key":new Ot(Ne.layout_line["line-sort-key"]),"line-z-offset":new Ot(Ne.layout_line["line-z-offset"]),"line-elevation-reference":new wt(Ne.layout_line["line-elevation-reference"]),"line-cross-slope":new wt(Ne.layout_line["line-cross-slope"]),visibility:new wt(Ne.layout_line.visibility),"line-width-unit":new wt(Ne.layout_line["line-width-unit"])})),paint:wE||(wE=new Xi({"line-opacity":new Ot(Ne.paint_line["line-opacity"]),"line-color":new Ot(Ne.paint_line["line-color"]),"line-translate":new wt(Ne.paint_line["line-translate"]),"line-translate-anchor":new wt(Ne.paint_line["line-translate-anchor"]),"line-width":new Ot(Ne.paint_line["line-width"]),"line-gap-width":new Ot(Ne.paint_line["line-gap-width"]),"line-offset":new Ot(Ne.paint_line["line-offset"]),"line-blur":new Ot(Ne.paint_line["line-blur"]),"line-dasharray":new Ot(Ne.paint_line["line-dasharray"]),"line-pattern":new Ot(Ne.paint_line["line-pattern"]),"line-pattern-cross-fade":new wt(Ne.paint_line["line-pattern-cross-fade"]),"line-gradient":new wl(Ne.paint_line["line-gradient"]),"line-trim-offset":new wt(Ne.paint_line["line-trim-offset"]),"line-trim-fade-range":new wt(Ne.paint_line["line-trim-fade-range"]),"line-trim-color":new wt(Ne.paint_line["line-trim-color"]),"line-emissive-strength":new wt(Ne.paint_line["line-emissive-strength"]),"line-border-width":new Ot(Ne.paint_line["line-border-width"]),"line-border-color":new Ot(Ne.paint_line["line-border-color"]),"line-occlusion-opacity":new wt(Ne.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},N1);class k5 extends Ot{possiblyEvaluate(e,i){return i=new si(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition}),super.possiblyEvaluate(e,i)}evaluate(e,i,l,c){return i=$e({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,l,c)}}let mm;function PE(o,e){return e>0?e+2*o:o}const O5=Yn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),F5=Yn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),B5=Yn([{name:"a_projected_pos",components:4,type:"Float32"}],4);Yn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const N5=Yn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),V5=Yn([{name:"a_texb",components:2,type:"Uint16"}]),U5=Yn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),j5=Yn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Yn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const zE=Yn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),$5=Yn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Yn([{name:"triangle",components:3,type:"Uint16"}]),Yn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Yn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Yn([{type:"Float32",name:"offsetX"}]),Yn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Pr=24;function G5(o,e,i){return o.sections.forEach(l=>{l.text=function(c,d,p){const v=d.layout.get("text-transform").evaluate(p,{});return v==="uppercase"?c=c.toLocaleUpperCase():v==="lowercase"&&(c=c.toLocaleLowerCase()),Yo.applyArabicShaping&&(c=Yo.applyArabicShaping(c)),c}(l.text,e,i)}),o}const _m={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹","â":"â","â":"â"};function q5(o){return o==="ï¸¶"||o==="ï¹"||o==="ï¸¸"||o==="ï¹"||o==="ï¹"||o==="ï¸¾"||o==="ï¸¼"||o==="ï¸º"||o==="ï¸"||o==="ï¹"||o==="ï¸"||o==="ï¸"||o==="ï¸"||o==="ï½"||o==="ï¿£"||o==="ï¸"||o==="ï¸"}function H5(o){return o==="ï¸µ"||o==="ï¹"||o==="ï¸·"||o==="ï¹"||o==="ï¹"||o==="ï¸½"||o==="ï¸»"||o==="ï¸¹"||o==="ï¸"||o==="ï¸¿"}var RE,V1,DE,U1={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function Z5(){return RE||(RE=1,U1.read=function(o,e,i,l,c){var d,p,v=8*c-l-1,w=(1<<v)-1,S=w>>1,I=-7,C=i?c-1:0,R=i?-1:1,B=o[e+C];for(C+=R,d=B&(1<<-I)-1,B>>=-I,I+=v;I>0;d=256*d+o[e+C],C+=R,I-=8);for(p=d&(1<<-I)-1,d>>=-I,I+=l;I>0;p=256*p+o[e+C],C+=R,I-=8);if(d===0)d=1-S;else{if(d===w)return p?NaN:1/0*(B?-1:1);p+=Math.pow(2,l),d-=S}return(B?-1:1)*p*Math.pow(2,d-l)},U1.write=function(o,e,i,l,c,d){var p,v,w,S=8*d-c-1,I=(1<<S)-1,C=I>>1,R=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,B=l?0:d-1,N=l?1:-1,$=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(v=isNaN(e)?1:0,p=I):(p=Math.floor(Math.log(e)/Math.LN2),e*(w=Math.pow(2,-p))<1&&(p--,w*=2),(e+=p+C>=1?R/w:R*Math.pow(2,1-C))*w>=2&&(p++,w/=2),p+C>=I?(v=0,p=I):p+C>=1?(v=(e*w-1)*Math.pow(2,c),p+=C):(v=e*Math.pow(2,C-1)*Math.pow(2,c),p=0));c>=8;o[i+B]=255&v,B+=N,v/=256,c-=8);for(p=p<<c|v,S+=c;S>0;o[i+B]=255&p,B+=N,p/=256,S-=8);o[i+B-N]|=128*$}),U1}function LE(){if(DE)return V1;DE=1,V1=e;var o=Z5();function e(G){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(G)?G:new Uint8Array(G||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=4294967296,l=1/i,c=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function d(G){return G.type===e.Bytes?G.readVarint()+G.pos:G.pos+1}function p(G,ne,ae){return ae?4294967296*ne+(G>>>0):4294967296*(ne>>>0)+(G>>>0)}function v(G,ne,ae){var de=ne<=16383?1:ne<=2097151?2:ne<=268435455?3:Math.floor(Math.log(ne)/(7*Math.LN2));ae.realloc(de);for(var be=ae.pos-1;be>=G;be--)ae.buf[be+de]=ae.buf[be]}function w(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeVarint(G[ae])}function S(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeSVarint(G[ae])}function I(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeFloat(G[ae])}function C(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeDouble(G[ae])}function R(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeBoolean(G[ae])}function B(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeFixed32(G[ae])}function N(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeSFixed32(G[ae])}function $(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeFixed64(G[ae])}function X(G,ne){for(var ae=0;ae<G.length;ae++)ne.writeSFixed64(G[ae])}function K(G,ne){return(G[ne]|G[ne+1]<<8|G[ne+2]<<16)+16777216*G[ne+3]}function le(G,ne,ae){G[ae]=ne,G[ae+1]=ne>>>8,G[ae+2]=ne>>>16,G[ae+3]=ne>>>24}function re(G,ne){return(G[ne]|G[ne+1]<<8|G[ne+2]<<16)+(G[ne+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(G,ne,ae){for(ae=ae||this.length;this.pos<ae;){var de=this.readVarint(),be=de>>3,Ie=this.pos;this.type=7&de,G(be,ne,this),this.pos===Ie&&this.skip(de)}return ne},readMessage:function(G,ne){return this.readFields(G,ne,this.readVarint()+this.pos)},readFixed32:function(){var G=K(this.buf,this.pos);return this.pos+=4,G},readSFixed32:function(){var G=re(this.buf,this.pos);return this.pos+=4,G},readFixed64:function(){var G=K(this.buf,this.pos)+K(this.buf,this.pos+4)*i;return this.pos+=8,G},readSFixed64:function(){var G=K(this.buf,this.pos)+re(this.buf,this.pos+4)*i;return this.pos+=8,G},readFloat:function(){var G=o.read(this.buf,this.pos,!0,23,4);return this.pos+=4,G},readDouble:function(){var G=o.read(this.buf,this.pos,!0,52,8);return this.pos+=8,G},readVarint:function(G){var ne,ae,de=this.buf;return ne=127&(ae=de[this.pos++]),ae<128?ne:(ne|=(127&(ae=de[this.pos++]))<<7,ae<128?ne:(ne|=(127&(ae=de[this.pos++]))<<14,ae<128?ne:(ne|=(127&(ae=de[this.pos++]))<<21,ae<128?ne:function(be,Ie,Me){var ke,Ye,ft=Me.buf;if(ke=(112&(Ye=ft[Me.pos++]))>>4,Ye<128||(ke|=(127&(Ye=ft[Me.pos++]))<<3,Ye<128)||(ke|=(127&(Ye=ft[Me.pos++]))<<10,Ye<128)||(ke|=(127&(Ye=ft[Me.pos++]))<<17,Ye<128)||(ke|=(127&(Ye=ft[Me.pos++]))<<24,Ye<128)||(ke|=(1&(Ye=ft[Me.pos++]))<<31,Ye<128))return p(be,ke,Ie);throw new Error("Expected varint not more than 10 bytes")}(ne|=(15&(ae=de[this.pos]))<<28,G,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var G=this.readVarint();return G%2==1?(G+1)/-2:G/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var G=this.readVarint()+this.pos,ne=this.pos;return this.pos=G,G-ne>=12&&c?function(ae,de,be){return c.decode(ae.subarray(de,be))}(this.buf,ne,G):function(ae,de,be){for(var Ie="",Me=de;Me<be;){var ke,Ye,ft,at=ae[Me],ht=null,_t=at>239?4:at>223?3:at>191?2:1;if(Me+_t>be)break;_t===1?at<128&&(ht=at):_t===2?(192&(ke=ae[Me+1]))==128&&(ht=(31&at)<<6|63&ke)<=127&&(ht=null):_t===3?(Ye=ae[Me+2],(192&(ke=ae[Me+1]))==128&&(192&Ye)==128&&((ht=(15&at)<<12|(63&ke)<<6|63&Ye)<=2047||ht>=55296&&ht<=57343)&&(ht=null)):_t===4&&(Ye=ae[Me+2],ft=ae[Me+3],(192&(ke=ae[Me+1]))==128&&(192&Ye)==128&&(192&ft)==128&&((ht=(15&at)<<18|(63&ke)<<12|(63&Ye)<<6|63&ft)<=65535||ht>=1114112)&&(ht=null)),ht===null?(ht=65533,_t=1):ht>65535&&(ht-=65536,Ie+=String.fromCharCode(ht>>>10&1023|55296),ht=56320|1023&ht),Ie+=String.fromCharCode(ht),Me+=_t}return Ie}(this.buf,ne,G)},readBytes:function(){var G=this.readVarint()+this.pos,ne=this.buf.subarray(this.pos,G);return this.pos=G,ne},readPackedVarint:function(G,ne){if(this.type!==e.Bytes)return G.push(this.readVarint(ne));var ae=d(this);for(G=G||[];this.pos<ae;)G.push(this.readVarint(ne));return G},readPackedSVarint:function(G){if(this.type!==e.Bytes)return G.push(this.readSVarint());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readSVarint());return G},readPackedBoolean:function(G){if(this.type!==e.Bytes)return G.push(this.readBoolean());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readBoolean());return G},readPackedFloat:function(G){if(this.type!==e.Bytes)return G.push(this.readFloat());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readFloat());return G},readPackedDouble:function(G){if(this.type!==e.Bytes)return G.push(this.readDouble());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readDouble());return G},readPackedFixed32:function(G){if(this.type!==e.Bytes)return G.push(this.readFixed32());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readFixed32());return G},readPackedSFixed32:function(G){if(this.type!==e.Bytes)return G.push(this.readSFixed32());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readSFixed32());return G},readPackedFixed64:function(G){if(this.type!==e.Bytes)return G.push(this.readFixed64());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readFixed64());return G},readPackedSFixed64:function(G){if(this.type!==e.Bytes)return G.push(this.readSFixed64());var ne=d(this);for(G=G||[];this.pos<ne;)G.push(this.readSFixed64());return G},skip:function(G){var ne=7&G;if(ne===e.Varint)for(;this.buf[this.pos++]>127;);else if(ne===e.Bytes)this.pos=this.readVarint()+this.pos;else if(ne===e.Fixed32)this.pos+=4;else{if(ne!==e.Fixed64)throw new Error("Unimplemented type: "+ne);this.pos+=8}},writeTag:function(G,ne){this.writeVarint(G<<3|ne)},realloc:function(G){for(var ne=this.length||16;ne<this.pos+G;)ne*=2;if(ne!==this.length){var ae=new Uint8Array(ne);ae.set(this.buf),this.buf=ae,this.length=ne}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(G){this.realloc(4),le(this.buf,G,this.pos),this.pos+=4},writeSFixed32:function(G){this.realloc(4),le(this.buf,G,this.pos),this.pos+=4},writeFixed64:function(G){this.realloc(8),le(this.buf,-1&G,this.pos),le(this.buf,Math.floor(G*l),this.pos+4),this.pos+=8},writeSFixed64:function(G){this.realloc(8),le(this.buf,-1&G,this.pos),le(this.buf,Math.floor(G*l),this.pos+4),this.pos+=8},writeVarint:function(G){(G=+G||0)>268435455||G<0?function(ne,ae){var de,be;if(ne>=0?(de=ne%4294967296|0,be=ne/4294967296|0):(be=~(-ne/4294967296),4294967295^(de=~(-ne%4294967296))?de=de+1|0:(de=0,be=be+1|0)),ne>=18446744073709552e3||ne<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");ae.realloc(10),function(Ie,Me,ke){ke.buf[ke.pos++]=127&Ie|128,Ie>>>=7,ke.buf[ke.pos++]=127&Ie|128,Ie>>>=7,ke.buf[ke.pos++]=127&Ie|128,Ie>>>=7,ke.buf[ke.pos++]=127&Ie|128,ke.buf[ke.pos]=127&(Ie>>>=7)}(de,0,ae),function(Ie,Me){var ke=(7&Ie)<<4;Me.buf[Me.pos++]|=ke|((Ie>>>=3)?128:0),Ie&&(Me.buf[Me.pos++]=127&Ie|((Ie>>>=7)?128:0),Ie&&(Me.buf[Me.pos++]=127&Ie|((Ie>>>=7)?128:0),Ie&&(Me.buf[Me.pos++]=127&Ie|((Ie>>>=7)?128:0),Ie&&(Me.buf[Me.pos++]=127&Ie|((Ie>>>=7)?128:0),Ie&&(Me.buf[Me.pos++]=127&Ie)))))}(be,ae)}(G,this):(this.realloc(4),this.buf[this.pos++]=127&G|(G>127?128:0),G<=127||(this.buf[this.pos++]=127&(G>>>=7)|(G>127?128:0),G<=127||(this.buf[this.pos++]=127&(G>>>=7)|(G>127?128:0),G<=127||(this.buf[this.pos++]=G>>>7&127))))},writeSVarint:function(G){this.writeVarint(G<0?2*-G-1:2*G)},writeBoolean:function(G){this.writeVarint(!!G)},writeString:function(G){G=String(G),this.realloc(4*G.length),this.pos++;var ne=this.pos;this.pos=function(de,be,Ie){for(var Me,ke,Ye=0;Ye<be.length;Ye++){if((Me=be.charCodeAt(Ye))>55295&&Me<57344){if(!ke){Me>56319||Ye+1===be.length?(de[Ie++]=239,de[Ie++]=191,de[Ie++]=189):ke=Me;continue}if(Me<56320){de[Ie++]=239,de[Ie++]=191,de[Ie++]=189,ke=Me;continue}Me=ke-55296<<10|Me-56320|65536,ke=null}else ke&&(de[Ie++]=239,de[Ie++]=191,de[Ie++]=189,ke=null);Me<128?de[Ie++]=Me:(Me<2048?de[Ie++]=Me>>6|192:(Me<65536?de[Ie++]=Me>>12|224:(de[Ie++]=Me>>18|240,de[Ie++]=Me>>12&63|128),de[Ie++]=Me>>6&63|128),de[Ie++]=63&Me|128)}return Ie}(this.buf,G,this.pos);var ae=this.pos-ne;ae>=128&&v(ne,ae,this),this.pos=ne-1,this.writeVarint(ae),this.pos+=ae},writeFloat:function(G){this.realloc(4),o.write(this.buf,G,this.pos,!0,23,4),this.pos+=4},writeDouble:function(G){this.realloc(8),o.write(this.buf,G,this.pos,!0,52,8),this.pos+=8},writeBytes:function(G){var ne=G.length;this.writeVarint(ne),this.realloc(ne);for(var ae=0;ae<ne;ae++)this.buf[this.pos++]=G[ae]},writeRawMessage:function(G,ne){this.pos++;var ae=this.pos;G(ne,this);var de=this.pos-ae;de>=128&&v(ae,de,this),this.pos=ae-1,this.writeVarint(de),this.pos+=de},writeMessage:function(G,ne,ae){this.writeTag(G,e.Bytes),this.writeRawMessage(ne,ae)},writePackedVarint:function(G,ne){ne.length&&this.writeMessage(G,w,ne)},writePackedSVarint:function(G,ne){ne.length&&this.writeMessage(G,S,ne)},writePackedBoolean:function(G,ne){ne.length&&this.writeMessage(G,R,ne)},writePackedFloat:function(G,ne){ne.length&&this.writeMessage(G,I,ne)},writePackedDouble:function(G,ne){ne.length&&this.writeMessage(G,C,ne)},writePackedFixed32:function(G,ne){ne.length&&this.writeMessage(G,B,ne)},writePackedSFixed32:function(G,ne){ne.length&&this.writeMessage(G,N,ne)},writePackedFixed64:function(G,ne){ne.length&&this.writeMessage(G,$,ne)},writePackedSFixed64:function(G,ne){ne.length&&this.writeMessage(G,X,ne)},writeBytesField:function(G,ne){this.writeTag(G,e.Bytes),this.writeBytes(ne)},writeFixed32Field:function(G,ne){this.writeTag(G,e.Fixed32),this.writeFixed32(ne)},writeSFixed32Field:function(G,ne){this.writeTag(G,e.Fixed32),this.writeSFixed32(ne)},writeFixed64Field:function(G,ne){this.writeTag(G,e.Fixed64),this.writeFixed64(ne)},writeSFixed64Field:function(G,ne){this.writeTag(G,e.Fixed64),this.writeSFixed64(ne)},writeVarintField:function(G,ne){this.writeTag(G,e.Varint),this.writeVarint(ne)},writeSVarintField:function(G,ne){this.writeTag(G,e.Varint),this.writeSVarint(ne)},writeStringField:function(G,ne){this.writeTag(G,e.Bytes),this.writeString(ne)},writeFloatField:function(G,ne){this.writeTag(G,e.Fixed32),this.writeFloat(ne)},writeDoubleField:function(G,ne){this.writeTag(G,e.Fixed64),this.writeDouble(ne)},writeBooleanField:function(G,ne){this.writeVarintField(G,!!ne)}},V1}var m0=Ts(LE());const j1=3;function W5(o,e,i){e.glyphs=[],o===1&&i.readMessage(X5,e)}function X5(o,e,i){if(o===3){const{id:l,bitmap:c,width:d,height:p,left:v,top:w,advance:S}=i.readMessage(Y5,{});e.glyphs.push({id:l,bitmap:new Dc({width:d+2*j1,height:p+2*j1},c),metrics:{width:d,height:p,left:v,top:w,advance:S}})}else o===4?e.ascender=i.readSVarint():o===5&&(e.descender=i.readSVarint())}function Y5(o,e,i){o===1?e.id=i.readVarint():o===2?e.bitmap=i.readBytes():o===3?e.width=i.readVarint():o===4?e.height=i.readVarint():o===5?e.left=i.readSVarint():o===6?e.top=i.readSVarint():o===7&&(e.advance=i.readVarint())}const K5=j1,Po={horizontal:1,vertical:2,horizontalOnly:3};class gm{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const l=new gm;return l.scale=e||1,l.fontStack=i,l}static forImage(e){const i=new gm;return i.image=e,i}}class qf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,l){const c=new qf;for(let d=0;d<e.sections.length;d++){const p=e.sections[d];p.image?c.addImageSection(p,l):c.addTextSection(p,i)}return c}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,l){let c="";for(let d=0;d<i.length;d++){const p=i.charCodeAt(d+1)||null,v=i.charCodeAt(d-1)||null;c+=!l&&(p&&zg(p)&&!_m[i[d+1]]||v&&zg(v)&&!_m[i[d-1]])||!_m[i[d]]?i[d]:_m[i[d]]}return c}(this.text,e)}trim(){let e=0;for(let l=0;l<this.text.length&&_0[this.text.charCodeAt(l)];l++)e++;let i=this.text.length;for(let l=this.text.length-1;l>=0&&l>=e&&_0[this.text.charCodeAt(l)];l--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const l=new qf;return l.text=this.text.substring(e,i),l.sectionIndex=this.sectionIndex.slice(e,i),l.sections=this.sections,l}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(gm.forText(e.scale,e.fontStack||i));const l=this.sections.length-1;for(let c=0;c<e.text.length;++c)this.sectionIndex.push(l)}addImageSection(e,i){const l=e.image?e.image.getPrimary():null;if(!l)return void Dn("Can't add FormattedSection with an empty image.");l.scaleSelf(i);const c=this.getNextImageSectionCharCode();c?(this.text+=String.fromCodePoint(c),this.sections.push(gm.forImage(l)),this.sectionIndex.push(this.sections.length-1)):Dn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function $1(o,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$=1){const X=qf.fromFeature(o,c,$);C===Po.vertical&&X.verticalizePunctuation(R);let K=[];const le=function(de,be,Ie,Me,ke,Ye){if(!de)return[];const ft=[],at=function(ct,Ge,Xe,yt,vt,Wt){let Nt=0;for(let Mt=0;Mt<ct.length();Mt++){const gt=ct.getSection(Mt);Nt+=kE(ct.getCodePoint(Mt),gt,yt,vt,Ge,Wt)}return Nt/Math.max(1,Math.ceil(Nt/Xe))}(de,be,Ie,Me,ke,Ye),ht=de.text.indexOf("â")>=0;let _t=0;for(let ct=0;ct<de.length();ct++){const Ge=de.getSection(ct),Xe=de.getCodePoint(ct);if(_0[Xe]||(_t+=kE(Xe,Ge,Me,ke,be,Ye)),ct<de.length()-1){const yt=!((We=Xe)<11904||!(Qt["Bopomofo Extended"](We)||Qt.Bopomofo(We)||Qt["CJK Compatibility Forms"](We)||Qt["CJK Compatibility Ideographs"](We)||Qt["CJK Compatibility"](We)||Qt["CJK Radicals Supplement"](We)||Qt["CJK Strokes"](We)||Qt["CJK Symbols and Punctuation"](We)||Qt["CJK Unified Ideographs Extension A"](We)||Qt["CJK Unified Ideographs"](We)||Qt["Enclosed CJK Letters and Months"](We)||Qt["Halfwidth and Fullwidth Forms"](We)||Qt.Hiragana(We)||Qt["Ideographic Description Characters"](We)||Qt["Kangxi Radicals"](We)||Qt["Katakana Phonetic Extensions"](We)||Qt.Katakana(We)||Qt["Vertical Forms"](We)||Qt["Yi Radicals"](We)||Qt["Yi Syllables"](We)));(J5[Xe]||yt||Ge.image)&&ft.push(FE(ct+1,_t,at,ft,Q5(Xe,de.getCodePoint(ct+1),yt&&ht),!1))}}var We;return BE(FE(de.length(),_t,at,ft,0,!0))}(X,S,d,e,l,B),{processBidirectionalText:re,processStyledBidirectionalText:G}=Yo;if(re&&X.sections.length===1){const de=re(X.toString(),le);for(const be of de){const Ie=new qf;Ie.text=be,Ie.sections=X.sections;for(let Me=0;Me<be.length;Me++)Ie.sectionIndex.push(0);K.push(Ie)}}else if(G){const de=G(X.text,X.sectionIndex,le);for(const be of de){const Ie=new qf;Ie.text=be[0],Ie.sectionIndex=be[1],Ie.sections=X.sections,K.push(Ie)}}else K=function(de,be){const Ie=[],Me=de.text;let ke=0;for(const Ye of be)Ie.push(de.substring(ke,Ye)),ke=Ye;return ke<Me.length&&Ie.push(de.substring(ke,Me.length)),Ie}(X,le);const ne=[],ae={positionedLines:ne,text:X.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:C,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(de,be,Ie,Me,ke,Ye,ft,at,ht,_t,We,ct){let Ge=0,Xe=0,yt=0;const vt=at==="right"?1:at==="left"?0:.5;let Wt=!1;for(const Gt of ke){const on=Gt.getSections();for(const mn of on){if(mn.image)continue;const gn=be[mn.fontStack];if(gn&&(Wt=gn.ascender!==void 0&&gn.descender!==void 0,!Wt))break}if(!Wt)break}let Nt=0;for(const Gt of ke){Gt.trim();const on=Gt.getMaxScale(),mn=(on-1)*Pr,gn={positionedGlyphs:[],lineOffset:0};de.positionedLines[Nt]=gn;const Cn=gn.positionedGlyphs;let Sn=0;if(!Gt.length()){Xe+=Ye,++Nt;continue}let bn=0,hi=0;for(let he=0;he<Gt.length();he++){const pe=Gt.getSection(he),Je=Gt.getSectionIndex(he),Tt=Gt.getCodePoint(he);let zt=pe.scale,Pt=null,qt=null,nn=null,kn=Pr,On=0;ht===Po.vertical&&((Mt=Tt)===12312||Mt===12313||Mt===12316||Mt===12540||Mt===12448)&&(ht=Po.horizontal);const wn=!(ht===Po.horizontal||!We&&!Bu(Tt)||We&&(_0[Tt]||t1(Tt)));if(pe.image){const ri=Me.get(pe.image.toString());if(!ri)continue;nn=pe.image,de.iconsInText=de.iconsInText||!0,qt=ri.paddedRect;const yi=ri.displaySize;zt=zt*Pr/ct,Pt={width:yi[0],height:yi[1],left:0,top:-3,advance:wn?yi[1]:yi[0],localGlyph:!1},On=Wt?-Pt.height*zt:on*Pr-17-yi[1]*zt,kn=Pt.advance;const Fn=(wn?yi[0]:yi[1])*zt-Pr*on;Fn>0&&Fn>Sn&&(Sn=Fn)}else{const ri=Ie[pe.fontStack];if(!ri)continue;ri[Tt]&&(qt=ri[Tt]);const yi=be[pe.fontStack];if(!yi)continue;const Fn=yi.glyphs[Tt];if(!Fn)continue;if(Pt=Fn.metrics,kn=Tt!==8203?Pr:0,Wt){const ji=yi.ascender!==void 0?Math.abs(yi.ascender):0,Ai=yi.descender!==void 0?Math.abs(yi.descender):0,ei=(ji+Ai)*zt;bn<ei&&(bn=ei,hi=(ji-Ai)/2*zt),On=-ji*zt}else On=(on-zt)*Pr-17}wn?(de.verticalizable=!0,Cn.push({glyph:Tt,image:nn,x:Ge,y:Xe+On,vertical:wn,scale:zt,localGlyph:Pt.localGlyph,fontStack:pe.fontStack,sectionIndex:Je,metrics:Pt,rect:qt}),Ge+=kn*zt+_t):(Cn.push({glyph:Tt,image:nn,x:Ge,y:Xe+On,vertical:wn,scale:zt,localGlyph:Pt.localGlyph,fontStack:pe.fontStack,sectionIndex:Je,metrics:Pt,rect:qt}),Ge+=Pt.advance*zt+_t)}Cn.length!==0&&(yt=Math.max(Ge-_t,yt),Wt?NE(Cn,vt,Sn,hi,Ye*on/2):NE(Cn,vt,Sn,0,Ye/2)),Ge=0;const Ei=Ye*on+Sn;gn.lineOffset=Math.max(Sn,mn),Xe+=Ei,++Nt}var Mt;const gt=Xe,{horizontalAlign:ln,verticalAlign:$t}=G1(ft);(function(Gt,on,mn,gn,Cn,Sn){const bn=(on-mn)*Cn,hi=-Sn*gn;for(const Ei of Gt)for(const he of Ei.positionedGlyphs)he.x+=bn,he.y+=hi})(de.positionedLines,vt,ln,$t,yt,gt),de.top+=-$t*gt,de.bottom=de.top+gt,de.left+=-ln*yt,de.right=de.left+yt,de.hasBaseline=Wt}(ae,e,i,l,K,p,v,w,C,S,R,N),!function(de){for(const be of de)if(be.positionedGlyphs.length!==0)return!1;return!0}(ne))return ae}const _0={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},J5={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function kE(o,e,i,l,c,d){if(e.image){const p=l.get(e.image.toString());return p?p.displaySize[0]*e.scale*Pr/d+c:0}{const p=i[e.fontStack],v=p&&p.glyphs[o];return v?v.metrics.advance*e.scale+c:0}}function OE(o,e,i,l){const c=Math.pow(o-e,2);return l?o<e?c/2:2*c:c+Math.abs(i)*i}function Q5(o,e,i){let l=0;return o===10&&(l-=1e4),i&&(l+=150),o!==40&&o!==65288||(l+=50),e!==41&&e!==65289||(l+=50),l}function FE(o,e,i,l,c,d){let p=null,v=OE(e,i,c,d);for(const w of l){const S=OE(e-w.x,i,c,d)+w.badness;S<=v&&(p=w,v=S)}return{index:o,x:e,priorBreak:p,badness:v}}function BE(o){return o?BE(o.priorBreak).concat(o.index):[]}function G1(o){let e=.5,i=.5;switch(o){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(o){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function NE(o,e,i,l,c){if(!(e||i||l||c))return;const d=o.length-1,p=o[d],v=(p.x+p.metrics.advance*p.scale)*e;for(let w=0;w<=d;w++)o[w].x-=v,o[w].y+=i+l+c}function VE(o){return o.imagePrimary!==void 0&&o.top!==void 0&&o.bottom!==void 0&&o.left!==void 0&&o.right!==void 0}function ek(o,e,i,l){const{horizontalAlign:c,verticalAlign:d}=G1(l),p=i[0]-o.displaySize[0]*c,v=i[1]-o.displaySize[1]*d;return{imagePrimary:o,imageSecondary:e,top:v,bottom:v+o.displaySize[1],left:p,right:p+o.displaySize[0]}}function UE(o,e,i,l,c,d){const p=o.imagePrimary;let v;if(p.content){const X=p.content,K=p.pixelRatio||1;v=[X[0]/K,X[1]/K,p.displaySize[0]-X[2]/K,p.displaySize[1]-X[3]/K]}const w=e.left*d,S=e.right*d;let I,C,R,B;i==="width"||i==="both"?(B=c[0]+w-l[3],C=c[0]+S+l[1]):(B=c[0]+(w+S-p.displaySize[0])/2,C=B+p.displaySize[0]);const N=e.top*d,$=e.bottom*d;return i==="height"||i==="both"?(I=c[1]+N-l[0],R=c[1]+$+l[2]):(I=c[1]+(N+$-p.displaySize[1])/2,R=I+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:I,right:C,bottom:R,left:B,collisionPadding:v}}function jE(o){return!o.imagePrimary.stretchX}function $E(o){return!o.imagePrimary.stretchY}function GE(o){return{width:o.right-o.left,height:o.bottom-o.top}}const ka=128;function qE(o,e){const{expression:i}=e;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new si(o+1))};if(i.kind==="source")return{kind:"source"};{const{zoomStops:l,interpolationType:c}=i;let d=0;for(;d<l.length&&l[d]<=o;)d++;d=Math.max(0,d-1);let p=d;for(;p<l.length&&l[p]<o+1;)p++;p=Math.min(l.length-1,p);const v=l[d],w=l[p];return i.kind==="composite"?{kind:"composite",minZoom:v,maxZoom:w,interpolationType:c}:{kind:"camera",minZoom:v,maxZoom:w,minSize:i.evaluate(new si(v)),maxSize:i.evaluate(new si(w)),interpolationType:c}}}function q1(o,{uSize:e,uSizeT:i},{lowerSize:l,upperSize:c}){return o.kind==="source"?l/ka:o.kind==="composite"?Jt(l/ka,c/ka,i):e}function ym(o,e,i=1){let l=0,c=0;if(o.kind==="constant")c=o.layoutSize*i;else if(o.kind!=="source"){const{interpolationType:d,minZoom:p,maxZoom:v}=o,w=d?ze(uo.interpolationFactor(d,e,p,v),0,1):0;o.kind==="camera"?c=Jt(o.minSize,o.maxSize,w)*i:l=w*i}return{uSizeT:l,uSize:c}}class Pl extends St{constructor(e,i,l,c,d){super(e,i),this.angle=c,this.z=l,d!==void 0&&(this.segment=d)}clone(){return new Pl(this.x,this.y,this.z,this.angle,this.segment)}}function HE(o,e,i,l,c){if(e.segment===void 0)return!0;let d=e,p=e.segment+1,v=0;for(;v>-i/2;){if(p--,p<0)return!1;v-=o[p].dist(d),d=o[p]}v+=o[p].dist(o[p+1]),p++;const w=[];let S=0;for(;v<i/2;){const I=o[p],C=o[p+1];if(!C)return!1;let R=o[p-1].angleTo(I)-I.angleTo(C);for(R=Math.abs((R+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:v,angleDelta:R}),S+=R;v-w[0].distance>l;)S-=w.shift().angleDelta;if(S>c)return!1;p++,v+=I.dist(C)}return!0}function ZE(o){let e=0;for(let i=0;i<o.length-1;i++)e+=o[i].dist(o[i+1]);return e}function WE(o,e,i){return o?.6*e*i:0}function XE(o,e){return Math.max(o?o.right-o.left:0,e?e.right-e.left:0)}function tk(o,e,i,l,c,d){const p=WE(i,c,d),v=XE(i,l)*d;let w=0;const S=ZE(o)/2;for(let I=0;I<o.length-1;I++){const C=o[I],R=o[I+1],B=C.dist(R);if(w+B>S){const N=(S-w)/B,$=Jt(C.x,R.x,N),X=Jt(C.y,R.y,N),K=new Pl($,X,0,R.angleTo(C),I);return!p||HE(o,K,v,p,e)?K:void 0}w+=B}}function nk(o,e,i,l,c,d,p,v,w){const S=WE(l,d,p),I=XE(l,c),C=I*p,R=o[0].x===0||o[0].x===w||o[0].y===0||o[0].y===w;return e-C<e/4&&(e=C+e/4),YE(o,R?e/2*v%e:(I/2+2*d)*p*v%e,e,S,i,C,R,!1,w)}function YE(o,e,i,l,c,d,p,v,w){const S=d/2,I=ZE(o);let C=0,R=e-i,B=[];for(let N=0;N<o.length-1;N++){const $=o[N],X=o[N+1],K=$.dist(X),le=X.angleTo($);for(;R+i<C+K;){R+=i;const re=(R-C)/K,G=Jt($.x,X.x,re),ne=Jt($.y,X.y,re);if(G>=0&&G<w&&ne>=0&&ne<w&&R-S>=0&&R+S<=I){const ae=new Pl(G,ne,0,le,N);l&&!HE(o,ae,d,l,c)||B.push(ae)}}C+=K}return v||B.length||p||(B=YE(o,C/2,i,l,c,d,p,!0,w)),B}function KE(o){let e=0,i=0;for(const p of o)e+=p.w*p.h,i=Math.max(i,p.w);o.sort((p,v)=>v.h-p.h);const l=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let c=0,d=0;for(const p of o)for(let v=l.length-1;v>=0;v--){const w=l[v];if(!(p.w>w.w||p.h>w.h)){if(p.x=w.x,p.y=w.y,d=Math.max(d,p.y+p.h),c=Math.max(c,p.x+p.w),p.w===w.w&&p.h===w.h){const S=l.pop();v<l.length&&(l[v]=S)}else p.h===w.h?(w.x+=p.w,w.w-=p.w):p.w===w.w?(w.y+=p.h,w.h-=p.h):(l.push({x:w.x+p.w,y:w.y,w:w.w-p.w,h:p.h}),w.y+=p.h,w.h-=p.h);break}}return{w:c,h:d,fill:e/(c*d)||0}}Ft(Pl,"Anchor");const ih=1;class vm{static getImagePositionScale(e,i,l){if(i&&e&&e.options&&e.options.transform){const c=e.options.transform;return{x:c.a,y:c.d}}return{x:l,y:l}}constructor(e,i,l,c){this.paddedRect=e;const{pixelRatio:d,version:p,stretchX:v,stretchY:w,content:S,sdf:I,usvg:C}=i;this.pixelRatio=d,this.stretchX=v,this.stretchY=w,this.content=S,this.version=p,this.padding=l,this.sdf=I,this.scale=vm.getImagePositionScale(c,C,d)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function H1(o,e,i){const l=as.parse(o),c=function(d,p,v=[1,1]){return{x:0,y:0,w:(d.data?d.data.width:d.width*v[0])+2*p,h:(d.data?d.data.height:d.height*v[1])+2*p}}(e,i,[l.options.transform.a,l.options.transform.d]);return{bin:c,imagePosition:new vm(c,e,i,l),imageVariant:l}}class JE{constructor(e,i,l){const c=new Map,d=new Map;this.haveRenderCallbacks=[];const p=[];this.addImages(e,c,ih,p),this.addImages(i,d,2,p);const{w:v,h:w}=KE(p),S=new Fr({width:v||1,height:w||1});for(const[I,C]of e.entries()){const R=c.get(I).paddedRect;Fr.copy(C.data,S,{x:0,y:0},{x:R.x+ih,y:R.y+ih},C.data,l,C.sdf)}for(const[I,C]of i.entries()){const R=d.get(I),B=R.paddedRect;let N=R.padding;const $=B.x+N,X=B.y+N,K=C.data.width,le=C.data.height;N=N>1?N-1:N,Fr.copy(C.data,S,{x:0,y:0},{x:$,y:X},C.data,l),Fr.copy(C.data,S,{x:0,y:le-N},{x:$,y:X-N},{width:K,height:N},l),Fr.copy(C.data,S,{x:0,y:0},{x:$,y:X+le},{width:K,height:N},l),Fr.copy(C.data,S,{x:K-N,y:0},{x:$-N,y:X},{width:N,height:le},l),Fr.copy(C.data,S,{x:0,y:0},{x:$+K,y:X},{width:N,height:le},l),Fr.copy(C.data,S,{x:K-N,y:le-N},{x:$-N,y:X-N},{width:N,height:N},l),Fr.copy(C.data,S,{x:0,y:le-N},{x:$+K,y:X-N},{width:N,height:N},l),Fr.copy(C.data,S,{x:0,y:0},{x:$+K,y:X+le},{width:N,height:N},l),Fr.copy(C.data,S,{x:K-N,y:0},{x:$-N,y:X+le},{width:N,height:N},l)}this.lut=l,this.image=S,this.iconPositions=c,this.patternPositions=d}addImages(e,i,l,c){for(const[d,p]of e.entries()){const{bin:v,imagePosition:w,imageVariant:S}=H1(d,p,l);i.set(d,w),c.push(v),p.hasRenderCallback&&this.haveRenderCallbacks.push(S.id)}}patchUpdatedImages(e,i,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>e.hasImage(c,l)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,l);for(const c of e.getUpdatedImages(l)){for(const d of this.iconPositions.keys()){const p=as.parse(d);if(_o.isEqual(p.id,c)){const v=e.getImage(c,l);this.patchUpdatedImage(this.iconPositions.get(d),v,i)}}for(const d of this.patternPositions.keys()){const p=as.parse(d);if(_o.isEqual(p.id,c)){const v=e.getImage(c,l);this.patchUpdatedImage(this.patternPositions.get(d),v,i)}}}}patchUpdatedImage(e,i,l){if(!e||!i||e.version===i.version)return;e.version=i.version;const[c,d]=e.tl,p=e.sdf;if(this.lut||p){const v={width:i.data.width,height:i.data.height},w=new Fr(v);Fr.copy(i.data,w,{x:0,y:0},{x:0,y:0},v,this.lut,p),l.update(w,{position:{x:c,y:d}})}else l.update(i.data,{position:{x:c,y:d}})}}Ft(vm,"ImagePosition"),Ft(JE,"ImageAtlas");const g0=1e20;function QE(o,e,i,l,c,d,p,v,w){for(let S=e;S<e+l;S++)eA(o,i*d+S,d,c,p,v,w);for(let S=i;S<i+c;S++)eA(o,S*d+e,1,l,p,v,w)}function eA(o,e,i,l,c,d,p){d[0]=0,p[0]=-1e20,p[1]=g0,c[0]=o[e];for(let v=1,w=0,S=0;v<l;v++){c[v]=o[e+v*i];const I=v*v;do{const C=d[w];S=(c[v]-c[C]+I-C*C)/(v-C)/2}while(S<=p[w]&&--w>-1);w++,d[w]=v,p[w]=S,p[w+1]=g0}for(let v=0,w=0;v<l;v++){for(;p[w+1]<v;)w++;const S=d[w],I=v-S;o[e+v*i]=c[S]+I*I}}const ta=2,Z1={none:0,ideographs:1,all:2};class Hf{constructor(e,i,l){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=l,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,l){const c=[],d=this.urls[i]||Or.GLYPHS_URL;for(const p in e)for(const v of e[p])c.push({stack:p,id:v});it(c,({stack:p,id:v},w)=>{let S=this.entries[p];S||(S=this.entries[p]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let I=S.glyphs[v];if(I!==void 0)return void w(null,{stack:p,id:v,glyph:I});if(I=this._tinySDF(S,p,v),I)return S.glyphs[v]=I,void w(null,{stack:p,id:v,glyph:I});const C=Math.floor(v/256);if(256*C>65535)return Dn("glyphs > 65535 not supported"),void w(null,{stack:p,id:v,glyph:I});if(S.ranges[C])return void w(null,{stack:p,id:v,glyph:I});let R=S.requests[C];R||(R=S.requests[C]=[],Hf.loadGlyphRange(p,C,d,this.requestManager,(B,N)=>{if(N){S.ascender=N.ascender,S.descender=N.descender;for(const $ in N.glyphs)this._doesCharSupportLocalGlyph(+$)||(S.glyphs[+$]=N.glyphs[+$]);S.ranges[C]=!0}for(const $ of R)$(B,N);delete S.requests[C]})),R.push((B,N)=>{B?w(B):N&&w(null,{stack:p,id:v,glyph:N.glyphs[v]||null})})},(p,v)=>{if(p)l(p);else if(v){const w={};for(const{stack:S,id:I,glyph:C}of v)w[S]===void 0&&(w[S]={}),w[S].glyphs===void 0&&(w[S].glyphs={}),w[S].glyphs[I]=C&&{id:C.id,bitmap:C.bitmap.clone(),metrics:C.metrics},w[S].ascender=this.entries[S].ascender,w[S].descender=this.entries[S].descender;l(null,w)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Z1.none&&(this.localGlyphMode===Z1.all?!!this.localFontFamily:!!this.localFontFamily&&(Qt["CJK Unified Ideographs"](e)||Qt["Hangul Syllables"](e)||Qt.Hiragana(e)||Qt.Katakana(e)||Qt["CJK Symbols and Punctuation"](e)||Qt["CJK Unified Ideographs Extension A"](e)||Qt["CJK Unified Ideographs Extension B"](e)||Qt.Osage(e)))}_tinySDF(e,i,l){const c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(l))return;let d=e.tinySDF;if(!d){let $="400";/bold/i.test(i)?$="900":/medium/i.test(i)?$="500":/light/i.test(i)&&($="200"),d=e.tinySDF=new Hf.TinySDF({fontFamily:c,fontWeight:$,fontSize:24*ta,buffer:3*ta,radius:8*ta}),d.fontWeight=$}if(this.localGlyphs[d.fontWeight][l])return this.localGlyphs[d.fontWeight][l];const p=String.fromCodePoint(l),{data:v,width:w,height:S,glyphWidth:I,glyphHeight:C,glyphLeft:R,glyphTop:B,glyphAdvance:N}=d.draw(p);return this.localGlyphs[d.fontWeight][l]={id:l,bitmap:new Dc({width:w,height:S},v),metrics:{width:I/ta,height:C/ta,left:R/ta,top:B/ta-27,advance:N/ta,localGlyph:!0}}}}Hf.loadGlyphRange=function(o,e,i,l,c){const d=256*e,p=d+255,v=l.transformRequest(l.normalizeGlyphsURL(i).replace("{fontstack}",o).replace("{range}",`${d}-${p}`),$h.Glyphs);ec(v,(w,S)=>{if(w)c(w);else if(S){const I={},C=function(R){return new m0(R).readFields(W5,{})}(S);for(const R of C.glyphs)I[R.id]=R;c(null,{glyphs:I,ascender:C.ascender,descender:C.descender})}})},Hf.TinySDF=class{constructor({fontSize:o=24,buffer:e=3,radius:i=8,cutoff:l=.25,fontFamily:c="sans-serif",fontWeight:d="normal",fontStyle:p="normal"}={}){this.buffer=e,this.cutoff=l,this.radius=i;const v=this.size=o+4*e,w=this._createCanvas(v),S=this.ctx=w.getContext("2d",{willReadFrequently:!0});S.font=`${p} ${d} ${o}px ${c}`,S.textBaseline="alphabetic",S.textAlign="left",S.fillStyle="black",this.gridOuter=new Float64Array(v*v),this.gridInner=new Float64Array(v*v),this.f=new Float64Array(v),this.z=new Float64Array(v+1),this.v=new Uint16Array(v)}_createCanvas(o){const e=document.createElement("canvas");return e.width=e.height=o,e}draw(o){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:l,actualBoundingBoxLeft:c,actualBoundingBoxRight:d}=this.ctx.measureText(o),p=Math.ceil(i),v=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(d-c))),w=Math.min(this.size-this.buffer,p+Math.ceil(l)),S=v+2*this.buffer,I=w+2*this.buffer,C=Math.max(S*I,0),R=new Uint8ClampedArray(C),B={data:R,width:S,height:I,glyphWidth:v,glyphHeight:w,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(v===0||w===0)return B;const{ctx:N,buffer:$,gridInner:X,gridOuter:K}=this;N.clearRect($,$,v,w),N.fillText(o,$,$+p);const le=N.getImageData($,$,v,w);K.fill(g0,0,C),X.fill(0,0,C);for(let re=0;re<w;re++)for(let G=0;G<v;G++){const ne=le.data[4*(re*v+G)+3]/255;if(ne===0)continue;const ae=(re+$)*S+G+$;if(ne===1)K[ae]=0,X[ae]=g0;else{const de=.5-ne;K[ae]=de>0?de*de:0,X[ae]=de<0?de*de:0}}QE(K,0,0,S,I,S,this.f,this.v,this.z),QE(X,$,$,v,w,S,this.f,this.v,this.z);for(let re=0;re<C;re++){const G=Math.sqrt(K[re])-Math.sqrt(X[re]);R[re]=Math.round(255-255*(G/this.radius+this.cutoff))}return B}};const rh=ih;function tA(o,e){return o+e[1]-e[0]}function nA(o,e,i,l,c=1){const d=[],p=o.imagePrimary,v=p.pixelRatio,w=p.paddedRect.w-2*rh,S=p.paddedRect.h-2*rh,I=(o.right-o.left)*c,C=(o.bottom-o.top)*c,R=p.stretchX||[[0,w]],B=p.stretchY||[[0,S]],N=R.reduce(tA,0),$=B.reduce(tA,0),X=w-N,K=S-$;let le=0,re=N,G=0,ne=$,ae=0,de=X,be=0,Ie=K;if(p.content&&l){const ke=p.content;le=y0(R,0,ke[0]),G=y0(B,0,ke[1]),re=y0(R,ke[0],ke[2]),ne=y0(B,ke[1],ke[3]),ae=ke[0]-le,be=ke[1]-G,de=ke[2]-ke[0]-re,Ie=ke[3]-ke[1]-ne}const Me=(ke,Ye,ft,at)=>{const ht=v0(ke.stretch-le,re,I,o.left*c),_t=x0(ke.fixed-ae,de,ke.stretch,N),We=v0(Ye.stretch-G,ne,C,o.top*c),ct=x0(Ye.fixed-be,Ie,Ye.stretch,$),Ge=v0(ft.stretch-le,re,I,o.left*c),Xe=x0(ft.fixed-ae,de,ft.stretch,N),yt=v0(at.stretch-G,ne,C,o.top*c),vt=x0(at.fixed-be,Ie,at.stretch,$),Wt=new St(ht,We),Nt=new St(Ge,We),Mt=new St(Ge,yt),gt=new St(ht,yt),ln=new St(_t/v,ct/v),$t=new St(Xe/v,vt/v),Gt=e*Math.PI/180;if(Gt){const bn=Math.sin(Gt),hi=Math.cos(Gt),Ei=[hi,-bn,bn,hi];Wt._matMult(Ei),Nt._matMult(Ei),gt._matMult(Ei),Mt._matMult(Ei)}const on=ke.stretch+ke.fixed,mn=ft.stretch+ft.fixed,gn=Ye.stretch+Ye.fixed,Cn=at.stretch+at.fixed,Sn=o.imageSecondary;return{tl:Wt,tr:Nt,bl:gt,br:Mt,texPrimary:{x:p.paddedRect.x+rh+on,y:p.paddedRect.y+rh+gn,w:mn-on,h:Cn-gn},texSecondary:Sn?{x:Sn.paddedRect.x+rh+on,y:Sn.paddedRect.y+rh+gn,w:mn-on,h:Cn-gn}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ln,pixelOffsetBR:$t,minFontScaleX:de/v/I,minFontScaleY:Ie/v/C,isSDF:i}};if(l&&(p.stretchX||p.stretchY)){const ke=iA(R,X,N),Ye=iA(B,K,$);for(let ft=0;ft<ke.length-1;ft++){const at=ke[ft],ht=ke[ft+1];for(let _t=0;_t<Ye.length-1;_t++)d.push(Me(at,Ye[_t],ht,Ye[_t+1]))}}else d.push(Me({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:S+1}));return d}function y0(o,e,i){let l=0;for(const c of o)l+=Math.max(e,Math.min(i,c[1]))-Math.max(e,Math.min(i,c[0]));return l}function iA(o,e,i){const l=[{fixed:-1,stretch:0}];for(const[c,d]of o){const p=l[l.length-1];l.push({fixed:c-p.stretch,stretch:p.stretch}),l.push({fixed:c-p.stretch,stretch:p.stretch+(d-c)})}return l.push({fixed:e+rh,stretch:i}),l}function v0(o,e,i,l){return o/e*i+l}function x0(o,e,i,l){return o-e*i/l}function ik(o,e,i,l){const c=e+o.positionedLines[l].lineOffset;return l===0?i+c/2:i+(c+(e+o.positionedLines[l-1].lineOffset))/2}function rk(o,e=1,i=!1){let l=1/0,c=1/0,d=-1/0,p=-1/0;const v=o[0];for(let B=0;B<v.length;B++){const N=v[B];(!B||N.x<l)&&(l=N.x),(!B||N.y<c)&&(c=N.y),(!B||N.x>d)&&(d=N.x),(!B||N.y>p)&&(p=N.y)}const w=Math.min(d-l,p-c);let S=w/2;const I=new ef([],ok);if(w===0)return new St(l,c);for(let B=l;B<d;B+=w)for(let N=c;N<p;N+=w)I.push(new Zf(B+S,N+S,S,o));let C=function(B){let N=0,$=0,X=0;const K=B[0];for(let le=0,re=K.length,G=re-1;le<re;G=le++){const ne=K[le],ae=K[G],de=ne.x*ae.y-ae.x*ne.y;$+=(ne.x+ae.x)*de,X+=(ne.y+ae.y)*de,N+=3*de}return new Zf($/N,X/N,0,B)}(o),R=I.length;for(;I.length;){const B=I.pop();(B.d>C.d||!C.d)&&(C=B,i&&console.log("found best %d after %d probes",Math.round(1e4*B.d)/1e4,R)),B.max-C.d<=e||(S=B.h/2,I.push(new Zf(B.p.x-S,B.p.y-S,S,o)),I.push(new Zf(B.p.x+S,B.p.y-S,S,o)),I.push(new Zf(B.p.x-S,B.p.y+S,S,o)),I.push(new Zf(B.p.x+S,B.p.y+S,S,o)),R+=4)}return i&&(console.log(`num probes: ${R}`),console.log(`best distance: ${C.d}`)),C.p}function ok(o,e){return e.max-o.max}class Zf{constructor(e,i,l,c){this.p=new St(e,i),this.h=l,this.d=function(d,p){let v=!1,w=1/0;for(let S=0;S<p.length;S++){const I=p[S];for(let C=0,R=I.length,B=R-1;C<R;B=C++){const N=I[C],$=I[B];N.y>d.y!=$.y>d.y&&d.x<($.x-N.x)*(d.y-N.y)/($.y-N.y)+N.x&&(v=!v),w=Math.min(w,Vn(d,N,$))}}return(v?1:-1)*Math.sqrt(w)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}const sk=Object.keys,W1=Number.POSITIVE_INFINITY,ak=Math.sqrt(2);function rA(o,[e,i]){let l=0,c=0;if(i===W1){e<0&&(e=0);const d=e/ak;switch(o){case"top-right":case"top-left":c=d-7;break;case"bottom-right":case"bottom-left":c=7-d;break;case"bottom":c=7-e;break;case"top":c=e-7}switch(o){case"top-right":case"bottom-right":l=-d;break;case"top-left":case"bottom-left":l=d;break;case"left":l=e;break;case"right":l=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),o){case"top-right":case"top-left":case"top":c=i-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-i}switch(o){case"top-right":case"bottom-right":case"right":l=-e;break;case"top-left":case"bottom-left":case"left":l=e}}return[l,c]}function b0(o,e,i,l,c,d,p,v,w){if(!e||!e.usvg)return;const S=GE(l),I=GE(c),C=d!=="both"&&d!=="width"||!jE(l)?1:Math.max(1,I.width/S.width),R=d!=="both"&&d!=="height"||!$E(l)?1:Math.max(1,I.height/S.height);i.scaleSelf(C,R);const B=i.toString();p.set(B,i),v.set(B,e);const{imagePosition:N}=H1(B,e,ih);w.set(B,N)}function oA(o,e,i,l,c,d,p,v){if(!o)return;const w=function(S,I,C,R,B){if(S.kind==="camera")return S.maxSize;if(S.kind==="composite"){const N=I.possiblyEvaluate(new si(S.maxZoom),C).evaluate(B,{},C),$=I.possiblyEvaluate(new si(S.minZoom),C).evaluate(B,{},C);return Math.max(N,$)}return I.possiblyEvaluate(new si(R)).evaluate(B,{},C)}(e,i,l,c,d);return o.scaleSelf(w*v*p)}function sA(o,e,i,l,c,d,p,v){return{iconPrimary:oA(o.getPrimary(),e,i,l,c,d,p,v),iconSecondary:oA(o.getSecondary(),e,i,l,c,d,p,v)}}function aA(o,e,i,l){if(!o)return;const c=e.get(i.toString());if(o.imagePrimary=c,l){const d=e.get(l.toString());o.imageSecondary=d}}function lk(o,e){for(const i in o.horizontal)lA(o.horizontal[i],e);lA(o.vertical,e)}function lA(o,e){if(o){for(const i of o.positionedLines)for(const l of i.positionedGlyphs)if(l.image!==null){const c=l.image.toString();l.rect=e.get(c).paddedRect}}}function X1(o){switch(o){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function ck(o,e,i,l,c,d,p,v,w){const S=Y1(d.horizontal)||d.vertical,I=i.get("icon-text-fit-padding").evaluate(l,{},c);let C,R=e;return e&&w!=="none"&&(o.allowVerticalPlacement&&d.vertical&&(C=UE(e,d.vertical,w,I,v,p)),S&&(R=UE(e,S,w,I,v,p))),{defaultShapedIcon:R,verticallyShapedIcon:C}}function uk(o,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K,le,re){let G=p.textMaxSize.evaluate(e,{},R);G===void 0?G=v*p.textScaleFactor:G*=p.textScaleFactor;const ne=o.layers[0].layout,ae=Y1(i.horizontal)||i.vertical,de=B.name==="globe",be=Pr,Ie=o.tilePixelRatio*G/be,Me=(_t=o.overscaling,o.zoom>18&&_t>2&&(_t>>=1),Math.max(At/(512*_t),1)*ne.get("symbol-spacing")),ke=ne.get("text-padding")*o.tilePixelRatio,Ye=ne.get("icon-padding")*o.tilePixelRatio,ft=W(ne.get("text-max-angle")),at=ne.get("icon-rotation-alignment")==="map"&&re!=="point",ht=Me/2;var _t;o.hasAnyIconTextFit===!1&&X!=="none"&&(o.hasAnyIconTextFit=!0);const We=e.properties?+e.properties[Qu]:null,ct=We&&o.elevationFeatureIdToIndex?o.elevationFeatureIdToIndex.get(We):65535,Ge=(Xe,yt,vt)=>{if(yt.x<0||yt.x>=At||yt.y<0||yt.y>=At)return;let Wt=null;if(de){const{x:Nt,y:Mt,z:gt}=B.projectTilePoint(yt.x,yt.y,vt);Wt={anchor:new Pl(Nt,Mt,gt,0,void 0),up:B.upVector(vt,yt.x,yt.y)}}(function(Nt,Mt,gt,ln,$t,Gt,on,mn,gn,Cn,Sn,bn,hi,Ei,he,pe,Je,Tt,zt,Pt,qt,nn,kn,On,wn,ri,yi,Fn,ji){const Ai=Nt.addToLineVertexArray(Mt,ln);let ei,Ki,Mi,vi,Ii,oi,Mn,ci=0,$i=0,tn=0,jn=0,Ci=-1,Wi=-1;const Di={};let dr=mo("");const fi=gt?gt.anchor:Mt,sr=Fn!=="none";let vo=0,Br=0;if(gn._unevaluatedLayout.getValue("text-radial-offset")===void 0){const pr=gn.layout.get("text-offset").evaluate(qt,{},wn);vo=pr[0]*Pr,Br=pr[1]*Pr}else vo=gn.layout.get("text-radial-offset").evaluate(qt,{},wn)*Pr,Br=W1;if(Nt.allowVerticalPlacement&&$t.vertical){const pr=$t.vertical;if(he)oi=K1(pr),mn&&(Mn=K1(mn));else{const xr=gn.layout.get("text-rotate").evaluate(qt,{},wn)+90;Mi=w0(Cn,fi,Mt,Sn,bn,hi,pr,Ei,xr,pe),mn&&(vi=w0(Cn,fi,Mt,Sn,bn,hi,mn,Tt,xr))}}if(Gt){const pr=Nt.iconSizeData,xr=gn.layout.get("icon-rotate").evaluate(qt,{},wn),Nr=nA(Gt,xr,kn,sr,nn.iconScaleFactor),to=mn?nA(mn,xr,kn,sr,nn.iconScaleFactor):void 0;Ki=w0(Cn,fi,Mt,Sn,bn,hi,Gt,Tt,xr,null),ci=4*Nr.length;let qr=null;pr.kind==="source"?(qr=[ka*gn.layout.get("icon-size").evaluate(qt,{},wn)*nn.iconScaleFactor],qr[0]>Oc&&Dn(`${Nt.layerIds[0]}: Value for "icon-size" is >= ${xm}. Reduce your "icon-size".`)):pr.kind==="composite"&&(qr=[ka*nn.compositeIconSizes[0].evaluate(qt,{},wn)*nn.iconScaleFactor,ka*nn.compositeIconSizes[1].evaluate(qt,{},wn)*nn.iconScaleFactor],(qr[0]>Oc||qr[1]>Oc)&&Dn(`${Nt.layerIds[0]}: Value for "icon-size" is >= ${xm}. Reduce your "icon-size".`)),Nt.addSymbols(Nt.icon,Nr,qr,Pt,zt,qt,void 0,gt,Mt,Ai.lineStartIndex,Ai.lineLength,-1,On,wn,ri,yi),Ci=Nt.icon.placedSymbolArray.length-1,to&&($i=4*to.length,Nt.addSymbols(Nt.icon,to,qr,Pt,zt,qt,Po.vertical,gt,Mt,Ai.lineStartIndex,Ai.lineLength,-1,On,wn,ri,yi),Wi=Nt.icon.placedSymbolArray.length-1)}for(const pr in $t.horizontal){const xr=pr,Nr=$t.horizontal[xr];ei||(dr=mo(Nr.text),he?Ii=K1(Nr):ei=w0(Cn,fi,Mt,Sn,bn,hi,Nr,Ei,gn.layout.get("text-rotate").evaluate(qt,{},wn),pe));const to=Nr.positionedLines.length===1;if(tn+=cA(Nt,gt,Mt,Nr,on,gn,he,qt,pe,Ai,$t.vertical?Po.horizontal:Po.horizontalOnly,to?sk($t.horizontal):[xr],Di,Ci,nn,On,wn,ri),to)break}$t.vertical&&(jn+=cA(Nt,gt,Mt,$t.vertical,on,gn,he,qt,pe,Ai,Po.vertical,["vertical"],Di,Wi,nn,On,wn,ri));let kr=-1;const xo=(pr,xr)=>pr?Math.max(pr,xr):xr;kr=xo(Ii,kr),kr=xo(oi,kr),kr=xo(Mn,kr);const Oa=kr>-1?1:0;Nt.glyphOffsetArray.length>=65535&&Dn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),qt.sortKey!==void 0&&Nt.addToSortKeyRanges(Nt.symbolInstances.length,qt.sortKey),Nt.symbolInstances.emplaceBack(Mt.x,Mt.y,fi.x,fi.y,fi.z,Di.right>=0?Di.right:-1,Di.center>=0?Di.center:-1,Di.left>=0?Di.left:-1,Di.vertical>=0?Di.vertical:-1,Ci,Wi,dr,ei!==void 0?ei:Nt.collisionBoxArray.length,ei!==void 0?ei+1:Nt.collisionBoxArray.length,Mi!==void 0?Mi:Nt.collisionBoxArray.length,Mi!==void 0?Mi+1:Nt.collisionBoxArray.length,Ki!==void 0?Ki:Nt.collisionBoxArray.length,Ki!==void 0?Ki+1:Nt.collisionBoxArray.length,vi||Nt.collisionBoxArray.length,vi?vi+1:Nt.collisionBoxArray.length,Sn,tn,jn,ci,$i,Oa,0,vo,Br,kr,0,sr?1:0,ji)})(o,yt,Wt,Xe,i,l,d,c,o.layers[0],o.collisionBoxArray,e.index,e.sourceLayerIndex,o.index,ke,le,S,0,Ye,at,K,e,p,I,C,R,N,$,X,ct)};if(re==="line")for(const Xe of p0(e.geometry,0,0,At,At)){const yt=nk(Xe,Me,ft,i.vertical||ae,l,be,Ie,o.overscaling,At);for(const vt of yt)ae&&hk(o,ae.text,ht,vt)||Ge(Xe,vt,R)}else if(re==="line-center"){for(const Xe of e.geometry)if(Xe.length>1){const yt=tk(Xe,ft,i.vertical||ae,l,be,Ie);yt&&Ge(Xe,yt,R)}}else if(e.type==="Polygon")for(const Xe of a0(e.geometry,0)){const yt=rk(Xe,16);Ge(Xe[0],new Pl(yt.x,yt.y,0,0,void 0),R)}else if(e.type==="LineString")for(const Xe of e.geometry)Ge(Xe,new Pl(Xe[0].x,Xe[0].y,0,0,void 0),R);else if(e.type==="Point")for(const Xe of e.geometry)for(const yt of Xe)Ge([yt],new Pl(yt.x,yt.y,0,0,void 0),R)}const xm=255,Oc=xm*ka;function cA(o,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X,K){const le=function(ne,ae,de,be,Ie,Me,ke,Ye){const ft=[];if(ae.positionedLines.length===0)return ft;const at=be.layout.get("text-rotate").evaluate(Me,{})*Math.PI/180,ht=function(Xe){const yt=Xe[0],vt=Xe[1],Wt=yt*vt;return Wt>0?[yt,-vt]:Wt<0?[-yt,vt]:yt===0?[vt,yt]:[vt,-yt]}(de);let _t=Math.abs(ae.top-ae.bottom);for(const Xe of ae.positionedLines)_t-=Xe.lineOffset;const We=ae.positionedLines.length,ct=_t/We;let Ge=ae.top-de[1];for(let Xe=0;Xe<We;++Xe){const yt=ae.positionedLines[Xe];Ge=ik(ae,ct,Ge,Xe);for(const vt of yt.positionedGlyphs){if(!vt.rect)continue;const Wt=vt.rect||{};let Nt=K5+1,Mt=!0,gt=1,ln=0;if(vt.image){const qt=ke.get(vt.image.toString());if(!qt)continue;if(qt.sdf){Dn("SDF images are not supported in formatted text and will be ignored.");continue}Mt=!1,gt=qt.pixelRatio,Nt=ih/gt}const $t=(Ie||Ye)&&vt.vertical,Gt=vt.metrics.advance*vt.scale/2,on=vt.metrics,mn=vt.rect;if(mn===null)continue;Ye&&ae.verticalizable&&(ln=vt.image?Gt-vt.metrics.width*vt.scale/2:0);const gn=Ie?[vt.x+Gt,vt.y]:[0,0];let Cn=[0,0],Sn=[0,0],bn=!1;Ie||($t?(Sn=[vt.x+Gt+ht[0],vt.y+ht[1]-ln],bn=!0):Cn=[vt.x+Gt+de[0],vt.y+de[1]-ln]);const hi=mn.w*vt.scale/(gt*(vt.localGlyph?ta:1)),Ei=mn.h*vt.scale/(gt*(vt.localGlyph?ta:1));let he,pe,Je,Tt;if($t){const qt=vt.y-Ge,nn=new St(-Gt,Gt-qt),kn=-Math.PI/2,On=new St(...Sn);he=new St(-Gt+Cn[0],Cn[1]),he._rotateAround(kn,nn)._add(On),he.x+=-qt+Gt,he.y-=(on.left-Nt)*vt.scale;const wn=vt.image?on.advance*vt.scale:Pr*vt.scale,ri=String.fromCodePoint(vt.glyph);q5(ri)?he.x+=(1-Nt)*vt.scale:H5(ri)?he.x+=wn-on.height*vt.scale+(-Nt-1)*vt.scale:he.x+=vt.image||on.width+2*Nt===mn.w&&on.height+2*Nt===mn.h?(wn-Ei)/2:(wn-(on.height+2*Nt)*vt.scale)/2,pe=new St(he.x,he.y-hi),Je=new St(he.x+Ei,he.y),Tt=new St(he.x+Ei,he.y-hi)}else{const qt=(on.left-Nt)*vt.scale-Gt+Cn[0],nn=(-on.top-Nt)*vt.scale+Cn[1],kn=qt+hi,On=nn+Ei;he=new St(qt,nn),pe=new St(kn,nn),Je=new St(qt,On),Tt=new St(kn,On)}if(at){let qt;qt=Ie?new St(0,0):bn?new St(ht[0],ht[1]):new St(de[0],de[1]),he._rotateAround(at,qt),pe._rotateAround(at,qt),Je._rotateAround(at,qt),Tt._rotateAround(at,qt)}const zt=new St(0,0),Pt=new St(0,0);ft.push({tl:he,tr:pe,bl:Je,br:Tt,texPrimary:Wt,texSecondary:void 0,writingMode:ae.writingMode,glyphOffset:gn,sectionIndex:vt.sectionIndex,isSDF:Mt,pixelOffsetTL:zt,pixelOffsetBR:Pt,minFontScaleX:0,minFontScaleY:0})}}return ft}(0,l,w,d,p,v,c,o.allowVerticalPlacement),re=o.textSizeData;let G=null;re.kind==="source"?(G=[ka*d.layout.get("text-size").evaluate(v,{},X)*N.textScaleFactor],G[0]>Oc&&Dn(`${o.layerIds[0]}: Value for "text-size" is >= ${xm}. Reduce your "text-size".`)):re.kind==="composite"&&(G=[ka*N.compositeTextSizes[0].evaluate(v,{},X)*N.textScaleFactor,ka*N.compositeTextSizes[1].evaluate(v,{},X)*N.textScaleFactor],(G[0]>Oc||G[1]>Oc)&&Dn(`${o.layerIds[0]}: Value for "text-size" is >= ${xm}. Reduce your "text-size".`)),o.addSymbols(o.text,le,G,w,p,v,I,e,i,S.lineStartIndex,S.lineLength,B,$,X,K,!1);for(const ne of C)R[ne]=o.text.placedSymbolArray.length-1;return 4*le.length}function Y1(o){for(const e in o)return o[e];return null}function w0(o,e,i,l,c,d,p,v,w,S){let I=p.top,C=p.bottom,R=p.left,B=p.right;if(VE(p)&&p.collisionPadding){const N=p.collisionPadding;R-=N[0],I-=N[1],B+=N[2],C+=N[3]}if(w){const N=new St(R,I),$=new St(B,I),X=new St(R,C),K=new St(B,C),le=W(w);let re=new St(0,0);S&&(re=new St(S[0],S[1])),N._rotateAround(le,re),$._rotateAround(le,re),X._rotateAround(le,re),K._rotateAround(le,re),R=Math.min(N.x,$.x,X.x,K.x),B=Math.max(N.x,$.x,X.x,K.x),I=Math.min(N.y,$.y,X.y,K.y),C=Math.max(N.y,$.y,X.y,K.y)}return o.emplaceBack(e.x,e.y,e.z,i.x,i.y,R,I,B,C,v,l,c,d),o.length-1}function K1(o){VE(o)&&o.collisionPadding&&(o.top-=o.collisionPadding[1],o.bottom+=o.collisionPadding[3]);const e=o.bottom-o.top;return e>0?Math.max(10,e):null}function hk(o,e,i,l){const c=o.compareText;if(e in c){const d=c[e];for(let p=d.length-1;p>=0;p--)if(l.dist(d[p])<i)return!0}else c[e]=[];return c[e].push(l),!1}function uA(o,e){const i=o.fovAboveCenter,l=o.elevation?o.elevation.getMinElevationBelowMSL()*e:0,c=(o._camera.position[2]*o.worldSize-l)/Math.cos(o._pitch),d=Math.sin(i)*c/Math.sin(Math.max(Math.PI/2-o._pitch-i,.01));let p=Math.sin(o._pitch)*d+c;const v=c*(1/o._horizonShift);if(!o.elevation||o.elevation.exaggeration()===0){let w=Math.max(o.zoom-17,0);o.isOrthographic&&(w/=10),p*=1+w}return Math.min(1.01*p,v)}function bm(o,e){if(!e.isReprojectedInTileSpace)return{scale:1<<o.z,x:o.x,y:o.y,x2:o.x+1,y2:o.y+1,projection:e};const i=Math.pow(2,-o.z),l=o.x*i,c=(o.x+1)*i,d=o.y*i,p=(o.y+1)*i,v=we(l),w=we(c),S=Te(d),I=Te(p),C=e.project(v,S),R=e.project(w,S),B=e.project(w,I),N=e.project(v,I);let $=Math.min(C.x,R.x,B.x,N.x),X=Math.min(C.y,R.y,B.y,N.y),K=Math.max(C.x,R.x,B.x,N.x),le=Math.max(C.y,R.y,B.y,N.y);const re=i/16;function G(ae,de,be,Ie,Me,ke){const Ye=(be+Me)/2,ft=(Ie+ke)/2,at=e.project(we(Ye),Te(ft)),ht=Math.max(0,$-at.x,X-at.y,at.x-K,at.y-le);$=Math.min($,at.x),K=Math.max(K,at.x),X=Math.min(X,at.y),le=Math.max(le,at.y),ht>re&&(G(ae,at,be,Ie,Ye,ft),G(at,de,Ye,ft,Me,ke))}G(C,R,l,d,c,d),G(R,B,c,d,c,p),G(B,N,c,p,l,p),G(N,C,l,p,l,d),$-=re,X-=re,K+=re,le+=re;const ne=1/Math.max(K-$,le-X);return{scale:ne,x:$*ne,y:X*ne,x2:K*ne,y2:le*ne,projection:e}}function hA(o,{x:e,y:i},l=0){return new St(((e-l)*o.scale-o.x)*At,(i*o.scale-o.y)*At)}const fk=J(new Float32Array(16));class Fc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new Z(0,0)}projectTilePoint(e,i,l){return{x:e,y:i,z:0}}locationPoint(e,i,l,c=!0){return e._coordinatePoint(e.locationCoordinate(i,l),c)}pixelsPerMeter(e,i){return _e(1,e)*i}pixelSpaceConversion(e,i,l){return 1}farthestPixelDistance(e){return uA(e,e.pixelsPerMeter)}pointCoordinate(e,i,l,c){const d=e.horizonLineFromTop(!1),p=new St(i,Math.max(d,l));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,c))}pointCoordinate3D(e,i,l){const c=new St(i,l);if(e.elevation)return e.elevation.pointCoordinate(c);{const d=this.pointCoordinate(e,c.x,c.y,0);return[d.x,d.y,d.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const l=e.horizonLineFromTop();return i.y<l}createInversionMatrix(e,i){return fk}createTileMatrix(e,i,l){let c,d,p;const v=l.canonical,w=J(new Float64Array(16));if(this.isReprojectedInTileSpace){const S=bm(v,this);c=1,d=S.x+l.wrap*S.scale,p=S.y,ce(w,w,[c/S.scale,c/S.scale,e.pixelsPerMeter/i])}else c=i/e.zoomScale(v.z),d=(v.x+Math.pow(2,v.z)*l.wrap)*c,p=v.y*c;return ue(w,w,[d,p,0]),ce(w,w,[c/At,c/At,1]),w}upVector(e,i,l){return[0,0,1]}upVectorScale(e,i,l){return{metersToTile:1}}}class dk extends Fc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,l]=this.parallels=e.parallels||[29.5,45.5],c=Math.sin(W(i));this.n=(c+Math.sin(W(l)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:l,c,r0:d}=this,p=W(e-this.center[0]),v=W(i),w=Math.sqrt(c-2*l*Math.sin(v))/l;return{x:w*Math.sin(p*l),y:w*Math.cos(p*l)-d,z:0}}unproject(e,i){const{n:l,c,r0:d}=this,p=d+i;let v=Math.atan2(e,Math.abs(p))*Math.sign(p);p*l<0&&(v-=Math.PI*Math.sign(e)*Math.sign(p));const w=W(this.center[0])*l;v=He(v,-Math.PI-w,Math.PI-w);const S=ze(ie(v/l)+this.center[0],-180,180),I=Math.asin(ze((c-(e*e+p*p)*l*l)/(2*l),-1,1)),C=ze(ie(I),-85.051129,Fe);return new Z(S,C)}}const wm=1.340264,Tm=-.081106,Sm=893e-6,Em=.003796,T0=Math.sqrt(3)/2;class pk extends Fc{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const l=Math.asin(T0*Math.sin(i)),c=l*l,d=c*c*c;return{x:.5*(e*Math.cos(l)/(T0*(wm+3*Tm*c+d*(7*Sm+9*Em*c)))/Math.PI+.5),y:1-.5*(l*(wm+Tm*c+d*(Sm+Em*c))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let l=i=(2*(1-i)-1)*Math.PI,c=l*l,d=c*c*c;for(let I,C,R,B=0;B<12&&(C=l*(wm+Tm*c+d*(Sm+Em*c))-i,R=wm+3*Tm*c+d*(7*Sm+9*Em*c),I=C/R,l=ze(l-I,-Math.PI/3,Math.PI/3),c=l*l,d=c*c*c,!(Math.abs(I)<1e-12));++B);const p=T0*e*(wm+3*Tm*c+d*(7*Sm+9*Em*c))/Math.cos(l),v=Math.asin(Math.sin(l)/T0),w=ze(180*p/Math.PI,-180,180),S=ze(180*v/Math.PI,-85.051129,Fe);return new Z(w,S)}}class mk extends Fc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const l=360*(e-.5),c=ze(360*(.5-i),-85.051129,Fe);return new Z(l,c)}}const Wf=Math.PI/2;function S0(o){return Math.tan((Wf+o)/2)}class _k extends Fc{constructor(e){super(e),this.center=e.center||[0,30];const[i,l]=this.parallels=e.parallels||[30,30];let c=W(i),d=W(l);this.southernCenter=c+d<0,this.southernCenter&&(c=-c,d=-d);const p=Math.cos(c),v=S0(c);this.n=c===d?Math.sin(c):Math.log(p/Math.cos(d))/Math.log(S0(d)/v),this.f=p*Math.pow(S0(c),this.n)/this.n}project(e,i){i=W(i),this.southernCenter&&(i=-i),e=W(e-this.center[0]);const l=1e-6,{n:c,f:d}=this;d>0?i<-Wf+l&&(i=-Wf+l):i>Wf-l&&(i=Wf-l);const p=d/Math.pow(S0(i),c);let v=p*Math.sin(c*e),w=d-p*Math.cos(c*e);return v=.5*(v/Math.PI+.5),w=.5*(w/Math.PI+.5),{x:v,y:this.southernCenter?w:1-w,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:l,f:c}=this,d=c-i,p=Math.sign(d),v=Math.sign(l)*Math.sqrt(e*e+d*d);let w=Math.atan2(e,Math.abs(d))*p;d*l<0&&(w-=Math.PI*Math.sign(e)*p);const S=ze(ie(w/l)+this.center[0],-180,180),I=ze(ie(2*Math.atan(Math.pow(c/v,1/l))-Wf),-85.051129,Fe);return new Z(S,this.southernCenter?-I:I)}}class fA extends Fc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:ye(e),y:ve(i),z:0}}unproject(e,i){const l=we(e),c=Te(i);return new Z(l,c)}}const dA=W(Fe);class gk extends Fc{project(e,i){const l=(i=W(i))*i,c=l*l;return{x:.5*((e=W(e))*(.8707-.131979*l+c*(c*(.003971*l-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+l*(.015085+c*(.028874*l-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let l=i=(2*(1-i)-1)*Math.PI,c=25,d=0,p=l*l;do{p=l*l;const S=p*p;d=(l*(1.007226+p*(.015085+S*(.028874*p-.044475-.005916*S)))-i)/(1.007226+p*(.045255+S*(.259866*p-.311325-.005916*11*S))),l=ze(l-d,-dA,dA)}while(Math.abs(d)>1e-6&&--c>0);p=l*l;const v=ze(ie(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),w=ie(l);return new Z(v,w)}}const pA=W(Fe);class yk extends Fc{project(e,i){i=W(i),e=W(e);const l=Math.cos(i),c=2/Math.PI,d=Math.acos(l*Math.cos(e/2)),p=Math.sin(d)/d,v=.5*(e*c+2*l*Math.sin(e/2)/p)||0,w=.5*(i+Math.sin(i)/p)||0;return{x:.5*(v/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(e,i){let l=e=(2*e-.5)*Math.PI,c=i=(2*(1-i)-1)*Math.PI,d=25;const p=1e-6;let v=0,w=0;do{const S=Math.cos(c),I=Math.sin(c),C=2*I*S,R=I*I,B=S*S,N=Math.cos(l/2),$=Math.sin(l/2),X=2*N*$,K=$*$,le=1-B*N*N,re=le?1/le:0,G=le?Math.acos(S*N)*Math.sqrt(1/le):0,ne=.5*(2*G*S*$+2*l/Math.PI)-e,ae=.5*(G*I+c)-i,de=.5*re*(B*K+G*S*N*R)+1/Math.PI,be=re*(X*C/4-G*I*$),Ie=.125*re*(C*$-G*I*B*X),Me=.5*re*(R*N+G*K*S)+.5,ke=be*Ie-Me*de;v=(ae*be-ne*Me)/ke,w=(ne*Ie-ae*de)/ke,l=ze(l-v,-Math.PI,Math.PI),c=ze(c-w,-pA,pA)}while((Math.abs(v)>p||Math.abs(w)>p)&&--d>0);return new Z(ie(l),ie(c))}}class mA extends Fc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(W(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:l,cosPhi:c}=this;return{x:W(e)*c*l+.5,y:-Math.sin(W(i))/c*l+.5,z:0}}unproject(e,i){const{scale:l,cosPhi:c}=this,d=-(i-.5)/l,p=ze(ie((e-.5)/l)/c,-180,180),v=Math.asin(ze(d*c,-1,1)),w=ze(ie(v),-85.051129,Fe);return new Z(p,w)}}class vk extends fA{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,l){const c=rm(e,i,l);return Ct(c,c,r0(Da(l))),{x:c[0],y:c[1],z:c[2]}}locationPoint(e,i,l){const c=H(i.lat,i.lng),d=hn([],c),p=l?e._centerAltitude+l:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;rn(c,c,d,_e(1,0)*At*p);const v=J(new Float64Array(16));return ee(v,e.pixelMatrix,e.globeMatrix),Ct(c,c,v),new St(c[0],c[1])}pixelsPerMeter(e,i){return _e(1,0)*i}pixelSpaceConversion(e,i,l){const c=_e(1,e)*i,d=Jt(_e(1,45)*i,c,l);return this.pixelsPerMeter(e,i)/d}createTileMatrix(e,i,l){const c=m1(Da(l.canonical));return ee(new Float64Array(16),e.globeMatrix,c)}createInversionMatrix(e,i){const{center:l}=e,c=r0(Da(i));return Ae(c,c,W(l.lng)),se(c,c,W(l.lat)),ce(c,c,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(e,i,l,c){return QT(e,i,l,!0)||new je(0,0)}pointCoordinate3D(e,i,l){const c=this.pointCoordinate(e,i,l,0);return[c.x,c.y,c.z]}isPointAboveHorizon(e,i){return!QT(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(c,d){const p=c.cameraToCenterDistance,v=c._centerAltitude*d,w=c._camera,S=c._camera.forward(),I=Ve([],Lt([],S,-p),[0,0,v]),C=c.worldSize/(2*Math.PI),R=[0,0,-C],B=c.width/c.height,N=Math.tan(c.fovAboveCenter),$=Lt([],w.up(),N),X=Lt([],w.right(),N*B),K=hn([],Ve([],Ve([],S,$),X)),le=[];let re;if(new ps(I,K).closestPointOnSphere(R,C,le)){const G=Ve([],le,R),ne=dn([],G,I);re=Math.cos(c.fovAboveCenter)*ut(ne)}else{const G=dn([],I,R),ne=dn([],R,I);hn(ne,ne);const ae=ut(G)-C;re=Math.sqrt(ae*(ae+2*C));const de=Math.acos(re/(C+ae))-Math.acos(Nn(S,ne));re*=Math.cos(de)}return 1.01*re}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),l=Rc(e.zoom);if(l>0){const c=uA(e,_e(1,e.center.lat)*e.worldSize),d=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Jt(i,c+d*(1-Math.cos(p)),Math.pow(l,10))}return i}upVector(e,i,l){return rm(i,l,e,1)}upVectorScale(e){return{metersToTile:zc(i0(Da(e)))}}}function _A(o){const e=o.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(o.name){case"mercator":return new fA(o);case"equirectangular":return new mk(o);case"naturalEarth":return new gk(o);case"equalEarth":return new pk(o);case"winkelTripel":return new yk(o);case"albers":return i?new mA(o):new dk(o);case"lambertConformalConic":return i?new mA(o):new _k(o);case"globe":return new vk(o)}throw new Error(`Invalid projection name: ${o.name}`)}const xk=Lc.VectorTileFeature.types,bk=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function E0(o,e,i,l,c,d,p,v,w,S,I,C,R){const B=v?Math.min(Oc,Math.round(v[0])):0,N=v?Math.min(Oc,Math.round(v[1])):0;o.emplaceBack(e,i,Math.round(32*l),Math.round(32*c),d,p,(B<<1)+(w?1:0),N,16*S,16*I,256*C,256*R)}function A0(o,e,i){o.emplaceBack(e,i)}function I0(o,e,i,l,c,d,p){o.emplaceBack(e,i,l,c,d,p)}function M0(o,e,i,l,c){o.emplaceBack(e,i,l,c),o.emplaceBack(e,i,l,c),o.emplaceBack(e,i,l,c),o.emplaceBack(e,i,l,c)}function wk(o){for(const e of o.sections)if(i1(e.text))return!0;return!1}class J1{constructor(e){this.layoutVertexArray=new Ec,this.indexArray=new wr,this.programConfigurations=e,this.segments=new Ui,this.dynamicLayoutVertexArray=new Is,this.opacityVertexArray=new Zp,this.placedSymbolArray=new $g,this.iconTransitioningVertexArray=new Pa,this.globeExtVertexArray=new ho,this.zOffsetVertexArray=new Tc}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,l,c,d){this.isEmpty()||(l&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,O5.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,B5.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,bk,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,V5.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,F5.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||d)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,N5.members,!0)),this.opacityVertexBuffer.itemSize=1),(l||c)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Ft(J1,"SymbolBuffers");class Q1{constructor(e,i,l){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new l,this.segments=new Ui,this.collisionVertexArray=new Xp,this.collisionVertexArrayExt=new Is}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,U5.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,j5.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ft(Q1,"CollisionBuffers");class C0{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=J([]),this.placementViewportMatrix=J([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=qE(this.zoom,i["text-size"]),this.iconSizeData=qE(this.zoom,i["icon-size"]);const l=this.layers[0].layout,c=l.get("symbol-sort-key"),d=l.get("symbol-z-order");this.canOverlap=l.get("text-allow-overlap")||l.get("icon-allow-overlap")||l.get("text-ignore-placement")||l.get("icon-ignore-placement"),this.sortFeaturesByKey=d!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(d==="viewport-y"||d==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=l.get("text-writing-mode").map(p=>Po[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new J1(new Il(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new J1(new Il(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new tm,this.lineVertexArray=new Hg,this.symbolInstances=new qg}calculateGlyphDependencies(e,i,l,c,d){for(const p of e){const v=p.codePointAt(0);if(v===void 0)break;if(i[v]=!0,c&&d&&v<=65535){const w=_m[p];w&&(i[w.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!D1(this.activeReplacements,l)&&(this.activeReplacements=l,!0)}populate(e,i,l,c){const d=this.layers[0],p=d.layout,v=this.projection.name==="globe",w=p.get("text-font"),S=p.get("text-field"),I=p.get("icon-image"),[C,R]=p.get("icon-size-scale-range"),B=ze(i.scaleFactor||1,C,R),N=(S.value.kind!=="constant"||S.value.value instanceof Yr&&!S.value.value.isEmpty()||S.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),$=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,X=p.get("symbol-sort-key");if(this.features=[],!N&&!$)return;const K=i.iconDependencies,le=i.glyphDependencies,re=i.availableImages,G=new si(this.zoom);for(const{feature:ne,id:ae,index:de,sourceLayerIndex:be}of e){const Ie=d._featureFilter.needGeometry,Me=Xt(ne,Ie);if(!d._featureFilter.filter(G,Me,l))continue;if(Ie||(Me.geometry=Vt(ne,l,c)),v&&ne.type!==1&&l.z<=5){const ht=Me.geometry,_t=.98078528056,We=(ct,Ge)=>Nn(rm(ct.x,ct.y,l,1),rm(Ge.x,Ge.y,l,1))<_t;for(let ct=0;ct<ht.length;ct++)ht[ct]=dt(ht[ct],We)}let ke,Ye;if(N){const ht=d.getValueAndResolveTokens("text-field",Me,l,re),_t=Yr.factory(ht);wk(_t)&&(this.hasRTLText=!0),(!this.hasRTLText||xc()==="unavailable"||this.hasRTLText&&Yo.isParsed())&&(ke=G5(_t,d,Me))}if($){const ht=d.getValueAndResolveTokens("icon-image",Me,l,re);Ye=typeof ht=="string"?co.build(ht):ht}if(!ke&&!Ye)continue;const ft=this.sortFeaturesByKey?X.evaluate(Me,{},l):void 0,at={id:ae,text:ke,icon:Ye,index:de,sourceLayerIndex:be,geometry:Me.geometry,properties:ne.properties,type:xk[ne.type],sortKey:ft};if(this.features.push(at),Ye){const ht=this.layers[0]._unevaluatedLayout._values,{iconPrimary:_t,iconSecondary:We}=sA(Ye,this.iconSizeData,ht["icon-size"],l,this.zoom,at,this.pixelRatio,B),ct=_t.id.toString();if(K.has(ct)?K.get(ct).push(_t):K.set(ct,[_t]),We){const Ge=We.id.toString();K.has(Ge)?K.get(Ge).push(We):K.set(Ge,[We])}}if(ke){const ht=w.evaluate(Me,{},l).join(","),_t=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Po.vertical)>=0;for(const We of ke.sections)if(We.image){const ct=We.image.getPrimary().scaleSelf(this.pixelRatio),Ge=ct.id.toString(),Xe=K.get(Ge)||[];Xe.push(ct),K.set(Ge,Xe)}else{const ct=kp(ke.toString()),Ge=We.fontStack||ht,Xe=le[Ge]=le[Ge]||{};this.calculateGlyphDependencies(We.text,Xe,_t,this.allowVerticalPlacement,ct)}}}if(p.get("symbol-placement")==="line"&&(this.features=function(ne){const ae={},de={},be=[];let Ie=0;function Me(at){be.push(ne[at]),Ie++}function ke(at,ht,_t){const We=de[at];return delete de[at],de[ht]=We,be[We].geometry[0].pop(),be[We].geometry[0]=be[We].geometry[0].concat(_t[0]),We}function Ye(at,ht,_t){const We=ae[ht];return delete ae[ht],ae[at]=We,be[We].geometry[0].shift(),be[We].geometry[0]=_t[0].concat(be[We].geometry[0]),We}function ft(at,ht,_t){const We=_t?ht[0][ht[0].length-1]:ht[0][0];return`${at}:${We.x}:${We.y}`}for(let at=0;at<ne.length;at++){const ht=ne[at],_t=ht.geometry,We=ht.text?ht.text.toString():null;if(!We){Me(at);continue}const ct=ft(We,_t),Ge=ft(We,_t,!0);if(ct in de&&Ge in ae&&de[ct]!==ae[Ge]){const Xe=Ye(ct,Ge,_t),yt=ke(ct,Ge,be[Xe].geometry);delete ae[ct],delete de[Ge],de[ft(We,be[yt].geometry,!0)]=yt,be[Xe].geometry=null}else ct in de?ke(ct,Ge,_t):Ge in ae?Ye(ct,Ge,_t):(Me(at),ae[ct]=Ie-1,de[Ge]=Ie-1)}return be.filter(at=>at.geometry)}(this.features)),p.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const ne of i.elevationFeatures)this.elevationFeatureIdToIndex.set(ne.id,this.elevationFeatures.length),this.elevationFeatures.push(ne)}}else p.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((ne,ae)=>ne.sortKey-ae.sortKey)}update(e,i,l,c,d,p,v){this.text.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v),this.icon.programConfigurations.updatePaintArrays(e,i,d,l,c,p,v)}updateRoadElevation(){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let e=!1;for(let i=0;i<this.symbolInstances.length;i++){const l=this.symbolInstances.get(i);if(l.elevationFeatureIndex===65535)continue;const c=this.elevationFeatures[l.elevationFeatureIndex];if(c){const d=.05+c.pointElevation(new St(l.tileAnchorX,l.tileAnchorY));l.zOffset!==d&&(e=!0,l.zOffset=d)}}e&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(d,p,v)=>{l+=p,l>d.length&&d.resize(l);for(let w=-p;w<0;w++)d.emplace(w+l,v)},i=(d,p,v)=>{c+=p,c>d.length&&d.resize(c);for(let w=-p;w<0;w++)d.emplace(w+c,v)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let l=0,c=0;for(let d=0;d<this.symbolInstances.length;d++){const p=this.symbolInstances.get(d),{numHorizontalGlyphVertices:v,numVerticalGlyphVertices:w,numIconVertices:S}=p,I=p.zOffset,C=S>0;if((v>0||w>0)&&(e(this.text.zOffsetVertexArray,v,I),e(this.text.zOffsetVertexArray,w,I)),C){const{placedIconSymbolIndex:R,verticalPlacedIconSymbolIndex:B}=p;R>=0&&i(this.icon.zOffsetVertexArray,S,I),B>=0&&i(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=_A(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const l=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:c,y:d}of i)this.lineVertexArray.emplaceBack(c,d);return{lineStartIndex:l,lineLength:this.lineVertexArray.length-l}}addSymbols(e,i,l,c,d,p,v,w,S,I,C,R,B,N,$,X){const K=e.indexArray,le=e.layoutVertexArray,re=e.globeExtVertexArray,G=e.segments.prepareSegment(4*i.length,le,K,this.canOverlap?p.sortKey:void 0),ne=this.glyphOffsetArray.length,ae=G.vertexLength,de=this.allowVerticalPlacement&&v===Po.vertical?Math.PI/2:0,be=p.text&&p.text.sections;for(let Me=0;Me<i.length;Me++){const{tl:ke,tr:Ye,bl:ft,br:at,texPrimary:ht,texSecondary:_t,pixelOffsetTL:We,pixelOffsetBR:ct,minFontScaleX:Ge,minFontScaleY:Xe,glyphOffset:yt,isSDF:vt,sectionIndex:Wt}=i[Me],Nt=G.vertexLength,Mt=yt[1];if(E0(le,S.x,S.y,ke.x,Mt+ke.y,ht.x,ht.y,l,vt,We.x,We.y,Ge,Xe),E0(le,S.x,S.y,Ye.x,Mt+Ye.y,ht.x+ht.w,ht.y,l,vt,ct.x,We.y,Ge,Xe),E0(le,S.x,S.y,ft.x,Mt+ft.y,ht.x,ht.y+ht.h,l,vt,We.x,ct.y,Ge,Xe),E0(le,S.x,S.y,at.x,Mt+at.y,ht.x+ht.w,ht.y+ht.h,l,vt,ct.x,ct.y,Ge,Xe),w){const{x:gt,y:ln,z:$t}=w.anchor,[Gt,on,mn]=w.up;I0(re,gt,ln,$t,Gt,on,mn),I0(re,gt,ln,$t,Gt,on,mn),I0(re,gt,ln,$t,Gt,on,mn),I0(re,gt,ln,$t,Gt,on,mn),M0(e.dynamicLayoutVertexArray,gt,ln,$t,de)}else M0(e.dynamicLayoutVertexArray,S.x,S.y,S.z,de);if(X){const gt=_t||ht;A0(e.iconTransitioningVertexArray,gt.x,gt.y),A0(e.iconTransitioningVertexArray,gt.x+gt.w,gt.y),A0(e.iconTransitioningVertexArray,gt.x,gt.y+gt.h),A0(e.iconTransitioningVertexArray,gt.x+gt.w,gt.y+gt.h)}K.emplaceBack(Nt,Nt+1,Nt+2),K.emplaceBack(Nt+1,Nt+2,Nt+3),G.vertexLength+=4,G.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(yt[0]),Me!==i.length-1&&Wt===i[Me+1].sectionIndex||e.programConfigurations.populatePaintArrays(le.length,p,p.index,{},B,N,$,be&&be[Wt])}const Ie=w?w.anchor:S;e.placedSymbolArray.emplaceBack(Ie.x,Ie.y,Ie.z,S.x,S.y,ne,this.glyphOffsetArray.length-ne,ae,I,C,S.segment,l?l[0]:0,l?l[1]:0,c[0],c[1],v,0,0,0,R,0)}_commitLayoutVertex(e,i,l,c,d,p,v){e.emplaceBack(i,l,c,d,p,Math.round(v.x),Math.round(v.y))}_addCollisionDebugVertices(e,i,l,c,d,p,v){const w=l.segments.prepareSegment(4,l.layoutVertexArray,l.indexArray),S=w.vertexLength,I=v.tileAnchorX,C=v.tileAnchorY;for(let B=0;B<4;B++)l.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(l.collisionVertexArrayExt,i,e.padding,v.zOffset),this._commitLayoutVertex(l.layoutVertexArray,c,d,p,I,C,new St(e.x1,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,c,d,p,I,C,new St(e.x2,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,c,d,p,I,C,new St(e.x2,e.y2)),this._commitLayoutVertex(l.layoutVertexArray,c,d,p,I,C,new St(e.x1,e.y2)),w.vertexLength+=4;const R=l.indexArray;R.emplaceBack(S,S+1),R.emplaceBack(S+1,S+2),R.emplaceBack(S+2,S+3),R.emplaceBack(S+3,S),w.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,l,c,d,p){for(let v=c;v<d;v++){const w=l.get(v),S=this.getSymbolInstanceTextSize(e,p,i,v);this._addCollisionDebugVertices(w,S,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,i,l,c,d,p){for(let v=c;v<d;v++){const w=l.get(v),S=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._addCollisionDebugVertices(w,S,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,i,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Q1(Lf,zE.members,Pa),this.iconCollisionBox=new Q1(Lf,zE.members,Pa);const c=ym(this.iconSizeData,e),d=ym(this.textSizeData,e,l);for(let p=0;p<this.symbolInstances.length;p++){const v=this.symbolInstances.get(p);this._addTextDebugCollisionBoxes(d,e,i,v.textBoxStartIndex,v.textBoxEndIndex,v),this._addTextDebugCollisionBoxes(d,e,i,v.verticalTextBoxStartIndex,v.verticalTextBoxEndIndex,v),this._addIconDebugCollisionBoxes(c,e,i,v.iconBoxStartIndex,v.iconBoxEndIndex,v),this._addIconDebugCollisionBoxes(c,e,i,v.verticalIconBoxStartIndex,v.verticalIconBoxEndIndex,v)}}getSymbolInstanceTextSize(e,i,l,c){const d=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:c),p=q1(this.textSizeData,e,d)/Pr;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,i,l){const c=this.icon.placedSymbolArray.get(l),d=q1(this.iconSizeData,e,c);return this.tilePixelRatio*d}_commitDebugCollisionVertexUpdate(e,i,l,c){e.emplaceBack(i,-l,-l,c),e.emplaceBack(i,l,-l,c),e.emplaceBack(i,l,l,c),e.emplaceBack(i,-l,l,c)}_updateTextDebugCollisionBoxes(e,i,l,c,d,p,v){for(let w=c;w<d;w++){const S=l.get(w),I=this.getSymbolInstanceTextSize(e,p,i,w);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,S.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,i,l,c,d,p,v){for(let w=c;w<d;w++){const S=l.get(w),I=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,S.padding,p.zOffset)}}updateCollisionDebugBuffers(e,i,l,c){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const d=ym(this.iconSizeData,e,c),p=ym(this.textSizeData,e,l);for(let v=0;v<this.symbolInstances.length;v++){const w=this.symbolInstances.get(v);this._updateTextDebugCollisionBoxes(p,e,i,w.textBoxStartIndex,w.textBoxEndIndex,w,l),this._updateTextDebugCollisionBoxes(p,e,i,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w,l),this._updateIconDebugCollisionBoxes(d,e,i,w.iconBoxStartIndex,w.iconBoxEndIndex,w,c),this._updateIconDebugCollisionBoxes(d,e,i,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w,c)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,l,c,d,p,v,w,S){const I={};if(i<l){const{x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G,featureIndex:ne}=e.get(i);I.textBox={x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G},I.textFeatureIndex=ne}if(c<d){const{x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G,featureIndex:ne}=e.get(c);I.verticalTextBox={x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G},I.verticalTextFeatureIndex=ne}if(p<v){const{x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G,featureIndex:ne}=e.get(p);I.iconBox={x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G},I.iconFeatureIndex=ne}if(w<S){const{x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G,featureIndex:ne}=e.get(w);I.verticalIconBox={x1:C,y1:R,x2:B,y2:N,padding:$,projectedAnchorX:X,projectedAnchorY:K,projectedAnchorZ:le,tileAnchorX:re,tileAnchorY:G},I.verticalIconFeatureIndex=ne}return I}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const l=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,l.textBoxStartIndex,l.textBoxEndIndex,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l.iconBoxStartIndex,l.iconBoxEndIndex,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const l=e.placedSymbolArray.get(i),c=l.vertexStartIndex+4*l.numGlyphs;for(let d=l.vertexStartIndex;d<c;d+=4)e.indexArray.emplaceBack(d,d+1,d+2),e.indexArray.emplaceBack(d+1,d+2,d+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),l=Math.cos(e),c=[],d=[],p=[];for(let v=0;v<this.symbolInstances.length;++v){p.push(v);const w=this.symbolInstances.get(v);c.push(0|Math.round(i*w.tileAnchorX+l*w.tileAnchorY)),d.push(w.featureIndex)}return p.sort((v,w)=>c[v]-c[w]||d[w]-d[v]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const l=this.sortKeyRanges[this.sortKeyRanges.length-1];l&&l.sortKey===i?l.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const l=this.symbolInstances.get(i);this.featureSortOrder.push(l.featureIndex);const{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:d,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:v,placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:S}=l;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),d>=0&&d!==c&&this.addIndicesForPlacedSymbol(this.text,d),p>=0&&p!==d&&p!==c&&this.addIndicesForPlacedSymbol(this.text,p),v>=0&&this.addIndicesForPlacedSymbol(this.text,v),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w),S>=0&&this.addIndicesForPlacedSymbol(this.icon,S)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let gA,yA,eb;Ft(C0,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),C0.addDynamicAttributes=M0;class vA{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:ga,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ft(vA,"FormatSectionOverride",{omit:["defaultValue"]});const tb=()=>eb||(eb={layout:gA||(gA=new Xi({"symbol-placement":new wt(Ne.layout_symbol["symbol-placement"]),"symbol-spacing":new wt(Ne.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new wt(Ne.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ot(Ne.layout_symbol["symbol-sort-key"]),"symbol-z-order":new wt(Ne.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new wt(Ne.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new wt(Ne.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new wt(Ne.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new wt(Ne.layout_symbol["icon-ignore-placement"]),"icon-optional":new wt(Ne.layout_symbol["icon-optional"]),"icon-rotation-alignment":new wt(Ne.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ot(Ne.layout_symbol["icon-size"]),"icon-size-scale-range":new wt(Ne.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Ot(Ne.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ot(Ne.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ot(Ne.layout_symbol["icon-image"]),"icon-rotate":new Ot(Ne.layout_symbol["icon-rotate"]),"icon-padding":new wt(Ne.layout_symbol["icon-padding"]),"icon-keep-upright":new wt(Ne.layout_symbol["icon-keep-upright"]),"icon-offset":new Ot(Ne.layout_symbol["icon-offset"]),"icon-anchor":new Ot(Ne.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new wt(Ne.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new wt(Ne.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new wt(Ne.layout_symbol["text-rotation-alignment"]),"text-field":new Ot(Ne.layout_symbol["text-field"]),"text-font":new Ot(Ne.layout_symbol["text-font"]),"text-size":new Ot(Ne.layout_symbol["text-size"]),"text-size-scale-range":new wt(Ne.layout_symbol["text-size-scale-range"]),"text-max-width":new Ot(Ne.layout_symbol["text-max-width"]),"text-line-height":new Ot(Ne.layout_symbol["text-line-height"]),"text-letter-spacing":new Ot(Ne.layout_symbol["text-letter-spacing"]),"text-justify":new Ot(Ne.layout_symbol["text-justify"]),"text-radial-offset":new Ot(Ne.layout_symbol["text-radial-offset"]),"text-variable-anchor":new wt(Ne.layout_symbol["text-variable-anchor"]),"text-anchor":new Ot(Ne.layout_symbol["text-anchor"]),"text-max-angle":new wt(Ne.layout_symbol["text-max-angle"]),"text-writing-mode":new wt(Ne.layout_symbol["text-writing-mode"]),"text-rotate":new Ot(Ne.layout_symbol["text-rotate"]),"text-padding":new wt(Ne.layout_symbol["text-padding"]),"text-keep-upright":new wt(Ne.layout_symbol["text-keep-upright"]),"text-transform":new Ot(Ne.layout_symbol["text-transform"]),"text-offset":new Ot(Ne.layout_symbol["text-offset"]),"text-allow-overlap":new wt(Ne.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new wt(Ne.layout_symbol["text-ignore-placement"]),"text-optional":new wt(Ne.layout_symbol["text-optional"]),visibility:new wt(Ne.layout_symbol.visibility)})),paint:yA||(yA=new Xi({"icon-opacity":new Ot(Ne.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Ot(Ne.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Ot(Ne.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ot(Ne.paint_symbol["text-emissive-strength"]),"icon-color":new Ot(Ne.paint_symbol["icon-color"]),"icon-halo-color":new Ot(Ne.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ot(Ne.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ot(Ne.paint_symbol["icon-halo-blur"]),"icon-translate":new wt(Ne.paint_symbol["icon-translate"]),"icon-translate-anchor":new wt(Ne.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new wt(Ne.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ot(Ne.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Ot(Ne.paint_symbol["text-occlusion-opacity"]),"text-color":new Ot(Ne.paint_symbol["text-color"],{runtimeType:lo,getOverride:o=>o.textColor,hasOverride:o=>!!o.textColor}),"text-halo-color":new Ot(Ne.paint_symbol["text-halo-color"]),"text-halo-width":new Ot(Ne.paint_symbol["text-halo-width"]),"text-halo-blur":new Ot(Ne.paint_symbol["text-halo-blur"]),"text-translate":new wt(Ne.paint_symbol["text-translate"]),"text-translate-anchor":new wt(Ne.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new wt(Ne.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new wt(Ne.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new wt(Ne.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new wt(Ne.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Ot(Ne.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},eb);class P0 extends eo{constructor(e,i,l,c){super(e,tb(),i,l,c),this._colorAdjustmentMatrix=J([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const l=this.layout.get("text-writing-mode");if(l){const c=[];for(const d of l)c.indexOf(d)<0&&c.push(d);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,l,c){return this._saturation===e&&this._contrast===i&&this._brightnessMin===l&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(d,p,v,w){d=$r(d),p=jr(p);const S=te(),I=d/3,C=1-2*I,R=[C,I,I,0,I,C,I,0,I,I,C,0,0,0,0,1],B=.5-.5*p,N=w-v;return ee(S,[N,0,0,0,0,N,0,0,0,0,N,0,v,v,v,1],[p,0,0,0,0,p,0,0,0,0,p,0,B,B,B,1]),ee(S,S,R),S}(e,i,l,c),this._saturation=e,this._contrast=i,this._brightnessMin=l,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,l,c){const d=this.layout.get(e).evaluate(i,{},l,c),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||wf(p.value)||!d?d:function(v,w){return w.replace(/{([^{}]+)}/g,(S,I)=>I in v?String(v[I]):"")}(i.properties,d)}createBucket(e){return new C0(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of tb().paint.overridableProperties){if(!P0.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),l=new vA(i),c=new Rp(l,i.property.specification,this.scope,this.options);let d=null;d=i.value.kind==="constant"||i.value.kind==="source"?new yl("source",c):new yc("composite",c,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new bc(i.property,d,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,l){return!(!this.layout||i.isDataDriven()||l.isDataDriven())&&P0.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const l=e.get("text-field"),c=tb().paint.properties[i];let d=!1;const p=v=>{for(const w of v)if(c.overrides&&c.overrides.hasOverride(w))return void(d=!0)};if(l.value.kind==="constant"&&l.value.value instanceof Yr)p(l.value.value.sections);else if(l.value.kind==="source"){const v=S=>{d||(S instanceof In&&vr(S.value)===xu?p(S.value.sections):S instanceof cl?p(S.sections):S.eachChild(v))},w=l.value;w._styleExpression&&v(w._styleExpression.expression)}return d}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,l){return{config:new Ra(this,{zoom:i,lut:l}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let xA,bA,wA,TA;var nb=Yn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function ib(o){switch(o){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function rb(o){switch(o){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class ob{constructor(e,i,l,c){this.context=e,this.format=l,this.useMipmap=c&&c.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:c&&c.premultiply})}update(e,i){const l=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,c=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:d}=this,{gl:p}=d,{x:v,y:w}=i&&i.position?i.position:{x:0,y:0},S=v+l,I=w+c;!this.size||this.size[0]===S&&this.size[1]===I||(p.bindTexture(p.TEXTURE_2D,null),p.deleteTexture(this.texture),this.texture=p.createTexture(),this.size=null),p.bindTexture(p.TEXTURE_2D,this.texture),d.pixelStoreUnpackFlipY.set(!1),d.pixelStoreUnpack.set(1),d.pixelStoreUnpackPremultiplyAlpha.set(this.format===p.RGBA8&&(!i||i.premultiply!==!1));const C=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&S>0&&I>0){const R=this.useMipmap?Math.floor(Math.log2(Math.max(S,I)))+1:1;p.texStorage2D(p.TEXTURE_2D,R,this.format,S,I),this.size=[S,I]}if(this.size)if(C)p.texSubImage2D(p.TEXTURE_2D,0,v,w,ib(this.format),rb(this.format),e);else{const R=e.data;R&&p.texSubImage2D(p.TEXTURE_2D,0,v,w,l,c,ib(this.format),rb(this.format),R)}this.useMipmap&&p.generateMipmap(p.TEXTURE_2D)}bind(e,i,l=!1){const{context:c}=this,{gl:d}=c;d.bindTexture(d.TEXTURE_2D,this.texture),e!==this.minFilter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this.useMipmap&&!l?e===d.NEAREST?d.NEAREST_MIPMAP_NEAREST:d.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,i),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,l,c){const{context:d}=this,{gl:p}=d;p.bindTexture(p.TEXTURE_2D,this.texture),i!==this.magFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,this.useMipmap?e===p.NEAREST?p.NEAREST_MIPMAP_NEAREST:p.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),l!==this.wrapS&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,l),this.wrapS=l),c!==this.wrapT&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,c),this.wrapT=c)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class z0{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:l}=this,{gl:c}=l;c.bindTexture(c.TEXTURE_2D,this.texture),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,i),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,i),this.wrapS=i)}}function R0(o,e,i,l,c,d,p,v){const w=[o,e,1,i,l,1,c,d,1],S=[p,v,1],I=k([],w),[C,R,B]=fn(S,S,I);return j(w,w,[C,0,0,0,R,0,0,0,B])}function SA(o,e,i,l,c,d,p,v){const w=function(S,I,C,R,B,N,$,X){const K=R0(0,0,1,0,1,1,0,1),le=R0(S,I,C,R,B,N,$,X);return j(le,le,k([],K))}(o,e,i,l,c,d,p,v);return[w[2]/w[8]/At,w[5]/w[8]/At]}function D0(o){return[o[0],Math.min(Math.max(o[1],-85.051129),Fe)]}class EA extends sl{constructor(e,i,l,c){super(),this.id=e,this.dispatcher=l,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new _a("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=tc(this.map._requestManager.transformRequest(this.url,$h.Image),(l,c)=>{this._imageRequest=null,this._loaded=!0,l?this.fire(new np(l)):c&&(this.image=c instanceof HTMLImageElement?rs.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new z0(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new _a("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof z0||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],l=e[0][1];for(const d of e)d[1]>l&&(l=d[1]),d[1]<i&&(i=d[1]);const c=(l+i)/2;if(c>Fe?this.onNorthPole=!0:c<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const d=e.map(je.fromLngLat);this.tileID=function(p){let v=1/0,w=1/0,S=-1/0,I=-1/0;for(const $ of p)v=Math.min(v,$.x),w=Math.min(w,$.y),S=Math.max(S,$.x),I=Math.max(I,$.y);const C=Math.max(S-v,I-w),R=Math.max(0,Math.floor(-Math.log(C)/Math.LN2)),B=Math.pow(2,R);let N=Math.floor((v+S)/2*B);return N>1&&(N-=1),new Si(R,N,Math.floor((w+I)/2*B))}(d),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new _a("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const K in this.tiles){const le=this.tiles[K];le.state!=="loaded"&&(le.state="loaded",le.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=bm(new Si(0,0,0),this.map.transform.projection),l=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(K){const le=K[1].x-K[0].x,re=K[1].y-K[0].y,G=K[2].x-K[1].x,ne=K[2].y-K[1].y,ae=K[3].x-K[2].x,de=K[3].y-K[2].y,be=K[0].x-K[3].x,Ie=K[0].y-K[3].y,Me=le*ne-G*re,ke=G*de-ae*ne,Ye=ae*Ie-be*de,ft=be*re-le*Ie;return Me>0&&ke>0&&Ye>0&&ft>0||Me<0&&ke<0&&Ye<0&&ft<0}(l))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const c=bm(this.tileID,this.map.transform.projection),[d,p,v,w]=this.coordinates.map(K=>{const le=c.projection.project(K[0],K[1]);return hA(c,le)._round()});this.perspectiveTransform=SA(d.x,d.y,p.x,p.y,v.x,v.y,w.x,w.y);const S=this._boundsArray=new Sl;S.emplaceBack(d.x,d.y,0,0),S.emplaceBack(p.x,p.y,At,0),S.emplaceBack(w.x,w.y,0,At),S.emplaceBack(v.x,v.y,At,At),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(S,nb.members),this.boundsSegments=Ui.simpleSegment(0,0,4,2);const I=[],C=[D0((R=this.coordinates)[0]),D0(R[1]),D0(R[2]),D0(R[3])];var R;const[B,N,$,X]=function(K){let le=K[0][0],re=le,G=K[0][1],ne=G;for(let ae=1;ae<K.length;ae++)K[ae][0]<le?le=K[ae][0]:K[ae][0]>re&&(re=K[ae][0]),K[ae][1]<G?G=K[ae][1]:K[ae][1]>ne&&(ne=K[ae][1]);return[le,G,re-le,ne-G]}(C);{const K=new Sl,[le,re,G,ne]=function(We){let ct=We[0].x,Ge=ct,Xe=We[0].y,yt=Xe;for(let vt=1;vt<We.length;vt++)We[vt].x<ct?ct=We[vt].x:We[vt].x>Ge&&(Ge=We[vt].x),We[vt].y<Xe?Xe=We[vt].y:We[vt].y>yt&&(yt=We[vt].y);return[ct,Xe,Ge-ct,yt-Xe]}(l),ae=We=>[(We.x-le)/G,(We.y-re)/ne],[de,be,Ie,Me]=l.map(ae),ke=function(We,ct,Ge,Xe,yt,vt,Wt,Nt){const Mt=R0(0,0,1,0,1,1,0,1);return j(Mt,Mt,k([],R0(We,ct,Ge,Xe,yt,vt,Wt,Nt)))}(de[0],de[1],be[0],be[1],Ie[0],Ie[1],Me[0],Me[1]);this.elevatedGlobePerspectiveTransform=SA(de[0],de[1],be[0],be[1],Ie[0],Ie[1],Me[0],Me[1]);const Ye=(We,ct)=>{I.push(We.lng);const Ge=Math.round((We.lng-B)/$*At),Xe=Math.round((We.lat-N)/X*At),yt=ae(ct),vt=fn([],[yt[0],yt[1],1],ke),Wt=Math.round(vt[0]/vt[2]*At),Nt=Math.round(vt[1]/vt[2]*At);K.emplaceBack(Ge,Xe,Wt,Nt)},ft=l[3].x-l[0].x,at=l[3].y-l[0].y,ht=l[2].x-l[1].x,_t=l[2].y-l[1].y;for(let We=0;We<65;We++){const ct=We/64,Ge=[l[0].x+ct*ft,l[0].y+ct*at],Xe=[l[1].x+ct*ht,l[1].y+ct*_t],yt=Xe[0]-Ge[0],vt=Xe[1]-Ge[1];for(let Wt=0;Wt<65;Wt++){const Nt=Wt/64,Mt={x:Ge[0]+yt*Nt,y:Ge[1]+vt*Nt};Ye(i.projection.unproject(Mt.x,Mt.y),Mt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(K,nb.members)}{this.maxLongitudeTriangleSize=0;let K=[],le=new wr;const re=(G,ne,ae)=>{le.emplaceBack(G,ne,ae);const de=I[G],be=I[ne],Ie=I[ae],Me=Math.min(Math.min(de,be),Ie),ke=Math.max(Math.max(de,be),Ie)-Me;ke>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=ke),K.push(Me+ke/2)};for(let G=0;G<64;G++)for(let ne=0;ne<64;ne++){const ae=65*G+ne,de=ae+1,be=ae+65,Ie=be+1;re(ae,be,de),re(de,be,Ie)}[K,le]=function(G,ne){const ae=Array.from({length:G.length},(Ie,Me)=>Me);ae.sort((Ie,Me)=>G[Ie]-G[Me]);const de=[],be=new wr;for(let Ie=0;Ie<ae.length;Ie++){const Me=ae[Ie];de.push(G[Me]);const ke=3*Me,Ye=ke+1;be.emplaceBack(ne.uint16[ke],ne.uint16[Ye],ne.uint16[Ye+1])}return[de,be]}(K,le),this.elevatedGlobeTrianglesCenterLongitudes=K,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(le)}this.elevatedGlobeSegments=Ui.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,$/At,0,X/At,0,0,N,B,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,l=i.gl;!this._dirty||this.texture instanceof z0||(this.texture?this.texture.update(this.image):(this.texture=new ob(i,this.image,l.RGBA8),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const l=this.elevatedGlobeTrianglesCenterLongitudes;let c=(d=e+180)+360*Math.round((l[0]-d)/360);var d;const p=new Ui,v=(C,R)=>{p.segments.push({vertexOffset:0,primitiveOffset:C,vertexLength:i.segments[0].vertexLength,primitiveLength:R,sortKey:void 0,vaos:{}})},w=.51*this.maxLongitudeTriangleSize;if(Math.abs(l[0]-c)<=w){const C=Gs(l,0,l.length,c+w);return C===l.length||v(C,Dr(l,C+1,l.length,c+360-w)-C),p}c<l[0]&&(c+=360);const S=Dr(l,0,l.length,c-w);if(S===l.length)return v(0,l.length),p;v(0,S-0);const I=Gs(l,S+1,l.length,c+w);return I!==l.length&&v(I,l.length-I),p}}const Tk=(Math.pow(256,2)-1)/16907520;class AA extends eo{constructor(e,i,l,c){super(e,{layout:wA||(wA=new Xi({visibility:new wt(Ne.layout_raster.visibility)})),paint:TA||(TA=new Xi({"raster-opacity":new wt(Ne.paint_raster["raster-opacity"]),"raster-color":new wl(Ne.paint_raster["raster-color"]),"raster-color-mix":new wt(Ne.paint_raster["raster-color-mix"]),"raster-color-range":new wt(Ne.paint_raster["raster-color-range"]),"raster-hue-rotate":new wt(Ne.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new wt(Ne.paint_raster["raster-brightness-min"]),"raster-brightness-max":new wt(Ne.paint_raster["raster-brightness-max"]),"raster-saturation":new wt(Ne.paint_raster["raster-saturation"]),"raster-contrast":new wt(Ne.paint_raster["raster-contrast"]),"raster-resampling":new wt(Ne.paint_raster["raster-resampling"]),"raster-fade-duration":new wt(Ne.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new wt(Ne.paint_raster["raster-emissive-strength"]),"raster-array-band":new wt(Ne.paint_raster["raster-array-band"]),"raster-elevation":new wt(Ne.paint_raster["raster-elevation"]),"raster-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},i,l,c),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof EA&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[l,c]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(l)&&isNaN(c)||l===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=om({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:l,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[l,c])}}let IA,MA,CA,PA,zA;class RA extends eo{constructor(e,i,l,c){super(e,{layout:IA||(IA=new Xi({visibility:new wt(Ne["layout_raster-particle"].visibility)})),paint:MA||(MA=new Xi({"raster-particle-array-band":new wt(Ne["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new wt(Ne["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new wl(Ne["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new wt(Ne["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new wt(Ne["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new wt(Ne["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new wt(Ne["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new wt(Ne["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},i,l,c),this._updateColorRamp(),this.lastInvalidatedAt=rs.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=om({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=rs.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Sk extends eo{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function sb(o,e,i){const l=[0,0,1],c=da([]);return Ka(c,c,i?-W(o)+Math.PI:W(o)),Us(c,c,-W(e)),Tn(l,l,c),hn(l,l)}function DA(o,e){const i=L0(o.projection,o.zoom,o.width,o.height),l=function(d,p,v,w,S){const I=new Z(v.lng-180*Bc,v.lat),C=new Z(v.lng+180*Bc,v.lat),R=d.project(I.lng,I.lat),B=d.project(C.lng,C.lat),N=-Math.atan2(B.y-R.y,B.x-R.x),$=je.fromLngLat(v);$.y=ze($.y,-1+Bc,1-Bc);const X=$.toLngLat(),K=d.project(X.lng,X.lat),le=je.fromLngLat(X);le.x+=Bc;const re=le.toLngLat(),G=d.project(re.lng,re.lat),ne=kA(G.x-K.x,G.y-K.y,N),ae=je.fromLngLat(X);ae.y+=Bc;const de=ae.toLngLat(),be=d.project(de.lng,de.lat),Ie=kA(be.x-K.x,be.y-K.y,N),Me=Math.abs(ne.x)/Math.abs(Ie.y),ke=J([]);De(ke,ke,-N*(1-(S?0:w)));const Ye=J([]);return ce(Ye,Ye,[1,1-(1-Me)*w,1]),Ye[4]=-Ie.x/Ie.y*w,De(Ye,Ye,N),ee(Ye,ke,Ye),Ye}(o.projection,0,o.center,i,e),c=LA(o);return ce(l,l,[c,c,1]),l}function LA(o){const e=o.projection,i=L0(o.projection,o.zoom,o.width,o.height),l=ab(e,o.center),c=ab(e,Z.convert(e.center));return Math.pow(2,l*i+(1-i)*c)}function L0(o,e,i,l,c=1/0){const d=o.range;if(!d)return 0;const p=Math.min(c,Math.max(i,l)),v=Math.log(p/1024)/Math.LN2;return Re(d[0]+v,d[1]+v,e)}const Bc=1/4e4;function ab(o,e){const i=ze(e.lat,-85.051129,Fe),l=new Z(e.lng-180*Bc,i),c=new Z(e.lng+180*Bc,i),d=o.project(l.lng,i),p=o.project(c.lng,i),v=je.fromLngLat(l),w=je.fromLngLat(c),S=p.x-d.x,I=p.y-d.y,C=w.x-v.x,R=w.y-v.y,B=Math.sqrt((C*C+R*R)/(S*S+I*I));return Math.log(B)/Math.LN2}function kA(o,e,i){const l=Math.cos(i),c=Math.sin(i);return{x:o*l-e*c,y:o*c+e*l}}function OA(o,e,i){J(o),De(o,o,W(e[2])),se(o,o,W(e[0])),Ae(o,o,W(e[1])),ce(o,o,i),ee(o,o,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function k0(o,e,i,l,c,d,p,v){const w=[i[0]-e[0],i[1]-e[1],0],S=[l[0]-e[0],l[1]-e[1],0];if(ut(w)<1e-12||ut(S)<1e-12)return da(o);const I=Pn([],w,S);hn(I,I),qe(S,l,e),w[2]=(d-c)*v,S[2]=(p-c)*v;const C=w;return Pn(C,w,S),hn(C,C),js(o,I,C)}function lb(o,e,i=!1){const l=Rc(e.zoom),c=function(d,p,v){const w=p.worldSize,S=[d[12],d[13],d[14]],I=Te(S[1]/w),C=we(S[0]/w),R=J([]),B=_e(1,I)*w,N=_e(1,0)*w*et(I,p.zoom),$=1/_1(w);let X=N*$;if(v){const G=L0(p.projection,p.zoom,p.width,p.height,1024);X=$*p.projection.pixelSpaceConversion(p.center.lat,w,G)}const K=H(I,C);Ve(K,K,Lt([],hn([],K),B*X*S[2]));const le=function(G){const ne=[G[0],G[1],G[2]];let ae=[0,1,0];const de=Pn([],ae,ne);return Pn(ae,ne,de),pi(ae)===0&&(ae=[0,1,0],Pn(de,ne,ae)),hn(de,de),hn(ae,ae),hn(ne,ne),[de[0],de[1],de[2],0,ae[0],ae[1],ae[2],0,ne[0],ne[1],ne[2],0,G[0],G[1],G[2],1]}(K);ce(R,R,[X,X,X*B]),ue(R,R,[-S[0],-S[1],-S[2]]);const re=ee([],p.globeMatrix,le);return ee(re,re,R),ee(re,re,d),re}(o,e,i);if(l>0){const d=function(p,v){const w=v.worldSize,S=_e(1,0)*w*et(v.center.lat,v.zoom)/_1(w),I=_e(1,v.center.lat)*w,C=J([]);return Ae(C,C,W(v.center.lng)),se(C,C,W(v.center.lat)),ue(C,C,[0,0,g]),ce(C,C,[S,S,S*I]),ue(C,C,[v.point.x-.5*w,v.point.y-.5*w,0]),ee(C,C,p),ee(C,v.globeMatrix,C)}(o,e);return function(p,v,w){const S=(N,$,X)=>{const K=ut(N),le=ut($),re=Cl(N,$,X);return Lt(re,re,1/ut(re)*Jt(K,le,X))},I=S([p[0],p[1],p[2]],[v[0],v[1],v[2]],w),C=S([p[4],p[5],p[6]],[v[4],v[5],v[6]],w),R=S([p[8],p[9],p[10]],[v[8],v[9],v[10]],w),B=Cl([p[12],p[13],p[14]],[v[12],v[13],v[14]],w);return[I[0],I[1],I[2],0,C[0],C[1],C[2],0,R[0],R[1],R[2],0,B[0],B[1],B[2],1]}(c,d,l)}return c}function FA(o,e,i,l){const c=Ri.projectAabbCorners(l,i);let d=Number.MAX_VALUE,p=-1;for(let S=0;S<c.length;++S){const I=c[S];I[0]=(.5*I[0]+.5)*e.width,I[1]=(.5-.5*I[1])*e.height,I[2]<d&&(p=S,d=I[2])}const v=S=>new St(c[S][0],c[S][1]);let w;switch(p){case 0:case 6:w=[v(1),v(5),v(4),v(7),v(3),v(2),v(1)];break;case 1:case 7:w=[v(0),v(4),v(5),v(6),v(2),v(3),v(0)];break;case 3:case 5:w=[v(1),v(0),v(4),v(7),v(6),v(2),v(1)];break;default:w=[v(1),v(5),v(6),v(7),v(3),v(0),v(1)]}if(en(o,w))return d}const Ek=Yn([{name:"a_pos_3f",components:3,type:"Float32"}]),Ak=Yn([{name:"a_color_3f",components:3,type:"Float32"}]),Ik=Yn([{name:"a_color_4f",components:4,type:"Float32"}]),Mk=Yn([{name:"a_uv_2f",components:2,type:"Float32"}]),Ck=Yn([{name:"a_normal_3f",components:3,type:"Float32"}]),Pk=Yn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),zk=Yn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),BA={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class O0{constructor(e,i,l,c){this.message=(e?`${e}: `:"")+l,c&&(this.identifier=c),i!=null&&i.__line__&&(this.line=i.__line__)}}function cb(o,e){const i=o.indexOf("://")===-1;try{return new URL(o,i&&e?"http://example.com":void 0),!0}catch{return!1}}class NA{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class VA{constructor(){this.instancedDataArray=new Ac,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class ub{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,l,c){this.tileToMeter=Oe(l);const d=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:p,id:v,index:w,sourceLayerIndex:S}of e){const I=v??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),C=Xt(p,d);if(!this.layers[0]._featureFilter.filter(new si(this.zoom),C,l))continue;const R={id:I,sourceLayerIndex:S,index:w,geometry:d?C.geometry:Vt(p,l,c),properties:p.properties,type:p.type,patterns:{}},B=this.addFeature(R,R.geometry,C);B&&i.featureIndex.insert(p,R.geometry,w,S,this.index,this.instancesPerModel[B].instancedDataArray.length,At/32)}this.lookup=null}update(e,i,l,c){for(const d in this.instancesPerModel){const p=this.instancesPerModel[d];for(const v in e)p.idToFeaturesIndex.hasOwnProperty(v)&&(this.evaluate(p.features[p.idToFeaturesIndex[v]],e[v],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];for(const c of l.features){const d=this.layers[0],p=c.feature,v=this.canonical,w=d.paint.get("model-rotation").evaluate(p,{},v),S=d.paint.get("model-scale").evaluate(p,{},v),I=d.paint.get("model-translation").evaluate(p,{},v);It(c.rotation,w)&&It(c.scale,S)&&It(c.translation,I)||(this.evaluate(c,c.featureStates,l,!0),e=!0)}}return e}updateReplacement(e,i,l,c){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const d=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(D1(this.activeReplacements,d))return!1;this.activeReplacements=d;let p=!1;for(const v in this.instancesPerModel){const w=this.instancesPerModel[v],S=w.instancedDataArray;for(const I of w.features){const C=I.instancedDataOffset,R=I.instancedDataCount;for(let B=0;B<R;B++){const N=16*(B+C);let $=S.float32[N+0];const X=$>At;$=X?$-At:$;const K=Math.floor($),le=S.float32[N+1];let re=!1;for(const G of this.activeReplacements)if(!qS(G,l,BA.Model,c)&&!(G.min.x>K||K>G.max.x||G.min.y>le||le>G.max.y)&&(re=KS(YS(K,le,e.canonical,G.footprintTileId.canonical),G.footprint),re))break;S.float32[N]=re?$+At:$,p=p||re!==X}}}return p}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];l.instancedDataArray.length<0||l.instancedDataArray.length===0||(l.instancedDataBuffer?l.instancedDataBuffer.updateData(l.instancedDataArray):l.instancedDataBuffer=e.createVertexBuffer(l.instancedDataArray,Pk.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,l){const c=this.layers[0],d=c.layout.get("model-id").evaluate(l,{},this.canonical);if(!d)return Dn(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),d;(cb(d,!1)||this.styleDefinedModelURLs[d]!==void 0)&&(this.modelUris.includes(d)||this.modelUris.push(d)),this.instancesPerModel[d]||(this.instancesPerModel[d]=new VA);const p=this.instancesPerModel[d],v=p.instancedDataArray,w=new NA(l,v.length);for(const S of i)for(const I of S){if(I.x<0||I.x>=At||I.y<0||I.y>=At)continue;const C=(this.lookupDim-1)/At,R=this.lookupDim*(I.y*C|0)+I.x*C|0;if(this.lookup){if(this.lookup[R]!==0)continue;this.lookup[R]=1}this.instanceCount++;const B=v.length;v.resize(B+1),p.instancesEvaluatedElevation.push(0),v.float32[16*B]=I.x,v.float32[16*B+1]=I.y}return w.instancedDataCount=p.instancedDataArray.length-w.instancedDataOffset,w.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(w),this.evaluate(w,{},p,!1)),d}getModelUris(){return this.modelUris}evaluate(e,i,l,c){const d=this.layers[0],p=e.feature,v=this.canonical,w=e.rotation=d.paint.get("model-rotation").evaluate(p,i,v),S=e.scale=d.paint.get("model-scale").evaluate(p,i,v),I=e.translation=d.paint.get("model-translation").evaluate(p,i,v),C=d.paint.get("model-color").evaluate(p,i,v);C.a=d.paint.get("model-color-mix-intensity").evaluate(p,i,v);const R=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]),this.maxScale=Math.max(Math.max(this.maxScale,S[0]),Math.max(S[1],S[2])),OA(R,w,S);const B=Math.round(100*C.a)+C.b/1.05;for(let N=0;N<e.instancedDataCount;++N){const $=e.instancedDataOffset+N,X=16*$,K=l.instancedDataArray.float32;let le=0;c&&(le=K[X+6]-l.instancesEvaluatedElevation[$]);const re=0|K[X+1];K[X]=(0|K[X])+C.r/1.05,K[X+1]=re+C.g/1.05,K[X+2]=B,K[X+3]=1/(v.z>10?this.tileToMeter:Oe(v,re)),K[X+4]=I[0],K[X+5]=I[1],K[X+6]=I[2]+le,K[X+7]=R[0],K[X+8]=R[1],K[X+9]=R[2],K[X+10]=R[4],K[X+11]=R[5],K[X+12]=R[6],K[X+13]=R[8],K[X+14]=R[9],K[X+15]=R[10],l.instancesEvaluatedElevation[$]=I[2]}}}let UA,jA;Ft(ub,"ModelBucket",{omit:["layers"]}),Ft(VA,"PerModelAttributes"),Ft(NA,"ModelFeature");const oh=64,Xf={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function $A(o,e,i,l,c,d,p,v,w,S=!1){const I=i.zoom,C=i.project(l),R=et(l.lat,I),B=1/R;J(o),ue(o,o,[C.x+p[0]*B,C.y+p[1]*B,p[2]]);let N=1,$=1;const X=i.worldSize;if(S){if(i.projection.name==="mercator"){let G=0;i.elevation&&(G=i.elevation.getAtPointOrZero(new je(C.x/X,C.y/X),0));const ne=tr([],[C.x,C.y,G,1],i.projMatrix)[3]/i.cameraToCenterDistance;N=ne,$=ne*et(i.center.lat,I)}else if(i.projection.name==="globe"){const G=lb(o,i),ne=[0,0,0,1];tr(ne,ne,ee([],i.projMatrix,G));const ae=ne[3]/i.cameraToCenterDistance,de=Rc(I),be=i.projection.pixelsPerMeter(l.lat,X)*et(l.lat,I),Ie=i.projection.pixelsPerMeter(i.center.lat,X)*et(i.center.lat,I);N=ae/Jt(be,ot(i.center.lat),de),$=ae*R/be,N*=Ie,$*=Ie}}else N=B;ce(o,o,[N,N,$]);const K=[...o],le=e.orientation,re=[];if(OA(re,[le[0]+c[0],le[1]+c[1],le[2]+c[2]],d),ee(o,K,re),v&&i.elevation){let G=0;const ne=[];if(w&&i.elevation){G=function(de,be,Ie,Me,ke){const Ye=be.elevation;if(!Ye)return 0;const ft=Ri.projectAabbCorners(Ie,Me),at=_e(1,ke.lat)*be.worldSize,ht=function(gt,ln){const $t=[0,0,1],Gt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const on of Gt){const mn=gt[on.corners[0]],gn=gt[on.corners[1]],Cn=gt[on.corners[2]],Sn=[gn[0]-mn[0],gn[1]-mn[1],ln*(gn[2]-mn[2])],bn=Pn(Sn,Sn,[Cn[0]-mn[0],Cn[1]-mn[1],ln*(Cn[2]-mn[2])]);hn(bn,bn),on.dotProductWithUp=Nn(bn,$t)}return Gt.sort((on,mn)=>on.dotProductWithUp-mn.dotProductWithUp),Gt[0].corners}(ft,at),_t=ft[ht[0]],We=ft[ht[1]],ct=ft[ht[2]],Ge=ft[ht[3]],Xe=Ye.getAtPointOrZero(new je(_t[0]/be.worldSize,_t[1]/be.worldSize),0),yt=Ye.getAtPointOrZero(new je(We[0]/be.worldSize,We[1]/be.worldSize),0),vt=Ye.getAtPointOrZero(new je(ct[0]/be.worldSize,ct[1]/be.worldSize),0),Wt=Ye.getAtPointOrZero(new je(Ge[0]/be.worldSize,Ge[1]/be.worldSize),0),Nt=(Xe+Wt)/2,Mt=(yt+vt)/2;return Nt>Mt?yt<vt?k0(de,We,Ge,_t,yt,Wt,Xe,at):k0(de,ct,_t,Ge,vt,Xe,Wt,at):Xe<Wt?k0(de,_t,We,ct,Xe,yt,vt,at):k0(de,Ge,ct,We,Wt,vt,yt,at),Math.max(Nt,Mt)}(ne,i,e.aabb,o,l);const ae=ee([],rt([],ne),re);ee(o,K,ae)}else G=i.elevation.getAtPointOrZero(new je(C.x/X,C.y/X),0);G!==0&&(o[14]+=G)}}function Am(o,e,i=!1){o.uploaded||(o.gfxTexture=new ob(e,o.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:o.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),o.uploaded=!0,o.image=null)}function Rk(o,e,i){o.indexBuffer=e.createIndexBuffer(o.indexArray,!1,!0),o.vertexBuffer=e.createVertexBuffer(o.vertexArray,Ek.members,!1,!0),o.normalArray&&(o.normalBuffer=e.createVertexBuffer(o.normalArray,Ck.members,!1,!0)),o.texcoordArray&&(o.texcoordBuffer=e.createVertexBuffer(o.texcoordArray,Mk.members,!1,!0)),o.colorArray&&(o.colorBuffer=e.createVertexBuffer(o.colorArray,(o.colorArray.bytesPerElement===12?Ak:Ik).members,!1,!0)),o.featureArray&&(o.pbrBuffer=e.createVertexBuffer(o.featureArray,zk.members,!0)),o.segments=Ui.simpleSegment(0,0,o.vertexArray.length,o.indexArray.length);const l=o.material;l.pbrMetallicRoughness.baseColorTexture&&Am(l.pbrMetallicRoughness.baseColorTexture,e),l.pbrMetallicRoughness.metallicRoughnessTexture&&Am(l.pbrMetallicRoughness.metallicRoughnessTexture,e),l.normalTexture&&Am(l.normalTexture,e),l.occlusionTexture&&Am(l.occlusionTexture,e,i),l.emissionTexture&&Am(l.emissionTexture,e)}function hb(o,e,i){if(o.meshes)for(const l of o.meshes)Rk(l,e,i);if(o.children)for(const l of o.children)hb(l,e,i)}function F0(o){if(o.meshes)for(const e of o.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(o.children)for(const e of o.children)F0(e)}function fb(o){if(o.meshes)for(const i of o.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(o.children)for(const i of o.children)fb(i)}class Yf{constructor(e,i,l){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=l}static create(e,i,l){const c=l||e.findDEMTileFor(i);if(!c||!c.dem)return;const d=c.dem,p=c.tileID,v=1<<i.canonical.z-p.canonical.z;return new Yf(c,d.dim/At/v,[(i.canonical.x/v-p.canonical.x)*d.dim,(i.canonical.y/v-p.canonical.y)*d.dim])}tileCoordToPixel(e,i){const l=i*this._scale+this._offset[1],c=Math.floor(e*this._scale+this._offset[0]),d=Math.floor(l);return new St(c,d)}getElevationAt(e,i,l,c){const d=e*this._scale+this._offset[0],p=i*this._scale+this._offset[1],v=Math.floor(d),w=Math.floor(p),S=this._dem;return c=!!c,l?Jt(Jt(S.get(v,w,c),S.get(v,w+1,c),p-w),Jt(S.get(v+1,w,c),S.get(v+1,w+1,c),p-w),d-v):S.get(v,w,c)}getElevationAtPixel(e,i,l){return this._dem.get(e,i,!!l)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*_e(1,e)*this._dem.stride}}const db=new Float32Array(262144),sh=new Uint8Array(262144);function GA(o){let e=0;if(o.meshes)for(const i of o.meshes)e=Math.max(e,i.aabb.max[2]);if(o.children)for(const i of o.children)e=Math.max(e,GA(i));return e}function qA(o,e,i){if(o.meshes)for(const l of o.meshes){if(l.aabb.min[0]===1/0)continue;const c=Ri.applyTransform(l.aabb,o.matrix);i.insert(e,c.min[0],c.min[1],c.max[0],c.max[1])}if(o.children)for(const l of o.children)qA(l,e,i)}const HA=["","wall","door","roof","window","lamp","logo"];class ZA{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:GA(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const l of this.node.meshes)this.node.lightMeshIndex!==e&&(l.transformedAabb=Ri.applyTransformFast(l.aabb,this.node.matrix),i.encapsulate(l.transformedAabb)),e++;this.aabb=i}return this.aabb}}class B0{constructor(e,i,l,c,d,p,v){this.id=l,this.layers=e,this.layerIds=this.layers.map(w=>w.fqid),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.modelTraits|=Xf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,c&&(this.modelTraits|=Xf.HasMapboxMeshFeatures),d&&(this.modelTraits|=Xf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=p,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const w of i)this.nodesInfo.push(new ZA(w)),qA(w,v.featureIndexArray.length,v.grid),v.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,v.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const l of this.getNodesInfo()){const c=l.node;c.footprint&&i.push({footprint:c.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const l=i?this.stateDependentLayers:this.layers;if(!$s(e,this.states))for(const c of l)this.evaluate(c,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const l of i){const c=l.node;this.uploaded?this.updatePbrBuffer(c):hb(c,e,!0)}for(const l of i)F0(l.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const l of e.meshes)l.pbrBuffer&&(l.pbrBuffer.updateData(l.featureArray),i=!0);return i}needsReEvaluation(e,i,l){const c=e.transform.projectionOptions,d=e.style.getBrightness(),p=this.brightness!==d;if(!this.uploaded||this.dirty||c.name!==this.projection.name||Im(l.paint.get("model-color").value,p)||Im(l.paint.get("model-color-mix-intensity").value,p)||Im(l.paint.get("model-roughness").value,p)||Im(l.paint.get("model-emissive-strength").value,p)||Im(l.paint.get("model-height-based-emissive-strength-multiplier").value,p)){this.projection=c,this.brightness=d;const v=this.getNodesInfo();for(const w of v)w.state=null;return!0}return!1}evaluateScale(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const l=this.getNodesInfo(),c=this.id.canonical;for(const d of l){const p=d.feature;d.evaluatedScale=i.paint.get("model-scale").evaluate(p,{},c)}}evaluate(e,i){const l=this.getNodesInfo();for(const c of l){if(!c.node.meshes)continue;const d=c.feature,p=i&&i[d.id];if($s(p,c.state))continue;c.state=structuredClone(p);const v=c.node.meshes&&c.node.meshes[0].featureData,w=c.evaluatedColor[2],S=c.evaluatedRMEA[2],I=this.id.canonical;if(c.hasTranslucentParts=!1,v){for(let C=0;C<HA.length;C++){const R=HA[C];R.length&&(d.properties.part=R);const B=e.paint.get("model-color").evaluate(d,p,I).toRenderColor(null),N=e.paint.get("model-color-mix-intensity").evaluate(d,p,I);c.evaluatedColor[C]=[B.r,B.g,B.b,N],c.evaluatedRMEA[C][0]=e.paint.get("model-roughness").evaluate(d,p,I),c.evaluatedRMEA[C][2]=e.paint.get("model-emissive-strength").evaluate(d,p,I),c.evaluatedRMEA[C][3]=B.a,c.emissionHeightBasedParams[C]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(d,p,I),!c.hasTranslucentParts&&B.a<1&&(c.hasTranslucentParts=!0)}delete d.properties.part,Lk(c,w!==c.evaluatedColor[2]||S!==c.evaluatedRMEA[2],this.modelTraits)}else c.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(d,p,I);c.evaluatedScale=e.paint.get("model-scale").evaluate(d,p,I),this.updatePbrBuffer(c.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,l,c){const d=e.findDEMTileFor(l);if(d&&(d.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(d.dem&&d.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=d.tileID.overscaledZ;const p=Yf.create(e,l,d);if(!p)return;this.modelTraits&Xf.HasMapboxMeshFeatures&&this.updateDEM(e,p,l,c);for(const v of this.getNodesInfo()){const w=v.node;if(!w.footprint||!w.footprint.vertices||!w.footprint.vertices.length)continue;const S=w.footprint.vertices;let I=p.getElevationAt(S[0].x,S[0].y,!0,!0);for(let C=1;C<S.length;C++)I=Math.min(I,p.getElevationAt(S[C].x,S[C].y,!0,!0));w.elevation=I}}this.terrainTile=d.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,l,c){let d=i._dem._modifiedForSources[c];if(d===void 0&&(i._dem._modifiedForSources[c]=[],d=i._dem._modifiedForSources[c]),d.includes(l.canonical))return;const p=i._dem.dim;d.push(l.canonical);let v=!1;for(const w of this.getNodesInfo()){const S=w.node;if(!S.footprint||!S.footprint.grid)continue;const I=S.footprint.grid,C=i.tileCoordToPixel(I.min.x,I.min.y),R=i.tileCoordToPixel(I.max.x,I.max.y),B=Math.min(Math.min(p-R.y,C.x),Math.min(C.y,p-R.x));if(B<0)continue;const N=ze(B,2,5);let $=Math.max(0,C.x-N),X=Math.max(0,C.y-N),K=Math.min(R.x+N,p-1),le=Math.min(R.y+N,p-1);for(let ae=X;ae<=le;++ae)for(let de=$;de<=K;++de)sh[ae*p+de]=255;let re=0,G=0;for(let ae=0;ae<I.cellsY;++ae)for(let de=0;de<I.cellsX;++de){if(!I.cells[ae*I.cellsX+de])continue;const be=i.tileCoordToPixel(I.min.x+de/I.xScale,I.min.y+ae/I.yScale),Ie=i.tileCoordToPixel(I.min.x+(de+1)/I.xScale,I.min.y+(ae+1)/I.yScale);for(let Me=be.y;Me<=Math.min(Ie.y+1,p-1);++Me)for(let ke=be.x;ke<=Math.min(Ie.x+1,p-1);++ke)sh[Me*p+ke]===255&&(sh[Me*p+ke]=0,re+=i.getElevationAtPixel(ke,Me),G++)}const ne=re/G;$=Math.max(1,C.x-N),X=Math.max(1,C.y-N),K=Math.min(R.x+N,p-2),le=Math.min(R.y+N,p-2),v=!0;for(let ae=X;ae<=le;++ae)for(let de=$;de<=K;++de)sh[ae*p+de]===0&&(db[ae*p+de]=i._dem.set(de,ae,ne));for(let ae=1;ae<N;++ae){$=Math.max(1,C.x-ae),X=Math.max(1,C.y-ae),K=Math.min(R.x+ae,p-2),le=Math.min(R.y+ae,p-2);for(let de=X;de<=le;++de)for(let be=$;be<=K;++be){const Ie=de*p+be;if(sh[Ie]===255){let Me=0,ke=0,Ye=-1,ft=-1;for(let at=-1;at<=1;++at)for(let ht=-1;ht<=1;++ht){const _t=(de+at)*p+be+ht;if(sh[_t]>=ae)continue;const We=db[_t],ct=Math.abs(We);ct>ke&&(Me=We,ke=ct,Ye=ht,ft=at)}if(ke>.1){const at=1-(ae+.5*Math.abs(Ye*ft))/N;let ht=i._dem.get(be,de)+Me*at;const _t=i._dem.get(be+Ye,de+ft),We=i._dem.get(be-Ye,de-ft,!0);(ht-_t)*(ht-We)>0&&(ht=(_t+We)/2),db[Ie]=i._dem.set(be,de,ht),sh[Ie]=ae}}}}}v&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=rs.now())}setFilter(e){this.filter=e?Vp(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new si(this.id.overscaledZ),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)F0(i.node),fb(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped()),c=this.getNodesInfo();for(let d=0;d<this.nodesInfo.length;d++){const p=c[d].node;c[d].hiddenByReplacement=!!p.footprint&&!l.find(v=>v.footprint===p.footprint)}}getHeightAtTileCoord(e,i){const l=this.getNodesInfo(),c=[],d=[0,0,0],p=J([]);for(let v=0;v<this.nodesInfo.length;v++){const w=l[v],S=w.node.meshes[0],I=S.transformedAabb;if(e<I.min[0]||i<I.min[1]||e>I.max[0]||i>I.max[1])continue;if(w.node.hidden===!0)return{height:1/0,maxHeight:w.feature.properties.height,hidden:!1,verticalScale:w.evaluatedScale[2]};Q(p,w.node.matrix),d[0]=e,d[1]=i,Ct(d,d,p);const C=(d[0]-S.aabb.min[0])/(S.aabb.max[0]-S.aabb.min[0])*oh|0,R=Math.min(63,(d[1]-S.aabb.min[1])/(S.aabb.max[1]-S.aabb.min[1])*oh|0)*oh+Math.min(63,C),B=S.heightmap[R];if(!(B<0&&w.node.footprint))return w.hiddenByReplacement?void 0:{height:B,maxHeight:w.feature.properties.height,hidden:!1,verticalScale:w.evaluatedScale[2]};if(w.node.footprint.grid.query(new St(e,i),new St(e,i),c),c.length>0)return{height:void 0,maxHeight:w.feature.properties.height,hidden:w.hiddenByReplacement,verticalScale:w.evaluatedScale[2]}}}}function Im(o,e){return o instanceof yl&&!o.isLightConstant&&e}function Dk(o,e,i,l,c,d,p,v){let w=(61440&e|(61440&e)>>4)>>8,S=(3840&e|(3840&e)>>4)>>4,I=240&e|(240&e)>>4;i[3]>0&&(w=Jt(w,255*i[0],i[3]),S=Jt(S,255*i[1],i[3]),I=Jt(I,255*i[2],i[3]));const C=w<<8|S,R=I<<8|Math.floor(255*l[3]),B=function(ae){const de=ze(ae,0,2);return Math.min(Math.round(.5*de*255),255)}(l[2])<<8|15*l[0]<<4|15*l[1],N=ze(c[0],0,1),$=ze(c[1],0,1),X=ze(c[2],0,1),K=ze(c[3],0,1);let le,re,G,ne;if(N!==$&&p!==d&&$!==N){const ae=p-d;re=1/(ae*($-N)),G=-(d+ae*N)/(ae*($-N));const de=ze(c[4],-1,1);ne=Math.pow(10,de),le=255*X<<8|255*K}else le=65535,re=0,G=1,ne=1;if(o.emplaceBack(C,R,B,le,re,G,ne),v){const ae=v.length;v.clear();for(let de=0;de<ae;de++)v.emplaceBack(C,R,B,le,re,G,ne)}}function Lk(o,e,i){const l=o.node;let c=0;const d=i&Xf.HasMeshoptCompression;for(const p of l.meshes){if(l.lights&&l.lightMeshIndex===c||!p.featureData)continue;p.featureArray=new qu,p.featureArray.reserve(p.featureData.length);let v=e;for(const w of p.featureData){const S=d?65535&w:w>>16&65535,I=d?w>>16&65535:65535&w,C=(15&I)<8?15&I:0,R=o.evaluatedRMEA[C],B=o.evaluatedColor[C],N=o.emissionHeightBasedParams[C];let $;if(v&&C===2&&l.lights&&($=new qu,$.resize(10*l.lights.length)),Dk(p.featureArray,S,B,R,N,p.aabb.min[2],p.aabb.max[2],$),$&&v){v=!1;const X=l.meshes[l.lightMeshIndex];X.featureArray=$,X.featureArray._trim()}}p.featureArray._trim(),c++}}function WA(o,e,i,l){const c=1<<o.z;e.lat=Te((l/At+o.y)/c),e.lng=we((i/At+o.x)/c)}Ft(B0,"Tiled3dModelBucket",{omit:["layers"]}),Ft(ZA,"Tiled3dModelFeature");const kk={circle:class extends eo{constructor(o,e,i,l){super(o,{layout:Jn||(Jn=new Xi({"circle-sort-key":new Ot(Ne.layout_circle["circle-sort-key"]),"circle-elevation-reference":new wt(Ne.layout_circle["circle-elevation-reference"]),visibility:new wt(Ne.layout_circle.visibility)})),paint:Fi||(Fi=new Xi({"circle-radius":new Ot(Ne.paint_circle["circle-radius"]),"circle-color":new Ot(Ne.paint_circle["circle-color"]),"circle-blur":new Ot(Ne.paint_circle["circle-blur"]),"circle-opacity":new Ot(Ne.paint_circle["circle-opacity"]),"circle-translate":new wt(Ne.paint_circle["circle-translate"]),"circle-translate-anchor":new wt(Ne.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new wt(Ne.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new wt(Ne.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ot(Ne.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ot(Ne.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ot(Ne.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new wt(Ne.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}createBucket(o){return new jt(o)}queryRadius(o){const e=o;return xn("circle-radius",this,e)+xn("circle-stroke-width",this,e)+Pi(this.paint.get("circle-translate"))}queryIntersectsFeature(o,e,i,l,c,d,p,v){const w=zi(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),d.angle,o.pixelToTileUnitsFactor),S=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return lS(o,l,d,p,v,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",w,S)}getProgramIds(){return["circle"]}getDefaultProgramParams(o,e,i){const l=aS(this);return{config:new Ra(this,{zoom:e,lut:i}),defines:l,overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends eo{createBucket(o){return new uS(o)}constructor(o,e,i,l){super(o,{layout:hS||(hS=new Xi({visibility:new wt(Ne.layout_heatmap.visibility)})),paint:fS||(fS=new Xi({"heatmap-radius":new Ot(Ne.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ot(Ne.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new wt(Ne.paint_heatmap["heatmap-intensity"]),"heatmap-color":new wl(Ne.paint_heatmap["heatmap-color"]),"heatmap-opacity":new wt(Ne.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=om({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(o){return xn("heatmap-radius",this,o)}queryIntersectsFeature(o,e,i,l,c,d,p,v){const w=this.paint.get("heatmap-radius").evaluate(e,i);return lS(o,l,d,p,v,!0,!0,new St(0,0),w)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(o,e,i){return o==="heatmap"?{config:new Ra(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends eo{constructor(o,e,i,l){super(o,{layout:dS||(dS=new Xi({visibility:new wt(Ne.layout_hillshade.visibility)})),paint:pS||(pS=new Xi({"hillshade-illumination-direction":new wt(Ne.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new wt(Ne.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new wt(Ne.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new wt(Ne.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new wt(Ne.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new wt(Ne.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new wt(Ne.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(o,e,i){return{overrideFog:!1}}},fill:class extends eo{constructor(o,e,i,l){super(o,{layout:VS||(VS=new Xi({"fill-sort-key":new Ot(Ne.layout_fill["fill-sort-key"]),visibility:new wt(Ne.layout_fill.visibility),"fill-elevation-reference":new wt(Ne.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Ot(Ne.layout_fill["fill-construct-bridge-guard-rail"])})),paint:US||(US=new Xi({"fill-antialias":new wt(Ne.paint_fill["fill-antialias"]),"fill-opacity":new Ot(Ne.paint_fill["fill-opacity"]),"fill-color":new Ot(Ne.paint_fill["fill-color"]),"fill-outline-color":new Ot(Ne.paint_fill["fill-outline-color"]),"fill-translate":new wt(Ne.paint_fill["fill-translate"]),"fill-translate-anchor":new wt(Ne.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ot(Ne.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new wt(Ne.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new wt(Ne.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Ot(Ne.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Ot(Ne.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Ot(Ne.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}getProgramIds(){const o=this.paint.get("fill-pattern"),e=o&&o.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(o,e,i){return{config:new Ra(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(o,e){super.recalculate(o,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(o){return new P1(o)}queryRadius(){return Pi(this.paint.get("fill-translate"))}queryIntersectsFeature(o,e,i,l,c,d){return!o.queryGeometry.isAboveHorizon&&Rn(Gn(o.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),d.angle,o.pixelToTileUnitsFactor),l)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(o){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return o!=null?e&&!o:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends eo{constructor(o,e,i,l){super(o,{layout:fE||(fE=new Xi({visibility:new wt(Ne["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new wt(Ne["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:dE||(dE=new Xi({"fill-extrusion-opacity":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Ot(Ne["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new wt(Ne["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(o){return new d0(o)}queryRadius(){return Pi(this.paint.get("fill-extrusion-translate"))}is3D(o){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(o,e,i,l,c,d,p,v,w){const S=zi(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),d.angle,o.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(e,i),C=this.paint.get("fill-extrusion-base").evaluate(e,i),R=[0,0],B=v&&d.elevation,N=d.elevation?d.elevation.exaggeration():1,$=o.tile.getBucket(this);if(B&&$ instanceof d0){const G=$.centroidVertexArray,ne=w+1;ne<G.length&&(R[0]=G.geta_centroid_pos0(ne),R[1]=G.geta_centroid_pos1(ne))}if(R[0]===0&&R[1]===1)return!1;d.projection.name==="globe"&&(l=hE([l],[new St(0,0),new St(At,At)],o.tileID.canonical).map(G=>G.polygon).flat());const X=B?v:null,[K,le]=function(G,ne,ae,de,be,Ie,Me,ke,Ye,ft,at){return G.projection.name==="globe"?function(ht,_t,We,ct,Ge,Xe,yt,vt,Wt,Nt,Mt){const gt=[],ln=[],$t=ht.projection.upVectorScale(Mt,ht.center.lat,ht.worldSize).metersToTile,Gt=[0,0,0,1],on=[0,0,0,1],mn=(Cn,Sn,bn,hi)=>{Cn[0]=Sn,Cn[1]=bn,Cn[2]=hi,Cn[3]=1},gn=uE();We>0&&(We+=gn),ct+=gn;for(const Cn of _t){const Sn=[],bn=[];for(const hi of Cn){const Ei=hi.x+Ge.x,he=hi.y+Ge.y,pe=ht.projection.projectTilePoint(Ei,he,Mt),Je=ht.projection.upVector(Mt,hi.x,hi.y);let Tt=We,zt=ct;if(yt){const Pt=vE(Ei,he,We,ct,yt,vt,Wt,Nt);Tt+=Pt.base,zt+=Pt.top}We!==0?mn(Gt,pe.x+Je[0]*$t*Tt,pe.y+Je[1]*$t*Tt,pe.z+Je[2]*$t*Tt):mn(Gt,pe.x,pe.y,pe.z),mn(on,pe.x+Je[0]*$t*zt,pe.y+Je[1]*$t*zt,pe.z+Je[2]*$t*zt),Ct(Gt,Gt,Xe),Ct(on,on,Xe),Sn.push(new nh(Gt[0],Gt[1],Gt[2])),bn.push(new nh(on[0],on[1],on[2]))}gt.push(Sn),ln.push(bn)}return[gt,ln]}(G,ne,ae,de,be,Ie,Me,ke,Ye,ft,at):Me?function(ht,_t,We,ct,Ge,Xe,yt,vt,Wt){const Nt=[],Mt=[],gt=[0,0,0,1];for(const ln of ht){const $t=[],Gt=[];for(const on of ln){const mn=on.x+ct.x,gn=on.y+ct.y,Cn=vE(mn,gn,_t,We,Xe,yt,vt,Wt);gt[0]=mn,gt[1]=gn,gt[2]=Cn.base,gt[3]=1,tr(gt,gt,Ge),gt[3]=Math.max(gt[3],1e-5);const Sn=new nh(gt[0]/gt[3],gt[1]/gt[3],gt[2]/gt[3]);gt[0]=mn,gt[1]=gn,gt[2]=Cn.top,gt[3]=1,tr(gt,gt,Ge),gt[3]=Math.max(gt[3],1e-5);const bn=new nh(gt[0]/gt[3],gt[1]/gt[3],gt[2]/gt[3]);$t.push(Sn),Gt.push(bn)}Nt.push($t),Mt.push(Gt)}return[Nt,Mt]}(ne,ae,de,be,Ie,Me,ke,Ye,ft):function(ht,_t,We,ct,Ge){const Xe=[],yt=[],vt=Ge[8]*_t,Wt=Ge[9]*_t,Nt=Ge[10]*_t,Mt=Ge[11]*_t,gt=Ge[8]*We,ln=Ge[9]*We,$t=Ge[10]*We,Gt=Ge[11]*We;for(const on of ht){const mn=[],gn=[];for(const Cn of on){const Sn=Cn.x+ct.x,bn=Cn.y+ct.y,hi=Ge[0]*Sn+Ge[4]*bn+Ge[12],Ei=Ge[1]*Sn+Ge[5]*bn+Ge[13],he=Ge[2]*Sn+Ge[6]*bn+Ge[14],pe=Ge[3]*Sn+Ge[7]*bn+Ge[15],Je=hi+vt,Tt=Ei+Wt,zt=he+Nt,Pt=Math.max(pe+Mt,1e-5),qt=hi+gt,nn=Ei+ln,kn=he+$t,On=Math.max(pe+Gt,1e-5);mn.push(new nh(Je/Pt,Tt/Pt,zt/Pt)),gn.push(new nh(qt/On,nn/On,kn/On))}Xe.push(mn),yt.push(gn)}return[Xe,yt]}(ne,ae,de,be,Ie)}(d,l,C,I,S,p,X,R,N,d.center.lat,o.tileID.canonical),re=o.queryGeometry;return function(G,ne,ae){let de=1/0;Rn(ae,ne)&&(de=yE(ae,ne[0]));for(let be=0;be<ne.length;be++){const Ie=ne[be],Me=G[be];for(let ke=0;ke<Ie.length-1;ke++){const Ye=Ie[ke],ft=[Ye,Ie[ke+1],Me[ke+1],Me[ke],Ye];en(ae,ft)&&(de=Math.min(de,yE(ae,ft)))}}return de!==1/0&&de}(K,le,re.isPointQuery()?re.screenBounds:re.screenGeometry)}},line:class extends eo{constructor(o,e,i,l){const c=CE();super(o,c,e,i,l),c.layout&&(this.layout=new bl(c.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(o){if(o==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Cu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(o,e){super.recalculate(o,e),this.paint._values["line-floorwidth"]=(()=>{if(mm)return mm;const i=CE();return mm=new k5(i.paint.properties["line-width"].specification),mm.useIntegerZoom=!0,mm})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,o)}createBucket(o){return new F1(o)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(o,e,i){const l=IE(this);return{config:new Ra(this,{zoom:e,lut:i}),defines:l,overrideFog:!1}}queryRadius(o){const e=o,i=PE(xn("line-width",this,e),xn("line-gap-width",this,e)),l=xn("line-offset",this,e);return i/2+Math.abs(l)+Pi(this.paint.get("line-translate"))}queryIntersectsFeature(o,e,i,l,c,d){if(o.queryGeometry.isAboveHorizon)return!1;const p=Gn(o.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),d.angle,o.pixelToTileUnitsFactor),v=o.pixelToTileUnitsFactor/2*PE(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),w=this.paint.get("line-offset").evaluate(e,i);return w&&(l=function(S,I){const C=[],R=new St(0,0);for(let B=0;B<S.length;B++){const N=S[B],$=[];for(let X=0;X<N.length;X++){const K=N[X],le=N[X+1],re=X===0?R:K.sub(N[X-1])._unit()._perp(),G=X===N.length-1?R:le.sub(K)._unit()._perp(),ne=re._add(G)._unit();ne._mult(1/(ne.x*G.x+ne.y*G.y)),$.push(ne._mult(I)._add(K))}C.push($)}return C}(l,w*o.pixelToTileUnitsFactor)),function(S,I,C){for(let R=0;R<I.length;R++){const B=I[R];if(S.length>=3){for(let N=0;N<B.length;N++)if(li(S,B[N]))return!0}if(ai(S,B,C))return!0}return!1}(p,l,v)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(o){return!this.hasElevatedBuckets}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:P0,background:class extends eo{constructor(o,e,i,l){super(o,{layout:xA||(xA=new Xi({visibility:new wt(Ne.layout_background.visibility)})),paint:bA||(bA=new Xi({"background-pitch-alignment":new wt(Ne.paint_background["background-pitch-alignment"]),"background-color":new wt(Ne.paint_background["background-color"]),"background-pattern":new wt(Ne.paint_background["background-pattern"]),"background-opacity":new wt(Ne.paint_background["background-opacity"]),"background-emissive-strength":new wt(Ne.paint_background["background-emissive-strength"]),"background-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(o,e,i){return{overrideFog:!1}}is3D(o){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:AA,"raster-particle":RA,sky:class extends eo{constructor(o,e,i,l){super(o,{layout:CA||(CA=new Xi({visibility:new wt(Ne.layout_sky.visibility)})),paint:PA||(PA=new Xi({"sky-type":new wt(Ne.paint_sky["sky-type"]),"sky-atmosphere-sun":new wt(Ne.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new wt(Ne.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new wt(Ne.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new wt(Ne.paint_sky["sky-gradient-radius"]),"sky-gradient":new wl(Ne.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new wt(Ne.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new wt(Ne.paint_sky["sky-atmosphere-color"]),"sky-opacity":new wt(Ne.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="sky-gradient"?this._updateColorRamp():o!=="sky-atmosphere-sun"&&o!=="sky-atmosphere-halo-color"&&o!=="sky-atmosphere-color"&&o!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=om({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(o){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=o.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(o,e){if(this.paint.get("sky-type")==="atmosphere"){const l=this.paint.get("sky-atmosphere-sun"),c=!l,d=o.style.light,p=d.properties.get("position");return c&&d.properties.get("anchor")==="viewport"&&Dn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?sb(p.azimuthal,90-p.polar,e):sb(l[0],90-l[1],e)}const i=this.paint.get("sky-gradient-center");return sb(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(o){this._skyboxInvalidated=!1,this._lightPosition=o.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const o=this.paint.get("sky-type");return o==="atmosphere"?["skyboxCapture","skybox"]:o==="gradient"?["skyboxGradient"]:null}},slot:class extends eo{constructor(o,e,i,l){super(o,{paint:zA||(zA=new Xi({}))},e,null)}},model:class extends eo{constructor(o,e,i,l){super(o,{layout:UA||(UA=new Xi({visibility:new wt(Ne.layout_model.visibility),"model-id":new Ot(Ne.layout_model["model-id"])})),paint:jA||(jA=new Xi({"model-opacity":new Ot(Ne.paint_model["model-opacity"]),"model-rotation":new Ot(Ne.paint_model["model-rotation"]),"model-scale":new Ot(Ne.paint_model["model-scale"]),"model-translation":new Ot(Ne.paint_model["model-translation"]),"model-color":new Ot(Ne.paint_model["model-color"]),"model-color-mix-intensity":new Ot(Ne.paint_model["model-color-mix-intensity"]),"model-type":new wt(Ne.paint_model["model-type"]),"model-cast-shadows":new wt(Ne.paint_model["model-cast-shadows"]),"model-receive-shadows":new wt(Ne.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new wt(Ne.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ot(Ne.paint_model["model-emissive-strength"]),"model-roughness":new Ot(Ne.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ot(Ne.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new wt(Ne.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new wt(Ne.paint_model["model-front-cutoff"]),"model-color-use-theme":new Ot({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(o){return new ub(o)}getProgramIds(){return["model"]}is3D(o){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(o){return o instanceof B0?At-1:0}queryIntersectsFeature(o,e,i,l,c,d){if(!this.modelManager)return!1;const p=this.modelManager,v=o.tile.getBucket(this);if(!(v&&v instanceof ub))return!1;for(const w in v.instancesPerModel){const S=v.instancesPerModel[w],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(S.idToFeaturesIndex.hasOwnProperty(I)){const C=S.features[S.idToFeaturesIndex[I]],R=p.getModel(w,this.scope);if(!R)return!1;let B=te();const N=new Z(0,0),$=v.canonical;let X=Number.MAX_VALUE;for(let K=0;K<C.instancedDataCount;++K){const le=16*(C.instancedDataOffset+K),re=S.instancedDataArray.float32,G=[re[le+4],re[le+5],re[le+6]];WA($,N,re[le],0|re[le+1]),$A(B,R,d,N,C.rotation,C.scale,G,!1,!1,!1),d.projection.name==="globe"&&(B=lb(B,d));const ne=ee([],d.projMatrix,B),ae=o.queryGeometry,de=FA(ae.isPointQuery()?ae.screenBounds:ae.screenGeometry,d,ne,R.aabb);de!=null&&(X=Math.min(de,X))}return X!==Number.MAX_VALUE&&X}}return!1}_handleOverridablePaintPropertyUpdate(o,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||o!=="model-color"&&o!=="model-color-mix-intensity"&&o!=="model-rotation"&&o!=="model-scale"&&o!=="model-translation"&&o!=="model-emissive-strength")}_isPropertyZoomDependent(o){const e=this._transitionablePaint._values[o];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof yc}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends eo{constructor(o,e,i,l){super(o,{layout:jS||(jS=new Xi({"clip-layer-types":new wt(Ne.layout_clip["clip-layer-types"]),"clip-layer-scope":new wt(Ne.layout_clip["clip-layer-scope"])})),paint:$S||($S=new Xi({}))},e,i,l)}recalculate(o,e){super.recalculate(o,e)}createBucket(o){return new GS(o)}is3D(o){return!0}}};class Ok{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Fk{constructor(){this.tasks={},this.taskQueue=[],un(["process"],this),this.invoker=new Ok(this.process),this.nextId=0}add(e,i){const l=this.nextId++,c=function({type:d,isSymbolTile:p,zoom:v}){return v=v||0,d==="message"?0:d!=="maybePrepare"||p?d!=="parseTile"||p?d==="parseTile"&&p?300-v:d==="maybePrepare"&&p?400-v:500:200-v:100-v}(i);if(c===0){try{e()}finally{}return null}return this.tasks[l]={fn:e,metadata:i,priority:c,id:l},this.taskQueue.push(l),this.invoker.trigger(),{cancel:()=>{delete this.tasks[l]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(l=>!!this.tasks[l]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let c=0;c<this.taskQueue.length;c++){const d=this.tasks[this.taskQueue[c]];d.priority<i&&(i=d.priority,e=c)}if(e===null)return null;const l=this.taskQueue[e];return this.taskQueue.splice(e,1),l}remove(){this.invoker.remove()}}class XA{constructor(e,i,l){this.target=e,this.parent=i,this.mapId=l,this.callbacks={},this.cancelCallbacks={},un(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Fk}send(e,i,l,c,d=!1,p){const v=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=p,this.callbacks[v]=l);const w=new Set;return this.target.postMessage({id:v,type:e,hasCallback:!!l,targetMapId:c,mustQueue:d,sourceMapId:this.mapId,data:Ea(i,w)},w),{cancel:()=>{l&&delete this.callbacks[v],this.target.postMessage({id:v,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const l=i.id;if(l&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const c=this.cancelCallbacks[l];delete this.cancelCallbacks[l],c&&c.cancel()}else if(i.mustQueue||Ti(self)){const c=this.callbacks[l],d=this.scheduler.add(()=>this.processTask(l,i),c&&c.metadata||{type:"message"});d&&(this.cancelCallbacks[l]=d)}else this.processTask(l,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const l=this.callbacks[e];delete this.callbacks[e],l&&(i.error?l(Aa(i.error)):l(null,Aa(i.data)))}else{const l=new Set,c=i.hasCallback?(p,v)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?Ea(p):null,data:Ea(v,l)},l)}:()=>{},d=Aa(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,d,c);else if(this.parent.getWorkerSource){const p=i.type.split("."),{source:v,scope:w}=d;this.parent.getWorkerSource(i.sourceMapId,p[0],v,w)[p[1]](d,c)}else c(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Mm={workerUrl:"",workerClass:null,workerParams:void 0};const pb="mapboxgl_preloaded_worker_pool";class ah{constructor(){this.active={}}acquire(e,i=ah.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(Mm.workerClass!=null?new Mm.workerClass:new self.Worker(Mm.workerUrl,Mm.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[pb]}numActive(){return Object.keys(this.active).length}}ah.workerCount=2;class Kf{constructor(e,i,l="Worker",c=ah.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=kt();const d=this.workerPool.acquire(this.id,c);for(let p=0;p<d.length;p++){const v=new Kf.Actor(d[p],i,this.id);v.name=`${l} ${p}`,this.actors.push(v)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,l){it(this.actors,(c,d)=>{c.send(e,i,d)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Cm,mb;function N0(){return Cm||(Cm=new ah),Cm}Kf.Actor=XA;const _b=new Kn(0,0,0),gb={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},yb={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},V0={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},Bk={PAINT_ORDER_FILL_AND_STROKE:1},Pm={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},YA={MASK_TYPE_LUMINANCE:1};function Nk(o,e,i){o===1&&e.icons.push(function(l,c){return function(d){if(d.usvg_tree.height||(d.usvg_tree.height=d.usvg_tree.width),!d.metadata)return d;const{metadata:p}=d;if(p.content_area){const{content_area:v}=p;v.top==null&&(v.top=v.left),v.width==null&&(v.width=d.usvg_tree.width),v.height==null&&(v.height=v.width)}return p.stretch_x&&p.stretch_x.length&&KA(p,"x"),p.stretch_y&&p.stretch_y.length&&KA(p,"y"),d}(l.readFields(Vk,{name:void 0},c))}(i,i.readVarint()+i.pos))}function KA(o,e){const i=[],l=o[`stretch_${e}`];let c=null;for(let d=0;d<l.length;d++)c===null?c=i.length===0?l[0]:i[i.length-1][1]+l[d]:(i.push([c,c+l[d]]),c=null);o[`stretch_${e}_areas`]=i}function Vk(o,e,i){o===1?e.name=i.readString():o===2?e.metadata=function(l,c){return l.readFields(Uk,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},c)}(i,i.readVarint()+i.pos):o===3&&(e.usvg_tree=function(l,c){return l.readFields(Gk,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},c)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function Uk(o,e,i){o===1?e.stretch_x=i.readPackedVarint():o===2?e.stretch_y=i.readPackedVarint():o===3?e.content_area=function(l,c){return l.readFields(jk,{left:0},c)}(i,i.readVarint()+i.pos):o===4&&e.variables.push(function(l,c){return l.readFields($k,{name:void 0},c)}(i,i.readVarint()+i.pos))}function jk(o,e,i){o===1?e.left=i.readVarint():o===2?e.width=i.readVarint():o===3?e.top=i.readVarint():o===4&&(e.height=i.readVarint())}function $k(o,e,i){o===1?e.name=i.readString():o===2&&(e.rgb_color=$0(i.readVarint()),e.value="rgb_color")}function Gk(o,e,i){o===1?e.width=e.height=i.readVarint():o===2?e.height=i.readVarint():o===3?e.children.push(U0(i,i.readVarint()+i.pos)):o===4?e.linear_gradients.push(function(l,c){return l.readFields(Kk,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},c)}(i,i.readVarint()+i.pos)):o===5?e.radial_gradients.push(function(l,c){return l.readFields(Qk,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},c)}(i,i.readVarint()+i.pos)):o===7?e.clip_paths.push(function(l,c){return l.readFields(e4,{children:[]},c)}(i,i.readVarint()+i.pos)):o===8&&e.masks.push(function(l,c){const d=l.readFields(t4,{left:0,width:20,mask_type:YA.MASK_TYPE_LUMINANCE,children:[]},c);return d.height==null&&(d.height=d.width),d.top==null&&(d.top=d.left),d}(i,i.readVarint()+i.pos))}function U0(o,e){return o.readFields(qk,{},e)}function qk(o,e,i){o===1?(e.group=function(l,c){return l.readFields(Hk,{opacity:255,children:[]},c)}(i,i.readVarint()+i.pos),e.node="group"):o===2&&(e.path=function(l,c){return l.readFields(Wk,{paint_order:1,commands:[],step:1,diffs:[],rule:gb.PATH_RULE_NON_ZERO},c)}(i,i.readVarint()+i.pos),e.node="path")}function Hk(o,e,i){o===1?e.transform=j0(i,i.readVarint()+i.pos):o===2?e.opacity=i.readVarint():o===5?e.clip_path_idx=i.readVarint():o===6?e.mask_idx=i.readVarint():o===7&&e.children.push(U0(i,i.readVarint()+i.pos))}function j0(o,e){return o.readFields(Zk,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function Zk(o,e,i){o===1?e.sx=i.readFloat():o===2?e.ky=i.readFloat():o===3?e.kx=i.readFloat():o===4?e.sy=i.readFloat():o===5?e.tx=i.readFloat():o===6&&(e.ty=i.readFloat())}function Wk(o,e,i){o===1?e.fill=function(l,c){return l.readFields(Xk,{rgb_color:_b,paint:"rgb_color",opacity:255},c)}(i,i.readVarint()+i.pos):o===2?e.stroke=function(l,c){return l.readFields(Yk,{rgb_color:_b,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},c)}(i,i.readVarint()+i.pos):o===3?e.paint_order=i.readVarint():o===5?i.readPackedVarint(e.commands):o===6?e.step=i.readFloat():o===7?i.readPackedSVarint(e.diffs):o===8&&(e.rule=i.readVarint())}function Xk(o,e,i){o===1?(e.rgb_color=$0(i.readVarint()),e.paint="rgb_color"):o===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):o===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):o===5&&(e.opacity=i.readVarint())}function $0(o){return new Kn((o>>16&255)/255,(o>>8&255)/255,(255&o)/255,1)}function Yk(o,e,i){o===1?(e.rgb_color=$0(i.readVarint()),e.paint="rgb_color"):o===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):o===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):o===5?i.readPackedFloat(e.dasharray):o===6?e.dashoffset=i.readFloat():o===7?e.miterlimit=i.readFloat():o===8?e.opacity=i.readVarint():o===9?e.width=i.readFloat():o===10?e.linecap=i.readVarint():o===11&&(e.linejoin=i.readVarint())}function Kk(o,e,i){o===1?e.transform=j0(i,i.readVarint()+i.pos):o===2?e.spread_method=i.readVarint():o===3?e.stops.push(JA(i,i.readVarint()+i.pos)):o===4?e.x1=i.readFloat():o===5?e.y1=i.readFloat():o===6?e.x2=i.readFloat():o===7&&(e.y2=i.readFloat())}function JA(o,e){return o.readFields(Jk,{offset:0,opacity:255,rgb_color:_b},e)}function Jk(o,e,i){o===1?e.offset=i.readFloat():o===2?e.opacity=i.readVarint():o===3&&(e.rgb_color=$0(i.readVarint()))}function Qk(o,e,i){o===1?e.transform=j0(i,i.readVarint()+i.pos):o===2?e.spread_method=i.readVarint():o===3?e.stops.push(JA(i,i.readVarint()+i.pos)):o===4?e.cx=i.readFloat():o===5?e.cy=i.readFloat():o===6?e.r=i.readFloat():o===7?e.fx=i.readFloat():o===8?e.fy=i.readFloat():o===9&&(e.fr=i.readFloat())}function e4(o,e,i){o===1?e.transform=j0(i,i.readVarint()+i.pos):o===2?e.clip_path_idx=i.readVarint():o===3&&e.children.push(U0(i,i.readVarint()+i.pos))}function t4(o,e,i){o===1?e.left=e.top=i.readFloat():o===2?e.width=e.height=i.readFloat():o===3?e.top=i.readFloat():o===4?e.height=i.readFloat():o===5?e.mask_type=i.readVarint():o===6?e.mask_idx=i.readVarint():o===7&&e.children.push(U0(i,i.readVarint()+i.pos))}class n4{static calculate(e={},i=[]){const l=new Map,c=new Map;if(Object.keys(e).length===0)return l;i.forEach(d=>{c.set(d.name,d.rgb_color||new Kn(0,0,0))});for(const[d,p]of Object.entries(e))c.has(d)?l.set(c.get(d).toStringPremultipliedAlpha(),p):console.warn(`Ignoring unknown image variable "${d}"`);return l}}function Jf(o,e=255,i){const l=e/255,c=o.toStringPremultipliedAlpha(),d=i.has(c)?i.get(c).clone():o.clone();return d.a*=l,d.toString()}function zm(o,e){if(!Yd()){const i=document.createElement("canvas");return i.width=o,i.height=e,i}return new OffscreenCanvas(o,e)}function i4(o,e){const i=n4.calculate(e.params,o.metadata?o.metadata.variables:[]),l=o.usvg_tree,c=l.width,d=l.height,p=e.transform?e.transform:new DOMMatrix,v=Math.max(1,Math.round(c*p.a)),w=Math.max(1,Math.round(d*p.d)),S=new DOMMatrix([v/c,0,0,w/d,0,0]),I=zm(v,w).getContext("2d");return vb(I,S,l,l,i),I.getImageData(0,0,v,w)}function vb(o,e,i,l,c){for(const d of l.children)QA(o,e,i,d,c)}function QA(o,e,i,l,c){l.group?(o.save(),function(d,p,v,w,S){const I=w.mask_idx!=null?v.masks[w.mask_idx]:null,C=w.clip_path_idx!=null?v.clip_paths[w.clip_path_idx]:null;if(w.transform&&(p=G0(w.transform).preMultiplySelf(p)),!function(N,$,X){return N.opacity!==255||$||X}(w,C!=null,I!=null))return void vb(d,p,v,w,S);const R=zm(d.canvas.width,d.canvas.height),B=R.getContext("2d");vb(B,p,v,w,S),C&&sI(B,p,v,C),I&&aI(B,p,v,I,S),d.globalAlpha=w.opacity/255,d.drawImage(R,0,0)}(o,e,i,l.group,c),o.restore()):l.path&&(o.save(),function(d,p,v,w,S){const I=lI(w);d.setTransform(p),w.paint_order===Bk.PAINT_ORDER_FILL_AND_STROKE?(eI(d,v,w,I,S),nI(d,v,w,I,S)):(nI(d,v,w,I,S),eI(d,v,w,I,S))}(o,e,i,l.path,c),o.restore())}function eI(o,e,i,l,c){const d=i.fill;if(!d)return;const p=d.opacity/255;switch(d.paint){case"rgb_color":o.fillStyle=Jf(d.rgb_color,d.opacity,c);break;case"linear_gradient_idx":o.fillStyle=iI(o,e.linear_gradients[d.linear_gradient_idx],p,c);break;case"radial_gradient_idx":o.fillStyle=rI(o,e.radial_gradients[d.radial_gradient_idx],p,c)}o.fill(l,tI(i))}function tI(o){return o.rule===gb.PATH_RULE_NON_ZERO?"nonzero":o.rule===gb.PATH_RULE_EVEN_ODD?"evenodd":void 0}function nI(o,e,i,l,c){const d=i.stroke;if(!d)return;o.lineWidth=d.width,o.miterLimit=d.miterlimit,o.setLineDash(d.dasharray),o.lineDashOffset=d.dashoffset;const p=d.opacity/255;switch(d.paint){case"rgb_color":o.strokeStyle=Jf(d.rgb_color,d.opacity,c);break;case"linear_gradient_idx":o.strokeStyle=iI(o,e.linear_gradients[d.linear_gradient_idx],p,c);break;case"radial_gradient_idx":o.strokeStyle=rI(o,e.radial_gradients[d.radial_gradient_idx],p,c)}switch(d.linejoin){case V0.LINE_JOIN_MITER_CLIP:case V0.LINE_JOIN_MITER:o.lineJoin="miter";break;case V0.LINE_JOIN_ROUND:o.lineJoin="round";break;case V0.LINE_JOIN_BEVEL:o.lineJoin="bevel"}switch(d.linecap){case yb.LINE_CAP_BUTT:o.lineCap="butt";break;case yb.LINE_CAP_ROUND:o.lineCap="round";break;case yb.LINE_CAP_SQUARE:o.lineCap="square"}o.stroke(l)}function iI(o,e,i,l){if(e.stops.length===1){const R=e.stops[0];return Jf(R.rgb_color,R.opacity*i,l)}const c=G0(e.transform),{x1:d,y1:p,x2:v,y2:w}=e,S=c.transformPoint(new DOMPoint(d,p)),I=c.transformPoint(new DOMPoint(v,w)),C=o.createLinearGradient(S.x,S.y,I.x,I.y);for(const R of e.stops)C.addColorStop(R.offset,Jf(R.rgb_color,R.opacity*i,l));return C}function rI(o,e,i,l){if(e.stops.length===1){const R=e.stops[0];return Jf(R.rgb_color,R.opacity*i,l)}const c=G0(e.transform),{fx:d,fy:p,cx:v,cy:w}=e,S=c.transformPoint(new DOMPoint(d,p)),I=c.transformPoint(new DOMPoint(v,w)),C=o.createRadialGradient(S.x,S.y,0,I.x,I.y,e.r*((c.a+c.d)/2));for(const R of e.stops)C.addColorStop(R.offset,Jf(R.rgb_color,R.opacity*i,l));return C}function oI(o,e,i,l){const c=l.transform?G0(l.transform).preMultiplySelf(e):e,d=zm(o.canvas.width,o.canvas.height),p=d.getContext("2d");for(const w of l.children)if(w.group)oI(p,c,i,w.group);else if(w.path){const S=w.path,I=new Path2D;I.addPath(lI(S),c),p.fill(I,tI(S))}const v=l.clip_path_idx!=null?i.clip_paths[l.clip_path_idx]:null;v&&sI(p,c,i,v),o.globalCompositeOperation="source-over",o.drawImage(d,0,0)}function sI(o,e,i,l){const c=zm(o.canvas.width,o.canvas.height);oI(c.getContext("2d"),e,i,l),o.globalCompositeOperation="destination-in",o.drawImage(c,0,0)}function aI(o,e,i,l,c){if(l.children.length===0)return;const d=l.mask_idx!=null?i.masks[l.mask_idx]:null;d&&aI(o,e,i,d,c);const p=o.canvas.width,v=o.canvas.height,w=zm(p,v),S=w.getContext("2d"),I=l.width,C=l.height,R=l.left,B=l.top,N=new Path2D,$=new Path2D;$.rect(R,B,I,C),N.addPath($,e),S.clip(N);for(const le of l.children)QA(S,e,i,le,c);const X=S.getImageData(0,0,p,v),K=X.data;if(l.mask_type===YA.MASK_TYPE_LUMINANCE)for(let le=0;le<K.length;le+=4)K[le+3]=K[le+3]/255*(.2126*K[le]+.7152*K[le+1]+.0722*K[le+2]);S.putImageData(X,0,0),o.globalCompositeOperation="destination-in",o.drawImage(w,0,0)}function G0(o){return o?new DOMMatrix([o.sx,o.ky,o.kx,o.sy,o.tx,o.ty]):new DOMMatrix}function lI(o){const e=new Path2D,i=o.step;let l=o.diffs[0]*i,c=o.diffs[1]*i;e.moveTo(l,c);for(let d=0,p=2;d<o.commands.length;d++)switch(o.commands[d]){case Pm.PATH_COMMAND_MOVE:l+=o.diffs[p++]*i,c+=o.diffs[p++]*i,e.moveTo(l,c);break;case Pm.PATH_COMMAND_LINE:l+=o.diffs[p++]*i,c+=o.diffs[p++]*i,e.lineTo(l,c);break;case Pm.PATH_COMMAND_QUAD:{const v=l+o.diffs[p++]*i,w=c+o.diffs[p++]*i;l=v+o.diffs[p++]*i,c=w+o.diffs[p++]*i,e.quadraticCurveTo(v,w,l,c);break}case Pm.PATH_COMMAND_CUBIC:{const v=l+o.diffs[p++]*i,w=c+o.diffs[p++]*i,S=v+o.diffs[p++]*i,I=w+o.diffs[p++]*i;l=S+o.diffs[p++]*i,c=I+o.diffs[p++]*i,e.bezierCurveTo(v,w,S,I,l,c);break}case Pm.PATH_COMMAND_CLOSE:e.closePath()}return e}class q0{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Ft(q0,"LRUCache");class xb{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Fr(e,e.data)}getFromCache(e,i,l){return this.cacheMap.has(l)||this.cacheMap.set(l,new q0(150)),this.cacheMap.get(l).get(Tl(e.toString(),i))}setInCache(e,i,l,c){this.cacheDependenciesMap.has(c)||this.cacheDependenciesMap.set(c,new Map),this.cacheMap.has(c)||this.cacheMap.set(c,new q0(150));const d=this.cacheDependenciesMap.get(c),p=Tl(e.id.toString(),l);d.get(p)||d.set(p,new Set);const v=this.cacheMap.get(c),w=e.toString();d.get(p).add(w),v.put(Tl(e.toString(),l),i)}removeImagesFromCacheByIds(e,i,l=0){if(!this.cacheMap.has(l)||!this.cacheDependenciesMap.has(l))return;const c=this.cacheMap.get(l),d=this.cacheDependenciesMap.get(l);for(const p of e){const v=Tl(p.toString(),i);if(d.has(v)){for(const w of d.get(v))c.delete(w);d.delete(v)}}}rasterize(e,i,l,c,d=i4){const p=this.getFromCache(e,l,c);if(p)return p.clone();const v=d(i.icon,e.options),w=xb._getImage(v);return this.setInCache(e,w,l,c),w.clone()}}class cI{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const l=this.toIdx(e,i);return{min:this.minimums[l],max:this.maximums[l]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function uI(o,e,i,l){let c=0,d=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(l[p])<1e-15){if(i[p]<o[p]||i[p]>e[p])return null}else{const v=1/l[p];let w=(o[p]-i[p])*v,S=(e[p]-i[p])*v;if(w>S){const I=w;w=S,S=I}if(w>c&&(c=w),S<d&&(d=S),c>d)return null}return c}function hI(o,e,i,l,c,d,p,v,w,S,I){const C=l-o,R=c-e,B=d-i,N=p-o,$=v-e,X=w-i,K=I[1]*X-I[2]*$,le=I[2]*N-I[0]*X,re=I[0]*$-I[1]*N,G=C*K+R*le+B*re;if(Math.abs(G)<1e-15)return null;const ne=1/G,ae=S[0]-o,de=S[1]-e,be=S[2]-i,Ie=(ae*K+de*le+be*re)*ne;if(Ie<0||Ie>1)return null;const Me=de*B-be*R,ke=be*C-ae*B,Ye=ae*R-de*C,ft=(I[0]*Me+I[1]*ke+I[2]*Ye)*ne;return ft<0||Ie+ft>1?null:(N*Me+$*ke+X*Ye)*ne}function fI(o,e,i){return(o-e)/(i-e)}function dI(o,e,i,l,c,d,p,v,w){const S=1<<i,I=d-l,C=p-c,R=(o+1)/S*I+l,B=(e+0)/S*C+c,N=(e+1)/S*C+c;v[0]=(o+0)/S*I+l,v[1]=B,w[0]=R,w[1]=N}class pI{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(d){const p=Math.ceil(Math.log2(d.dim/8)),v=[];let w=Math.ceil(Math.pow(2,p));const S=1/w,I=(B,N,$,X,K)=>{const le=X?1:0,re=(B+1)*$-le,G=N*$,ne=(N+1)*$-le;K[0]=B*$,K[1]=G,K[2]=re,K[3]=ne};let C=new cI(w);const R=[];for(let B=0;B<w*w;B++){I(B%w,Math.floor(B/w),S,!1,R);const N=Nc(R[0],R[1],d),$=Nc(R[2],R[1],d),X=Nc(R[2],R[3],d),K=Nc(R[0],R[3],d);C.minimums.push(Math.min(N,$,X,K)),C.maximums.push(Math.max(N,$,X,K)),C.leaves.push(1)}for(v.push(C),w/=2;w>=1;w/=2){const B=v[v.length-1];C=new cI(w);for(let N=0;N<w*w;N++){I(N%w,Math.floor(N/w),2,!0,R);const $=B.getElevation(R[0],R[1]),X=B.getElevation(R[2],R[1]),K=B.getElevation(R[2],R[3]),le=B.getElevation(R[0],R[3]),re=B.isLeaf(R[0],R[1]),G=B.isLeaf(R[2],R[1]),ne=B.isLeaf(R[2],R[3]),ae=B.isLeaf(R[0],R[3]),de=Math.min($.min,X.min,K.min,le.min),be=Math.max($.max,X.max,K.max,le.max),Ie=re&&G&&ne&&ae;C.maximums.push(be),C.minimums.push(de),C.leaves.push(be-de<=5&&Ie?1:0)}v.push(C)}return v}(this.dem),l=i.length-1,c=i[l];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(i,0,0,l,0)}raycastRoot(e,i,l,c,d,p,v=1){return uI([e,i,-100],[l,c,this.maximums[0]*v],d,p)}raycast(e,i,l,c,d,p,v=1){if(!this.nodeCount)return null;const w=this.raycastRoot(e,i,l,c,d,p,v);if(w==null)return null;const S=[],I=[],C=[],R=[],B=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;B.length>0;){const{idx:N,t:$,nodex:X,nodey:K,depth:le}=B.pop();if(this.leaves[N]){dI(X,K,le,e,i,l,c,C,R);const G=1<<le,ne=(X+0)/G,ae=(X+1)/G,de=(K+0)/G,be=(K+1)/G,Ie=Nc(ne,de,this.dem)*v,Me=Nc(ae,de,this.dem)*v,ke=Nc(ae,be,this.dem)*v,Ye=Nc(ne,be,this.dem)*v,ft=hI(C[0],C[1],Ie,R[0],C[1],Me,R[0],R[1],ke,d,p),at=hI(R[0],R[1],ke,C[0],R[1],Ye,C[0],C[1],Ie,d,p),ht=Math.min(ft!==null?ft:Number.MAX_VALUE,at!==null?at:Number.MAX_VALUE);if(ht!==Number.MAX_VALUE)return ht;{const _t=rn([],d,p,$);if(mI(Ie,Me,Ye,ke,fI(_t[0],C[0],R[0]),fI(_t[1],C[1],R[1]))>=_t[2])return $}continue}let re=0;for(let G=0;G<this._siblingOffset.length;G++){dI((X<<1)+this._siblingOffset[G][0],(K<<1)+this._siblingOffset[G][1],le+1,e,i,l,c,C,R),C[2]=-100,R[2]=this.maximums[this.childOffsets[N]+G]*v;const ne=uI(C,R,d,p);if(ne!=null){const ae=ne;S[G]=ae;let de=!1;for(let be=0;be<re&&!de;be++)ae>=S[I[be]]&&(I.splice(be,0,G),de=!0);de||(I[re]=G),re++}}for(let G=0;G<re;G++){const ne=I[G];B.push({idx:this.childOffsets[N]+ne,t:S[ne],nodex:(X<<1)+this._siblingOffset[ne][0],nodey:(K<<1)+this._siblingOffset[ne][1],depth:le+1})}}return null}_addNode(e,i,l){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(l),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,l,c,d){if(e[c].isLeaf(i,l)===1)return;this.childOffsets[d]||(this.childOffsets[d]=this.nodeCount);const p=c-1,v=e[p];let w=0,S=0;for(let I=0;I<this._siblingOffset.length;I++){const C=2*i+this._siblingOffset[I][0],R=2*l+this._siblingOffset[I][1],B=v.getElevation(C,R),N=v.isLeaf(C,R),$=this._addNode(B.min,B.max,N);N&&(w|=1<<I),S||(S=$)}for(let I=0;I<this._siblingOffset.length;I++)w&1<<I||this._construct(e,2*i+this._siblingOffset[I][0],2*l+this._siblingOffset[I][1],p,S+I)}}function mI(o,e,i,l,c,d){return Jt(Jt(o,i,d),Jt(e,l,d),c)}function Nc(o,e,i){const l=i.dim,c=ze(o*l-.5,0,l-1),d=ze(e*l-.5,0,l-1),p=Math.floor(c),v=Math.floor(d),w=Math.min(p+1,l-1),S=Math.min(v+1,l-1);return mI(i.get(p,v),i.get(w,v),i.get(p,S),i.get(w,S),c-p,d-v)}const r4={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function o4(o,e,i){return(256*o*256+256*e+i)/10-1e4}function s4(o,e,i){return 256*o+e+i/256-32768}class H0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,l,c=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(l&&l!=="mapbox"&&l!=="terrarium")return void Dn(`"${l}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const d=this.dim=i.height-2,p=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let w=0;w<d;w++)p[this._idx(-1,w)]=p[this._idx(0,w)],p[this._idx(d,w)]=p[this._idx(d-1,w)],p[this._idx(w,-1)]=p[this._idx(w,0)],p[this._idx(w,d)]=p[this._idx(w,d-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(d,-1)]=p[this._idx(d-1,0)],p[this._idx(-1,d)]=p[this._idx(0,d-1)],p[this._idx(d,d)]=p[this._idx(d-1,d-1)]}const v=l==="terrarium"?s4:o4;for(let w=0;w<p.length;++w){const S=4*w;this.floatView[w]=v(this.pixels[S],this.pixels[S+1],this.pixels[S+2])}this._timestamp=rs.now()}_buildQuadTree(){this._tree=new pI(this)}get(e,i,l=!1){l&&(e=ze(e,-1,this.dim),i=ze(i,-1,this.dim));const c=this._idx(e,i);return this.floatView[c]}set(e,i,l){const c=this._idx(e,i),d=this.floatView[c];return this.floatView[c]=l,l-d}static getUnpackVector(e){return r4[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const l=[0,0,0,0],c=H0.getUnpackVector(i);let d=Math.floor((e+c[3])/c[2]);return l[2]=d%256,d=Math.floor(d/256),l[1]=d%256,d=Math.floor(d/256),l[0]=d,l}getPixels(){return new gS({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,l){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let c=i*this.dim,d=i*this.dim+this.dim,p=l*this.dim,v=l*this.dim+this.dim;switch(i){case-1:c=d-1;break;case 1:d=c+1}switch(l){case-1:p=v-1;break;case 1:v=p+1}const w=-i*this.dim,S=-l*this.dim;for(let I=p;I<v;I++)for(let C=c;C<d;C++){const R=4*this._idx(C,I),B=4*this._idx(C+w,I+S);this.pixels[R+0]=e.pixels[B+0],this.pixels[R+1]=e.pixels[B+1],this.pixels[R+2]=e.pixels[B+2],this.pixels[R+3]=e.pixels[B+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function a4(o,e,i){o===1?e.headerLength=i.readFixed32():o===2?e.x=i.readVarint():o===3?e.y=i.readVarint():o===4?e.z=i.readVarint():o===5&&e.layers.push(function(l,c){return l.readFields(f4,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},c)}(i,i.readVarint()+i.pos))}function l4(o,e,i){o===1?(e.delta_filter=function(l,c){return l.readFields(c4,{blockSize:0},c)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):o===2?(i.readVarint(),e.filter="zigzag_filter"):o===3?(i.readVarint(),e.filter="bitshuffle_filter"):o===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function c4(o,e,i){o===1&&(e.blockSize=i.readVarint())}function u4(o,e,i){o===1?(i.readVarint(),e.codec="gzip_data"):o===2?(i.readVarint(),e.codec="jpeg_image"):o===3?(i.readVarint(),e.codec="webp_image"):o===4&&(i.readVarint(),e.codec="png_image")}function h4(o,e,i){let l=0,c=0;o===1?e.firstByte=i.readFixed64():o===2?e.lastByte=i.readFixed64():o===3?e.filters.push(function(d,p){return d.readFields(l4,{},p)}(i,i.readVarint()+i.pos)):o===4?e.codec=function(d,p){return d.readFields(u4,{},p)}(i,i.readVarint()+i.pos):o===5?c=i.readFloat():o===6?l=i.readFloat():o===7?e.bands.push(i.readString()):o===8?e.offset=i.readDouble():o===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=c),e.scale===0&&(e.scale=l)}function f4(o,e,i){o===1?e.version=i.readVarint():o===2?e.name=i.readString():o===3?e.units=i.readString():o===4?e.tileSize=i.readVarint():o===5?e.buffer=i.readVarint():o===6?e.pixelFormat=i.readVarint():o===7&&e.dataIndex.push(function(l,c){return l.readFields(h4,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},c)}(i,i.readVarint()+i.pos))}function d4(o,e,i){if(o===2)(function(l,c,d){l.readFields(p4,d,c)})(i,i.readVarint()+i.pos,e);else if(o===3)throw new Error("Not implemented")}function p4(o,e,i){if(o===1){let l=0;const c=i.readVarint()+i.pos;for(;i.pos<c;)e[l++]=i.readVarint()}}function m4(o,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let l=2;l>=1;l--){const c=l===1?1:0,d=l===2?1:0;for(let p=0;p<e[0];p++){const v=e[1]*p;for(let w=c;w<e[1];w++){const S=e[2]*(w+v);for(let I=d;I<e[2];I++){const C=e[3]*(I+S);for(let R=0;R<e[3];R++){const B=C+R;o[B]+=o[B-i]}}}}i*=e[l]}return o}function _4(o){for(let e=0,i=o.length;e<i;e++)o[e]=o[e]>>>1^-(1&o[e]);return o}function g4(o,e){switch(e){case"uint32":return o;case"uint16":for(let i=0;i<o.length;i+=2){const l=o[i],c=o[i+1];o[i]=(240&l)>>4|(61440&l)>>8|(240&c)<<4|61440&c,o[i+1]=15&l|(3840&l)>>4|(15&c)<<8|(3840&c)<<4}return o;case"uint8":for(let i=0;i<o.length;i+=4){const l=o[i],c=o[i+1],d=o[i+2],p=o[i+3];o[i+0]=(192&l)>>6|(192&c)>>4|(192&d)>>2|192&p,o[i+1]=(48&l)>>4|(48&c)>>2|48&d|(48&p)<<2,o[i+2]=(12&l)>>2|12&c|(12&d)<<2|(12&p)<<4,o[i+3]=3&l|(3&c)<<2|(3&d)<<4|(3&p)<<6}return o;default:throw new Error(`Invalid pixel format, "${e}"`)}}Ft(H0,"DEMData"),Ft(pI,"DemMinMaxQuadTree",{omit:["dem"]});var ms=Uint8Array,Rm=Uint16Array,y4=Int32Array,_I=new ms([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),gI=new ms([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),v4=new ms([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yI=function(o,e){for(var i=new Rm(31),l=0;l<31;++l)i[l]=e+=1<<o[l-1];var c=new y4(i[30]);for(l=1;l<30;++l)for(var d=i[l];d<i[l+1];++d)c[d]=d-i[l]<<5|l;return{b:i,r:c}},vI=yI(_I,2),xI=vI.b,x4=vI.r;xI[28]=258,x4[258]=28;for(var b4=yI(gI,0).b,bI=new Rm(32768),mr=0;mr<32768;++mr){var Qf=(43690&mr)>>1|(21845&mr)<<1;bI[mr]=((65280&(Qf=(61680&(Qf=(52428&Qf)>>2|(13107&Qf)<<2))>>4|(3855&Qf)<<4))>>8|(255&Qf)<<8)>>1}var Dm=function(o,e,i){for(var l=o.length,c=0,d=new Rm(e);c<l;++c)o[c]&&++d[o[c]-1];var p,v=new Rm(e);for(c=1;c<e;++c)v[c]=v[c-1]+d[c-1]<<1;p=new Rm(1<<e);var w=15-e;for(c=0;c<l;++c)if(o[c])for(var S=c<<4|o[c],I=e-o[c],C=v[o[c]-1]++<<I,R=C|(1<<I)-1;C<=R;++C)p[bI[C]>>w]=S;return p},Lm=new ms(288);for(mr=0;mr<144;++mr)Lm[mr]=8;for(mr=144;mr<256;++mr)Lm[mr]=9;for(mr=256;mr<280;++mr)Lm[mr]=7;for(mr=280;mr<288;++mr)Lm[mr]=8;var wI=new ms(32);for(mr=0;mr<32;++mr)wI[mr]=5;var w4=Dm(Lm,9),T4=Dm(wI,5),bb=function(o){for(var e=o[0],i=1;i<o.length;++i)o[i]>e&&(e=o[i]);return e},na=function(o,e,i){var l=e/8|0;return(o[l]|o[l+1]<<8)>>(7&e)&i},wb=function(o,e){var i=e/8|0;return(o[i]|o[i+1]<<8|o[i+2]<<16)>>(7&e)},S4=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ia=function(o,e,i){var l=new Error(e||S4[o]);if(l.code=o,Error.captureStackTrace&&Error.captureStackTrace(l,ia),!i)throw l;return l},E4=new ms(0),A4=typeof TextDecoder<"u"&&new TextDecoder;try{A4.decode(E4,{stream:!0})}catch{}const I4={gzip_data:"gzip"};class zs extends Error{constructor(e){super(e),this.name="MRTError"}}const M4={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},TI={uint32:1,uint16:2,uint8:4},C4={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Tb;class Z0{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new zs(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),l=new DataView(e);if(i[0]!==13)throw new zs("File is not a valid MRT.");return l.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),l=this.getHeaderLength(e);if(i.length<l)throw new zs(`Expected header with length >= ${l} but got buffer of length ${i.length}`);const c=function(d,p){return d.readFields(a4,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new Tb(i.subarray(0,l)));if(!isNaN(this.x)&&(this.x!==c.x||this.y!==c.y||this.z!==c.z))throw new zs(`Invalid attempt to parse header ${c.z}/${c.x}/${c.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=c.x,this.y=c.y,this.z=c.z;for(const d of c.layers)this.layers[d.name]=new SI(d,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],l=this.getLayer(e.layerName);for(let c of e.blockIndices){const d=l.dataIndex[c],p=d.firstByte-e.firstByte,v=d.lastByte-e.firstByte;if(l._blocksInProgress.has(c))continue;const w={layerName:l.name,firstByte:p,lastByte:v,pixelFormat:l.pixelFormat,blockIndex:c,blockShape:[d.bands.length].concat(l.bandShape),buffer:l.buffer,codec:d.codec.codec,filters:d.filters.map(S=>S.filter)};l._blocksInProgress.add(c),i.push(w)}return new EI(i,()=>{i.forEach(c=>l._blocksInProgress.delete(c.blockIndex))},(c,d)=>{if(i.forEach(p=>l._blocksInProgress.delete(p.blockIndex)),c)throw c;d.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class SI{constructor({version:e,name:i,units:l,tileSize:c,pixelFormat:d,buffer:p,dataIndex:v},w){if(this.version=e,this.version!==1)throw new zs(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=l,this.tileSize=c,this.buffer=p,this.pixelFormat=M4[d],this.dataIndex=v,this.bandShape=[c+2*p,c+2*p,TI[this.pixelFormat]],this._decodedBlocks=new q0(w?w.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return TI[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[l,c]of this.dataIndex.entries()){for(const[d,p]of c.bands.entries())if(p===e)return{bandIndex:i+d,blockIndex:l,blockBandIndex:d};i+=c.bands.length}break;case"number":for(const[l,c]of this.dataIndex.entries()){if(e>=i&&e<i+c.bands.length)return{bandIndex:e,blockIndex:l,blockBandIndex:e-i};i+=c.bands.length}break;default:throw new zs(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,l=-1/0;const c=[],d=new Set;for(const p of e){const{blockIndex:v}=this.getBlockForBand(p);if(v<0)throw new zs(`Invalid band: ${JSON.stringify(p)}`);const w=this.dataIndex[v];c.includes(v)||c.push(v),d.add(v),i=Math.min(i,w.firstByte),l=Math.max(l,w.lastByte)}if(d.size>this.cacheSize)throw new zs(`Number of blocks to decode (${d.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:l,blockIndices:c}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:l}=this.getBlockForBand(e);if(i<0)throw new zs(`Band not found: ${JSON.stringify(e)}`);const c=this._decodedBlocks.get(i.toString());if(!c)throw new zs(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const d=this.dataIndex[i],p=this.bandShape.reduce((S,I)=>S*I,1),v=l*p,w=c.subarray(v,v+p);return{data:w,bytes:new Uint8Array(w.buffer).subarray(w.byteOffset,w.byteOffset+w.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:d.offset,scale:d.scale}}}Z0.setPbf=function(o){Tb=o};class EI{constructor(e,i,l){this.tasks=e,this._onCancel=i,this._onComplete=l,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}Z0.performDecoding=function(o,e){const i=new Uint8Array(o);return Promise.all(e.tasks.map(l=>{const{layerName:c,firstByte:d,lastByte:p,pixelFormat:v,blockShape:w,blockIndex:S,filters:I,codec:C}=l,R=i.subarray(d,p+1),B=new Uint32Array(w[0]*w[1]*w[2]);let N;if(C!=="gzip_data")throw new zs(`Unhandled codec: ${C}`);return N=function($,X){if(!globalThis.DecompressionStream&&X==="gzip_data")return Promise.resolve(((G=function(de){de[0]==31&&de[1]==139&&de[2]==8||ia(6,"invalid gzip data");var be=de[3],Ie=10;4&be&&(Ie+=2+(de[10]|de[11]<<8));for(var Me=(be>>3&1)+(be>>4&1);Me>0;Me-=!de[Ie++]);return Ie+(2&be)}(re=$))+8>re.length&&ia(6,"invalid gzip data"),function(de,be,Ie,Me){var ke=de.length;if(!ke||be.f&&!be.l)return Ie||new ms(0);var Ye=!Ie,ft=Ye||be.i!=2,at=be.i;Ye&&(Ie=new ms(3*ke));var ht,_t,We=function(Ki){var Mi=Ie.length;if(Ki>Mi){var vi=new ms(Math.max(2*Mi,Ki));vi.set(Ie),Ie=vi}},ct=be.f||0,Ge=be.p||0,Xe=be.b||0,yt=be.l,vt=be.d,Wt=be.m,Nt=be.n,Mt=8*ke;do{if(!yt){ct=na(de,Ge,1);var gt=na(de,Ge+1,3);if(Ge+=3,!gt){var ln=de[(he=4+((Ge+7)/8|0))-4]|de[he-3]<<8,$t=he+ln;if($t>ke){at&&ia(0);break}ft&&We(Xe+ln),Ie.set(de.subarray(he,$t),Xe),be.b=Xe+=ln,be.p=Ge=8*$t,be.f=ct;continue}if(gt==1)yt=w4,vt=T4,Wt=9,Nt=5;else if(gt==2){var Gt=na(de,Ge,31)+257,on=na(de,Ge+10,15)+4,mn=Gt+na(de,Ge+5,31)+1;Ge+=14;for(var gn=new ms(mn),Cn=new ms(19),Sn=0;Sn<on;++Sn)Cn[v4[Sn]]=na(de,Ge+3*Sn,7);Ge+=3*on;var bn=bb(Cn),hi=(1<<bn)-1,Ei=Dm(Cn,bn);for(Sn=0;Sn<mn;){var he,pe=Ei[na(de,Ge,hi)];if(Ge+=15&pe,(he=pe>>4)<16)gn[Sn++]=he;else{var Je=0,Tt=0;for(he==16?(Tt=3+na(de,Ge,3),Ge+=2,Je=gn[Sn-1]):he==17?(Tt=3+na(de,Ge,7),Ge+=3):he==18&&(Tt=11+na(de,Ge,127),Ge+=7);Tt--;)gn[Sn++]=Je}}var zt=gn.subarray(0,Gt),Pt=gn.subarray(Gt);Wt=bb(zt),Nt=bb(Pt),yt=Dm(zt,Wt),vt=Dm(Pt,Nt)}else ia(1);if(Ge>Mt){at&&ia(0);break}}ft&&We(Xe+131072);for(var qt=(1<<Wt)-1,nn=(1<<Nt)-1,kn=Ge;;kn=Ge){var On=(Je=yt[wb(de,Ge)&qt])>>4;if((Ge+=15&Je)>Mt){at&&ia(0);break}if(Je||ia(2),On<256)Ie[Xe++]=On;else{if(On==256){kn=Ge,yt=null;break}var wn=On-254;On>264&&(wn=na(de,Ge,(1<<(Fn=_I[Sn=On-257]))-1)+xI[Sn],Ge+=Fn);var ri=vt[wb(de,Ge)&nn],yi=ri>>4;if(ri||ia(3),Ge+=15&ri,Pt=b4[yi],yi>3){var Fn=gI[yi];Pt+=wb(de,Ge)&(1<<Fn)-1,Ge+=Fn}if(Ge>Mt){at&&ia(0);break}ft&&We(Xe+131072);var ji=Xe+wn;if(Xe<Pt){var Ai=0-Pt,ei=Math.min(Pt,ji);for(Ai+Xe<0&&ia(3);Xe<ei;++Xe)Ie[Xe]=(void 0)[Ai+Xe]}for(;Xe<ji;++Xe)Ie[Xe]=Ie[Xe-Pt]}}be.l=yt,be.p=kn,be.b=Xe,be.f=ct,yt&&(ct=1,be.m=Wt,be.d=vt,be.n=Nt)}while(!ct);return Xe!=Ie.length&&Ye?(ht=Ie,((_t=Xe)==null||_t>ht.length)&&(_t=ht.length),new ms(ht.subarray(0,_t))):Ie.subarray(0,Xe)}(re.subarray(G,-8),{i:2},new ms(((K=re)[(le=K.length)-4]|K[le-3]<<8|K[le-2]<<16|K[le-1]<<24)>>>0))));var K,le,re,G;const ne=I4[X];if(!ne)throw new Error(`Unhandled codec: ${X}`);const ae=new globalThis.DecompressionStream(ne);return new Response(new Blob([$]).stream().pipeThrough(ae)).arrayBuffer().then(de=>new Uint8Array(de))}(R,C).then($=>(function(X,K){X.readFields(d4,K)}(new Tb($),B),new C4[v](B.buffer))),N.then($=>{for(let X=I.length-1;X>=0;X--)switch(I[X]){case"delta_filter":m4($,w);break;case"zigzag_filter":_4($);break;case"bitshuffle_filter":g4($,v);break;default:throw new zs(`Unhandled filter "${I[X]}"`)}return{layerName:c,blockIndex:S,data:$}}).catch($=>{throw $})}))},Ft(EI,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Ft(Z0,"MapboxRasterTile"),Ft(SI,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let km,Sb,ra,ed,Eb,td=null;function AI(){return Ti(self)&&self.worker.dracoUrl?self.worker.dracoUrl:Sb||Or.DRACO_URL}function II(){if(Ti(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(ed)return ed;const o=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return ed=WebAssembly.validate(o)?Or.MESHOPT_SIMD_URL:Or.MESHOPT_URL,ed}const W0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},P4={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Om={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function MI(o,e,i){const l=i.json.bufferViews.length,c=i.buffers.length;e.bufferView=l,i.json.bufferViews[l]={buffer:c,byteLength:o.byteLength},i.buffers[c]=o}const Ab="KHR_draco_mesh_compression";function z4(o,e){const i=o.extensions&&o.extensions[Ab];if(!i)return;const l=new ra.Decoder,c=RI(e,i.bufferView),d=new ra.Mesh;if(!l.DecodeArrayToMesh(c,c.byteLength,d))throw new Error("Failed to decode Draco mesh");const p=e.json.accessors[o.indices],v=W0[p.componentType],w=p.count*v.BYTES_PER_ELEMENT,S=ra._malloc(w);v===Uint16Array?l.GetTrianglesUInt16Array(d,w,S):l.GetTrianglesUInt32Array(d,w,S),MI(ra.memory.buffer.slice(S,S+w),p,e),ra._free(S);for(const I of Object.keys(i.attributes)){const C=l.GetAttributeByUniqueId(d,i.attributes[I]),R=e.json.accessors[o.attributes[I]],B=P4[R.componentType],N=R.count*Om[R.type]*W0[R.componentType].BYTES_PER_ELEMENT,$=ra._malloc(N);l.GetAttributeDataArrayForAllPoints(d,C,ra[B],N,$),MI(ra.memory.buffer.slice($,$+N),R,e),ra._free($)}l.destroy(),d.destroy(),delete o.extensions[Ab]}const X0="EXT_meshopt_compression";function R4(o,e){if(!o.extensions||!o.extensions[X0])return;const i=o.extensions[X0],l=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),c=new Uint8Array(i.count*i.byteStride);Eb.decodeGltfBuffer(c,i.count,i.byteStride,l,i.mode,i.filter),o.buffer=e.buffers.length,o.byteOffset=0,e.buffers[o.buffer]=c.buffer,delete o.extensions[X0]}const CI=1179937895,PI=new TextDecoder("utf8");function zI(o,e){return new URL(o,e).href}function D4(o,e,i,l){return fetch(zI(o.uri,l)).then(c=>c.arrayBuffer()).then(c=>{e.buffers[i]=c})}function RI(o,e){const i=o.json.bufferViews[e];return new Uint8Array(o.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function L4(o,e,i,l){if(o.uri){const c=zI(o.uri,l);return fetch(c).then(d=>d.blob()).then(d=>createImageBitmap(d)).then(d=>{e.images[i]=d})}if(o.bufferView!==void 0){const c=RI(e,o.bufferView),d=new Blob([c],{type:o.mimeType});return createImageBitmap(d).then(p=>{e.images[i]=p})}}function DI(o,e=0,i){const l={json:null,images:[],buffers:[]};if(new Uint32Array(o,e,1)[0]===CI){const I=new Uint32Array(o,e);let C=2;const R=(I[C++]>>2)-3,B=I[C++]>>2;if(C++,l.json=JSON.parse(PI.decode(I.subarray(C,C+B))),C+=B,C<R){const N=I[C++];C++;const $=e+(C<<2);l.buffers[0]=o.slice($,$+N)}}else l.json=JSON.parse(PI.decode(new Uint8Array(o,e)));const{buffers:c,images:d,meshes:p,extensionsUsed:v,bufferViews:w}=l.json;let S=Promise.resolve();if(c){const I=[];for(let C=0;C<c.length;C++){const R=c[C];R.uri?I.push(D4(R,l,C,i)):l.buffers[C]||(l.buffers[C]=null)}S=Promise.all(I)}return S.then(()=>{const I=[],C=v&&v.includes(Ab),R=v&&v.includes(X0);if(C&&I.push(function(){if(!ra)return km??(km=function(B){let N,$=null;function X(){N=new Uint8Array($.buffer)}function K(){throw new Error("Unexpected Draco error.")}const le={a:{a:K,d:function(re,G,ne){return N.copyWithin(re,G,G+ne)},c:function(re){const G=N.length,ne=Math.max(re>>>0,Math.ceil(1.2*G)),ae=Math.ceil((ne-G)/65536);try{return $.grow(ae),X(),!0}catch{return!1}},b:K}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(B,le):B.then(re=>re.arrayBuffer()).then(re=>WebAssembly.instantiate(re,le))).then(re=>{const{Rb:G,Qb:ne,P:ae,T:de,X:be,Ja:Ie,La:Me,Qa:ke,Va:Ye,Wa:ft,eb:at,jb:ht,f:_t,e:We,yb:ct,zb:Ge,Ab:Xe,Bb:yt,Db:vt,Gb:Wt}=re.instance.exports;$=We;const Nt=(()=>{let Mt=0,gt=0,ln=0,$t=0;return Gt=>{ln&&(G($t),G(Mt),gt+=ln,ln=Mt=0),Mt||(gt+=128,Mt=ne(gt));const on=Gt.length+7&-8;let mn=Mt;on>=gt&&(ln=on,mn=$t=ne(on));for(let gn=0;gn<Gt.length;gn++)N[mn+gn]=Gt[gn];return mn}})();return X(),_t(),{memory:We,_free:G,_malloc:ne,Mesh:class{constructor(){this.ptr=ae()}destroy(){de(this.ptr)}},Decoder:class{constructor(){this.ptr=Ie()}destroy(){ht(this.ptr)}DecodeArrayToMesh(Mt,gt,ln){const $t=Nt(Mt),Gt=Me(this.ptr,$t,gt,ln.ptr);return!!be(Gt)}GetAttributeByUniqueId(Mt,gt){return{ptr:ke(this.ptr,Mt.ptr,gt)}}GetTrianglesUInt16Array(Mt,gt,ln){Ye(this.ptr,Mt.ptr,gt,ln)}GetTrianglesUInt32Array(Mt,gt,ln){ft(this.ptr,Mt.ptr,gt,ln)}GetAttributeDataArrayForAllPoints(Mt,gt,ln,$t,Gt){at(this.ptr,Mt.ptr,gt.ptr,ln,$t,Gt)}},DT_INT8:ct(),DT_UINT8:Ge(),DT_INT16:Xe(),DT_UINT16:yt(),DT_UINT32:vt(),DT_FLOAT32:Wt()}})}(fetch(AI())),km.then(B=>{ra=B,km=void 0}))}()),R&&I.push(function(){if(Eb)return;const B=function(N){let $;const X=WebAssembly.instantiateStreaming(N,{}).then(re=>{$=re.instance,$.exports.__wasm_call_ctors()}),K={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},le={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:X,supported:!0,decodeGltfBuffer(re,G,ne,ae,de,be){(function(Ie,Me,ke,Ye,ft,at,ht){const _t=Ie.exports.sbrk,We=Ye+3&-4,ct=_t(We*ft),Ge=_t(at.length),Xe=new Uint8Array(Ie.exports.memory.buffer);Xe.set(at,Ge);const yt=Me(ct,Ye,ft,Ge,at.length);if(yt===0&&ht&&ht(ct,We,ft),ke.set(Xe.subarray(ct,ct+Ye*ft)),_t(ct-_t(0)),yt!==0)throw new Error(`Malformed buffer data: ${yt}`)})($,$.exports[le[de]],re,G,ne,ae,$.exports[K[be]])}}}(fetch(II()));return B.ready.then(()=>{Eb=B})}()),d)for(let B=0;B<d.length;B++)I.push(L4(d[B],l,B,i));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(C&&p)for(const{primitives:B}of p)for(const N of B)z4(N,l);if(R&&p&&w)for(const B of w)R4(B,l);return l})})}function lh(o,e){const i=o.json.bufferViews[e.bufferView],l=W0[e.componentType];return new l(o.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Om[e.type]*l.BYTES_PER_ELEMENT?i.byteStride/l.BYTES_PER_ELEMENT:Om[e.type]))}function Ib(o,e,i,l){const c=W0[e.componentType],d=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),p=o.json.bufferViews[e.bufferView],v=p.byteStride?p.byteStride/c.BYTES_PER_ELEMENT:Om[e.type],w=i.float32,S=w.length/i.capacity;for(let I=0,C=0;I<e.count*v;I+=v,C+=S)for(let R=0;R<S;R++)w[C+R]=l[I+R]*d;i._trim()}function k4(o,e,i){const l=o.indices,c=o.attributes,d={};d.indexArray=new wr;const p=e.json.accessors[l],v=p.count/3;d.indexArray.reserve(v);const w=lh(e,p);for(let R=0;R<v;R++)d.indexArray.emplaceBack(w[3*R],w[3*R+1],w[3*R+2]);d.indexArray._trim(),d.vertexArray=new As;const S=e.json.accessors[c.POSITION];d.vertexArray.reserve(S.count);const I=lh(e,S);for(let R=0;R<S.count;R++)d.vertexArray.emplaceBack(I[3*R],I[3*R+1],I[3*R+2]);if(d.vertexArray._trim(),d.aabb=new Ri(S.min,S.max),d.centroid=function(R,B){const N=[0,0,0],$=R.length;if($>0){for(let X=0;X<$;X++){const K=3*R[X];N[0]+=B[K],N[1]+=B[K+1],N[2]+=B[K+2]}N[0]/=$,N[1]/=$,N[2]/=$}return N}(w,I),c.COLOR_0!==void 0){const R=e.json.accessors[c.COLOR_0],B=Om[R.type],N=lh(e,R);d.colorArray=B===3?new As:new Is,d.colorArray.resize(R.count),Ib(e,R,d.colorArray,N)}if(c.NORMAL!==void 0){d.normalArray=new As;const R=e.json.accessors[c.NORMAL];d.normalArray.resize(R.count);const B=lh(e,R);Ib(e,R,d.normalArray,B)}if(c.TEXCOORD_0!==void 0&&i.length>0){d.texcoordArray=new Al;const R=e.json.accessors[c.TEXCOORD_0];d.texcoordArray.resize(R.count);const B=lh(e,R);Ib(e,R,d.texcoordArray,B)}if(c._FEATURE_ID_RGBA4444!==void 0){const R=e.json.accessors[c._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(d.featureData=lh(e,R))}c._FEATURE_RGBA4444!==void 0&&(d.featureData=new Uint32Array(lh(e,e.json.accessors[c._FEATURE_RGBA4444]).buffer));const C=o.material;return d.material=function(R,B){const{emissiveFactor:N=[0,0,0],alphaMode:$="OPAQUE",alphaCutoff:X=.5,normalTexture:K,occlusionTexture:le,emissiveTexture:re,doubleSided:G}=R,{baseColorFactor:ne=[1,1,1,1],metallicFactor:ae=1,roughnessFactor:de=1,baseColorTexture:be,metallicRoughnessTexture:Ie}=R.pbrMetallicRoughness||{},Me=le?B[le.index]:void 0;if(le&&le.extensions&&le.extensions.KHR_texture_transform&&Me){const ke=le.extensions.KHR_texture_transform;Me.offsetScale=[ke.offset[0],ke.offset[1],ke.scale[0],ke.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Kn(...ne),metallicFactor:ae,roughnessFactor:de,baseColorTexture:be?B[be.index]:void 0,metallicRoughnessTexture:Ie?B[Ie.index]:void 0},doubleSided:G,emissiveFactor:N,alphaMode:$,alphaCutoff:X,normalTexture:K?B[K.index]:void 0,occlusionTexture:Me,emissionTexture:re?B[re.index]:void 0,defined:R.defined===void 0}}(C!==void 0?e.json.materials[C]:{defined:!1},i),d}function LI(o,e,i){const{matrix:l,rotation:c,translation:d,scale:p,mesh:v,extras:w,children:S}=o,I={};if(I.matrix=l||function(C,R,B,N){var $=R[0],X=R[1],K=R[2],le=R[3],re=$+$,G=X+X,ne=K+K,ae=$*re,de=$*G,be=$*ne,Ie=X*G,Me=X*ne,ke=K*ne,Ye=le*re,ft=le*G,at=le*ne,ht=N[0],_t=N[1],We=N[2];return C[0]=(1-(Ie+ke))*ht,C[1]=(de+at)*ht,C[2]=(be-ft)*ht,C[3]=0,C[4]=(de-at)*_t,C[5]=(1-(ae+ke))*_t,C[6]=(Me+Ye)*_t,C[7]=0,C[8]=(be+ft)*We,C[9]=(Me-Ye)*We,C[10]=(1-(ae+Ie))*We,C[11]=0,C[12]=B[0],C[13]=B[1],C[14]=B[2],C[15]=1,C}([],c||[0,0,0,1],d||[0,0,0],p||[1,1,1]),v!==void 0){I.meshes=i[v];const C=I.anchor=[0,0];for(const R of I.meshes){const{min:B,max:N}=R.aabb;C[0]+=B[0]+N[0],C[1]+=B[1]+N[1]}C[0]=Math.floor(C[0]/I.meshes.length/2),C[1]=Math.floor(C[1]/I.meshes.length/2)}if(w&&(w.id&&(I.id=w.id),w.lights&&(I.lights=function(C){if(!C.length)return[];const R=function(K){const le=atob(K),re=new Uint8Array(le.length);for(let G=0;G<le.length;G++)re[G]=le.codePointAt(G);return re}(C),B=[],N=R.length/24,$=new Uint16Array(R.buffer),X=new Float32Array(R.buffer);for(let K=0;K<N;K++){const le=$[2*K*6]/30,re=$[2*K*6+1]/30,G=$[2*K*6+10]/100,ne=X[6*K+1],ae=X[6*K+2],de=X[6*K+3],be=X[6*K+4],Ie=de-ne,Me=be-ae,ke=Math.hypot(Ie,Me);B.push({pos:[ne+.5*Ie,ae+.5*Me,re],normal:[Me/ke,-Ie/ke,0],width:ke,height:le,depth:G,points:[ne,ae,de,be]})}return B}(w.lights))),S){const C=[];for(const R of S)C.push(LI(e.json.nodes[R],e,i));I.children=C}return I}function O4(o){if(o.vertices.length===0||o.indices.length===0)return null;const e=new z1(o.vertices,o.indices,8,256),[i,l]=[e.min.clone(),e.max.clone()];return{vertices:o.vertices,indices:o.indices,grid:e,min:i,max:l}}function F4(o){if(!o.extras||!o.extras.ground)return null;const e=o.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const l=[];for(const p of i){if(!Array.isArray(p)||p.length!==2)continue;const v=p[0],w=p[1];typeof v=="number"&&typeof w=="number"&&l.push(new St(v,w))}if(l.length<3)return null;l.length>1&&l[l.length-1].equals(l[0])&&l.pop();let c=0;for(let p=0;p<l.length;p++){const v=l[p],w=l[(p+1)%l.length],S=l[(p+2)%l.length];c+=(v.x-w.x)*(S.y-w.y)-(S.x-w.x)*(v.y-w.y)}c>0&&l.reverse();const d=sm(l.flatMap(p=>[p.x,p.y]),[]);return d.length===0?null:{vertices:l,indices:d}}function B4(o,e){const i=[],l=[];let c=0;const d=[];for(const p of o){c=i.length;const v=p.vertexArray.float32,w=p.indexArray.uint16;for(let S=0;S<p.vertexArray.length;S++)d[0]=v[3*S+0],d[1]=v[3*S+1],d[2]=v[3*S+2],Ct(d,d,e),i.push(new St(d[0],d[1]));for(let S=0;S<3*p.indexArray.length;S++)l.push(w[S]+c)}if(l.length%3!=0)return null;for(let p=0;p<l.length;p+=3){const v=i[l[p+0]],w=i[l[p+1]],S=i[l[p+2]];(v.x-w.x)*(S.y-w.y)-(S.x-w.x)*(v.y-w.y)>0&&([l[p+1],l[p+2]]=[l[p+2],l[p+1]])}return{vertices:i,indices:l}}function kI(o){const e=function(w,S){const I=[],C=WebGL2RenderingContext;if(w.json.textures)for(const R of w.json.textures){const B={magFilter:C.LINEAR,minFilter:C.NEAREST,wrapS:C.REPEAT,wrapT:C.REPEAT};R.sampler!==void 0&&Object.assign(B,w.json.samplers[R.sampler]),I.push({image:S[R.source],sampler:B,uploaded:!1})}return I}(o,o.images),i=function(w,S){const I=[];for(const C of w.json.meshes){const R=[];for(const B of C.primitives)R.push(k4(B,w,S));I.push(R)}return I}(o,e),{scenes:l,scene:c,nodes:d}=o.json,p=l?l[c||0].nodes:d,v=[];for(const w of p)v.push(LI(d[w],o,i));return function(w,S,I){const C={},R=new Set;for(let B=0;B<w.length;B++){const N=I[S[B]];if(!N.extras)continue;const $=N.extras["mapbox:footprint:version"],X=N.extras["mapbox:footprint:id"];($||X)&&R.add(B),$==="1.0.0"&&X&&(C[X]=B)}for(let B=0;B<w.length;B++){if(R.has(B))continue;const N=w[B],$=I[S[B]];if(!$.extras)continue;let X=null;N.id in C&&(X=B4(w[C[N.id]].meshes,N.matrix)),X||(X=F4($)),X&&(N.footprint=O4(X))}if(R.size>0){const B=Array.from(R.values()).sort((N,$)=>N-$);for(let N=B.length-1;N>=0;N--)w.splice(B[N],1)}}(v,p,o.json.nodes),v}function N4(o){o.heightmap=new Float32Array(4096),o.heightmap.fill(-1);const e=o.vertexArray.float32,i=o.aabb.min[0]-1,l=o.aabb.min[1]-1,c=oh/(o.aabb.max[0]-i+2),d=oh/(o.aabb.max[1]-l+2);for(let p=0;p<e.length;p+=3){const v=e[p+2],w=(e[p+0]-i)*c|0,S=(e[p+1]-l)*d|0;v>o.heightmap[S*oh+w]&&(o.heightmap[S*oh+w]=v)}}function V4(o,e){const i={};i.indexArray=new wr,i.indexArray.reserve(4*o.length),i.vertexArray=new As,i.vertexArray.reserve(10*o.length),i.colorArray=new Is,i.vertexArray.reserve(10*o.length);let l=0;for(const p of o){const v=Math.min(10,Math.max(4,1.3*p.height))*e,w=[-p.normal[1],p.normal[0],0],S=Math.min(.29,.1*p.width/p.depth),I=p.width-2*p.depth*e*(S+.01),C=rn([],p.pos,w,I/2),R=rn([],p.pos,w,-I/2),B=[C[0],C[1],C[2]+p.height],N=[R[0],R[1],R[2]+p.height],$=rn([],p.normal,w,S);Lt($,$,v);const X=rn([],p.normal,w,-S);Lt(X,X,v),Ve($,C,$),Ve(X,R,X),C[2]+=.1,R[2]+=.1,i.vertexArray.emplaceBack($[0],$[1],$[2]),i.vertexArray.emplaceBack(X[0],X[1],X[2]),i.vertexArray.emplaceBack(C[0],C[1],C[2]),i.vertexArray.emplaceBack(R[0],R[1],R[2]),i.vertexArray.emplaceBack(B[0],B[1],B[2]),i.vertexArray.emplaceBack(N[0],N[1],N[2]),i.vertexArray.emplaceBack(C[0],C[1],C[2]),i.vertexArray.emplaceBack(R[0],R[1],R[2]),i.vertexArray.emplaceBack($[0],$[1],$[2]),i.vertexArray.emplaceBack(X[0],X[1],X[2]);const K=I/v/2;i.colorArray.emplaceBack(-K-S,-1,K,.8),i.colorArray.emplaceBack(K+S,-1,K,.8),i.colorArray.emplaceBack(-K,0,K,1.3),i.colorArray.emplaceBack(K,0,K,1.3),i.colorArray.emplaceBack(K+S,-.8,K,.7),i.colorArray.emplaceBack(K+S,-.8,K,.7),i.colorArray.emplaceBack(0,0,K,1.3),i.colorArray.emplaceBack(0,0,K,1.3),i.colorArray.emplaceBack(K+S,-1.2,K,.8),i.colorArray.emplaceBack(K+S,-1.2,K,.8),i.indexArray.emplaceBack(6+l,4+l,8+l),i.indexArray.emplaceBack(7+l,9+l,5+l),i.indexArray.emplaceBack(0+l,1+l,2+l),i.indexArray.emplaceBack(1+l,3+l,2+l),l+=10}const c={defined:!0,emissiveFactor:[0,0,0]},d={};return d.baseColorFactor=Kn.white,c.pbrMetallicRoughness=d,i.material=c,i.aabb=new Ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}class OI{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const l=e[i];this._stringToNumber[l]=i,this._numberToString[i]=l}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const U4=["id","tile","layer","source","sourceLayer","state"];class nd{constructor(e,i,l,c,d){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=l,this._y=c,this.properties=e.properties,this.id=d}clone(){const e=new nd(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of U4)this[i]!==void 0&&(e[i]=this[i]);return e}}class FI{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new vc(At,16,0),this.featureIndexArray=new Wg,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,l,c,d,p=0,v=0){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(l,c,d,p);const S=this.grid;for(let I=0;I<i.length;I++){const C=i[I],R=[1/0,1/0,-1/0,-1/0];for(let B=0;B<C.length;B++){const N=C[B];R[0]=Math.min(R[0],N.x),R[1]=Math.min(R[1],N.y),R[2]=Math.max(R[2],N.x),R[3]=Math.max(R[3],N.y)}v!==0&&(R[0]-=v,R[1]-=v,R[2]+=v,R[3]+=v),R[0]<At&&R[1]<At&&R[2]>=0&&R[3]>=0&&S.insert(w,R[0],R[1],R[2],R[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Lc.VectorTile(new m0(this.rawTileData)).layers,this.sourceLayerCoder=new OI(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:l,transform:c,tileTransform:d,pixelPosMatrix:p,availableImages:v}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const w=l.bufferedTilespaceBounds,S=this.grid.query(w.min.x,w.min.y,w.max.x,w.max.y,(B,N,$,X)=>or(l.bufferedTilespaceGeometry,B,N,$,X));S.sort(j4);let I=null;c.elevation&&S.length>0&&(I=Yf.create(c.elevation,this.tileID));const C={};let R;for(let B=0;B<S.length;B++){const N=S[B];if(N===R)continue;R=N;const $=this.featureIndexArray.get(N);let X=null;this.is3DTile?this.loadMatchingModelFeature(C,$,e,l,c):this.loadMatchingFeature(C,$,e,v,(K,le,re,G=0)=>(X||(X=Vt(K,this.tileID.canonical,d)),le.queryIntersectsFeature(l,K,re,X,this.z,c,p,I,G)))}return C}loadMatchingFeature(e,i,l,c,d){const{featureIndex:p,bucketIndex:v,sourceLayerIndex:w,layoutVertexArrayOffset:S}=i,I=this.bucketLayerIDs[v],C=l.layers,R=Object.keys(C);if(R.length&&!function(K,le){for(let re=0;re<K.length;re++)if(le.indexOf(K[re])>=0)return!0;return!1}(R,I))return;const B=l.sourceCache,N=this.sourceLayerCoder.decode(w),$=this.vtLayers[N].feature(p),X=this.getId($,N);for(let K=0;K<I.length;K++){const le=I[K];if(!C[le])continue;const{styleLayer:re,targets:G}=C[le];let ne={};X!==void 0&&(ne=B.getFeatureState(re.sourceLayer,X));const ae=!d||d($,re,ne,S);if(!ae)continue;const de=new nd($,this.z,this.x,this.y,X);de.tile=this.tileID.canonical,de.state=ne;let be=this.serializedLayersCache.get(le);be||(be=re.serialize(),be.id=le,this.serializedLayersCache.set(le,be)),de.source=be.source,de.sourceLayer=be["source-layer"],de.layer=$e({},be),de.layer.paint=BI(be.paint,re.paint,$,ne,c),de.layer.layout=BI(be.layout,re.layout,$,ne,c);let Ie=!1;for(const Me of G){this.updateFeatureProperties(de,Me);const{filter:ke}=Me;if(ke){if($.properties=de.properties,ke.needGeometry){const Ye=Xt($,!0);if(!ke.filter(new si(this.tileID.overscaledZ),Ye,this.tileID.canonical))continue}else if(!ke.filter(new si(this.tileID.overscaledZ),$))continue}Ie=!0,Me.targetId&&this.addFeatureVariant(de,Me)}Ie&&this.appendToResult(e,le,p,de,ae)}}loadMatchingModelFeature(e,i,l,c,d){const p=this.bucketLayerIDs[0][0],v=l.layers;if(!v[p])return;const{styleLayer:w,targets:S}=v[p];if(w.type!=="model")return;const I=c.tile,C=i.featureIndex,R=I.getBucket(w);if(!(R&&R instanceof B0))return;const B=function(be,Ie,Me,ke){const Ye=be.getNodesInfo()[Ie];if(Ye.hiddenByReplacement||!Ye.node.meshes)return;let ft=Number.MAX_VALUE;const at=Ye.node,ht=Me.tile,_t=ke.calculatePosMatrix(ht.tileID.toUnwrapped(),ke.worldSize),We=Ye.evaluatedScale;let ct=0;ke.elevation&&at.elevation&&(ct=at.elevation*ke.elevation.exaggeration()),ue(_t,_t,[(at.anchor?at.anchor[0]:0)*(We[0]-1),(at.anchor?at.anchor[1]:0)*(We[1]-1),ct]),ce(_t,_t,We);const Ge=Me.queryGeometry,Xe=Ge.isPointQuery()?Ge.screenBounds:Ge.screenGeometry,yt=function(Wt){const Nt=ee([],_t,Wt.matrix);ee(Nt,ke.expandedFarZProjMatrix,Nt);for(let Mt=0;Mt<Wt.meshes.length;++Mt){const gt=Wt.meshes[Mt];if(Mt===Wt.lightMeshIndex)continue;const ln=FA(Xe,ke,Nt,gt.aabb);ln!=null&&(ft=Math.min(ln,ft))}if(Wt.children)for(const Mt of Wt.children)yt(Mt)};if(yt(at),ft===Number.MAX_VALUE)return;const vt=new Z(0,0);return WA(ht.tileID.canonical,vt,Ye.node.anchor[0],Ye.node.anchor[1]),{intersectionZ:ft,position:vt,feature:Ye.feature}}(R,C,c,d);if(!B)return;const{z:N,x:$,y:X}=I.tileID.canonical,{feature:K,intersectionZ:le,position:re}=B;let G={};K.id!==void 0&&(G=l.sourceCache.getFeatureState(w.sourceLayer,K.id));const ne=new nd({},N,$,X,K.id);ne.tile=this.tileID.canonical,ne.state=G,ne.properties=K.properties,ne.geometry={type:"Point",coordinates:[re.lng,re.lat]};let ae=this.serializedLayersCache.get(p);ae||(ae=w.serialize(),ae.id=p,this.serializedLayersCache.set(p,ae)),ne.source=ae.source,ne.sourceLayer=ae["source-layer"],ne.layer=$e({},ae);let de=!1;for(const be of S){this.updateFeatureProperties(ne,be);const{filter:Ie}=be;if(Ie){if(K.properties=ne.properties,Ie.needGeometry){if(!Ie.filter(new si(this.tileID.overscaledZ),K,this.tileID.canonical))continue}else if(!Ie.filter(new si(this.tileID.overscaledZ),K))continue}de=!0,be.targetId&&this.addFeatureVariant(ne,be)}de&&this.appendToResult(e,p,C,ne,le)}updateFeatureProperties(e,i,l){if(i.properties){const c={};for(const d in i.properties){const p=i.properties[d].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,l);p!=null&&(c[d]=p)}e.properties=c}}addFeatureVariant(e,i,l){const c={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(c.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(c)}appendToResult(e,i,l,c,d){let p=e[i];p===void 0&&(p=e[i]=[]),p.push({featureIndex:l,feature:c,intersectionZ:d})}lookupSymbolFeatures(e,i,l,c,d){const p={};this.loadVTLayers();for(const v of e)this.loadMatchingFeature(p,{bucketIndex:i,sourceLayerIndex:l,featureIndex:v,layoutVertexArrayOffset:0},c,d);return p}loadFeature(e){const{featureIndex:i,sourceLayerIndex:l}=e;this.loadVTLayers();const c=this.sourceLayerCoder.decode(l),d=this.vtFeatures[c];if(d[i])return d[i];const p=this.vtLayers[c].feature(i);return d[i]=p,p}hasLayer(e){for(const i of this.bucketLayerIDs)for(const l of i)if(e===l)return!0;return!1}getId(e,i){let l=e.id;if(this.promoteId){const c=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(c!=null)if(Array.isArray(c)){if(!this.promoteIdExpression){const d=gc(c);if(d.result!=="success"){const p=d.value.map(v=>`${v.key}: ${v.message}`).join(", ");return void Dn(`Failed to create expression for promoteId: ${p}`)}this.promoteIdExpression=d.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Kh),l=this.promoteIdExpression.evaluate({zoom:0},e)}else l=e.properties[c];typeof l=="boolean"&&(l=Number(l))}return l}}function BI(o,e,i,l,c){return _n(o,(d,p)=>{const v=e instanceof bl?e.get(p):null;return v&&v.evaluate?v.evaluate(i,l,void 0,c):v})}function j4(o,e){return e-o}Ft(FI,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const NI=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Mb{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,l]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const c=l>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);const d=NI[15&l];if(!d)throw new Error("Unrecognized array type.");const[p]=new Uint16Array(e,2,1),[v]=new Uint32Array(e,4,1);return new Mb(v,p,d,e)}constructor(e,i=64,l=Float64Array,c){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=l,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const d=NI.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,v=e*this.IndexArrayType.BYTES_PER_ELEMENT,w=(8-v%8)%8;if(d<0)throw new Error(`Unexpected typed array class: ${l}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+v+w,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+v+w),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+v+w,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+d]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const l=this._pos>>1;return this.ids[l]=l,this.coords[this._pos++]=e,this.coords[this._pos++]=i,l}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Cb(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,l,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:d,coords:p,nodeSize:v}=this,w=[0,d.length-1,0],S=[];for(;w.length;){const I=w.pop()||0,C=w.pop()||0,R=w.pop()||0;if(C-R<=v){for(let X=R;X<=C;X++){const K=p[2*X],le=p[2*X+1];K>=e&&K<=l&&le>=i&&le<=c&&S.push(d[X])}continue}const B=R+C>>1,N=p[2*B],$=p[2*B+1];N>=e&&N<=l&&$>=i&&$<=c&&S.push(d[B]),(I===0?e<=N:i<=$)&&(w.push(R),w.push(B-1),w.push(1-I)),(I===0?l>=N:c>=$)&&(w.push(B+1),w.push(C),w.push(1-I))}return S}within(e,i,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:c,coords:d,nodeSize:p}=this,v=[0,c.length-1,0],w=[],S=l*l;for(;v.length;){const I=v.pop()||0,C=v.pop()||0,R=v.pop()||0;if(C-R<=p){for(let X=R;X<=C;X++)UI(d[2*X],d[2*X+1],e,i)<=S&&w.push(c[X]);continue}const B=R+C>>1,N=d[2*B],$=d[2*B+1];UI(N,$,e,i)<=S&&w.push(c[B]),(I===0?e-l<=N:i-l<=$)&&(v.push(R),v.push(B-1),v.push(1-I)),(I===0?e+l>=N:i+l>=$)&&(v.push(B+1),v.push(C),v.push(1-I))}return w}}function Cb(o,e,i,l,c,d){if(c-l<=i)return;const p=l+c>>1;VI(o,e,p,l,c,d),Cb(o,e,i,l,p-1,1-d),Cb(o,e,i,p+1,c,1-d)}function VI(o,e,i,l,c,d){for(;c>l;){if(c-l>600){const S=c-l+1,I=i-l+1,C=Math.log(S),R=.5*Math.exp(2*C/3),B=.5*Math.sqrt(C*R*(S-R)/S)*(I-S/2<0?-1:1);VI(o,e,i,Math.max(l,Math.floor(i-I*R/S+B)),Math.min(c,Math.floor(i+(S-I)*R/S+B)),d)}const p=e[2*i+d];let v=l,w=c;for(Fm(o,e,l,i),e[2*c+d]>p&&Fm(o,e,l,c);v<w;){for(Fm(o,e,v,w),v++,w--;e[2*v+d]<p;)v++;for(;e[2*w+d]>p;)w--}e[2*l+d]===p?Fm(o,e,l,w):(w++,Fm(o,e,w,c)),w<=i&&(l=w+1),i<=w&&(c=w-1)}}function Fm(o,e,i,l){Pb(o,i,l),Pb(e,2*i,2*l),Pb(e,2*i+1,2*l+1)}function Pb(o,e,i){const l=o[e];o[e]=o[i],o[i]=l}function UI(o,e,i,l){const c=o-i,d=e-l;return c*c+d*d}r.$=Gr,r.A=_a,r.B=as,r.C=Tl,r.D=Kf,r.E=sl,r.F=2,r.G=vm,r.H=KE,r.I=_o,r.J=class extends O0{},r.K=an,r.L=vu,r.M=cs,r.N=vf,r.O=yf,r.P=St,r.Q=zp,r.R=$h,r.S=wf,r.T=ob,r.U=If,r.V=O0,r.W=Lu,r.X=gc,r.Y=sf,r.Z=fc,r._=Mu,r.a=function(o){return Or.API_CDN_URL_REGEX.test(o)},r.a$=kt,r.a0=yu,r.a1=Mf,r.a2=xf,r.a3=Ig,r.a4=function(o){const e=o.value;let i=[];if(!e)return i;const l=an(e);return l!=="string"?(i=i.concat([new O0(o.key,e,`string expected, "${l}" found`)]),i):(cb(e,!0)||(i=i.concat([new O0(o.key,e,`invalid url "${e}"`)])),i)},r.a5=Ne,r.a6=Lg,r.a7=Xi,r.a8=wt,r.a9=class{constructor(o){this.specification=o}possiblyEvaluate(o,e){return gi(o.expression.evaluate(e))}interpolate(o,e,i){return{x:Jt(o.x,e.x,i),y:Jt(o.y,e.y,i),z:Jt(o.z,e.z,i),azimuthal:Jt(o.azimuthal,e.azimuthal,i),polar:Jt(o.polar,e.polar,i)}}},r.aA=tr,r.aB=li,r.aC=lt,r.aD=ze,r.aE=g,r.aF=function(o,e){const i={};for(let l=0;l<e.length;l++){const c=e[l];c in o&&(i[c]=o[c])}return i},r.aG=oe,r.aH=ve,r.aI=class{constructor(o){this.entries={},this.scheduler=o}request(o,e,i,l){const c=this.entries[o]=this.entries[o]||{callbacks:[]};if(c.result){const[d,p]=c.result;return this.scheduler?this.scheduler.add(()=>{l(d,p)},e):l(d,p),()=>{}}return c.callbacks.push(l),c.cancel||(c.cancel=i((d,p)=>{c.result=[d,p];for(const v of c.callbacks)this.scheduler?this.scheduler.add(()=>{v(d,p)},e):v(d,p);setTimeout(()=>delete this.entries[o],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(d=>d!==l),c.callbacks.length||(c.cancel(),delete this.entries[o]))}}},r.aJ=function(o,e,i){const l=JSON.stringify(o.request);return o.data&&(this.deduped.entries[l]={result:[null,o.data]}),this.deduped.request(l,{type:"parseTile",isSymbolTile:o.isSymbolTile,zoom:o.tileZoom},c=>{const d=ec(o.request,(p,v,w,S)=>{p?c(p):v&&c(null,{vectorTile:i?void 0:new Lc.VectorTile(new m0(v)),rawData:v,cacheControl:w,expires:S})});return()=>{d.cancel(),c()}},e)},r.aK=function(o){mu++,mu>ss&&(o.getActor().send("enforceCacheSizeLimit",qs),mu=0)},r.aL=function(o){return o<=1?1:Math.pow(2,Math.floor(Math.log(o)/Math.LN2))},r.aM=nr,r.aN=AA,r.aO=RA,r.aP=EA,r.aQ=function(o,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let l=0;l<o.length;l++){const c=document.createElement("source");Lx(o[l])||(i.crossOrigin="Anonymous"),c.src=o[l],i.appendChild(c)}return{cancel:()=>{}}},r.aR=z0,r.aS=function(o){return fetch(o).then(e=>e.arrayBuffer()).then(e=>DI(e,0,o))},r.aT=kI,r.aU=class{constructor(o,e,i,l){this.id=o,this.position=e!=null?new Z(e[0],e[1]):new Z(0,0),this.orientation=i??[0,0,0],this.nodes=l,this.uploaded=!1,this.aabb=new Ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(o,e){if(ee(o.matrix,e,o.matrix),o.meshes)for(const i of o.meshes){const l=Ri.applyTransformFast(i.aabb,o.matrix);this.aabb.encapsulate(l)}if(o.children)for(const i of o.children)this._applyTransformations(i,o.matrix)}computeBoundsAndApplyParent(){const o=J([]);for(const e of this.nodes)this._applyTransformations(e,o)}computeModelMatrix(o,e,i,l,c,d,p=!1){$A(this.matrix,this,o.transform,this.position,e,i,l,c,d,p)}upload(o){if(!this.uploaded){for(const e of this.nodes)hb(e,o);for(const e of this.nodes)F0(e);this.uploaded=!0}}destroy(){for(const o of this.nodes)fb(o)}},r.aV=un,r.aW=bm,r.aX=we,r.aY=Te,r.aZ=Sl,r.a_=wr,r.aa=si,r.ab=yc,r.ac=je,r.ad=Ct,r.ae=ut,r.af=Re,r.ag=bl,r.ah=Rc,r.ai=Jt,r.aj=At,r.ak=tg,r.al=W,r.am=Kn,r.an=class{constructor(o){this.specification=o}possiblyEvaluate(o,e){return function([i,l]){const c=gi([1,i,l]);return{x:c.x,y:c.y,z:c.z}}(o.expression.evaluate(e))}interpolate(o,e,i){return{x:Jt(o.x,e.x,i),y:Jt(o.y,e.y,i),z:Jt(o.z,e.z,i)}}},r.ao=function(o,e,i=0,l=!0){const c=new St(i,i),d=o.sub(c),p=e.add(c),v=[d,new St(p.x,d.y),p,new St(d.x,p.y)];return l&&v.push(d.clone()),v},r.ap=function(o,e){const i=[];for(let l=0;l<o.length;l++){const c=He(l-1,-1,o.length-1),d=He(l+1,-1,o.length-1),p=o[l],v=o[d],w=o[c].sub(p).unit(),S=v.sub(p).unit(),I=S.angleWithSep(w.x,w.y),C=w.add(S).unit().mult(-1*e/Math.sin(I/2));i.push(p.add(C))}return i},r.aq=hA,r.ar=or,r.as=function(o,e,i=0){return Pe(((e.x-i)*o.scale-o.x)*At,(e.y*o.scale-o.y)*At,Ue(e.z,e.y))},r.at=dn,r.au=hn,r.av=ps,r.aw=TE,r.ax=function(o){let e=1/0,i=1/0,l=-1/0,c=-1/0;for(const d of o)e=Math.min(e,d.x),i=Math.min(i,d.y),l=Math.max(l,d.x),c=Math.max(c,d.y);return{min:new St(e,i),max:new St(l,c)}},r.ay=ye,r.az=ee,r.b=function(o){return Or.API_FONTS_REGEX.test(o)},r.b$=Lt,r.b0=Ff,r.b1=C0,r.b2=function(){Yo.isLoading()||Yo.isLoaded()||xc()!=="deferred"||Dg()},r.b3=Vp,r.b4=Xt,r.b5=nd,r.b6=er,r.b7=F1,r.b8=P1,r.b9=Vt,r.bA=function(o,e){const{x:i,y:l}=o.point,c=rS(i,l,o.worldSize/o._pixelsPerMercatorPixel,0,0);return ee(c,c,m1(Da(e)))},r.bB=L,r.bC=function(o){return o[0]=0,o[1]=0,o[2]=0,o},r.bD=function(o,e){return Math.hypot(e[0]-o[0],e[1]-o[1],e[2]-o[2])},r.bE=Nn,r.bF=rn,r.bG=Pn,r.bH=ym,r.bI=Po,r.bJ=q1,r.bK=function(o,e,i,l,c){const d=5*e+2;o.float32[d+0]=i,o.float32[d+1]=l,o.float32[d+2]=c},r.bL=M0,r.bM=p0,r.bN=en,r.bO=Pr,r.bP=qS,r.bQ=BA,r.bR=YS,r.bS=KS,r.bT=X1,r.bU=rA,r.bV=G1,r.bW=Mb,r.bX=He,r.bY=da,r.bZ=function(o,e,i){i*=.5;var l=e[0],c=e[1],d=e[2],p=e[3],v=Math.sin(i),w=Math.cos(i);return o[0]=l*w+c*v,o[1]=c*w-l*v,o[2]=d*w+p*v,o[3]=p*w-d*v,o},r.b_=Us,r.ba=Ks,r.bb=Gu,r.bc=Cs,r.bd=Ui,r.be=sm,r.bf=nb,r.bg=function(o,e){const i=Rc(e.zoom);if(i===0)return Da(o);const l=n0(o),c=p1(l),d=ye(l.getWest())*e.worldSize,p=ye(l.getEast())*e.worldSize,v=ve(l.getNorth())*e.worldSize,w=ve(l.getSouth())*e.worldSize,S=[d,v,0],I=[p,v,0],C=[d,w,0],R=[p,w,0],B=Q([],e.globeMatrix);return Ct(S,S,B),Ct(I,I,B),Ct(C,C,B),Ct(R,R,B),c[0]=Cl(c[0],C,i),c[1]=Cl(c[1],R,i),c[2]=Cl(c[2],I,i),c[3]=Cl(c[3],S,i),Ri.fromPoints(c)},r.bh=r0,r.bi=Q,r.bj=rm,r.bk=Cl,r.bl=zf,r.bm=Jo,r.bn=Qe,r.bo=ue,r.bp=Z0,r.bq=m0,r.br=ec,r.bs=function(o,e){const i=[];for(const l in o)l in e||i.push(l);return i},r.bt=it,r.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],r.bv=$s,r.bw=function(o){var e=new M(16);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],e[4]=o[4],e[5]=o[5],e[6]=o[6],e[7]=o[7],e[8]=o[8],e[9]=o[9],e[10]=o[10],e[11]=o[11],e[12]=o[12],e[13]=o[13],e[14]=o[14],e[15]=o[15],e},r.bx=J,r.by=De,r.bz=te,r.c=nl,r.c$=function(o){return o({pluginStatus:go,pluginURL:Ia}),Af.on("pluginStateChange",o),o},r.c0=Qi,r.c1=br,r.c2=function(o,e){return o[0]=-e[0],o[1]=-e[1],o[2]=-e[2],o[3]=e[3],o},r.c3=rt,r.c4=function(o,e,i,l,c){var d,p=1/Math.tan(e/2);return o[0]=p/i,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=p,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,c!=null&&c!==1/0?(o[10]=(c+l)*(d=1/(l-c)),o[14]=2*c*l*d):(o[10]=-1,o[14]=-2*l),o},r.c5=function(o,e,i,l,c,d,p){var v=1/(e-i),w=1/(l-c),S=1/(d-p);return o[0]=-2*v,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*w,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*S,o[11]=0,o[12]=(e+i)*v,o[13]=(c+l)*w,o[14]=(p+d)*S,o[15]=1,o},r.c6=_e,r.c7=function(o,e,i){o[4*e+0]=i[0],o[4*e+1]=i[1],o[4*e+2]=i[2],o[4*e+3]=i[3]},r.c8=Wu,r.c9=us,r.cA=L0,r.cB=tt,r.cC=DA,r.cD=function(o){const e=DA(o,!0);return L([],[e[0],e[1],e[4],e[5]])},r.cE=ce,r.cF=Pc,r.cG=se,r.cH=function(o){const{x:e,y:i}=o.point,{lng:l,lat:c}=o._center;return rS(e,i,o.worldSize,l,c)},r.cI=bt,r.cJ=ie,r.cK=Lr,r.cL=b,r.cM=function(o,e,i){let l=0;for(let c=0;c<2;++c)o[c]>0&&(l+=(o[c]-0)*(o[c]-0)),e[c]<0&&(l+=(0-e[c])*(0-e[c]));return l},r.cN=45,r.cO=Wh,r.cP=xe,r.cQ=Vf,r.cR=function(o,e,i){const l=Math.sqrt(o*o+e*e+i*i),c=l>0?Math.acos(i/l)*Ke:0;let d=o!==0||e!==0?Math.atan2(-e,-o)*Ke+90:0;return d<0&&(d+=360),[l,d,c]},r.cS=Pe,r.cT=Oe,r.cU=Ve,r.cV=Ri,r.cW=gi,r.cX=function(o){return[Math.pow(o[0],1/2.2),Math.pow(o[1],1/2.2),Math.pow(o[2],1/2.2)]},r.cY=qe,r.cZ=cb,r.c_=function(o,e){return o.readFields(Nk,{icons:[]},e)},r.ca=Zu,r.cb=ir,r.cc=Nf,r.cd=Z,r.ce=_A,r.cf=function(){var o=new M(4);return M!=Float32Array&&(o[1]=0,o[2]=0),o[0]=1,o[3]=1,o},r.cg=function(o,e,i){var l=e[0],c=e[1],d=e[2],p=e[3],v=Math.sin(i),w=Math.cos(i);return o[0]=l*w+d*v,o[1]=c*w+p*v,o[2]=l*-v+d*w,o[3]=c*-v+p*w,o},r.ch=function(o,e){return o[0]===e[0]&&o[1]===e[1]&&o[2]===e[2]&&o[3]===e[3]},r.ci=It,r.cj=function(o){return Math.hypot(o[0],o[1],o[2],o[3])},r.ck=bs,r.cl=Tn,r.cm=Cr,r.cn=Ku,r.co=LA,r.cp=Si,r.cq=tS,r.cr=function(o,e,i,l,c,d,p,v,w){if(w.name==="globe")return tS(o,e,new Si(i,l,c),!1);const S=bm({z:i,x:l,y:c},w);return new Ri([(d+S.x/S.scale)*e,e*(S.y/S.scale),p],[(d+S.x2/S.scale)*e,e*(S.y2/S.scale),v])},r.cs=function(o,e,i){return o[0]=Math.min(e[0],i[0]),o[1]=Math.min(e[1],i[1]),o[2]=Math.min(e[2],i[2]),o[3]=Math.min(e[3],i[3]),o},r.ct=function(o,e,i){return o[0]=Math.max(e[0],i[0]),o[1]=Math.max(e[1],i[1]),o[2]=Math.max(e[2],i[2]),o[3]=Math.max(e[3],i[3]),o},r.cu=function(o){const e=Math.round((o+45+360)%360/90)%4;return ge[e]},r.cv=Fe,r.cw=vn,r.cx=T,r.cy=function(o){const e=J(new Float64Array(16));ee(e,o.pixelMatrix,o.globeMatrix);const i=[0,F,0],l=[0,O,0];return Ct(i,i,e),Ct(l,l,e),[i[0]>0&&i[0]<=o.width&&i[1]>0&&i[1]<=o.height&&!g1(o,new Z(o.center.lat,90)),l[0]>0&&l[0]<=o.width&&l[1]>0&&l[1]<=o.height&&!g1(o,new Z(o.center.lat,-90))]},r.cz=function(o,e){const{scale:i}=o.tileTransform,l=i*At/(o.tileSize*Math.pow(2,e.zoom-o.tileID.overscaledZ+o.tileID.canonical.z));return function(c,d,p){var v=d[1],w=d[2],S=d[3],I=p[0],C=p[1];return c[0]=d[0]*I,c[1]=v*I,c[2]=w*C,c[3]=S*C,c}(new Float32Array(4),e.inverseAdjustmentMatrix,[l,l])},r.d=function(o){return Or.API_TILEJSON_REGEX.test(o)},r.d$=em,r.d0=N0,r.d1=Hf,r.d2=Z1,r.d3=Hn,r.d4=xl,r.d5=po,r.d6=mo,r.d7=zn,r.d8=function(o){const e=o.indexOf(Vu);return e>=0?o.slice(0,e):o},r.d9=function(o){return o.indexOf(Vu)>=0},r.dA=iS,r.dB=$r,r.dC=jr,r.dD=256,r.dE=function(o,e){const i=[0,0,0];return Ct(i,i,r0(Da(e.canonical))),Ct(i,i,o),i},r.dF=o=>({u_camera_to_center_distance:new ir(o),u_extrude_scale:new Ko(o),u_device_pixel_ratio:new ir(o),u_matrix:new Wu(o),u_inv_rot_matrix:new Wu(o),u_merc_center:new us(o),u_tile_id:new Zu(o),u_zoom_transition:new ir(o),u_up_dir:new Zu(o),u_emissive_strength:new ir(o)}),r.dG=o=>({u_matrix:new Wu(o),u_pixels_to_tile_units:new Ko(o),u_device_pixel_ratio:new ir(o),u_width_scale:new ir(o),u_floor_width_scale:new ir(o),u_units_to_pixels:new us(o),u_dash_image:new Nf(o),u_gradient_image:new Nf(o),u_image_height:new ir(o),u_texsize:new us(o),u_tile_units_to_pixels:new ir(o),u_alpha_discard_threshold:new ir(o),u_trim_offset:new us(o),u_trim_fade_range:new us(o),u_trim_color:new Vf(o),u_emissive_strength:new ir(o),u_zbias_factor:new ir(o),u_tile_to_meter:new ir(o),u_ground_shadow_factor:new Zu(o)}),r.dH=o=>({u_matrix:new Wu(o),u_texsize:new us(o),u_pixels_to_tile_units:new Ko(o),u_device_pixel_ratio:new ir(o),u_width_scale:new ir(o),u_floor_width_scale:new ir(o),u_image:new Nf(o),u_units_to_pixels:new us(o),u_tile_units_to_pixels:new ir(o),u_alpha_discard_threshold:new ir(o),u_trim_offset:new us(o),u_trim_fade_range:new us(o),u_trim_color:new Vf(o),u_emissive_strength:new ir(o),u_zbias_factor:new ir(o),u_tile_to_meter:new ir(o),u_ground_shadow_factor:new Zu(o),u_pattern_transition:new ir(o)}),r.dI=ju,r.dJ=$5,r.dK=aS,r.dL=(o,e,i,l,c,d)=>{const p=o.transform,v=p.projection.name==="globe";let w;if(d.paint.get("circle-pitch-alignment")==="map")if(v){const I=iS(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;w=Float32Array.from([I,0,0,I])}else w=p.calculatePixelsToTileUnitsMatrix(i);else w=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);const S={u_camera_to_center_distance:o.transform.getCameraToCenterDistance(p.projection),u_matrix:o.translatePosMatrix(e.projMatrix,i,d.paint.get("circle-translate"),d.paint.get("circle-translate-anchor")),u_device_pixel_ratio:rs.devicePixelRatio,u_extrude_scale:w,u_inv_rot_matrix:BL,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:d.paint.get("circle-emissive-strength")};if(v){S.u_inv_rot_matrix=l,S.u_merc_center=c,S.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],S.u_zoom_transition=Rc(p.zoom);const I=c[0]*At,C=c[1]*At;S.u_up_dir=p.projection.upVector(new Si(0,0,0),I,C)}return S},r.dM=IE,r.dN=co,r.dO=(o,e,i,l,c,d,p,v,w,S)=>{const I=o.transform,C=I.pitch<15?SE(.07,.7,ze((14-I.zoom)/5,0,1)):.07,R=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:AE(o,e,i,l),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:c,u_width_scale:d,u_floor_width_scale:p,u_image:0,u_tile_units_to_pixels:EE(e,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:v,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(R?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:C,u_tile_to_meter:Oe(e.tileID.canonical,0),u_ground_shadow_factor:w,u_pattern_transition:S}},r.dP=(o,e,i,l,c,d,p,v,w,S)=>{const I=o.transform,C=I.calculatePixelsToTileUnitsMatrix(e),R=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",B=I.pitch<15?SE(.07,.7,ze((14-I.zoom)/5,0,1)):.07;return{u_matrix:AE(o,e,i,l),u_pixels_to_tile_units:C,u_device_pixel_ratio:d,u_width_scale:p,u_floor_width_scale:v,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:ME(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:EE(e,o.transform),u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(R?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:B,u_tile_to_meter:Oe(e.tileID.canonical,0),u_ground_shadow_factor:S}},r.dQ=Zt,r.dR=om,r.dS=Ue,r.dT=uE,r.dU=ds,r.dV=d0,r.dW=kc,r.dX=450,r.dY=7,r.dZ=Tk,r.d_=Yn,r.da=function(o){const e=o.lastIndexOf(Vu);return e>=0?o.slice(e+1):""},r.db=function(o){const e=[],i=o.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),o.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),o.renderingMode&&o.renderingMode!=="2d"&&o.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},r.dc=function(o,e,i,l){return o.type==="custom"?new Sk(o,e):new kk[o.type](o,e,i,l)},r.dd=An,r.de=function(o){const e=o.indexOf(Vu);return e>=0?o.slice(e+1):""},r.df=class extends nd{constructor(o,e){super(o._vectorTileFeature,o._z,o._x,o._y,o.id),o.state&&(this.state=Object.assign({},o.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=o.source,this.sourceLayer=o.sourceLayer,this.layer=o.layer)}toJSON(){const o=super.toJSON();return o.target=this.target,o.namespace=this.namespace,o}},r.dg=Af,r.dh=Ql,r.di=e0,r.dj=class extends Ms{constructor(o){super(o),this.current=t0}set(o,e,i){if(this.fetchUniformLocation(o,e)){for(let l=0;l<9;l++)if(i[l]!==this.current[l]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},r.dk=Ee,r.dl=function(o,e,i){const l=Rc(i.zoom),c=o.style.map._antialias,d=o.terrain&&o.terrain.exaggeration()>0;return l===0&&!c&&!d},r.dm=function(o){const e=o.pixelsPerMeter,i=e/_e(1,o.center.lat),l=J(new Float64Array(16));return ue(l,l,[o.point.x,o.point.y,0]),ce(l,l,[i,i,e]),Float32Array.from(l)},r.dn=n0,r.dp=function(o){const e=Fe-5;o=ze(o,-80.051129,e)/e*90;const i=Math.pow(Math.abs(Math.sin(W(o))),3);return Math.round(i*(D.length-1))},r.dq=function(o,e,i,l){const c=e.getNorth(),d=e.getSouth(),p=e.getWest(),v=e.getEast(),w=1<<o.z,S=v-p,I=c-d,C=S/z,R=-I/D[i],B=[0,C,0,R,0,0,c,p,0];if(o.z>0){const N=180/l;j(B,B,[N/S+1,0,0,0,N/I+1,0,-.5*N/C,.5*N/R,1])}return B[2]=w,B[5]=o.x,B[8]=o.y,B},r.dr=Da,r.ds=function(o,e,i){const l=J(new Float64Array(16)),c=(e/(1<<o)-.5)*Math.PI*2;return Ae(l,i.globeMatrix,c),Float32Array.from(l)},r.dt=class{isDataAvailableAtPoint(o){const e=this._source();if(this.isUsingMockSource()||!e||o.y<0||o.y>1)return!1;const i=e.getSource().maxzoom,l=1<<i,c=Math.floor(o.x),d=Math.floor((o.x-c)*l),p=Math.floor(o.y*l),v=this.findDEMTileFor(new nr(i,c,i,d,p));return!(!v||!v.dem)}getAtPointOrZero(o,e=0){return this.getAtPoint(o,e)||0}getAtPoint(o,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const l=this._source();if(!l||o.y<0||o.y>1)return e;const c=l.getSource().maxzoom,d=1<<c,p=Math.floor(o.x),v=o.x-p,w=new nr(c,p,c,Math.floor(v*d),Math.floor(o.y*d)),S=this.findDEMTileFor(w);if(!S||!S.dem)return e;const I=S.dem,C=1<<S.tileID.canonical.z,R=(v*C-S.tileID.canonical.x)*I.dim,B=(o.y*C-S.tileID.canonical.y)*I.dim,N=Math.floor(R),$=Math.floor(B);return(i?this.exaggeration():1)*Jt(Jt(I.get(N,$),I.get(N,$+1),B-$),Jt(I.get(N+1,$),I.get(N+1,$+1),B-$),R-N)}getAtTileOffset(o,e,i){const l=1<<o.canonical.z;return this.getAtPointOrZero(new je(o.wrap+(o.canonical.x+e/At)/l,(o.canonical.y+i/At)/l))}getAtTileOffsetFunc(o,e,i,l){return c=>{const d=this.getAtTileOffset(o,c.x,c.y),p=l.upVector(o.canonical,c.x,c.y);return Lt(p,p,d*l.upVectorScale(o.canonical,e,i).metersToTile),p}}getForTilePoints(o,e,i,l){if(this.isUsingMockSource())return!1;const c=Yf.create(this,o,l);return!!c&&(e.forEach(d=>{d[2]=this.exaggeration()*c.getElevationAt(d[0],d[1],i)}),!0)}getMinMaxForTile(o){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(o);if(!e||!e.dem)return null;const i=e.dem.tree,l=e.tileID,c=1<<o.canonical.z-l.canonical.z;let d=o.canonical.x/c-l.canonical.x,p=o.canonical.y/c-l.canonical.y,v=0;for(let w=0;w<o.canonical.z-l.canonical.z&&!i.leaves[v];w++){d*=2,p*=2;const S=2*Math.floor(p)+Math.floor(d);v=i.childOffsets[v]+S,d%=1,p%=1}return{min:this.exaggeration()*i.minimums[v],max:this.exaggeration()*i.maximums[v]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(o,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(o){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(o){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const o=this.visibleDemTiles;if(o.length===0)return null;let e=!1,i=Number.MAX_VALUE,l=Number.MIN_VALUE;for(const c of o){const d=this.getMinMaxForTile(c.tileID);d&&(i=Math.min(i,d.min),l=Math.max(l,d.max),e=!0)}return e?{min:i,max:l}:null}},r.du=gS,r.dv=zc,r.dw=function(o,e){return[Math.pow(o[0],2.2)*e,Math.pow(o[1],2.2)*e,Math.pow(o[2],2.2)*e]},r.dx=V,r.dy=function(o,e){var i=Math.sin(e),l=Math.cos(e);return o[0]=l,o[1]=i,o[2]=0,o[3]=-i,o[4]=l,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},r.dz=fn,r.e=Or,r.e$=OI,r.e0=256,r.e1=m1,r.e2=As,r.e3=Ae,r.e4=function(o,e){return o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[4],o[4]=e[5],o[5]=e[6],o[6]=e[8],o[7]=e[9],o[8]=e[10],o},r.e5=za,r.e6=$u,r.e7=function(o,e,i,l,c){return ze((o-e)/(i-e)*(c-l)+l,l,c)},r.e8=Ka,r.e9=function(o,e){var i=e[0],l=e[1],c=e[2],d=e[3],p=e[4],v=e[5],w=e[6],S=e[7],I=e[8],C=I*p-v*S,R=-I*d+v*w,B=S*d-p*w,N=i*C+l*R+c*B;return N?(o[0]=C*(N=1/N),o[1]=(-I*l+c*S)*N,o[2]=(v*l-c*p)*N,o[3]=R*N,o[4]=(I*i-c*w)*N,o[5]=(-v*i+c*d)*N,o[6]=B*N,o[7]=(-S*i+l*w)*N,o[8]=(p*i-l*d)*N,o):null},r.eA=function(o,e,i){return o[0]=e[0]/i[0],o[1]=e[1]/i[1],o[2]=e[2]/i[2],o},r.eB=$n,r.eC=H,r.eD=pi,r.eE=function(o,e,i,l){return o[0]=e,o[1]=i,o[2]=l,o},r.eF=function([o,e,i]){const l=Math.hypot(o,e,i),c=Math.atan2(o,i),d=.5*Math.PI-Math.acos(-e/l);return new Z(ie(c),ie(d))},r.eG=wi,r.eH=ab,r.eI=function(o){const e=o.navigator?o.navigator.userAgent:null;return!!function(i){if(hr==null){const l=i.navigator?i.navigator.userAgent:null;hr=!!i.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return hr}(o)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},r.eJ=function(o,e){qs=o,ss=e},r.eK=g1,r.eL=oS,r.eM=function(o){const e=[0,0,0],i=J(new Float64Array(16));return ee(i,o.pixelMatrix,o.globeMatrix),Ct(e,e,i),new St(e[0],e[1])},r.eN=function(o,e,i=!1){if(go===Op||go===Fp||go===Bp)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ia=rs.resolveURL(o),go=Op,Np=e,Ef(),i||Dg()},r.eO=xc,r.eP=function(){N0().acquire(pb)},r.eQ=function(){const o=Cm;o&&(o.isPreloaded()&&o.numActive()===1?(o.release(pb),Cm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},r.eR=ah,r.eS=function(o){const e=Jd();if(!e)return;const i=e.delete(os);o&&i.then(()=>o()).catch(o)},r.eT=Mm,r.eU=AI,r.eV=function(o){Sb=rs.resolveURL(o),td||(td=new Kf(N0(),new sl)),td.broadcast("setDracoUrl",Sb)},r.eW=II,r.eX=function(o){ed=rs.resolveURL(o),td||(td=new Kf(N0(),new sl)),td.broadcast("setMeshoptUrl",ed)},r.eY=Ft,r.eZ=Dc,r.e_=ta,r.ea=Tg,r.eb=ti,r.ec=et,r.ed=class{constructor(o,e,i,l){this.context=o,this.format=l,this.size=i,this.texture=o.gl.createTexture();const[c,d,p]=this.size,{gl:v}=o;v.bindTexture(v.TEXTURE_3D,this.texture),o.pixelStoreUnpackFlipY.set(!1),o.pixelStoreUnpack.set(1),o.pixelStoreUnpackPremultiplyAlpha.set(!1),v.texImage3D(v.TEXTURE_3D,0,this.format,c,d,p,0,ib(this.format),rb(this.format),e.data)}bind(o,e){const{context:i}=this,{gl:l}=i;l.bindTexture(l.TEXTURE_3D,this.texture),o!==this.minFilter&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MAG_FILTER,o),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MIN_FILTER,o),this.minFilter=o),e!==this.wrapS&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_S,e),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:o}=this.context;o.deleteTexture(this.texture),this.texture=null}},r.ee=function(o,e){if(o===e){var i=e[1],l=e[2],c=e[3],d=e[6],p=e[7],v=e[11];o[1]=e[4],o[2]=e[8],o[3]=e[12],o[4]=i,o[6]=e[9],o[7]=e[13],o[8]=l,o[9]=d,o[11]=e[14],o[12]=c,o[13]=p,o[14]=v}else o[0]=e[0],o[1]=e[4],o[2]=e[8],o[3]=e[12],o[4]=e[1],o[5]=e[5],o[6]=e[9],o[7]=e[13],o[8]=e[2],o[9]=e[6],o[10]=e[10],o[11]=e[14],o[12]=e[3],o[13]=e[7],o[14]=e[11],o[15]=e[15];return o},r.ef=lb,r.eg=Be,r.eh=[1,1,1],r.ei=function(o,e,i,l){var c=new M(4);return c[0]=o,c[1]=e,c[2]=i,c[3]=l,c},r.ej=bi,r.ek=function(o,e,i,l){var c=e[0],d=e[1],p=e[2],v=e[3];return o[0]=c+l*(i[0]-c),o[1]=d+l*(i[1]-d),o[2]=p+l*(i[2]-p),o[3]=v+l*(i[3]-v),o},r.el=Yf,r.em=Xf,r.en=Pa,r.eo=Al,r.ep=function(o,e,i,l,c,d,p,v,w,S,I,C,R,B,N,$){var X=new M(16);return X[0]=o,X[1]=e,X[2]=i,X[3]=l,X[4]=c,X[5]=d,X[6]=p,X[7]=v,X[8]=w,X[9]=S,X[10]=I,X[11]=C,X[12]=R,X[13]=B,X[14]=N,X[15]=$,X},r.eq=q,r.er=kf,r.es=Jp,r.et=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new St(1/0,1/0),max:new St(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(o,e=!1){const i=ZS(new St(0,0),new St(At,At),o),l=[];if(e&&!R1(i,this._globalClipBounds))return l;for(const c of this._activeRegions){if(c.hiddenByOverlap||!R1(i,c))continue;const d=m5(c.min,c.max,o);l.push({min:d.min,max:d.max,sourceId:this._sourceIds[c.priority],footprint:c.footprint,footprintTileId:c.tileId,order:c.order,clipMask:c.clipMask,clipScope:c.clipScope})}return l}setSources(o){this._setSources(o.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const l of e.cache.getVisibleCoordinates()){const c=e.cache.getTile(l).buckets[e.layer];c&&c.updateFootprints(l.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(o){const e=o.getFootprints();if(e.length===0)return;const i=o.getOrder(),l=o.getClipMask(),c=o.getClipScope();for(const d of e){if(!d.footprint)continue;const p=ZS(d.footprint.min,d.footprint.max,d.id);this._activeRegions.push({min:p.min,max:p.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:d.id,footprint:d.footprint,order:i,clipMask:l,clipScope:c})}this._sourceIds.push(o.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||h0(e.min,i.min)||h0(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(l,c){const d=(p,v)=>p+v;return l.length-c.length||l.reduce(d,"").localeCompare(c.reduce(d,""))}(e.clipScope,i.clipScope));let o=this._activeRegions.length!==this._prevRegions.length;if(!o){let e=0;for(;!o&&e!==this._activeRegions.length;){const i=this._activeRegions[e],l=this._prevRegions[e];o=i.priority!==l.priority||!HS(i,l)||i.order!==l.order||i.clipMask!==l.clipMask||!$s(i.clipScope,l.clipScope),++e}}if(o){++this._updateTime;for(const i of this._activeRegions)i.order!==u0&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const l=this._activeRegions;if(i>=l.length)return i;const c=l[i].priority;for(;i<l.length&&l[i].priority===c;)++i;return i};if(this._sourceIds.length>1){let i=0,l=e(i);for(;i!==l;){let c=i;const d=i;for(;c!==l;){const p=this._activeRegions[c];p.hiddenByOverlap=!1;for(let v=0;v<d;v++){const w=this._activeRegions[v];if(!w.hiddenByOverlap&&p.order===u0&&R1(p,w)&&(p.hiddenByOverlap=XS(p.footprint,p.tileId,w.footprint,w.tileId),p.hiddenByOverlap))break}++c}i=l,l=e(i)}}}}_setSources(o){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=o.length-1;e>=0;e--)this._addSource(o[e]);this._computeReplacement()}},r.eu=class{constructor(o){this._createGrid(o),this._createPoles(o)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const o of this._poleSegments)o.destroy();for(const o of this._gridSegments)o.withSkirts.destroy(),o.withoutSkirts.destroy()}_fillGridMeshWithLods(o,e){const i=new Ks,l=new wr,c=[],d=o+1+2,p=e[0]+1,v=e[0]+1+(1+e.length),w=(S,I,C)=>{let R=S===d-1?S-2:S===0?S:S-1;return R+=C?24575:0,[R,I]};for(let S=0;S<d;++S)i.emplaceBack(...w(S,0,!0));for(let S=0;S<p;++S)for(let I=0;I<d;++I)i.emplaceBack(...w(I,S,(I===0||I===d-1)&&!0));for(let S=0;S<e.length;++S){const I=e[S];for(let C=0;C<d;++C)i.emplaceBack(...w(C,I,!0))}for(let S=0;S<e.length;++S){const I=l.length,C=e[S]+1+2,R=new wr;for(let $=0;$<C-1;$++){const X=$===C-2,K=X?d*(v-e.length+S-$):d;for(let le=0;le<d-1;le++){const re=$*d+le;$===0||X||le===0||le===d-2?(R.emplaceBack(re+1,re,re+K),R.emplaceBack(re+K,re+K+1,re+1)):(l.emplaceBack(re+1,re,re+K),l.emplaceBack(re+K,re+K+1,re+1))}}const B=Ui.simpleSegment(0,I,i.length,l.length-I);for(let $=0;$<R.uint16.length;$+=3)l.emplaceBack(R.uint16[$],R.uint16[$+1],R.uint16[$+2]);const N=Ui.simpleSegment(0,I,i.length,l.length-I);c.push({withoutSkirts:B,withSkirts:N})}return{vertices:i,indices:l,segments:c}}_createGrid(o){const e=this._fillGridMeshWithLods(z,D);this._gridSegments=e.segments,this._gridBuffer=o.createVertexBuffer(e.vertices,Cs.members),this._gridIndexBuffer=o.createIndexBuffer(e.indices,!0)}_createPoles(o){const e=new wr;for(let p=0;p<=z;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=o.createIndexBuffer(e,!0);const i=new za,l=new za,c=new za,d=new za;this._poleSegments=[];for(let p=0,v=0;p<b;p++){const w=360/(1<<p);i.emplaceBack(0,-g,0,.5,0),l.emplaceBack(0,-g,0,.5,1),c.emplaceBack(0,-g,0,.5,.5),d.emplaceBack(0,-g,0,.5,.5);for(let S=0;S<=z;S++){let I=S/z,C=0;const R=Jt(0,w,I),[B,N,$]=U(OL,FL,R,g);i.emplaceBack(B,N,$,I,C),l.emplaceBack(B,N,$,I,1-C);const X=W(R);I=.5+.5*Math.sin(X),C=.5+.5*Math.cos(X),c.emplaceBack(B,N,$,I,C),d.emplaceBack(B,N,$,I,1-C)}this._poleSegments.push(Ui.simpleSegment(v,0,66,64)),v+=66}this._poleNorthVertexBuffer=o.createVertexBuffer(i,yo,!1),this._poleSouthVertexBuffer=o.createVertexBuffer(l,yo,!1),this._texturedPoleNorthVertexBuffer=o.createVertexBuffer(c,yo,!1),this._texturedPoleSouthVertexBuffer=o.createVertexBuffer(d,yo,!1)}getGridBuffers(o,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[o].withSkirts:this._gridSegments[o].withoutSkirts]}getPoleBuffers(o,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[o]]}},r.ev=u0,r.ew=Se,r.ex=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},r.ey=Ce,r.ez=xt,r.f=function(o){return o.indexOf("mapbox:")===0},r.f0=FI,r.f1=xE,r.f2=Qu,r.f3="hd_road_elevation",r.f4=I1,r.f5=_n,r.f6=th,r.f7=H1,r.f8=ih,r.f9=function(o,e,i,l,c,d,p,v=1,w,S){o.createArrays(),o.tilePixelRatio=At/(512*o.overscaling),o.compareText={},o.iconsNeedLinear=!1;const I=o.layers[0].layout,C=o.layers[0]._unevaluatedLayout._values,R={};R.scaleFactor=v,R.textSizeScaleRange=I.get("text-size-scale-range"),R.iconSizeScaleRange=I.get("icon-size-scale-range");const[B,N]=R.textSizeScaleRange,[$,X]=R.iconSizeScaleRange;R.textScaleFactor=ze(R.scaleFactor,B,N),R.iconScaleFactor=ze(R.scaleFactor,$,X);const K=C["text-size"],le=C["icon-size"];if(o.textSizeData.kind==="composite"){const{minZoom:be,maxZoom:Ie}=o.textSizeData;R.compositeTextSizes=[K.possiblyEvaluate(new si(be),d),K.possiblyEvaluate(new si(Ie),d)]}if(o.iconSizeData.kind==="composite"){const{minZoom:be,maxZoom:Ie}=o.iconSizeData;R.compositeIconSizes=[le.possiblyEvaluate(new si(be),d),le.possiblyEvaluate(new si(Ie),d)]}R.layoutTextSize=K.possiblyEvaluate(new si(p+1),d),R.layoutIconSize=le.possiblyEvaluate(new si(p+1),d),R.textMaxSize=K.possiblyEvaluate(new si(18),d);const re=I.get("symbol-placement"),G=I.get("text-rotation-alignment")==="map"&&re!=="point",ne=I.get("text-size");let ae=!1;const de=[];for(const be of o.features){const Ie=I.get("text-font").evaluate(be,{},d).join(","),Me=ne.evaluate(be,{},d)*R.textScaleFactor,ke=R.layoutTextSize.evaluate(be,{},d)*R.textScaleFactor,Ye=R.layoutIconSize.evaluate(be,{},d)*R.iconScaleFactor,ft={horizontal:{},vertical:void 0},at=be.text;let ht,_t=[0,0];if(at){const Gt=at.toString(),on=I.get("text-letter-spacing").evaluate(be,{},d)*Pr,mn=I.get("text-line-height").evaluate(be,{},d)*Pr,gn=e1(Gt)?on:0,Cn=I.get("text-anchor").evaluate(be,{},d),Sn=I.get("text-variable-anchor");if(!Sn){const pe=I.get("text-radial-offset").evaluate(be,{},d);if(pe)_t=rA(Cn,[pe*Pr,W1]);else{const Je=I.get("text-offset").evaluate(be,{},d);_t=[Je[0]*Pr,Je[1]*Pr]}}let bn=G?"center":I.get("text-justify").evaluate(be,{},d);const hi=re==="point",Ei=hi?I.get("text-max-width").evaluate(be,{},d)*Pr:1/0,he=pe=>{o.allowVerticalPlacement&&kp(Gt)&&(ft.vertical=$1(at,e,i,c,Ie,Ei,mn,Cn,pe,gn,_t,Po.vertical,!0,ke,Me,w))};if(!G&&Sn){const pe=bn==="auto"?Sn.map(Tt=>X1(Tt)):[bn];let Je=!1;for(let Tt=0;Tt<pe.length;Tt++){const zt=pe[Tt];if(!ft.horizontal[zt])if(Je)ft.horizontal[zt]=ft.horizontal[0];else{const Pt=$1(at,e,i,c,Ie,Ei,mn,"center",zt,gn,_t,Po.horizontal,!1,ke,Me,w);Pt&&(ft.horizontal[zt]=Pt,Je=Pt.positionedLines.length===1)}}he("left")}else{if(bn==="auto"&&(bn=X1(Cn)),hi||I.get("text-writing-mode").indexOf("horizontal")>=0||!kp(Gt)){const pe=$1(at,e,i,c,Ie,Ei,mn,Cn,bn,gn,_t,Po.horizontal,!1,ke,Me,w);pe&&(ft.horizontal[bn]=pe)}he(hi?"left":bn)}}let We,ct,Ge,Xe,yt,vt,Wt,Nt=!1;if(be.icon&&be.icon.hasPrimary()){const Gt=sA(be.icon,o.iconSizeData,C["icon-size"],d,o.zoom,be,w,R.iconScaleFactor);We=Gt.iconPrimary,Ge=Gt.iconSecondary;const on=We.toString();if(ct=l.get(on),ct&&(yt=I.get("icon-offset").evaluate(be,{},d),vt=I.get("icon-anchor").evaluate(be,{},d),Wt=I.get("icon-text-fit").evaluate(be,{},d),ht=ek(c.get(on),Ge?c.get(Ge.toString()):void 0,yt,vt),Nt=ct.sdf,o.sdfIcons===void 0?o.sdfIcons=ct.sdf:o.sdfIcons!==ct.sdf&&Dn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ct.pixelRatio!==o.pixelRatio||I.get("icon-rotate").constantOr(1)!==0)&&(o.iconsNeedLinear=!0)),Ge){const mn=Ge.toString();Xe=l.get(mn)}}ae=ae||!(!be.icon||!be.icon.hasSecondary());const Mt=Y1(ft.horizontal)||ft.vertical;o.iconsInText||(o.iconsInText=!!Mt&&Mt.iconsInText);const gt=ke*R.textScaleFactor/Pr,{defaultShapedIcon:ln,verticallyShapedIcon:$t}=ck(o,ht,I,be,d,ft,gt,yt,Wt);Wt!=="none"&&ht&&(jE(ht)||$E(ht))&&(b0(0,ct,We,ht,ln,Wt,S,l,c),b0(0,Xe,Ge,ht,ln,Wt,S,l,c),$t&&(b0(0,ct,We,ht,$t,Wt,S,l,c),b0(0,Xe,Ge,ht,$t,Wt,S,l,c))),ht=ln,de.push({feature:be,shapedTextOrientations:ft,shapedText:Mt,shapedIcon:ht,iconPrimary:We,iconSecondary:Ge,iconOffset:yt,iconAnchor:vt,verticallyShapedIcon:$t,layoutTextSize:ke,layoutIconSize:Ye,textOffset:_t,isSDFIcon:Nt,iconTextFit:Wt})}return{featureData:de,sizes:R,hasAnySecondaryIcon:ae,textAlongLine:G,symbolPlacement:re}},r.fa=JE,r.fb=function(o,e,i,l,c,d,p,v,w,S){const{featureData:I,hasAnySecondaryIcon:C,sizes:R,textAlongLine:B,symbolPlacement:N}=e;for(const $ of I){const{shapedIcon:X,verticallyShapedIcon:K,feature:le,shapedTextOrientations:re,shapedText:G,layoutTextSize:ne,textOffset:ae,isSDFIcon:de,iconPrimary:be,iconSecondary:Ie,iconTextFit:Me,iconOffset:ke}=$;aA(X,S.iconPositions,be,Ie),aA(K,S.iconPositions,be,Ie),lk(re,S.iconPositions),(G||X)&&uk(o,le,re,X,K,w,R,ne,0,ae,de,l,c,p,v,C,Me,ke,B,N)}i&&o.generateCollisionDebugBuffers(d,o.collisionBoxArray,R.textScaleFactor)},r.fc=Lc,r.fd=H0,r.fe=uu,r.ff=PS,r.fg=LE,r.fh=Ts,r.fi=function(o){let e=0;if(new Uint32Array(o,0,1)[0]!==CI){const i=new Uint32Array(o,0,7),[,,l,c,d,p]=i;e=i.byteLength+c+d+p+d,(l!==o.byteLength||e>=o.byteLength)&&Dn("Invalid b3dm header information.")}return DI(o,e)},r.fj=function(o,e){const i=kI(o);for(const l of i){for(const c of l.meshes)N4(c);l.lights&&(l.lightMeshIndex=l.meshes.length,l.meshes.push(V4(l.lights,e)))}return i},r.fk=B0,r.fl=Ti,r.fm=XA,r.fn=Yo,r.fo=function(o){Zs(),Ho!=null&&Ho.then(e=>{e.keys().then(i=>{for(let l=0;l<i.length-o;l++)e.delete(i[l]).catch(c=>Dn(c.message))}).catch(i=>Dn(i.message))}).catch(e=>Dn(e.message))},r.g=function(o,e){return Ql($e(o,{method:"GET"}),e)},r.h=Ss,r.i=function(o){return Or.API_STYLE_REGEX.test(o)&&!nl(o)},r.j=function(o){return decodeURIComponent(atob(o).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},r.k=function(o){return btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},r.l=$e,r.m=Qd,r.n=function(o,e){return Ql($e(o,{type:"json"}),e)},r.o=tc,r.p=function(o,e){return Ql($e(o,{method:"POST"}),e)},r.q=rs,r.r=Fr,r.s=function(o){try{const e=self[o];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},r.t=Yd,r.u=function(){return function o(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,o)}()},r.v=function(o){return!!o&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(o)},r.w=Dn,r.x=function(){return mb||(mb=new ah),mb},r.y=xb,r.z=np}),x(["./shared"],function(r){function P(Ke){const W=Ke?Ke.url.toString():void 0;return W?performance.getEntriesByName(W):[]}function M(Ke){if(typeof Ke=="number"||typeof Ke=="boolean"||typeof Ke=="string"||Ke==null)return JSON.stringify(Ke);if(Array.isArray(Ke)){let ie="[";for(const ge of Ke)ie+=`${M(ge)},`;return`${ie}]`}let W="{";for(const ie of Object.keys(Ke).sort())W+=`${ie}:${M(Ke[ie])},`;return`${W}}`}function L(Ke){let W="";for(const ie of r.bu)(Ke.type!=="model"||ie!=="minzoom"&&ie!=="maxzoom")&&(W+=`/${M(Ke[ie])}`);return W}class V{constructor(W){this.keyCache={},this._layers={},this._layerConfigs={},W&&this.replace(W)}replace(W,ie){this._layerConfigs={},this._layers={},this.update(W,[],ie)}update(W,ie,ge){this._options=ge;for(const Se of W)this._layerConfigs[Se.id]=Se,(this._layers[Se.id]=r.dc(Se,this.scope,null,this._options)).compileFilter(ge),this.keyCache[Se.id]&&delete this.keyCache[Se.id];for(const Se of ie)delete this.keyCache[Se],delete this._layerConfigs[Se],delete this._layers[Se];this.familiesBySource={};const Ee=function(Se,Ce){const ze={};for(let He=0;He<Se.length;He++){const it=Se[He];let $e=Ce&&Ce[it.id];$e||(it.type==="symbol"?$e=it.id:($e=L(it),it.type==="line"&&it.paint&&function kt(Zt){return typeof Zt=="string"&&Zt==="line-progress"||(Array.isArray(Zt)?Zt.some(kt):!(!Zt||typeof Zt!="object")&&Object.values(Zt).some(kt))}(it.paint["line-width"])&&($e+=`/${M(it.paint["line-width"])}`))),Ce&&(Ce[it.id]=$e);let Et=ze[$e];Et||(Et=ze[$e]=[]),Et.push(it)}const Re=[];for(const He in ze)Re.push(ze[He]);return Re}(Object.values(this._layerConfigs),this.keyCache);for(const Se of Ee){const Ce=Se.map(Et=>this._layers[Et.id]),ze=Ce[0];if(ze.visibility==="none")continue;const Re=ze.source||"";let He=this.familiesBySource[Re];He||(He=this.familiesBySource[Re]={});const it=ze.sourceLayer||"_geojsonTileLayer";let $e=He[it];$e||($e=He[it]=[]),$e.push(Ce)}}}const k=1*r.e_;class j{constructor(W){const ie={},ge=[];for(const ze in W){const Re=W[ze],He=ie[ze]={};for(const it in Re.glyphs){const $e=Re.glyphs[+it];if(!$e||$e.bitmap.width===0||$e.bitmap.height===0)continue;const Et=$e.metrics.localGlyph?k:1,kt={x:0,y:0,w:$e.bitmap.width+2*Et,h:$e.bitmap.height+2*Et};ge.push(kt),He[it]=kt}}const{w:Ee,h:Se}=r.H(ge),Ce=new r.eZ({width:Ee||1,height:Se||1});for(const ze in W){const Re=W[ze];for(const He in Re.glyphs){const it=Re.glyphs[+He];if(!it||it.bitmap.width===0||it.bitmap.height===0)continue;const $e=ie[ze][He],Et=it.metrics.localGlyph?k:1;r.eZ.copy(it.bitmap,Ce,{x:0,y:0},{x:$e.x+Et,y:$e.y+Et},it.bitmap)}}this.image=Ce,this.positions=ie}}r.eY(j,"GlyphAtlas");class te{constructor(W){this.tileID=new r.aM(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.tileZoom=W.tileZoom,this.uid=W.uid,this.zoom=W.zoom,this.lut=W.lut,this.canonical=W.tileID.canonical,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.scope=W.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=W.showCollisionBoxes,this.collectResourceTiming=!!W.request&&W.request.collectResourceTiming,this.promoteId=W.promoteId,this.isSymbolTile=W.isSymbolTile,this.tileTransform=r.aW(W.tileID.canonical,W.projection),this.projection=W.projection,this.worldview=W.worldview,this.localizableLayerIds=W.localizableLayerIds,this.brightness=W.brightness,this.extraShadowCaster=!!W.extraShadowCaster,this.tessellationStep=W.tessellationStep,this.scaleFactor=W.scaleFactor}parse(W,ie,ge,Ee,Se,Ce){this.status="parsing",this.data=W,this.collisionBoxArray=new r.b0;const ze=new r.e$(Object.keys(W.layers).sort()),Re=new r.f0(this.tileID,this.promoteId);Re.bucketLayerIDs=[];const He={},it=new r.f1(256,256),$e={featureIndex:Re,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:it,availableImages:ge,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Et=ie.familiesBySource[this.source];for(const Xn in Et){const gi=W.layers[Xn];if(!gi)continue;let Ti=!1,er=!1,hr=!1;for(const jr of Et[Xn])jr[0].type==="symbol"?Ti=!0:er=!0,jr[0].is3D()&&jr[0].type!=="model"&&(hr=!0);if(this.extraShadowCaster&&!hr||this.isSymbolTile===!0&&!Ti||this.isSymbolTile===!1&&!er)continue;gi.version===1&&r.w(`Vector tile source "${this.source}" layer "${Xn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const br=ze.encode(Xn),Dr=[];let Gs=!1;for(let jr=0,$r=0;jr<gi.length;jr++){const Mr=gi.feature(jr),Or=Re.getId(Mr,Xn);if(this.localizableLayerIds&&this.localizableLayerIds.has(Xn)){const Ss=Mr.properties?Mr.properties.worldview:null;if(this.worldview&&typeof Ss=="string")if(Ss==="all")Mr.properties.$localized=!0;else{if(!Ss.split(",").includes(this.worldview))continue;Mr.properties.$localized=!0,Mr.properties.worldview=this.worldview}}!Gs&&Mr.properties&&Mr.properties.hasOwnProperty(r.f2)&&(Gs=!0),Dr.push({feature:Mr,id:Or,index:$r,sourceLayerIndex:br}),$r++}Gs&&!$e.elevationFeatures&&W.layers.hasOwnProperty(r.f3)&&($e.elevationFeatures=r.f4.parseFrom(W.layers[r.f3],this.canonical));for(const jr of Et[Xn]){const $r=jr[0];(!this.extraShadowCaster||$r.is3D()&&$r.type!=="model")&&(this.isSymbolTile!==void 0&&$r.type==="symbol"!==this.isSymbolTile||$r.minzoom&&this.zoom<Math.floor($r.minzoom)||$r.maxzoom&&this.zoom>=$r.maxzoom||$r.visibility!=="none"&&(J(jr,this.zoom,$e.brightness,ge),(He[$r.id]=$r.createBucket({index:Re.bucketLayerIDs.length,layers:jr,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:br,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:Ee})).populate(Dr,$e,this.tileID.canonical,this.tileTransform),Re.bucketLayerIDs.push(jr.map(Mr=>r.C(Mr.id,Mr.scope)))))}}let kt,Zt,un,_n,An,zn;it.trim();const qi={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Dn=()=>{if(kt)return this.status="done",Ce(kt);if(this.extraShadowCaster)this.status="done",Ce(null,{buckets:Object.values(He).filter(Xn=>!Xn.isEmpty()),featureIndex:Re,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:$e.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Zt&&un&&_n){const Xn=new j(Zt),gi=new Map;for(const[hr,br]of un.entries()){const{imagePosition:Dr}=r.f7(hr,br,r.f8);gi.set(hr,Dr)}const Ti={};for(const hr in He){const br=He[hr];br instanceof r.b1&&(J(br.layers,this.zoom,$e.brightness,ge),Ti[hr]=r.f9(br,Zt,Xn.positions,un,gi,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,An))}const er={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Se,un,An,()=>{er.iconsPending=!1,_i(Ti,Xn,er)}),this.rasterizeIfNeeded(Se,_n,zn,()=>{er.patternsPending=!1,_i(Ti,Xn,er)})}},_i=(Xn,gi,Ti,er)=>{if(Ti.iconsPending||Ti.patternsPending)return;const hr=new r.fa(un,_n,this.lut);for(const br in He){const Dr=He[br];if(br in Xn)r.fb(Dr,Xn[br],this.showCollisionBoxes,ge,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,un,hr);else if(Dr.hasPattern&&(Dr instanceof r.b7||Dr instanceof r.b8||Dr instanceof r.dV)){J(Dr.layers,this.zoom,$e.brightness,ge);const Gs=Object.fromEntries(hr.patternPositions);Dr.addFeatures($e,this.tileID.canonical,Gs,ge,this.tileTransform,this.brightness)}}this.status="done",Ce(null,{buckets:Object.values(He).filter(br=>!br.isEmpty()),featureIndex:Re,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:gi.image,lineAtlas:it,imageAtlas:hr,brightness:$e.brightness})};if(!this.extraShadowCaster){const Xn=r.f5($e.glyphDependencies,er=>Object.keys(er).map(Number));Object.keys(Xn).length?Se.send("getGlyphs",{uid:this.uid,stacks:Xn,scope:this.scope},(er,hr)=>{kt||(kt=er,Zt=hr,Dn())},void 0,!1,qi):Zt={};const gi=Array.from($e.iconDependencies.keys()).map(er=>r.I.parse(er));gi.length?Se.send("getImages",{images:gi,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(er,hr)=>{kt||(kt=er,un=new Map,An=this.updateImageMapAndGetImageTaskQueue(un,hr,$e.iconDependencies),Dn())},void 0,!1,qi):(un=new Map,An=new Map);const Ti=Array.from($e.patternDependencies.keys()).map(er=>r.I.parse(er));Ti.length?Se.send("getImages",{images:Ti,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(er,hr)=>{kt||(kt=er,_n=new Map,zn=this.updateImageMapAndGetImageTaskQueue(_n,hr,$e.patternDependencies),Dn())},void 0,!1,qi):(_n=new Map,zn=new Map)}if($e.elevationFeatures&&$e.elevationFeatures.length>0){const Xn=[];for(const Ti of Object.values(He))if(Ti instanceof r.b8){const er=Ti.getUnevaluatedPortalGraph();er&&Xn.push(er)}const gi=r.f6.evaluate(Xn);for(const Ti of Object.values(He))Ti instanceof r.b8&&Ti.setEvaluatedPortalGraph(gi)}Dn()}rasterizeIfNeeded(W,ie,ge,Ee){Array.from(ie.values()).some(Se=>Se.usvg)?this.rasterize(W,ie,ge,Ee):Ee()}updateImageMapAndGetImageTaskQueue(W,ie,ge){const Ee=new Map;for(const Se of ie.keys()){const Ce=ge.get(Se)||[];for(const ze of Ce){const Re=ze.toString(),He=ie.get(ze.id.toString());He.usvg?Ee.has(Re)||(Ee.set(Re,ze),W.set(Re,Object.assign({},He))):W.set(Re,He)}}return Ee}rasterize(W,ie,ge,Ee){this.rasterizeTask=W.send("rasterizeImages",{scope:this.scope,tasks:ge},(Se,Ce)=>{if(!Se)for(const[ze,Re]of Ce.entries()){const He=Object.assign(ie.get(ze),{data:Re});ie.set(ze,He)}Ee()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function J(Ke,W,ie,ge){const Ee=new r.aa(W,{brightness:ie});for(const Se of Ke)Se.recalculate(Ee,ge)}class Q extends r.E{constructor(W,ie,ge,Ee,Se,Ce,ze){super(),this.actor=W,this.layerIndex=ie,this.availableImages=ge,this.availableModels=Ee,this.loadVectorData=Ce||r.aJ,this.loading={},this.loaded={},this.deduped=new r.aI(W.scheduler),this.isSpriteLoaded=Se,this.scheduler=W.scheduler,this.brightness=ze}loadTile(W,ie){const ge=W.uid,Ee=W&&W.request,Se=Ee&&Ee.collectResourceTiming,Ce=this.loading[ge]=new te(W);Ce.abort=this.loadVectorData(W,(ze,Re)=>{const He=!this.loading[ge];if(delete this.loading[ge],Ce.cancelRasterize(),He||ze||!Re)return Ce.status="done",He||(this.loaded[ge]=Ce),ie(ze);const it=Re.rawData,$e={};Re.expires&&($e.expires=Re.expires),Re.cacheControl&&($e.cacheControl=Re.cacheControl),Ce.vectorTile=Re.vectorTile||new r.fc.VectorTile(new r.bq(it));const Et=()=>{Ce.parse(Ce.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(kt,Zt)=>{if(kt||!Zt)return ie(kt);const un={};if(Se){const _n=P(Ee);_n.length>0&&(un.resourceTiming=JSON.parse(JSON.stringify(_n)))}ie(null,r.l({rawTileData:it.slice(0)},Zt,$e,un))})};this.isSpriteLoaded?Et():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Et,{type:"parseTile",isSymbolTile:W.isSymbolTile,zoom:W.tileZoom}):Et()}),this.loaded=this.loaded||{},this.loaded[ge]=Ce})}reloadTile(W,ie){const ge=this.loaded,Ee=W.uid;if(ge&&ge[Ee]){const Se=ge[Ee];Se.scaleFactor=W.scaleFactor,Se.showCollisionBoxes=W.showCollisionBoxes,Se.projection=W.projection,Se.brightness=W.brightness,Se.tileTransform=r.aW(W.tileID.canonical,W.projection),Se.extraShadowCaster=W.extraShadowCaster,Se.lut=W.lut;const Ce=(ze,Re)=>{const He=Se.reloadCallback;He&&(delete Se.reloadCallback,Se.parse(Se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,He)),ie(ze,Re)};Se.status==="parsing"?Se.reloadCallback=Ce:Se.status==="done"&&(Se.vectorTile?Se.parse(Se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ce):Ce())}else ie(null,void 0)}abortTile(W,ie){const ge=W.uid,Ee=this.loading[ge];Ee&&(Ee.abort&&Ee.abort(),delete this.loading[ge]),ie()}removeTile(W,ie){const ge=this.loaded,Ee=W.uid;ge&&ge[Ee]&&delete ge[Ee],ie()}}class ee{loadTile(W,ie){const{uid:ge,encoding:Ee,rawImageData:Se,padding:Ce}=W,ze=ImageBitmap&&Se instanceof ImageBitmap?this.getImageData(Se,Ce):Se;ie(null,new r.fd(ge,ze,Ee,Ce<1))}reloadTile(W,ie){ie(null,null)}abortTile(W,ie){ie()}removeTile(W,ie){ie()}getImageData(W,ie){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(W.width,W.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=W.width,this.offscreenCanvas.height=W.height,this.offscreenCanvasContext.drawImage(W,0,0,W.width,W.height);const ge=this.offscreenCanvasContext.getImageData(-ie,-ie,W.width+2*ie,W.height+2*ie);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ge}}r.bp.setPbf(r.bq);class ue{constructor(W){this._mrt=new r.bp(W.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=W.uid,this.tileID=W.tileID,this.source=W.source}parse(W,ie){const ge=this._mrt;this.status="parsing",this._entireBuffer=W;try{ge.parseHeader(W),this._isHeaderLoaded=!0;const Ee=[];for(const Se in ge.layers){const Ce=ge.getLayer(Se),ze=Ce.getDataRange(Ce.getBandList()),Re=ge.createDecodingTask(ze),He=W.slice(ze.firstByte,ze.lastByte+1),it=r.bp.performDecoding(He,Re).then($e=>Re.complete(null,$e)).catch($e=>Re.complete($e,null));Ee.push(it)}Promise.allSettled(Ee).then(()=>ie(null,ge)).catch(Se=>ie(Se))}catch(Ee){ie(Ee)}}}class ce{constructor(W){this.actor=W,this.loading={},this.loaded={}}loadTile(W,ie){const ge=W.uid,Ee=W.request,Se=this.loading[ge]=new ue(W),{cancel:Ce}=r.br(Ee,(ze,Re,He,it)=>{const $e=!this.loading[ge];if(delete this.loading[ge],$e||ze||!Re)return Se.status="done",$e||(this.loaded[ge]=Se),ie(ze);Se.parse(Re,(Et,kt)=>{if(Et||!kt)return ie(Et);ie(null,kt,He,it)}),this.loaded[ge]=Se});Se.abort=Ce}reloadTile(W,ie){ie(null,void 0)}abortTile(W,ie){const ge=W.uid,Ee=this.loading[ge];Ee&&(Ee.abort&&Ee.abort(),delete this.loading[ge]),ie()}removeTile(W,ie){const ge=W.uid;this.loaded[ge]&&delete this.loaded[ge],ie()}decodeRasterArray(W,ie){r.bp.performDecoding(W.buffer,W.task).then(ge=>ie(null,ge)).catch(ge=>ie(ge))}}const se=r.fc.VectorTileFeature.prototype.toGeoJSON;class Ae{constructor(W){this._feature=W,this.extent=r.aj,this.type=W.type,this.properties=W.tags,"id"in W&&!isNaN(W.id)&&(this.id=parseInt(W.id,10))}loadGeometry(){if(this._feature.type===1){const W=[];for(const ie of this._feature.geometry)W.push([new r.P(ie[0],ie[1])]);return W}{const W=[];for(const ie of this._feature.geometry){const ge=[];for(const Ee of ie)ge.push(new r.P(Ee[0],Ee[1]));W.push(ge)}return W}}toGeoJSON(W,ie,ge){return se.call(this,W,ie,ge)}}class De{constructor(W){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=r.aj,this.length=W.length,this._features=W}feature(W){return new Ae(this._features[W])}}const Qe=64/4096,nt=128;class rt{constructor(){this.features=new Map}clear(){this.features.clear()}load(W=[],ie){for(const ge of W){const Ee=ge.id;if(Ee==null)continue;let Se=this.features.get(Ee);Se&&this.updateCache(Se,ie),ge.geometry?(Se=Be(ge),this.updateCache(Se,ie),this.features.set(Ee,Se)):this.features.delete(Ee),this.updateCache(Se,ie)}}updateCache(W,ie){for(const{canonical:ge,uid:Ee}of Object.values(ie)){const{z:Se,x:Ce,y:ze}=ge;tt(W,Math.pow(2,Se),Ce,ze)&&delete ie[Ee]}}getTile(W,ie,ge){const Ee=Math.pow(2,W),Se=[];for(const Ce of this.features.values())tt(Ce,Ee,ie,ge)&&Se.push(Ve(Ce,Ee,ie,ge));return{features:Se}}getFeatures(){return[...this.features.values()]}}function tt({minX:Ke,minY:W,maxX:ie,maxY:ge},Ee,Se,Ce){return Ke<(Se+1+Qe)/Ee&&W<(Ce+1+Qe)/Ee&&ie>(Se-Qe)/Ee&&ge>(Ce-Qe)/Ee}function Be(Ke){const{id:W,geometry:ie,properties:ge}=Ke;if(!ie)return;if(ie.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Ee,coordinates:Se}=ie,Ce={id:W,type:1,geometry:[],tags:ge,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ze=Ce.geometry;if(Ee==="Point")Rt(Se,ze,Ce);else if(Ee==="MultiPoint")for(const Re of Se)Rt(Re,ze,Ce);else if(Ee==="LineString")Ce.type=2,ut(Se,ze,Ce);else if(Ee==="MultiLineString")Ce.type=2,Pe(Se,ze,Ce);else if(Ee==="Polygon")Ce.type=3,Pe(Se,ze,Ce,!0);else{if(Ee!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Ce.type=3;for(const Re of Se)Pe(Re,ze,Ce,!0)}return Ce}function Rt([Ke,W],ie,ge){const Ee=r.ay(Ke);let Se=r.aH(W);Se=Se<0?0:Se>1?1:Se,ie.push(Ee,Se),ge.minX=Math.min(ge.minX,Ee),ge.minY=Math.min(ge.minY,Se),ge.maxX=Math.max(ge.maxX,Ee),ge.maxY=Math.max(ge.maxY,Se)}function ut(Ke,W,ie,ge=!1,Ee=!1){const Se=[];for(const Ce of Ke)Rt(Ce,Se,ie);W.push(Se),ge&&function(Ce,ze){let Re=0;for(let He=0,it=Ce.length,$e=it-2;He<it;$e=He,He+=2)Re+=(Ce[He]-Ce[$e])*(Ce[He+1]+Ce[$e+1]);if(Re>0===ze)for(let He=0,it=Ce.length;He<it/2;He+=2){const $e=Ce[He],Et=Ce[He+1];Ce[He]=Ce[it-2-He],Ce[He+1]=Ce[it-1-He],Ce[it-2-He]=$e,Ce[it-1-He]=Et}}(Se,Ee)}function Pe(Ke,W,ie,ge=!1){for(let Ee=0;Ee<Ke.length;Ee++)ut(Ke[Ee],W,ie,ge,Ee===0)}function Ve(Ke,W,ie,ge){const{id:Ee,type:Se,geometry:Ce,tags:ze}=Ke,Re=[];if(Se===1)(function(He,it,$e,Et,kt){for(let Zt=0;Zt<He.length;Zt+=2){const un=Math.round(r.aj*(He[Zt+0]*it-$e)),_n=Math.round(r.aj*(He[Zt+1]*it-Et));kt.push([un,_n])}})(Ce,W,ie,ge,Re);else for(const He of Ce)qe(He,W,ie,ge,Re);return{id:Ee,type:Se,geometry:Re,tags:ze}}function qe(Ke,W,ie,ge,Ee){const Ce=r.aj+nt;let ze;for(let Re=0;Re<Ke.length-2;Re+=2){let He=Math.round(r.aj*(Ke[Re+0]*W-ie)),it=Math.round(r.aj*(Ke[Re+1]*W-ge)),$e=Math.round(r.aj*(Ke[Re+2]*W-ie)),Et=Math.round(r.aj*(Ke[Re+3]*W-ge));const kt=$e-He,Zt=Et-it;He<-128&&$e<-128||(He<-128?(it+=Math.round(Zt*((-128-He)/kt)),He=-128):$e<-128&&(Et=it+Math.round(Zt*((-128-He)/kt)),$e=-128),it<-128&&Et<-128||(it<-128?(He+=Math.round(kt*((-128-it)/Zt)),it=-128):Et<-128&&($e=He+Math.round(kt*((-128-it)/Zt)),Et=-128),He>=Ce&&$e>=Ce||(He>=Ce?(it+=Math.round(Zt*((Ce-He)/kt)),He=Ce):$e>=Ce&&(Et=it+Math.round(Zt*((Ce-He)/kt)),$e=Ce),it>=Ce&&Et>=Ce||(it>=Ce?(He+=Math.round(kt*((Ce-it)/Zt)),it=Ce):Et>=Ce&&($e=He+Math.round(kt*((Ce-it)/Zt)),Et=Ce),ze&&He===ze[ze.length-1][0]&&it===ze[ze.length-1][1]||(ze=[[He,it]],Ee.push(ze)),ze.push([$e,Et])))))}}var bt,Ht,Dt,Lt={exports:{}},rn=function(){if(Dt)return Lt.exports;Dt=1;var Ke=r.fg(),W=function(){if(Ht)return bt;Ht=1;var it=r.fe(),$e=r.ff().VectorTileFeature;function Et(Zt,un){this.options=un||{},this.features=Zt,this.length=Zt.length}function kt(Zt,un){this.id=typeof Zt.id=="number"?Zt.id:void 0,this.type=Zt.type,this.rawGeometry=Zt.type===1?[Zt.geometry]:Zt.geometry,this.properties=Zt.tags,this.extent=un||4096}return bt=Et,Et.prototype.feature=function(Zt){return new kt(this.features[Zt],this.options.extent)},kt.prototype.loadGeometry=function(){var Zt=this.rawGeometry;this.geometry=[];for(var un=0;un<Zt.length;un++){for(var _n=Zt[un],An=[],zn=0;zn<_n.length;zn++)An.push(new it(_n[zn][0],_n[zn][1]));this.geometry.push(An)}return this.geometry},kt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Zt=this.geometry,un=1/0,_n=-1/0,An=1/0,zn=-1/0,qi=0;qi<Zt.length;qi++)for(var Dn=Zt[qi],_i=0;_i<Dn.length;_i++){var Xn=Dn[_i];un=Math.min(un,Xn.x),_n=Math.max(_n,Xn.x),An=Math.min(An,Xn.y),zn=Math.max(zn,Xn.y)}return[un,An,_n,zn]},kt.prototype.toGeoJSON=$e.prototype.toGeoJSON,bt}();function ie(it){var $e=new Ke;return function(Et,kt){for(var Zt in Et.layers)kt.writeMessage(3,ge,Et.layers[Zt])}(it,$e),$e.finish()}function ge(it,$e){var Et;$e.writeVarintField(15,it.version||1),$e.writeStringField(1,it.name||""),$e.writeVarintField(5,it.extent||4096);var kt={keys:[],values:[],keycache:{},valuecache:{}};for(Et=0;Et<it.length;Et++)kt.feature=it.feature(Et),$e.writeMessage(2,Ee,kt);var Zt=kt.keys;for(Et=0;Et<Zt.length;Et++)$e.writeStringField(3,Zt[Et]);var un=kt.values;for(Et=0;Et<un.length;Et++)$e.writeMessage(4,He,un[Et])}function Ee(it,$e){var Et=it.feature;Et.id!==void 0&&$e.writeVarintField(1,Et.id),$e.writeMessage(2,Se,it),$e.writeVarintField(3,Et.type),$e.writeMessage(4,Re,Et)}function Se(it,$e){var Et=it.feature,kt=it.keys,Zt=it.values,un=it.keycache,_n=it.valuecache;for(var An in Et.properties){var zn=Et.properties[An],qi=un[An];if(zn!==null){qi===void 0&&(kt.push(An),un[An]=qi=kt.length-1),$e.writeVarint(qi);var Dn=typeof zn;Dn!=="string"&&Dn!=="boolean"&&Dn!=="number"&&(zn=JSON.stringify(zn));var _i=Dn+":"+zn,Xn=_n[_i];Xn===void 0&&(Zt.push(zn),_n[_i]=Xn=Zt.length-1),$e.writeVarint(Xn)}}}function Ce(it,$e){return($e<<3)+(7&it)}function ze(it){return it<<1^it>>31}function Re(it,$e){for(var Et=it.loadGeometry(),kt=it.type,Zt=0,un=0,_n=Et.length,An=0;An<_n;An++){var zn=Et[An],qi=1;kt===1&&(qi=zn.length),$e.writeVarint(Ce(1,qi));for(var Dn=kt===3?zn.length-1:zn.length,_i=0;_i<Dn;_i++){_i===1&&kt!==1&&$e.writeVarint(Ce(2,Dn-1));var Xn=zn[_i].x-Zt,gi=zn[_i].y-un;$e.writeVarint(ze(Xn)),$e.writeVarint(ze(gi)),Zt+=Xn,un+=gi}kt===3&&$e.writeVarint(Ce(7,1))}}function He(it,$e){var Et=typeof it;Et==="string"?$e.writeStringField(1,it):Et==="boolean"?$e.writeBooleanField(7,it):Et==="number"&&(it%1!=0?$e.writeDoubleField(3,it):it<0?$e.writeSVarintField(6,it):$e.writeVarintField(5,it))}return Lt.exports=ie,Lt.exports.fromVectorTileJs=ie,Lt.exports.fromGeojsonVt=function(it,$e){$e=$e||{};var Et={};for(var kt in it)Et[kt]=new W(it[kt].features,$e),Et[kt].name=kt,Et[kt].version=$e.version,Et[kt].extent=$e.extent;return ie({layers:Et})},Lt.exports.GeoJSONWrapper=W,Lt.exports}(),yn=r.fh(rn);const pi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ke=>Ke},ti=Math.fround||(hn=new Float32Array(1),Ke=>(hn[0]=+Ke,hn[0]));var hn;const Nn=3,Pn=5,Gi=6;class Ct{constructor(W){this.options=Object.assign(Object.create(pi),W),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(W){const{log:ie,minZoom:ge,maxZoom:Ee}=this.options;ie&&console.time("total time");const Se=`prepare ${W.length} points`;ie&&console.time(Se),this.points=W;const Ce=[];for(let Re=0;Re<W.length;Re++){const He=W[Re];if(!He.geometry)continue;const[it,$e]=He.geometry.coordinates,Et=ti(It(it)),kt=ti(dn($e));Ce.push(Et,kt,1/0,Re,-1,1),this.options.reduce&&Ce.push(0)}let ze=this.trees[Ee+1]=this._createTree(Ce);ie&&console.timeEnd(Se);for(let Re=Ee;Re>=ge;Re--){const He=+Date.now();ze=this.trees[Re]=this._createTree(this._cluster(ze,Re)),ie&&console.log("z%d: %d clusters in %dms",Re,ze.numItems,+Date.now()-He)}return ie&&console.timeEnd("total time"),this}getClusters(W,ie){let ge=((W[0]+180)%360+360)%360-180;const Ee=Math.max(-90,Math.min(90,W[1]));let Se=W[2]===180?180:((W[2]+180)%360+360)%360-180;const Ce=Math.max(-90,Math.min(90,W[3]));if(W[2]-W[0]>=360)ge=-180,Se=180;else if(ge>Se){const $e=this.getClusters([ge,Ee,180,Ce],ie),Et=this.getClusters([-180,Ee,Se,Ce],ie);return $e.concat(Et)}const ze=this.trees[this._limitZoom(ie)],Re=ze.range(It(ge),dn(Ce),It(Se),dn(Ee)),He=ze.data,it=[];for(const $e of Re){const Et=this.stride*$e;it.push(He[Et+Pn]>1?fn(He,Et,this.clusterProps):this.points[He[Et+Nn]])}return it}getChildren(W){const ie=this._getOriginId(W),ge=this._getOriginZoom(W),Ee="No cluster with the specified id.",Se=this.trees[ge];if(!Se)throw new Error(Ee);const Ce=Se.data;if(ie*this.stride>=Ce.length)throw new Error(Ee);const ze=this.options.radius/(this.options.extent*Math.pow(2,ge-1)),Re=Se.within(Ce[ie*this.stride],Ce[ie*this.stride+1],ze),He=[];for(const it of Re){const $e=it*this.stride;Ce[$e+4]===W&&He.push(Ce[$e+Pn]>1?fn(Ce,$e,this.clusterProps):this.points[Ce[$e+Nn]])}if(He.length===0)throw new Error(Ee);return He}getLeaves(W,ie,ge){const Ee=[];return this._appendLeaves(Ee,W,ie=ie||10,ge=ge||0,0),Ee}getTile(W,ie,ge){const Ee=this.trees[this._limitZoom(W)],Se=Math.pow(2,W),{extent:Ce,radius:ze}=this.options,Re=ze/Ce,He=(ge-Re)/Se,it=(ge+1+Re)/Se,$e={features:[]};return this._addTileFeatures(Ee.range((ie-Re)/Se,He,(ie+1+Re)/Se,it),Ee.data,ie,ge,Se,$e),ie===0&&this._addTileFeatures(Ee.range(1-Re/Se,He,1,it),Ee.data,Se,ge,Se,$e),ie===Se-1&&this._addTileFeatures(Ee.range(0,He,Re/Se,it),Ee.data,-1,ge,Se,$e),$e.features.length?$e:null}getClusterExpansionZoom(W){let ie=this._getOriginZoom(W)-1;for(;ie<=this.options.maxZoom;){const ge=this.getChildren(W);if(ie++,ge.length!==1)break;W=ge[0].properties.cluster_id}return ie}_appendLeaves(W,ie,ge,Ee,Se){const Ce=this.getChildren(ie);for(const ze of Ce){const Re=ze.properties;if(Re&&Re.cluster?Se+Re.point_count<=Ee?Se+=Re.point_count:Se=this._appendLeaves(W,Re.cluster_id,ge,Ee,Se):Se<Ee?Se++:W.push(ze),W.length===ge)break}return Se}_createTree(W){const ie=new r.bW(W.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ge=0;ge<W.length;ge+=this.stride)ie.add(W[ge],W[ge+1]);return ie.finish(),ie.data=W,ie}_addTileFeatures(W,ie,ge,Ee,Se,Ce){for(const ze of W){const Re=ze*this.stride,He=ie[Re+Pn]>1;let it,$e,Et;if(He)it=Tn(ie,Re,this.clusterProps),$e=ie[Re],Et=ie[Re+1];else{const un=this.points[ie[Re+Nn]];it=un.properties;const[_n,An]=un.geometry.coordinates;$e=It(_n),Et=dn(An)}const kt={type:1,geometry:[[Math.round(this.options.extent*($e*Se-ge)),Math.round(this.options.extent*(Et*Se-Ee))]],tags:it};let Zt;Zt=He||this.options.generateId?ie[Re+Nn]:this.points[ie[Re+Nn]].id,Zt!==void 0&&(kt.id=Zt),Ce.features.push(kt)}}_limitZoom(W){return Math.max(this.options.minZoom,Math.min(Math.floor(+W),this.options.maxZoom+1))}_cluster(W,ie){const{radius:ge,extent:Ee,reduce:Se,minPoints:Ce}=this.options,ze=ge/(Ee*Math.pow(2,ie)),Re=W.data,He=[],it=this.stride;for(let $e=0;$e<Re.length;$e+=it){if(Re[$e+2]<=ie)continue;Re[$e+2]=ie;const Et=Re[$e],kt=Re[$e+1],Zt=W.within(Re[$e],Re[$e+1],ze),un=Re[$e+Pn];let _n=un;for(const An of Zt){const zn=An*it;Re[zn+2]>ie&&(_n+=Re[zn+Pn])}if(_n>un&&_n>=Ce){let An,zn=Et*un,qi=kt*un,Dn=-1;const _i=($e/it<<5)+(ie+1)+this.points.length;for(const Xn of Zt){const gi=Xn*it;if(Re[gi+2]<=ie)continue;Re[gi+2]=ie;const Ti=Re[gi+Pn];zn+=Re[gi]*Ti,qi+=Re[gi+1]*Ti,Re[gi+4]=_i,Se&&(An||(An=this._map(Re,$e,!0),Dn=this.clusterProps.length,this.clusterProps.push(An)),Se(An,this._map(Re,gi)))}Re[$e+4]=_i,He.push(zn/_n,qi/_n,1/0,_i,-1,_n),Se&&He.push(Dn)}else{for(let An=0;An<it;An++)He.push(Re[$e+An]);if(_n>1)for(const An of Zt){const zn=An*it;if(!(Re[zn+2]<=ie)){Re[zn+2]=ie;for(let qi=0;qi<it;qi++)He.push(Re[zn+qi])}}}}return He}_getOriginId(W){return W-this.points.length>>5}_getOriginZoom(W){return(W-this.points.length)%32}_map(W,ie,ge){if(W[ie+Pn]>1){const Ce=this.clusterProps[W[ie+Gi]];return ge?Object.assign({},Ce):Ce}const Ee=this.points[W[ie+Nn]].properties,Se=this.options.map(Ee);return ge&&Se===Ee?Object.assign({},Se):Se}}function fn(Ke,W,ie){return{type:"Feature",id:Ke[W+Nn],properties:Tn(Ke,W,ie),geometry:{type:"Point",coordinates:[(ge=Ke[W],360*(ge-.5)),$n(Ke[W+1])]}};var ge}function Tn(Ke,W,ie){const ge=Ke[W+Pn],Ee=ge>=1e4?`${Math.round(ge/1e3)}k`:ge>=1e3?Math.round(ge/100)/10+"k":ge,Se=Ke[W+Gi],Ce=Se===-1?{}:Object.assign({},ie[Se]);return Object.assign(Ce,{cluster:!0,cluster_id:Ke[W+Nn],point_count:ge,point_count_abbreviated:Ee})}function It(Ke){return Ke/360+.5}function dn(Ke){const W=Math.sin(Ke*Math.PI/180),ie=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return ie<0?0:ie>1?1:ie}function $n(Ke){const W=(180-360*Ke)*Math.PI/180;return 360*Math.atan(Math.exp(W))/Math.PI-90}function Qi(Ke,W,ie,ge){let Ee=ge;const Se=W+(ie-W>>1);let Ce,ze=ie-W;const Re=Ke[W],He=Ke[W+1],it=Ke[ie],$e=Ke[ie+1];for(let Et=W+3;Et<ie;Et+=3){const kt=bi(Ke[Et],Ke[Et+1],Re,He,it,$e);if(kt>Ee)Ce=Et,Ee=kt;else if(kt===Ee){const Zt=Math.abs(Et-Se);Zt<ze&&(Ce=Et,ze=Zt)}}Ee>ge&&(Ce-W>3&&Qi(Ke,W,Ce,ge),Ke[Ce+2]=Ee,ie-Ce>3&&Qi(Ke,Ce,ie,ge))}function bi(Ke,W,ie,ge,Ee,Se){let Ce=Ee-ie,ze=Se-ge;if(Ce!==0||ze!==0){const Re=((Ke-ie)*Ce+(W-ge)*ze)/(Ce*Ce+ze*ze);Re>1?(ie=Ee,ge=Se):Re>0&&(ie+=Ce*Re,ge+=ze*Re)}return Ce=Ke-ie,ze=W-ge,Ce*Ce+ze*ze}function vn(Ke,W,ie,ge){const Ee={id:Ke??null,type:W,geometry:ie,tags:ge,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(W==="Point"||W==="MultiPoint"||W==="LineString")wi(Ee,ie);else if(W==="Polygon")wi(Ee,ie[0]);else if(W==="MultiLineString")for(const Se of ie)wi(Ee,Se);else if(W==="MultiPolygon")for(const Se of ie)wi(Ee,Se[0]);return Ee}function wi(Ke,W){for(let ie=0;ie<W.length;ie+=3)Ke.minX=Math.min(Ke.minX,W[ie]),Ke.minY=Math.min(Ke.minY,W[ie+1]),Ke.maxX=Math.max(Ke.maxX,W[ie]),Ke.maxY=Math.max(Ke.maxY,W[ie+1])}function tr(Ke,W,ie,ge){if(!W.geometry)return;const Ee=W.geometry.coordinates;if(Ee&&Ee.length===0)return;const Se=W.geometry.type,Ce=Math.pow(ie.tolerance/((1<<ie.maxZoom)*ie.extent),2);let ze=[],Re=W.id;if(ie.promoteId?Re=W.properties[ie.promoteId]:ie.generateId&&(Re=ge||0),Se==="Point")yr(Ee,ze);else if(Se==="MultiPoint")for(const He of Ee)yr(He,ze);else if(Se==="LineString")da(Ee,ze,Ce,!1);else if(Se==="MultiLineString"){if(ie.lineMetrics){for(const He of Ee)ze=[],da(He,ze,Ce,!1),Ke.push(vn(Re,"LineString",ze,W.properties));return}Us(Ee,ze,Ce,!1)}else if(Se==="Polygon")Us(Ee,ze,Ce,!0);else{if(Se!=="MultiPolygon"){if(Se==="GeometryCollection"){for(const He of W.geometry.geometries)tr(Ke,{id:Re,geometry:He,properties:W.properties},ie,ge);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const He of Ee){const it=[];Us(He,it,Ce,!0),ze.push(it)}}Ke.push(vn(Re,Se,ze,W.properties))}function yr(Ke,W){W.push(Ka(Ke[0]),so(Ke[1]),0)}function da(Ke,W,ie,ge){let Ee,Se,Ce=0;for(let Re=0;Re<Ke.length;Re++){const He=Ka(Ke[Re][0]),it=so(Ke[Re][1]);W.push(He,it,0),Re>0&&(Ce+=ge?(Ee*it-He*Se)/2:Math.sqrt(Math.pow(He-Ee,2)+Math.pow(it-Se,2))),Ee=He,Se=it}const ze=W.length-3;W[2]=1,Qi(W,0,ze,ie),W[ze+2]=1,W.size=Math.abs(Ce),W.start=0,W.end=W.size}function Us(Ke,W,ie,ge){for(let Ee=0;Ee<Ke.length;Ee++){const Se=[];da(Ke[Ee],Se,ie,ge),W.push(Se)}}function Ka(Ke){return Ke/360+.5}function so(Ke){const W=Math.sin(Ke*Math.PI/180),ie=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return ie<0?0:ie>1?1:ie}function Io(Ke,W,ie,ge,Ee,Se,Ce,ze){if(ge/=W,Se>=(ie/=W)&&Ce<ge)return Ke;if(Ce<ie||Se>=ge)return null;const Re=[];for(const He of Ke){const it=He.geometry;let $e=He.type;const Et=Ee===0?He.minX:He.minY,kt=Ee===0?He.maxX:He.maxY;if(Et>=ie&&kt<ge){Re.push(He);continue}if(kt<ie||Et>=ge)continue;let Zt=[];if($e==="Point"||$e==="MultiPoint")au(it,Zt,ie,ge,Ee);else if($e==="LineString")Ja(it,Zt,ie,ge,Ee,!1,ze.lineMetrics);else if($e==="MultiLineString")bs(it,Zt,ie,ge,Ee,!1);else if($e==="Polygon")bs(it,Zt,ie,ge,Ee,!0);else if($e==="MultiPolygon")for(const un of it){const _n=[];bs(un,_n,ie,ge,Ee,!0),_n.length&&Zt.push(_n)}if(Zt.length){if(ze.lineMetrics&&$e==="LineString"){for(const un of Zt)Re.push(vn(He.id,$e,un,He.tags));continue}$e!=="LineString"&&$e!=="MultiLineString"||(Zt.length===1?($e="LineString",Zt=Zt[0]):$e="MultiLineString"),$e!=="Point"&&$e!=="MultiPoint"||($e=Zt.length===3?"Point":"MultiPoint"),Re.push(vn(He.id,$e,Zt,He.tags))}}return Re.length?Re:null}function au(Ke,W,ie,ge,Ee){for(let Se=0;Se<Ke.length;Se+=3){const Ce=Ke[Se+Ee];Ce>=ie&&Ce<=ge&&js(W,Ke[Se],Ke[Se+1],Ke[Se+2])}}function Ja(Ke,W,ie,ge,Ee,Se,Ce){let ze=Xl(Ke);const Re=Ee===0?ao:Qa;let He,it,$e=Ke.start;for(let _n=0;_n<Ke.length-3;_n+=3){const An=Ke[_n],zn=Ke[_n+1],qi=Ke[_n+2],Dn=Ke[_n+3],_i=Ke[_n+4],Xn=Ee===0?An:zn,gi=Ee===0?Dn:_i;let Ti=!1;Ce&&(He=Math.sqrt(Math.pow(An-Dn,2)+Math.pow(zn-_i,2))),Xn<ie?gi>ie&&(it=Re(ze,An,zn,Dn,_i,ie),Ce&&(ze.start=$e+He*it)):Xn>ge?gi<ge&&(it=Re(ze,An,zn,Dn,_i,ge),Ce&&(ze.start=$e+He*it)):js(ze,An,zn,qi),gi<ie&&Xn>=ie&&(it=Re(ze,An,zn,Dn,_i,ie),Ti=!0),gi>ge&&Xn<=ge&&(it=Re(ze,An,zn,Dn,_i,ge),Ti=!0),!Se&&Ti&&(Ce&&(ze.end=$e+He*it),W.push(ze),ze=Xl(Ke)),Ce&&($e+=He)}let Et=Ke.length-3;const kt=Ke[Et],Zt=Ke[Et+1],un=Ee===0?kt:Zt;un>=ie&&un<=ge&&js(ze,kt,Zt,Ke[Et+2]),Et=ze.length-3,Se&&Et>=3&&(ze[Et]!==ze[0]||ze[Et+1]!==ze[1])&&js(ze,ze[0],ze[1],ze[2]),ze.length&&W.push(ze)}function Xl(Ke){const W=[];return W.size=Ke.size,W.start=Ke.start,W.end=Ke.end,W}function bs(Ke,W,ie,ge,Ee,Se){for(const Ce of Ke)Ja(Ce,W,ie,ge,Ee,Se,!1)}function js(Ke,W,ie,ge){Ke.push(W,ie,ge)}function ao(Ke,W,ie,ge,Ee,Se){const Ce=(Se-W)/(ge-W);return js(Ke,Se,ie+(Ee-ie)*Ce,1),Ce}function Qa(Ke,W,ie,ge,Ee,Se){const Ce=(Se-ie)/(Ee-ie);return js(Ke,W+(ge-W)*Ce,Se,1),Ce}function pa(Ke,W){const ie=[];for(let ge=0;ge<Ke.length;ge++){const Ee=Ke[ge],Se=Ee.type;let Ce;if(Se==="Point"||Se==="MultiPoint"||Se==="LineString")Ce=ws(Ee.geometry,W);else if(Se==="MultiLineString"||Se==="Polygon"){Ce=[];for(const ze of Ee.geometry)Ce.push(ws(ze,W))}else if(Se==="MultiPolygon"){Ce=[];for(const ze of Ee.geometry){const Re=[];for(const He of ze)Re.push(ws(He,W));Ce.push(Re)}}ie.push(vn(Ee.id,Se,Ce,Ee.tags))}return ie}function ws(Ke,W){const ie=[];ie.size=Ke.size,Ke.start!==void 0&&(ie.start=Ke.start,ie.end=Ke.end);for(let ge=0;ge<Ke.length;ge+=3)ie.push(Ke[ge]+W,Ke[ge+1],Ke[ge+2]);return ie}function el(Ke,W){if(Ke.transformed)return Ke;const ie=1<<Ke.z,ge=Ke.x,Ee=Ke.y;for(const Se of Ke.features){const Ce=Se.geometry,ze=Se.type;if(Se.geometry=[],ze===1)for(let Re=0;Re<Ce.length;Re+=2)Se.geometry.push(tl(Ce[Re],Ce[Re+1],W,ie,ge,Ee));else for(let Re=0;Re<Ce.length;Re++){const He=[];for(let it=0;it<Ce[Re].length;it+=2)He.push(tl(Ce[Re][it],Ce[Re][it+1],W,ie,ge,Ee));Se.geometry.push(He)}}return Ke.transformed=!0,Ke}function tl(Ke,W,ie,ge,Ee,Se){return[Math.round(ie*(Ke*ge-Ee)),Math.round(ie*(W*ge-Se))]}function lu(Ke,W,ie,ge,Ee){const Se=W===Ee.maxZoom?0:Ee.tolerance/((1<<W)*Ee.extent),Ce={features:[],numPoints:0,numSimplified:0,numFeatures:Ke.length,source:null,x:ie,y:ge,z:W,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ze of Ke)Bi(Ce,ze,Se,Ee);return Ce}function Bi(Ke,W,ie,ge){const Ee=W.geometry,Se=W.type,Ce=[];if(Ke.minX=Math.min(Ke.minX,W.minX),Ke.minY=Math.min(Ke.minY,W.minY),Ke.maxX=Math.max(Ke.maxX,W.maxX),Ke.maxY=Math.max(Ke.maxY,W.maxY),Se==="Point"||Se==="MultiPoint")for(let ze=0;ze<Ee.length;ze+=3)Ce.push(Ee[ze],Ee[ze+1]),Ke.numPoints++,Ke.numSimplified++;else if(Se==="LineString")Ts(Ce,Ee,Ke,ie,!1,!1);else if(Se==="MultiLineString"||Se==="Polygon")for(let ze=0;ze<Ee.length;ze++)Ts(Ce,Ee[ze],Ke,ie,Se==="Polygon",ze===0);else if(Se==="MultiPolygon")for(let ze=0;ze<Ee.length;ze++){const Re=Ee[ze];for(let He=0;He<Re.length;He++)Ts(Ce,Re[He],Ke,ie,!0,He===0)}if(Ce.length){let ze=W.tags||null;if(Se==="LineString"&&ge.lineMetrics){ze={};for(const He in W.tags)ze[He]=W.tags[He];ze.mapbox_clip_start=Ee.start/Ee.size,ze.mapbox_clip_end=Ee.end/Ee.size}const Re={geometry:Ce,type:Se==="Polygon"||Se==="MultiPolygon"?3:Se==="LineString"||Se==="MultiLineString"?2:1,tags:ze};W.id!==null&&(Re.id=W.id),Ke.features.push(Re)}}function Ts(Ke,W,ie,ge,Ee,Se){const Ce=ge*ge;if(ge>0&&W.size<(Ee?Ce:ge))return void(ie.numPoints+=W.length/3);const ze=[];for(let Re=0;Re<W.length;Re+=3)(ge===0||W[Re+2]>Ce)&&(ie.numSimplified++,ze.push(W[Re],W[Re+1])),ie.numPoints++;Ee&&function(Re,He){let it=0;for(let $e=0,Et=Re.length,kt=Et-2;$e<Et;kt=$e,$e+=2)it+=(Re[$e]-Re[kt])*(Re[$e+1]+Re[kt+1]);if(it>0===He)for(let $e=0,Et=Re.length;$e<Et/2;$e+=2){const kt=Re[$e],Zt=Re[$e+1];Re[$e]=Re[Et-2-$e],Re[$e+1]=Re[Et-1-$e],Re[Et-2-$e]=kt,Re[Et-1-$e]=Zt}}(ze,Se),Ke.push(ze)}const Yl={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class qo{constructor(W,ie){const ge=(ie=this.options=function(Se,Ce){for(const ze in Ce)Se[ze]=Ce[ze];return Se}(Object.create(Yl),ie)).debug;if(ge&&console.time("preprocess data"),ie.maxZoom<0||ie.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(ie.promoteId&&ie.generateId)throw new Error("promoteId and generateId cannot be used together.");let Ee=function(Se,Ce){const ze=[];if(Se.type==="FeatureCollection")for(let Re=0;Re<Se.features.length;Re++)tr(ze,Se.features[Re],Ce,Re);else tr(ze,Se.type==="Feature"?Se:{geometry:Se},Ce);return ze}(W,ie);this.tiles={},this.tileCoords=[],ge&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",ie.indexMaxZoom,ie.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Ee=function(Se,Ce){const ze=Ce.buffer/Ce.extent;let Re=Se;const He=Io(Se,1,-1-ze,ze,0,-1,2,Ce),it=Io(Se,1,1-ze,2+ze,0,-1,2,Ce);return(He||it)&&(Re=Io(Se,1,-ze,1+ze,0,-1,2,Ce)||[],He&&(Re=pa(He,1).concat(Re)),it&&(Re=Re.concat(pa(it,-1)))),Re}(Ee,ie),Ee.length&&this.splitTile(Ee,0,0,0),ge&&(Ee.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(W,ie,ge,Ee,Se,Ce,ze){const Re=[W,ie,ge,Ee],He=this.options,it=He.debug;for(;Re.length;){Ee=Re.pop(),ge=Re.pop(),ie=Re.pop(),W=Re.pop();const $e=1<<ie,Et=cu(ie,ge,Ee);let kt=this.tiles[Et];if(!kt&&(it>1&&console.time("creation"),kt=this.tiles[Et]=lu(W,ie,ge,Ee,He),this.tileCoords.push({z:ie,x:ge,y:Ee}),it)){it>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",ie,ge,Ee,kt.numFeatures,kt.numPoints,kt.numSimplified),console.timeEnd("creation"));const Ti=`z${ie}`;this.stats[Ti]=(this.stats[Ti]||0)+1,this.total++}if(kt.source=W,Se==null){if(ie===He.indexMaxZoom||kt.numPoints<=He.indexMaxPoints)continue}else{if(ie===He.maxZoom||ie===Se)continue;if(Se!=null){const Ti=Se-ie;if(ge!==Ce>>Ti||Ee!==ze>>Ti)continue}}if(kt.source=null,W.length===0)continue;it>1&&console.time("clipping");const Zt=.5*He.buffer/He.extent,un=.5-Zt,_n=.5+Zt,An=1+Zt;let zn=null,qi=null,Dn=null,_i=null,Xn=Io(W,$e,ge-Zt,ge+_n,0,kt.minX,kt.maxX,He),gi=Io(W,$e,ge+un,ge+An,0,kt.minX,kt.maxX,He);W=null,Xn&&(zn=Io(Xn,$e,Ee-Zt,Ee+_n,1,kt.minY,kt.maxY,He),qi=Io(Xn,$e,Ee+un,Ee+An,1,kt.minY,kt.maxY,He),Xn=null),gi&&(Dn=Io(gi,$e,Ee-Zt,Ee+_n,1,kt.minY,kt.maxY,He),_i=Io(gi,$e,Ee+un,Ee+An,1,kt.minY,kt.maxY,He),gi=null),it>1&&console.timeEnd("clipping"),Re.push(zn||[],ie+1,2*ge,2*Ee),Re.push(qi||[],ie+1,2*ge,2*Ee+1),Re.push(Dn||[],ie+1,2*ge+1,2*Ee),Re.push(_i||[],ie+1,2*ge+1,2*Ee+1)}}getTile(W,ie,ge){W=+W,ie=+ie,ge=+ge;const Ee=this.options,{extent:Se,debug:Ce}=Ee;if(W<0||W>24)return null;const ze=1<<W,Re=cu(W,ie=ie+ze&ze-1,ge);if(this.tiles[Re])return el(this.tiles[Re],Se);Ce>1&&console.log("drilling down to z%d-%d-%d",W,ie,ge);let He,it=W,$e=ie,Et=ge;for(;!He&&it>0;)it--,$e>>=1,Et>>=1,He=this.tiles[cu(it,$e,Et)];return He&&He.source?(Ce>1&&(console.log("found parent tile z%d-%d-%d",it,$e,Et),console.time("drilling down")),this.splitTile(He.source,it,$e,Et,W,ie,ge),Ce>1&&console.timeEnd("drilling down"),this.tiles[Re]?el(this.tiles[Re],Se):null):null}}function cu(Ke,W,ie){return 32*((1<<Ke)*ie+W)+Ke}function Bh(Ke,W){const ie=Ke.tileID.canonical;if(!this._geoJSONIndex)return void W(null,null);const ge=this._geoJSONIndex.getTile(ie.z,ie.x,ie.y);if(!ge)return void W(null,null);const Ee=new De(ge.features);let Se=yn(Ee);Se.byteOffset===0&&Se.byteLength===Se.buffer.byteLength||(Se=new Uint8Array(Se)),W(null,{vectorTile:Ee,rawData:Se.buffer})}class uu extends Q{constructor(W,ie,ge,Ee,Se,Ce,ze){super(W,ie,ge,Ee,Se,Bh,ze),Ce&&(this.loadGeoJSON=Ce),this._dynamicIndex=new rt}loadData(W,ie){const ge=W&&W.request,Ee=ge&&ge.collectResourceTiming;this.loadGeoJSON(W,(Se,Ce)=>{if(Se||!Ce)return ie(Se);if(typeof Ce!="object")return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`));{try{if(W.filter){const Re=r.X(W.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Re.result==="error")throw new Error(Re.value.map(He=>`${He.key}: ${He.message}`).join(", "));Ce.features=Ce.features.filter(He=>Re.value.evaluate({zoom:0},He))}W.dynamic?(Ce.type==="Feature"&&(Ce={type:"FeatureCollection",features:[Ce]}),W.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Ce.features,this.loaded),W.cluster&&(Ce.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=W.cluster?new Ct(function({superclusterOptions:Re,clusterProperties:He}){if(!He||!Re)return Re;const it={},$e={},Et={accumulated:null,zoom:0},kt={properties:null},Zt=Object.keys(He);for(const un of Zt){const[_n,An]=He[un],zn=r.X(An),qi=r.X(typeof _n=="string"?[_n,["accumulated"],["get",un]]:_n);it[un]=zn.value,$e[un]=qi.value}return Re.map=un=>{kt.properties=un;const _n={};for(const An of Zt)_n[An]=it[An].evaluate(Et,kt);return _n},Re.reduce=(un,_n)=>{kt.properties=_n;for(const An of Zt)Et.accumulated=un[An],un[An]=$e[An].evaluate(Et,kt)},Re}(W)).load(Ce.features):W.dynamic?this._dynamicIndex:function(Re,He){return new qo(Re,He)}(Ce,W.geojsonVtOptions)}catch(Re){return ie(Re)}const ze={};if(Ee){const Re=P(ge);Re&&(ze.resourceTiming={},ze.resourceTiming[W.source]=JSON.parse(JSON.stringify(Re)))}ie(null,ze)}})}reloadTile(W,ie){const ge=this.loaded;return ge&&ge[W.uid]?W.partial?ie(null,void 0):super.reloadTile(W,ie):this.loadTile(W,ie)}loadGeoJSON(W,ie){if(W.request)r.n(W.request,ie);else{if(typeof W.data!="string")return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`));try{return ie(null,JSON.parse(W.data))}catch{return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(W,ie){try{ie(null,this._geoJSONIndex.getClusterExpansionZoom(W.clusterId))}catch(ge){ie(ge)}}getClusterChildren(W,ie){try{ie(null,this._geoJSONIndex.getChildren(W.clusterId))}catch(ge){ie(ge)}}getClusterLeaves(W,ie){try{ie(null,this._geoJSONIndex.getLeaves(W.clusterId,W.limit,W.offset))}catch(ge){ie(ge)}}}class St{constructor(W,ie){this.tileID=new r.aM(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.tileZoom=W.tileZoom,this.uid=W.uid,this.zoom=W.zoom,this.canonical=W.tileID.canonical,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=W.projection,this.brightness=ie}parse(W,ie,ge,Ee){this.status="parsing";const Se=new r.aM(ge.tileID.overscaledZ,ge.tileID.wrap,ge.tileID.canonical.z,ge.tileID.canonical.x,ge.tileID.canonical.y),Ce=[],ze=ie.familiesBySource[ge.source],Re=new r.f0(Se,ge.promoteId);Re.bucketLayerIDs=[],Re.is3DTile=!0,r.fi(W).then(He=>{if(!He)return Ee(new Error("Could not parse tile"));const it=r.fj(He,1/r.cT(ge.tileID.canonical)),$e=He.json.extensionsUsed&&He.json.extensionsUsed.includes("MAPBOX_mesh_features")||He.json.asset.extras&&He.json.asset.extras.MAPBOX_mesh_features,Et=He.json.extensionsUsed&&He.json.extensionsUsed.includes("EXT_meshopt_compression"),kt=new r.aa(this.zoom,{brightness:this.brightness});for(const Zt in ze)for(const un of ze[Zt]){const _n=un[0];Re.bucketLayerIDs.push(un.map(zn=>r.C(zn.id,zn.scope))),_n.recalculate(kt,[]);const An=new r.fk(un,it,Se,$e,Et,this.brightness,Re);$e||(An.needsUpload=!0),Ce.push(An),An.evaluate(_n)}this.status="done",Ee(null,{buckets:Ce,featureIndex:Re,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(He=>Ee(new Error(He.message)))}}class $s{constructor(W,ie,ge,Ee,Se,Ce,ze){this.actor=W,this.layerIndex=ie,this.availableImages=ge,this.availableModels=Ee,this.brightness=ze,this.loading={},this.loaded={}}loadTile(W,ie){const ge=W.uid,Ee=this.loading[ge]=new St(W,this.brightness);r.br(W.request,(Se,Ce)=>{const ze=!this.loading[ge];return delete this.loading[ge],ze||Se?(Ee.status="done",ze||(this.loaded[ge]=Ee),ie(Se)):Ce&&Ce.byteLength!==0?void Ee.parse(Ce,this.layerIndex,W,(Re,He)=>{Ee.status="done",this.loaded=this.loaded||{},this.loaded[ge]=Ee,Re||!He?ie(Re):ie(null,He)}):(Ee.status="done",this.loaded[ge]=Ee,ie())})}reloadTile(W,ie){const ge=this.loaded,Ee=W.uid;if(ge&&ge[Ee]){const Se=ge[Ee];Se.projection=W.projection,Se.brightness=W.brightness;const Ce=(ze,Re)=>{Se.reloadCallback&&(delete Se.reloadCallback,this.loadTile(W,ie)),ie(ze,Re)};Se.status==="parsing"?Se.reloadCallback=Ce:Se.status==="done"&&this.loadTile(W,ie)}}abortTile(W,ie){const ge=W.uid;this.loading[ge]&&delete this.loading[ge],ie()}removeTile(W,ie){const ge=this.loaded,Ee=W.uid;ge&&ge[Ee]&&delete ge[Ee],ie()}}class Nh{constructor(W){this.self=W,this.actor=new r.fm(W,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new r.y,this.projections={},this.defaultProjection=r.ce({name:"mercator"}),this.workerSourceTypes={vector:Q,geojson:uu,"raster-dem":ee,"raster-array":ce,"batched-model":$s},this.workerSources={},this.self.registerWorkerSource=(ie,ge)=>{if(this.workerSourceTypes[ie])throw new Error(`Worker source with name "${ie}" already registered.`);this.workerSourceTypes[ie]=ge},this.self.registerRTLTextPlugin=ie=>{if(r.fn.isParsed())throw new Error("RTL text plugin already registered.");r.fn.applyArabicShaping=ie.applyArabicShaping,r.fn.processBidirectionalText=ie.processBidirectionalText,r.fn.processStyledBidirectionalText=ie.processStyledBidirectionalText}}clearCaches(W,ie,ge){delete this.layerIndexes[W],delete this.availableImages[W],delete this.availableModels[W],delete this.workerSources[W],ge()}checkIfReady(W,ie,ge){ge()}setReferrer(W,ie){this.referrer=ie}spriteLoaded(W,ie){this.isSpriteLoaded[W]||(this.isSpriteLoaded[W]={});const{scope:ge,isLoaded:Ee}=ie;if(this.isSpriteLoaded[W][ge]=Ee,this.workerSources[W]&&this.workerSources[W][ge])for(const Se in this.workerSources[W][ge]){const Ce=this.workerSources[W][ge][Se];for(const ze in Ce){const Re=Ce[ze];Re instanceof Q&&(Re.isSpriteLoaded=Ee,Re.fire(new r.A("isSpriteLoaded")))}}}setImages(W,ie,ge){this.availableImages[W]||(this.availableImages[W]={});const{scope:Ee,images:Se}=ie;if(this.availableImages[W][Ee]=Se,this.workerSources[W]&&this.workerSources[W][Ee]){for(const Ce in this.workerSources[W][Ee]){const ze=this.workerSources[W][Ee][Ce];for(const Re in ze)ze[Re].availableImages=Se}ge()}else ge()}setModels(W,{scope:ie,models:ge},Ee){if(this.availableModels[W]||(this.availableModels[W]={}),this.availableModels[W][ie]=ge,this.workerSources[W]&&this.workerSources[W][ie]){for(const Se in this.workerSources[W][ie]){const Ce=this.workerSources[W][ie][Se];for(const ze in Ce)Ce[ze].availableModels=ge}Ee()}else Ee()}setProjection(W,ie){this.projections[W]=r.ce(ie)}setBrightness(W,ie,ge){this.brightness=ie,ge()}setLayers(W,ie,ge){this.getLayerIndex(W,ie.scope).replace(ie.layers,ie.options),ge()}updateLayers(W,ie,ge){this.getLayerIndex(W,ie.scope).update(ie.layers,ie.removedIds,ie.options),ge()}loadTile(W,ie,ge){ie.projection=this.projections[W]||this.defaultProjection,this.getWorkerSource(W,ie.type,ie.source,ie.scope).loadTile(ie,ge)}decodeRasterArray(W,ie,ge){this.getWorkerSource(W,ie.type,ie.source,ie.scope).decodeRasterArray(ie,ge)}reloadTile(W,ie,ge){ie.projection=this.projections[W]||this.defaultProjection,this.getWorkerSource(W,ie.type,ie.source,ie.scope).reloadTile(ie,ge)}abortTile(W,ie,ge){this.getWorkerSource(W,ie.type,ie.source,ie.scope).abortTile(ie,ge)}removeTile(W,ie,ge){this.getWorkerSource(W,ie.type,ie.source,ie.scope).removeTile(ie,ge)}removeSource(W,ie,ge){if(!(this.workerSources[W]&&this.workerSources[W][ie.scope]&&this.workerSources[W][ie.scope][ie.type]&&this.workerSources[W][ie.scope][ie.type][ie.source]))return;const Ee=this.workerSources[W][ie.scope][ie.type][ie.source];delete this.workerSources[W][ie.scope][ie.type][ie.source],Ee.removeSource!==void 0?Ee.removeSource(ie,ge):ge()}loadWorkerSource(W,ie,ge){try{this.self.importScripts(ie.url),ge()}catch(Ee){ge(Ee.toString())}}syncRTLPluginState(W,ie,ge){try{r.fn.setState(ie);const Ee=r.fn.getPluginURL();if(r.fn.isLoaded()&&!r.fn.isParsed()&&Ee!=null){this.self.importScripts(Ee);const Se=r.fn.isParsed();ge(Se?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Ee}`),Se)}}catch(Ee){ge(Ee.toString())}}setDracoUrl(W,ie){this.dracoUrl=ie}getAvailableImages(W,ie){this.availableImages[W]||(this.availableImages[W]={});let ge=this.availableImages[W][ie];return ge||(ge=[]),ge}getAvailableModels(W,ie){this.availableModels[W]||(this.availableModels[W]={});let ge=this.availableModels[W][ie];return ge||(ge={}),ge}getLayerIndex(W,ie){this.layerIndexes[W]||(this.layerIndexes[W]={});let ge=this.layerIndexes[W][ie];return ge||(ge=this.layerIndexes[W][ie]=new V,ge.scope=ie),ge}getWorkerSource(W,ie,ge,Ee){const Se=this.workerSources;return Se[W]||(Se[W]={}),Se[W][Ee]||(Se[W][Ee]={}),Se[W][Ee][ie]||(Se[W][Ee][ie]={}),this.isSpriteLoaded[W]||(this.isSpriteLoaded[W]={}),Se[W][Ee][ie][ge]||(Se[W][Ee][ie][ge]=new this.workerSourceTypes[ie]({send:(Ce,ze,Re,He,it,$e)=>this.actor.send(Ce,ze,Re,W,it,$e),scheduler:this.actor.scheduler},this.getLayerIndex(W,Ee),this.getAvailableImages(W,Ee),this.getAvailableModels(W,Ee),this.isSpriteLoaded[W][Ee],void 0,this.brightness)),Se[W][Ee][ie][ge]}rasterizeImagesWorker(W,ie,ge){const Ee=new Map;for(const[Se,{image:Ce,imageVariant:ze}]of ie.tasks.entries()){const Re=this.imageRasterizer.rasterize(ze,Ce,ie.scope,W);Ee.set(Se,Re)}ge(void 0,Ee)}removeRasterizedImages(W,ie,ge){this.imageRasterizer.removeImagesFromCacheByIds(ie.imageIds,ie.scope,W),ge()}enforceCacheSizeLimit(W,ie){r.fo(ie)}getWorkerPerformanceMetrics(W,ie,ge){ge(void 0,void 0)}}return r.fl(self)&&(self.worker=new Nh(self)),Nh}),x(["./shared"],function(r){var P="3.12.0";const M={create:"create",load:"load",fullLoad:"fullLoad"},L={mark(h){performance.mark(h)},measure(h,t,s){performance.measure(h,t,s)}};function V(h){const t=h.name.split("?")[0];return r.a(t)&&t.includes("mapbox-gl.js")?"javascript":r.a(t)&&t.includes("mapbox-gl.css")?"css":r.b(t)?"fontRange":r.c(t)?"sprite":r.i(t)?"style":r.d(t)?"tilejson":"other"}var k,j={},te=function(){if(k)return j;function h(f){return!t(f)}function t(f){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var g,b,T=new Blob([""],{type:"text/javascript"}),A=URL.createObjectURL(T);try{b=new Worker(A),g=!0}catch{g=!1}return b&&b.terminate(),URL.revokeObjectURL(A),g}()?function(){var g=document.createElement("canvas");g.width=g.height=1;var b=g.getContext("2d");if(!b)return!1;var T=b.getImageData(0,0,1,1);return T&&T.width===g.width}()?(s[_=f&&f.failIfMajorPerformanceCaveat]===void 0&&(s[_]=function(g){var b,T=function(A){var z=document.createElement("canvas"),D=Object.create(h.webGLContextAttributes);return D.failIfMajorPerformanceCaveat=A,z.getContext("webgl2",D)}(g);if(!T)return!1;try{b=T.createShader(T.VERTEX_SHADER)}catch{return!1}return!(!b||T.isContextLost())&&(T.shaderSource(b,"void main() {}"),T.compileShader(b),T.getShaderParameter(b,T.COMPILE_STATUS)===!0)}(_)),s[_]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var _}k=1,j.supported=h,j.notSupportedReason=t;var s={};return h.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},j}();function J(h,t,s){const f=document.createElement(h);return t!=null&&(f.className=t),s&&s.appendChild(f),f}function Q(h,t,s){const f=document.createElementNS("http://www.w3.org/2000/svg",h);for(const _ of Object.keys(t))f.setAttributeNS(null,_,String(t[_]));return s&&s.appendChild(f),f}const ee=typeof document<"u"?document.documentElement&&document.documentElement.style:null,ue=ee&&ee.userSelect!==void 0?"userSelect":"WebkitUserSelect";let ce;function se(){ee&&ue&&(ce=ee[ue],ee[ue]="none")}function Ae(){ee&&ue&&(ee[ue]=ce)}function De(h){h.preventDefault(),h.stopPropagation(),window.removeEventListener("click",De,!0)}function Qe(){window.addEventListener("click",De,!0),window.setTimeout(()=>{window.removeEventListener("click",De,!0)},0)}function nt(h,t){const s=h.getBoundingClientRect();return Be(h,s,t)}function rt(h,t){const s=h.getBoundingClientRect(),f=[];for(let _=0;_<t.length;_++)f.push(Be(h,s,t[_]));return f}function tt(h){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&h.button===2&&h.ctrlKey?0:h.button}function Be(h,t,s){const f=h.offsetWidth===t.width?1:h.offsetWidth/t.width;return new r.P((s.clientX-t.left)*f,(s.clientY-t.top)*f)}const Rt="01",ut="NO_ACCESS_TOKEN";class Pe{constructor(t,s,f){this._transformRequestFn=t,this._customAccessToken=s,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){const t=function(){let s="";for(let f=0;f<10;f++)s+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Rt,s].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,s){return this._transformRequestFn&&this._transformRequestFn(t,s)||{url:t}}normalizeStyleURL(t,s){if(!r.f(t))return t;const f=qe(t);return f.params.push(`sdk=js-${P}`),f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||s)}normalizeGlyphsURL(t,s){if(!r.f(t))return t;const f=qe(t);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||s)}normalizeModelURL(t,s){if(!r.f(t))return t;const f=qe(t);return f.path=`/models/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||s)}normalizeSourceURL(t,s,f,_){if(!r.f(t))return t;const g=qe(t);return g.path=`/v4/${g.authority}.json`,g.params.push("secure"),f&&g.params.push(`language=${f}`),_&&g.params.push(`worldview=${_}`),this._makeAPIURL(g,this._customAccessToken||s)}normalizeIconsetURL(t,s){const f=qe(t);return r.f(t)?(f.path=`/styles/v1${f.path}/iconset.pbf`,this._makeAPIURL(f,this._customAccessToken||s)):bt(f)}normalizeSpriteURL(t,s,f,_){const g=qe(t);return r.f(t)?(g.path=`/styles/v1${g.path}/sprite${s}${f}`,this._makeAPIURL(g,this._customAccessToken||_)):(g.path+=`${s}${f}`,bt(g))}normalizeTileURL(t,s,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!r.f(t))return t;const _=qe(t);_.path=_.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${s||f&&_.authority!=="raster"&&f===512?"@2x":""}${r.m.supported?".webp":"$1"}`),_.authority==="raster"?_.path=`/${r.e.RASTER_URL_PREFIX}${_.path}`:_.authority==="rasterarrays"?_.path=`/${r.e.RASTERARRAYS_URL_PREFIX}${_.path}`:_.authority==="3dtiles"?_.path=`/${r.e.TILES3D_URL_PREFIX}${_.path}`:(_.path=_.path.replace(/^.+\/v4\//,"/"),_.path=`/${r.e.TILE_URL_VERSION}${_.path}`);const g=this._customAccessToken||function(b){for(const T of b){const A=T.match(/^access_token=(.*)$/);if(A)return A[1]}return null}(_.params)||r.e.ACCESS_TOKEN;return r.e.REQUIRE_ACCESS_TOKEN&&g&&this._skuToken&&_.params.push(`sku=${this._skuToken}`),this._makeAPIURL(_,g)}canonicalizeTileURL(t,s){const f=qe(t);if(!f.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!f.path.match(/\.[\w]+$/))return t;let _="mapbox://";f.path.match(/^\/raster\/v1\//)?_+=`raster/${f.path.replace(`/${r.e.RASTER_URL_PREFIX}/`,"")}`:f.path.match(/^\/rasterarrays\/v1\//)?_+=`rasterarrays/${f.path.replace(`/${r.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:_+=`tiles/${f.path.replace(`/${r.e.TILE_URL_VERSION}/`,"")}`;let g=f.params;return s&&(g=g.filter(b=>!b.match(/^access_token=/))),g.length&&(_+=`?${g.join("&")}`),_}canonicalizeTileset(t,s){const f=!!s&&r.f(s),_=[];for(const g of t.tiles||[])r.h(g)?_.push(this.canonicalizeTileURL(g,f)):_.push(g);return _}_makeAPIURL(t,s){const f="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",_=qe(r.e.API_URL);if(t.protocol=_.protocol,t.authority=_.authority,t.protocol==="http"){const g=t.params.indexOf("secure");g>=0&&t.params.splice(g,1)}if(_.path!=="/"&&(t.path=`${_.path}${t.path}`),!r.e.REQUIRE_ACCESS_TOKEN)return bt(t);if(s=s||r.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!s)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(s[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return t.params=t.params.filter(g=>g.indexOf("access_token")===-1),t.params.push(`access_token=${s||""}`),bt(t)}}const Ve=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function qe(h){const t=h.match(Ve);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function bt(h){const t=h.params.length?`?${h.params.join("&")}`:"";return`${h.protocol}://${h.authority}${h.path}${t}`}const Ht="mapbox.eventData";function Dt(h){if(!h)return null;const t=h.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(r.j(t[1]))}catch{return null}}class Lt{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const s=Dt(r.e.ACCESS_TOKEN);let f="";return f=s&&s.u?r.k(s.u):r.e.ACCESS_TOKEN||"",t?`${Ht}.${t}:${f}`:`${Ht}:${f}`}fetchEventData(){const t=r.s("localStorage"),s=this.getStorageKey(),f=this.getStorageKey("uuid");if(t)try{const _=localStorage.getItem(s);_&&(this.eventData=JSON.parse(_));const g=localStorage.getItem(f);g&&(this.anonId=g)}catch{r.w("Unable to read from LocalStorage")}}saveEventData(){const t=r.s("localStorage"),s=this.getStorageKey(),f=this.getStorageKey("uuid"),_=this.anonId;if(t&&_)try{localStorage.setItem(f,_),Object.keys(this.eventData).length>=1&&localStorage.setItem(s,JSON.stringify(this.eventData))}catch{r.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,s,f,_){if(!r.e.EVENTS_URL)return;const g=qe(r.e.EVENTS_URL);g.params.push(`access_token=${_||r.e.ACCESS_TOKEN||""}`);const b={event:this.type,created:new Date(t).toISOString()},T=s?r.l(b,s):b,A={url:bt(g),headers:{"Content-Type":"text/plain"},body:JSON.stringify([T])};this.pendingRequest=r.p(A,z=>{this.pendingRequest=null,f(z),this.saveEventData(),this.processRequests(_)})}queueRequest(t,s){this.queue.push(t),this.processRequests(s)}}const rn=new class extends Lt{constructor(h){super("appUserTurnstile"),this._customAccessToken=h}postTurnstileEvent(h,t){r.e.EVENTS_URL&&r.e.ACCESS_TOKEN&&Array.isArray(h)&&h.some(s=>r.f(s)||r.h(s))&&this.queueRequest(Date.now(),t)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Dt(r.e.ACCESS_TOKEN),s=t?t.u:r.e.ACCESS_TOKEN;let f=s!==this.eventData.tokenU;r.v(this.anonId)||(this.anonId=r.u(),f=!0);const _=this.queue.shift();if(this.eventData.lastSuccess){const g=new Date(this.eventData.lastSuccess),b=new Date(_),T=(_-this.eventData.lastSuccess)/864e5;f=f||T>=1||T<-1||g.getDate()!==b.getDate()}else f=!0;f?this.postEvent(_,{sdkIdentifier:"mapbox-gl-js",sdkVersion:P,skuId:Rt,"enabled.telemetry":!1,userId:this.anonId},g=>{g||(this.eventData.lastSuccess=_,this.eventData.tokenU=s)},h):this.processRequests()}},yn=rn.postTurnstileEvent.bind(rn),pi=new class extends Lt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(h,t,s,f){this.skuToken=t,this.errorCb=f,r.e.EVENTS_URL&&(s||r.e.ACCESS_TOKEN?this.queueRequest({id:h,timestamp:Date.now()},s):this.errorCb(new Error(ut)))}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:s}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),r.v(this.anonId)||(this.anonId=r.u()),this.postEvent(s,{sdkIdentifier:"mapbox-gl-js",sdkVersion:P,skuId:Rt,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):t&&(this.success[t]=!0)},h))}remove(){this.errorCb=null}},ti=pi.postMapLoadEvent.bind(pi),hn=new class extends Lt{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(h){let t=this.mapInstanceIdMap.get(h);return t||(t=r.u(),this.mapInstanceIdMap.set(h,t)),t}getEventId(h){const t=this.eventIdPerMapInstanceMap.get(h)||0;return this.eventIdPerMapInstanceMap.set(h,t+1),t}postStyleLoadEvent(h,t){const{map:s,style:f,importedStyles:_}=t;if(!r.e.EVENTS_URL||!h&&!r.e.ACCESS_TOKEN)return;const g=this.getMapInstanceId(s),b={mapInstanceId:g,eventId:this.getEventId(g),style:f};_.length&&(b.importedStyles=_),this.queueRequest({timestamp:Date.now(),payload:b},h)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:s}=this.queue.shift();this.postEvent(t,s,()=>{},h)}},Nn=hn.postStyleLoadEvent.bind(hn),Pn=new class extends Lt{constructor(){super("gljs.performance")}postPerformanceEvent(h,t){r.e.EVENTS_URL&&(h||r.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},h)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:s}=this.queue.shift(),f=function(_){const g=performance.getEntriesByType("resource"),b=performance.getEntriesByType("mark"),T=function(U){const H={};if(U){for(const q in U)if(q!=="other")for(const Y of U[q]){const Z=`${q}ResolveRangeMin`,oe=`${q}ResolveRangeMax`,fe=`${q}RequestCount`,me=`${q}RequestCachedCount`;H[Z]=Math.min(H[Z]||1/0,Y.startTime),H[oe]=Math.max(H[oe]||-1/0,Y.responseEnd);const xe=ye=>{H[ye]===void 0&&(H[ye]=0),++H[ye]};Y.transferSize!==void 0&&Y.transferSize===0&&xe(me),xe(fe)}}return H}(function(U,H){const q={};if(U)for(const Y of U){const Z=H(Y);q[Z]===void 0&&(q[Z]=[]),q[Z].push(Y)}return q}(g,V)),A=window.devicePixelRatio,z=navigator.connection||navigator.mozConnection||navigator.webkitConnection,D=z?z.effectiveType:void 0,F={counters:[],metadata:[],attributes:[]},O=(U,H,q)=>{q!=null&&U.push({name:H,value:q.toString()})};for(const U in T)O(F.counters,U,T[U]);if(_.interactionRange[0]!==1/0&&_.interactionRange[1]!==-1/0&&(O(F.counters,"interactionRangeMin",_.interactionRange[0]),O(F.counters,"interactionRangeMax",_.interactionRange[1])),b)for(const U of Object.keys(M)){const H=M[U],q=b.find(Y=>Y.name===H);q&&O(F.counters,H,q.startTime)}return O(F.counters,"visibilityHidden",_.visibilityHidden),O(F.attributes,"style",function(U){if(U)for(const H of U){const q=H.name.split("?")[0];if(r.i(q)){const Y=q.split("/").slice(-2);if(Y.length===2)return`mapbox://styles/${Y[0]}/${Y[1]}`}}}(g)),O(F.attributes,"terrainEnabled",_.terrainEnabled?"true":"false"),O(F.attributes,"fogEnabled",_.fogEnabled?"true":"false"),O(F.attributes,"projection",_.projection),O(F.attributes,"zoom",_.zoom),O(F.metadata,"devicePixelRatio",A),O(F.metadata,"connectionEffectiveType",D),O(F.metadata,"navigatorUserAgent",navigator.userAgent),O(F.metadata,"screenWidth",window.screen.width),O(F.metadata,"screenHeight",window.screen.height),O(F.metadata,"windowWidth",window.innerWidth),O(F.metadata,"windowHeight",window.innerHeight),O(F.metadata,"mapWidth",_.width/A),O(F.metadata,"mapHeight",_.height/A),O(F.metadata,"webglRenderer",_.renderer),O(F.metadata,"webglVendor",_.vendor),O(F.metadata,"sdkVersion",P),O(F.metadata,"sdkIdentifier","mapbox-gl-js"),F}(s);for(const _ of f.metadata);for(const _ of f.counters);for(const _ of f.attributes);this.postEvent(t,f,()=>{},h)}},Gi=Pn.postPerformanceEvent.bind(Pn),Ct=new class extends Lt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(h,t,s,f){if(!r.e.API_URL||!r.e.SESSION_PATH)return;const _=qe(r.e.API_URL+r.e.SESSION_PATH);_.params.push(`sku=${t||""}`),_.params.push(`access_token=${f||r.e.ACCESS_TOKEN||""}`);const g={url:bt(_),headers:{"Content-Type":"text/plain"}};this.pendingRequest=r.g(g,b=>{this.pendingRequest=null,s(b),this.saveEventData(),this.processRequests(f)})}getSessionAPI(h,t,s,f){this.skuToken=t,this.errorCb=f,r.e.SESSION_PATH&&r.e.API_URL&&(s||r.e.ACCESS_TOKEN?this.queueRequest({id:h,timestamp:Date.now()},s):this.errorCb(new Error(ut)))}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:s}=this.queue.shift();t&&this.success[t]||this.getSession(s,this.skuToken,f=>{f?this.errorCb(f):t&&(this.success[t]=!0)},h)}remove(){this.errorCb=null}},fn=Ct.getSessionAPI.bind(Ct),Tn=new Set;function It(h,t){t?Tn.add(h):Tn.delete(h)}class dn{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,s){this._updatedSourceCaches[t]=s,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const s=t.scope;this._updatedLayers[s]=this._updatedLayers[s]||new Set,this._updatedLayers[s].add(t.id),this.setDirty()}removeLayer(t){const s=t.scope;this._removedLayers[s]=this._removedLayers[s]||{},this._updatedLayers[s]=this._updatedLayers[s]||new Set,this._removedLayers[s][t.id]=t,this._updatedLayers[s].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const s in this._updatedLayers)t[s]=t[s]||{},t[s].updatedIds=Array.from(this._updatedLayers[s].values());for(const s in this._removedLayers)t[s]=t[s]||{},t[s].removedIds=Object.keys(this._removedLayers[s]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,s){this._updatedImages[s]=this._updatedImages[s]||new Set,this._updatedImages[s].add(r.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function $n(h){const{userImage:t}=h;return!!(t&&t.render&&t.render())&&(h.data.replace(new Uint8Array(t.data.buffer)),!0)}class Qi extends r.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&r.t()&&(this.imageRasterizerDispatcher=new r.D(r.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new r.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const s=this.atlasTexture.get(t);s&&(s.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,s){this.imageProviders.has(s)||this.imageProviders.set(s,new Map),this.imageProviders.get(s).set(t.id,t)}removeImageProvider(t,s){this.imageProviders.has(s)&&this.imageProviders.get(s).delete(t)}getPendingImageProviders(){const t=[];for(const s of this.imageProviders.values())for(const f of s.values())f.hasPendingRequests()&&t.push(f);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new r.y),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,s){if(this.loaded.get(s)!==t&&(this.loaded.set(s,t),t)){for(const{ids:f,callback:_}of this.requestors)this._notify(f,s,_);this.requestors=[]}}hasImage(t,s){return!!this.getImage(t,s)}getImage(t,s){return this.images.get(s).get(t.toString())}addImage(t,s,f){this._validate(t,f)&&this.images.get(s).set(t.toString(),f)}_validate(t,s){let f=!0;return this._validateStretch(s.stretchX,s.data&&s.data.width)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),f=!1),this._validateStretch(s.stretchY,s.data&&s.data.height)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),f=!1),this._validateContent(s.content,s)||(this.fire(new r.z(new Error(`Image "${t.name}" has invalid "content" value`))),f=!1),f}_validateStretch(t,s){if(!t)return!0;let f=0;for(const _ of t){if(_[0]<f||_[1]<_[0]||s<_[1])return!1;f=_[1]}return!0}_validateContent(t,s){return t?t.length!==4||!s.usvg&&(t[0]<0||s.data.width<t[0]||t[1]<0||s.data.height<t[1]||t[2]<0||s.data.width<t[2]||t[3]<0||s.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,s,f){const _=this.images.get(s).get(t.toString());f.version=_.version+1,this.images.get(s).set(t.toString(),f),this.updatedImages.get(s).add(t),this.removeFromImageRasterizerCache(t,s)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,s){this.spriteFormat!=="raster"&&(r.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:s}):this.imageRasterizer.removeImagesFromCacheByIds([t],s))}removeImage(t,s){const f=this.images.get(s),_=f.get(t.toString());f.delete(t.toString()),this.patterns.get(s).delete(t.toString()),this.removeFromImageRasterizerCache(t,s),_.userImage&&_.userImage.onRemove&&_.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(s=>r.I.from(s))}getImages(t,s,f){const _=[],g=[],b=this.imageProviders.get(s);for(const D of t){if(!D.iconsetId){_.push(D);continue}const F=b.get(D.iconsetId);F&&(this.getImage(D,s)?g.push(D):F.addPendingRequest(D))}if(_.length===0)return void this._notify(g,s,f);let T=!0;const A=!!this.loaded.get(s),z=this.images.get(s);if(!A)for(const D of _)z.has(D.toString())||(T=!1);A||T?this._notify(_,s,f):this.requestors.push({ids:_,scope:s,callback:f})}rasterizeImages(t,s){const f=new Map,{tasks:_,scope:g}=t;for(const[b,T]of _.entries()){const A=this.getImage(T.id,g);A&&f.set(b,{image:A,imageVariant:T})}this._rasterizeImages(g,f,s)}_rasterizeImages(t,s,f){if(r.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:s,scope:t},f);else{const _=new Map;for(const[g,{image:b,imageVariant:T}]of s.entries())_.set(g,this.imageRasterizer.rasterize(T,b,t,0));f(void 0,_)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,s,f){const _=this.images.get(s),g=new Map;for(const b of t){if(!_.get(b.toString())){if(b.iconsetId)continue;this.fire(new r.A("styleimagemissing",{id:b.name}))}const T=_.get(b.toString());if(!T){r.w(`Image "${b.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const A={data:T.usvg?null:T.data.clone(),pixelRatio:T.pixelRatio,sdf:T.sdf,usvg:T.usvg,version:T.version,stretchX:T.stretchX,stretchY:T.stretchY,content:T.content,hasRenderCallback:!!(T.userImage&&T.userImage.render)};T.usvg&&Object.assign(A,{width:T.icon.usvg_tree.width,height:T.icon.usvg_tree.height}),g.set(r.I.toString(b),A)}f(null,g)}getPixelSize(t){const{width:s,height:f}=this.atlasImage.get(t);return{width:s,height:f}}getPattern(t,s,f){const _=t.toString(),g=this.patterns.get(s),b=g.get(_),T=this.getImage(t,s);if(!T)return null;if(b){if(b.position.version===T.version)return b.position;b.position.version=T.version}else{if(T.usvg&&!T.data){const A=this.getPatternInFlightId(_,s);if(this.patternsInFlight.has(A))return null;this.patternsInFlight.add(A);const z=new r.B(t).scaleSelf(r.q.devicePixelRatio),D=new Map([[z.toString(),{image:T,imageVariant:z}]]);return this._rasterizeImages(s,D,(F,O)=>this.storePatternImage(z,s,T,f,O)),null}this.storePattern(t,s,T)}return this._updatePatternAtlas(s,f),g.get(_).position}getPatternInFlightId(t,s){return r.C(t,s)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,s,f,_,g){const b=t.toString(),T=g?g.get(b):void 0;T&&(f.data=T,this.storePattern(t.id,s,f),this._updatePatternAtlas(s,_),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),s)))}storePattern(t,s,f){const _={w:f.data.width+2*r.F,h:f.data.height+2*r.F,x:0,y:0},g=new r.G(_,f,r.F);this.patterns.get(s).set(t.toString(),{bin:_,position:g})}bind(t,s){const f=t.gl;let _=this.atlasTexture.get(s);_?this.dirty&&(_.update(this.atlasImage.get(s)),this.dirty=!1):(_=new r.T(t,this.atlasImage.get(s),f.RGBA8),this.atlasTexture.set(s,_)),_.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(t,s){const f=this.patterns.get(t),_=Array.from(f.values()).map(({bin:z})=>z),{w:g,h:b}=r.H(_),T=this.atlasImage.get(t);T.resize({width:g||1,height:b||1});const A=this.images.get(t);for(const[z,{bin:D,position:F}]of f.entries()){let O=F.padding;const U=D.x+O,H=D.y+O,q=A.get(z).data,Y=q.width,Z=q.height;O=O>1?O-1:O,r.r.copy(q,T,{x:0,y:0},{x:U,y:H},{width:Y,height:Z},s),r.r.copy(q,T,{x:0,y:Z-O},{x:U,y:H-O},{width:Y,height:O},s),r.r.copy(q,T,{x:0,y:0},{x:U,y:H+Z},{width:Y,height:O},s),r.r.copy(q,T,{x:Y-O,y:0},{x:U-O,y:H},{width:O,height:Z},s),r.r.copy(q,T,{x:0,y:0},{x:U+Y,y:H},{width:O,height:Z},s),r.r.copy(q,T,{x:Y-O,y:Z-O},{x:U-O,y:H-O},{width:O,height:O},s),r.r.copy(q,T,{x:0,y:Z-O},{x:U+Y,y:H-O},{width:O,height:O},s),r.r.copy(q,T,{x:0,y:0},{x:U+Y,y:H+Z},{width:O,height:O},s),r.r.copy(q,T,{x:Y-O,y:0},{x:U-O,y:H+Z},{width:O,height:O},s)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,s){const f=this.images.get(s);for(const _ of t){if(this.callbackDispatchedThisFrame.get(s).has(_.toString()))continue;this.callbackDispatchedThisFrame.get(s).add(_.toString());const g=f.get(_.toString());$n(g)&&this.updateImage(_,s,g)}}}function bi(h){const t=h.key,s=h.value,f=h.valueSpec||{},_=h.objectElementValidators||{},g=h.style,b=h.styleSpec;let T=[];const A=r.K(s);if(A!=="object")return[new r.V(t,s,`object expected, ${A} found`)];for(const z in s){const D=z.split(".")[0];let F;_[D]?F=_[D]:f[D]?F=Bi:_["*"]?F=_["*"]:f["*"]&&(F=Bi),F?T=T.concat(F({key:(t&&`${t}.`)+z,value:s[z],valueSpec:f[D]||f["*"],style:g,styleSpec:b,object:s,objectKey:z},s)):T.push(new r.J(t,s[z],`unknown property "${z}"`))}for(const z in f)_[z]||f[z].required&&f[z].default===void 0&&s[z]===void 0&&T.push(new r.V(t,s,`missing required property "${z}"`));return T}function vn(h){const t=h.value,s=h.valueSpec,f=h.style,_=h.styleSpec,g=h.key,b=h.arrayElementValidator||Bi;if(r.K(t)!=="array")return[new r.V(g,t,`array expected, ${r.K(t)} found`)];if(s.length&&t.length!==s.length)return[new r.V(g,t,`array length ${s.length} expected, length ${t.length} found`)];if(s["min-length"]&&t.length<s["min-length"])return[new r.V(g,t,`array length at least ${s["min-length"]} expected, length ${t.length} found`)];let T={type:s.value,values:s.values,minimum:s.minimum,maximum:s.maximum,function:void 0};_.$version<7&&(T.function=s.function),r.K(s.value)==="object"&&(T=s.value);let A=[];for(let z=0;z<t.length;z++)A=A.concat(b({array:t,arrayIndex:z,value:t[z],valueSpec:T,style:f,styleSpec:_,key:`${g}[${z}]`},!0));return A}function wi(h){const t=h.key,s=h.value,f=h.valueSpec;let _=r.K(s);if(_==="number"&&s!=s&&(_="NaN"),_!=="number")return[new r.V(t,s,`number expected, ${_} found`)];if("minimum"in f){let g=f.minimum;if(r.K(f.minimum)==="array"&&(g=f.minimum[h.arrayIndex]),s<g)return[new r.V(t,s,`${s} is less than the minimum value ${g}`)]}if("maximum"in f){let g=f.maximum;if(r.K(f.maximum)==="array"&&(g=f.maximum[h.arrayIndex]),s>g)return[new r.V(t,s,`${s} is greater than the maximum value ${g}`)]}return[]}function tr(h){const t=h.valueSpec,s=r.M(h.value.type);let f,_,g,b={};const T=s!=="categorical"&&h.value.property===void 0,A=!T,z=r.K(h.value.stops)==="array"&&r.K(h.value.stops[0])==="array"&&r.K(h.value.stops[0][0])==="object",D=bi({key:h.key,value:h.value,valueSpec:h.styleSpec.function,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(U){if(s==="identity")return[new r.V(U.key,U.value,'identity function may not have a "stops" property')];let H=[];const q=U.value;return H=H.concat(vn({key:U.key,value:q,valueSpec:U.valueSpec,style:U.style,styleSpec:U.styleSpec,arrayElementValidator:F})),r.K(q)==="array"&&q.length===0&&H.push(new r.V(U.key,q,"array must have at least one stop")),H},default:function(U){return Bi({key:U.key,value:U.value,valueSpec:t,style:U.style,styleSpec:U.styleSpec})}}});return s==="identity"&&T&&D.push(new r.V(h.key,h.value,'missing required property "property"')),s==="identity"||h.value.stops||D.push(new r.V(h.key,h.value,'missing required property "stops"')),s==="exponential"&&h.valueSpec.expression&&!r.N(h.valueSpec)&&D.push(new r.V(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(A&&!r.O(h.valueSpec)?D.push(new r.V(h.key,h.value,"property functions not supported")):T&&!r.Q(h.valueSpec)&&D.push(new r.V(h.key,h.value,"zoom functions not supported"))),s!=="categorical"&&!z||h.value.property!==void 0||D.push(new r.V(h.key,h.value,'"property" property is required')),D;function F(U){let H=[];const q=U.value,Y=U.key;if(r.K(q)!=="array")return[new r.V(Y,q,`array expected, ${r.K(q)} found`)];if(q.length!==2)return[new r.V(Y,q,`array length 2 expected, length ${q.length} found`)];if(z){if(r.K(q[0])!=="object")return[new r.V(Y,q,`object expected, ${r.K(q[0])} found`)];if(q[0].zoom===void 0)return[new r.V(Y,q,"object stop key must have zoom")];if(q[0].value===void 0)return[new r.V(Y,q,"object stop key must have value")];const Z=r.M(q[0].zoom);if(typeof Z!="number")return[new r.V(Y,q[0].zoom,"stop zoom values must be numbers")];if(g&&g>Z)return[new r.V(Y,q[0].zoom,"stop zoom values must appear in ascending order")];Z!==g&&(g=Z,_=void 0,b={}),H=H.concat(bi({key:`${Y}[0]`,value:q[0],valueSpec:{zoom:{}},style:U.style,styleSpec:U.styleSpec,objectElementValidators:{zoom:wi,value:O}}))}else H=H.concat(O({key:`${Y}[0]`,value:q[0],style:U.style,styleSpec:U.styleSpec},q));return r.S(r.U(q[1]))?H.concat([new r.V(`${Y}[1]`,q[1],"expressions are not allowed in function stops.")]):H.concat(Bi({key:`${Y}[1]`,value:q[1],valueSpec:t,style:U.style,styleSpec:U.styleSpec}))}function O(U,H){const q=r.K(U.value),Y=r.M(U.value),Z=U.value!==null?U.value:H;if(f){if(q!==f)return[new r.V(U.key,Z,`${q} stop domain type must match previous stop domain type ${f}`)]}else f=q;if(q!=="number"&&q!=="string"&&q!=="boolean"&&typeof Y!="number"&&typeof Y!="string"&&typeof Y!="boolean")return[new r.V(U.key,Z,"stop domain value must be a number, string, or boolean")];if(q!=="number"&&s!=="categorical"){let oe=`number expected, ${q} found`;return r.O(t)&&s===void 0&&(oe+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new r.V(U.key,Z,oe)]}return s!=="categorical"||q!=="number"||typeof Y=="number"&&isFinite(Y)&&Math.floor(Y)===Y?s!=="categorical"&&q==="number"&&typeof Y=="number"&&typeof _=="number"&&_!==void 0&&Y<_?[new r.V(U.key,Z,"stop domain values must appear in ascending order")]:(_=Y,s==="categorical"&&Y in b?[new r.V(U.key,Z,"stop domain values must be unique")]:(b[Y]=!0,[])):[new r.V(U.key,Z,`integer expected, found ${String(Y)}`)]}}function yr(h){const t=(h.expressionContext==="property"?r.W:r.X)(r.U(h.value),h.valueSpec);if(t.result==="error")return t.value.map(f=>new r.V(`${h.key}${f.key}`,h.value,f.message));const s=t.value.expression||t.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!s.outputDefined())return[new r.V(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!r.Y(s))return[new r.V(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter")return da(s,h);if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!r.Z(s,["zoom","feature-state"]))return[new r.V(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!r._(s))return[new r.V(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function da(h,t){const s=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const _ of t.valueSpec.expression.parameters)s.delete(_);if(s.size===0)return[];const f=[];return h instanceof r.$&&s.has(h.name)?[new r.V(t.key,t.value,`["${h.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(h.eachChild(_=>{f.push(...da(_,t))}),f)}function Us(h){const t=h.key,s=h.value,f=h.valueSpec,_=[];return Array.isArray(f.values)?f.values.indexOf(r.M(s))===-1&&_.push(new r.V(t,s,`expected one of [${f.values.join(", ")}], ${JSON.stringify(s)} found`)):Object.keys(f.values).indexOf(r.M(s))===-1&&_.push(new r.V(t,s,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(s)} found`)),_}function Ka(h){return r.a1(r.U(h.value))?yr(r.L({},h,{expressionContext:"filter",valueSpec:h.styleSpec[`filter_${h.layerType||"fill"}`]})):so(h)}function so(h){const t=h.value,s=h.key;if(r.K(t)!=="array")return[new r.V(s,t,`array expected, ${r.K(t)} found`)];const f=h.styleSpec;let _,g=[];if(t.length<1)return[new r.V(s,t,"filter array must have at least 1 element")];switch(g=g.concat(Us({key:`${s}[0]`,value:t[0],valueSpec:f.filter_operator,style:h.style,styleSpec:h.styleSpec})),r.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&r.M(t[1])==="$type"&&g.push(new r.V(s,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&g.push(new r.V(s,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(_=r.K(t[1]),_!=="string"&&g.push(new r.V(`${s}[1]`,t[1],`string expected, ${_} found`)));for(let b=2;b<t.length;b++)_=r.K(t[b]),r.M(t[1])==="$type"?g=g.concat(Us({key:`${s}[${b}]`,value:t[b],valueSpec:f.geometry_type,style:h.style,styleSpec:h.styleSpec})):_!=="string"&&_!=="number"&&_!=="boolean"&&g.push(new r.V(`${s}[${b}]`,t[b],`string, number, or boolean expected, ${_} found`));break;case"any":case"all":case"none":for(let b=1;b<t.length;b++)g=g.concat(so({key:`${s}[${b}]`,value:t[b],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":_=r.K(t[1]),t.length!==2?g.push(new r.V(s,t,`filter array for "${t[0]}" operator must have 2 elements`)):_!=="string"&&g.push(new r.V(`${s}[1]`,t[1],`string expected, ${_} found`))}return g}function Io(h,t){const s=h.key,f=h.style,_=h.layer,g=h.styleSpec,b=h.value,T=h.objectKey,A=g[`${t}_${h.layerType}`];if(!A)return[];const z=T.match(/^(.*)-use-theme$/);if(t==="paint"&&z&&A[z[1]])return r.S(b)?[].concat(Bi({key:h.key,value:b,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:f,styleSpec:g,expressionContext:"property",propertyType:t,propertyKey:T})):Bi({key:s,value:b,valueSpec:{type:"string"},style:f,styleSpec:g});const D=T.match(/^(.*)-transition$/);if(t==="paint"&&D&&A[D[1]]&&A[D[1]].transition)return Bi({key:s,value:b,valueSpec:g.transition,style:f,styleSpec:g});const F=h.valueSpec||A[T];if(!F)return[new r.J(s,b,`unknown property "${T}"`)];let O;if(r.K(b)==="string"&&r.O(F)&&!F.tokens&&(O=/^{([^}]+)}$/.exec(b))){const H=`\`{ "type": "identity", "property": ${O?JSON.stringify(O[1]):'"_"'} }\``;return[new r.V(s,b,`"${T}" does not support interpolation syntax
Use an identity property function instead: ${H}.`)]}const U=[];if(h.layerType==="symbol")T!=="text-field"||!f||f.glyphs||f.imports||U.push(new r.V(s,b,'use of "text-field" requires a style "glyphs" property')),T==="text-font"&&r.a2(r.U(b))&&r.M(b.type)==="identity"&&U.push(new r.V(s,b,'"text-font" does not support identity functions'));else if(h.layerType==="model"&&t==="paint"&&_&&_.layout&&_.layout.hasOwnProperty("model-id")&&r.O(F)&&(r.a3(F)||r.Q(F))){const H=r.W(r.U(b),F),q=H.value.expression||H.value._styleExpression.expression;q&&!r.Z(q,["measure-light"])&&(T==="model-emissive-strength"&&r._(q)&&r.Y(q)||U.push(new r.V(s,b,`${T} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return U.concat(Bi({key:h.key,value:b,valueSpec:F,style:f,styleSpec:g,expressionContext:"property",propertyType:t,propertyKey:T}))}function au(h){return Io(h,"paint")}function Ja(h){return Io(h,"layout")}function Xl(h){let t=[];const s=h.value,f=h.key,_=h.style,g=h.styleSpec;s.type||s.ref||t.push(new r.V(f,s,'either "type" or "ref" is required'));let b=r.M(s.type);const T=r.M(s.ref);if(s.id){const A=r.M(s.id);for(let z=0;z<h.arrayIndex;z++){const D=_.layers[z];r.M(D.id)===A&&t.push(new r.V(f,s.id,`duplicate layer id "${s.id}", previously used at line ${D.id.__line__}`))}}if("ref"in s){let A;["type","source","source-layer","filter","layout"].forEach(z=>{z in s&&t.push(new r.V(f,s[z],`"${z}" is prohibited for ref layers`))}),_.layers.forEach(z=>{r.M(z.id)===T&&(A=z)}),A?A.ref?t.push(new r.V(f,s.ref,"ref cannot reference another ref layer")):b=r.M(A.type):typeof T=="string"&&t.push(new r.V(f,s.ref,`ref layer "${T}" not found`))}else if(b!=="background"&&b!=="sky"&&b!=="slot")if(s.source){const A=_.sources&&_.sources[s.source],z=A&&r.M(A.type);A?z==="vector"&&b==="raster"?t.push(new r.V(f,s.source,`layer "${s.id}" requires a raster source`)):z==="raster"&&b!=="raster"?t.push(new r.V(f,s.source,`layer "${s.id}" requires a vector source`)):z!=="vector"||s["source-layer"]?z==="raster-dem"&&b!=="hillshade"?t.push(new r.V(f,s.source,"raster-dem source can only be used with layer type 'hillshade'.")):z!=="raster-array"||["raster","raster-particle"].includes(b)?b==="line"&&s.paint&&(s.paint["line-gradient"]||s.paint["line-trim-offset"])&&z==="geojson"&&!A.lineMetrics?t.push(new r.V(f,s,`layer "${s.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):b==="raster-particle"&&z!=="raster-array"&&t.push(new r.V(f,s.source,`layer "${s.id}" requires a 'raster-array' source.`)):t.push(new r.V(f,s.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new r.V(f,s,`layer "${s.id}" must specify a "source-layer"`)):t.push(new r.V(f,s.source,`source "${s.source}" not found`))}else t.push(new r.V(f,s,'missing required property "source"'));return t=t.concat(bi({key:f,value:s,valueSpec:g.layer,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Bi({key:`${f}.type`,value:s.type,valueSpec:g.layer.type,style:h.style,styleSpec:h.styleSpec,object:s,objectKey:"type"}),filter:A=>Ka(r.L({layerType:b},A)),layout:A=>bi({layer:s,key:A.key,value:A.value,valueSpec:{},style:A.style,styleSpec:A.styleSpec,objectElementValidators:{"*":z=>Ja(r.L({layerType:b},z))}}),paint:A=>bi({layer:s,key:A.key,value:A.value,valueSpec:{},style:A.style,styleSpec:A.styleSpec,objectElementValidators:{"*":z=>au(r.L({layerType:b,layer:s},z))}})}})),t}function bs(h){const t=h.value,s=h.key,f=r.K(t);return f!=="string"?[new r.V(s,t,`string expected, ${f} found`)]:[]}const js={promoteId:function h({key:t,value:s}){if(r.K(s)==="string")return bs({key:t,value:s});if(Array.isArray(s)){const f=[],_=r.U(s),g=r.X(_);return g.result==="error"&&g.value.forEach(b=>{f.push(new r.V(`${t}${b.key}`,null,`${b.message}`))}),r.Z(g.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||f.push(new r.V(`${t}`,null,"promoteId expression should be only feature dependent")),f}{const f=[];for(const _ in s)f.push(...h({key:`${t}.${_}`,value:s[_]}));return f}}};function ao(h){const t=h.value,s=h.key,f=h.styleSpec,_=h.style;if(!t.type)return[new r.V(s,t,'"type" is required')];const g=r.M(t.type);let b=[];switch(["vector","raster","raster-dem","raster-array"].includes(g)&&(t.url||t.tiles||b.push(new r.J(s,t,'Either "url" or "tiles" is required.'))),g){case"vector":case"raster":case"raster-dem":case"raster-array":return b=b.concat(bi({key:s,value:t,valueSpec:f[`source_${g.replace("-","_")}`],style:h.style,styleSpec:f,objectElementValidators:js})),b;case"geojson":if(b=bi({key:s,value:t,valueSpec:f.source_geojson,style:_,styleSpec:f,objectElementValidators:js}),t.cluster)for(const T in t.clusterProperties){const[A,z]=t.clusterProperties[T],D=typeof A=="string"?[A,["accumulated"],["get",T]]:A;b.push(...yr({key:`${s}.${T}.map`,value:z,expressionContext:"cluster-map"})),b.push(...yr({key:`${s}.${T}.reduce`,value:D,expressionContext:"cluster-reduce"}))}return b;case"video":return bi({key:s,value:t,valueSpec:f.source_video,style:_,styleSpec:f});case"image":return bi({key:s,value:t,valueSpec:f.source_image,style:_,styleSpec:f});case"canvas":return[new r.V(s,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Us({key:`${s}.type`,value:t.type,valueSpec:{values:Qa(f)}})}}function Qa(h){return h.source.reduce((t,s)=>{const f=h[s];return f.type.type==="enum"&&(t=t.concat(Object.keys(f.type.values))),t},[])}function pa(h){const t=h.value,s=h.styleSpec,f=s.light,_=h.style;let g=[];const b=r.K(t);if(t===void 0)return g;if(b!=="object")return g=g.concat([new r.V("light",t,`object expected, ${b} found`)]),g;for(const T in t){const A=T.match(/^(.*)-transition$/),z=T.match(/^(.*)-use-theme$/);g=g.concat(z&&f[z[1]]?Bi({key:T,value:t[T],valueSpec:{type:"string"},style:_,styleSpec:s}):A&&f[A[1]]&&f[A[1]].transition?Bi({key:T,value:t[T],valueSpec:s.transition,style:_,styleSpec:s}):f[T]?Bi({key:T,value:t[T],valueSpec:f[T],style:_,styleSpec:s}):[new r.V(T,t[T],`unknown property "${T}"`)])}return g}function ws(h){const t=h.value;let s=[];if(!t)return s;const f=r.K(t);if(f!=="object")return s=s.concat([new r.V("light-3d",t,`object expected, ${f} found`)]),s;const _=h.styleSpec,g=_["light-3d"],b=h.key,T=h.style,A=h.style.lights;for(const F of["type","id"])if(!(F in t))return s=s.concat([new r.V("light-3d",t,`missing property ${F} on light`)]),s;if(t.type&&A)for(let F=0;F<h.arrayIndex;F++){const O=r.M(t.type),U=A[F];r.M(U.type)===O&&s.push(new r.V(b,t.id,`duplicate light type "${t.type}", previously defined at line ${U.id.__line__}`))}const z=`properties_light_${t.type}`;if(!(z in _))return s=s.concat([new r.V("light-3d",t,`Invalid light type ${t.type}`)]),s;const D=_[z];for(const F in t)if(F==="properties"){const O=t[F],U=r.K(O);if(U!=="object")return s=s.concat([new r.V("properties",O,`object expected, ${U} found`)]),s;for(const H in O)s=s.concat(D[H]?Bi({key:H,value:O[H],valueSpec:D[H],style:T,styleSpec:_}):[new r.J(h.key,O[H],`unknown property "${H}"`)])}else{const O=F.match(/^(.*)-transition$/),U=F.match(/^(.*)-use-theme$/);s=s.concat(U&&g[U[1]]?Bi({key:F,value:t[F],valueSpec:{type:"string"},style:T,styleSpec:_}):O&&g[O[1]]&&g[O[1]].transition?Bi({key:F,value:t[F],valueSpec:_.transition,style:T,styleSpec:_}):g[F]?Bi({key:F,value:t[F],valueSpec:g[F],style:T,styleSpec:_}):[new r.J(F,t[F],`unknown property "${F}"`)])}return s}function el(h){const t=h.value,s=h.key,f=h.style,_=h.styleSpec,g=_.terrain;let b=[];const T=r.K(t);if(t===void 0||T==="null")return b;if(T!=="object")return b=b.concat([new r.V("terrain",t,`object expected, ${T} found`)]),b;for(const A in t){const z=A.match(/^(.*)-transition$/),D=A.match(/^(.*)-use-theme$/);b=b.concat(D&&g[D[1]]?Bi({key:A,value:t[A],valueSpec:{type:"string"},style:f,styleSpec:_}):z&&g[z[1]]&&g[z[1]].transition?Bi({key:A,value:t[A],valueSpec:_.transition,style:f,styleSpec:_}):g[A]?Bi({key:A,value:t[A],valueSpec:g[A],style:f,styleSpec:_}):[new r.J(A,t[A],`unknown property "${A}"`)])}if(t.source){const A=f.sources&&f.sources[t.source],z=A&&r.M(A.type);A?z!=="raster-dem"&&b.push(new r.V(s,t.source,`terrain cannot be used with a source of type ${String(z)}, it only be used with a "raster-dem" source type`)):b.push(new r.V(s,t.source,`source "${t.source}" not found`))}else b.push(new r.V(s,t,'terrain is missing required property "source"'));return b}function tl(h){const t=h.value,s=h.style,f=h.styleSpec,_=f.fog;let g=[];const b=r.K(t);if(t===void 0)return g;if(b!=="object")return g=g.concat([new r.V("fog",t,`object expected, ${b} found`)]),g;for(const T in t){const A=T.match(/^(.*)-transition$/),z=T.match(/^(.*)-use-theme$/);g=g.concat(z&&_[z[1]]?Bi({key:T,value:t[T],valueSpec:{type:"string"},style:s,styleSpec:f}):A&&_[A[1]]&&_[A[1]].transition?Bi({key:T,value:t[T],valueSpec:f.transition,style:s,styleSpec:f}):_[T]?Bi({key:T,value:t[T],valueSpec:_[T],style:s,styleSpec:f}):[new r.J(T,t[T],`unknown property "${T}"`)])}return g}const lu={"*":()=>[],array:vn,boolean:function(h){const t=h.value,s=h.key,f=r.K(t);return f!=="boolean"?[new r.V(s,t,`boolean expected, ${f} found`)]:[]},number:wi,color:function(h){const t=h.key,s=h.value,f=r.K(s);return f!=="string"?[new r.V(t,s,`color expected, ${f} found`)]:r.a0.parseCSSColor(s)===null?[new r.V(t,s,`color expected, "${s}" found`)]:[]},enum:Us,filter:Ka,function:tr,layer:Xl,object:bi,source:ao,model:r.a4,light:pa,"light-3d":ws,terrain:el,fog:tl,string:bs,formatted:function(h){return bs(h).length===0?[]:yr(h)},resolvedImage:function(h){return bs(h).length===0?[]:yr(h)},projection:function(h){const t=h.value,s=h.styleSpec,f=s.projection,_=h.style;let g=[];const b=r.K(t);if(b==="object")for(const T in t)g=g.concat(Bi({key:T,value:t[T],valueSpec:f[T],style:_,styleSpec:s}));else b!=="string"&&(g=g.concat([new r.V("projection",t,`object or string expected, ${b} found`)]));return g},import:function(h){const{value:t,styleSpec:s}=h,{data:f,..._}=t;Object.defineProperty(_,"__line__",{value:t.__line__,enumerable:!1});let g=bi(r.L({},h,{value:_,valueSpec:s.import}));return r.M(_.id)===""&&g.push(new r.V(`${h.key}.id`,_,"import id can't be an empty string")),f&&(g=g.concat(Yl(f,s,{key:`${h.key}.data`}))),g},iconset:function(h){const t=h.value,s=h.key,f=h.styleSpec,_=h.style;if(!t.type)return[new r.V(s,t,'"type" is required')];const g=r.M(t.type);let b=[];if(b=b.concat(bi({key:s,value:t,valueSpec:f[`iconset_${g}`],style:_,styleSpec:f})),g==="source"&&t.source){const T=_.sources&&_.sources[t.source],A=T&&r.M(T.type);T?A!=="raster-array"&&b.push(new r.V(s,t.source,`iconset cannot be used with a source of type ${String(A)}, it only be used with a "raster-array" source type`)):b.push(new r.V(s,t.source,`source "${t.source}" not found`))}return b}};function Bi(h,t=!1){const s=h.value,f=h.valueSpec,_=h.styleSpec;if(f.expression&&r.a2(r.M(s)))return tr(h);if(f.expression&&r.S(r.U(s)))return yr(h);if(f.type&&lu[f.type]){const g=lu[f.type](h);return t===!0&&g.length>0&&r.K(h.value)==="array"?yr(h):g}return bi(r.L({},h,{valueSpec:f.type?_[f.type]:f}))}function Ts(h){const t=h.value,s=h.key,f=bs(h);return f.length||(t.indexOf("{fontstack}")===-1&&f.push(new r.V(s,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&f.push(new r.V(s,t,'"glyphs" url must include a "{range}" token'))),f}function Yl(h,t=r.a5,s={}){return Bi({key:s.key||"",value:h,valueSpec:t.$root,styleSpec:t,style:h,objectElementValidators:{glyphs:Ts,"*":()=>[]}})}function qo(h,t=r.a5){return Ce(Yl(h,t))}const cu=h=>Ce(ao(h)),Bh=h=>Ce(pa(h)),uu=h=>Ce(ws(h)),St=h=>Ce(el(h)),$s=h=>Ce(tl(h)),Nh=h=>Ce(function(t){const s=t.value,f=t.style,_=t.styleSpec,g=_.snow;let b=[];const T=r.K(s);if(s===void 0)return b;if(T!=="object")return b=b.concat([new r.V("snow",s,`object expected, ${T} found`)]),b;for(const A in s){const z=A.match(/^(.*)-transition$/);b=b.concat(z&&g[z[1]]&&g[z[1]].transition?Bi({key:A,value:s[A],valueSpec:_.transition,style:f,styleSpec:_}):g[A]?Bi({key:A,value:s[A],valueSpec:g[A],style:f,styleSpec:_}):[new r.J(A,s[A],`unknown property "${A}"`)])}return b}(h)),Ke=h=>Ce(function(t){const s=t.value,f=t.style,_=t.styleSpec,g=_.rain;let b=[];const T=r.K(s);if(s===void 0)return b;if(T!=="object")return b=b.concat([new r.V("rain",s,`object expected, ${T} found`)]),b;for(const A in s){const z=A.match(/^(.*)-transition$/);b=b.concat(z&&g[z[1]]&&g[z[1]].transition?Bi({key:A,value:s[A],valueSpec:_.transition,style:f,styleSpec:_}):g[A]?Bi({key:A,value:s[A],valueSpec:g[A],style:f,styleSpec:_}):[new r.J(A,s[A],`unknown property "${A}"`)])}return b}(h)),W=h=>Ce(Xl(h)),ie=h=>Ce(Ka(h)),ge=h=>Ce(au(h)),Ee=h=>Ce(Ja(h)),Se=h=>Ce(r.a4(h));function Ce(h){return h.slice().sort((t,s)=>t.line&&s.line?t.line-s.line:0)}function ze(h,t){let s=!1;if(t&&t.length)for(const f of t)f instanceof r.J?r.w(f.message):(h.fire(new r.z(new Error(f.message))),s=!0);return s}let Re;class He extends r.E{constructor(t,s="flat"){super(),this._transitionable=new r.a6(Re||(Re=new r.a7({anchor:new r.a8(r.a5.light.anchor),position:new r.a9(r.a5.light.position),color:new r.a8(r.a5.light.color),intensity:new r.a8(r.a5.light.intensity)}))),this.setLight(t,s),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,s,f={}){this._validate(Bh,t,f)||(this._transitionable.setTransitionOrValue(t),this.id=s)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,s,f){return(!f||f.validate!==!1)&&ze(this,t.call(qo,r.l({value:s,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let it=class extends r.E{constructor(h,t,s,f){super(),this.scope=s,this._transitionable=new r.a6(new r.a7({source:new r.a8(r.a5.terrain.source),exaggeration:new r.a8(r.a5.terrain.exaggeration)}),s,f),this._transitionable.setTransitionOrValue(h,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(h,t){this._transitionable.setTransitionOrValue(h,t)}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}getExaggeration(h){return this._transitioning.possiblyEvaluate(new r.aa(h)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const h=this._transitionable._values.exaggeration;if(!h)return null;const t=h.value.expression;if(!t)return null;let s=-1,f=-1,_=1;for(const g of t.zoomStops)_=t.evaluate(new r.aa(g)),_>.01?(s=g,f=-1):f=g;return _<.01&&s>0&&f>s?[s,f]:null}isZoomDependent(){const h=this._transitionable._values.exaggeration;return h!=null&&h.value!=null&&h.value.expression!=null&&h.value.expression instanceof r.ab}};const $e=45,Et=65,kt=.05;function Zt(h,t,s,f){const _=r.af($e,Et,s),[g,b]=un(h,f);let T=1-Math.min(1,Math.exp((t-g)/(b-g)*-6));return T*=T*T,T=Math.min(1,1.00747*T),T*_*h.alpha}function un(h,t){const s=.5/Math.tan(.5*t);return[h.range[0]+s,h.range[1]+s]}function _n(h,t,s,f,_){const g=r.ad([],[t,s,f],_.mercatorFogMatrix);return Zt(h,r.ae(g),_.pitch,_._fov)}function An(h,t,s,f,_,g,b){const T=[[s,f,0],[_,f,0],[_,g,0],[s,g,0]];let A=Number.MAX_VALUE,z=-Number.MAX_VALUE;for(const D of T){const F=r.ad([],D,t),O=r.ae(F);A=Math.min(A,O),z=Math.max(z,O)}return[Zt(h,A,b.pitch,b._fov),Zt(h,z,b.pitch,b._fov)]}class zn extends r.E{constructor(t,s,f,_){super();const g=new r.a7({range:new r.a8(r.a5.fog.range),color:new r.a8(r.a5.fog.color),"color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new r.a8(r.a5.fog["high-color"]),"high-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new r.a8(r.a5.fog["space-color"]),"space-color-use-theme":new r.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new r.a8(r.a5.fog["horizon-blend"]),"star-intensity":new r.a8(r.a5.fog["star-intensity"]),"vertical-range":new r.a8(r.a5.fog["vertical-range"])});this._transitionable=new r.a6(g,f,new Map(_)),this.set(t,_),this._transitioning=this._transitionable.untransitioned(),this._transform=s,this.properties=new r.ag(g),this.scope=f}get state(){const t=this._transform,s=t.projection.name==="globe",f=r.ah(t.zoom),_=this.properties.get("range"),g=[.5,3];return{range:s?[r.ai(g[0],_[0],f),r.ai(g[1],_[1],f)]:_,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,s,f={}){if(this._validate($s,t,f))return;const _=r.l({},t);for(const g of Object.keys(r.a5.fog))_[g]===void 0&&(_[g]=r.a5.fog[g].default);this._options=_,this._transitionable.setTransitionOrValue(this._options,s)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const s=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:r.af($e,Et,t))*s.a}getOpacityAtLatLng(t,s){return this._transform.projection.supportsFog?function(f,_,g){const b=r.ac.fromLngLat(_),T=g.elevation?g.elevation.getAtPointOrZero(b):0;return _n(f,b.x,b.y,T,g)}(this.state,t,s):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const s=this._transform.calculateFogTileMatrix(t.toUnwrapped());return An(this.state,s,0,0,r.aj,r.aj,this._transform)}getOpacityForBounds(t,s,f,_,g){return this._transform.projection.supportsFog?An(this.state,t,s,f,_,g,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?un(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const s=[4,5,6,7];for(const f of s){const _=t.points[f];let g;if(_[2]>=0)g=_;else{const b=t.points[f-4];g=r.ak(b,_,b[2]/(b[2]-_[2]))}if(_n(this.state,g[0],g[1],0,this._transform)>=kt)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,s,f){return(!f||f.validate!==!1)&&ze(this,t.call(qo,r.l({value:s,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}}let qi,Dn,_i,Xn,gi=class extends r.E{constructor(h,t,s,f){super();const _=qi||(qi=new r.a7({density:new r.a8(r.a5.snow.density),intensity:new r.a8(r.a5.snow.intensity),color:new r.a8(r.a5.snow.color),opacity:new r.a8(r.a5.snow.opacity),vignette:new r.a8(r.a5.snow.vignette),"vignette-color":new r.a8(r.a5.snow["vignette-color"]),"center-thinning":new r.a8(r.a5.snow["center-thinning"]),direction:new r.a8(r.a5.snow.direction),"flake-size":new r.a8(r.a5.snow["flake-size"])}));this._transitionable=new r.a6(_,s,new Map(f)),this.set(h,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(_),this.scope=s}get state(){const h=this.properties.get("opacity"),t=this.properties.get("color"),s=this.properties.get("direction"),f=r.al(s[0]),_=-Math.max(r.al(s[1]),.01),g=[Math.cos(f)*Math.cos(_),Math.sin(f)*Math.cos(_),Math.sin(_)],b=this.properties.get("vignette"),T=this.properties.get("vignette-color");return T.a=b,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*h),direction:g,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:T}}get(){return this._transitionable.serialize()}set(h,t,s={}){if(this._validate(Nh,h,s))return;const f=r.l({},h);for(const _ of Object.keys(r.a5.snow))f[_]===void 0&&(f[_]=r.a5.snow[_].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(h){this._transitionable.setTransitionOrValue(this._options,new Map(h))}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,t,s){return(!s||s.validate!==!1)&&ze(this,h.call(qo,r.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}},Ti=class extends r.E{constructor(h,t,s,f){super();const _=Dn||(Dn=new r.a7({density:new r.a8(r.a5.rain.density),intensity:new r.a8(r.a5.rain.intensity),color:new r.a8(r.a5.rain.color),opacity:new r.a8(r.a5.rain.opacity),vignette:new r.a8(r.a5.rain.vignette),"vignette-color":new r.a8(r.a5.rain["vignette-color"]),"center-thinning":new r.a8(r.a5.rain["center-thinning"]),direction:new r.a8(r.a5.rain.direction),"droplet-size":new r.a8(r.a5.rain["droplet-size"]),"distortion-strength":new r.a8(r.a5.rain["distortion-strength"])}));this._transitionable=new r.a6(_,s,new Map(f)),this.set(h,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new r.ag(_),this.scope=s}get state(){const h=this.properties.get("opacity"),t=this.properties.get("color"),s=this.properties.get("direction"),f=r.al(s[0]),_=-Math.max(r.al(s[1]),.01),g=[Math.cos(f)*Math.cos(_),Math.sin(f)*Math.cos(_),Math.sin(_)],b=this.properties.get("vignette-color");return b.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new r.am(t.r,t.g,t.b,t.a*h),direction:g,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(h,t,s={}){if(this._validate(Ke,h,s))return;const f=r.l({},h);for(const _ of Object.keys(r.a5.rain))f[_]===void 0&&(f[_]=r.a5.rain[_].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(h){this._transitionable.setTransitionOrValue(this._options,new Map(h))}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,t,s){return(!s||s.validate!==!1)&&ze(this,h.call(qo,r.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:r.a5})))}};class er extends r.E{constructor(t,s,f,_){super(),this.scope=f,this._options=t,this.properties=new r.ag(s),this._transitionable=new r.a6(s,f,new Map(_)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,s){this._options=t,this._transitionable.setTransitionOrValue(t.properties,s)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class hr{constructor(t,s,f,_){this.screenBounds=t,this.cameraPoint=s,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=f,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,_)}static createFromScreenPoints(t,s){let f,_;if(t instanceof r.P||typeof t[0]=="number"){const g=r.P.convert(t);f=[g],_=s.isPointAboveHorizon(g)}else{const g=r.P.convert(t[0]),b=r.P.convert(t[1]),T=g.add(b)._div(2);f=[g,b],_=r.ao(g,b).every(A=>s.isPointAboveHorizon(A))&&s.isPointAboveHorizon(T)}return new hr(f,s.getCameraPoint(),_,s)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return r.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const s=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],_=r.ao(s,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>s.x&&this.cameraPoint.x<f.x?_.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?_[2]=this.cameraPoint:this.cameraPoint.x<=s.x&&(_[3]=this.cameraPoint)),r.ap(_,t)}bufferedCameraGeometryGlobe(t){const s=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],_=r.ao(s,f,t),g=this.cameraPoint.clone();switch(3*((g.y>s.y)+(g.y>f.y))+((g.x>s.x)+(g.x>f.x))){case 0:_[0]=g,_[4]=g.clone();break;case 1:_.splice(1,0,g);break;case 2:_[1]=g;break;case 3:_.splice(4,0,g);break;case 5:_.splice(2,0,g);break;case 6:_[3]=g;break;case 7:_.splice(3,0,g);break;case 8:_[2]=g}return _}containsTile(t,s,f,_=0){const g=t.queryPadding/s._pixelsPerMercatorPixel+1,b=f?this._bufferedCameraMercator(g,s):this._bufferedScreenMercator(g,s);let T=t.tileID.wrap+(b.unwrapped?_:0);const A=b.polygon.map(Y=>r.aq(t.tileTransform,Y,T));if(!r.ar(A,0,0,r.aj,r.aj))return;T=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?_:0);const z=this.screenGeometryMercator.polygon.map(Y=>r.as(t.tileTransform,Y,T)),D=z.map(Y=>new r.P(Y[0],Y[1])),F=s.getFreeCameraOptions().position||new r.ac(0,0,0),O=r.as(t.tileTransform,F,T),U=z.map(Y=>{const Z=r.at(Y,Y,O);return r.au(Z,Z),new r.av(O,Z)}),H=r.aw(t,1,s.zoom)*s._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:D,tilespaceRays:U,bufferedTilespaceGeometry:A,bufferedTilespaceBounds:(q=r.ax(A),q.min.x=r.aD(q.min.x,0,r.aj),q.min.y=r.aD(q.min.y,0,r.aj),q.max.x=r.aD(q.max.x,0,r.aj),q.max.y=r.aD(q.max.y,0,r.aj),q),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:H};var q}_bufferedScreenMercator(t,s){const f=Gs(t);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let _;return _=s.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),s):{polygon:this.bufferedScreenGeometry(t).map(g=>s.pointCoordinate3D(g)),unwrapped:!0},this._screenRaycastCache[f]=_,_}}_bufferedCameraMercator(t,s){const f=Gs(t);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let _;return _=s.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),s):{polygon:this.bufferedCameraGeometry(t).map(g=>s.pointCoordinate3D(g)),unwrapped:!0},this._cameraRaycastCache[f]=_,_}}_projectAndResample(t,s){const f=function(g,b){const T=r.az([],b.pixelMatrix,b.globeMatrix),A=[0,-r.aE,0,1],z=[0,r.aE,0,1],D=[0,0,0,1];r.aA(A,A,T),r.aA(z,z,T),r.aA(D,D,T);const F=new r.P(A[0]/A[3],A[1]/A[3]),O=new r.P(z[0]/z[3],z[1]/z[3]),U=r.aB(g,F)&&A[3]<D[3],H=r.aB(g,O)&&z[3]<D[3];if(!U&&!H)return null;const q=function(ve,_e,we){for(let Te=1;Te<ve.length;Te++){const Ue=Dr(_e.pointCoordinate3D(ve[Te-1]).x),Fe=Dr(_e.pointCoordinate3D(ve[Te]).x);if(we<0){if(Ue<Fe)return{idx:Te,t:-Ue/(Fe-1-Ue)}}else if(Fe<Ue)return{idx:Te,t:(1-Ue)/(Fe+1-Ue)}}return null}(g,b,U?-1:1);if(!q)return null;const{idx:Y,t:Z}=q;let oe=Y>1?br(g.slice(0,Y),b):[],fe=Y<g.length?br(g.slice(Y),b):[];oe=oe.map(ve=>new r.P(Dr(ve.x),ve.y)),fe=fe.map(ve=>new r.P(Dr(ve.x),ve.y));const me=[...oe];me.length===0&&me.push(fe[fe.length-1]);const xe=r.ai(me[me.length-1].y,(fe.length===0?oe[0]:fe[0]).y,Z);let ye;return ye=U?[new r.P(0,xe),new r.P(0,0),new r.P(1,0),new r.P(1,xe)]:[new r.P(1,xe),new r.P(1,1),new r.P(0,1),new r.P(0,xe)],me.push(...ye),fe.length===0?me.push(oe[0]):me.push(...fe),{polygon:me.map(ve=>new r.ac(ve.x,ve.y)),unwrapped:!1}}(t,s);if(f)return f;const _=function(g,b){let T=!1,A=-1/0,z=0;for(let F=0;F<g.length-1;F++)g[F].x>A&&(A=g[F].x,z=F);for(let F=0;F<g.length-1;F++){const O=(z+F)%(g.length-1),U=g[O],H=g[O+1];Math.abs(U.x-H.x)>.5&&(U.x<H.x?(U.x+=1,O===0&&(g[g.length-1].x+=1)):(H.x+=1,O+1===g.length-1&&(g[0].x+=1)),T=!0)}const D=r.ay(b.center.lng);return T&&D<Math.abs(D-1)&&g.forEach(F=>{F.x-=1}),{polygon:g,unwrapped:T}}(br(t,s).map(g=>new r.P(Dr(g.x),g.y)),s);return{polygon:_.polygon.map(g=>new r.ac(g.x,g.y)),unwrapped:_.unwrapped}}}function br(h,t){return r.aC(h,s=>{const f=t.pointCoordinate3D(s);s.x=f.x,s.y=f.y},1/256)}function Dr(h){return h<0?1+h%1:h%1}function Gs(h){return 100*h|0}function jr(h,t,s,f,_){const g=function(T,A){if(T)return _(T);if(A){if(h.url&&A.tiles&&h.tiles&&delete h.tiles,A.variants){if(!Array.isArray(A.variants))return _(new Error("variants must be an array"));for(const D of A.variants){if(D==null||typeof D!="object"||D.constructor!==Object)return _(new Error("variant must be an object"));if(!Array.isArray(D.capabilities))return _(new Error("capabilities must be an array"));if(D.capabilities.length===1&&D.capabilities[0]==="meshopt"){A=r.l(A,D);break}}}const z=r.aF(r.l({},A,h),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);z.tiles=t.canonicalizeTileset(z,h.url),_(null,z)}},b=function(T,A,z){if(!T)return null;if(!A&&!z)return T;z=z||T.worldview_default;const D=Object.values(T.language||{});if(D.length===0)return null;const F=Object.values(T.worldview||{});if(F.length===0)return null;const O=D.every(H=>H===A),U=F.every(H=>H===z);return O&&U?T:A in(T.language_options||{})||z in(T.worldview_options||{})?null:T.language_options&&T.worldview_options?T:null}(h.data,s,f);return b?r.q.frame(()=>g(null,b)):h.url?r.n(t.transformRequest(t.normalizeSourceURL(h.url,null,s,f),r.R.Source),g):r.q.frame(()=>{const{data:T,...A}=h;g(null,A)})}function $r(h,t){const s=Math.pow(2,t.z),f=Math.floor(r.ay(h.getWest())*s),_=Math.floor(r.aH(h.getNorth())*s),g=Math.ceil(r.ay(h.getEast())*s),b=Math.ceil(r.aH(h.getSouth())*s);return t.x>=f&&t.x<g&&t.y>=_&&t.y<b}class Mr{constructor(t,s,f){this.bounds=t?r.aG.convert(this.validateBounds(t)):null,this.minzoom=s||0,this.maxzoom=f||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const s of t)this.extraBounds.push(r.aG.convert(this.validateBounds(s)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!$r(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const s of this.extraBounds)if($r(s,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const s=new Mr(t.bounds,t.minzoom,t.maxzoom);return s.addExtraBounds(t.extra_bounds),s}}class Or extends r.E{constructor(t,s,f,_){if(super(),this.id=t,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,r.l(this,r.aF(s,["url","scheme","tileSize","promoteId"])),this._options=r.l({type:"vector"},s),this._collectResourceTiming=!!s.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(_),this._tileWorkers={},this._deduped=new r.aI}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));const s=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map.getWorldview();this._tileJSONRequest=jr(this._options,this.map._requestManager,s,f,(_,g)=>{if(this._tileJSONRequest=null,this._loaded=!0,_)s&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${s}`),f&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new r.z(_));else if(g){if(r.l(this,g),this.hasWorldviews=!!g.worldview_options,g.worldview_default&&(this.worldviewDefault=g.worldview_default),g.vector_layers){this.vectorLayers=g.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const b of g.vector_layers)this.vectorLayerIds.push(b.id),g.worldview&&g.worldview[b.source]&&this.localizableLayerIds.add(b.id)}this.tileBounds=Mr.fromTileJSON(g),yn(g.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(_)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.l({},this._options)}loadTile(t,s){const f=t.tileID.canonical.url(this.tiles,this.scheme),_=this.map._requestManager.normalizeTileURL(f),g=this.map._requestManager.transformRequest(_,r.R.Tile),b=this.map.style?this.map.style.getLut(this.scope):null,T=b?{image:b.image.clone()}:null,A={request:g,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:T,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&r.f(f)&&(A.worldview=this.map.getWorldview()||this.worldviewDefault,A.localizableLayerIds=this.localizableLayerIds),A.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=s:t.request=t.actor.send("reloadTile",A,z.bind(this));else if(t.actor=this._tileWorkers[_]=this._tileWorkers[_]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",A,z.bind(this),void 0,!0);else{const D=r.aJ.call({deduped:this._deduped},A,(F,O)=>{F||!O?z.call(this,F):(A.data={cacheControl:O.cacheControl,expires:O.expires,rawData:O.rawData.slice(0)},t.actor&&t.actor.send("loadTile",A,z.bind(this),void 0,!0))},!0);t.request={cancel:D}}function z(D,F){return delete t.request,t.aborted?s(null):D&&D.status!==404?s(D):(F&&F.resourceTiming&&(t.resourceTiming=F.resourceTiming),this.map._refreshExpiredTiles&&F&&t.setExpiryData(F),t.loadVectorData(F,this.map.painter),r.aK(this.dispatcher),s(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,s){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ss extends r.E{constructor(t,s,f,_){super(),this.id=t,this.dispatcher=f,this.setEventedParent(_),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=r.l({type:"raster"},s),r.l(this,r.aF(s,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"})),this._tileJSONRequest=jr(this._options,this.map._requestManager,null,null,(s,f)=>{this._tileJSONRequest=null,this._loaded=!0,s?this.fire(new r.z(s)):f&&(r.l(this,f),f.raster_layers&&(this.rasterLayers=f.raster_layers,this.rasterLayerIds=this.rasterLayers.map(_=>_.id)),this.tileBounds=Mr.fromTileJSON(f),yn(f.tiles),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(s)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return r.l({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,s){const f=r.q.devicePixelRatio>=2,_=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);t.request=r.o(this.map._requestManager.transformRequest(_,r.R.Tile),(g,b,T,A)=>(delete t.request,t.aborted?(t.state="unloaded",s(null)):g?(t.state="errored",s(g)):b?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:T,expires:A}),t.setTexture(b,this.map.painter),t.state="loaded",r.aK(this.dispatcher),void s(null)):s(null)))}abortTile(t,s){t.request&&(t.request.cancel(),delete t.request),s&&s()}unloadTile(t,s){t.texture&&t.texture instanceof r.T?(t.destroy(!0),t.texture&&t.texture instanceof r.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),s&&s()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class nl extends Ss{constructor(t,s,f,_){super(t,s,f,_),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=r.l({type:"raster-array"},s)}triggerRepaint(t){const s=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);s&&s.enabled&&f&&s._clearRenderCacheForTile(f.id,t.tileID),this.map.triggerRepaint()}loadTile(t,s){const f=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),_=this.map._requestManager.transformRequest(f,r.R.Tile),g={request:_,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=_,t.actor||(t.actor=this.dispatcher.getActor());const b=(T,A,z,D)=>{if(delete t.request,t.aborted)return t.state="unloaded",s(null);if(T)return T.name==="AbortError"?void 0:(t.state="errored",s(T));if(this.map._refreshExpiredTiles&&A&&t.setExpiryData({cacheControl:z,expires:D}),this.partial)t.state="empty";else{if(!A)return s(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=A}s(null)};t.request=this.partial?t.fetchHeader(void 0,b.bind(this)):t.actor.send("loadTile",g,b.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,s){const f=t.texture;f&&f instanceof r.T?(t.destroy(!0),this.map.painter.saveTileTexture(f)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,s,f){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(s,f,(_,g)=>{if(_)return t.state="errored",this.fire(new r.z(_)),void this.triggerRepaint(t);g&&(t._isHeaderLoaded=!0,t.setTexture(g,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const s=this.rasterLayers.find(({id:g})=>g===t),f=s&&s.fields,_=f&&f.bands&&f.bands;return _?_[0]:0}getTextureDescriptor(t,s,f){if(!t)return;const _=s.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!_)return;let g=null;s instanceof r.aN?g=s.paint.get("raster-array-band"):s instanceof r.aO&&(g=s.paint.get("raster-particle-array-band"));const b=g||this.getInitialBand(_);if(b!=null)if(t.textureDescriptor){if(!t.updateNeeded(_,b)||f)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,_,b)}getImages(t,s){const f=new Map;for(const _ of t)for(const g of s){const[b,T]=g.split("/"),A=_.getLayer(b);if(!A||!A.hasBand(T)||!A.hasDataForBand(T))continue;const{bytes:z,tileSize:D,buffer:F}=A.getBandView(T),O=D+2*F,U={data:new r.r({width:O,height:O},z),pixelRatio:2,sdf:!1,usvg:!1,version:0};f.set(g,U)}return f}}const hu={vector:Or,raster:Ss,"raster-dem":class extends Ss{constructor(h,t,s,f){super(h,t,s,f),this.type="raster-dem",this.maxzoom=22,this._options=r.l({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(h,t){const s=this.map._requestManager.normalizeTileURL(h.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(_,g){_&&(h.state="errored",t(_)),g&&(h.dem=g,h.dem.onDeserialize(),h.needsHillshadePrepare=!0,h.needsDEMTextureUpload=!0,h.state="loaded",t(null))}h.request=r.o(this.map._requestManager.transformRequest(s,r.R.Tile),(function(_,g,b,T){if(delete h.request,h.aborted)h.state="unloaded",t(null);else if(_)h.state="errored",t(_);else if(g){this.map._refreshExpiredTiles&&h.setExpiryData({cacheControl:b,expires:T});const A=ImageBitmap&&g instanceof ImageBitmap&&r.t(),z=1-(g.width-r.aL(g.width))/2;z<1||h.neighboringTiles||(h.neighboringTiles=this._getNeighboringTiles(h.tileID));const D=A?g:r.q.getImageData(g,z),F={uid:h.uid,tileID:h.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:D,encoding:this.encoding,padding:z};h.actor&&h.state!=="expired"||(h.actor=this.dispatcher.getActor(),h.actor.send("loadTile",F,f.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(h){const t=h.canonical,s=Math.pow(2,t.z),f=(t.x-1+s)%s,_=t.x===0?h.wrap-1:h.wrap,g=(t.x+1+s)%s,b=t.x+1===s?h.wrap+1:h.wrap,T={};return T[new r.aM(h.overscaledZ,_,t.z,f,t.y).key]={backfilled:!1},T[new r.aM(h.overscaledZ,b,t.z,g,t.y).key]={backfilled:!1},t.y>0&&(T[new r.aM(h.overscaledZ,_,t.z,f,t.y-1).key]={backfilled:!1},T[new r.aM(h.overscaledZ,h.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},T[new r.aM(h.overscaledZ,b,t.z,g,t.y-1).key]={backfilled:!1}),t.y+1<s&&(T[new r.aM(h.overscaledZ,_,t.z,f,t.y+1).key]={backfilled:!1},T[new r.aM(h.overscaledZ,h.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},T[new r.aM(h.overscaledZ,b,t.z,g,t.y+1).key]={backfilled:!1}),T}},"raster-array":nl,geojson:class extends r.E{constructor(h,t,s,f){super(),this.id=h,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=s.getActor(),this.setEventedParent(f),this._data=t.data,this._options=r.l({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const _=r.aj/this.tileSize;this.workerOptions=r.l({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*_,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*_,extent:r.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:r.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*_,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(h){this.map=h,this.setData(this._data)}setData(h){return this._data=h,this._updateWorkerData(),this}updateData(h){if(!this._options.dynamic)return this.fire(new r.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof h!="string"&&(h.type==="Feature"&&(h={type:"FeatureCollection",features:[h]}),h.type!=="FeatureCollection"))return this.fire(new r.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof h!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const s of this._data.features)t.set(s.id,s);for(const s of h.features)t.set(s.id,s);this._data.features=[...t.values()]}else this._data=h;return this._updateWorkerData(!0),this}getClusterExpansionZoom(h,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:h,source:this.id,scope:this.scope},t),this}getClusterChildren(h,t){return this.actor.send("geojson.getClusterChildren",{clusterId:h,source:this.id,scope:this.scope},t),this}getClusterLeaves(h,t,s,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:h,limit:t,offset:s},f),this}_updateWorkerData(h=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new r.A("dataloading",{dataType:"source"})),this._loaded=!1;const t=r.l({append:h},this.workerOptions);t.scope=this.scope;const s=this._data;typeof s=="string"?(t.request=this.map._requestManager.transformRequest(r.q.resolveURL(s),r.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(s),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(f,_)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new r.z(f));else{const g={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&_&&_.resourceTiming&&_.resourceTiming[this.id]&&(g.resourceTiming=_.resourceTiming[this.id]),h&&(this._partialReload=!0),this.fire(new r.A("data",g)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(h),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const h=r.C(this.id,this.scope);this.map.style.clearSource(h),this._updateWorkerData()}loadTile(h,t){const s=h.actor?"reloadTile":"loadTile";h.actor=this.actor;const f=this.map.style?this.map.style.getLut(this.scope):null,_=f?{image:f.image.clone()}:null,g=this._partialReload,b={type:this.type,uid:h.uid,tileID:h.tileID,tileZoom:h.tileZoom,zoom:h.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:_,scope:this.scope,pixelRatio:r.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:h.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:g};h.request=this.actor.send(s,b,(T,A)=>g&&!A?(h.state="loaded",t(null)):(delete h.request,h.destroy(),h.aborted?t(null):T?t(T):(h.loadVectorData(A,this.map.painter,s==="reloadTile"),t(null))),void 0,s==="loadTile")}abortTile(h){h.request&&(h.request.cancel(),delete h.request),h.aborted=!0}unloadTile(h,t){this.actor.send("removeTile",{uid:h.uid,type:this.type,source:this.id,scope:this.scope}),h.destroy()}onRemove(h){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return r.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends r.aP{constructor(h,t,s,f){super(h,t,s,f),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const h=this.options;this.urls=[];for(const t of h.urls)this.urls.push(this.map._requestManager.transformRequest(t,r.R.Source).url);r.aQ(this.urls,(t,s)=>{this._loaded=!0,t?this.fire(new r.z(t)):s&&(this.video=s,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(h){if(this.video){const t=this.video.seekable;h<t.start(0)||h>t.end(0)?this.fire(new r.z(new r.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=h}}getVideo(){return this.video}onAdd(h){this.map||(this.map=h,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const h=this.map.painter.context,t=h.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new r.T(h,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(h)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:r.aP,model:class extends r.E{constructor(h,t,s,f){super(),this.id=h,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const h=[];for(const t in this._options.models){const s=this._options.models[t],f=r.aS(this.map._requestManager.transformRequest(s.uri,r.R.Model).url).then(_=>{if(!_)return;const g=r.aT(_),b=new r.aU(t,s.position,s.orientation,g);b.computeBoundsAndApplyParent(),this.models.push(b)}).catch(_=>{this.fire(new r.z(new Error(`Could not load model ${t} from ${s.uri}: ${_.message}`)))});h.push(f)}Promise.allSettled(h).then(()=>{this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new r.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(h){this.map=h,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(h,t){}serialize(){return this._options}},"batched-model":class extends r.E{constructor(h,t,s,f){super(),this.type="batched-model",this.id=h,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=s,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(h){this.map=h,this.load()}reload(){this.cancelTileJSONRequest();const h=r.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(h))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(h){this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,s=this.map.getWorldview();this._tileJSONRequest=jr(this._options,this.map._requestManager,t,s,(f,_)=>{this._tileJSONRequest=null,this._loaded=!0,f?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),s&&s.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${s}`),this.fire(new r.z(f))):_&&(r.l(this,_),_.bounds&&(this.tileBounds=new Mr(_.bounds,this.minzoom,this.maxzoom)),yn(_.tiles,this.map._requestManager._customAccessToken),this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))),h&&h(f)})}hasTransition(){return!1}hasTile(h){return!this.tileBounds||this.tileBounds.contains(h.canonical)}loaded(){return this._loaded}loadTile(h,t){const s=this.map._requestManager.normalizeTileURL(h.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(s,r.R.Tile),data:void 0,uid:h.uid,tileID:h.tileID,tileZoom:h.tileZoom,zoom:h.tileID.overscaledZ,tileSize:this.tileSize*h.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:h.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:r.q.devicePixelRatio,promoteId:this.promoteId};if(h.actor&&h.state!=="expired")if(h.state==="loading")h.reloadCallback=t;else{if(h.buckets){const g=Object.values(h.buckets);for(const b of g)b.dirty=!0;return void(h.state="loaded")}h.request=h.actor.send("reloadTile",f,_.bind(this))}else h.actor=this.dispatcher.getActor(),h.request=h.actor.send("loadTile",f,_.bind(this),void 0,!0);function _(g,b){return h.aborted?t(null):g&&g.status!==404?t(g):(this.map._refreshExpiredTiles&&b&&h.setExpiryData(b),h.loadModelData(b,this.map.painter),h.state="loaded",void t(null))}}serialize(){return r.l({},this._options)}},canvas:class extends r.aP{constructor(h,t,s,f){super(h,t,s,f),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(_=>!Array.isArray(_)||_.length!==2||_.some(g=>typeof g!="number"))||this.fire(new r.z(new r.V(`sources.${h}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new r.z(new r.V(`sources.${h}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new r.z(new r.V(`sources.${h}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new r.z(new r.V(`sources.${h}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new r.z(new r.V(`sources.${h}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new r.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(h){this.map=h,this.load(),this.canvas&&this.animate&&this.play()}onRemove(h){this.pause()}prepare(){let h=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,h=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,h=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!h&&!this._playing||this.texture instanceof r.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new r.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const h of[this.canvas.width,this.canvas.height])if(isNaN(h)||h<=0)return!0;return!1}},custom:class extends r.E{constructor(h,t,s,f){super(),this.id=h,this.type="custom",this._dataType="raster",this._dispatcher=s,this._implementation=t,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new r.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new r.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Mr(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),r.l(this,r.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return r.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new r.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(h){this.map=h,this._loaded=!1,this.fire(new r.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(h),this.load()}onRemove(h){this._implementation.onRemove&&this._implementation.onRemove(h)}hasTile(h){if(this._implementation.hasTile){const{x:t,y:s,z:f}=h.canonical;return this._implementation.hasTile({x:t,y:s,z:f})}return!this.tileBounds||this.tileBounds.contains(h.canonical)}loadTile(h,t){const{x:s,y:f,z:_}=h.tileID.canonical,g=new AbortController;h.request=Promise.resolve(this._implementation.loadTile({x:s,y:f,z:_},{signal:g.signal})).then((function(b){return delete h.request,h.aborted?(h.state="unloaded",t(null)):b===void 0?(h.state="errored",t(null)):b===null?(this.loadTileData(h,{width:this.tileSize,height:this.tileSize,data:null}),h.state="loaded",t(null)):function(T){return T instanceof ImageData||T instanceof HTMLCanvasElement||T instanceof ImageBitmap||T instanceof HTMLImageElement}(b)?(this.loadTileData(h,b),h.state="loaded",void t(null)):(h.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(b=>{b.name!=="AbortError"&&(h.state="errored",t(b))}),h.request.cancel=()=>g.abort()}loadTileData(h,t){h.setTexture(t,this.map.painter)}unloadTile(h,t){if(h.texture&&h.texture instanceof r.T?(h.destroy(!0),h.texture&&h.texture instanceof r.T&&this.map.painter.saveTileTexture(h.texture)):h.destroy(),this._implementation.unloadTile){const{x:s,y:f,z:_}=h.tileID.canonical;this._implementation.unloadTile({x:s,y:f,z:_})}t&&t()}abortTile(h,t){h.request&&h.request.cancel&&(h.request.cancel(),delete h.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(h=>({x:h.canonical.x,y:h.canonical.y,z:h.canonical.z}))}_clearTiles(){const h=r.C(this.id,this.scope);this.map.style.clearSource(h)}_update(){this.fire(new r.A("data",{dataType:"source",sourceDataType:"content"}))}}},Kl=function(h,t,s,f){const _=new hu[t.type](h,t,s,f);if(_.id!==h)throw new Error(`Expected Source id to be ${h} instead of ${_.id}`);return r.aV(["load","abort","unload","serialize","prepare"],_),_};function Vh(h,t,s=""){return`${s}:${t.id||""}:${t.layer.id}:${function(f){if("layerId"in f)return`layer:${f.layerId}`;{const{featuresetId:_,importId:g}=f;return`featureset:${_}${g?`:import:${g}`:""}`}}(h.target)}`}function fu(h,t,s,f=""){if(h.uniqueFeatureID){const _=Vh(h,t,f);if(s.has(_))return!0;s.add(_)}return!1}function il(h,t,s,f,_=!1){const g=t.sourceCache.transform,b=t.sourceCache.tilesIn(h,t.has3DLayers,_);b.sort(rs);const T=[];for(const A of b){const z=A.tile.queryRenderedFeatures(t,A,s,f,g,_);Object.keys(z).length&&T.push({wrappedTileID:A.tile.tileID.wrapped().key,queryResults:z})}return T.length===0?{}:function(A){const z={},D={};for(const F of A){const O=F.queryResults,U=F.wrappedTileID,H=D[U]=D[U]||{};for(const q in O){const Y=O[q],Z=H[q]=H[q]||{},oe=z[q]=z[q]||[];for(const fe of Y)Z[fe.featureIndex]||(Z[fe.featureIndex]=!0,oe.push(fe))}}return z}(T)}function du(h,t,s,f,_){const g={},b=f.queryRenderedSymbols(h),T=[];for(const A of Object.keys(b).map(Number))T.push(_[A]);T.sort(rs);for(const A of T){const z=A.featureIndex.lookupSymbolFeatures(b[A.bucketInstanceId],A.bucketIndex,A.sourceLayerIndex,t,s);for(const D in z){const F=g[D]=g[D]||[],O=z[D];O.sort((U,H)=>{const q=A.featureSortOrder;if(q){const Y=q.indexOf(U.featureIndex);return q.indexOf(H.featureIndex)-Y}return H.featureIndex-U.featureIndex});for(const U of O)F.push(U)}}return g}function Yd(h,t){const s=h.getRenderableIds().map(g=>h.getTileByID(g)),f=[],_={};for(let g=0;g<s.length;g++){const b=s[g],T=b.tileID.canonical.key;_[T]||(_[T]=!0,b.querySourceFeatures(f,t))}return f}function rs(h,t){const s=h.tileID,f=t.tileID;return s.overscaledZ-f.overscaledZ||s.canonical.y-f.canonical.y||s.wrap-f.wrap||s.canonical.x-f.canonical.x}function Kd(h,t){const s={};if(!t)return s;for(const f of h){const _=f.layerIds.map(g=>t.getLayer(g)).filter(Boolean);if(_.length!==0){f.layers=_,f.stateDependentLayerIds&&(f.stateDependentLayers=f.stateDependentLayerIds.map(g=>_.filter(b=>b.id===g)[0]));for(const g of _)s[g.fqid]=f}}return s}const po=32,os=33,qs=new Uint16Array(8184);for(let h=0;h<2046;h++){let t=h+2,s=0,f=0,_=0,g=0,b=0,T=0;for(1&t?_=g=b=po:s=f=T=po;(t>>=1)>1;){const z=s+_>>1,D=f+g>>1;1&t?(_=s,g=f,s=b,f=T):(s=_,f=g,_=b,g=T),b=z,T=D}const A=4*h;qs[A+0]=s,qs[A+1]=f,qs[A+2]=_,qs[A+3]=g}const ss=new Uint16Array(2178),Hs=new Uint8Array(1089),Ho=new Uint16Array(1089);function pu(h){return h===0?-.03125:h===32?.03125:0}const Jd={type:2,extent:r.aj,loadGeometry:()=>[[new r.P(0,0),new r.P(r.aj+1,0),new r.P(r.aj+1,r.aj+1),new r.P(0,r.aj+1),new r.P(0,0)]]};class Zs{constructor(t,s,f,_,g){this.tileID=t,this.uid=r.a$(),this.uses=0,this.tileSize=s,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=g,_&&_.style&&(this._lastUpdatedBrightness=_.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",_&&_.transform&&(this.projection=_.transform.projection)}registerFadeDuration(t){const s=t+this.timeAdded;s<r.q.now()||this.fadeEndTime&&s<this.fadeEndTime||(this.fadeEndTime=s)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=r.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,s,f){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Kd(t.buckets,s.style),this.hasSymbolBuckets=!1;for(const _ in this.buckets){const g=this.buckets[_];if(g instanceof r.b1){if(this.hasSymbolBuckets=!0,!f)break;g.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const _ in this.buckets){const g=this.buckets[_];if(g instanceof r.b1&&g.hasRTLText){this.hasRTLText=!0,r.b2();break}}this.queryPadding=0;for(const _ in this.buckets){const g=this.buckets[_],b=s.style.getOwnLayer(_);if(!b)continue;const T=b.queryRadius(g);this.queryPadding=Math.max(this.queryPadding,T)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new r.b0}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,s,f){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Kd(t.buckets,s.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const _ in this.buckets){const g=this.buckets[_];g.uploadPending()&&g.upload(t)}const s=t.gl,f=this.imageAtlas;f&&!f.uploaded&&(this.imageAtlasTexture=new r.T(t,f.image,s.RGBA8,{useMipmap:!!f.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new r.T(t,this.glyphAtlasImage,s.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new r.T(t,this.lineAtlas.image,s.R8),this.lineAtlas.uploaded=!0)}prepare(t,s,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,f),!s||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const _=s.style.getBrightness();(this._lastUpdatedBrightness||_)&&(this._lastUpdatedBrightness&&_&&Math.abs(this._lastUpdatedBrightness-_)<.001||(this.updateBuckets(s,this._lastUpdatedBrightness!==_),this._lastUpdatedBrightness=_))}queryRenderedFeatures(t,s,f,_,g,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const T=function(A,z){const D=r.bn([],[.5*A.width,.5*-A.height,1]);return r.bo(D,D,[1,-1,0]),r.az(D,D,A.calculateProjMatrix(z.toUnwrapped())),Float32Array.from(D)}(g,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:s,pixelPosMatrix:T,transform:_,availableImages:f,tileTransform:this.tileTransform})}querySourceFeatures(t,s){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const _=f.loadVTLayers(),g=s?s.sourceLayer:"",b=_._geojsonTileLayer||_[g];if(!b)return;const T=r.b3(s&&s.filter),{z:A,x:z,y:D}=this.tileID.canonical,F={z:A,x:z,y:D};for(let O=0;O<b.length;O++){const U=b.feature(O);if(T.needGeometry){const Y=r.b4(U,!0);if(!T.filter(new r.aa(this.tileID.overscaledZ),Y,this.tileID.canonical))continue}else if(!T.filter(new r.aa(this.tileID.overscaledZ),U))continue;const H=f.getId(U,g),q=new r.b5(U,A,z,D,H);q.tile=F,t.push(q)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const s=this.expirationTime;if(t.cacheControl){const f=r.b6(t.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const f=Date.now();let _=!1;if(this.expirationTime>f)_=!1;else if(s)if(this.expirationTime<s)_=!0;else{const g=this.expirationTime-s;g?this.expirationTime=f+Math.max(g,3e4):_=!0}else _=!0;_?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,s){if(!this.latestFeatureIndex||!t.style)return;const f=this.latestFeatureIndex.loadVTLayers(),_=t.style.listImages(),g=t.style.getBrightness();for(const b in this.buckets){if(!t.style.hasLayer(b))continue;const T=this.buckets[b],A=T.layers[0],z=A.sourceLayer||"_geojsonTileLayer",D=f[z],F=t.style.getLayerSourceCache(A);let O={};F&&(O=F._state.getState(z,void 0));const U=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},H=Object.keys(O).length>0&&!s;H&&!T.stateDependentLayers.length&&!s||T.update(O,D,_,U,H?T.stateDependentLayers:T.layers,s,g),(T instanceof r.b7||T instanceof r.b8)&&t._terrain&&t._terrain.enabled&&F&&T.uploadPending()&&t._terrain._clearRenderCacheForTile(F.id,this.tileID);const q=t&&t.style&&t.style.getOwnLayer(b);q&&(this.queryPadding=Math.max(this.queryPadding,q.queryRadius(T)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<r.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=r.q.now()+t}setTexture(t,s){const f=s.context,_=f.gl;this.texture=this.texture||s.getTileTexture(t.width),this.texture&&this.texture instanceof r.T?this.texture.update(t):(this.texture=new r.T(f,t,_.RGBA8,{useMipmap:!0}),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE))}setDependencies(t,s){const f={};for(const _ of s)f[_]=!0;this.dependencies[t]=f}hasDependency(t,s){for(const f of t){const _=this.dependencies[f];if(_){for(const g of s)if(_[g])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,s){if(!s||s.name==="mercator"||this._tileDebugBuffer)return;const f=r.b9(Jd,this.tileID.canonical,this.tileTransform)[0],_=new r.ba,g=new r.bb;for(let b=0;b<f.length;b++){const{x:T,y:A}=f[b];_.emplaceBack(T,A),g.emplaceBack(b)}g.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(g),this._tileDebugBuffer=t.createVertexBuffer(_,r.bc.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,_.length,g.length)}_makeTileBoundsBuffers(t,s){if(this._tileBoundsBuffer||!s||s.name==="mercator")return;const f=r.b9(Jd,this.tileID.canonical,this.tileTransform)[0];let _,g;if(this.isRaster){const b=function(T,A){const z=r.aW(T,A),D=Math.pow(2,T.z);for(let Y=0;Y<os;Y++)for(let Z=0;Z<os;Z++){const oe=r.aX((T.x+(Z+pu(Z))/po)/D),fe=r.aY((T.y+(Y+pu(Y))/po)/D),me=A.project(oe,fe),xe=Y*os+Z;ss[2*xe+0]=Math.round((me.x*z.scale-z.x)*r.aj),ss[2*xe+1]=Math.round((me.y*z.scale-z.y)*r.aj)}Hs.fill(0),Ho.fill(0);for(let Y=2045;Y>=0;Y--){const Z=4*Y,oe=qs[Z+0],fe=qs[Z+1],me=qs[Z+2],xe=qs[Z+3],ye=oe+me>>1,ve=fe+xe>>1,_e=ye+ve-fe,we=ve+oe-ye,Te=fe*os+oe,Ue=xe*os+me,Fe=ve*os+ye,ot=Math.hypot((ss[2*Te+0]+ss[2*Ue+0])/2-ss[2*Fe+0],(ss[2*Te+1]+ss[2*Ue+1])/2-ss[2*Fe+1])>=16;Hs[Fe]=Hs[Fe]||(ot?1:0),Y<1022&&(Hs[Fe]=Hs[Fe]||Hs[(fe+we>>1)*os+(oe+_e>>1)]||Hs[(xe+we>>1)*os+(me+_e>>1)])}const F=new r.aZ,O=new r.a_;let U=0;function H(Y,Z){const oe=Z*os+Y;return Ho[oe]===0&&(F.emplaceBack(ss[2*oe+0],ss[2*oe+1],Y*r.aj/po,Z*r.aj/po),Ho[oe]=++U),Ho[oe]-1}function q(Y,Z,oe,fe,me,xe){const ye=Y+oe>>1,ve=Z+fe>>1;if(Math.abs(Y-me)+Math.abs(Z-xe)>1&&Hs[ve*os+ye])q(me,xe,Y,Z,ye,ve),q(oe,fe,me,xe,ye,ve);else{const _e=H(Y,Z),we=H(oe,fe),Te=H(me,xe);O.emplaceBack(_e,we,Te)}}return q(0,0,po,po,po,0),q(po,po,0,0,0,po),{vertices:F,indices:O}}(this.tileID.canonical,s);_=b.vertices,g=b.indices}else{_=new r.aZ,g=new r.a_;for(const{x:T,y:A}of f)_.emplaceBack(T,A,0,0);const b=r.be(_.int16.subarray(0,4*_.length),void 0,4);for(let T=0;T<b.length;T+=3)g.emplaceBack(b[T],b[T+1],b[T+2])}this._tileBoundsBuffer=t.createVertexBuffer(_,r.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(g),this._tileBoundsSegments=r.bd.simpleSegment(0,0,_.length,g.length)}_makeGlobeTileDebugBuffers(t,s){const f=s.projection;if(!f||f.name!=="globe"||s.freezeTileCoverage)return;const _=this.tileID.canonical,g=r.bg(_,s),b=r.bh(g),T=r.ah(s.zoom);let A;T>0&&(A=r.bi(new Float64Array(16),s.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,_,s,b,A,T),this._makeGlobeTileDebugTextBuffer(t,_,s,b,A,T)}_globePoint(t,s,f,_,g,b,T){let A=r.bj(t,s,f);if(b){const z=1<<f.z,D=r.ay(_.center.lng),F=r.aH(_.center.lat),O=(f.x+.5)/z-D;let U=0;O>.5?U=-1:O<-.5&&(U=1);let H=(t/r.aj+f.x)/z+U,q=(s/r.aj+f.y)/z;H=(H-D)*_._pixelsPerMercatorPixel+D,q=(q-F)*_._pixelsPerMercatorPixel+F;const Y=[H*_.worldSize,q*_.worldSize,0];r.ad(Y,Y,b),A=r.bk(A,Y,T)}return r.ad(A,A,g)}_makeGlobeTileDebugBorderBuffer(t,s,f,_,g,b){const T=new r.ba,A=new r.bb,z=new r.bl,D=(O,U,H,q,Y)=>{const Z=(H-O)/(Y-1),oe=(q-U)/(Y-1),fe=T.length;for(let me=0;me<Y;me++){const xe=O+me*Z,ye=U+me*oe;T.emplaceBack(xe,ye);const ve=this._globePoint(xe,ye,s,f,_,g,b);z.emplaceBack(ve[0],ve[1],ve[2]),A.emplaceBack(fe+me)}},F=r.aj;D(0,0,F,0,16),D(F,0,F,F,16),D(F,F,0,F,16),D(0,F,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(A),this._tileDebugBuffer=t.createVertexBuffer(T,r.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(z,r.bm.members),this._tileDebugSegments=r.bd.simpleSegment(0,0,T.length,A.length)}_makeGlobeTileDebugTextBuffer(t,s,f,_,g,b){const T=r.aj/4,A=new r.ba,z=new r.a_,D=new r.bl,F=25;z.reserve(32),A.reserve(F),D.reserve(F);const O=(U,H)=>F*U+H;for(let U=0;U<F;U++){const H=U*T;for(let q=0;q<F;q++){const Y=q*T;A.emplaceBack(Y,H);const Z=this._globePoint(Y,H,s,f,_,g,b);D.emplaceBack(Z[0],Z[1],Z[2])}}for(let U=0;U<4;U++)for(let H=0;H<4;H++){const q=O(U,H),Y=O(U,H+1),Z=O(U+1,H),oe=O(U+1,H+1);z.emplaceBack(q,Y,Z),z.emplaceBack(Z,Y,oe)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(z),this._tileDebugTextBuffer=t.createVertexBuffer(A,r.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(D,r.bm.members),this._tileDebugTextSegments=r.bd.simpleSegment(0,0,F,32)}destroy(t=!1){for(const s in this.buckets)this.buckets[s].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof r.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}r.bp.setPbf(r.bq);class mu extends Zs{constructor(t,s,f,_,g){super(t,s,f,_,g),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexture(t,s){const f=s.context,_=f.gl;this.texture=this.texture||s.getTileTexture(t.width),this.texture&&this.texture instanceof r.T?this.texture.update(t,{premultiply:!1}):this.texture=new r.T(f,t,_.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,s){const f=this._mrt=new r.bp(30),_=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=r.br(_,(g,b,T,A)=>{if(g)s(g);else try{const z=f.getHeaderLength(b);if(z>t)return void(this.request=this.fetchHeader(z,s));f.parseHeader(b),this._isHeaderLoaded=!0;let D=0;for(const F of Object.values(f.layers))D=Math.max(D,F.dataIndex[F.dataIndex.length-1].lastByte);b.byteLength>=D&&(this.entireBuffer=b),s(null,this.entireBuffer||b,T,A)}catch(z){s(z)}}),this.request}fetchBand(t,s,f){const _=this._mrt;if(!this._isHeaderLoaded||!_)return void f(new Error("Tile header is not ready"));const g=this.actor;if(!g)return void f(new Error("Can't fetch tile band without an actor"));let b;const T=(F,O)=>{b.complete(F,O),F?f(F):(this.updateTextureDescriptor(t,s),f(null,this.textureDescriptor&&this.textureDescriptor.img))},A=(F,O)=>{if(F)return f(F);const U=g.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:O,task:b},T,void 0,!0);this._workQueue.push(()=>{U&&U.cancel(),b.cancel()})},z=_.getLayer(t);if(!z)return void f(new Error(`Unknown sourceLayer "${t}"`));if(z.hasDataForBand(s))return this.updateTextureDescriptor(t,s),void f(null,this.textureDescriptor?this.textureDescriptor.img:null);const D=z.getDataRange([s]);if(b=_.createDecodingTask(D),!b||b.tasks.length)if(this.flushQueues(),this.entireBuffer)A(null,this.entireBuffer.slice(D.firstByte,D.lastByte+1));else{const F=Object.assign({},this.requestParams,{headers:{Range:`bytes=${D.firstByte}-${D.lastByte}`}}),O=r.br(F,A);this._fetchQueue.push(()=>{O.cancel(),b.cancel()})}else f(null)}updateNeeded(t,s){return(!this.textureDescriptor||this.textureDescriptor.band!==s||this.textureDescriptor.layer!==t)&&this.state!=="errored"}updateTextureDescriptor(t,s){if(!this._mrt)return;const f=this._mrt.getLayer(t);if(!f||!f.hasBand(s)||!f.hasDataForBand(s))return;const{bytes:_,tileSize:g,buffer:b,offset:T,scale:A}=f.getBandView(s),z=g+2*b,D=new r.r({width:z,height:z},_),F=this.texture;F&&F instanceof r.T&&F.update(D,{premultiply:!1}),this.textureDescriptor={layer:t,band:s,img:D,buffer:b,offset:T,tileSize:g,format:f.pixelFormat,mix:[A,256*A,65536*A,16777216*A]}}}class Qd{constructor(t,s){this.max=t,this.onRemove=s,this.reset()}reset(){for(const t in this.data)for(const s of this.data[t])s.timeout&&clearTimeout(s.timeout),this.onRemove(s.value);return this.data={},this.order=[],this}add(t,s,f){const _=t.wrapped().key;this.data[_]===void 0&&(this.data[_]=[]);const g={value:s,timeout:void 0};if(f!==void 0&&(g.timeout=setTimeout(()=>{this.remove(t,g)},f)),this.data[_].push(g),this.order.push(_),this.order.length>this.max){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const s=this.data[t].shift();return s.timeout&&clearTimeout(s.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),s.value}getByKey(t){const s=this.data[t];return s?s[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,s){if(!this.has(t))return this;const f=t.wrapped().key,_=s===void 0?0:this.data[f].indexOf(s),g=this.data[f][_];return this.data[f].splice(_,1),g.timeout&&clearTimeout(g.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(g.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const s=this._getAndRemoveByKey(this.order[0]);s&&this.onRemove(s)}return this}filter(t){const s=[];for(const f in this.data)for(const _ of this.data[f])t(_.value)||s.push(_);for(const f of s)this.remove(f.value.tileID,f)}}class _u{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,s,f){const _=String(s);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][_]=this.stateChanges[t][_]||{},r.l(this.stateChanges[t][_],f),this.deletedStates[t]===null){this.deletedStates[t]={};for(const g in this.state[t])g!==_&&(this.deletedStates[t][g]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][_]===null){this.deletedStates[t][_]={};for(const g in this.state[t][_])f[g]||(this.deletedStates[t][_][g]=null)}else for(const g in f)this.deletedStates[t]&&this.deletedStates[t][_]&&this.deletedStates[t][_][g]===null&&delete this.deletedStates[t][_][g]}removeFeatureState(t,s,f){if(this.deletedStates[t]===null)return;const _=String(s);if(this.deletedStates[t]=this.deletedStates[t]||{},f&&s!==void 0)this.deletedStates[t][_]!==null&&(this.deletedStates[t][_]=this.deletedStates[t][_]||{},this.deletedStates[t][_][f]=null);else if(s!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][_])for(f in this.deletedStates[t][_]={},this.stateChanges[t][_])this.deletedStates[t][_][f]=null;else this.deletedStates[t][_]=null;else this.deletedStates[t]=null}getState(t,s){const f=this.state[t]||{},_=this.stateChanges[t]||{},g=this.deletedStates[t];if(g===null)return{};if(s!==void 0){const T=String(s),A=r.l({},f[T],_[T]);if(g){const z=g[s];if(z===null)return{};for(const D in z)delete A[D]}return A}const b=r.l({},f,_);if(g)for(const T in g)delete b[T];return b}initializeTileState(t,s){t.refreshFeatureState(s)}coalesceChanges(t,s){const f={};for(const _ in this.stateChanges){this.state[_]=this.state[_]||{};const g={};for(const b in this.stateChanges[_])this.state[_][b]||(this.state[_][b]={}),r.l(this.state[_][b],this.stateChanges[_][b]),g[b]=this.state[_][b];f[_]=g}for(const _ in this.deletedStates){this.state[_]=this.state[_]||{};const g={};if(this.deletedStates[_]===null)for(const b in this.state[_])g[b]={},this.state[_][b]={};else for(const b in this.deletedStates[_]){if(this.deletedStates[_][b]===null)this.state[_][b]={};else if(this.state[_][b])for(const T of Object.keys(this.deletedStates[_][b]))delete this.state[_][b][T];g[b]=this.state[_][b]}f[_]=f[_]||{},r.l(f[_],g)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const _ in t)t[_].refreshFeatureState(s)}}class Wr extends r.E{constructor(t,s,f){super(),this.id=t,this._onlySymbols=f,s.on("data",_=>{_.dataType==="source"&&_.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&_.dataType==="source"&&_.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),s.on("error",()=>{this._sourceErrored=!0}),this._source=s,this._tiles={},this._cache=new Qd(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=s.minTileCacheSize,this._maxTileCacheSize=s.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new _u,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,s){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,s)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const s in this._tiles){const f=this._tiles[s];f.upload(t),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Uh).map(t=>t.key)}getRenderableIds(t,s){const f=[];for(const _ in this._tiles)this._isIdRenderable(+_,t,s)&&f.push(this._tiles[_]);return t?f.sort((_,g)=>{const b=_.tileID,T=g.tileID,A=new r.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),z=new r.P(T.canonical.x,T.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-T.overscaledZ||z.y-A.y||z.x-A.x}).map(_=>_.tileID.key):f.map(_=>_.tileID).sort(Uh).map(_=>_.key)}hasRenderableParent(t){const s=this.findLoadedParent(t,0);return!!s&&this._isIdRenderable(s.tileID.key)}_isIdRenderable(t,s,f){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(s||!this._tiles[t].holdingForFade())&&(f||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,s){const f=this._tiles[t];f&&(f.state!=="loading"&&(f.state=s),this._loadTile(f,this._tileLoaded.bind(this,f,t,s)))}_tileLoaded(t,s,f,_){if(_)if(t.state="errored",_.status!==404)this._source.fire(new r.z(_,{tile:t}));else{if(this._source.fire(new r.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const g=this.map.painter.terrain;this.update(this.transform,g.getScaledDemTileSize(),!0),g.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=r.q.now(),f==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(s,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new r.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const s=this.getRenderableIds();for(let _=0;_<s.length;_++){const g=s[_];if(t.neighboringTiles&&t.neighboringTiles[g]){const b=this.getTileByID(g);f(t,b),f(b,t)}}function f(_,g){if(!_.dem||_.dem.borderReady)return;_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0;let b=g.tileID.canonical.x-_.tileID.canonical.x;const T=g.tileID.canonical.y-_.tileID.canonical.y,A=Math.pow(2,_.tileID.canonical.z),z=g.tileID.key;b===0&&T===0||Math.abs(T)>1||(Math.abs(b)>1&&(Math.abs(b+A)===1?b+=A:Math.abs(b-A)===1&&(b-=A)),g.dem&&_.dem&&(_.dem.backfillBorder(g.dem,b,T),_.neighboringTiles&&_.neighboringTiles[z]&&(_.neighboringTiles[z].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,s,f,_){for(const g in this._tiles){let b=this._tiles[g];if(_[g]||!b.hasData()||b.tileID.overscaledZ<=s||b.tileID.overscaledZ>f)continue;let T=b.tileID;for(;b&&b.tileID.overscaledZ>s+1;){const z=b.tileID.scaledTo(b.tileID.overscaledZ-1);b=this._tiles[z.key],b&&b.hasData()&&(T=z)}let A=T;for(;A.overscaledZ>s;)if(A=A.scaledTo(A.overscaledZ-1),t[A.key]){_[T.key]=T;break}}}findLoadedParent(t,s){if(t.key in this._loadedParentTiles){const f=this._loadedParentTiles[t.key];return f&&f.tileID.overscaledZ>=s?f:null}for(let f=t.overscaledZ-1;f>=s;f--){const _=t.scaledTo(f),g=this._getLoadedTile(_);if(g)return g}}_getLoadedTile(t){const s=this._tiles[t.key];return s&&s.hasData()?s:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,s){s=s||this._source.tileSize;const f=Math.ceil(t.width/s)+1,_=Math.ceil(t.height/s)+1,g=Math.floor(f*_*5),b=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,g):g,T=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,b):b;this._cache.setMaxSize(T)}handleWrapJump(t){const s=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,s){const f={};for(const _ in this._tiles){const g=this._tiles[_];g.tileID=g.tileID.unwrapTo(g.tileID.wrap+s),f[g.tileID.key]=g}this._tiles=f;for(const _ in this._timers)clearTimeout(this._timers[_]),delete this._timers[_];for(const _ in this._tiles)this._setTileReloadTimer(+_,this._tiles[_])}}update(t,s,f,_,g){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;this.updateCacheSize(t,s),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const b=this._source.type==="batched-model";let T,A=this._source.maxzoom;const z=this.map&&this.map.painter?this.map.painter._terrain:null;if(z&&z.sourceCache===this&&z.attenuationRange()){const O=z.attenuationRange()[0],U=Math.floor(O)-Math.log2(z.getDemUpscale());A>U&&(A=U)}if(this.used||this.usedForTerrain){if(this._source.tileID)T=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(O=>new r.aM(O.canonical.z,O.wrap,O.canonical.z,O.canonical.x,O.canonical.y));else if(this.tileCoverLift!==0){const O=t.clone();O.tileCoverLift=this.tileCoverLift,T=O.coveringTiles({tileSize:s||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:A,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.minzoom<=1&&t.projection.name==="globe"&&(T.push(new r.aM(1,0,1,0,0)),T.push(new r.aM(1,0,1,1,0)),T.push(new r.aM(1,0,1,0,1)),T.push(new r.aM(1,0,1,1,1)))}else if(T=t.coveringTiles({tileSize:s||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:A,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.hasTile){const O=this._source.hasTile.bind(this._source);T=T.filter(U=>O(U))}}else T=[];if(T.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!jh(this._source.type)){const O=t.coveringZoomLevel({tileSize:s||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),U=Math.min(O,this._source.maxzoom);if(b){const H=t.extendTileCover(T,U);for(const q of H)T.push(q)}else if(g){const H=t.extendTileCover(T,U,this.transform._camera.forward());for(const q of H)T.push(q)}else if(this.castsShadows&&_){const H=t.extendTileCover(T,U,_);for(const q of H)this._shadowCasterTiles[q.key]=!0,T.push(q)}}const D=this._updateRetainedTiles(T);if(jh(this._source.type)&&T.length!==0){const O={},U={},H=Object.keys(D);for(const Y of H){const Z=D[Y],oe=this._tiles[Y];if(!oe||oe.fadeEndTime&&oe.fadeEndTime<=r.q.now())continue;const fe=this.findLoadedParent(Z,Math.max(Z.overscaledZ-Wr.maxOverzooming,this._source.minzoom));fe&&(this._addTile(fe.tileID),O[fe.tileID.key]=fe.tileID),U[Y]=Z}const q=T[T.length-1].overscaledZ;for(const Y in this._tiles){const Z=this._tiles[Y];if(D[Y]||!Z.hasData())continue;let oe=Z.tileID;for(;oe.overscaledZ>q;){oe=oe.scaledTo(oe.overscaledZ-1);const fe=this._tiles[oe.key];if(fe&&fe.hasData()&&U[oe.key]){D[Y]=Z.tileID;break}}}for(const Y in O)D[Y]||(this._coveredTiles[Y]=!0,D[Y]=O[Y])}for(const O in D)this._tiles[O].clearFadeHold();const F=r.bs(this._tiles,D);for(const O of F){const U=this._tiles[O];U.hasSymbolBuckets&&!U.holdingForFade()?U.setHoldDuration(this.map._fadeDuration):U.hasSymbolBuckets&&!U.symbolFadeFinished()||this._removeTile(+O)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const s={};if(t.length===0)return s;const f={},_=t.reduce((z,D)=>Math.min(z,D.overscaledZ),1/0),g=t[0].overscaledZ,b=Math.max(g-Wr.maxOverzooming,this._source.minzoom),T=Math.max(g+Wr.maxUnderzooming,this._source.minzoom),A={};for(const z of t){const D=this._addTile(z);s[z.key]=z,D.hasData()||_<this._source.maxzoom&&(A[z.key]=z)}this._retainLoadedChildren(A,_,T,s);for(const z of t){let D=this._tiles[z.key];if(D.hasData())continue;if(z.canonical.z>=this._source.maxzoom){const O=z.children(this._source.maxzoom)[0],U=this.getTile(O);if(U&&U.hasData()){s[O.key]=O;continue}}else{const O=z.children(this._source.maxzoom);if(s[O[0].key]&&s[O[1].key]&&s[O[2].key]&&s[O[3].key])continue}let F=D.wasRequested();for(let O=z.overscaledZ-1;O>=b;--O){const U=z.scaledTo(O);if(f[U.key]||(f[U.key]=!0,D=this.getTile(U),!D&&F&&(D=this._addTile(U)),D&&(s[U.key]=U,F=D.wasRequested(),D.hasData())))break}}return s}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const s=[];let f,_=this._tiles[t].tileID;for(;_.overscaledZ>0;){if(_.key in this._loadedParentTiles){f=this._loadedParentTiles[_.key];break}s.push(_.key);const g=_.scaledTo(_.overscaledZ-1);if(f=this._getLoadedTile(g),f)break;_=g}for(const g of s)this._loadedParentTiles[g]=f}}_addTile(t){let s=this._tiles[t.key];if(s)return s.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),s;s=this._cache.getAndRemove(t),s&&(this._setTileReloadTimer(t.key,s),s.tileID=t,this._state.initializeTileState(s,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,s)));const f=!!s;if(!f){const _=this.map?this.map.painter:null,g=this._source.tileSize*t.overscaleFactor();s=this._source.type==="raster-array"?new mu(t,g,this.transform.tileZoom,_,this._isRaster):new Zs(t,g,this.transform.tileZoom,_,this._isRaster),this._loadTile(s,this._tileLoaded.bind(this,s,t.key,s.state))}return s.uses++,this._tiles[t.key]=s,f||this._source.fire(new r.A("dataloading",{tile:s,coord:s.tileID,dataType:"source"})),s}_setTileReloadTimer(t,s){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const f=s.getExpiryTimeout();f&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},f))}_removeTile(t){const s=this._tiles[t];s&&(s.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),s.uses>0||(s.hasData()&&s.state!=="reloading"||s.state==="empty"?this._cache.add(s.tileID,s,s.getExpiryTimeout()):(s.aborted=!0,this._abortTile(s),this._unloadTile(s))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,s,f){const _=[],g=this.transform;if(!g)return _;const b=g.projection.name==="globe",T=r.ay(g.center.lng);for(const A in this._tiles){const z=this._tiles[A];if(f&&z.clearQueryDebugViz(),z.holdingForFade())continue;let D;if(b){const F=z.tileID.canonical;if(F.z===0){const O=[Math.abs(r.aD(T,...Jl(F,-1))-T),Math.abs(r.aD(T,...Jl(F,1))-T)];D=[0,2*O.indexOf(Math.min(...O))-1]}else{const O=[Math.abs(r.aD(T,...Jl(F,-1))-T),Math.abs(r.aD(T,...Jl(F,0))-T),Math.abs(r.aD(T,...Jl(F,1))-T)];D=[O.indexOf(Math.min(...O))-1]}}else D=[0];for(const F of D){const O=t.containsTile(z,g,s,F);O&&_.push(O)}}return _}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,s){const f=this.getRenderableIds(t,s).map(g=>this._tiles[g].tileID),_=this.transform.projection.name==="globe";for(const g of f)g.projMatrix=this.transform.calculateProjMatrix(g.toUnwrapped()),g.expandedProjMatrix=_?this.transform.calculateProjMatrix(g.toUnwrapped(),!1,!0):g.projMatrix;return f}sortCoordinatesByDistance(t){const s=t.slice(),f=this.transform._camera.position,_=this.transform._camera.forward(),g={};for(const b of s){const T=1/(1<<b.canonical.z);g[b.key]=((b.canonical.x+.5)*T+b.wrap-f[0])*_[0]+((b.canonical.y+.5)*T-f[1])*_[1]-f[2]*_[2]}return s.sort((b,T)=>g[b.key]-g[T.key]),s}hasTransition(){if(this._source.hasTransition())return!0;if(jh(this._source.type))for(const t in this._tiles){const s=this._tiles[t];if(s.fadeEndTime!==void 0&&s.fadeEndTime>=r.q.now())return!0}return!1}setFeatureState(t,s,f){this._state.updateState(t=t||"_geojsonTileLayer",s,f)}removeFeatureState(t,s,f){this._state.removeFeatureState(t=t||"_geojsonTileLayer",s,f)}getFeatureState(t,s){return this._state.getState(t=t||"_geojsonTileLayer",s)}setDependencies(t,s,f){const _=this._tiles[t];_&&_.setDependencies(s,f)}reloadTilesForDependencies(t,s){for(const f in this._tiles)this._tiles[f].hasDependency(t,s)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(t,s))}_preloadTiles(t,s){if(!this._sourceLoaded){const A=()=>{this._sourceLoaded&&(this._source.off("data",A),this._preloadTiles(t,s))};return void this._source.on("data",A)}const f=new Map,_=Array.isArray(t)?t:[t],g=this.map.painter.terrain,b=this.usedForTerrain&&g?g.getScaledDemTileSize():this._source.tileSize;for(const A of _){const z=A.coveringTiles({tileSize:b,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const D of z)f.set(D.key,D);this.usedForTerrain&&A.updateElevation(!1)}const T=Array.from(f.values());r.bt(T,(A,z)=>{const D=new Zs(A,this._source.tileSize*A.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(D,F=>{this._source.type==="raster-dem"&&D.dem&&this._backfillDEM(D),z(F,D)})},s)}}function Uh(h,t){const s=Math.abs(2*h.wrap)-+(h.wrap<0),f=Math.abs(2*t.wrap)-+(t.wrap<0);return h.overscaledZ-t.overscaledZ||f-s||t.canonical.y-h.canonical.y||t.canonical.x-h.canonical.x}function jh(h){return h==="raster"||h==="image"||h==="video"||h==="custom"}function Jl(h,t){const s=1<<h.z;return[h.x/s+t,(h.x+1)/s+t]}Wr.maxOverzooming=10,Wr.maxUnderzooming=3;class K_{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,s=!1;for(const f in this.style._mergedLayers){const _=this.style._mergedLayers[f];if(_.type==="fill-extrusion")this.layers.push({layer:_,visible:t,visibilityChanged:s});else if(_.type==="model"){const g=this.style.getLayerSource(_);g&&g.type==="batched-model"&&this.layers.push({layer:_,visible:t,visibilityChanged:s})}}}onNewFrame(t){this.layersGotHidden=!1;for(const s of this.layers){const f=s.layer;let _=!1;f.type==="fill-extrusion"?_=!f.isHidden(t)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="model"&&(_=!f.isHidden(t)&&f.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!_&&s.visible,s.visible=_}}updateZOffset(t,s){this.currentBuildingBuckets=[];for(const _ of this.layers){const g=_.layer,b=this.style.getLayerSourceCache(g);let T=1;g.type==="fill-extrusion"&&(T=_.visible?g.paint.get("fill-extrusion-vertical-scale"):0);let A=b?b.getTile(s):null;if(!A&&b&&s.canonical.z>b.getSource().minzoom){let z=s.scaledTo(Math.min(b.getSource().maxzoom,s.overscaledZ-1));for(;z.overscaledZ>=b.getSource().minzoom&&(A=b.getTile(z),!A&&z.overscaledZ!==0);)z=z.scaledTo(z.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:A?A.getBucket(g):null,tileID:A?A.tileID:s,verticalScale:T})}t.hasAnyZOffset=!1;let f=!1;for(let _=0;_<t.symbolInstances.length;_++){const g=t.symbolInstances.get(_),b=g.zOffset,T=this._getHeightAtTileOffset(s,g.tileAnchorX,g.tileAnchorY);g.zOffset=T!==Number.NEGATIVE_INFINITY?T:b,f||b===g.zOffset||(f=!0),t.hasAnyZOffset||g.zOffset===0||(t.hasAnyZOffset=!0)}f&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,s,f,_){let g=s,b=f;if(t.canonical.z!==_.canonical.z){const T=_.canonical,A=1/(1<<t.canonical.z-T.z);g=(s+t.canonical.x*r.aj)*A-T.x*r.aj|0,b=(f+t.canonical.y*r.aj)*A-T.y*r.aj|0}return{tileX:g,tileY:b}}_getHeightAtTileOffset(t,s,f){let _,g;for(let b=0;b<this.layers.length;++b){if(this.layers[b].layer.type!=="fill-extrusion")continue;const{bucket:T,tileID:A,verticalScale:z}=this.currentBuildingBuckets[b];if(!T)continue;const{tileX:D,tileY:F}=this._mapCoordToOverlappingTile(t,s,f,A),O=T.getHeightAtTileCoord(D,F);O&&O.height!==void 0&&(O.hidden?_=O.height:g=Math.max(O.height*z,g||0))}if(g!==void 0)return g;for(let b=0;b<this.layers.length;++b){const T=this.layers[b];if(T.layer.type!=="model"||!T.visible)continue;const{bucket:A,tileID:z}=this.currentBuildingBuckets[b];if(!A)continue;const{tileX:D,tileY:F}=this._mapCoordToOverlappingTile(t,s,f,z),O=A.getHeightAtTileCoord(D,F);if(O&&!O.hidden)return O.height===void 0&&_!==void 0?Math.min(O.maxHeight,_)*O.verticalScale:O.height?O.height*O.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function $h(h,t){const s={};for(const f in h)f!=="ref"&&(s[f]=h[f]);return r.bu.forEach(f=>{f in t&&(s[f]=t[f])}),s}function Gh(h){h=h.slice();const t=Object.create(null);for(let s=0;s<h.length;s++)t[h[s].id]=h[s];for(let s=0;s<h.length;s++)"ref"in h[s]&&(h[s]=$h(h[s],t[h[s].ref]));return h}const Hn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Ql(h,t,s){s.push({command:Hn.addSource,args:[h,t[h]]})}function ec(h,t,s){t.push({command:Hn.removeSource,args:[h]}),s[h]=!0}function Lx(h,t,s,f){ec(h,s,f),Ql(h,t,s)}function J_(h,t,s){let f;for(f in h[s])if(h[s].hasOwnProperty(f)&&f!=="data"&&!r.bv(h[s][f],t[s][f]))return!1;for(f in t[s])if(t[s].hasOwnProperty(f)&&f!=="data"&&!r.bv(h[s][f],t[s][f]))return!1;return!0}function rl(h,t,s,f,_,g){let b;for(b in t=t||{},h=h||{})h.hasOwnProperty(b)&&(r.bv(h[b],t[b])||s.push({command:g,args:[f,b,t[b],_]}));for(b in t)t.hasOwnProperty(b)&&!h.hasOwnProperty(b)&&(r.bv(h[b],t[b])||s.push({command:g,args:[f,b,t[b],_]}))}function ma(h){return h.id}function tc(h,t){return h[t.id]=t,h}class Q_{constructor(t,s){this.reset(t,s)}reset(t,s){this.points=t||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(s||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=r.aD(t,0,1);let s=1,f=this._distances[s];const _=t*this.paddedLength+this.padding;for(;f<_&&s<this._distances.length;)f=this._distances[++s];const g=s-1,b=this._distances[g],T=f-b,A=T>0?(_-b)/T:0;return this.points[g].mult(1-A).add(this.points[s].mult(A))}}class ep{constructor(t,s,f){const _=this.boxCells=[],g=this.circleCells=[];this.xCellCount=Math.ceil(t/f),this.yCellCount=Math.ceil(s/f);for(let b=0;b<this.xCellCount*this.yCellCount;b++)_.push([]),g.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=s,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/s,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,s,f,_,g){this._forEachCell(s,f,_,g,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(s),this.bboxes.push(f),this.bboxes.push(_),this.bboxes.push(g)}insertCircle(t,s,f,_){this._forEachCell(s-_,f-_,s+_,f+_,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(s),this.circles.push(f),this.circles.push(_)}_insertBoxCell(t,s,f,_,g,b){this.boxCells[g].push(b)}_insertCircleCell(t,s,f,_,g,b){this.circleCells[g].push(b)}_query(t,s,f,_,g,b){if(f<0||t>this.width||_<0||s>this.height)return!g&&[];const T=[];if(t<=0&&s<=0&&this.width<=f&&this.height<=_){if(g)return!0;for(let A=0;A<this.boxKeys.length;A++)T.push({key:this.boxKeys[A],x1:this.bboxes[4*A],y1:this.bboxes[4*A+1],x2:this.bboxes[4*A+2],y2:this.bboxes[4*A+3]});for(let A=0;A<this.circleKeys.length;A++){const z=this.circles[3*A],D=this.circles[3*A+1],F=this.circles[3*A+2];T.push({key:this.circleKeys[A],x1:z-F,y1:D-F,x2:z+F,y2:D+F})}return b?T.filter(b):T}return this._forEachCell(t,s,f,_,this._queryCell,T,{hitTest:g,seenUids:{box:{},circle:{}}},b),g?T.length>0:T}_queryCircle(t,s,f,_,g){const b=t-f,T=t+f,A=s-f,z=s+f;if(T<0||b>this.width||z<0||A>this.height)return!_&&[];const D=[];return this._forEachCell(b,A,T,z,this._queryCellCircle,D,{hitTest:_,circle:{x:t,y:s,radius:f},seenUids:{box:{},circle:{}}},g),_?D.length>0:D}query(t,s,f,_,g){return this._query(t,s,f,_,!1,g)}hitTest(t,s,f,_,g){return this._query(t,s,f,_,!0,g)}hitTestCircle(t,s,f,_){return this._queryCircle(t,s,f,!0,_)}_queryCell(t,s,f,_,g,b,T,A){const z=T.seenUids,D=this.boxCells[g];if(D!==null){const O=this.bboxes;for(const U of D)if(!z.box[U]){z.box[U]=!0;const H=4*U;if(t<=O[H+2]&&s<=O[H+3]&&f>=O[H+0]&&_>=O[H+1]&&(!A||A(this.boxKeys[U]))){if(T.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[U],x1:O[H],y1:O[H+1],x2:O[H+2],y2:O[H+3]})}}}const F=this.circleCells[g];if(F!==null){const O=this.circles;for(const U of F)if(!z.circle[U]){z.circle[U]=!0;const H=3*U;if(this._circleAndRectCollide(O[H],O[H+1],O[H+2],t,s,f,_)&&(!A||A(this.circleKeys[U]))){if(T.hitTest)return b.push(!0),!0;{const q=O[H],Y=O[H+1],Z=O[H+2];b.push({key:this.circleKeys[U],x1:q-Z,y1:Y-Z,x2:q+Z,y2:Y+Z})}}}}}_queryCellCircle(t,s,f,_,g,b,T,A){const z=T.circle,D=T.seenUids,F=this.boxCells[g];if(F!==null){const U=this.bboxes;for(const H of F)if(!D.box[H]){D.box[H]=!0;const q=4*H;if(this._circleAndRectCollide(z.x,z.y,z.radius,U[q+0],U[q+1],U[q+2],U[q+3])&&(!A||A(this.boxKeys[H])))return b.push(!0),!0}}const O=this.circleCells[g];if(O!==null){const U=this.circles;for(const H of O)if(!D.circle[H]){D.circle[H]=!0;const q=3*H;if(this._circlesCollide(U[q],U[q+1],U[q+2],z.x,z.y,z.radius)&&(!A||A(this.circleKeys[H])))return b.push(!0),!0}}}_forEachCell(t,s,f,_,g,b,T,A){const z=this._convertToXCellCoord(t),D=this._convertToYCellCoord(s),F=this._convertToXCellCoord(f),O=this._convertToYCellCoord(_);for(let U=z;U<=F;U++)for(let H=D;H<=O;H++)if(g.call(this,t,s,f,_,this.xCellCount*H+U,b,T,A))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,s,f,_,g,b){const T=_-t,A=g-s,z=f+b;return z*z>T*T+A*A}_circleAndRectCollide(t,s,f,_,g,b,T){const A=(b-_)/2,z=Math.abs(t-(_+A));if(z>A+f)return!1;const D=(T-g)/2,F=Math.abs(s-(g+D));if(F>D+f)return!1;if(z<=A||F<=D)return!0;const O=z-A,U=F-D;return O*O+U*U<=f*f}}const ol={unknown:0,flipRequired:1,flipNotRequired:2},gu=Math.tan(85*Math.PI/180);function nc(h,t,s,f,_,g,b){const T=r.bz();if(s)if(g.name==="globe"){const A=r.bA(_,t);r.az(T,T,A)}else{const A=r.bB([],b);T[0]=A[0],T[1]=A[1],T[4]=A[2],T[5]=A[3],f||r.by(T,T,_.angle)}else r.az(T,_.labelPlaneMatrix,h);return T}function qh(h,t,s,f,_,g,b){const T=nc(h,t,s,f,_,g,b);return g.name==="globe"&&s||(T[2]=T[6]=T[10]=T[14]=0),T}function tp(h,t,s,f,_,g,b){if(s){if(g.name==="globe"){const T=nc(h,t,s,f,_,g,b);return r.bi(T,T),r.az(T,h,T),T}{const T=r.bw(h),A=r.bx([]);return A[0]=b[0],A[1]=b[1],A[4]=b[2],A[5]=b[3],r.az(T,T,A),f||r.by(T,T,-_.angle),T}}return _.glCoordMatrix}function mo(h,t,s,f){const _=[h,t,s,1];s?r.aA(_,_,f):eg(_,_,f);const g=_[3];return _[0]/=g,_[1]/=g,_[2]/=g,_}function _a(h,t){return Math.min(.5+h/t*.5,1.5)}function np(h,t){const s=h[0]/h[3],f=h[1]/h[3];return s>=-t[0]&&s<=t[0]&&f>=-t[1]&&f<=t[1]}function ip(h,t,s,f,_,g,b,T,A,z){const D=s.transform,F=f?h.textSizeData:h.iconSizeData,O=r.bH(F,s.transform.zoom),U=D.projection.name==="globe",H=[256/s.width*2+1,256/s.height*2+1],q=f?h.text.dynamicLayoutVertexArray:h.icon.dynamicLayoutVertexArray;q.clear();let Y=null;U&&(Y=f?h.text.globeExtVertexArray:h.icon.globeExtVertexArray);const Z=h.lineVertexArray,oe=f?h.text.placedSymbolArray:h.icon.placedSymbolArray,fe=s.transform.width/s.transform.height;let me,xe=!1;for(let ye=0;ye<oe.length;ye++){const ve=oe.get(ye),{numGlyphs:_e,writingMode:we}=ve;if(we!==r.bI.vertical||xe||me===r.bI.horizontal||(xe=!0),me=we,(ve.hidden||we===r.bI.vertical)&&!xe){Kn(_e,q);continue}xe=!1;const Te=new r.P(ve.tileAnchorX,ve.tileAnchorY);let{x:Ue,y:Fe,z:ot}=D.projection.projectTilePoint(Te.x,Te.y,z.canonical);if(A){const[Vt,Xt,Bt]=A(Te);Ue+=Vt,Fe+=Xt,ot+=Bt}const et=[Ue,Fe,ot,1];if(r.aA(et,et,t),!np(et,H)){Kn(_e,q);continue}const xt=et[3],Oe=_a(s.transform.getCameraToCenterDistance(D.projection),xt),je=r.bJ(F,O,ve),Le=b?je/Oe:je*Oe,lt=mo(Ue,Fe,ot,_);if(lt[3]<=0){Kn(_e,q);continue}let Ze={};const dt=r.al(h.layers[0].layout.get("text-max-angle")),st=Math.cos(dt),pt=b?null:A,mt=_o(ve,Le,!1,T,t,_,g,h.glyphOffsetArray,Z,q,Y,lt,Te,Ze,fe,pt,D.projection,z,b,st);xe=mt.useVertical,pt&&mt.needsFlipping&&(Ze={}),(mt.notEnoughRoom||xe||mt.needsFlipping&&_o(ve,Le,!0,T,t,_,g,h.glyphOffsetArray,Z,q,Y,lt,Te,Ze,fe,pt,D.projection,z,b,st).notEnoughRoom)&&Kn(_e,q)}f?(h.text.dynamicLayoutVertexBuffer.updateData(q),Y&&h.text.globeExtVertexBuffer&&h.text.globeExtVertexBuffer.updateData(Y)):(h.icon.dynamicLayoutVertexBuffer.updateData(q),Y&&h.icon.globeExtVertexBuffer&&h.icon.globeExtVertexBuffer.updateData(Y))}function Hh(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y){const{lineStartIndex:Z,glyphStartIndex:oe,segment:fe}=T,me=oe+T.numGlyphs,xe=Z+T.lineLength,ye=t.getoffsetX(oe),ve=t.getoffsetX(me-1),_e=yu(h*ye,s,f,_,g,b,fe,Z,xe,A,z,D,F,O,!0,U,H,q,Y);if(!_e)return null;const we=yu(h*ve,s,f,_,g,b,fe,Z,xe,A,z,D,F,O,!0,U,H,q,Y);return we?{first:_e,last:we}:null}function sl(h,t,s,f){return h===r.bI.horizontal&&Math.abs(f)>Math.abs(s)?{useVertical:!0}:h===r.bI.vertical?f>0?{needsFlipping:!0}:null:t!==ol.unknown&&function(_,g){return _===0||Math.abs(g/_)>gu}(s,f)?t===ol.flipRequired?{needsFlipping:!0}:null:s<0?{needsFlipping:!0}:null}function _o(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe,fe){const me=t/24,xe=h.lineOffsetX*me,ye=h.lineOffsetY*me,{lineStartIndex:ve,glyphStartIndex:_e,numGlyphs:we,segment:Te,writingMode:Ue,flipState:Fe}=h,ot=ve+h.lineLength,et=xt=>{if(D){const[lt,Ze,dt]=xt.up,st=z.length;r.bK(D,st+0,lt,Ze,dt),r.bK(D,st+1,lt,Ze,dt),r.bK(D,st+2,lt,Ze,dt),r.bK(D,st+3,lt,Ze,dt)}const[Oe,je,Le]=xt.point;r.bL(z,Oe,je,Le,xt.angle)};if(we>1){const xt=Hh(me,T,xe,ye,s,F,O,h,A,g,U,q,!1,Y,Z,oe,fe);if(!xt)return{notEnoughRoom:!0};if(f&&!s){let[Oe,je,Le]=xt.first.point,[lt,Ze,dt]=xt.last.point;[Oe,je]=mo(Oe,je,Le,b),[lt,Ze]=mo(lt,Ze,dt,b);const st=sl(Ue,Fe,(lt-Oe)*H,Ze-je);if(h.flipState=st&&st.needsFlipping?ol.flipRequired:ol.flipNotRequired,st)return st}et(xt.first);for(let Oe=_e+1;Oe<_e+we-1;Oe++){const je=yu(me*T.getoffsetX(Oe),xe,ye,s,F,O,Te,ve,ot,A,g,U,q,!1,!1,Y,Z,oe,fe);if(!je)return z.length-=4*(Oe-_e),{notEnoughRoom:!0};et(je)}et(xt.last)}else{if(f&&!s){const Oe=mo(O.x,O.y,0,_),je=ve+Te+1,Le=new r.P(A.getx(je),A.gety(je)),lt=mo(Le.x,Le.y,0,_),Ze=lt[3]>0?lt:Zh(O,Le,Oe,1,_,void 0,Y,Z.canonical),dt=sl(Ue,Fe,(Ze[0]-Oe[0])*H,Ze[1]-Oe[1]);if(h.flipState=dt&&dt.needsFlipping?ol.flipRequired:ol.flipNotRequired,dt)return dt}const xt=yu(me*T.getoffsetX(_e),xe,ye,s,F,O,Te,ve,ot,A,g,U,q,!1,!1,Y,Z,oe,fe);if(!xt)return{notEnoughRoom:!0};et(xt)}return{}}function rp(h,t,s,f,_){const{x:g,y:b,z:T}=f.projectTilePoint(h.x,h.y,t);if(!_)return mo(g,b,T,s);const[A,z,D]=_(h);return mo(g+A,b+z,T+D,s)}function Zh(h,t,s,f,_,g,b,T){const A=rp(h.sub(t)._unit()._add(h),T,_,b,g);return r.at(A,s,A),r.au(A,A),r.bF(A,s,A,f)}function yu(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe){const fe=f?h-t:h+t;let me=fe>0?1:-1,xe=0;f&&(me*=-1,xe=Math.PI),me<0&&(xe+=Math.PI);let ye=T+b+(me>0?0:1)|0,ve=_,_e=_,we=0,Te=0;const Ue=Math.abs(fe),Fe=[],ot=[];let et=g,xt=et,Oe=r.bC([]);const je=()=>Zh(xt,et,_e,Ue-we+1,D,O,q,Y.canonical);for(;we+Te<=Ue;){if(ye+=me,ye<T||ye>=A)return null;if(_e=ve,xt=et,Fe.push(_e),U&&ot.push(xt),et=new r.P(z.getx(ye),z.gety(ye)),ve=F[ye],!ve){const Bt=rp(et,Y.canonical,D,q,O);ve=Bt[3]>0?F[ye]=Bt:je()}we+=Te;const Vt=r.at([],ve,_e),Xt=r.bD(_e,ve);if(s&&Xt>0&&Te>0&&r.bE(Oe,Vt)/(Te*Xt)<oe)return null;Te=Xt,Oe=Vt}H&&O&&(F[ye]&&(ve=je(),Te=r.bD(_e,ve),Oe=r.at([],ve,_e)),F[ye]=ve);const Le=(Ue-we)/Te,lt=et.sub(xt)._mult(Le)._add(xt),Ze=r.bF([],_e,Oe,Le);let dt=[0,0,1],st=Oe[0],pt=Oe[1];if(Z&&(dt=q.upVector(Y.canonical,lt.x,lt.y),dt[0]!==0||dt[1]!==0||dt[2]!==1)){const Vt=[dt[2],0,-dt[0]],Xt=r.bG([],dt,Vt);r.au(Vt,Vt),r.au(Xt,Xt),st=r.bE(Oe,Vt),pt=r.bE(Oe,Xt)}if(s){const Vt=r.bG([],dt,Oe);r.au(Vt,Vt),r.bF(Ze,Ze,Vt,s*me)}const mt=xe+Math.atan2(pt,st);return Fe.push(Ze),U&&ot.push(lt),{point:Ze,angle:mt,path:Fe,tilePath:ot,up:dt}}function Kn(h,t){const s=t.length,f=s+4*h;t.resize(f),t.float32.fill(-1/0,4*s,4*f)}function eg(h,t,s){const f=t[0],_=t[1];return h[0]=s[0]*f+s[4]*_+s[12],h[1]=s[1]*f+s[5]*_+s[13],h[3]=s[3]*f+s[7]*_+s[15],h}const Jt=100;class tg{constructor(t,s,f=new ep(t.width+200,t.height+200,25),_=new ep(t.width+200,t.height+200,25)){this.transform=t,this.grid=f,this.ignoredGrid=_,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Jt,this.screenBottomBoundary=t.height+Jt,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=s}placeCollisionBox(t,s,f,_,g,b,T,A){let z=f.projectedAnchorX,D=f.projectedAnchorY,F=f.projectedAnchorZ;const O=f.elevation,U=f.tileID,H=t.getProjection();if(O&&U){const[ye,ve,_e]=H.upVector(U.canonical,f.tileAnchorX,f.tileAnchorY),we=H.upVectorScale(U.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;z+=ye*O*we,D+=ve*O*we,F+=_e*O*we}const q=this.projectAndGetPerspectiveRatio(T,z,D,F,f.tileID,H.name==="globe"||!!O||this.transform.pitch>0,H),Y=b*q.perspectiveRatio,Z=(f.x1*s+_.x-f.padding)*Y+q.point.x,oe=(f.y1*s+_.y-f.padding)*Y+q.point.y,fe=(f.x2*s+_.x+f.padding)*Y+q.point.x,me=(f.y2*s+_.y+f.padding)*Y+q.point.y,xe=q.perspectiveRatio<=.55||q.occluded;return!this.isInsideGrid(Z,oe,fe,me)||!g&&this.grid.hitTest(Z,oe,fe,me,A)||xe?{box:[],offscreen:!1,occluded:q.occluded}:{box:[Z,oe,fe,me],offscreen:this.isOffscreen(Z,oe,fe,me),occluded:!1}}placeCollisionCircles(t,s,f,_,g,b,T,A,z,D,F,O,U,H,q){const Y=[],Z=this.transform.elevation,oe=t.getProjection(),fe=Z?Z.getAtTileOffsetFunc(q,this.transform.center.lat,this.transform.worldSize,oe):null,me=new r.P(f.tileAnchorX,f.tileAnchorY);let{x:xe,y:ye,z:ve}=oe.projectTilePoint(me.x,me.y,q.canonical);if(fe){const[dt,st,pt]=fe(me);xe+=dt,ye+=st,ve+=pt}const _e=oe.name==="globe",we=this.projectAndGetPerspectiveRatio(T,xe,ye,ve,q,_e||!!Z||this.transform.pitch>0,oe),{perspectiveRatio:Te}=we,Ue=(F?b/Te:b*Te)/r.bO,Fe=mo(xe,ye,ve,A),ot=f.lineOffsetX*Ue,et=f.lineOffsetY*Ue,xt=r.al(t.layers[0].layout.get("text-max-angle")),Oe=Math.cos(xt),je=we.signedDistanceFromCamera>0?Hh(Ue,g,ot,et,!1,Fe,me,f,_,A,{},Z&&!F?fe:null,F&&!!Z,oe,q,F,Oe):null;let Le=!1,lt=!1,Ze=!0;if(je&&!we.occluded){const dt=.5*U*Te+H,st=new r.P(-100,-100),pt=new r.P(this.screenRightBoundary,this.screenBottomBoundary),mt=new Q_,{first:Vt,last:Xt}=je,Bt=Vt.path.length;let Yt=[];for(let cn=Bt-1;cn>=1;cn--)Yt.push(Vt.path[cn]);for(let cn=1;cn<Xt.path.length;cn++)Yt.push(Xt.path[cn]);const jt=2.5*dt;z&&(Yt=Yt.map(([cn,Rn,ai],ii)=>(fe&&!_e&&(ai=fe(ii<Bt-1?Vt.tilePath[Bt-1-ii]:Xt.tilePath[ii-Bt+2])[2]),mo(cn,Rn,ai,z))),Yt.some(cn=>cn[3]<=0)&&(Yt=[]));let en=[];if(Yt.length>0){let cn=1/0,Rn=-1/0,ai=1/0,ii=-1/0;for(const Ln of Yt)cn=Math.min(cn,Ln[0]),ai=Math.min(ai,Ln[1]),Rn=Math.max(Rn,Ln[0]),ii=Math.max(ii,Ln[1]);Rn>=st.x&&cn<=pt.x&&ii>=st.y&&ai<=pt.y&&(en=[Yt.map(Ln=>new r.P(Ln[0],Ln[1]))],(cn<st.x||Rn>pt.x||ai<st.y||ii>pt.y)&&(en=r.bM(en,st.x,st.y,pt.x,pt.y)))}for(const cn of en){mt.reset(cn,.25*dt);let Rn=0;Rn=mt.length<=.5*dt?1:Math.ceil(mt.paddedLength/jt)+1;for(let ai=0;ai<Rn;ai++){const ii=ai/Math.max(Rn-1,1),Ln=mt.lerp(ii),Zi=Ln.x+Jt,Ni=Ln.y+Jt;Y.push(Zi,Ni,dt,0);const pn=Zi-dt,Vn=Ni-dt,Zn=Zi+dt,li=Ni+dt;if(Ze=Ze&&this.isOffscreen(pn,Vn,Zn,li),lt=lt||this.isInsideGrid(pn,Vn,Zn,li),!s&&this.grid.hitTestCircle(Zi,Ni,dt,O)&&(Le=!0,!D))return{circles:[],offscreen:!1,collisionDetected:Le,occluded:!1}}}}return{circles:!D&&Le||!lt?[]:Y,offscreen:Ze,collisionDetected:Le,occluded:we.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const s=[];let f=1/0,_=1/0,g=-1/0,b=-1/0;for(const D of t){const F=new r.P(D.x+Jt,D.y+Jt);f=Math.min(f,F.x),_=Math.min(_,F.y),g=Math.max(g,F.x),b=Math.max(b,F.y),s.push(F)}const T=this.grid.query(f,_,g,b).concat(this.ignoredGrid.query(f,_,g,b)),A={},z={};for(const D of T){const F=D.key;if(A[F.bucketInstanceId]===void 0&&(A[F.bucketInstanceId]={}),A[F.bucketInstanceId][F.featureIndex])continue;const O=[new r.P(D.x1,D.y1),new r.P(D.x2,D.y1),new r.P(D.x2,D.y2),new r.P(D.x1,D.y2)];r.bN(s,O)&&(A[F.bucketInstanceId][F.featureIndex]=!0,z[F.bucketInstanceId]===void 0&&(z[F.bucketInstanceId]=[]),z[F.bucketInstanceId].push(F.featureIndex))}return z}insertCollisionBox(t,s,f,_,g){(s?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:_,collisionGroupID:g},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,s,f,_,g){const b=s?this.ignoredGrid:this.grid,T={bucketInstanceId:f,featureIndex:_,collisionGroupID:g};for(let A=0;A<t.length;A+=4)b.insertCircle(T,t[A],t[A+1],t[A+2])}projectAndGetPerspectiveRatio(t,s,f,_,g,b,T){const A=[s,f,_,1];let z=!1;_||this.transform.pitch>0?(r.aA(A,A,t),this.fogState&&g&&T.name!=="globe"&&(z=function(O,U,H,q,Y,Z){const oe=Z.calculateFogTileMatrix(Y),fe=[U,H,q];return r.ad(fe,fe,oe),Zt(O,r.ae(fe),Z.pitch,Z._fov)}(this.fogState,s,f,_,g.toUnwrapped(),this.transform)>.9)):eg(A,A,t);const D=A[3];return{point:new r.P((A[0]/D+1)/2*this.transform.width+Jt,(-A[1]/D+1)/2*this.transform.height+Jt),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(T)/D*.5,1.5),signedDistanceFromCamera:D,occluded:b&&A[2]>D||z}}isOffscreen(t,s,f,_){return f<Jt||t>=this.screenRightBoundary||_<Jt||s>this.screenBottomBoundary}isInsideGrid(t,s,f,_){return f>=0&&t<this.gridRightBoundary&&_>=0&&s<this.gridBottomBoundary}getViewportMatrix(){const t=r.bx([]);return r.bo(t,t,[-100,-100,0]),t}}function Wh(h,t,s){const f=t.createTileMatrix(h,h.worldSize,s.toUnwrapped());return r.az(new Float32Array(16),h.projMatrix,f)}function Xh(h,t,s){if(t.projection.name===s.projection.name)return h.projMatrix;const f=s.clone();return f.setProjection(t.projection),Wh(f,t.getProjection(),h)}function vu(h,t,s){return t.name===s.projection.name?h.projMatrix:Wh(s,t,h)}class Zo{constructor(t,s,f,_){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?s:-s))):_&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class al{constructor(t,s,f,_,g,b=!1){this.text=new Zo(t?t.text:null,s,f,g),this.icon=new Zo(t?t.icon:null,s,_,g),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ga{constructor(t,s,f,_=!1){this.text=t,this.icon=s,this.skipFade=f,this.clipped=_}}class Kt{constructor(){this.invProjMatrix=r.bz(),this.viewportMatrix=r.bz(),this.circles=[]}}class ui{constructor(t,s,f,_,g){this.bucketInstanceId=t,this.featureIndex=s,this.sourceLayerIndex=f,this.bucketIndex=_,this.tileID=g}}class ni{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const s=++this.maxGroupID;this.collisionGroups[t]={ID:s,predicate:f=>f.collisionGroupID===s}}return this.collisionGroups[t]}}function lo(h,t,s,f,_){const{horizontalAlign:g,verticalAlign:b}=r.bV(h),T=-(g-.5)*t,A=-(b-.5)*s,z=r.bU(h,f);return new r.P(T+z[0]*_,A+z[1]*_)}function ya(h,t,s,f,_){const g=new r.P(h,t);return s&&g._rotate(f?_:-_),g}class Qn{constructor(t,s,f,_,g,b){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new tg(this.transform,g),this.buildingIndex=b,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=s,this.retainedQueryData={},this.collisionGroups=new ni(f),this.collisionCircleArrays={},this.prevPlacement=_,_&&(_.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,s,f,_,g=1){const b=f.getBucket(s),T=f.latestFeatureIndex;if(!b||!T||s.fqid!==b.layerIds[0])return;const A=b.layers[0].layout,z=b.layers[0].paint,D=f.collisionBoxArray,F=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),O=f.tileSize/r.aj,U=f.tileID.toUnwrapped();this.transform.setProjection(b.projection);const H=(q=f.tileID,Y=b.getProjection(),Z=this.transform,Y.name===this.projection?Z.calculateProjMatrix(q.toUnwrapped()):Wh(Z,Y,q));var q,Y,Z;const oe=A.get("text-pitch-alignment")==="map",fe=A.get("text-rotation-alignment")==="map";s.compileFilter(s.options);const me=s.dynamicFilter(),xe=s.dynamicFilterNeedsFeature(),ye=this.transform.calculatePixelsToTileUnitsMatrix(f),ve=qh(H,f.tileID.canonical,oe,fe,this.transform,b.getProjection(),ye);let _e=null;if(oe){const je=tp(H,f.tileID.canonical,oe,fe,this.transform,b.getProjection(),ye);_e=r.az([],this.transform.labelPlaneMatrix,je)}let we=null;me&&f.latestFeatureIndex&&(we={unwrappedTileID:U,dynamicFilter:me,dynamicFilterNeedsFeature:xe}),this.retainedQueryData[b.bucketInstanceId]=new ui(b.bucketInstanceId,T,b.sourceLayerIndex,b.index,f.tileID);const[Te,Ue]=b.layers[0].layout.get("text-size-scale-range"),Fe=r.aD(g,Te,Ue),[ot,et]=A.get("icon-size-scale-range"),xt=r.aD(g,ot,et),Oe={bucket:b,layout:A,paint:z,posMatrix:H,textLabelPlaneMatrix:ve,labelToScreenMatrix:_e,clippingData:we,scale:F,textPixelRatio:O,holdingForFade:f.holdingForFade(),collisionBoxArray:D,partiallyEvaluatedTextSize:r.bH(b.textSizeData,this.transform.zoom,Fe),partiallyEvaluatedIconSize:r.bH(b.iconSizeData,this.transform.zoom,xt),collisionGroup:this.collisionGroups.get(b.sourceID),latestFeatureIndex:f.latestFeatureIndex};if(_)for(const je of b.sortKeyRanges){const{sortKey:Le,symbolInstanceStart:lt,symbolInstanceEnd:Ze}=je;t.push({sortKey:Le,symbolInstanceStart:lt,symbolInstanceEnd:Ze,parameters:Oe})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:Oe})}attemptAnchorPlacement(t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe){const{textOffset0:fe,textOffset1:me,crossTileID:xe}=O,ye=[fe,me],ve=lo(t,f,_,ye,g),_e=this.collisionIndex.placeCollisionBox(H,g,s,ya(ve.x,ve.y,b,T,this.transform.angle),F,A,z,D.predicate);if(Y){const we=H.getSymbolInstanceIconSize(oe,this.transform.zoom,O.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(H,we,Y,ya(ve.x,ve.y,b,T,this.transform.angle),F,A,z,D.predicate).box.length===0)return}if(_e.box.length>0){let we;return this.prevPlacement&&this.prevPlacement.variableOffsets[xe]&&this.prevPlacement.placements[xe]&&this.prevPlacement.placements[xe].text&&(we=this.prevPlacement.variableOffsets[xe].anchor),this.variableOffsets[xe]={textOffset:ye,width:f,height:_,anchor:t,textScale:g,prevAnchor:we},this.markUsedJustification(H,t,O,q),H.allowVerticalPlacement&&(this.markUsedOrientation(H,q,O),this.placedOrientations[xe]=q),{shift:ve,placedGlyphBoxes:_e}}}placeLayerBucketPart(t,s,f,_,g=1){const{bucket:b,layout:T,paint:A,posMatrix:z,textLabelPlaneMatrix:D,labelToScreenMatrix:F,clippingData:O,textPixelRatio:U,holdingForFade:H,collisionBoxArray:q,partiallyEvaluatedTextSize:Y,partiallyEvaluatedIconSize:Z,collisionGroup:oe,latestFeatureIndex:fe}=t.parameters,me=T.get("text-optional"),xe=T.get("icon-optional"),ye=T.get("text-allow-overlap"),ve=T.get("icon-allow-overlap"),_e=T.get("text-rotation-alignment")==="map",we=T.get("text-pitch-alignment")==="map",Te=A.get("symbol-z-offset"),Ue=T.get("symbol-elevation-reference")==="sea",[Fe,ot]=T.get("text-size-scale-range"),[et,xt]=T.get("icon-size-scale-range"),Oe=r.aD(g,Fe,ot),je=r.aD(g,et,xt);this.transform.setProjection(b.projection);let Le=ye&&(ve||!b.hasIconData()||xe),lt=ve&&(ye||!b.hasTextData()||me);const Ze=!Te.isConstant();!b.collisionArrays&&q&&b.deserializeCollisionBoxes(q),f&&_&&b.updateCollisionDebugBuffers(this.transform.zoom,q,Oe,je);const dt=(st,pt,mt)=>{const{crossTileID:Vt,numVerticalGlyphVertices:Xt}=st;let Bt=null;if(O&&O.dynamicFilterNeedsFeature||Ze){const Gn=this.retainedQueryData[b.bucketInstanceId];Bt=fe.loadFeature({featureIndex:st.featureIndex,bucketIndex:Gn.bucketIndex,sourceLayerIndex:Gn.sourceLayerIndex,layoutVertexArrayOffset:0})}if(O&&!(0,O.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Bt,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new r.P(st.tileAnchorX,st.tileAnchorY),this.transform.calculateDistanceTileData(O.unwrappedTileID)))return this.placements[Vt]=new ga(!1,!1,!1,!0),void s.add(Vt);const Yt=Te.evaluate(Bt,{});if(s.has(Vt))return;if(H)return void(this.placements[Vt]=new ga(!1,!1,!1));let jt=!1,en=!1,cn=!0,Rn=!1,ai=!1,ii=null,Ln={box:null,offscreen:null,occluded:null},Zi={box:null},Ni=null,pn=null,Vn=null,Zn=0,li=0,or=0;mt.textFeatureIndex?Zn=mt.textFeatureIndex:st.useRuntimeCollisionCircles&&(Zn=st.featureIndex),mt.verticalTextFeatureIndex&&(li=mt.verticalTextFeatureIndex);const Yi=Gn=>{Gn.tileID=this.retainedQueryData[b.bucketInstanceId].tileID;const zi=this.transform.elevation;Gn.elevation=Ue?Yt:Yt+(zi?zi.getAtTileOffset(Gn.tileID,Gn.tileAnchorX,Gn.tileAnchorY):0),Gn.elevation+=st.zOffset},rr=mt.textBox;if(rr){Yi(rr);const Gn=Jn=>{let Fi=r.bI.horizontal;if(b.allowVerticalPlacement&&!Jn&&this.prevPlacement){const Tr=this.prevPlacement.placedOrientations[Vt];Tr&&(this.placedOrientations[Vt]=Tr,Fi=Tr,this.markUsedOrientation(b,Fi,st))}return Fi},zi=(Jn,Fi)=>{if(b.allowVerticalPlacement&&Xt>0&&mt.verticalTextBox){for(const Tr of b.writingModes)if(Tr===r.bI.vertical?(Ln=Fi(),Zi=Ln):Ln=Jn(),Ln&&Ln.box&&Ln.box.length)break}else Ln=Jn()};if(T.get("text-variable-anchor")){let Jn=T.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Vt]){const Si=this.prevPlacement.variableOffsets[Vt];Jn.indexOf(Si.anchor)>0&&(Jn=Jn.filter(Cr=>Cr!==Si.anchor),Jn.unshift(Si.anchor))}const Fi=(Si,Cr,nr)=>{const Lr=b.getSymbolInstanceTextSize(Y,st,this.transform.zoom,pt),ds=(Si.x2-Si.x1)*Lr+2*Si.padding,ea=(Si.y2-Si.y1)*Lr+2*Si.padding,yo=st.hasIconTextFit&&!ve?Cr:null;yo&&Yi(yo);let Jo={box:[],offscreen:!1,occluded:!1};const Cs=ye?2*Jn.length:Jn.length;for(let Ps=0;Ps<Cs;++Ps){const ps=this.attemptAnchorPlacement(Jn[Ps%Jn.length],Si,ds,ea,Lr,_e,we,U,z,oe,Ps>=Jn.length,st,pt,b,nr,yo,Y,Z);if(ps&&(Jo=ps.placedGlyphBoxes,Jo&&Jo.box&&Jo.box.length)){jt=!0,ii=ps.shift;break}}return Jo};zi(()=>Fi(rr,mt.iconBox,r.bI.horizontal),()=>{const Si=mt.verticalTextBox;return Si&&Yi(Si),b.allowVerticalPlacement&&!(Ln&&Ln.box&&Ln.box.length)&&Xt>0&&Si?Fi(Si,mt.verticalIconBox,r.bI.vertical):{box:null,offscreen:null,occluded:null}}),Ln&&(jt=Ln.box,cn=Ln.offscreen,Rn=Ln.occluded);const Tr=Gn(!(!Ln||!Ln.box));if(!jt&&this.prevPlacement){const Si=this.prevPlacement.variableOffsets[Vt];Si&&(this.variableOffsets[Vt]=Si,this.markUsedJustification(b,Si.anchor,st,Tr))}}else{const Jn=(Fi,Tr)=>{const Si=b.getSymbolInstanceTextSize(Y,st,this.transform.zoom,pt,g),Cr=this.collisionIndex.placeCollisionBox(b,Si,Fi,new r.P(0,0),ye,U,z,oe.predicate);return Cr&&Cr.box&&Cr.box.length&&(this.markUsedOrientation(b,Tr,st),this.placedOrientations[Vt]=Tr),Cr};zi(()=>Jn(rr,r.bI.horizontal),()=>{const Fi=mt.verticalTextBox;return b.allowVerticalPlacement&&Xt>0&&Fi?(Yi(Fi),Jn(Fi,r.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Gn(!!(Ln&&Ln.box&&Ln.box.length))}}if(Ni=Ln,jt=Ni&&Ni.box&&Ni.box.length>0,cn=Ni&&Ni.offscreen,Rn=Ni&&Ni.occluded,st.useRuntimeCollisionCircles){const Gn=b.text.placedSymbolArray.get(st.centerJustifiedTextSymbolIndex>=0?st.centerJustifiedTextSymbolIndex:st.verticalPlacedTextSymbolIndex),zi=r.bJ(b.textSizeData,Y,Gn),Jn=T.get("text-padding");pn=this.collisionIndex.placeCollisionCircles(b,ye,Gn,b.lineVertexArray,b.glyphOffsetArray,zi,z,D,F,f,we,oe.predicate,st.collisionCircleDiameter*zi/r.bO,Jn,this.retainedQueryData[b.bucketInstanceId].tileID),jt=ye||pn.circles.length>0&&!pn.collisionDetected,cn=cn&&pn.offscreen,Rn=pn.occluded}if(mt.iconFeatureIndex&&(or=mt.iconFeatureIndex),mt.iconBox){const Gn=zi=>{Yi(zi);const Jn=st.hasIconTextFit&&ii?ya(ii.x,ii.y,_e,we,this.transform.angle):new r.P(0,0),Fi=b.getSymbolInstanceIconSize(Z,this.transform.zoom,st.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,Fi,zi,Jn,ve,U,z,oe.predicate)};Zi&&Zi.box&&Zi.box.length&&mt.verticalIconBox?(Vn=Gn(mt.verticalIconBox),en=Vn.box.length>0):(Vn=Gn(mt.iconBox),en=Vn.box.length>0),cn=cn&&Vn.offscreen,ai=Vn.occluded}const Oi=me||st.numHorizontalGlyphVertices===0&&Xt===0,xn=xe||st.numIconVertices===0;if(Oi||xn?xn?Oi||(en=en&&jt):jt=en&&jt:en=jt=en&&jt,jt&&Ni&&Ni.box&&this.collisionIndex.insertCollisionBox(Ni.box,T.get("text-ignore-placement"),b.bucketInstanceId,Zi&&Zi.box&&li?li:Zn,oe.ID),en&&Vn&&this.collisionIndex.insertCollisionBox(Vn.box,T.get("icon-ignore-placement"),b.bucketInstanceId,or,oe.ID),pn&&(jt&&this.collisionIndex.insertCollisionCircles(pn.circles,T.get("text-ignore-placement"),b.bucketInstanceId,Zn,oe.ID),f)){const Gn=b.bucketInstanceId;let zi=this.collisionCircleArrays[Gn];zi===void 0&&(zi=this.collisionCircleArrays[Gn]=new Kt);for(let Jn=0;Jn<pn.circles.length;Jn+=4)zi.circles.push(pn.circles[Jn+0]),zi.circles.push(pn.circles[Jn+1]),zi.circles.push(pn.circles[Jn+2]),zi.circles.push(pn.collisionDetected?1:0)}const Pi=b.projection.name!=="globe";Le=Le&&(Pi||!Rn),lt=lt&&(Pi||!ai),this.placements[Vt]=new ga(jt||Le,en||lt,cn||b.justReloaded),s.add(Vt)};if(b.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(b,this.retainedQueryData[b.bucketInstanceId].tileID),b.elevationType==="road"&&b.updateRoadElevation(),b.updateZOffset(),b.sortFeaturesByY){const st=b.getSortedSymbolIndexes(this.transform.angle);for(let pt=st.length-1;pt>=0;--pt){const mt=st[pt];dt(b.symbolInstances.get(mt),mt,b.collisionArrays[mt])}b.hasAnyZOffset&&r.w(`${b.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(b.hasAnyZOffset){const st=b.getSortedIndexesByZOffset();for(let pt=0;pt<st.length;++pt){const mt=st[pt];dt(b.symbolInstances.get(mt),mt,b.collisionArrays[mt])}}else for(let st=t.symbolInstanceStart;st<t.symbolInstanceEnd;st++)dt(b.symbolInstances.get(st),st,b.collisionArrays[st]);if(f&&b.bucketInstanceId in this.collisionCircleArrays){const st=this.collisionCircleArrays[b.bucketInstanceId];r.bi(st.invProjMatrix,z),st.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(t,s,f,_){const{leftJustifiedTextSymbolIndex:g,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:A,crossTileID:z}=f,D=r.bT(s),F=_===r.bI.vertical?A:D==="left"?g:D==="center"?b:D==="right"?T:-1;g>=0&&(t.text.placedSymbolArray.get(g).crossTileID=F>=0&&g!==F?0:z),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=F>=0&&b!==F?0:z),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=F>=0&&T!==F?0:z),A>=0&&(t.text.placedSymbolArray.get(A).crossTileID=F>=0&&A!==F?0:z)}markUsedOrientation(t,s,f){const _=s===r.bI.horizontal||s===r.bI.horizontalOnly?s:0,g=s===r.bI.vertical?s:0,{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:T,rightJustifiedTextSymbolIndex:A,verticalPlacedTextSymbolIndex:z}=f,D=t.text.placedSymbolArray;b>=0&&(D.get(b).placedOrientation=_),T>=0&&(D.get(T).placedOrientation=_),A>=0&&(D.get(A).placedOrientation=_),z>=0&&(D.get(z).placedOrientation=g)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const s=this.prevPlacement;let f=!1;this.prevZoomAdjustment=s?s.zoomAdjustment(this.transform.zoom):0;const _=s?s.symbolFadeChange(t):1,g=s?s.opacities:{},b=s?s.variableOffsets:{},T=s?s.placedOrientations:{};for(const A in this.placements){const z=this.placements[A],D=g[A];D?(this.opacities[A]=new al(D,_,z.text,z.icon,null,z.clipped),f=f||z.text!==D.text.placed||z.icon!==D.icon.placed):(this.opacities[A]=new al(null,_,z.text,z.icon,z.skipFade,z.clipped),f=f||z.text||z.icon)}for(const A in g){const z=g[A];if(!this.opacities[A]){const D=new al(z,_,!1,!1);D.isHidden()||(this.opacities[A]=D,f=f||z.text.placed||z.icon.placed)}}for(const A in b)this.variableOffsets[A]||!this.opacities[A]||this.opacities[A].isHidden()||(this.variableOffsets[A]=b[A]);for(const A in T)this.placedOrientations[A]||!this.opacities[A]||this.opacities[A].isHidden()||(this.placedOrientations[A]=T[A]);f?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=s?s.lastPlacementChangeTime:t)}updateLayerOpacities(t,s,f,_){const g=new Set;for(const b of s){const T=b.getBucket(t);T&&b.latestFeatureIndex&&t.fqid===T.layerIds[0]&&(this.updateBucketOpacities(T,g,b,b.collisionBoxArray,f,_,b.tileID,t.scope),T.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(T,b.tileID),T.elevationType==="road"&&T.updateRoadElevation(),T.updateZOffset())}}updateBucketOpacities(t,s,f,_,g,b,T,A){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const z=t.layers[0].layout,D=t.layers[0].paint,F=!!t.layers[0].dynamicFilter(),O=new al(null,0,!1,!1,!0),U=z.get("text-allow-overlap"),H=z.get("icon-allow-overlap"),q=z.get("text-variable-anchor"),Y=z.get("text-rotation-alignment")==="map",Z=z.get("text-pitch-alignment")==="map",oe=D.get("symbol-z-offset"),fe=z.get("symbol-elevation-reference")==="sea",me=!oe.isConstant(),xe=new al(null,0,U&&(H||!t.hasIconData()||z.get("icon-optional")),H&&(U||!t.hasTextData()||z.get("text-optional")),!0);!t.collisionArrays&&_&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(_);const ye=(_e,we,Te)=>{for(let Ue=0;Ue<we/4;Ue++)_e.opacityVertexArray.emplaceBack(Te)};let ve=0;b&&t.updateReplacement(T,b);for(let _e=0;_e<t.symbolInstances.length;_e++){const we=t.symbolInstances.get(_e),{numHorizontalGlyphVertices:Te,numVerticalGlyphVertices:Ue,crossTileID:Fe,numIconVertices:ot,tileAnchorX:et,tileAnchorY:xt}=we;let Oe=null;const je=this.retainedQueryData[t.bucketInstanceId];me&&we&&je&&(Oe=f.latestFeatureIndex.loadFeature({featureIndex:we.featureIndex,bucketIndex:je.bucketIndex,sourceLayerIndex:je.sourceLayerIndex,layoutVertexArrayOffset:0}));const Le=oe.evaluate(Oe,{}),lt=s.has(Fe);let Ze=this.opacities[Fe];lt?Ze=O:Ze||(Ze=xe,this.opacities[Fe]=Ze),s.add(Fe);const dt=Te>0||Ue>0,st=ot>0,pt=this.placedOrientations[Fe],mt=pt===r.bI.vertical,Vt=pt===r.bI.horizontal||pt===r.bI.horizontalOnly;!dt&&!st||Ze.isHidden()||ve++;let Xt=!1;if((dt||st)&&b)for(const Bt of t.activeReplacements){if(r.bP(Bt,g,r.bQ.Symbol,A)||Bt.min.x>et||et>Bt.max.x||Bt.min.y>xt||xt>Bt.max.y)continue;const Yt=r.bR(et,xt,T.canonical,Bt.footprintTileId.canonical);if(Xt=r.bS(Yt,Bt.footprint),Xt)break}if(dt){const Bt=Xt?va:ic(Ze.text);ye(t.text,Te,mt?va:Bt),ye(t.text,Ue,Vt?va:Bt);const Yt=Ze.text.isHidden(),{leftJustifiedTextSymbolIndex:jt,centerJustifiedTextSymbolIndex:en,rightJustifiedTextSymbolIndex:cn,verticalPlacedTextSymbolIndex:Rn}=we,ai=t.text.placedSymbolArray,ii=Yt||mt?1:0;jt>=0&&(ai.get(jt).hidden=ii),en>=0&&(ai.get(en).hidden=ii),cn>=0&&(ai.get(cn).hidden=ii),Rn>=0&&(ai.get(Rn).hidden=Yt||Vt?1:0);const Ln=this.variableOffsets[Fe];Ln&&this.markUsedJustification(t,Ln.anchor,we,pt);const Zi=this.placedOrientations[Fe];Zi&&(this.markUsedJustification(t,"left",we,Zi),this.markUsedOrientation(t,Zi,we))}if(st){const Bt=Xt?va:ic(Ze.icon),{placedIconSymbolIndex:Yt,verticalPlacedIconSymbolIndex:jt}=we,en=t.icon.placedSymbolArray,cn=Ze.icon.isHidden()?1:0;Yt>=0&&(ye(t.icon,ot,mt?va:Bt),en.get(Yt).hidden=cn),jt>=0&&(ye(t.icon,we.numVerticalIconVertices,Vt?va:Bt),en.get(jt).hidden=cn)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Bt=t.collisionArrays[_e];if(Bt){let Yt=new r.P(0,0),jt=!0;if(Bt.textBox||Bt.verticalTextBox){if(q){const cn=this.variableOffsets[Fe];cn?(Yt=lo(cn.anchor,cn.width,cn.height,cn.textOffset,cn.textScale),Y&&Yt._rotate(Z?this.transform.angle:-this.transform.angle)):jt=!1}F&&(jt=!Ze.clipped),Bt.textBox&&ll(t.textCollisionBox.collisionVertexArray,Ze.text.placed,!jt||mt,Le,fe,Yt.x,Yt.y),Bt.verticalTextBox&&ll(t.textCollisionBox.collisionVertexArray,Ze.text.placed,!jt||Vt,Le,fe,Yt.x,Yt.y)}const en=jt&&!!(!Vt&&Bt.verticalIconBox);Bt.iconBox&&ll(t.iconCollisionBox.collisionVertexArray,Ze.icon.placed,en,Le,fe,we.hasIconTextFit?Yt.x:0,we.hasIconTextFit?Yt.y:0),Bt.verticalIconBox&&ll(t.iconCollisionBox.collisionVertexArray,Ze.icon.placed,!en,Le,fe,we.hasIconTextFit?Yt.x:0,we.hasIconTextFit?Yt.y:0)}}}if(t.fullyClipped=ve===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const _e=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=_e.invProjMatrix,t.placementViewportMatrix=_e.viewportMatrix,t.collisionCircleArray=_e.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,s){const f=this.zoomAtLastRecencyCheck===s?1-this.zoomAdjustment(s):1;return this.zoomAtLastRecencyCheck=s,this.commitTime+this.fadeDuration*f>t}setStale(){this.stale=!0}}function ll(h,t,s,f,_,g,b){h.emplaceBack(t?1:0,s?1:0,g||0,b||0,f,_?1:0),h.emplaceBack(t?1:0,s?1:0,g||0,b||0,f,_?1:0),h.emplaceBack(t?1:0,s?1:0,g||0,b||0,f,_?1:0),h.emplaceBack(t?1:0,s?1:0,g||0,b||0,f,_?1:0)}const xu=Math.pow(2,25),bu=Math.pow(2,24),Xr=Math.pow(2,17),fr=Math.pow(2,16),kx=Math.pow(2,9),wu=Math.pow(2,8),op=Math.pow(2,1);function ic(h){if(h.opacity===0&&!h.placed)return 0;if(h.opacity===1&&h.placed)return 4294967295;const t=h.placed?1:0,s=Math.floor(127*h.opacity);return s*xu+t*bu+s*Xr+t*fr+s*kx+t*wu+s*op+t}const va=0;class Yh{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,s,f,_,g,b){const T=this._bucketParts;for(;this._currentTileIndex<t.length;)if(s.getBucketParts(T,_,t[this._currentTileIndex],this._sortAcrossTiles,b),this._currentTileIndex++,g())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,T.sort((A,z)=>A.sortKey-z.sortKey));this._currentPartIndex<T.length;){const A=T[this._currentPartIndex];if(s.placeLayerBucketPart(A,this._seenCrossTileIDs,f,A.symbolInstanceStart===0,b),this._currentPartIndex++,g())return!0}return!1}}class Yr{constructor(t,s,f,_,g,b,T,A,z){this.placement=new Qn(t,g,b,T,A,z),this._currentPlacementIndex=s.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=_,this._done=!1}isDone(){return this._done}continuePlacement(t,s,f,_,g){const b=r.q.now(),T=()=>{const A=r.q.now()-b;return!this._forceFullPlacement&&A>2};for(;this._currentPlacementIndex>=0;){const A=s[t[this._currentPlacementIndex]],z=this.placement.collisionIndex.transform.zoom;if(A.type==="symbol"&&(!A.minzoom||A.minzoom<=z)&&(!A.maxzoom||A.maxzoom>z)){const D=A,F=D.layout.get("symbol-z-elevate"),O=D.layout.get("symbol-sort-key").constantOr(1)!==void 0,U=D.layout.get("symbol-z-order"),H=U==="viewport-y"||U==="auto"&&!(U!=="viewport-y"&&O),q=D.layout.get("text-allow-overlap")||D.layout.get("icon-allow-overlap")||D.layout.get("text-ignore-placement")||D.layout.get("icon-ignore-placement"),Y=H&&q,Z=this._inProgressLayer=this._inProgressLayer||new Yh(D),oe=r.C(A.source,A.scope);if(Z.continuePlacement(F||Y?_[oe]:f[oe],this.placement,this._showCollisionBoxes,A,T,g))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const as=512/r.aj/2;class co{constructor(t,s,f){this.tileID=t,this.bucketInstanceId=f,this.index=new r.bW(s.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const _=t.canonical.x*r.aj,g=t.canonical.y*r.aj;for(let b=0;b<s.length;b++){const{key:T,crossTileID:A,tileAnchorX:z,tileAnchorY:D}=s.get(b),F=Math.floor((_+z)*as),O=Math.floor((g+D)*as);this.index.add(F,O),this.keys.push(T),this.crossTileIDs.push(A)}this.index.finish()}findMatches(t,s,f){const _=this.tileID.canonical.z<s.canonical.z?1:Math.pow(2,this.tileID.canonical.z-s.canonical.z),g=as/Math.pow(2,s.canonical.z-this.tileID.canonical.z),b=s.canonical.x*r.aj,T=s.canonical.y*r.aj;for(let A=0;A<t.length;A++){const z=t.get(A);if(z.crossTileID)continue;const{key:D,tileAnchorX:F,tileAnchorY:O}=z,U=Math.floor((b+F)*g),H=Math.floor((T+O)*g),q=this.index.range(U-_,H-_,U+_,H+_).sort((Y,Z)=>Y-Z);for(const Y of q){const Z=this.crossTileIDs[Y];if(this.keys[Y]===D&&!f.has(Z)){f.add(Z),z.crossTileID=Z;break}}}}}class ng{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class rc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const s=Math.round((t-this.lng)/360);if(s!==0)for(const f in this.indexes){const _=this.indexes[f],g={};for(const b in _){const T=_[b];T.tileID=T.tileID.unwrapTo(T.tileID.wrap+s),g[T.tileID.key]=T}this.indexes[f]=g}this.lng=t}addBucket(t,s,f){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===s.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let g=0;g<s.symbolInstances.length;g++)s.symbolInstances.get(g).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const _=this.usedCrossTileIDs[t.overscaledZ];for(const g in this.indexes){const b=this.indexes[g];if(Number(g)>t.overscaledZ)for(const T in b){const A=b[T];A.tileID.isChildOf(t)&&A.findMatches(s.symbolInstances,t,_)}else{const T=b[t.scaledTo(Number(g)).key];T&&T.findMatches(s.symbolInstances,t,_)}}for(let g=0;g<s.symbolInstances.length;g++){const b=s.symbolInstances.get(g);b.crossTileID||(b.crossTileID=f.generate(),_.add(b.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new co(t,s.symbolInstances,s.bucketInstanceId),!0}removeBucketCrossTileIDs(t,s){for(const f of s.crossTileIDs)this.usedCrossTileIDs[t].delete(f)}removeStaleBuckets(t){let s=!1;for(const f in this.indexes){const _=this.indexes[f];for(const g in _)t[_[g].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,_[g]),delete _[g],s=!0)}return s}}class vr{constructor(){this.layerIndexes={},this.crossTileIDs=new ng,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,s,f,_){let g=this.layerIndexes[t.fqid];g===void 0&&(g=this.layerIndexes[t.fqid]=new rc);let b=!1;const T={};_.name!=="globe"&&g.handleWrapJump(f);for(const A of s){const z=A.getBucket(t);z&&t.fqid===z.layerIds[0]&&(z.bucketInstanceId||(z.bucketInstanceId=++this.maxBucketInstanceId),g.addBucket(A.tileID,z,this.crossTileIDs)&&(b=!0),T[z.bucketInstanceId]=!0)}return g.removeStaleBuckets(T)&&(b=!0),b}pruneUnusedLayers(t){const s={};t.forEach(f=>{s[f]=!0});for(const f in this.layerIndexes)s[f]||delete this.layerIndexes[f]}}const Kr=771;class In{constructor(t,s,f,_){this.blendFunction=t,this.blendColor=s,this.mask=f,this.blendEquation=_}}In.Replace=[1,0,1,0],In.disabled=new In(In.Replace,r.am.transparent,[!1,!1,!1,!1]),In.unblended=new In(In.Replace,r.am.transparent,[!0,!0,!0,!0]),In.alphaBlended=new In([1,Kr,1,Kr],r.am.transparent,[!0,!0,!0,!0]),In.alphaBlendedNonPremultiplied=new In([770,Kr,770,Kr],r.am.transparent,[!0,!0,!0,!0]),In.multiply=new In([774,0,774,0],r.am.transparent,[!0,!0,!0,!0]);class Ut{constructor(t,s,f){this.func=t,this.mask=s,this.range=f}}Ut.ReadOnly=!1,Ut.ReadWrite=!0,Ut.disabled=new Ut(519,Ut.ReadOnly,[0,1]);const Tu=7680;class sn{constructor(t,s,f,_,g,b){this.test=t,this.ref=s,this.mask=f,this.fail=_,this.depthFail=g,this.pass=b}}sn.disabled=new sn({func:519,mask:0},0,0,Tu,Tu,Tu);const cl=1029,oc=2305;class an{constructor(t,s,f){this.enable=t,this.mode=s,this.frontFace=f}}function ig(h,t){const s=r.c1(h,3);r.c3(h,t),r.c7(h,3,s)}function ls(h,t){const s=r.bY([]);return r.bZ(s,s,-t),r.b_(s,s,-h),s}function rg(h,t){const s=[h[0],h[1],0],f=[t[0],t[1],0];if(r.ae(s)>=1e-15){const b=r.au([],s);r.b$(f,b,r.bE(f,b)),t[0]=f[0],t[1]=f[1]}const _=r.bG([],t,h);if(r.c0(_)<1e-15)return null;const g=Math.atan2(-_[1],_[0]);return ls(Math.atan2(Math.sqrt(h[0]*h[0]+h[1]*h[1]),-h[2]),g)}an.disabled=new an(!1,cl,oc),an.backCCW=new an(!0,cl,oc),an.backCW=new an(!0,cl,2304),an.frontCW=new an(!0,1028,2304),an.frontCCW=new an(!0,1028,oc);class Kh{constructor(t,s){this.position=t,this.orientation=s}get position(){return this._position}set position(t){if(t){const s=t instanceof r.ac?t:new r.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(s.x=r.bX(s.x,0,1)),this._position=s}else this._position=null}lookAtPoint(t,s){if(this.orientation=null,!this.position)return;const f=this.position,_=this._elevation?this._elevation.getAtPointOrZero(r.ac.fromLngLat(t)):0,g=r.ac.fromLngLat(t,_),b=[g.x-f.x,g.y-f.y,g.z-f.z];s||(s=[0,0,1]),s[2]=Math.abs(s[2]),this.orientation=rg(b,s)}setPitchBearing(t,s){this.orientation=ls(r.al(t),r.al(-s))}}class Gr{constructor(t,s){this._transform=r.bx([]),this.orientation=s,this.position=t}get mercatorPosition(){const t=this.position;return new r.ac(t[0],t[1],t[2])}get position(){const t=r.c1(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var s;t&&r.c7(this._transform,3,[(s=t)[0],s[1],s[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||r.bY([]),t&&ig(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),s=this.right();return{bearing:Math.atan2(-s[1],s[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,s){this._orientation=ls(t,s),ig(this._transform,this._orientation)}forward(){const t=r.c1(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=r.c1(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=r.c1(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,s){const f=new Float64Array(16);return r.bi(f,this.getWorldToCamera(t,s)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,s,f){const _=this.position;r.b$(_,_,-t);const g=new Float64Array(16);return r.bn(g,[f,f,f]),r.bo(g,g,_),g[10]*=s,g}getWorldToCamera(t,s){const f=new Float64Array(16),_=new Float64Array(4),g=this.position;return r.c2(_,this._orientation),r.b$(g,g,-t),r.c3(f,_),r.bo(f,f,g),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=s,f[9]*=s,f[10]*=s,f[11]*=s,f}getCameraToClipPerspective(t,s,f,_){const g=new Float64Array(16);return r.c4(g,t,s,f,_),g}getCameraToClipOrthographic(t,s,f,_,g,b){const T=new Float64Array(16);return r.c5(T,t,s,f,_,g,b),T}getDistanceToElevation(t,s=!1){const f=t===0?0:r.c6(t,s?r.aY(this.position[1]):this.position[1]),_=this.forward();return(f-this.position[2])/_[2]}clone(){return new Gr([...this.position],[...this.orientation])}}const Jr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class sc{constructor(t=0,s=0,f=0,_=0){if(isNaN(t)||t<0||isNaN(s)||s<0||isNaN(f)||f<0||isNaN(_)||_<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=s,this.left=f,this.right=_}interpolate(t,s,f){return s.top!=null&&t.top!=null&&(this.top=r.ai(t.top,s.top,f)),s.bottom!=null&&t.bottom!=null&&(this.bottom=r.ai(t.bottom,s.bottom,f)),s.left!=null&&t.left!=null&&(this.left=r.ai(t.left,s.left,f)),s.right!=null&&t.right!=null&&(this.right=r.ai(t.right,s.right,f)),this}getCenter(t,s){const f=r.aD((this.left+t-this.right)/2,0,t),_=r.aD((this.top+s-this.bottom)/2,0,s);return new r.P(f,_)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new sc(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const xa=15;class ul{constructor(t,s,f,_,g,b,T){this.tileSize=512,this._renderWorldCopies=g===void 0||g,this._minZoom=t||0,this._maxZoom=s||22,this._minPitch=f??0,this._maxPitch=_??60,this.setProjection(b),this.setMaxBounds(T),this.width=0,this.height=0,this._center=new r.cd(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new sc,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Gr,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new ul(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<xa}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,s=!1){const f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(t||f)&&this._constrainCamera(s),this._calcMatrices()}getProjection(){return r.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const s=this.projection?this.getProjection():void 0;this.projection=r.ce(this.projectionOptions);const f=this.getProjection(),_=!r.bv(s,f);return _&&this._calcMatrices(),this.mercatorFromTransition=!1,_}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=r.ce({name:"mercator"});const s=t!==this.projection.name;return s&&this._calcMatrices(),s}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return r.c6(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new r.P(this.width,this.height)}get bearing(){return r.bX(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const s=-t*Math.PI/180;this.angle!==s&&(this._unmodified=!1,this.angle=s,this._calcMatrices(),this.rotationMatrix=r.cf(),r.cg(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const s=r.aD(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==s&&(this._unmodified=!1,this._pitch=s,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=r.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const s=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==s&&(this._unmodified=!1,this._setZoom(s),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,s=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!s||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const f=this._elevation;s||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,s=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop();let _=0,g=0;for(let b=0;b<s.length;b++){const T=new r.P(s[b][0]*this.width,f+s[b][1]*(this.height-f)),A=t.pointCoordinate(T);if(!A)continue;const z=1/Math.hypot(A[0]-this._camera.position[0],A[1]-this._camera.position[1]);_+=A[3]*z,g+=z}return g===0?NaN:_/g}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,s=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*s,_=this._mercatorZfromZoom(t),g=this._mercatorZfromZoom(this._maxZoom),b=Math.max(_-f,g);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const s=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let f;f=t.z<this._camera.position[2]?[s.x,s.y,s.z]:[t.x,t.y,t.z];const _=r.ae(r.at([],this._camera.position,f));return r.aD(this._zoomFromMercatorZ(_),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let s=!1;if(t.orientation&&!r.ch(t.orientation,this._camera.orientation)&&(s=this._setCameraOrientation(t.orientation)),t.position){const f=[t.position.x,t.position.y,t.position.z];r.ci(f,this._camera.position)||(this._setCameraPosition(f),s=!0)}s&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,s=new Kh;return s.position=new r.ac(t[0],t[1],t[2]),s.orientation=this._camera.orientation,s._elevation=this.elevation,s._renderWorldCopies=this.renderWorldCopies,s}_setCameraOrientation(t){if(!r.cj(t))return!1;r.ck(t,t);const s=r.cl([],[0,0,-1],t),f=r.cl([],[0,-1,0],t);if(f[2]<0)return!1;const _=rg(s,f);return!!_&&(this._camera.orientation=_,!0)}_setCameraPosition(t){const s=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,_=this.cameraToCenterDistance;t[2]=r.aD(t[2],_/f,_/s),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,s,f){this._unmodified=!1,this._edgeInsets.interpolate(t,s,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const s=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,s)}getVisibleUnwrappedCoordinates(t){const s=[new r.cm(0,t)];if(this.renderWorldCopies){const f=this.pointCoordinate(new r.P(0,0)),_=this.pointCoordinate(new r.P(this.width,0)),g=this.pointCoordinate(new r.P(this.width,this.height)),b=this.pointCoordinate(new r.P(0,this.height)),T=Math.floor(Math.min(f.x,_.x,g.x,b.x)),A=Math.floor(Math.max(f.x,_.x,g.x,b.x)),z=1;for(let D=T-z;D<=A+z;D++)D!==0&&s.push(new r.cm(D,t))}return s}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,s,f){let _=[];const g=f!=null,b=!g;if(b&&this.zoom<s||g&&f[0]===0&&f[1]===0)return _;const T=new Set,A=(D,F,O,U,H)=>{const q=r.cK(F,D,O,U,H);T.has(q)||(_.push(new r.aM(D,F,O,U,H)),T.add(q))};for(let D=0;D<t.length;D++){const F=t[D];if(b&&F.canonical.z!==s)continue;const O=F.canonical,U=F.overscaledZ,H=F.wrap,q=1<<O.z,Y=O.x+1<q,Z=O.x>0,oe=O.y+1<q,fe=O.y>0,me=F.wrap-(Z?0:1),xe=F.wrap+(Y?0:1),ye=Z?O.x-1:q-1,ve=Y?O.x+1:0;if(g)f[0]<0?(A(U,xe,O.z,ve,O.y),f[1]<0&&oe&&(A(U,H,O.z,O.x,O.y+1),A(U,xe,O.z,ve,O.y+1)),f[1]>0&&fe&&(A(U,H,O.z,O.x,O.y-1),A(U,xe,O.z,ve,O.y-1))):f[0]>0?(A(U,me,O.z,ye,O.y),f[1]<0&&oe&&(A(U,H,O.z,O.x,O.y+1),A(U,me,O.z,ye,O.y+1)),f[1]>0&&fe&&(A(U,H,O.z,O.x,O.y-1),A(U,me,O.z,ye,O.y-1))):f[1]<0&&oe?A(U,H,O.z,O.x,O.y+1):fe&&A(U,H,O.z,O.x,O.y-1);else{const _e=F.visibleQuadrants;1&_e&&(A(U,me,O.z,ye,O.y),fe&&(A(U,H,O.z,O.x,O.y-1),A(U,me,O.z,ye,O.y-1))),2&_e&&(A(U,xe,O.z,ve,O.y),fe&&(A(U,H,O.z,O.x,O.y-1),A(U,xe,O.z,ve,O.y-1))),4&_e&&(A(U,me,O.z,ye,O.y),oe&&(A(U,H,O.z,O.x,O.y+1),A(U,me,O.z,ye,O.y+1))),8&_e&&(A(U,xe,O.z,ve,O.y),oe&&(A(U,H,O.z,O.x,O.y+1),A(U,xe,O.z,ve,O.y+1)))}}const z=[];for(const D of _)_.some(F=>D.isChildOf(F))||z.push(D);if(_=z.filter(D=>!t.some(F=>!!(D.overscaledZ<s&&F.isChildOf(D))||D.equals(F)||D.isChildOf(F))),b){const D=1<<s,F=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),O=[D*F.x,D*F.y],U=4,H=U*U;_=_.filter(q=>{const Y=q.canonical.x+.5-O[0],Z=q.canonical.y+.5-O[1];return Y*Y+Z*Z<H})}return _}coveringTiles(t){let s=this.coveringZoomLevel(t);const f=s,_=this.elevation&&this.elevation.exaggeration(),g=_&&!t.isTerrainDEM,b=this.projection.name==="mercator";if(t.minzoom!==void 0&&s<t.minzoom)return[];t.maxzoom!==void 0&&s>t.maxzoom&&(s=t.maxzoom);const T=this.locationCoordinate(this.center),A=this.center.lat,z=1<<s,D=[z*T.x,z*T.y,0],F=this.projection.name==="globe",O=!F,U=r.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,s,O),H=F?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),q=z*r.c6(1,this.center.lat),Y=this._camera.position[2]/r.c6(1,this.center.lat),Z=[z*H.x,z*H.y,Y*(O?1:q)],oe=F||_,fe=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),me=this.isLODDisabled(!0)?s:0;let xe;if(this._elevation&&t.isTerrainDEM)xe=1e4*this._elevation.exaggeration();else if(this._elevation){const Le=this._elevation.getMinMaxForVisibleTiles();xe=Le?Le.max:this._centerAltitude}else xe=this._centerAltitude;const ye=t.isTerrainDEM?-xe:this._elevation?this._elevation.getMinElevationBelowMSL():0,ve=this.projection.isReprojectedInTileSpace?r.co(this):1,_e=Le=>{const Ze=new r.ac(Le.x+25e-6,Le.y,Le.z),dt=new r.ac(Le.x,Le.y+25e-6,Le.z),st=Le.toLngLat(),pt=Ze.toLngLat(),mt=dt.toLngLat(),Vt=this.locationCoordinate(st),Xt=this.locationCoordinate(pt),Bt=this.locationCoordinate(mt),Yt=Math.hypot(Xt.x-Vt.x,Xt.y-Vt.y),jt=Math.hypot(Bt.x-Vt.x,Bt.y-Vt.y);return Math.sqrt(Yt*jt)*ve/25e-6},we=Le=>{const lt=xe,Ze=ye;return{aabb:r.cr(this,z,0,0,0,Le,Ze,lt,this.projection),zoom:0,x:0,y:0,minZ:Ze,maxZ:lt,wrap:Le,fullyVisible:!1}},Te=[];let Ue=[];const Fe=s,ot=t.reparseOverscaled?f:s,et=(Y-this._centerAltitude)*q,xt=Le=>{if(!this._elevation||!Le.tileID||!b)return;const lt=this._elevation.getMinMaxForTile(Le.tileID),Ze=Le.aabb;lt?(Ze.min[2]=lt.min,Ze.max[2]=lt.max,Ze.center[2]=(Ze.min[2]+Ze.max[2])/2):(Le.shouldSplit=je(Le),Le.shouldSplit||(Ze.min[2]=Ze.max[2]=Ze.center[2]=this._centerAltitude))},Oe=(Le,lt)=>{if(.707*lt<Le)return 1;const Ze=lt/Le;return Ze/(1.4144271570014144+(Math.pow(1.1,Ze-1.4144271570014144+1)-1)/(1.1-1)-1)},je=Le=>{if(Le.zoom<me)return!0;if(Le.zoom===Fe)return!1;if(Le.shouldSplit!=null)return Le.shouldSplit;const lt=Le.aabb.distanceX(Z),Ze=Le.aabb.distanceY(Z);let dt=et,st=1;if(F){dt=Le.aabb.distanceZ(Z);const jt=Math.pow(2,Le.zoom),en=r.aY((Le.y+1)/jt),cn=r.aY(Le.y/jt),Rn=Math.min(Math.max(A,en),cn),ai=r.cP(Rn)/r.cP(A);if(st=Rn===A?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,ai/this._mercatorScaleRatio),this.zoom<=r.cL&&Le.zoom===Fe-1&&ai>=.9)return!0}else if(g&&(dt=Le.aabb.distanceZ(Z)*q),this.projection.isReprojectedInTileSpace&&f<=5){const jt=Math.pow(2,Le.zoom),en=_e(new r.ac((Le.x+.5)/jt,(Le.y+.5)/jt));st=en>.85?1:en}if(!b){const jt=Math.sqrt(lt*lt+Ze*Ze+dt*dt);let en=(1<<Fe-Le.zoom)*fe*st;return en*=Oe(Math.max(dt,et),jt),jt<en}let pt=Number.MAX_VALUE,mt=0;const Vt=Le.aabb.getCorners(),Xt=[];for(const jt of Vt){r.at(Xt,jt,Z),F||(g?Xt[2]*=q:Xt[2]=et);const en=r.bE(Xt,this._camera.forward());en<pt&&(pt=en,mt=Math.abs(Xt[2]))}let Bt=(1<<Fe-Le.zoom)*fe*st;if(Bt*=Oe(Math.max(mt,et),pt),pt<Bt)return!0;const Yt=Le.aabb.closestPoint(D);return Yt[0]===D[0]&&Yt[1]===D[1]};if(this.renderWorldCopies)for(let Le=1;Le<=3;Le++)Te.push(we(-Le)),Te.push(we(Le));for(Te.push(we(0));Te.length>0;){const Le=Te.pop(),lt=Le.x,Ze=Le.y;let dt=Le.fullyVisible;const st=()=>this.projection.name==="globe"&&(Le.y===0||Le.y===(1<<Le.zoom)-1);if(!dt){let pt=oe?Le.aabb.intersects(U):Le.aabb.intersectsFlat(U);if(pt===0&&st()){const mt=new r.cp(Le.zoom,lt,Ze);pt=r.cq(this,z,mt,!0).intersects(U)}if(pt===0)continue;dt=pt===2}if(Le.zoom!==Fe&&je(Le))for(let pt=0;pt<4;pt++){const mt=(lt<<1)+pt%2,Vt=(Ze<<1)+(pt>>1),Xt={aabb:b?Le.aabb.quadrant(pt):r.cr(this,z,Le.zoom+1,mt,Vt,Le.wrap,Le.minZ,Le.maxZ,this.projection),zoom:Le.zoom+1,x:mt,y:Vt,wrap:Le.wrap,fullyVisible:dt,tileID:void 0,shouldSplit:void 0,minZ:Le.minZ,maxZ:Le.maxZ};g&&!F&&(Xt.tileID=new r.aM(Le.zoom+1===Fe?ot:Le.zoom+1,Le.wrap,Le.zoom+1,mt,Vt),xt(Xt)),Te.push(Xt)}else{const pt=Le.zoom===Fe?ot:Le.zoom;if(t.minzoom&&t.minzoom>pt)continue;let mt=0;if(!dt){let Yt=oe?Le.aabb.intersectsPrecise(U):Le.aabb.intersectsPreciseFlat(U);if(Yt===0&&st()){const jt=new r.cp(Le.zoom,lt,Ze);Yt=r.cq(this,z,jt,!0).intersectsPrecise(U)}if(Yt===0)continue;if(t.calculateQuadrantVisibility)if(U.containsPoint(Le.aabb.center))mt=15;else for(let jt=0;jt<4;jt++)Le.aabb.quadrant(jt).intersects(U)!==0&&(mt|=1<<jt)}const Vt=D[0]-(.5+lt+(Le.wrap<<Le.zoom))*(1<<s-Le.zoom),Xt=D[1]-.5-Ze,Bt=Le.tileID?Le.tileID:new r.aM(pt,Le.wrap,Le.zoom,lt,Ze);t.calculateQuadrantVisibility&&(Bt.visibleQuadrants=mt),Ue.push({tileID:Bt,distanceSq:Vt*Vt+Xt*Xt})}}if(this.fogCullDistSq){const Le=this.fogCullDistSq,lt=this.horizonLineFromTop();Ue=Ue.filter(Ze=>{const dt=[0,0,0,1],st=[r.aj,r.aj,0,1],pt=this.calculateFogTileMatrix(Ze.tileID.toUnwrapped());r.aA(dt,dt,pt),r.aA(st,st,pt);const mt=r.cs([],dt,st),Vt=r.ct([],dt,st),Xt=r.cM(mt,Vt);if(Xt===0)return!0;let Bt=!1;const Yt=this._elevation;if(Yt&&Xt>Le&&lt!==0){const jt=this.calculateProjMatrix(Ze.tileID.toUnwrapped());let en;t.isTerrainDEM||(en=Yt.getMinMaxForTile(Ze.tileID)),en||(en={min:ye,max:xe});const cn=r.cu(this.rotation),Rn=[cn[0]*r.aj,cn[1]*r.aj,en.max];r.ad(Rn,Rn,jt),Bt=(1-Rn[1])*this.height*.5<lt}return Xt<Le||Bt})}return Ue.sort((Le,lt)=>Le.distanceSq-lt.distanceSq).map(Le=>Le.tileID)}resize(t,s){this.width=t,this.height=s,this.pixelsToGLUnits=[2/t,-2/s],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const s=r.aD(t.lat,-r.cv,r.cv),f=this.projection.project(t.lng,s);return new r.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/r.c6(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,s){let f,_;const g=this.centerPoint;if(this.projection.name==="globe"){const T=this.worldSize;f=(s.x-g.x)/T,_=(s.y-g.y)/T}else{const T=this.pointCoordinate(s),A=this.pointCoordinate(g);f=T.x-A.x,_=T.y-A.y}const b=this.locationCoordinate(t);this.setLocation(new r.ac(b.x-f,b.y-_))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,s){return this.projection.locationPoint(this,t,s)}locationPoint3D(t,s){return this.projection.locationPoint(this,t,s,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,s){return this.coordinateLocation(this.pointCoordinate3D(t,s))}locationCoordinate(t,s){const f=s?r.c6(s,t.lat):void 0,_=this.projection.project(t.lng,t.lat);return new r.ac(_.x,_.y,f)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,s){const f=s??this._centerAltitude,_=[t.x,t.y,0,1],g=[t.x,t.y,1,1];r.aA(_,_,this.pixelMatrixInverse),r.aA(g,g,this.pixelMatrixInverse);const b=g[3];r.cw(_,_,1/_[3]),r.cw(g,g,1/b);const T=_[2],A=g[2];return{p0:_,p1:g,t:T===A?0:(f-T)/(A-T)}}screenPointToMercatorRay(t){const s=[t.x,t.y,0,1],f=[t.x,t.y,1,1];return r.aA(s,s,this.pixelMatrixInverse),r.aA(f,f,this.pixelMatrixInverse),r.cw(s,s,1/s[3]),r.cw(f,f,1/f[3]),s[2]=r.c6(s[2],this._center.lat)*this.worldSize,f[2]=r.c6(f[2],this._center.lat)*this.worldSize,r.cw(s,s,1/this.worldSize),r.cw(f,f,1/this.worldSize),new r.av([s[0],s[1],s[2]],r.au([],r.at([],f,s)))}rayIntersectionCoordinate(t){const{p0:s,p1:f,t:_}=t,g=r.c6(s[2],this._center.lat),b=r.c6(f[2],this._center.lat);return new r.ac(r.ai(s[0],f[0],_)/this.worldSize,r.ai(s[1],f[1],_)/this.worldSize,r.ai(g,b,_))}pointCoordinate(t,s=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,s)}pointCoordinate3D(t,s){if(!this.elevation)return this.pointCoordinate(t,s);let f=this.projection.pointCoordinate3D(this,t.x,t.y);if(f)return new r.ac(f[0],f[1],f[2]);let _=0,g=this.horizonLineFromTop();if(t.y>g)return this.pointCoordinate(t,s);const b=.02*g,T=t.clone();for(let A=0;A<10&&g-_>b;A++){T.y=r.ai(_,g,.66);const z=this.projection.pointCoordinate3D(this,T.x,T.y);z?(g=T.y,f=z):_=T.y}return f?new r.ac(f[0],f[1],f[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=r.cx)return!this.isPointAboveHorizon(t);const s=this.pointCoordinate(t);return s.y>=0&&s.y<=1}_coordinatePoint(t,s){const f=s&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,_=[t.x*this.worldSize,t.y*this.worldSize,f+t.toAltitude(),1];return r.aA(_,_,this.pixelMatrix),_[3]>0?new r.P(_[0]/_[3],_[1]/_[3]):new r.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:s}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,g=this.pointLocation3D(new r.P(s,t)),b=this.pointLocation3D(new r.P(_,t)),T=this.pointLocation3D(new r.P(_,f)),A=this.pointLocation3D(new r.P(s,f));let z=Math.min(g.lng,b.lng,T.lng,A.lng),D=Math.max(g.lng,b.lng,T.lng,A.lng),F=Math.min(g.lat,b.lat,T.lat,A.lat),O=Math.max(g.lat,b.lat,T.lat,A.lat);const U=Math.pow(2,-this.zoom)/16*270,H=this.projection.name==="globe"?1:4,q=(Y,Z,oe,fe,me)=>{const xe=(Y+oe)/2,ye=(Z+fe)/2,ve=new r.P(xe,ye),{lng:_e,lat:we}=this.pointLocation3D(ve),Te=Math.max(0,z-_e,F-we,_e-D,we-O);z=Math.min(z,_e),D=Math.max(D,_e),F=Math.min(F,we),O=Math.max(O,we),(me<H||Te>U)&&(q(Y,Z,xe,ye,me+1),q(xe,ye,oe,fe,me+1))};if(q(s,t,_,t,1),q(_,t,_,f,1),q(_,f,s,f,1),q(s,f,s,t,1),this.projection.name==="globe"){const[Y,Z]=r.cy(this);Y?(O=90,D=180,z=-180):Z&&(F=-90,D=180,z=-180)}return new r.aG(new r.cd(z,F),new r.cd(D,O))}_getBoundsRectangular(t,s){const{top:f,left:_}=this._edgeInsets,g=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,T=new r.P(_,f),A=new r.P(b,f),z=new r.P(b,g),D=new r.P(_,g);let F=this.pointCoordinate(T,t),O=this.pointCoordinate(A,t);const U=this.pointCoordinate(z,s),H=this.pointCoordinate(D,s),q=(Y,Z)=>(Z.y-Y.y)/(Z.x-Y.x);return F.y>1&&O.y>=0?F=new r.ac((1-H.y)/q(H,F)+H.x,1):F.y<0&&O.y<=1&&(F=new r.ac(-H.y/q(H,F)+H.x,0)),O.y>1&&F.y>=0?O=new r.ac((1-U.y)/q(U,O)+U.x,1):O.y<0&&F.y<=1&&(O=new r.ac(-U.y/q(U,O)+U.x,0)),new r.aG().extend(this.coordinateLocation(F)).extend(this.coordinateLocation(O)).extend(this.coordinateLocation(H)).extend(this.coordinateLocation(U))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const s=t.visibleDemTiles.reduce((f,_)=>{if(_.dem){const g=_.dem.tree;f.min=Math.min(f.min,g.minimums[0]),f.max=Math.max(f.max,g.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(s.min*t.exaggeration(),s.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const s=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-s*(1-this._horizonShift);return t?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-r.cv,this.maxLat=r.cv,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=r.ay(this.minLng)*this.tileSize,this.worldMaxX=r.ay(this.maxLng)*this.tileSize,this.worldMinY=r.aH(this.maxLat)*this.tileSize,this.worldMaxY=r.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,s){return this.projection.createTileMatrix(this,s,t)}calculateDistanceTileData(t){const s=t.key,f=this._distanceTileDataCache;if(f[s])return f[s];const _=t.canonical,g=1/this.height,b=this.cameraWorldSize,T=b/this.zoomScale(_.z),A=(_.x+Math.pow(2,_.z)*t.wrap)*T,z=_.y*T,D=this.point;D.x*=b/this.worldSize,D.y*=b/this.worldSize;const F=this.angle,O=Math.sin(-F),U=-Math.cos(-F);return f[s]={bearing:[O,U],center:[(D.x-A)*g,(D.y-z)*g],scale:T/r.aj*g},f[s]}calculateFogTileMatrix(t){const s=t.key,f=this._fogTileMatrixCache;if(f[s])return f[s];const _=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return r.az(_,this.worldToFogMatrix,_),f[s]=new Float32Array(_),f[s]}calculateProjMatrix(t,s=!1,f=!1){const _=t.key;let g;if(g=f?this._expandedProjMatrixCache:s?this._alignedProjMatrixCache:this._projMatrixCache,g[_])return g[_];const b=this.calculatePosMatrix(t,this.worldSize);let T;return T=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:s?this.alignedProjMatrix:this.projMatrix,r.az(b,T,b),g[_]=new Float32Array(b),g[_]}calculatePixelsToTileUnitsMatrix(t){const s=t.tileID.key,f=this._pixelsToTileUnitsCache;if(f[s])return f[s];const _=r.cz(t,this);return f[s]=_,f[s]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,s=r.bn([],[t,t,t]);return r.az(s,s,this.globeMatrix),s}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const s=r.c6(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(s),_=this._camera.forward(),g=r.c6(1,this._center.lat);f[2]/=g,_[2]/=g,r.au(_,_);const b=t.raycast(f,_,t.exaggeration());if(b){const T=r.bF([],f,_,b),A=new r.ac(T[0],T[1],r.c6(T[2],r.aY(T[1]))),z=(A.z+r.ae([A.x-f[0],A.y-f[1],A.z-f[2]*g]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(z),this._centerAltitude=A.toAltitude(),this._center=this.coordinateLocation(A),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const s=this._elevation,f=r.c6(1,this._center.lat)*this.worldSize,_=this._computeCameraPosition(f),g=s.getAtPointOrZero(new r.ac(..._)),b=this.pixelsPerMeter/this.worldSize*g,T=this._minimumHeightOverTerrain(),A=_[2]-b;if(A<=T)if(A<0||t){const z=this.locationCoordinate(this._center,this._centerAltitude),D=[_[0],_[1],z.z-_[2]],F=r.ae(D);D[2]-=(T-A)/this._pixelsPerMercatorPixel;const O=r.ae(D);if(O===0)return;r.b$(D,D,F/O*this._pixelsPerMercatorPixel),this._camera.position=[_[0],_[1],z.z*this._pixelsPerMercatorPixel-D[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const O=this.center;return O.lat=r.aD(O.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(O.lng=r.aD(O.lng,this.minLng,this.maxLng)),this.center=O,void(this._constraining=!1)}const s=this._unmodified,{x:f,y:_}=this.point;let g=0,b=f,T=_;const A=this.width/2,z=this.height/2,D=this.worldMinY*this.scale,F=this.worldMaxY*this.scale;if(_-z<D&&(T=D+z),_+z>F&&(T=F-z),F-D<this.height&&(g=Math.max(g,this.height/(F-D)),T=(F+D)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const O=this.worldMinX*this.scale,U=this.worldMaxX*this.scale,H=this.worldSize/2-(O+U)/2;b=(f+H+this.worldSize)%this.worldSize-H,b-A<O&&(b=O+A),b+A>U&&(b=U-A),U-O<this.width&&(g=Math.max(g,this.width/(U-O)),b=(U+O)/2)}b===f&&T===_||this._allowWorldUnderZoom||(this.center=this.unproject(new r.P(b,T))),g&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(g)),this._constrainCamera(),this._unmodified=s,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,s=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=r.c6(1,this.center.lat)/r.c6(1,r.cN));const _=r.cA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,_),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const g=this.projection.zAxisUnit==="meters"?f:1,b=this._camera.getWorldToCamera(this.worldSize,g);let T;const A=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(A[8]=2*-t.x/this.width,A[9]=2*t.y/this.height,this.isOrthographic){let we=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Te=we*this.aspect,Ue=-Te,Fe=-we;Te-=t.x,Ue-=t.x,we+=t.y,Fe+=t.y,T=this._camera.getCameraToClipOrthographic(Ue,Te,Fe,we,this._nearZ,this._farZ),((ot,et,xt,Oe)=>{for(let je=0;je<16;je++)ot[je]=r.ai(et[je],xt[je],Oe)})(T,T,A,r.cO(this.pitch>=xa?1:this.pitch/xa))}else T=A;const z=r.cB([],A,b);let D=r.cB([],T,b);if(this.projection.isReprojectedInTileSpace){const we=this.locationCoordinate(this.center),Te=r.bx([]);r.bo(Te,Te,[we.x*this.worldSize,we.y*this.worldSize,0]),r.az(Te,Te,r.cC(this)),r.bo(Te,Te,[-we.x*this.worldSize,-we.y*this.worldSize,0]),r.az(D,D,Te),r.az(z,z,Te),this.inverseAdjustmentMatrix=r.cD(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=r.cE([],D,[this.worldSize,this.worldSize,this.worldSize/g,1]),this.projMatrix=D,this.invProjMatrix=r.bi(new Float64Array(16),this.projMatrix),s){const we=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);we[8]=2*-t.x/this.width,we[9]=2*t.y/this.height,this.expandedFarZProjMatrix=r.cB([],we,b)}else this.expandedFarZProjMatrix=this.projMatrix;const F=r.bi([],T);this.frustumCorners=r.cF.fromInvProjectionMatrix(F,this.horizonLineFromTop(),this.height),this.cameraFrustum=r.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!s);const O=new Float32Array(16);r.bx(O),r.cE(O,O,[1,-1,1]),r.cG(O,O,this._pitch),r.by(O,O,this.angle);const U=r.c4(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=r.bw(U);const H=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;U[8]=2*-t.x/this.width,U[9]=2*(t.y+H)/this.height,this.skyboxMatrix=r.az(O,U,O);const q=this.point,Y=q.x,Z=q.y,oe=this.width%2/2,fe=this.height%2/2,me=Math.cos(this.angle),xe=Math.sin(this.angle),ye=Y-Math.round(Y)+me*oe+xe*fe,ve=Z-Math.round(Z)+me*fe+xe*oe,_e=new Float64Array(D);if(r.bo(_e,_e,[ye>.5?ye-1:ye,ve>.5?ve-1:ve,0]),this.alignedProjMatrix=_e,D=r.bz(),r.cE(D,D,[this.width/2,-this.height/2,1]),r.bo(D,D,[1,-1,0]),this.labelPlaneMatrix=D,D=r.bz(),r.cE(D,D,[1,-1,1]),r.bo(D,D,[-1,-1,0]),r.cE(D,D,[2/this.width,2/this.height,1]),this.glCoordMatrix=D,this.pixelMatrix=r.az(new Float64Array(16),this.labelPlaneMatrix,z),this._calcFogMatrices(),this._distanceTileDataCache={},D=r.bi(new Float64Array(16),this.pixelMatrix),!D)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=D,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=r.cH(this);const we=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=r.ad(we,we,b),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=D;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,s=this.cameraPixelsPerMeter,f=this._camera.position,_=1/this.height/this._pixelsPerMercatorPixel,g=[t,t,s];r.b$(g,g,_),r.b$(f,f,-1),r.cI(f,f,g);const b=r.bz();r.bo(b,b,f),r.cE(b,b,g),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,s,_)}_computeCameraPosition(t){const s=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),_=this.point,g=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*s-t/this.worldSize*this._centerAltitude;return[_.x/this.worldSize-f[0]*g,_.y/this.worldSize-f[1]*g,t/this.worldSize*this._centerAltitude-f[2]*g]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const s=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],_=t[2];let g=1;this.projection.wrap&&(this.center=this.center.wrap()),_>0&&(g=Math.min((s-f)/_,1)),this._camera.position=r.bF([],this._camera.position,t,g),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,s=this._camera.forward(),{pitch:f,bearing:_}=this._camera.getPitchBearing(),g=r.c6(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(r.al(this._maxPitch)),T=Math.max((t[2]-g)/Math.cos(f),b),A=this._zoomFromMercatorZ(T);r.bF(t,t,s,T),this._pitch=r.aD(f,r.al(this.minPitch),r.al(this.maxPitch)),this.angle=r.bX(_,-Math.PI,Math.PI),this._setZoom(r.aD(A,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new r.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let s=0,f=r.cx,_=0,g=1/0;for(;f-s>1e-6&&f>s;){const b=s+.5*(f-s),T=this.tileSize*Math.pow(2,b),A=this.getCameraToCenterDistance(this.projection,b,T),z=this.scaleZoom(A/(t*this.tileSize)),D=Math.abs(b-z);D<g&&(g=D,_=b),b<z?s=b:f=b}return _}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(r.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,s){const f=Math.min(t.x,s.x),_=Math.max(t.x,s.x),g=Math.min(t.y,s.y),b=Math.max(t.y,s.y);if(g<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const T=[new r.P(f,g),new r.P(_,b),new r.P(f,b),new r.P(_,g)],A=this.renderWorldCopies?-3:0,z=this.renderWorldCopies?4:1;for(const D of T){const F=this.pointRayIntersection(D);if(F.t<0)return!0;const O=this.rayIntersectionCoordinate(F);if(O.x<A||O.y<0||O.x>z||O.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+r.cJ(this.fovAboveCenter)>88||this.anyCornerOffEdge(new r.P(0,0),new r.P(this.width,this.height))}zoomDeltaToMovement(t,s){const f=r.ae(r.at([],this._camera.position,t)),_=this._zoomFromMercatorZ(f)+s;return f-this._mercatorZfromZoom(_)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([s,f,_],g){const b=[s,f,_,1];r.aA(b,b,g);const T=b[3]=Math.max(b[3],1e-6);return b[0]/=T,b[1]/=T,b[2]/=T,b}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new r.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new r.P(0,t))}}getCameraToCenterDistance(t,s=this.zoom,f=this.worldSize){const _=r.cA(t,s,this.width,this.height,1024),g=t.pixelSpaceConversion(this.center.lat,f,_);let b=.5/Math.tan(.5*this._fov)*this.height*g;return this.isOrthographic&&(b=r.ai(1,b,r.cO(this.pitch>=xa?1:this.pitch/xa))),b}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&r.az(t,t,this.globeMatrix),t}getFrustum(t){return r.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const hl=(h,t)=>{if(t>0&&h.terrain&&r.w("Cutoff is currently disabled on terrain"),t<=0||h.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const s=h.transform,f=Math.max(Math.abs(s._zoom-(h.minCutoffZoom-1)),1),_=s.isLODDisabled(!1)?r.af(60,45,s.pitch):r.af(30,15,s.pitch),g=s._farZ-s._nearZ,b=t*s.height,T=((1-(A=_))*s.cameraToCenterDistance+A*(s._farZ+b))*f;var A;return{shouldRenderCutoff:_<1,uniformValues:{u_cutoff_params:[s._nearZ,s._farZ,(T-s._nearZ)/g,(T-b-s._nearZ)/g]}}},Qr={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Su{constructor(t,s){this.aabb=t,this.lastCascade=s}}class Eu{add(t,s){const f=this.receivers[t.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],s.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],s.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],s.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],s.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],s.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],s.max[2])):this.receivers[t.key]=new Su(s,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,s,f){const _=r.cV.fromPoints(t.points);let g=0;for(const b in this.receivers){const T=this.receivers[b];if(!T||!_.intersectsAabb(T.aabb))continue;T.aabb.min=_.closestPoint(T.aabb.min),T.aabb.max=_.closestPoint(T.aabb.max);const A=T.aabb.getCorners();for(let z=0;z<f.length;z++){let D=!0;for(const F of A){const O=[F[0]*s,F[1]*s,F[2]];if(r.ad(O,O,f[z].matrix),O[0]<-1||O[0]>1||O[1]<-1||O[1]>1){D=!1;break}}if(T.lastCascade=z,g=Math.max(g,z),D)break}}return g+1}}class Ox{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Eu,this._depthMode=new Ut(t.context.gl.LEQUAL,Ut.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(Qr,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Qr,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Qr,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,s){const f=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!s||!s.properties)return;const _=s.properties.get("shadow-intensity");if(!s.shadowsEnabled()||_<=0||(this._shadowLayerCount=f.style.order.reduce((H,q)=>{const Y=f.style._mergedLayers[q];return H+(Y.hasShadowPass()&&!Y.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const g=f.context,b=Qr.shadowMapResolution,T=Qr.shadowMapResolution;if(this._cascades.length===0||Qr.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let H=0;H<Qr.cascadeCount;++H){const q=f._shadowMapDebug,Y=g.gl,Z=g.createFramebuffer(b,T,q,"texture"),oe=new r.T(g,{width:b,height:T,data:null},Y.DEPTH_COMPONENT16);if(Z.depthAttachment.set(oe.texture),q){const fe=new r.T(g,{width:b,height:T,data:null},Y.RGBA8);Z.colorAttachment.set(fe.texture)}this._cascades.push({framebuffer:Z,texture:oe,matrix:[],far:0,boundingSphereRadius:0,frustum:new r.cn,scale:0})}}this.shadowDirection=sp(s);let A=0;if(t.elevation){const H=t.elevation,q=[1e4,-1e4];H.visibleDemTiles.filter(Y=>Y.dem).forEach(Y=>{const Z=Y.dem.tree;q[0]=Math.min(q[0],Z.minimums[0]),q[1]=Math.max(q[1],Z.maximums[0])}),q[0]!==1e4&&(A=(q[1]-q[0])*H.exaggeration())}const z=1.5*t.cameraToCenterDistance,D=3*z,F=new Float64Array(16);for(let H=0;H<this._cascades.length;++H){const q=this._cascades[H];let Y=t.height/50,Z=1;Qr.cascadeCount===1?Z=D:H===0?Z=z:(Y=z,Z=D);const[oe,fe]=ap(t,this.shadowDirection,Y,Z,Qr.shadowMapResolution,A);q.scale=t.scale,q.matrix=oe,q.boundingSphereRadius=fe,r.bi(F,q.matrix),q.frustum=r.cn.fromInvProjectionMatrix(F,1,0,!0),q.far=Z}const O=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[O].far,this._cascades[O].far],this._uniformValues.u_shadow_intensity=_,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Qr.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Qr.shadowMapResolution,this._uniformValues.u_shadowmap_0=Jr.ShadowMap0,this._uniformValues.u_shadowmap_1=Jr.ShadowMap0+1,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const U=f.transform.elevation;for(const H of this._groundShadowTiles){let q={min:0,max:0};if(U){const Y=U.getMinMaxForTile(H);Y&&(q=Y)}this.addShadowReceiver(H.toUnwrapped(),q.min,q.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,s){if(!this.enabled)return;const f=this.painter,_=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),_.viewport.set([0,0,Qr.shadowMapResolution,Qr.shadowMapResolution]);for(let g=0;g<this._numCascadesToRender;++g){f.currentShadowCascade=g,_.bindFramebuffer.set(this._cascades[g].framebuffer.framebuffer),_.clear({color:r.am.white,depth:1});for(const b of t.order){const T=t._mergedLayers[b];if(!T.hasShadowPass()||T.isHidden(f.transform.zoom))continue;const A=t.getLayerSourceCache(T),z=A?s[A.id]:void 0;(T.type==="model"||z&&z.length)&&f.renderLayer(f,A,T,z)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,s=t.style,f=t.context,_=s.directionalLight,g=s.ambientLight;if(!_||!g)return;const b=[],T=hl(t,t.longestCutoffRange);T.shouldRenderCutoff&&b.push("RENDER_CUTOFF"),b.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&b.push("NORMAL_OFFSET");const A=Es(s,_,g),z=new Ut(f.gl.LEQUAL,Ut.ReadOnly,t.depthRangeFor3D);for(const D of this._groundShadowTiles){const F=D.toUnwrapped(),O=t.isTileAffectedByFog(D),U=t.getOrCreateProgram("groundShadow",{defines:b,overrideFog:O});this.setupShadows(F,U),t.uploadCommonUniforms(f,U,F,null,T);const H={u_matrix:t.transform.calculateProjMatrix(F),u_ground_shadow_factor:A};U.draw(t,f.gl.TRIANGLES,z,sn.disabled,In.multiply,an.disabled,H,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?In.unblended:In.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const s=this.painter.transform,f=s.calculatePosMatrix(t,s.worldSize);return r.az(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(t){return r.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,s,f,_=0){if(!this.enabled)return;const g=this.painter.transform,b=this.painter.context,T=b.gl,A=this._uniformValues,z=new Float64Array(16),D=g.calculatePosMatrix(t,g.worldSize);for(let F=0;F<this._cascades.length;F++)r.az(z,this._cascades[F].matrix,D),A[F===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(z),b.activeTexture.set(T.TEXTURE0+Jr.ShadowMap0+F),this._cascades[F].texture.bind(T.NEAREST,T.CLAMP_TO_EDGE);if(this.useNormalOffset=!!f,this.useNormalOffset){const F=r.cT(t.canonical),O=2/g.tileSize*r.aj/Qr.shadowMapResolution,U=O*this._cascades[0].boundingSphereRadius,H=O*this._cascades[this._cascades.length-1].boundingSphereRadius,q=(f==="vector-tile"?1:3)/Math.pow(2,_-t.canonical.z-(1-g.zoom+Math.floor(g.zoom)));A.u_shadow_normal_offset=[F,U*q,H*q],A.u_shadow_bias=[6e-5,.0012,.012]}else A.u_shadow_bias=[36e-5,.0012,.012];s.setShadowUniformValues(b,A)}setupShadowsFromMatrix(t,s,f=!1){if(!this.enabled)return;const _=this.painter.context,g=_.gl,b=this._uniformValues,T=new Float64Array(16);for(let A=0;A<Qr.cascadeCount;A++)r.az(T,this._cascades[A].matrix,t),b[A===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),_.activeTexture.set(g.TEXTURE0+Jr.ShadowMap0+A),this._cascades[A].texture.bind(g.NEAREST,g.CLAMP_TO_EDGE);if(this.useNormalOffset=f,f){const A=Qr.normalOffset;b.u_shadow_normal_offset=[1,A,A],b.u_shadow_bias=[6e-5,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];s.setShadowUniformValues(_,b)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,s,f,_){if(_[2]>=0)return{};const g=function(A,z,D){const F=D/(1<<A.canonical.z);return new r.cV([A.canonical.x*F+A.wrap*D,A.canonical.y*F+A.wrap*D,0],[(A.canonical.x+1)*F+A.wrap*D,(A.canonical.y+1)*F+A.wrap*D,z])}(t,s,f).getCorners(),b=s/-_[2];_[0]<0?(r.cU(g[0],g[0],[_[0]*b,0,0]),r.cU(g[3],g[3],[_[0]*b,0,0])):_[0]>0&&(r.cU(g[1],g[1],[_[0]*b,0,0]),r.cU(g[2],g[2],[_[0]*b,0,0])),_[1]<0?(r.cU(g[0],g[0],[0,_[1]*b,0]),r.cU(g[1],g[1],[0,_[1]*b,0])):_[1]>0&&(r.cU(g[2],g[2],[0,_[1]*b,0]),r.cU(g[3],g[3],[0,_[1]*b,0]));const T={};return T.vertices=g,T.planes=[Ws(g[1],g[0],g[4]),Ws(g[2],g[1],g[5]),Ws(g[3],g[2],g[6]),Ws(g[0],g[3],g[7])],T}addShadowReceiver(t,s,f){this._receivers.add(t,r.cV.fromTileIdAndHeight(t,s,f))}getMaxCascadeForTile(t){const s=this._receivers.get(t);return s&&s.lastCascade?s.lastCascade:0}}function Ws(h,t,s){const f=r.at([],s,t),_=r.at([],h,t),g=r.bG([],f,_),b=r.ae(g);return b===0?[0,0,1,0]:(r.b$(g,g,1/b),[g[0],g[1],g[2],-r.bE(g,t)])}function sp(h){const t=h.properties.get("direction"),s=r.cR(t.x,t.y,t.z);s[2]=r.aD(s[2],0,75);const f=r.cW([s[0],s[1],s[2]]);return r.cS(f.x,f.y,f.z)}function Es(h,t,s){const f=t.properties.get("color-use-theme")==="none",_=t.properties.get("color"),g=t.properties.get("intensity"),b=t.properties.get("direction"),T=[b.x,b.y,b.z],A=s.properties.get("color-use-theme")==="none",z=s.properties.get("color"),D=s.properties.get("intensity"),F=Math.max(r.bE([0,0,1],T),0),O=[0,0,0];r.b$(O,z.toRenderColor(A?null:h.getLut(t.scope)).toArray01Linear().slice(0,3),D);const U=[0,0,0];return r.b$(U,_.toRenderColor(f?null:h.getLut(s.scope)).toArray01Linear().slice(0,3),F*g),r.cX([O[0]>0?O[0]/(O[0]+U[0]):0,O[1]>0?O[1]/(O[1]+U[1]):0,O[2]>0?O[2]/(O[2]+U[2]):0])}function ap(h,t,s,f,_,g){const b=h.zoom,T=h.scale,A=h.worldSize,z=1/A,D=h.aspect,F=Math.sqrt(1+D*D)*Math.tan(.5*h.fovX),O=F*F,U=f-s,H=f+s;let q,Y;O>U/H?(q=f,Y=f*F):(q=.5*H*(1+O),Y=.5*Math.sqrt(U*U+2*(f*f+s*s)*O+H*H*O*O));const Z=h.projection.pixelsPerMeter(h.center.lat,A),oe=h._camera.getCameraToWorldMercator(),fe=[0,0,-q*z];r.ad(fe,fe,oe);let me=Y*z;const xe=h._edgeInsets;if(!(xe.left===0&&xe.top===0&&xe.right===0&&xe.bottom===0||xe.left===xe.right&&xe.top===xe.bottom)){const dt=h._camera.getWorldToCamera(h.worldSize,h.projection.zAxisUnit==="meters"?Z:1),st=h._camera.getCameraToClipPerspective(h._fov,h.width/h.height,s,f);st[8]=2*-h.centerOffset.x/h.width,st[9]=2*h.centerOffset.y/h.height;const pt=new Float64Array(16);r.cB(pt,st,dt);const mt=new Float64Array(16);r.bi(mt,pt);const Vt=r.cn.fromInvProjectionMatrix(mt,A,b,!0);for(const Xt of Vt.points){const Bt=((ye=Xt)[0]/=T,ye[1]/=T,ye[2]=r.c6(ye[2],h._center.lat),ye);me=Math.max(me,r.c0(r.cY([],fe,Bt)))}}var ye;me*=_/(_-1);const ve=Math.acos(t[2]),_e=Math.atan2(-t[0],-t[1]),we=new Gr;we.position=fe,we.setPitchBearing(ve,_e);const Te=we.getWorldToCamera(A,Z),Ue=me*A,Fe=Math.min(h._mercatorZfromZoom(17)*A*-2,-2*Ue),ot=we.getCameraToClipOrthographic(-Ue,Ue,-Ue,Ue,Fe,(Ue+g*Z)/t[2]),et=new Float64Array(16);r.az(et,ot,Te);const xt=r.cS(Math.floor(1e6*fe[0])/1e6*A,Math.floor(1e6*fe[1])/1e6*A,0),Oe=.5*_,je=[0,0,0];r.ad(je,xt,et),r.b$(je,je,Oe);const Le=[Math.floor(je[0]),Math.floor(je[1]),Math.floor(je[2])],lt=[0,0,0];r.at(lt,je,Le),r.b$(lt,lt,-1/Oe);const Ze=new Float64Array(16);return r.bx(Ze),r.bo(Ze,Ze,lt),r.az(et,Ze,et),[et,Ue]}class ba extends r.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,s){return r.aS(this.requestManager.transformRequest(s,r.R.Model).url).then(f=>{if(!f)return;const _=r.aT(f),g=new r.aU(t,void 0,void 0,_);return g.computeBoundsAndApplyParent(),g}).catch(f=>{if(f&&f.status===404)return null;this.fire(new r.z(new Error(`Could not load model ${t} from ${s}: ${f.message}`)))})}load(t,s,f={forceReload:!1}){this.models[s]||(this.models[s]={});const _=Object.keys(t),g=[],b=[];for(const T of _){const A=t[T];this.hasURLBeenRequested(A)&&!f.forceReload||(this.modelByURL[A]={modelId:T,scope:s},g.push(this.loadModel(T,A)),b.push(T)),this.models[s][T]||(this.models[s][T]={model:null,numReferences:1})}this.numModelsLoading[s]=(this.numModelsLoading[s]||0)+b.length,Promise.allSettled(g).then(T=>{for(let A=0;A<T.length;A++){const{status:z}=T[A];if(z==="rejected")continue;const{value:D}=T[A];this.models[s][b[A]]||(this.models[s][b[A]]={model:null,numReferences:1}),this.models[s][b[A]].model=D}this.numModelsLoading[s]-=b.length,this.fire(new r.A("data",{dataType:"style"}))}).catch(T=>{this.fire(new r.z(new Error(`Could not load models: ${T.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,s,f={exactIdMatch:!1}){return!!(f.exactIdMatch?this.getModel(t,s):this.getModelByURL(this.modelUris[s][t]))}getModel(t,s){return this.models[s]||(this.models[s]={}),this.models[s][t]?this.models[s][t].model:void 0}getModelByURL(t){if(!t)return null;const s=this.modelByURL[t];return s?this.models[s.scope][s.modelId].model:null}hasModelBeenAdded(t,s){return this.models[s]&&this.models[s][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,s,f){this.models[f]||(this.models[f]={}),this.modelUris[f]||(this.modelUris[f]={});const _=this.requestManager.normalizeModelURL(s);if((this.hasModel(t,f,{exactIdMatch:!0})||this.hasModelBeenAdded(t,f))&&this.modelUris[f][t]===_)this.models[f][t].numReferences++;else if(this.hasURLBeenRequested(_)){const{scope:g,modelId:b}=this.modelByURL[_];this.models[g][b].numReferences++}else this.modelUris[f][t]=_,this.load({[t]:this.modelUris[f][t]},f)}addModelURLs(t,s){this.models[s]||(this.models[s]={}),this.modelUris[s]||(this.modelUris[s]={});const f=this.modelUris[s];for(const _ in t)f[_]=this.requestManager.normalizeModelURL(t[_])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,s){this.models[s]||(this.models[s]={}),this.modelUris[s]||(this.modelUris[s]={});const f={};for(const _ of t)this.hasModel(_,s,{exactIdMatch:!0})||this.hasURLBeenRequested(_)?this.models[s][_].numReferences++:this.modelUris[s][_]&&!this.hasURLBeenRequested(_)?f[_]=this.modelUris[s][_]:!this.hasURLBeenRequested(_)&&r.cZ(_,!1)&&(this.modelUris[s][_]=this.requestManager.normalizeModelURL(_),f[_]=this.modelUris[s][_]);this.load(f,s)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,s,f=!1){if(this.models[s]&&this.models[s][t]&&(this.models[s][t].numReferences--,this.models[s][t].numReferences===0)){const _=this.modelUris[s][t];f||delete this.modelUris[s][t],delete this.modelByURL[_];const g=this.models[s][t].model;if(!g)return;delete this.models[s][t],g.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const s of Object.keys(this.models[t])){const f=this.models[t][s].model;delete this.models[t][s],f&&f.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,s){this.models[s]||(this.models[s]={});for(const f in this.models[s])this.models[s][f].model&&this.models[s][f].model.upload(t.context)}}const Fx=new r.a7({data:new r.a8(r.a5.colorTheme.data)}),Bx={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function og(h){return h=h||{},Object.assign(h,Bx)}class sg extends r.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},r.aV(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new r.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(t){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(b,T){const[A,z]=b,{center:D,radius:F}=T,[O,U]=D,H=Math.abs(A-O);return Math.sqrt((H>180?360-H:H)**2+(z-U)**2)<=F}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new r.A("floorplangone")));const s={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},f=new r.P(this._map.transform.width/2,this._map.transform.height/2),_=[new r.P(0,0),new r.P(this._map.transform.width,this._map.transform.height)],g=this._map.queryRenderedFeatures(t?_:f,s);g.length>0&&(this._selectedFloorplan&&g[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=g[0],this._floorplanSelected(!1)))}_floorplanSelected(t){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(g){const[[b,T],[A,z]]=g,D=(A-b+360)%360,F=D>180?360-D:D;return{center:[(b+F/2+360)%360,(T+z)/2],radius:Math.sqrt(F**2+(z-T)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const s=this._floorplanStates[this._indoorData.id].selectedBuilding,f=this._floorplanStates[this._indoorData.id].selectedLevel;let _;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const g of this._indoorData.levels)g.id===this._selectedLevel.id&&(_=g.id);if(this.fire(new r.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:_})),s){const g=this._indoorData.buildings.find(b=>b.id===s);this._buildingSelected(g,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(f){const g=this._indoorData.levels.find(b=>b.id===f);this._updateLevels(g,t)}else t&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(t,s){s&&t&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;const f=this._indoorData.levels.filter(_=>t.levels.includes(_.id));this.fire(new r.A("buildingselected",{buildingId:t.id,levels:f}))}_levelSelected(t){if(t==="overview")this._updateLevels(void 0,!0);else{const s=this._indoorData.levels.find(f=>f.id===t);this._updateLevels(s,!0)}this.fire(new r.A("levelselected",{levelId:t==="overview"?void 0:t}))}_updateLevels(t,s){if(!t)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(s&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function f(z){const D=z.indexOf("/floor/");if(D===-1)return z;const F=D+7,O=z.indexOf("/",F);return O===-1?z.slice(F):z.slice(F,O)}this._selectedLevel=t,this._floorplanStates[this._indoorData.id].selectedLevel=t?t.id:void 0;const _=[],g={},b={},T={},A={};for(const z of this._indoorData.levels)if(_.push(z.id),g[z.id]=z.height,b[z.id]=z.base,t){if(this.mergeFloors){const D=f(t.id),F=f(z.id);T[z.id]=F===D?"true":"false"}else T[z.id]=z.id===t.id?"true":"false";A[z.id]=z.base<t.base?"true":"false"}else A[z.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",_]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",g]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",b]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",T]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",A]),t&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!t.isUnderground),s&&t.extent)){const z=this._map.cameraForBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),D=this._map.getZoom(),F=z.zoom?Math.abs(D-z.zoom):0;this._map.fitBounds(t.extent,F>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:D})}}selectFloorplan(t){const s={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},f=[new r.P(0,0),new r.P(this._map.transform.width,this._map.transform.height)],_=this._map.queryRenderedFeatures(f,s);if(_.length>0){for(const g of _)if(JSON.parse(g.properties["indoor-data"]).floorplanIDs.includes(t)){this._selectedFloorplan=g,this._floorplanSelected(!0);break}}}selectBuilding(t){const s=this._indoorData.buildings.find(f=>f.id===t);this._buildingSelected(s,!0)}selectLevel(t){this._levelSelected(t)}}function Nx(h){if(!h.metadata||!h.metadata.content_area)return;const t=r.q.devicePixelRatio,{left:s,top:f,width:_,height:g}=h.metadata.content_area,b=s*t,T=f*t;return[b,T,b+_*t,T+g*t]}function Jh(h){if(h)return h.map(([t,s])=>[t*r.q.devicePixelRatio,s*r.q.devicePixelRatio])}class ag{constructor(t,s,f){this.id=t,this.scope=s,this.sourceCache=f,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const s=this.sourceCache.getVisibleCoordinates();if(s.length===0)return t;const f=this.sourceCache.getSource();if(!(f instanceof nl))return t;const _=s.map(b=>this.sourceCache.getTile(b)),g=f.getImages(_,Array.from(this.pendingRequests));for(const[b,T]of g)t.set(r.I.from({name:b,iconsetId:this.id}),T),this.pendingRequests.delete(b);for(const b of this.pendingRequests)this.missingRequests.add(b);return this.pendingRequests.clear(),t}}const wa=(h,t)=>ze(h,t&&t.filter(s=>s.identifier!=="source.canvas")),lg=r.aF(Hn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),cg=r.aF(Hn,["setCenter","setZoom","setBearing","setPitch"]),Xs=new Set(["background","sky","slot","custom"]),Au={version:8,layers:[],sources:{}},lp={duration:300,delay:0};class Wo extends r.E{constructor(t,s={}){super(),this.map=t,this.scope=s.scope||"",this.globalId=null,this.fragments=[],this.importDepth=s.importDepth||0,this.importsCache=s.importsCache||new Map,this.resolvedImports=s.resolvedImports||new Set,this.transition=r.l({},lp),this._buildingIndex=new K_(this),this.crossTileSymbolIndex=new vr,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=s.styleChanges||new dn,this.dispatcher=s.dispatcher?s.dispatcher:new r.D(r.d0(),this),s.imageManager?this.imageManager=s.imageManager:(this.imageManager=new Qi(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=s.glyphManager?s.glyphManager:new r.d1(t._requestManager,s.localFontFamily?r.d2.all:s.localIdeographFontFamily?r.d2.ideographs:r.d2.none,s.localFontFamily||s.localIdeographFontFamily),s.modelManager?this.modelManager=s.modelManager:(this.modelManager=new ba(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=s.configOptions?s.configOptions:new Map,this._configDependentLayers=s.configDependentLayers?s.configDependentLayers:new Set,this._config=s.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:s.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=s.initialConfig,this.dispatcher.broadcast("setReferrer",r.d3());const f=this;this._rtlTextPluginCallback=Wo.registerForPluginStateChange(_=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:_.pluginStatus,pluginURL:_.pluginURL},(g,b)=>{if(r.d4(g),b&&b.every(T=>T))for(const T in f._sourceCaches){const A=f._sourceCaches[T],z=A.getSource().type;z!=="vector"&&z!=="geojson"||A.reload()}})}),this.on("data",_=>{if(_.dataType!=="source"||_.sourceDataType!=="metadata")return;const g=this.getOwnSource(_.sourceId);if(g&&g.vectorLayerIds)for(const b in this._layers){const T=this._layers[b];T.source===g.id&&this._validateLayer(T)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(r.f(t))return t;const s=r.d5(t);if(!s.startsWith("http"))try{return new URL(s,location.href).toString()}catch{return s}return s}return`json://${r.d6(JSON.stringify(t))}`}_diffStyle(t,s,f){this.globalId=this._getGlobalId(t);const _=(g,b)=>{try{b(null,this.setState(g,f))}catch(T){b(T,!1)}};if(typeof t=="string"){const g=this.map._requestManager.normalizeStyleURL(t),b=this.map._requestManager.transformRequest(g,r.R.Style);r.n(b,(T,A)=>{T?this.fire(new r.z(T)):A&&_(A,s)})}else typeof t=="object"&&_(t,s)}loadURL(t,s={}){this.fire(new r.A("dataloading",{dataType:"style"}));const f=typeof s.validate=="boolean"?s.validate:!r.f(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,s.accessToken),this.resolvedImports.add(t);const _=this.importsCache.get(t);if(_)return this._load(_,f);const g=this.map._requestManager.transformRequest(t,r.R.Style);this._request=r.n(g,(b,T)=>{if(this._request=null,b)this.fire(new r.z(b));else if(T)return this.importsCache.set(t,T),this._load(T,f)})}loadJSON(t,s={}){this.fire(new r.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=r.q.frame(()=>{this._request=null,this._load(t,s.validate!==!1)})}loadEmpty(){this.fire(new r.A("dataloading",{dataType:"style"})),this._load(Au,!1)}_loadImports(t,s,f){if(this.importDepth>=4)return r.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const _=[];for(const g of t){const b=this._createFragmentStyle(g),T=new Promise(D=>{b.once("style.import.load",D),b.once("error",D)}).then(()=>this.mergeAll());if(_.push(T),this.resolvedImports.has(g.url)){b.loadEmpty();continue}const A=g.data||this.importsCache.get(g.url);A?(b.loadJSON(A,{validate:s}),this._isInternalStyle(A)&&(b.globalId=null)):g.url?b.loadURL(g.url,{validate:s}):b.loadEmpty();const z={style:b,id:g.id,config:g.config};if(f){const D=this.fragments.findIndex(({id:F})=>F===f);this.fragments=this.fragments.slice(0,D).concat(z).concat(this.fragments.slice(D))}else this.fragments.push(z)}return Promise.allSettled(_)}getImportGlobalIds(t=this,s=new Set){for(const f of t.fragments)f.style.globalId&&s.add(f.style.globalId),this.getImportGlobalIds(f.style,s);return[...s.values()]}_createFragmentStyle(t){const s=this.scope?r.C(t.id,this.scope):t.id;let f;const _=this._initialConfig&&this._initialConfig[s];(t.config||_)&&(f=r.l({},t.config,_));const g=new Wo(this.map,{scope:s,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return g.setEventedParent(this.map,{style:g}),g}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,s){const f=t.indoor?og(t.schema):t.schema;if(this._isInternalStyle(t)){const b=r.l({},Au,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(b,s)}if(this.updateConfig(this._config,f),s&&wa(this,qo(t)))return;this._loaded=!0,this.stylesheet=r.d7(t);const _=()=>{for(const z in t.sources)this.addSource(z,t.sources[z],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const z in t.iconsets)this.addIconset(z,t.iconsets[z]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(t.glyphs);const b=Gh(this.stylesheet.layers);if(this._order=b.map(z=>z.id),this.stylesheet.light&&r.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const z=this.stylesheet.lights[0];this.light=new He(z.properties,z.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new He(this.stylesheet.light)),this._layers={};for(const z of b){const D=r.dc(z,this.scope,this._styleColorTheme.lut,this.options);D.configDependencies.size!==0&&this._configDependentLayers.add(D.fqid),D.setEventedParent(this,{layer:{id:D.id}}),this._layers[D.id]=D;const F=this.getOwnLayerSourceCache(D),O=!!this.directionalLight&&this.directionalLight.shadowsEnabled();F&&D.canCastShadows()&&O&&(F.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const T=this.stylesheet.terrain;T&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(T,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new r.A("data",{dataType:"style"}));const A=this.isRootStyle();t.imports?this._loadImports(t.imports,s).then(()=>{this._reloadImports(),this.fire(new r.A(A?"style.load":"style.import.load"))}).catch(z=>{this.fire(new r.z(new Error("Failed to load imports",z))),this.fire(new r.A(A?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new r.A(A?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const g=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(g){const b=this._evaluateColorThemeData(g);this._loadColorTheme(b).then(()=>{_()}).catch(T=>{r.w(`Couldn't load color theme from the stylesheet: ${T}`),_()})}else this._styleColorTheme.lut=null,_()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,s,f,_,g,b,T,A,z,D;const F={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(O=>{if(O.stylesheet){if(O.light!=null&&(t=O.light),O.stylesheet.lights)for(const U of O.stylesheet.lights)U.type==="ambient"&&O.ambientLight!=null&&(s=O.ambientLight),U.type==="directional"&&O.directionalLight!=null&&(f=O.directionalLight);_=this._prioritizeTerrain(_,O.terrain,O.stylesheet.terrain),O.stylesheet.fog&&O.fog!=null&&(g=O.fog),O.stylesheet.snow&&O.snow!=null&&(b=O.snow),O.stylesheet.rain&&O.rain!=null&&(T=O.rain),O.stylesheet.camera!=null&&(D=O.stylesheet.camera),O.stylesheet.projection!=null&&(A=O.stylesheet.projection),O.stylesheet.transition!=null&&(z=O.stylesheet.transition),F[O.scope]=O._styleColorTheme}}),this.light=t,this.ambientLight=s,this.directionalLight=f,this.fog=g,this.snow=b,this.rain=T,this._styleColorThemeForScope=F,_===null?delete this.terrain:this.terrain=_,this.camera=D||{"camera-projection":"perspective"},this.projection=A||{name:"mercator"},this.transition=r.l({},lp,z),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const s=f=>{for(const _ of f.fragments)s(_.style);t(f)};s(this)}_prioritizeTerrain(t,s,f){const _=t&&t.drapeRenderMode===0;return f===null?s&&s.drapeRenderMode===0?s:_?t:null:s!=null&&(!t||_||s&&s.drapeRenderMode===1)?s:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(s=>{t=this._prioritizeTerrain(t,s.terrain,s.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(s=>{s.stylesheet.projection!=null&&(t=s.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},s={},f={};this.forEachFragmentStyle(_=>{for(const g in _._sourceCaches){const b=r.C(g,_.scope);t[b]=_._sourceCaches[g]}for(const g in _._otherSourceCaches){const b=r.C(g,_.scope);s[b]=_._otherSourceCaches[g]}for(const g in _._symbolSourceCaches){const b=r.C(g,_.scope);f[b]=_._symbolSourceCaches[g]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=s,this._mergedSymbolSourceCaches=f}mergeLayers(){const t={},s=[],f={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(g=>{for(const b of g._order){const T=g._layers[b];if(T.type==="slot"){const A=r.d8(b);if(t[A])continue;t[A]=[]}T.slot&&t[T.slot]?t[T.slot].push(T):s.push(T)}}),this._mergedOrder=[];const _=(g=[])=>{for(const b of g)if(b.type==="slot"){const T=r.d8(b.id);t[T]&&_(t[T]),this._mergedSlots.push(T)}else{const T=r.C(b.id,b.scope);this._mergedOrder.push(T),f[T]=b,b.is3D(!!this.terrain)&&(this._has3DLayers=!0),b.type==="circle"&&(this._hasCircleLayers=!0),b.type==="symbol"&&(this._hasSymbolLayers=!0),b.type==="clip"&&(this._clipLayerPresent=!0)}};_(s),this._mergedOrder.sort((g,b)=>{const T=f[g],A=f[b];return T.hasInitialOcclusionOpacityProperties?A.is3D(!!this.terrain)?1:0:T.is3D(!!this.terrain)&&A.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=r.l({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(s,f,_){const g=r.l({},f);for(const T of Object.keys(r.a5.colorTheme))g[T]===void 0&&(g[T]=r.a5.colorTheme[T].default);const b=new r.a6(Fx,s,new Map(_));return b.setTransitionOrValue(g,_),b.untransitioned().possiblyEvaluate(new r.aa(0))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const s=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((f,_)=>{const g="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void f();let b=t;b.startsWith(g)||(b=g+b);const T=r.I.from("mapbox-reserved-lut"),A=new Image;A.src=b,A.onerror=()=>{this._styleColorTheme.lutLoading=!1,_(new Error("Failed to load image data"))},A.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==s)return void f();this._styleColorTheme.lutLoading=!1;const{width:z,height:D,data:F}=r.q.getImageData(A);if(D>32)return void _(new Error("The height of the image must be less than or equal to 32 pixels."));if(z!==D*D)return void _(new Error("The width of the image must be equal to the height squared."));this.getImage(T)&&this.removeImage(T),this.addImage(T,{data:new r.r({width:z,height:D},F),pixelRatio:1,sdf:!1,usvg:!1,version:0});const O=this.imageManager.getImage(T,this.scope);O?(this._styleColorTheme.lut={image:O.data,data:t},f()):_(new Error("Missing LUT image."))}})}getLut(t){const s=this._styleColorThemeForScope[t];return s?s.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(s,f,_){let g,b,T;const A=r.q.devicePixelRatio>1?"@2x":"";let z=r.n(f.transformRequest(f.normalizeSpriteURL(s,A,".json"),r.R.SpriteJSON),(O,U)=>{z=null,T||(T=O,g=U,F())}),D=r.o(f.transformRequest(f.normalizeSpriteURL(s,A,".png"),r.R.SpriteImage),(O,U)=>{D=null,T||(T=O,b=U,F())});function F(){if(T)_(T);else if(g&&b){const O=r.q.getImageData(b),U={};for(const H in g){const{width:q,height:Y,x:Z,y:oe,sdf:fe,pixelRatio:me,stretchX:xe,stretchY:ye,content:ve}=g[H],_e=new r.r({width:q,height:Y});r.r.copy(O,_e,{x:Z,y:oe},{x:0,y:0},{width:q,height:Y},null),U[H]={data:_e,pixelRatio:me,sdf:fe,stretchX:xe,stretchY:ye,content:ve,usvg:!1}}_(null,U)}}return{cancel(){z&&(z.cancel(),z=null),D&&(D.cancel(),D=null)}}}(t,this.map._requestManager,(s,f)=>{if(this._spriteRequest=null,s)this.fire(new r.z(s));else if(f){const _=new Map;for(const g in f)_.set(r.I.from(g),f[g]);this.addImages(_)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))})}addIconset(t,s){if(s.type==="sprite")return void this._loadSprite(s.url);const f=this.getOwnSourceCache(s.source);if(!f)return void this.fire(new r.z(new Error(`Source "${s.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const _=f.getSource();if(_.type!=="raster-array")return void this.fire(new r.z(new Error(`Source "${s.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));_.partial=!1;const g=new ag(t,this.scope,f);this.imageManager.addImageProvider(g,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!r.f(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const s=this.map._spriteFormat==="auto";var f,_;this._spriteRequest=(_=(g,b)=>{if(this._spriteRequest=null,g)s?this._loadSprite(t):this.fire(new r.z(g));else if(b){const T=new Map;for(const A in b)T.set(r.I.from(A),b[A]);this.addImages(T)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.A("data",{dataType:"style"}))},r.br((f=this.map._requestManager).transformRequest(f.normalizeIconsetURL(t),r.R.Iconset),(g,b)=>{if(g)return void _(g);const T={},A=r.c_(new r.bq(b));for(const z of A.icons){const D={version:1,pixelRatio:r.q.devicePixelRatio,content:Nx(z),stretchX:z.metadata?Jh(z.metadata.stretch_x_areas):void 0,stretchY:z.metadata?Jh(z.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:z};T[z.name]=D}_(null,T)}))}_validateLayer(t){const s=this.getOwnSource(t.source);if(!s)return;const f=t.sourceLayer;f&&(s.type==="geojson"||s.vectorLayerIds&&s.vectorLayerIds.indexOf(f)===-1)&&this.fire(new r.z(new Error(`Source layer "${f}" does not exist on source "${s.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,s)=>{const f=this.fragments[s];return f&&f.style&&(t.data=f.style.serialize()),t})}_serializeSources(){const t={};for(const s in this._sourceCaches){const f=this._sourceCaches[s].getSource();t[f.id]||(t[f.id]=f.serialize())}return t}_serializeLayers(t){const s=[];for(const f of t){const _=this._layers[f];_&&_.type!=="custom"&&s.push(_.serialize())}return s}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const s=this.getOwnLayer(t);if(s)return s;this.fire(new r.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const s=this.getOwnSource(t);if(s)return s;this.fire(new r.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,s){const f=this.map.painter;if(f)for(let _=t.minzoom||0;_<(t.maxzoom||25.5);_++){const g=t.getProgramIds();if(g)for(const b of g){const T=t.getDefaultProgramParams(b,s.zoom,this._styleColorTheme.lut);T&&(f.style=this,this.fog&&(f._fogVisible=!0,T.overrideFog=!0,f.getOrCreateProgram(b,T)),f._fogVisible=!1,T.overrideFog=!1,f.getOrCreateProgram(b,T),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(T.overrideRtt=!0,f.getOrCreateProgram(b,T)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const s=this.calculateLightsBrightness();t.brightness=s||0,s!==this._brightness&&(this._brightness=s,this.dispatcher.broadcast("setBrightness",s));const f=this._changes.isDirty();let _=!1;if(this._changes.isDirty()){const T=this._changes.getLayerUpdatesByScope();for(const A in T){const{updatedIds:z,removedIds:D}=T[A];(z||D)&&(this._updateWorkerLayers(A,z,D),_=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const g={};for(const T in this._mergedSourceCaches){const A=this._mergedSourceCaches[T];g[T]=A.used,A.used=!1,A.tileCoverLift=0}for(const T of this._mergedOrder){const A=this._mergedLayers[T];if(A.recalculate(t,this._availableImages),!A.isHidden(t.zoom)){const z=this.getLayerSourceCache(A);z&&(z.used=!0,z.tileCoverLift=Math.max(z.tileCoverLift,A.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(A,t)}):this.precompilePrograms(A,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&_&&this.mergeLayers();const b=this.imageManager.getPendingImageProviders();for(const T of b)T.sourceCache.used=!0;for(const T in g){const A=this._mergedSourceCaches[T];g[T]!==A.used&&A.getSource().fire(new r.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:A.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),f&&this.fire(new r.A("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const s of t){const f=s.resolvePendingRequests(),_=this.getFragmentStyle(s.scope);_&&_.addImages(f)}}_updateTilesForChangedImages(){const t={};for(const s in this._mergedSourceCaches){const f=this._mergedSourceCaches[s].getSource().scope;t[f]=t[f]||this._changes.getUpdatedImages(f),t[f].length!==0&&this._mergedSourceCaches[s].reloadTilesForDependencies(["icons","patterns"],t[f])}for(const s in t)this._changes.resetUpdatedImages(s)}_updateWorkerLayers(t,s,f){const _=this.getFragmentStyle(t);_&&this.dispatcher.broadcast("updateLayers",{layers:s?_._serializeLayers(s):[],scope:t,removedIds:f||[],options:_.options})}setState(t,s){if(this._checkLoaded(),wa(this,qo(t)))return!1;(t=r.d7(t)).layers=Gh(t.layers);const f=function(b,T){if(!b)return[{command:Hn.setStyle,args:[T]}];let A=[];try{if(!r.bv(b.version,T.version))return[{command:Hn.setStyle,args:[T]}];if(r.bv(b.center,T.center)||A.push({command:Hn.setCenter,args:[T.center]}),r.bv(b.zoom,T.zoom)||A.push({command:Hn.setZoom,args:[T.zoom]}),r.bv(b.bearing,T.bearing)||A.push({command:Hn.setBearing,args:[T.bearing]}),r.bv(b.pitch,T.pitch)||A.push({command:Hn.setPitch,args:[T.pitch]}),r.bv(b.sprite,T.sprite)||A.push({command:Hn.setSprite,args:[T.sprite]}),r.bv(b.glyphs,T.glyphs)||A.push({command:Hn.setGlyphs,args:[T.glyphs]}),r.bv(b.imports,T.imports)||function(U=[],H=[],q){H=H||[];const Y=(U=U||[]).map(ma),Z=H.map(ma),oe=U.reduce(tc,{}),fe=H.reduce(tc,{}),me=Y.slice();let xe,ye,ve,_e;for(xe=0,ye=0;xe<Y.length;xe++)ve=Y[xe],fe.hasOwnProperty(ve)?ye++:(q.push({command:Hn.removeImport,args:[ve]}),me.splice(me.indexOf(ve,ye),1));for(xe=0,ye=0;xe<Z.length;xe++)ve=Z[Z.length-1-xe],me[me.length-1-xe]!==ve&&(oe.hasOwnProperty(ve)?(q.push({command:Hn.removeImport,args:[ve]}),me.splice(me.lastIndexOf(ve,me.length-ye),1)):ye++,_e=me[me.length-xe],q.push({command:Hn.addImport,args:[fe[ve],_e]}),me.splice(me.length-xe,0,ve));for(const we of H){const Te=oe[we.id];Te&&!r.bv(Te,we)&&q.push({command:Hn.updateImport,args:[we.id,we]})}}(b.imports,T.imports,A),r.bv(b.transition,T.transition)||A.push({command:Hn.setTransition,args:[T.transition]}),r.bv(b.light,T.light)||A.push({command:Hn.setLight,args:[T.light]}),r.bv(b.fog,T.fog)||A.push({command:Hn.setFog,args:[T.fog]}),r.bv(b.snow,T.snow)||A.push({command:Hn.setSnow,args:[T.snow]}),r.bv(b.rain,T.rain)||A.push({command:Hn.setRain,args:[T.rain]}),r.bv(b.projection,T.projection)||A.push({command:Hn.setProjection,args:[T.projection]}),r.bv(b.lights,T.lights)||A.push({command:Hn.setLights,args:[T.lights]}),r.bv(b.camera,T.camera)||A.push({command:Hn.setCamera,args:[T.camera]}),r.bv(b.iconsets,T.iconsets)||function(U,H,q){let Y;for(Y in H=H||{},U=U||{})U.hasOwnProperty(Y)&&(H.hasOwnProperty(Y)||q.push({command:Hn.removeIconset,args:[Y]}));for(Y in H){if(!H.hasOwnProperty(Y))continue;const Z=H[Y];U.hasOwnProperty(Y)?r.bv(U[Y],Z)||(q.push({command:Hn.removeIconset,args:[Y]}),q.push({command:Hn.addIconset,args:[Y,Z]})):q.push({command:Hn.addIconset,args:[Y,Z]})}}(b.iconsets,T.iconsets,A),!r.bv(b["color-theme"],T["color-theme"]))return[{command:Hn.setStyle,args:[T]}];const z={},D=[];(function(U,H,q,Y){let Z;for(Z in H=H||{},U=U||{})U.hasOwnProperty(Z)&&(H.hasOwnProperty(Z)||ec(Z,q,Y));for(Z in H){if(!H.hasOwnProperty(Z))continue;const oe=H[Z];U.hasOwnProperty(Z)?r.bv(U[Z],oe)||(U[Z].type==="geojson"&&oe.type==="geojson"&&J_(U,H,Z)?q.push({command:Hn.setGeoJSONSourceData,args:[Z,oe.data]}):Lx(Z,H,q,Y)):Ql(Z,H,q)}})(b.sources,T.sources,D,z);const F=[];b.layers&&b.layers.forEach(U=>{U.source&&z[U.source]?A.push({command:Hn.removeLayer,args:[U.id]}):F.push(U)});let O=b.terrain;O&&z[O.source]&&(A.push({command:Hn.setTerrain,args:[void 0]}),O=void 0),A=A.concat(D),r.bv(O,T.terrain)||A.push({command:Hn.setTerrain,args:[T.terrain]}),function(U,H,q){H=H||[];const Y=(U=U||[]).map(ma),Z=H.map(ma),oe=U.reduce(tc,{}),fe=H.reduce(tc,{}),me=Y.slice(),xe=Object.create(null);let ye,ve,_e,we,Te,Ue,Fe;for(ye=0,ve=0;ye<Y.length;ye++)_e=Y[ye],fe.hasOwnProperty(_e)?ve++:(q.push({command:Hn.removeLayer,args:[_e]}),me.splice(me.indexOf(_e,ve),1));for(ye=0,ve=0;ye<Z.length;ye++)_e=Z[Z.length-1-ye],me[me.length-1-ye]!==_e&&(oe.hasOwnProperty(_e)?(q.push({command:Hn.removeLayer,args:[_e]}),me.splice(me.lastIndexOf(_e,me.length-ve),1)):ve++,Ue=me[me.length-ye],q.push({command:Hn.addLayer,args:[fe[_e],Ue]}),me.splice(me.length-ye,0,_e),xe[_e]=!0);for(ye=0;ye<Z.length;ye++)if(_e=Z[ye],we=oe[_e],Te=fe[_e],!xe[_e]&&!r.bv(we,Te))if(r.bv(we.source,Te.source)&&r.bv(we["source-layer"],Te["source-layer"])&&r.bv(we.type,Te.type)){for(Fe in rl(we.layout,Te.layout,q,_e,null,Hn.setLayoutProperty),rl(we.paint,Te.paint,q,_e,null,Hn.setPaintProperty),r.bv(we.slot,Te.slot)||q.push({command:Hn.setSlot,args:[_e,Te.slot]}),r.bv(we.filter,Te.filter)||q.push({command:Hn.setFilter,args:[_e,Te.filter]}),r.bv(we.minzoom,Te.minzoom)&&r.bv(we.maxzoom,Te.maxzoom)||q.push({command:Hn.setLayerZoomRange,args:[_e,Te.minzoom,Te.maxzoom]}),we)we.hasOwnProperty(Fe)&&Fe!=="layout"&&Fe!=="paint"&&Fe!=="filter"&&Fe!=="metadata"&&Fe!=="minzoom"&&Fe!=="maxzoom"&&Fe!=="slot"&&(Fe.indexOf("paint.")===0?rl(we[Fe],Te[Fe],q,_e,Fe.slice(6),Hn.setPaintProperty):r.bv(we[Fe],Te[Fe])||q.push({command:Hn.setLayerProperty,args:[_e,Fe,Te[Fe]]}));for(Fe in Te)Te.hasOwnProperty(Fe)&&!we.hasOwnProperty(Fe)&&Fe!=="layout"&&Fe!=="paint"&&Fe!=="filter"&&Fe!=="metadata"&&Fe!=="minzoom"&&Fe!=="maxzoom"&&Fe!=="slot"&&(Fe.indexOf("paint.")===0?rl(we[Fe],Te[Fe],q,_e,Fe.slice(6),Hn.setPaintProperty):r.bv(we[Fe],Te[Fe])||q.push({command:Hn.setLayerProperty,args:[_e,Fe,Te[Fe]]}))}else q.push({command:Hn.removeLayer,args:[_e]}),Ue=me[me.lastIndexOf(_e)+1],q.push({command:Hn.addLayer,args:[Te,Ue]})}(F,T.layers,A)}catch(z){console.warn("Unable to compute style diff:",z),A=[{command:Hn.setStyle,args:[T]}]}return A}(this.serialize(),t).filter(b=>!(b.command in cg));if(f.length===0)return!1;const _=f.filter(b=>!(b.command in lg));if(_.length>0)throw new Error(`Unimplemented: ${_.map(b=>b.command).join(", ")}.`);const g=[];return f.forEach(b=>{g.push(this[b.command](...b.args))}),s&&Promise.all(g).then(s).catch(s),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){for(const[s,f]of t.entries()){if(this.getImage(s))return this.fire(new r.z(new Error(`An image with the name "${s.name}" already exists.`)));this.imageManager.addImage(s,this.scope,f),this._changes.updateImage(s,this.scope)}return this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this}addImage(t,s){return this.getImage(t)?this.fire(new r.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,s),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this)}updateImage(t,s,f=!1){this.imageManager.updateImage(t,this.scope,s),f&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new r.A("data",{dataType:"style"})),this}addModel(t,s,f={}){return this._checkLoaded(),this._validate(Se,`models.${t}`,s,null,f)||(this.modelManager.addModel(t,s,this.scope),this.fire(new r.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this.fire(new r.A("data",{dataType:"style"})),this):this.fire(new r.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,s,f={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!s.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(s).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(s.type)>=0&&this._validate(cu,`sources.${t}`,s,null,f))return;this.map&&this.map._collectResourceTiming&&(s.collectResourceTiming=!0);const _=Kl(t,s,this.dispatcher,this);_.scope=this.scope,_.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(_.id),source:_.serialize(),sourceId:_.id}));const g=b=>{const T=(b?"symbol:":"other:")+_.id,A=r.C(T,this.scope),z=this._sourceCaches[T]=new Wr(A,_,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[_.id]=z,z.onAdd(this.map)};g(!1),s.type!=="vector"&&s.type!=="geojson"||g(!0),_.onAdd&&_.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const s=this.getOwnSource(t);if(!s)throw new Error("There is no source with this ID");for(const _ in this._layers)if(this._layers[_].source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while layer "${_}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const _=Object.entries(this.stylesheet.iconsets).find(([g,b])=>b.type==="source"&&b.source===t);if(_)return this.fire(new r.z(new Error(`Source "${t}" cannot be removed while iconset "${_[0]}" is using it.`)))}const f=this.getOwnSourceCaches(t);for(const _ of f){const g=r.d8(_.id);delete this._sourceCaches[g],this._changes.discardSourceCacheUpdate(_.id),_.fire(new r.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:_.getSource().id})),_.setEventedParent(null),_.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),s.setEventedParent(null),s.onRemove&&s.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,s){this._checkLoaded(),this.getOwnSource(t).setData(s),this._changes.setDirty()}getOwnSource(t){const s=this.getOwnSourceCache(t);return s&&s.getSource()}getOwnSources(){const t=[];for(const s in this._otherSourceCaches){const f=this.getOwnSourceCache(s);f&&t.push(f.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const s in t){const f=t[s]._tiles;for(const _ in f){const g=f[_];if(g.state!=="loaded"&&g.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const s=this._getTransitionParameters();for(const _ of t){if(this._validate(uu,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){const g=this.ambientLight;g.set(_),g.updateTransitions(s)}else this.ambientLight=new er(_,_i||(_i=new r.a7({color:new r.a8(r.a5.properties_light_ambient.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const g=this.directionalLight;g.set(_),g.updateTransitions(s)}else this.directionalLight=new er(_,Xn||(Xn=new r.a7({direction:new r.an(r.a5.properties_light_directional.direction),color:new r.a8(r.a5.properties_light_directional.color),"color-use-theme":new r.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new r.a8(r.a5.properties_light_directional.intensity),"cast-shadows":new r.a8(r.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new r.a8(r.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new r.a8(r.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const f=new r.aa(this.z||0,s);this.ambientLight&&this.ambientLight.recalculate(f),this.directionalLight&&this.directionalLight.recalculate(f),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,s=this.ambientLight;if(!t||!s)return;const f=O=>.2126*(O[0]<=.03928?O[0]/12.92:Math.pow((O[0]+.055)/1.055,2.4))+.7152*(O[1]<=.03928?O[1]/12.92:Math.pow((O[1]+.055)/1.055,2.4))+.0722*(O[2]<=.03928?O[2]/12.92:Math.pow((O[2]+.055)/1.055,2.4)),_=t.properties.get("color").toRenderColor(null).toArray01(),g=t.properties.get("intensity"),b=t.properties.get("direction"),T=1-r.cR(b.x,b.y,b.z)[2]/90,A=f(_)*g*T,z=s.properties.get("color").toRenderColor(null).toArray01(),D=s.properties.get("intensity"),F=f(z)*D;return Number(((A+F)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(r.d9(t)){const s=r.da(t),f=this.fragments.find(({id:g})=>g===s);if(!f)return;const _=r.d8(t);return f.style.getFragmentStyle(_)}{const s=this.fragments.find(({id:f})=>f===t);return s?s.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const s={},f=(_,g="")=>`${_}::${g}`;this._featuresetSelectors={};for(const _ in t){const g=this._featuresetSelectors[_]=[];for(const b of t[_].selectors){if(b.featureNamespace){const A=this.getOwnLayer(b.layer);if(!A){r.w(`Layer is undefined for selector: ${b.layer}`);continue}const z=f(A.source,A.sourceLayer);if(z in s&&s[z]!==b.featureNamespace){r.w(`"featureNamespace ${b.featureNamespace} of featureset ${_}'s selector is not associated to the same source, skip this selector`);continue}s[z]=b.featureNamespace}let T;if(b.properties)for(const A in b.properties){const z=r.X(b.properties[A]);z.result==="success"&&(T=T||{},T[A]=z.value)}g.push({layerId:b.layer,namespace:b.featureNamespace,properties:T,uniqueFeatureID:b._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const s=this.getFragmentStyle(t);if(!s||!s.stylesheet.featuresets)return[];const f=[];for(const _ in s.stylesheet.featuresets)f.push({featuresetId:_,importId:s.scope?s.scope:void 0});return f}getFeaturesetLayers(t,s){const f=this.getFragmentStyle(s),_=f.stylesheet.featuresets;if(!_||!_[t])return this.fire(new r.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const g=[];for(const b of _[t].selectors){const T=f.getOwnLayer(b.layer);T&&g.push(T)}return g}getConfigProperty(t,s){const f=this.getFragmentStyle(t);if(!f)return null;const _=r.C(s,f.scope),g=f.options.get(_),b=g?g.value||g.default:null;return b?b.serialize():null}setConfigProperty(t,s,f){const _=this.getFragmentStyle(t);if(!_)return;const g=_.stylesheet.indoor?og(_.stylesheet.schema):_.stylesheet.schema;if(!g||!g[s])return;const b=r.X(f);if(b.result!=="success")return void wa(this,b.value);const T=b.value.expression,A=r.C(s,_.scope),z=_.options.get(A);if(!z)return;let D;const{minValue:F,maxValue:O,stepValue:U,type:H,values:q}=g[s],Y=r.X(g[s].default);Y.result==="success"&&(D=Y.value.expression),D?(this.options.set(A,Object.assign({},z,{value:T,default:D,minValue:F,maxValue:O,stepValue:U,type:H,values:q})),this.updateConfigDependencies(s)):this.fire(new r.z(new Error(`No schema defined for the config option "${s}" in the "${t}" fragment.`)))}getConfig(t){const s=this.getFragmentStyle(t);if(!s)return null;const f=s.stylesheet.schema;if(!f)return null;const _={};for(const g in f){const b=r.C(g,s.scope),T=s.options.get(b),A=T?T.value||T.default:null;_[g]=A?A.serialize():null}return _}setConfig(t,s){const f=this.getFragmentStyle(t);f&&(f.updateConfig(s,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const s=this.getFragmentStyle(t);return s?s.stylesheet.schema:null}setSchema(t,s){const f=this.getFragmentStyle(t);f&&(f.stylesheet.schema=s,f.updateConfig(f._config,s),this.updateConfigDependencies())}updateConfig(t,s){if(this._config=t,t||s)if(s)for(const f in s){let _,g;const b=r.X(s[f].default);if(b.result==="success"&&(_=b.value.expression),t&&t[f]!==void 0){const O=r.X(t[f]);O.result==="success"&&(g=O.value.expression)}const{minValue:T,maxValue:A,stepValue:z,type:D,values:F}=s[f];if(_){const O=r.C(f,this.scope);this.options.set(O,{default:_,value:g,minValue:T,maxValue:A,stepValue:z,type:D,values:F})}else this.fire(new r.z(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new r.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const s of this._configDependentLayers){const f=this.getLayer(s);if(f){if(t&&!f.configDependencies.has(t))continue;f.possiblyEvaluateVisibility(),this._updateLayer(f)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(s=>{const f=s._styleColorTheme.colorThemeOverride?s._styleColorTheme.colorThemeOverride:s._styleColorTheme.colorTheme;if(f){const _=s._evaluateColorThemeData(f);(!s._styleColorTheme.lut&&_!==""||s._styleColorTheme.lut&&_!==s._styleColorTheme.lut.data)&&s.setColorTheme(f)}}),this._changes.setDirty()}addLayer(t,s,f={}){this._checkLoaded();const _=t.id;if(this._layers[_])return void this.fire(new r.z(new Error(`Layer with id "${_}" already exists on this map`)));let g;if(t.type==="custom"){if(wa(this,r.db(t)))return;g=r.dc(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(_,t.source),t=r.d7(t),t=r.l(t,{source:_})),this._validate(W,`layers.${_}`,t,{arrayIndex:-1},f))return;g=r.dc(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(g),g.setEventedParent(this,{layer:{id:_}})}g.configDependencies.size!==0&&this._configDependentLayers.add(g.fqid);let b=this._order.length;if(s){const D=this._order.indexOf(s);if(D===-1)return void this.fire(new r.z(new Error(`Layer with id "${s}" does not exist on this map.`)));g.slot===this._layers[s].slot?b=D:r.w(`Layer with id "${s}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,_),this._layerOrderChanged=!0,this._layers[_]=g;const T=this.getOwnLayerSourceCache(g),A=!!this.directionalLight&&this.directionalLight.shadowsEnabled();T&&g.canCastShadows()&&A&&(T.castsShadows=!0);const z=this._changes.getRemovedLayer(g);if(z&&g.source&&T&&g.type!=="custom"){this._changes.discardLayerRemoval(g);const D=r.C(g.source,g.scope);z.type!==g.type?this._changes.updateSourceCache(D,"clear"):(this._changes.updateSourceCache(D,"reload"),T.pause())}this._updateLayer(g),g.onAdd&&g.onAdd(this.map),g.scope=this.scope,this.mergeLayers()}moveLayer(t,s){this._checkLoaded();const f=this._checkLayer(t);if(!f||t===s)return;const _=this._order.indexOf(t);this._order.splice(_,1);let g=this._order.length;if(s){const b=this._order.indexOf(s);if(b===-1)return void this.fire(new r.z(new Error(`Layer with id "${s}" does not exist on this map.`)));f.slot===this._layers[s].slot?g=b:r.w(`Layer with id "${s}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(g,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const s=this._checkLayer(t);if(!s)return;s.setEventedParent(null);const f=this._order.indexOf(t);this._order.splice(f,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(s.fqid),this._changes.removeLayer(s);const _=this.getOwnLayerSourceCache(s);if(_&&_.castsShadows){let g=!1;for(const b in this._layers)if(this._layers[b].source===s.source&&this._layers[b].canCastShadows()){g=!0;break}_.castsShadows=g}s.onRemove&&s.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const s in this._layers)if(this._layers[s].type===t)return!0;return!1}setLayerZoomRange(t,s,f){this._checkLoaded();const _=this._checkLayer(t);_&&(_.minzoom===s&&_.maxzoom===f||(s!=null&&(_.minzoom=s),f!=null&&(_.maxzoom=f),this._updateLayer(_)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,s){this._checkLoaded();const f=this._checkLayer(t);f&&f.slot!==s&&(f.slot=s,this._updateLayer(f))}setFilter(t,s,f={}){this._checkLoaded();const _=this._checkLayer(t);if(_&&!r.bv(_.filter,s))return s==null?(_.filter=void 0,void this._updateLayer(_)):void(this._validate(ie,`layers.${_.id}.filter`,s,{layerType:_.type},f)||(_.filter=r.d7(s),this._updateLayer(_)))}getFilter(t){const s=this._checkLayer(t);if(s)return r.d7(s.filter)}setLayoutProperty(t,s,f,_={}){this._checkLoaded();const g=this._checkLayer(t);if(g&&!r.bv(g.getLayoutProperty(s),f)){if(f!=null&&(!_||_.validate!==!1)&&wa(g,Ee.call(qo,{key:`layers.${t}.layout.${s}`,layerType:g.type,objectKey:s,value:f,styleSpec:r.a5,style:{glyphs:!0,sprite:!0}})))return;g.setLayoutProperty(s,f),g.configDependencies.size!==0&&this._configDependentLayers.add(g.fqid),this._updateLayer(g)}}getLayoutProperty(t,s){const f=this._checkLayer(t);if(f)return f.getLayoutProperty(s)}setPaintProperty(t,s,f,_={}){this._checkLoaded();const g=this._checkLayer(t);if(!g||r.bv(g.getPaintProperty(s),f)||f!=null&&(!_||_.validate!==!1)&&wa(g,ge.call(qo,{key:`layers.${t}.paint.${s}`,layerType:g.type,objectKey:s,value:f,styleSpec:r.a5})))return;const b=g.setPaintProperty(s,f);g.configDependencies.size!==0&&this._configDependentLayers.add(g.fqid),b&&this._updateLayer(g),this._changes.updatePaintProperties(g)}getPaintProperty(t,s){const f=this._checkLayer(t);if(f)return f.getPaintProperty(s)}setFeatureState(t,s){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:A,importId:z}=t.target,D=this.getFragmentStyle(z),F=D.getFeaturesetLayers(A);for(const{source:O,sourceLayer:U}of F)D.setFeatureState({id:t.id,source:O,sourceLayer:U},s)}else if("layerId"in t.target){const{layerId:A}=t.target,z=this.getLayer(A);this.setFeatureState({id:t.id,source:z.source,sourceLayer:z.sourceLayer},s)}return}const f=t.source,_=t.sourceLayer,g=this._checkSource(f);if(!g)return;const b=g.type;if(b==="geojson"&&_)return void this.fire(new r.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(b==="vector"&&!_)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided.")));const T=this.getOwnSourceCaches(f);for(const A of T)A.setFeatureState(_,t.id,s)}removeFeatureState(t,s){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:A,importId:z}=t.target,D=this.getFragmentStyle(z),F=D.getFeaturesetLayers(A);for(const{source:O,sourceLayer:U}of F)D.removeFeatureState({id:t.id,source:O,sourceLayer:U},s)}else if("layerId"in t.target){const{layerId:A}=t.target,z=this.getLayer(A);this.removeFeatureState({id:t.id,source:z.source,sourceLayer:z.sourceLayer},s)}return}const f=t.source,_=this._checkSource(f);if(!_)return;const g=_.type,b=g==="vector"?t.sourceLayer:void 0;if(g==="vector"&&!b)return void this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(s&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new r.z(new Error("A feature id is required to remove its specific state property.")));const T=this.getOwnSourceCaches(f);for(const A of T)A.removeFeatureState(b,t.id,s)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let g;if("featuresetId"in t.target){const{featuresetId:b,importId:T}=t.target,A=this.getFragmentStyle(T),z=A.getFeaturesetLayers(b);for(const{source:D,sourceLayer:F}of z){const O=A.getFeatureState({id:t.id,source:D,sourceLayer:F});if(O&&!g)g=O;else if(!r.bv(g,O))return void this.fire(new r.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:b}=t.target,T=this.getLayer(b);g=this.getFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer})}return g}const s=t.source,f=t.sourceLayer,_=this._checkSource(s);if(_){if(_.type!=="vector"||f)return t.id===void 0&&this.fire(new r.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(s)[0].getFeatureState(f,t.id);this.fire(new r.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=r.l({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return r.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),s=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return r.dd({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:s,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateFilteredLayers(t){for(const s of Object.values(this._mergedLayers))t(s)&&this._updateLayer(s)}_updateLayer(t){this._changes.updateLayer(t);const s=this.getLayerSourceCache(t),f=r.C(t.source,t.scope),_=this._changes.getUpdatedSourceCaches();t.source&&!_[f]&&s&&s.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),s.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const s=T=>this._mergedLayers[T].is3D(!!this.terrain),f=this.order,_={},g=[];for(let T=f.length-1;T>=0;T--){const A=f[T];if(s(A)){_[A]=T;for(const z of t){const D=z[A];if(D)for(const F of D)g.push(F)}}}g.sort((T,A)=>A.intersectionZ-T.intersectionZ);const b=[];for(let T=f.length-1;T>=0;T--){const A=f[T];if(s(A))for(let z=g.length-1;z>=0;z--){const D=g[z].feature;if(D.layer&&_[D.layer.id]<T)break;b.push(D),g.pop()}else for(const z of t){const D=z[A];if(D)for(const F of D)b.push(F.feature)}}return b}queryRenderedFeatures(t,s,f){let _;s&&!Array.isArray(s)&&s.filter&&(this._validate(ie,"queryRenderedFeatures.filter",s.filter,null,s),_=r.b3(s.filter));const g={},b=D=>{if(Xs.has(D.type))return;const F=this.getOwnLayerSourceCache(D),O=g[F.id]=g[F.id]||{sourceCache:F,layers:{},has3DLayers:!1};D.is3D(!!this.terrain)&&(O.has3DLayers=!0),O.layers[D.fqid]=O.layers[D.fqid]||{styleLayer:D,targets:[]},O.layers[D.fqid].targets.push({filter:_})};if(s&&s.layers){if(!Array.isArray(s.layers))return this.fire(new r.z(new Error("parameters.layers must be an Array."))),[];for(const D of s.layers){const F=this._layers[D];if(!F)return this.fire(new r.z(new Error(`The layer '${D}' does not exist in the map's style and cannot be queried for features.`))),[];b(F)}}else for(const D in this._layers)b(this._layers[D]);const T=this._queryRenderedFeatures(t,g,f),A=this._flattenAndSortRenderedFeatures(T),z=[];for(const D of A)r.de(D.layer.id)===this.scope&&z.push(D);return z}queryRenderedFeatureset(t,s,f){let _;s&&!Array.isArray(s)&&s.filter&&(this._validate(ie,"queryRenderedFeatures.filter",s.filter,null,s),_=r.b3(s.filter));const g="mock",b=[];if(s&&s.target)b.push(Object.assign({},s,{targetId:g,filter:_}));else{const D=this.getFeaturesetDescriptors();for(const F of D)b.push({targetId:g,filter:_,target:F});for(const{style:F}of this.fragments){const O=F.getFeaturesetDescriptors();for(const U of O)b.push({targetId:g,filter:_,target:U})}}const T=this.queryRenderedTargets(t,b,f),A=[],z=new Set;for(const D of T)for(const F of D.variants[g])fu(F,D,z)||A.push(new r.df(D,F));return A}queryRenderedTargets(t,s,f){const _={},g=(T,A,z,D)=>{const F=_[A.id]=_[A.id]||{sourceCache:A,layers:{},has3DLayers:!1};if(F.layers[T.fqid]=F.layers[T.fqid]||{styleLayer:T,targets:[]},T.is3D(!!this.terrain)&&(F.has3DLayers=!0),!D)return z.uniqueFeatureID=!1,void F.layers[T.fqid].targets.push(z);F.layers[T.fqid].targets.push(Object.assign({},z,{namespace:D.namespace,properties:D.properties,uniqueFeatureID:D.uniqueFeatureID}))};for(const T of s)if("featuresetId"in T.target){const{featuresetId:A,importId:z}=T.target,D=this.getFragmentStyle(z);if(!D||!D._featuresetSelectors)continue;const F=D._featuresetSelectors[A];if(!F){this.fire(new r.z(new Error(`The featureset '${A}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const O of F){const U=D.getOwnLayer(O.layerId);U&&!Xs.has(U.type)&&g(U,D.getOwnLayerSourceCache(U),T,O)}}else if("layerId"in T.target){const{layerId:A}=T.target,z=this.getLayer(A);if(!z||Xs.has(z.type))continue;g(z,this.getLayerSourceCache(z),T)}const b=this._queryRenderedFeatures(t,_,f);return this._flattenAndSortRenderedFeatures(b)}_queryRenderedFeatures(t,s,f){const _=[],g=!!this.map._showQueryGeometry,b=hr.createFromScreenPoints(t,f);for(const T in s){const A=il(b,s[T],this._availableImages,f,g);Object.keys(A).length&&_.push(A)}if(this.placement)for(const T in s){if(!s[T].sourceCache._onlySymbols)continue;const A=du(b.screenGeometry,s[T],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(A).length&&_.push(A)}return _}querySourceFeatures(t,s){const f=s&&s.filter;f&&this._validate(ie,"querySourceFeatures.filter",f,null,s);let _=[];const g=this.getOwnSourceCaches(t);for(const b of g)_=_.concat(Yd(b,s));return _}addSourceType(t,s,f){return Wo.getSourceType(t)?f(new Error(`A source type called "${t}" already exists.`)):(Wo.setSourceType(t,s),s.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:s.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,s,f={}){this._checkLoaded();const _=this.light.getLight();let g=!1;for(const T in t)if(!r.bv(t[T],_[T])){g=!0;break}if(!g)return;const b=this._getTransitionParameters();this.light.setLight(t,s,f),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=r.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&r.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,s=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),s===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let f=t;const _=t.source==null;if(s===1){if(this.disableElevatedTerrain)return;if(typeof f.source=="object"){const T="terrain-dem-src";this.addSource(T,f.source),f=r.d7(f),f=r.l(f,{source:T})}const g=r.l({},f),b={};if(this.terrain&&_){g.source=this.terrain.get().source;const T=this.terrain?this.getFragmentStyle(this.terrain.scope):null;T&&(b.style=T.serialize())}if(this._validate(St,"terrain",g,b))return}if(!this.terrain||this.terrain.scope!==this.scope&&!_||this.terrain&&s!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,s),this.fire(new r.A("data",{dataType:"style"}))}else{const g=this.terrain,b=g.get();for(const T of Object.keys(r.a5.terrain))!f.hasOwnProperty(T)&&r.a5.terrain[T].default&&(f[T]=r.a5.terrain[T].default);for(const T in t)if(!r.bv(t[T],b[T])){g.set(t,this.options),this.stylesheet.terrain=t;const A=this._getTransitionParameters({duration:0});g.updateTransitions(A),this.fire(new r.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const s=this.fog=new zn(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}_createSnow(t){const s=this.snow=new gi(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}_createRain(t){const s=this.rain=new Ti(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const s=this.fog;if(!r.bv(s.get(),t)){s.set(t,this.options),this.stylesheet.fog=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const s=this.snow;if(!r.bv(s.get(),t)){s.set(t,this.options),this.stylesheet.snow=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const s=this.rain;if(!r.bv(s.get(),t)){s.set(t,this.options),this.stylesheet.rain=s.get();const f=this._getTransitionParameters({duration:0});s.updateTransitions(f)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const _ in this._layers)this._layers[_].lut=this._styleColorTheme.lut;for(const _ in this._sourceCaches)this._sourceCaches[_].clearTiles()},s=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!s)return this._styleColorTheme.lut=null,void t();const f=this._evaluateColorThemeData(s);this._loadColorTheme(f).then(()=>{this.fire(new r.A("colorthemeset")),t()}).catch(_=>{r.w(`Couldn't set color theme: ${_}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&r.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,s){const f=this.getFragmentStyle(t);f&&(f._styleColorTheme.colorThemeOverride=s,f._reloadColorTheme())}_getTransitionParameters(t){return{now:r.q.now(),transition:r.l(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],s=[];for(const f of this._mergedOrder)this.isLayerDraped(this._mergedLayers[f])?t.push(f):s.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...s)}_createTerrain(t,s){const f=this.terrain=new it(t,s,this.scope,this.options);s===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const _=this._getTransitionParameters({duration:0});f.updateTransitions(_)}_force3DLayerUpdate(){for(const t in this._layers){const s=this._layers[t];s.type==="fill-extrusion"&&this._updateLayer(s)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const s=this._layers[t];s.type==="symbol"&&this._updateLayer(s)}}_validate(t,s,f,_,g={}){if(g&&g.validate===!1)return!1;const b=r.l({},this.serialize());return wa(this,t.call(qo,r.l({key:s,style:b,value:f,styleSpec:r.a5},_)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),r.dg.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const s=this.getSourceCaches(t);for(const f of s)f.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const s=this.getSourceCaches(t);for(const f of s)f.resume(),f.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let s;this.directionalLight&&(s=sp(this.directionalLight));const f=new Set;for(const _ in this._mergedLayers){const g=this._mergedLayers[_];g.hasElevation()&&!f.has(g.source)&&f.add(g.source)}for(const _ in this._mergedSourceCaches){const g=this._mergedSourceCaches[_],b=f.has(g._source.id);g.update(t,void 0,void 0,s,b)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const s=this._sourceCaches[t];s.resume(),s.reload()}}_updatePlacement(t,s,f,_,g,b,T=!1){let A=!1,z=!1;const D={},F={};for(const O of this._mergedOrder){const U=this._mergedLayers[O];if(U.type!=="symbol")continue;const H=r.C(U.source,U.scope);let q=D[H];if(!q){const Z=this.getLayerSourceCache(U);if(!Z)continue;const oe=Z.getRenderableIds(!0).map(fe=>Z.getTileByID(fe));F[H]=oe.slice(),q=D[H]=oe.sort((fe,me)=>me.tileID.overscaledZ-fe.tileID.overscaledZ||(fe.tileID.isLessThan(me.tileID)?-1:1))}const Y=this.crossTileSymbolIndex.addLayer(U,q,s.center.lng,s.projection);A=A||Y}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),T=T||this._layerOrderChanged||_===0,this._layerOrderChanged&&this.fire(new r.A("neworder")),(T||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(r.q.now(),s.zoom))&&(this.pauseablePlacement=new Yr(s,this._mergedOrder,T,f,_,g,this.placement,this.fog&&s.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,D,F,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(r.q.now()),z=!0),A&&this.pauseablePlacement.placement.setStale()),z||A){this._buildingIndex.onNewFrame(s.zoom);for(let O=0;O<this._mergedOrder.length;O++){const U=this._mergedLayers[this._mergedOrder[O]];if(U.type!=="symbol")continue;const H=this.isLayerClipped(U);this.placement.updateLayerOpacities(U,D[r.C(U.source,U.scope)],O,H?b:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(r.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,s){this._checkLoaded();const f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:g})=>g===t.id)!==-1)return void this.fire(new r.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!s)return f.push(t),this._loadImports([t],!0);const _=f.findIndex(({id:g})=>g===s);return _===-1&&this.fire(new r.z(new Error(`Import with id "${s}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,_).concat(t).concat(f.slice(_)),this._loadImports([t],!0,s)}updateImport(t,s){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(t);return _===-1?this:typeof s=="string"?(this.setImportUrl(t,s),this):(s.url&&s.url!==f[_].url&&this.setImportUrl(t,s.url),r.bv(s.config,f[_].config)||this.setImportConfig(t,s.config,s.data.schema),r.bv(s.data,f[_].data)||this.setImportData(t,s.data),this)}moveImport(t,s){this._checkLoaded();let f=this.stylesheet.imports||[];const _=this.getImportIndex(t);if(_===-1)return this;const g=this.getImportIndex(s);if(g===-1)return this;const b=f[_],T=this.fragments[_];return f=f.filter(({id:A})=>A!==t),this.fragments=this.fragments.filter(({id:A})=>A!==t),this.stylesheet.imports=f.slice(0,g).concat(b).concat(f.slice(g)),this.fragments=this.fragments.slice(0,g).concat(T).concat(this.fragments.slice(g)),this.mergeLayers(),this}setImportUrl(t,s){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(t);if(_===-1)return this;f[_].url=s;const g=this.fragments[_];return g.style=this._createFragmentStyle(f[_]),g.style.on("style.import.load",()=>this.mergeAll()),g.style.loadURL(s),this}setImportData(t,s){this._checkLoaded();const f=this.getImportIndex(t),_=this.stylesheet.imports||[];return f===-1?this:s?(this.fragments[f].style.setState(s),this._reloadImports(),this):(delete _[f].data,this.setImportUrl(t,_[f].url))}setImportConfig(t,s,f){this._checkLoaded();const _=this.getImportIndex(t),g=this.stylesheet.imports||[];if(_===-1)return this;s?g[_].config=s:delete g[_].config;const b=this.fragments[_];f&&b.style.stylesheet&&(b.style.stylesheet.schema=f);const T=b.style.stylesheet&&b.style.stylesheet.schema;return b.config=s,b.style.updateConfig(s,T),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const s=this.stylesheet.imports||[],f=this.getImportIndex(t);f!==-1&&(s.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(t){const s=(this.stylesheet.imports||[]).findIndex(f=>f.id===t);return s===-1&&this.fire(new r.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),s}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const s in this._mergedOtherSourceCaches){const f=this._mergedOtherSourceCaches[s];f&&t.push(f.getSource())}return t}getSource(t,s){const f=this.getSourceCache(t,s);return f&&f.getSource()}getLayerSource(t){const s=this.getLayerSourceCache(t);return s&&s.getSource()}getSourceCache(t,s){const f=r.C(t,s);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(t){const s=r.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[s]:this._mergedOtherSourceCaches[s]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const s=[];return this._mergedOtherSourceCaches[t]&&s.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&s.push(this._mergedSymbolSourceCaches[t]),s}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const s in t){const f=t[s];f==="reload"?this.reloadSource(s):f==="clear"&&this.clearSource(s)}}updateLayers(t){const s=this._changes.getUpdatedPaintProperties();for(const f of s){const _=this.getLayer(f);_&&_.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t,this.scope)}getImages(t,s,f){this.imageManager.getImages(s.images,s.scope,f),this._updateTilesForChangedImages();const _=b=>{if(b){const T=s.images.map(A=>r.I.toString(A));b.setDependencies(s.tileID.key,s.type,T)}},g=r.C(s.source,s.scope);_(this._mergedOtherSourceCaches[g]),_(this._mergedSymbolSourceCaches[g])}rasterizeImages(t,s,f){this.imageManager.rasterizeImages(s,f)}getGlyphs(t,s,f){this.glyphManager.getGlyphs(s.stacks,s.scope,f)}getResource(t,s,f){return r.dh(s,f)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const s=[];return this._otherSourceCaches[t]&&s.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&s.push(this._symbolSourceCaches[t]),s}_isSourceCacheLoaded(t){const s=this.getOwnSourceCaches(t);return s.length===0?(this.fire(new r.z(new Error(`There is no source with ID '${t}'`))),!1):s.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,s){if(!this._clipLayerPresent&&t.type!=="fill-extrusion")return!1;const f=t.type==="fill-extrusion"&&t.sourceLayer==="building";if(t.is3D(!!this.terrain)){if(f||s&&s.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Wo.getSourceType=function(h){return hu[h]},Wo.setSourceType=function(h,t){hu[h]=t},Wo.registerForPluginStateChange=r.c$;var ac=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,lc=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,cp=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Qh="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Mo=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,ef=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,At=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,up=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,tf=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,nf=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,hp=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef TEXTURE_GATHER
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const fl=[];uc(ac,fl),uc(cp,fl),uc(lc,fl);const Xo={"_prelude_fog.vertex.glsl":ef,"_prelude_terrain.vertex.glsl":Mo,"_prelude_shadow.vertex.glsl":nf,"_prelude_fog.fragment.glsl":At,"_prelude_shadow.fragment.glsl":hp,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":up,"_prelude_raster_particle.glsl":tf},cc={};Un("",Mo),Un(At,ef),Un(hp,nf),Un(up,""),Un(tf,"");const Ta=Un(lc,cp),Iu=ac;var dl={background:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in highp vec3 v_normal;in highp float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 apply_lighting_linear(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec4 color=vec4(v_color.rgb,1.0);vec3 normal=normalize(v_normal);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,v_color.rgb,v_color.a);color*=u_opacity;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_height));
#endif
#ifdef RENDER_CUTOFF
color*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_height);
#endif
glFragColor=vec4(linearTosRGB(color.rgb),color.a);
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3f;out vec4 v_color;out highp vec3 v_normal;out highp float v_height;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));vec3 pos=a_pos_3f;v_height=pos.z;gl_Position=u_matrix*vec4(pos,1.0);
#ifdef RENDER_SHADOWS
vec3 shadow_pos=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:Un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Un("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Un(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Un(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Un("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Un("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Un("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:Un(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Un(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
void main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,normal);
#endif
if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Un(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Un(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Un(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Un("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Un("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Un(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Un(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(abs(v_z_offset) > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
#endif
}`),terrainRaster:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Un("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Un(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Qh),skyboxGradient:Un(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Qh),skyboxCapture:Un(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Un(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Un(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Un("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Un("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Un("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Un("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function uc(h,t){const s=h.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let f of s)if(f=f.trim(),f[0]==="#"&&f.includes("if")&&!f.includes("endif")){f=f.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const _=f.split(" ");for(const g of _)t.includes(g)||t.push(g)}}function Un(h,t){const s=/#include\s+"([^"]+)"/g,f=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let _=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);_&&(_=_.map(z=>{const D=z.split(" ");return D[D.length-1]}),_=[...new Set(_)]);const g={},b=[],T=[];if(h=h.replace(s,(z,D)=>(T.push(D),"")),(t=t.replace(s,(z,D)=>(b.push(D),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let A=[...fl];uc(h,A),uc(t,A);for(const z of[...b,...T])Xo[z]||console.error(`Undefined include: ${z}`),cc[z]||(cc[z]=[],uc(Xo[z],cc[z])),A=[...A,...cc[z]];return{fragmentSource:h=h.replace(f,(z,D,F,O,U)=>(g[U]=!0,D==="define"?`
#ifndef HAS_UNIFORM_u_${U}
in ${F} ${O} ${U};
#else
uniform ${F} ${O} u_${U};
#endif
`:D==="initialize"?`
#ifdef HAS_UNIFORM_u_${U}
    ${F} ${O} ${U} = u_${U};
#endif
`:D==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${F} ${O} ${U};
#endif
`:D==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(f,(z,D,F,O,U)=>{const H=O==="float"?"vec2":O,q=U.match(/color/)?"color":H;return D==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${U}
in ${F} ${O} a_${U};
#endif
`:g[U]?D==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
in ${F} ${H} a_${U};
out ${F} ${O} ${U};
#else
uniform ${F} ${O} u_${U};
#endif
`:D==="initialize"?q==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = a_${U};
#else
    ${F} ${O} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = unpack_mix_${q}(a_${U}, u_${U}_t);
#else
    ${F} ${O} ${U} = u_${U};
#endif
`:D==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${F} ${O} a_${U};
    out ${F} ${O} ${U};
#endif
`:D==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${U} = a_${U};
#endif
`:void 0:D==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
in ${F} ${H} a_${U};
#else
uniform ${F} ${O} u_${U};
#endif
`:D==="define-instanced"?q==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${U}0;
in vec4 a_${U}1;
in vec4 a_${U}2;
in vec4 a_${U}3;
#else
uniform ${F} ${O} u_${U};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${F} ${H} a_${U};
#else
uniform ${F} ${O} u_${U};
#endif
`:D==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${F} ${O} ${U} = a_${U};
#endif
`:q==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${F} ${O} ${U} = a_${U};
#else
    ${F} ${O} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    ${F} ${O} ${U} = unpack_mix_${q}(a_${U}, u_${U}_t);
#else
    ${F} ${O} ${U} = u_${U};
#endif
`}),staticAttributes:_,usedDefines:A,vertexIncludes:b,fragmentIncludes:T}}class fp{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,s,f,_,g,b,T,A){this.context=t;let z=this.boundPaintVertexBuffers.length!==_.length;for(let F=0;!z&&F<_.length;F++)this.boundPaintVertexBuffers[F]!==_[F]&&(z=!0);let D=this.boundDynamicVertexBuffers.length!==T.length;for(let F=0;!D&&F<T.length;F++)this.boundDynamicVertexBuffers[F]!==T[F]&&(D=!0);if(!this.vao||this.boundProgram!==s||this.boundLayoutVertexBuffer!==f||z||D||this.boundIndexBuffer!==g||this.boundVertexOffset!==b)this.freshBind(s,f,_,g,b,T,A);else{t.bindVertexArrayOES.set(this.vao);for(const F of T)F&&(F.bind(),A&&F.instanceCount&&F.setVertexAttribDivisor(t.gl,s,A));g&&g.dynamicDraw&&g.bind()}}freshBind(t,s,f,_,g,b,T){const A=t.numAttributes,z=this.context,D=z.gl;this.vao&&this.destroy(),this.vao=z.gl.createVertexArray(),z.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=s,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=_,this.boundVertexOffset=g,this.boundDynamicVertexBuffers=b,s.enableAttributes(D,t),s.bind(),s.setVertexAttribPointers(D,t,g);for(const F of f)F.enableAttributes(D,t),F.bind(),F.setVertexAttribPointers(D,t,g);for(const F of b)F&&(F.enableAttributes(D,t),F.bind(),F.setVertexAttribPointers(D,t,g),T&&F.instanceCount&&F.setVertexAttribDivisor(D,t,T));_&&_.bind(),z.currentNumAttributes=A}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Vx(h,t){const s=Math.pow(2,t.canonical.z),f=t.canonical.y;return[new r.ac(0,f/s).toLngLat().lat,new r.ac(0,(f+1)/s).toLngLat().lat]}function ug(h,t,s,f,_,g,b){const T=h.context,A=T.gl,z=s.hillshadeFBO;if(!z)return;h.prepareDrawTile();const D=h.isTileAffectedByFog(t),F=h.getOrCreateProgram("hillshade",{overrideFog:D});T.activeTexture.set(A.TEXTURE0),A.bindTexture(A.TEXTURE_2D,z.colorAttachment.get());const O=((Y,Z,oe,fe)=>{const me=oe.paint.get("hillshade-shadow-color"),xe=oe.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ye=oe.paint.get("hillshade-highlight-color"),ve=oe.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",_e=oe.paint.get("hillshade-accent-color"),we=oe.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Te=oe.paint.get("hillshade-emissive-strength");let Ue=r.al(oe.paint.get("hillshade-illumination-direction"));if(oe.paint.get("hillshade-illumination-anchor")==="viewport")Ue-=Y.transform.angle;else if(Y.style&&Y.style.enable3dLights()&&Y.style.directionalLight){const ot=Y.style.directionalLight.properties.get("direction"),et=r.cR(ot.x,ot.y,ot.z);Ue=r.al(et[1])}const Fe=!Y.options.moving;return{u_matrix:fe||Y.transform.calculateProjMatrix(Z.tileID.toUnwrapped(),Fe),u_image:0,u_latrange:Vx(0,Z.tileID),u_light:[oe.paint.get("hillshade-exaggeration"),Ue],u_shadow:me.toRenderColor(xe?null:oe.lut),u_highlight:ye.toRenderColor(ve?null:oe.lut),u_emissive_strength:Te,u_accent:_e.toRenderColor(we?null:oe.lut)}})(h,s,f,h.terrain?t.projMatrix:null);h.uploadCommonUniforms(T,F,t.toUnwrapped());const{tileBoundsBuffer:U,tileBoundsIndexBuffer:H,tileBoundsSegments:q}=h.getTileBoundsBuffers(s);F.draw(h,A.TRIANGLES,_,g,b,an.disabled,O,f.id,U,H,q)}function dp(h,t,s){if(!t.needsDEMTextureUpload)return;const f=h.context,_=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||h.getTileTexture(s.stride);const g=s.getPixels();t.demTexture?t.demTexture.update(g,{premultiply:!1}):t.demTexture=new r.T(f,g,_.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function pp(h,t,s){const f=h.context,_=f.gl;if(!t.dem)return;const g=t.dem;if(f.activeTexture.set(_.TEXTURE1),dp(h,t,g),!t.demTexture)return;t.demTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE);const b=g.dim;f.activeTexture.set(_.TEXTURE0);let T=t.hillshadeFBO;if(!T){const O=new r.T(f,{width:b,height:b,data:null},_.RGBA8);O.bind(_.LINEAR,_.CLAMP_TO_EDGE),T=t.hillshadeFBO=f.createFramebuffer(b,b,!0,"renderbuffer"),T.colorAttachment.set(O.texture)}f.bindFramebuffer.set(T.framebuffer),f.viewport.set([0,0,b,b]);const{tileBoundsBuffer:A,tileBoundsIndexBuffer:z,tileBoundsSegments:D}=h.getMercatorTileBoundsBuffers(),F=[];h.linearFloatFilteringSupported()&&F.push("TERRAIN_DEM_FLOAT_FORMAT"),h.getOrCreateProgram("hillshadePrepare",{defines:F}).draw(h,_.TRIANGLES,Ut.disabled,sn.disabled,In.unblended,an.disabled,((O,U)=>{const H=U.stride,q=r.bz();return r.c5(q,0,r.aj,-r.aj,0,0,1),r.bo(q,q,[0,-r.aj,0]),{u_matrix:q,u_image:1,u_dimension:[H,H],u_zoom:O.overscaledZ}})(t.tileID,g),s.id,A,z,D),t.needsHillshadePrepare=!1}class Hi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ux extends Hi{getDefault(){return r.am.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class jx extends Hi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class $x extends Hi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class hg extends Hi{getDefault(){return[!0,!0,!0,!0]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Gx extends Hi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class rf extends Hi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class qx extends Hi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const s=this.current;(t.func!==s.func||t.ref!==s.ref||t.mask!==s.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class fg extends Hi{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class mp extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.STENCIL_TEST):s.disable(s.STENCIL_TEST),this.current=t,this.dirty=!1}}class of extends Hi{getDefault(){return[0,1]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class _p extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),this.current=t,this.dirty=!1}}class pl extends Hi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class gp extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.BLEND):s.disable(s.BLEND),this.current=t,this.dirty=!1}}class dg extends Hi{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class hc extends Hi{getDefault(){return r.am.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Mu extends Hi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class sf extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.CULL_FACE):s.disable(s.CULL_FACE),this.current=t,this.dirty=!1}}class af extends Hi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class fc extends Hi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let lf=class extends Hi{getDefault(){return null}set(h){(h!==this.current||this.dirty)&&(this.gl.useProgram(h),this.current=h,this.dirty=!1)}};class yp extends Hi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class pg extends Hi{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class vp extends Hi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class cf extends Hi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindRenderbuffer(s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Cu extends Hi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindTexture(s.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class mg extends Hi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class _g extends Hi{getDefault(){return null}set(t){const s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class gg extends Hi{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class dc extends Hi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class yg extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Hx extends Hi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class xp extends Hi{constructor(t,s){super(t),this.context=t,this.parent=s}getDefault(){return null}}class Zx extends xp{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class uf extends xp{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,this.attachment(),s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class bp extends xp{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferTexture2D(s.FRAMEBUFFER,this.attachment(),s.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class wp extends uf{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Tp=(h,t,s)=>({u_matrix:h,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:s}),Sp=(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q)=>({u_proj_matrix:Float32Array.from(h),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:s,u_zoom_transition:_,u_merc_center:g,u_image0:0,u_frustum_tl:b,u_frustum_tr:T,u_frustum_br:A,u_frustum_bl:z,u_globe_pos:D,u_globe_radius:F,u_viewport:O,u_grid_matrix:q?Float32Array.from(q):new Float32Array(9),u_skirt_height:U,u_far_z_cutoff:H});function Ep(h,t){return h!=null&&t!=null&&!(!h.hasData()||!t.hasData())&&h.demTexture!=null&&t.demTexture!=null&&h.tileID.key!==t.tileID.key}const pc=new class{constructor(){this.operations={}}newMorphing(h,t,s,f,_){if(h in this.operations){const g=this.operations[h];g.to.tileID.key!==s.tileID.key&&(g.queued=s)}else this.operations[h]={startTime:f,phase:0,duration:_,from:t,to:s,queued:null}}getMorphValuesForProxy(h){if(!(h in this.operations))return null;const t=this.operations[h];return{from:t.from,to:t.to,phase:t.phase}}update(h){for(const t in this.operations){const s=this.operations[t];for(s.phase=(h-s.startTime)/s.duration;s.phase>=1||!this._validOp(s);)if(!this._nextOp(s,h)){delete this.operations[t];break}}}_nextOp(h,t){return!!h.queued&&(h.from=h.to,h.to=h.queued,h.queued=null,h.phase=0,h.startTime=t,!0)}_validOp(h){return h.from.hasData()&&h.to.hasData()}},mc={0:null,1:"TERRAIN_VERTEX_MORPHING"};function _c(h,t,s){if(t===0)return 0;const f=t<1&&s===514?.25/t:1;return 6*Math.pow(1.5,22-h)*Math.max(t,1)*f}function vg(h,t){const s=1<<h.z;return!t&&(h.x===0||h.x===s-1)||h.y===0||h.y===s-1}const uo=h=>({u_matrix:h});function Pu(h,t,s,f,_){if(_>0){const g=r.q.now(),b=(g-h.timeAdded)/_,T=t?(g-t.timeAdded)/_:-1,A=s.getSource(),z=f.coveringZoomLevel({tileSize:A.tileSize,roundZoom:A.roundZoom}),D=!t||Math.abs(t.tileID.overscaledZ-z)>Math.abs(h.tileID.overscaledZ-z),F=D&&h.refreshedUponExpiration?1:r.aD(D?b:1-T,0,1);return h.refreshedUponExpiration&&b>=1&&(h.refreshedUponExpiration=!1),t?{opacity:1,mix:1-F}:{opacity:F,mix:0}}return{opacity:1,mix:0}}class hf extends Wr{constructor(t){const s={type:"raster-dem",maxzoom:t.transform.maxZoom},f=new r.D(r.d0(),null),_=Kl("mock-dem",s,f,t.style);super("mock-dem",_,!1),_.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,s){t.state="loaded",s(null)}}class ff extends Wr{constructor(t){const s=Kl("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new r.D(r.d0(),null),t.style);super("proxy",s,!1),s.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,s,f){if(t.freezeTileCoverage)return;this.transform=t;const _=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((g,b)=>{if(g[b.key]="",!this._tiles[b.key]){const T=new Zs(b,this._source.tileSize*b.overscaleFactor(),t.tileZoom);T.state="loaded",this._tiles[b.key]=T}return g},{});for(const g in this._tiles)g in _||(this.freeFBO(g),this._tiles[g].unloadVectorData(),delete this._tiles[g])}freeFBO(t){const s=this.proxyCachedFBO[t];if(s!==void 0){const f=Object.values(s);this.renderCachePool.push(...f),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class df extends r.aM{constructor(t,s,f){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=s,this.projMatrix=f}}class pf extends r.dt{constructor(t,s){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[f,_,g]=function(A){const z=new r.ba,D=new r.a_,F=131;z.reserve(17161),D.reserve(33800);const O=r.aj/128,U=r.aj+O/2,H=U+O;for(let Y=-O;Y<H;Y+=O)for(let Z=-O;Z<H;Z+=O){const oe=Z<0||Z>U||Y<0||Y>U?24575:0,fe=r.aD(Math.round(Z),0,r.aj),me=r.aD(Math.round(Y),0,r.aj);z.emplaceBack(fe+oe,me)}const q=(Y,Z)=>{const oe=Z*F+Y;D.emplaceBack(oe+1,oe,oe+F),D.emplaceBack(oe+F,oe+F+1,oe+1)};for(let Y=1;Y<129;Y++)for(let Z=1;Z<129;Z++)q(Z,Y);return[0,129].forEach(Y=>{for(let Z=0;Z<130;Z++)q(Z,Y),q(Y,Z)}),[z,D,32768]}(),b=t.context;this.gridBuffer=b.createVertexBuffer(f,r.bc.members),this.gridIndexBuffer=b.createIndexBuffer(_),this.gridSegments=r.bd.simpleSegment(0,0,f.length,_.length),this.gridNoSkirtSegments=r.bd.simpleSegment(0,0,f.length,g),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new ff(s.map),this.orthoMatrix=r.bz(),r.c5(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,r.aj,0,r.aj,0,1);const T=b.gl;this._overlapStencilMode=new sn({func:T.GEQUAL,mask:255},0,255,T.KEEP,T.KEEP,T.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=s,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new hf(s.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,s,f){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const _=t.terrain.properties,g=t.terrain.drapeRenderMode===0,b=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=r.q.now();const T=t.terrain&&t.terrain.scope,A=_.get("source"),z=g?this._mockSourceCache:t.getSourceCache(A,T);if(!z)return void r.w(`Couldn't find terrain source "${A}".`);if(this.sourceCache=z,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=b?this.calculateExaggeration(s):_.get("exaggeration"),!s.projection.requiresDraping&&b&&this._exaggeration===0)return void this._disable();this.enabled=!0;const D=()=>{this.sourceCache.used&&r.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const F=this.getScaledDemTileSize();this.sourceCache.update(s,F,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,D(),this._initializing=!0),D(),s.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(s),this._emptyDEMTextureDirty=!0,this._previousZoom=s.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const s=this._previousCameraAltitude,f=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=f;const _=s!=null?f-s:Number.MAX_VALUE;if(Math.abs(_)<2)return this._exaggeration;const g=t.zoom,b=this._style.terrain;if(!this._previousUpdateTimestamp)return b.getExaggeration(g);let T=g-this._previousZoom;const A=this._previousUpdateTimestamp;let z=g;this._evaluationZoom!=null&&(z=this._evaluationZoom,Math.abs(g-z)>.5&&(T=.5*(g-z+T)),T*_<0&&(z+=T)),this._evaluationZoom=z;const D=b.getExaggeration(z),F=D===b.getExaggeration(Math.max(0,z-.1));if(F&&Math.abs(D-this._exaggeration)<.01)return D;let O=Math.min(.1,.00375*(this._updateTimestamp-A));return(F||D<.1||Math.abs(T)<1e-4)&&(O=Math.min(.2,4*O)),r.ai(this._exaggeration,D,O)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const s=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(r.ac.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const _=this.proxyCoords=s.getIds().map(A=>{const z=s.getTileByID(A).tileID;return z.projMatrix=f.calculateProjMatrix(z.toUnwrapped()),z});(function(A,z){const D=z.transform.pointCoordinate(z.transform.getCameraPoint()),F=new r.P(D.x,D.y);A.sort((O,U)=>{if(U.overscaledZ-O.overscaledZ)return U.overscaledZ-O.overscaledZ;const H=new r.P(O.canonical.x+(1<<O.canonical.z)*O.wrap,O.canonical.y),q=new r.P(U.canonical.x+(1<<U.canonical.z)*U.wrap,U.canonical.y),Y=F.mult(1<<O.canonical.z);return Y.x-=.5,Y.y-=.5,Y.distSqr(H)-Y.distSqr(q)})})(_,this.painter);const g=this.proxyToSource||{};this.proxyToSource={},_.forEach(A=>{this.proxyToSource[A.key]={}}),this.terrainTileForTile={};const b=this._style._mergedSourceCaches;for(const A in b){const z=b[A];if(!z.used||(z!==this.sourceCache&&this.resetTileLookupCache(z.id),this._setupProxiedCoordsForOrtho(z,t[A],g),z.usedForTerrain))continue;const D=t[A];z.getSource().reparseOverscaled&&this._assignTerrainTiles(D)}this.proxiedCoords[s.id]=_.map(A=>new df(A,A.key,this.orthoMatrix)),this._assignTerrainTiles(_),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(g),this.renderingToTexture=!1;const T={};this._visibleDemTiles=[];for(const A of this.proxyCoords){const z=this.terrainTileForTile[A.key];if(!z)continue;const D=z.tileID.key;D in T||(this._visibleDemTiles.push(z),T[D]=D)}}_assignTerrainTiles(t){this._initializing||t.forEach(s=>{if(this.terrainTileForTile[s.key])return;const f=this._findTileCoveringTileID(s,this.sourceCache);f&&(this.terrainTileForTile[s.key]=f)})}_prepareDEMTextures(){const t=this.painter.context,s=t.gl;for(const f in this.terrainTileForTile){const _=this.terrainTileForTile[f],g=_.dem;!g||_.demTexture&&!_.needsDEMTextureUpload||(t.activeTexture.set(s.TEXTURE1),dp(this.painter,_,g))}}_prepareDemTileUniforms(t,s,f,_){if(!s||s.demTexture==null)return!1;const g=t.tileID.canonical,b=Math.pow(2,s.tileID.canonical.z-g.z),T=_||"";return f[`u_dem_tl${T}`]=[g.x*b%1,g.y*b%1],f[`u_dem_scale${T}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const s=this._visibleDemTiles.reduce((f,_)=>{if(!_.dem)return f;const g=_.dem.tree.minimums[0];return g>0&&t++,f+g},0);return t?s/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,s=t.gl;t.activeTexture.set(s.TEXTURE2);const f=this._getLoadedAreaMinimum(),_=new r.du({width:1,height:1},new Float32Array([f]));this._emptyDEMTextureDirty=!1;let g=this._emptyDEMTexture;return g?g.update(_,{premultiply:!1}):g=this._emptyDEMTexture=new r.T(t,_,s.R32F,{premultiply:!1}),g}setupElevationDraw(t,s,f){const _=this.painter.context,g=_.gl,b={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};b.u_exaggeration=this.exaggeration();let T=null,A=null,z=1;if(f&&f.morphing&&this._useVertexMorphing){const U=f.morphing.srcDemTile,H=f.morphing.dstDemTile;z=f.morphing.phase,U&&H&&(this._prepareDemTileUniforms(t,U,b,"_prev")&&(A=U),this._prepareDemTileUniforms(t,H,b)&&(T=H))}const D=U=>U&&U.demTexture&&this.painter.linearFloatFilteringSupported()?g.LINEAR:g.NEAREST;let F=null;var O;if(this.enabled?A&&T?(F=T.demTexture,_.activeTexture.set(g.TEXTURE4),A.demTexture.bind(D(A),g.CLAMP_TO_EDGE),b.u_dem_lerp=z):(T=this.terrainTileForTile[t.tileID.key],F=this._prepareDemTileUniforms(t,T,b)?T.demTexture:this.emptyDEMTexture):F=this.emptyDEMTexture,_.activeTexture.set(g.TEXTURE2),F&&(b.u_dem_size=(O=F).size[0]===1?1:O.size[0]-2,F.bind(D(T),g.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(f&&f.useDepthForOcclusion,s,b),f&&f.useMeterToDem&&T){const U=(1<<T.tileID.canonical.z)*r.c6(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=U}if(f&&f.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),s.setTerrainUniformValues(_,b),this.painter.transform.projection.name==="globe"){const U=this.globeUniformValues(this.painter.transform,t.tileID.canonical,f&&f.useDenormalizedUpVectorScale);s.setGlobeUniformValues(_,U)}}globeUniformValues(t,s,f){const _=t.projection;return{u_tile_tl_up:_.upVector(s,0,0),u_tile_tr_up:_.upVector(s,r.aj,0),u_tile_br_up:_.upVector(s,r.aj,r.aj),u_tile_bl_up:_.upVector(s,0,r.aj),u_tile_up_scale:f?r.dv(1):_.upVectorScale(s,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const s=this.painter,f=this.painter.context;t.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,s.width,s.height]),s.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(_,g,b,T,A){if(_.transform.projection.name==="globe")(function(z,D,F,O,U){const H=z.context,q=H.gl;let Y,Z;const oe=z.transform,fe=r.dl(z,H,oe),me=(ot,et)=>{if(Z===et)return;const xt=[mc[et],"PROJECTION_GLOBE_VIEW"];fe&&xt.push("CUSTOM_ANTIALIASING");const Oe=z.isTileAffectedByFog(ot);Y=z.getOrCreateProgram("globeRaster",{defines:xt,overrideFog:Oe}),Z=et},xe=z.colorModeForRenderPass(),ye=new Ut(q.LEQUAL,Ut.ReadWrite,z.depthRangeFor3D);pc.update(U);const ve=r.dm(oe),_e=[r.ay(oe.center.lng),r.aH(oe.center.lat)],we=z.globeSharedBuffers,Te=[oe.width*r.q.devicePixelRatio,oe.height*r.q.devicePixelRatio],Ue=Float32Array.from(oe.globeMatrix),Fe={useDenormalizedUpVectorScale:!0};{const ot=z.transform,et=_c(ot.zoom,D.exaggeration(),D.sourceCache._source.tileSize);Z=-1;const xt=q.TRIANGLES;for(const Oe of O){const je=F.getTile(Oe),Le=sn.disabled,lt=D.prevTerrainTileForTile[Oe.key],Ze=D.terrainTileForTile[Oe.key];Ep(lt,Ze)&&pc.newMorphing(Oe.key,lt,Ze,U,250),H.activeTexture.set(q.TEXTURE0),je.texture&&je.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE);const dt=pc.getMorphValuesForProxy(Oe.key),st=dt?1:0;dt&&r.L(Fe,{morphing:{srcDemTile:dt.from,dstDemTile:dt.to,phase:r.dk(dt.phase)}});const pt=r.dn(Oe.canonical),mt=r.dp(pt.getCenter().lat),Vt=r.dq(Oe.canonical,pt,mt,ot.worldSize/ot._pixelsPerMercatorPixel),Xt=r.bh(r.dr(Oe.canonical)),Bt=Sp(ot.expandedFarZProjMatrix,Ue,ve,Xt,r.ah(ot.zoom),_e,ot.frustumCorners.TL,ot.frustumCorners.TR,ot.frustumCorners.BR,ot.frustumCorners.BL,ot.globeCenterInViewSpace,ot.globeRadius,Te,et,ot._farZ,Vt);if(me(Oe,st),Y&&(D.setupElevationDraw(je,Y,Fe),z.uploadCommonUniforms(H,Y,Oe.toUnwrapped()),we)){const[Yt,jt,en]=we.getGridBuffers(mt,et!==0);Y.draw(z,xt,ye,Le,xe,an.backCCW,Bt,"globe_raster",Yt,jt,en)}}}if(we&&(z.renderDefaultNorthPole||z.renderDefaultSouthPole)){const ot=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];fe&&ot.push("CUSTOM_ANTIALIASING"),Y=z.getOrCreateProgram("globeRaster",{defines:ot});for(const et of O){const{x:xt,y:Oe,z:je}=et.canonical,Le=Oe===0,lt=Oe===(1<<je)-1,[Ze,dt,st,pt]=we.getPoleBuffers(je,!1);if(pt&&(Le||lt)){const mt=F.getTile(et);H.activeTexture.set(q.TEXTURE0),mt.texture&&mt.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE);let Vt=r.ds(je,xt,oe);const Xt=r.bh(r.dr(et.canonical)),Bt=(Yt,jt)=>Yt.draw(z,q.TRIANGLES,ye,sn.disabled,xe,an.disabled,Sp(oe.expandedFarZProjMatrix,Vt,Vt,Xt,0,_e,oe.frustumCorners.TL,oe.frustumCorners.TR,oe.frustumCorners.BR,oe.frustumCorners.BL,oe.globeCenterInViewSpace,oe.globeRadius,Te,0,oe._farZ),"globe_pole_raster",jt,st,pt);D.setupElevationDraw(mt,Y,Fe),z.uploadCommonUniforms(H,Y,et.toUnwrapped()),Le&&z.renderDefaultNorthPole&&Bt(Y,Ze),lt&&z.renderDefaultSouthPole&&(Vt=r.cE(r.bz(),Vt,[1,-1,1]),Bt(Y,dt))}}}})(_,g,b,T,A);else{const z=_.context,D=z.gl;let F,O;const U=_.shadowRenderer,H=hl(_,_.longestCutoffRange),q=xe=>{if(O===xe)return;const ye=[];ye.push(mc[xe]),H.shouldRenderCutoff&&ye.push("RENDER_CUTOFF"),U&&(ye.push("RENDER_SHADOWS","DEPTH_TEXTURE"),U.useNormalOffset&&ye.push("NORMAL_OFFSET")),F=_.getOrCreateProgram("terrainRaster",{defines:ye}),O=xe},Y=_.colorModeForRenderPass(),Z=new Ut(D.LEQUAL,Ut.ReadWrite,_.depthRangeFor3D);pc.update(A);const oe=_.transform,fe=_c(oe.zoom,g.exaggeration(),g.sourceCache._source.tileSize);let me=[0,0,0];if(U){const xe=_.style.directionalLight,ye=_.style.ambientLight;xe&&ye&&(me=Es(_.style,xe,ye))}{O=-1;const xe=D.TRIANGLES,[ye,ve]=[g.gridIndexBuffer,g.gridSegments];for(const _e of T){const we=b.getTile(_e),Te=sn.disabled,Ue=g.prevTerrainTileForTile[_e.key],Fe=g.terrainTileForTile[_e.key];Ep(Ue,Fe)&&pc.newMorphing(_e.key,Ue,Fe,A,250),z.activeTexture.set(D.TEXTURE0),we.texture&&we.texture.bind(D.LINEAR,D.CLAMP_TO_EDGE);const ot=pc.getMorphValuesForProxy(_e.key),et=ot?1:0;let xt;ot&&(xt={morphing:{srcDemTile:ot.from,dstDemTile:ot.to,phase:r.dk(ot.phase)}});const Oe=Tp(_e.projMatrix,vg(_e.canonical,oe.renderWorldCopies)?fe/10:fe,me);if(q(et),!F)continue;g.setupElevationDraw(we,F,xt);const je=_e.toUnwrapped();U&&U.setupShadows(je,F),_.uploadCommonUniforms(z,F,je,null,H),F.draw(_,xe,Z,Te,Y,an.backCCW,Oe,"terrain_raster",g.gridBuffer,ye,ve)}}}}(s,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,s.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const s=this.painter,f=this.painter.context,_=this.proxySourceCache,g=this.proxiedCoords[_.id],b=this._drapedRenderBatches.shift(),T=s.style.order,A=[];let z=0;for(const D of g){const F=_.getTileByID(D.proxyTileKey),O=_.proxyCachedFBO[D.key]?_.proxyCachedFBO[D.key][t]:void 0,U=O!==void 0?_.renderCache[O]:this.pool[z++],H=O!==void 0;if(F.texture=U.tex,H&&!U.dirty){A.push(F.tileID);continue}let q;f.bindFramebuffer.set(U.fb.framebuffer),this.renderedToTile=!1,U.dirty&&(f.clear({color:r.am.transparent,stencil:0}),U.dirty=!1);for(let Y=b.start;Y<=b.end;++Y){const Z=s.style._mergedLayers[T[Y]];if(Z.isHidden(s.transform.zoom))continue;const oe=s.style.getLayerSourceCache(Z),fe=oe?this.proxyToSource[D.key][oe.id]:[D];if(!fe)continue;const me=fe;f.viewport.set([0,0,U.fb.width,U.fb.height]),q!==(oe?oe.id:null)&&(this._setupStencil(U,fe,Z,oe),q=oe?oe.id:null),s.renderLayer(s,oe,Z,me)}if(this._drapedRenderBatches.length===0)for(const Y of this._pendingGroundEffectLayers){const Z=s.style._mergedLayers[T[Y]];if(Z.isHidden(s.transform.zoom))continue;const oe=s.style.getLayerSourceCache(Z),fe=oe?this.proxyToSource[D.key][oe.id]:[D];if(!fe)continue;const me=fe;f.viewport.set([0,0,U.fb.width,U.fb.height]),q!==(oe?oe.id:null)&&(this._setupStencil(U,fe,Z,oe),q=oe?oe.id:null),s.renderLayer(s,oe,Z,me)}this.renderedToTile?(U.dirty=!0,A.push(F.tileID)):H||--z,z===5&&(z=0,this.renderToBackBuffer(A))}return this.renderToBackBuffer(A),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,s.width,s.height]),b.end+1}postRender(){}isLayerOrderingCorrect(t){const s=t.order.length;let f=-1,_=s;for(let g=0;g<s;++g)this._style.isLayerDraped(t._mergedLayers[t.order[g]])?f=Math.max(f,g):_=Math.min(_,g);return _>f}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(s=>s.dem).forEach(s=>{t=Math.min(t,s.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,s,f){if(!this._visibleDemTiles)return null;const _=this._visibleDemTiles.filter(g=>g.dem).map(g=>{const b=g.tileID,T=1<<b.overscaledZ,{x:A,y:z}=b.canonical,D=A/T,F=(A+1)/T,O=z/T,U=(z+1)/T;return{minx:D,miny:O,maxx:F,maxy:U,t:g.dem.tree.raycastRoot(D,O,F,U,t,s,f),tile:g}});_.sort((g,b)=>(g.t!==null?g.t:Number.MAX_VALUE)-(b.t!==null?b.t:Number.MAX_VALUE));for(const g of _){if(g.t==null)return null;const b=g.tile.dem.tree.raycast(g.minx,g.miny,g.maxx,g.maxy,t,s,f);if(b!=null)return b}return null}_createFBO(){const t=this.painter.context,s=t.gl,f=this.drapeBufferSize;t.activeTexture.set(s.TEXTURE0);const _=new r.T(t,{width:f[0],height:f[1],data:null},s.RGBA8);_.bind(s.LINEAR,s.CLAMP_TO_EDGE);const g=t.createFramebuffer(f[0],f[1],!0,null);return g.colorAttachment.set(_.texture),g.depthAttachment=new wp(t,g.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,g.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):g.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&s.texParameterf(s.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:g,tex:_,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const s=this._style._mergedLayers[t],f=s.isHidden(this.painter.transform.zoom);return s.type==="hillshade"||s.type==="custom"?!f&&s.shouldRedrape():!f&&s.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const f of this._style.getSources())if(f instanceof Or){t=!0;break}if(!t)return;const s={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],g=this._style.getLayerSourceCache(_);if(g&&!s[g.id]&&!_.isHidden(this.painter.transform.zoom)&&_.type==="line"&&_.widthExpression()instanceof r.ab){s[g.id]=!0;for(const b of this.proxyCoords){const T=this.proxyToSource[b.key][g.id];if(T)for(const A of T)this._clearRenderCacheForTile(g.id,A)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof Ss){t=!0;break}if(!t)return;const s={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],g=this._style.getLayerSourceCache(_);if(!g||s[g.id]||_.isHidden(this.painter.transform.zoom)||_.type!=="raster")continue;const b=_.paint.get("raster-fade-duration");for(const T of this.proxyCoords){const A=this.proxyToSource[T.key][g.id];if(A)for(const z of A){const D=Pu(g.getTile(z),g.findLoadedParent(z,0),g,this.painter.transform,b);(D.opacity!==1||D.mix!==0)&&this._clearRenderCacheForTile(g.id,z)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,s=t.length;if(s===0)return;const f=[];this._pendingGroundEffectLayers=[];let _,g=0,b=this._style._mergedLayers[t[g]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++g<s;)b=this._style._mergedLayers[t[g]];for(;g<s;++g){const T=this._style._mergedLayers[t[g]];T.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(T)?_===void 0&&(_=g):(T.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(g),_!==void 0&&(f.push({start:_,end:g-1}),_=void 0)))}if(_!==void 0&&f.push({start:_,end:g-1}),f.length!==0){const T=f[f.length-1];this._pendingGroundEffectLayers.every(A=>A>T.end)||r.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(t){const s=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,s.renderCache.length>s.renderCachePool.length){const b=Object.values(s.proxyCachedFBO);s.proxyCachedFBO={};for(let T=0;T<b.length;++T){const A=Object.values(b[T]);s.renderCachePool.push(...A)}}return}this._clearRasterLayersFromRenderCache();const f=this.proxyCoords,_=this._tilesDirty;for(let b=f.length-1;b>=0;b--){const T=f[b];if(s.getTileByID(T.key),s.proxyCachedFBO[T.key]!==void 0){const A=t[T.key],z=this.proxyToSource[T.key];let D=0;for(const F in z){const O=z[F],U=A[F];if(!U||U.length!==O.length||O.some((H,q)=>H!==U[q]||_[F]&&_[F].hasOwnProperty(H.key))){D=-1;break}++D}for(const F in s.proxyCachedFBO[T.key])s.renderCache[s.proxyCachedFBO[T.key][F]].dirty=D<0||D!==Object.values(A).length}}const g=[...this._drapedRenderBatches];g.sort((b,T)=>T.end-T.start-(b.end-b.start));for(const b of g)for(const T of f){if(s.proxyCachedFBO[T.key])continue;let A=s.renderCachePool.pop();A===void 0&&s.renderCache.length<50&&(A=s.renderCache.length,s.renderCache.push(this._createFBO())),A!==void 0&&(s.proxyCachedFBO[T.key]={},s.proxyCachedFBO[T.key][b.start]=A,s.renderCache[A].dirty=!0)}this._tilesDirty={}}_setupStencil(t,s,f,_){if(!_||!this._sourceTilesOverlap[_.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const g=this.painter.context,b=g.gl;if(s.length<=1)return void(this._overlapStencilType=!1);let T;if(f.isTileClipped())T=s.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(s[0].overscaledZ>s[s.length-1].overscaledZ))return void(this._overlapStencilType=!1);T=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+T>255&&(g.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=T,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(s,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):sn.disabled}_renderTileClippingMasks(t,s){const f=this.painter,_=this.painter.context,g=_.gl;f._tileClippingMaskIDs={},_.setColorMode(In.disabled),_.setDepthMode(Ut.disabled);const b=f.getOrCreateProgram("clippingMask");for(const T of t){const A=f._tileClippingMaskIDs[T.key]=--s;b.draw(f,g.TRIANGLES,Ut.disabled,new sn({func:g.ALWAYS,mask:0},A,255,g.KEEP,g.KEEP,g.REPLACE),In.disabled,an.disabled,uo(T.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(t){const s=this.painter.transform;if(t.x<0||t.x>s.width||t.y<0||t.y>s.height)return null;const f=[t.x,t.y,1,1];r.aA(f,f,s.pixelMatrixInverse),r.cw(f,f,1/f[3]),f[0]/=s.worldSize,f[1]/=s.worldSize;const _=s._camera.position,g=r.c6(1,s.center.lat),b=[_[0],_[1],_[2]/g,0],T=r.cY([],f.slice(0,3),b);r.au(T,T);const A=this.raycast(b,T,this._exaggeration);return A!==null&&A?(r.bF(b,b,T,A),b[3]=b[2],b[2]*=g,b):null}_setupProxiedCoordsForOrtho(t,s,f){if(t.getSource()instanceof r.aP)return this._setupProxiedCoordsForImageSource(t,s,f);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const _=this.proxiedCoords[t.id]=[],g=this.proxyCoords;for(let A=0;A<g.length;A++){const z=g[A],D=this._findTileCoveringTileID(z,t);if(D){const F=this._createProxiedId(z,D,f[z.key]&&f[z.key][t.id]);_.push(F),this.proxyToSource[z.key][t.id]=[F]}}let b=!1;const T=new Set;for(let A=0;A<s.length;A++){const z=t.getTile(s[A]);if(!z||!z.hasData())continue;const D=this._findTileCoveringTileID(z.tileID,this.proxySourceCache);if(D&&D.tileID.canonical.z!==z.tileID.canonical.z){const F=this.proxyToSource[D.tileID.key][t.id],O=this._createProxiedId(D.tileID,z,f[D.tileID.key]&&f[D.tileID.key][t.id]);F?F.splice(F.length-1,0,O):this.proxyToSource[D.tileID.key][t.id]=[O];const U=this.proxyToSource[D.tileID.key][t.id];T.has(U)||T.add(U),_.push(O),b=!0}}if(this._sourceTilesOverlap[t.id]=b,b&&this._debugParams.sortTilesHiZFirst)for(const A of T)A.sort((z,D)=>D.overscaledZ-z.overscaledZ)}_setupProxiedCoordsForImageSource(t,s,f){if(!t.getSource().loaded())return;const _=this.proxiedCoords[t.id]=[],g=this.proxyCoords,b=t.getSource(),T=b.tileID;if(!T)return;const A=new r.P(T.x,T.y)._div(1<<T.z),z=b.coordinates.map(r.ac.fromLngLat).reduce((F,O)=>(F.min.x=Math.min(F.min.x,O.x-A.x),F.min.y=Math.min(F.min.y,O.y-A.y),F.max.x=Math.max(F.max.x,O.x-A.x),F.max.y=Math.max(F.max.y,O.y-A.y),F),{min:new r.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new r.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),D=(F,O)=>{const U=F.wrap+F.canonical.x/(1<<F.canonical.z),H=F.canonical.y/(1<<F.canonical.z),q=r.aj/(1<<F.canonical.z),Y=O.wrap+O.canonical.x/(1<<O.canonical.z),Z=O.canonical.y/(1<<O.canonical.z);return U+q<Y+z.min.x||U>Y+z.max.x||H+q<Z+z.min.y||H>Z+z.max.y};for(let F=0;F<g.length;F++){const O=g[F];for(let U=0;U<s.length;U++){const H=t.getTile(s[U]);if(!H||!H.hasData()||D(O,H.tileID))continue;const q=this._createProxiedId(O,H,f[O.key]&&f[O.key][t.id]),Y=this.proxyToSource[O.key][t.id];Y?Y.push(q):this.proxyToSource[O.key][t.id]=[q],_.push(q)}}}_createProxiedId(t,s,f){let _=this.orthoMatrix;if(f){const g=f.find(b=>b.key===s.tileID.key);if(g)return g}if(s.tileID.key!==t.key){const g=t.canonical.z-s.tileID.canonical.z;let b,T,A;_=r.bz();const z=s.tileID.wrap-t.wrap<<t.overscaledZ;g>0?(b=r.aj>>g,T=b*((s.tileID.canonical.x<<g)-t.canonical.x+z),A=b*((s.tileID.canonical.y<<g)-t.canonical.y)):(b=r.aj<<-g,T=r.aj*(s.tileID.canonical.x-(t.canonical.x+z<<-g)),A=r.aj*(s.tileID.canonical.y-(t.canonical.y<<-g))),r.c5(_,0,b,0,b,0,1),r.bo(_,_,[T,A,0])}return new df(s.tileID,t.key,_)}_findTileCoveringTileID(t,s){let f=s.getTile(t);if(f&&f.hasData())return f;const _=this._findCoveringTileCache[s.id],g=_[t.key];if(f=g?s.getTileByID(g):null,f&&f.hasData()||g===null)return f;let b=f?f.tileID:t,T=b.overscaledZ;const A=s.getSource().minzoom,z=[];if(!g){const F=s.getSource().maxzoom;if(t.canonical.z>=F){const O=t.canonical.z-F;s.getSource().reparseOverscaled?(T=Math.max(t.canonical.z+2,s.transform.tileZoom),b=new r.aM(T,t.wrap,F,t.canonical.x>>O,t.canonical.y>>O)):O!==0&&(T=F,b=new r.aM(T,t.wrap,F,t.canonical.x>>O,t.canonical.y>>O))}b.key!==t.key&&(z.push(b.key),f=s.getTile(b))}const D=F=>{z.forEach(O=>{_[O]=F}),z.length=0};for(T-=1;T>=A&&(!f||!f.hasData());T--){f&&D(f.tileID.key);const F=b.calculateScaledKey(T);if(f=s.getTileByID(F),f&&f.hasData())break;const O=_[F];if(O===null)break;O===void 0?z.push(F):f=s.getTileByID(O)}return D(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,s){let f=this._tilesDirty[t];f||(f=this._tilesDirty[t]={}),f[s.key]=!0}}function Ap(h,t,s){const f=function(T,A,z){const D=r.bE(A,T),F=r.bE(z,[.2126,.7152,.0722]),O=(H,q,Y)=>(1-Y)*H+Y*q,U=O(1-.3*Math.min(F,1),1,Math.min(D+1,1));return O(.92,1,Math.asin(r.aD(A[2],-1,1))/Math.PI+.5)*U}(h,[0,0,1],t),_=[0,0,0];r.b$(_,s.slice(0,3),f);const g=[0,0,0];r.b$(g,t.slice(0,3),h[2]);const b=[0,0,0];return r.cU(b,_,g),r.cX(b)}const mf=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Ip=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class _f{static cacheKey(t,s,f,_){let g=`${s}${_?_.cacheKey:""}`;for(const b of f)t.usedDefines.includes(b)&&(g+=`/${b}`);return g}constructor(t,s,f,_,g,b){const T=t.gl;this.program=T.createProgram(),this.configuration=_,this.name=s,this.fixedDefines=[...b];const A=_?_.getBinderAttributes():[],z=(f.staticAttributes||[]).concat(A);let D=_?_.defines():[];D=D.concat(b.map(Y=>`#define ${Y}`));const F=`#version 300 es
`;let O=F+D.concat("precision mediump float;",Iu,Ta.fragmentSource).join(`
`);for(const Y of f.fragmentIncludes)O+=`
${Xo[Y]}`;O+=`
${f.fragmentSource}`;let U=F+D.concat("precision highp float;",Iu,Ta.vertexSource).join(`
`);for(const Y of f.vertexIncludes)U+=`
${Xo[Y]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&f.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(U+=`
uniform int u_instanceID;
`),U+=`
${f.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(U=U.replaceAll("gl_InstanceID","u_instanceID"));const H=T.createShader(T.FRAGMENT_SHADER);if(T.isContextLost())return void(this.failedToCreate=!0);T.shaderSource(H,O),T.compileShader(H),T.attachShader(this.program,H);const q=T.createShader(T.VERTEX_SHADER);if(T.isContextLost())this.failedToCreate=!0;else{T.shaderSource(q,U),T.compileShader(q),T.attachShader(this.program,q),this.attributes={},this.numAttributes=z.length;for(let Y=0;Y<this.numAttributes;Y++)if(z[Y]){const Z=z[Y].startsWith("a_")?z[Y]:`a_${z[Y]}`;T.bindAttribLocation(this.program,Y,Z),this.attributes[Z]=Y}T.linkProgram(this.program),T.deleteShader(q),T.deleteShader(H),this.fixedUniforms=g(t),this.binderUniforms=_?_.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(Y=>({u_instanceID:new r.cc(Y)}))(t)),(b.includes("TERRAIN")||s.indexOf("symbol")!==-1||s.indexOf("circle")!==-1)&&(this.terrainUniforms=(Y=>({u_dem:new r.cc(Y),u_dem_prev:new r.cc(Y),u_dem_tl:new r.c9(Y),u_dem_scale:new r.cb(Y),u_dem_tl_prev:new r.c9(Y),u_dem_scale_prev:new r.cb(Y),u_dem_size:new r.cb(Y),u_dem_lerp:new r.cb(Y),u_exaggeration:new r.cb(Y),u_depth:new r.cc(Y),u_depth_size_inv:new r.c9(Y),u_depth_range_unpack:new r.c9(Y),u_occluder_half_size:new r.cb(Y),u_occlusion_depth_offset:new r.cb(Y),u_meter_to_dem:new r.cb(Y),u_label_plane_matrix_inv:new r.c8(Y)}))(t)),b.includes("GLOBE")&&(this.globeUniforms=(Y=>({u_tile_tl_up:new r.ca(Y),u_tile_tr_up:new r.ca(Y),u_tile_br_up:new r.ca(Y),u_tile_bl_up:new r.ca(Y),u_tile_up_scale:new r.cb(Y)}))(t)),b.includes("FOG")&&(this.fogUniforms=(Y=>({u_fog_matrix:new r.c8(Y),u_fog_range:new r.c9(Y),u_fog_color:new r.cQ(Y),u_fog_horizon_blend:new r.cb(Y),u_fog_vertical_limit:new r.c9(Y),u_fog_temporal_offset:new r.cb(Y),u_frustum_tl:new r.ca(Y),u_frustum_tr:new r.ca(Y),u_frustum_br:new r.ca(Y),u_frustum_bl:new r.ca(Y),u_globe_pos:new r.ca(Y),u_globe_radius:new r.cb(Y),u_globe_transition:new r.cb(Y),u_is_globe:new r.cc(Y),u_viewport:new r.c9(Y)}))(t)),b.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Y=>({u_cutoff_params:new r.cQ(Y)}))(t)),b.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Y=>({u_lighting_ambient_color:new r.ca(Y),u_lighting_directional_dir:new r.ca(Y),u_lighting_directional_color:new r.ca(Y),u_ground_radiance:new r.ca(Y)}))(t)),b.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Y=>({u_light_matrix_0:new r.c8(Y),u_light_matrix_1:new r.c8(Y),u_fade_range:new r.c9(Y),u_shadow_normal_offset:new r.ca(Y),u_shadow_intensity:new r.cb(Y),u_shadow_texel_size:new r.cb(Y),u_shadow_map_resolution:new r.cb(Y),u_shadow_direction:new r.ca(Y),u_shadow_bias:new r.ca(Y),u_shadowmap_0:new r.cc(Y),u_shadowmap_1:new r.cc(Y)}))(t))}}setTerrainUniformValues(t,s){if(!this.terrainUniforms)return;const f=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const _ in s)f[_]&&f[_].set(this.program,_,s[_])}}setGlobeUniformValues(t,s){if(!this.globeUniforms)return;const f=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const _ in s)f[_]&&f[_].set(this.program,_,s[_])}}setFogUniformValues(t,s){if(!this.fogUniforms)return;const f=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const _ in s)f[_].set(this.program,_,s[_])}}setCutoffUniformValues(t,s){if(!this.cutoffUniforms)return;const f=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const _ in s)f[_].set(this.program,_,s[_])}}setLightsUniformValues(t,s){if(!this.lightsUniforms)return;const f=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const _ in s)f[_].set(this.program,_,s[_])}}setShadowUniformValues(t,s){if(this.failedToCreate||!this.shadowUniforms)return;const f=this.shadowUniforms;t.program.set(this.program);for(const _ in s)f[_].set(this.program,_,s[_])}_drawDebugWireframe(t,s,f,_,g,b,T,A,z,D){const F=t.options.wireframe;if(F.terrain===!1&&F.layers2D===!1&&F.layers3D===!1)return;const O=t.context;if(!(!(!F.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!F.layers2D||t._terrain&&t._terrain.renderingToTexture||!mf.includes(this.name))||!(!F.layers3D||!Ip.includes(this.name))))return;const U=O.gl,H=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,g,O);if(!H)return;const q=[...this.fixedDefines];q.push("DEBUG_WIREFRAME");const Y=t.getOrCreateProgram(this.name,{config:this.configuration,defines:q});O.program.set(Y.program);const Z=(me,xe,ye)=>{if(xe[me]&&ye[me])for(const ve in xe[me])ye[me][ve]&&ye[me][ve].set(ye.program,ve,xe[me][ve].current)};z&&z.setUniforms(Y.program,O,Y.binderUniforms,T,{zoom:A}),Z("fixedUniforms",this,Y),Z("terrainUniforms",this,Y),Z("globeUniforms",this,Y),Z("fogUniforms",this,Y),Z("lightsUniforms",this,Y),Z("shadowUniforms",this,Y),H.bind(),O.setColorMode(new In([U.ONE,U.ONE_MINUS_SRC_ALPHA,U.ZERO,U.ONE],r.am.transparent,[!0,!0,!0,!1])),O.setDepthMode(new Ut(s.func===U.LESS?U.LEQUAL:s.func,Ut.ReadOnly,s.range)),O.setStencilMode(sn.disabled);const oe=3*b.primitiveLength*2,fe=3*b.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const me=D||1;for(let xe=0;xe<me;++xe)Y.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",xe),U.drawElements(U.LINES,oe,U.UNSIGNED_SHORT,fe)}else D&&D>1?U.drawElementsInstanced(U.LINES,oe,U.UNSIGNED_SHORT,fe,D):U.drawElements(U.LINES,oe,U.UNSIGNED_SHORT,fe);g.bind(),O.program.set(this.program),O.setDepthMode(s),O.setStencilMode(f),O.setColorMode(_)}checkUniforms(t,s,f){if(this.fixedDefines.includes(s)){for(const _ of Object.keys(f))if(!f[_].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${_} not set but required by ${s} being defined`)}}draw(t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y){const Z=t.context,oe=Z.gl;if(this.failedToCreate)return;Z.program.set(this.program),Z.setDepthMode(f),Z.setStencilMode(_),Z.setColorMode(g),Z.setCullFace(b);for(const xe of Object.keys(this.fixedUniforms))this.fixedUniforms[xe].set(this.program,xe,T[xe]);H&&H.setUniforms(this.program,Z,this.binderUniforms,O,{zoom:U});const fe={[oe.POINTS]:1,[oe.LINES]:2,[oe.TRIANGLES]:3,[oe.LINE_STRIP]:1}[s];this.checkUniforms(A,"RENDER_SHADOWS",this.shadowUniforms);const me=Y&&Y>0?1:void 0;for(const xe of F.get()){const ye=xe.vaos||(xe.vaos={});if((ye[A]||(ye[A]=new fp)).bind(Z,this,z,H?H.getPaintVertexBuffers():[],D,xe.vertexOffset,q||[],me),this.forceManualRenderingForInstanceIDShaders){const ve=Y||1;for(let _e=0;_e<ve;++_e)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",_e),D?oe.drawElements(s,xe.primitiveLength*fe,oe.UNSIGNED_SHORT,xe.primitiveOffset*fe*2):oe.drawArrays(s,xe.vertexOffset,xe.vertexLength)}else Y&&Y>1?oe.drawElementsInstanced(s,xe.primitiveLength*fe,oe.UNSIGNED_SHORT,xe.primitiveOffset*fe*2,Y):D?oe.drawElements(s,xe.primitiveLength*fe,oe.UNSIGNED_SHORT,xe.primitiveOffset*fe*2):oe.drawArrays(s,xe.vertexOffset,xe.vertexLength);s===oe.TRIANGLES&&D&&this._drawDebugWireframe(t,f,_,g,D,xe,O,U,H,Y)}}}function zu(h,t,s=0){const f=Math.pow(2,t.tileID.overscaledZ),_=t.tileSize*Math.pow(2,h.transform.tileZoom)/f,g=_*(t.tileID.canonical.x+t.tileID.wrap*f),b=_*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/r.aw(t,1,h.transform.tileZoom),u_pixel_coord_upper:[g>>16,b>>16],u_pixel_coord_lower:[65535&g,65535&b],u_pattern_transition:s}}const Ru={terrain:0,flat:1},xg=r.bz(),ml=(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z)=>{const oe=t.style.light,fe=oe.properties.get("position"),me=[fe.x,fe.y,fe.z],xe=r.dx();oe.properties.get("anchor")==="viewport"&&(r.dy(xe,-t.transform.angle),r.dz(me,me,xe));const ye=oe.properties.get("color"),ve=t.transform,_e={u_matrix:h,u_lightpos:me,u_lightintensity:oe.properties.get("intensity"),u_lightcolor:[ye.r,ye.g,ye.b],u_vertical_gradient:+s,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:xg,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Ru[z],u_base_type:Ru[D],u_ao:_,u_edge_radius:g,u_width_scale:b,u_flood_light_color:H,u_vertical_scale:q,u_flood_light_intensity:Y,u_ground_shadow_factor:Z};return ve.projection.name==="globe"&&(_e.u_tile_id=[T.canonical.x,T.canonical.y,1<<T.canonical.z],_e.u_zoom_transition=F,_e.u_inv_rot_matrix=U,_e.u_merc_center=O,_e.u_up_dir=ve.projection.upVector(new r.cp(0,0,0),O[0]*r.aj,O[1]*r.aj),_e.u_height_lift=A),_e},Wx=(h,t,s,f,_,g)=>({u_matrix:h,u_edge_radius:t,u_width_scale:s,u_vertical_scale:f,u_height_type:Ru[_],u_base_type:Ru[g]}),Xx=(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z)=>{const oe=ml(h,t,s,f,_,g,b,T,z,D,F,O,U,H,q,Y,1,[0,0,0]),fe={u_height_factor:-Math.pow(2,T.overscaledZ)/A.tileSize/8};return r.l(oe,zu(t,A,Z),fe)},bg=(h,t,s)=>({u_matrix:h,u_emissive_strength:t,u_ground_shadow_factor:s}),wg=(h,t,s,f,_,g=0)=>r.l(bg(h,t,_),zu(s,f,g)),Yx=(h,t,s,f)=>({u_matrix:h,u_world:s,u_emissive_strength:t,u_ground_shadow_factor:f}),Kx=(h,t,s,f,_,g,b=0)=>r.l(wg(h,t,s,f,g,b),{u_world:_}),Mp=(h,t)=>({u_matrix:h,u_ground_shadow_factor:t}),Du=(h,t,s,f,_)=>({u_matrix:h,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:s,u_height_scale:f,u_reset_depth:_}),Tg=(h,t,s,f)=>{const _=r.aj/s.tileSize;return{u_matrix:h,u_camera_to_center_distance:t.getCameraToCenterDistance(f),u_extrude_scale:[t.pixelsToGLUnits[0]/_,t.pixelsToGLUnits[1]/_]}},_l=(h,t,s=1)=>({u_matrix:h,u_color:t.toRenderColor(null),u_overlay:0,u_overlay_scale:s}),Sg=r.bz(),Eg=(h,t,s,f,_,g,b)=>{const T=h.transform,A=T.projection.name==="globe",z=A?r.dA(T.zoom,t.canonical)*T._pixelsPerMercatorPixel:r.aw(s,1,g),D={u_matrix:t.projMatrix,u_extrude_scale:z,u_intensity:b,u_inv_rot_matrix:Sg,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(A){D.u_inv_rot_matrix=f,D.u_merc_center=_,D.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],D.u_zoom_transition=r.ah(T.zoom);const F=_[0]*r.aj,O=_[1]*r.aj;D.u_up_dir=T.projection.upVector(new r.cp(0,0,0),F,O)}return D};function Cp(h,[t,s,f,_],[g,b]){if(g===b)return[0,0,0,0];const T=255*(h-1)/(h*(b-g));return[t*T,s*T,f*T,_*T]}function gf(h,t,[s,f]){return s===f?0:.5/h+(t-s)*(h-1)/(h*(f-s))}const Sa=(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe,fe,me)=>({u_matrix:h,u_normalize_matrix:t,u_globe_matrix:s,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:g,u_scale_parent:z,u_fade_t:D.mix,u_opacity:D.opacity*F.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:F.paint.get("raster-brightness-min"),u_brightness_high:F.paint.get("raster-brightness-max"),u_saturation_factor:r.dB(F.paint.get("raster-saturation")),u_contrast_factor:r.dC(F.paint.get("raster-contrast")),u_spin_weights:Ag(F.paint.get("raster-hue-rotate")),u_perspective_transform:O,u_raster_elevation:U,u_zoom_transition:b,u_merc_center:T,u_cutoff_params:A,u_colorization_mix:Cp(r.dD,q,Z),u_colorization_offset:gf(r.dD,Y,Z),u_color_ramp:H,u_texture_offset:[fe/(oe+2*fe),oe/(oe+2*fe)],u_texture_res:[oe+2*fe,oe+2*fe],u_emissive_strength:me});function Ag(h){h*=Math.PI/180;const t=Math.sin(h),s=Math.cos(h);return[(2*s+1)/3,(-Math.sqrt(3)*t-s+1)/3,(Math.sqrt(3)*t-s+1)/3]}const Co=.05,Pp=(h,t,s,f,_,g,b,T,A,z,D,F)=>({u_matrix:h,u_normalize_matrix:t,u_globe_matrix:s,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:g,u_scale_parent:z,u_fade_t:D.mix,u_opacity:D.opacity,u_image0:0,u_image1:1,u_raster_elevation:F,u_zoom_transition:b,u_merc_center:T,u_cutoff_params:A}),yf=(h,t,s,f,_,g,b,T,A,z)=>({u_particle_texture:h,u_particle_texture_side_len:t,u_tile_offset:s,u_velocity:f,u_color_ramp:g,u_velocity_res:_,u_max_speed:b,u_uv_offset:T,u_data_scale:[255*A[0],255*A[1]],u_data_offset:z,u_particle_pos_scale:1.1,u_particle_pos_offset:[Co,Co]}),Ig=(h,t,s,f,_,g,b,T,A,z)=>({u_particle_texture:h,u_particle_texture_side_len:t,u_velocity:s,u_velocity_res:f,u_max_speed:_,u_speed_factor:g,u_reset_rate:b,u_rand_seed:Math.random(),u_uv_offset:T,u_data_scale:[255*A[0],255*A[1]],u_data_offset:z,u_particle_pos_scale:1.1,u_particle_pos_offset:[Co,Co]}),zp=r.bz(),vf=(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe,fe,me,xe,ye)=>{const ve=_.transform,_e={u_is_size_zoom_constant:+(h==="constant"||h==="source"),u_is_size_feature_constant:+(h==="constant"||h==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:ve.getCameraToCenterDistance(oe),u_rotate_symbol:+s,u_aspect_ratio:ve.width/ve.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_matrix:g,u_label_plane_matrix:b,u_coord_matrix:T,u_is_text:+z,u_elevation_from_sea:A?1:0,u_pitch_with_map:+f,u_texsize:D,u_texsize_icon:F,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:zp,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:zp,u_up_vector:[0,-1,0],u_color_adj_mat:me,u_icon_transition:xe||0,u_gamma_scale:f?_.transform.getCameraToCenterDistance(oe)*Math.cos(_.terrain?0:_.transform._pitch):1,u_device_pixel_ratio:r.q.devicePixelRatio,u_is_halo:1,u_scale_factor:ye||1,u_ground_shadow_factor:fe,u_inv_matrix:r.bi(r.bz(),b)};return oe.name==="globe"&&(_e.u_tile_id=[U.canonical.x,U.canonical.y,1<<U.canonical.z],_e.u_zoom_transition=H,_e.u_inv_rot_matrix=Y,_e.u_merc_center=q,_e.u_camera_forward=ve._camera.forward(),_e.u_ecef_origin=r.dE(ve.globeMatrix,U.toUnwrapped()),_e.u_tile_matrix=Float32Array.from(ve.globeMatrix),_e.u_up_vector=Z),_e},xf=(h,t,s,f)=>({u_matrix:h,u_emissive_strength:t,u_opacity:s,u_color:f}),Mg=(h,t,s,f,_,g,b,T,A)=>r.l(function(z,D,F,O,U,H){const{width:q,height:Y}=O.imageManager.getPixelSize(D),Z=Math.pow(2,H.tileID.overscaledZ),oe=H.tileSize*Math.pow(2,O.transform.tileZoom)/Z,fe=oe*(H.tileID.canonical.x+H.tileID.wrap*Z),me=oe*H.tileID.canonical.y;return{u_image:0,u_pattern_tl:F.tl,u_pattern_br:F.br,u_texsize:[q,Y],u_pattern_size:F.displaySize,u_pattern_units_to_pixels:U?[O.transform.width,-1*O.transform.height]:[1/r.aw(H,1,O.transform.tileZoom),1/r.aw(H,1,O.transform.tileZoom)],u_pixel_coord_upper:[fe>>16,me>>16],u_pixel_coord_lower:[65535&fe,65535&me]}}(0,g,b,f,T,A),{u_matrix:h,u_emissive_strength:t,u_opacity:s}),bf=new Float32Array(r.bx([])),gl=(h,t,s,f,_,g,b,T,A,z,D,F,O,U=[0,0,0],H)=>{const q=_.style.light,Y=q.properties.get("position"),Z=[-Y.x,-Y.y,Y.z],oe=r.dx();q.properties.get("anchor")==="viewport"&&(r.dy(oe,-_.transform.angle),r.dz(Z,Z,oe));const fe=D.alphaMode==="MASK",me=q.properties.get("color").toRenderColor(null),xe=O.paint.get("model-ambient-occlusion-intensity"),ye=O.paint.get("model-color").constantOr(r.am.white).toRenderColor(null),ve=O.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:h,u_lighting_matrix:t,u_normal_matrix:s,u_node_matrix:f||bf,u_lightpos:Z,u_lightintensity:q.properties.get("intensity"),u_lightcolor:[me.r,me.g,me.b],u_camera_pos:U,u_opacity:g,u_baseTextureIsAlpha:0,u_alphaMask:+fe,u_alphaCutoff:D.alphaCutoff,u_baseColorFactor:[b.r,b.g,b.b,b.a],u_emissiveFactor:[T[0],T[1],T[2],1],u_metallicFactor:A,u_roughnessFactor:z,u_baseColorTexture:Jr.BaseColor,u_metallicRoughnessTexture:Jr.MetallicRoughness,u_normalTexture:Jr.Normal,u_occlusionTexture:Jr.Occlusion,u_emissionTexture:Jr.Emission,u_lutTexture:Jr.LUT,u_color_mix:[ye.r,ye.g,ye.b,ve],u_aoIntensity:xe,u_emissive_strength:F,u_occlusionTextureTransform:H||[0,0,0,0]}},Cg=(h,t=bf,s=bf)=>({u_matrix:h,u_instance:t,u_node_matrix:s}),Jx={fillExtrusion:h=>({u_matrix:new r.c8(h),u_lightpos:new r.ca(h),u_lightintensity:new r.cb(h),u_lightcolor:new r.ca(h),u_vertical_gradient:new r.cb(h),u_opacity:new r.cb(h),u_edge_radius:new r.cb(h),u_width_scale:new r.cb(h),u_ao:new r.c9(h),u_height_type:new r.cc(h),u_base_type:new r.cc(h),u_tile_id:new r.ca(h),u_zoom_transition:new r.cb(h),u_inv_rot_matrix:new r.c8(h),u_merc_center:new r.c9(h),u_up_dir:new r.ca(h),u_height_lift:new r.cb(h),u_flood_light_color:new r.ca(h),u_vertical_scale:new r.cb(h),u_flood_light_intensity:new r.cb(h),u_ground_shadow_factor:new r.ca(h)}),fillExtrusionDepth:h=>({u_matrix:new r.c8(h),u_edge_radius:new r.cb(h),u_width_scale:new r.cb(h),u_vertical_scale:new r.cb(h),u_height_type:new r.cc(h),u_base_type:new r.cc(h)}),fillExtrusionPattern:h=>({u_matrix:new r.c8(h),u_lightpos:new r.ca(h),u_lightintensity:new r.cb(h),u_lightcolor:new r.ca(h),u_vertical_gradient:new r.cb(h),u_height_factor:new r.cb(h),u_edge_radius:new r.cb(h),u_width_scale:new r.cb(h),u_ao:new r.c9(h),u_height_type:new r.cc(h),u_base_type:new r.cc(h),u_tile_id:new r.ca(h),u_zoom_transition:new r.cb(h),u_inv_rot_matrix:new r.c8(h),u_merc_center:new r.c9(h),u_up_dir:new r.ca(h),u_height_lift:new r.cb(h),u_image:new r.cc(h),u_texsize:new r.c9(h),u_pixel_coord_upper:new r.c9(h),u_pixel_coord_lower:new r.c9(h),u_tile_units_to_pixels:new r.cb(h),u_opacity:new r.cb(h),u_pattern_transition:new r.cb(h)}),fillExtrusionGroundEffect:h=>({u_matrix:new r.c8(h),u_opacity:new r.cb(h),u_ao_pass:new r.cb(h),u_meter_to_tile:new r.cb(h),u_ao:new r.c9(h),u_flood_light_intensity:new r.cb(h),u_flood_light_color:new r.ca(h),u_attenuation:new r.cb(h),u_edge_radius:new r.cb(h),u_fb:new r.cc(h),u_fb_size:new r.cb(h),u_dynamic_offset:new r.cb(h)}),fill:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_ground_shadow_factor:new r.ca(h)}),fillPattern:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_image:new r.cc(h),u_texsize:new r.c9(h),u_pixel_coord_upper:new r.c9(h),u_pixel_coord_lower:new r.c9(h),u_tile_units_to_pixels:new r.cb(h),u_ground_shadow_factor:new r.ca(h),u_pattern_transition:new r.cb(h)}),fillOutline:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_world:new r.c9(h),u_ground_shadow_factor:new r.ca(h)}),fillOutlinePattern:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_world:new r.c9(h),u_image:new r.cc(h),u_texsize:new r.c9(h),u_pixel_coord_upper:new r.c9(h),u_pixel_coord_lower:new r.c9(h),u_tile_units_to_pixels:new r.cb(h),u_ground_shadow_factor:new r.ca(h),u_pattern_transition:new r.cb(h)}),building:h=>({u_matrix:new r.c8(h),u_normal_matrix:new r.c8(h),u_opacity:new r.cb(h)}),buildingDepth:h=>({u_matrix:new r.c8(h)}),elevatedStructuresDepth:h=>({u_matrix:new r.c8(h),u_depth_bias:new r.cb(h)}),elevatedStructures:h=>({u_matrix:new r.c8(h),u_ground_shadow_factor:new r.ca(h)}),elevatedStructuresDepthReconstruct:h=>({u_matrix:new r.c8(h),u_camera_pos:new r.ca(h),u_depth_bias:new r.cb(h),u_height_scale:new r.cb(h),u_reset_depth:new r.cb(h)}),circle:r.dF,collisionBox:h=>({u_matrix:new r.c8(h),u_camera_to_center_distance:new r.cb(h),u_extrude_scale:new r.c9(h)}),collisionCircle:h=>({u_matrix:new r.c8(h),u_inv_matrix:new r.c8(h),u_camera_to_center_distance:new r.cb(h),u_viewport_size:new r.c9(h)}),debug:h=>({u_color:new r.di(h),u_matrix:new r.c8(h),u_overlay:new r.cc(h),u_overlay_scale:new r.cb(h)}),clippingMask:h=>({u_matrix:new r.c8(h)}),heatmap:h=>({u_extrude_scale:new r.cb(h),u_intensity:new r.cb(h),u_matrix:new r.c8(h),u_inv_rot_matrix:new r.c8(h),u_merc_center:new r.c9(h),u_tile_id:new r.ca(h),u_zoom_transition:new r.cb(h),u_up_dir:new r.ca(h)}),heatmapTexture:h=>({u_image:new r.cc(h),u_color_ramp:new r.cc(h),u_opacity:new r.cb(h)}),hillshade:h=>({u_matrix:new r.c8(h),u_image:new r.cc(h),u_latrange:new r.c9(h),u_light:new r.c9(h),u_shadow:new r.di(h),u_highlight:new r.di(h),u_emissive_strength:new r.cb(h),u_accent:new r.di(h)}),hillshadePrepare:h=>({u_matrix:new r.c8(h),u_image:new r.cc(h),u_dimension:new r.c9(h),u_zoom:new r.cb(h)}),line:r.dG,linePattern:r.dH,raster:h=>({u_matrix:new r.c8(h),u_normalize_matrix:new r.c8(h),u_globe_matrix:new r.c8(h),u_merc_matrix:new r.c8(h),u_grid_matrix:new r.dj(h),u_tl_parent:new r.c9(h),u_scale_parent:new r.cb(h),u_fade_t:new r.cb(h),u_opacity:new r.cb(h),u_image0:new r.cc(h),u_image1:new r.cc(h),u_brightness_low:new r.cb(h),u_brightness_high:new r.cb(h),u_saturation_factor:new r.cb(h),u_contrast_factor:new r.cb(h),u_spin_weights:new r.ca(h),u_perspective_transform:new r.c9(h),u_raster_elevation:new r.cb(h),u_zoom_transition:new r.cb(h),u_merc_center:new r.c9(h),u_cutoff_params:new r.cQ(h),u_colorization_mix:new r.cQ(h),u_colorization_offset:new r.cb(h),u_color_ramp:new r.cc(h),u_texture_offset:new r.c9(h),u_texture_res:new r.c9(h),u_emissive_strength:new r.cb(h)}),rasterParticle:h=>({u_matrix:new r.c8(h),u_normalize_matrix:new r.c8(h),u_globe_matrix:new r.c8(h),u_merc_matrix:new r.c8(h),u_grid_matrix:new r.dj(h),u_tl_parent:new r.c9(h),u_scale_parent:new r.cb(h),u_fade_t:new r.cb(h),u_opacity:new r.cb(h),u_image0:new r.cc(h),u_image1:new r.cc(h),u_raster_elevation:new r.cb(h),u_zoom_transition:new r.cb(h),u_merc_center:new r.c9(h),u_cutoff_params:new r.cQ(h)}),rasterParticleTexture:h=>({u_texture:new r.cc(h),u_opacity:new r.cb(h)}),rasterParticleDraw:h=>({u_particle_texture:new r.cc(h),u_particle_texture_side_len:new r.cb(h),u_tile_offset:new r.c9(h),u_velocity:new r.cc(h),u_color_ramp:new r.cc(h),u_velocity_res:new r.c9(h),u_max_speed:new r.cb(h),u_uv_offset:new r.c9(h),u_data_scale:new r.c9(h),u_data_offset:new r.cb(h),u_particle_pos_scale:new r.cb(h),u_particle_pos_offset:new r.c9(h)}),rasterParticleUpdate:h=>({u_particle_texture:new r.cc(h),u_particle_texture_side_len:new r.cb(h),u_velocity:new r.cc(h),u_velocity_res:new r.c9(h),u_max_speed:new r.cb(h),u_speed_factor:new r.cb(h),u_reset_rate:new r.cb(h),u_rand_seed:new r.cb(h),u_uv_offset:new r.c9(h),u_data_scale:new r.c9(h),u_data_offset:new r.cb(h),u_particle_pos_scale:new r.cb(h),u_particle_pos_offset:new r.c9(h)}),symbol:h=>({u_is_size_zoom_constant:new r.cc(h),u_is_size_feature_constant:new r.cc(h),u_size_t:new r.cb(h),u_size:new r.cb(h),u_camera_to_center_distance:new r.cb(h),u_rotate_symbol:new r.cc(h),u_aspect_ratio:new r.cb(h),u_fade_change:new r.cb(h),u_matrix:new r.c8(h),u_label_plane_matrix:new r.c8(h),u_coord_matrix:new r.c8(h),u_is_text:new r.cc(h),u_elevation_from_sea:new r.cc(h),u_pitch_with_map:new r.cc(h),u_texsize:new r.c9(h),u_texsize_icon:new r.c9(h),u_texture:new r.cc(h),u_texture_icon:new r.cc(h),u_gamma_scale:new r.cb(h),u_device_pixel_ratio:new r.cb(h),u_tile_id:new r.ca(h),u_zoom_transition:new r.cb(h),u_inv_rot_matrix:new r.c8(h),u_merc_center:new r.c9(h),u_camera_forward:new r.ca(h),u_tile_matrix:new r.c8(h),u_up_vector:new r.ca(h),u_ecef_origin:new r.ca(h),u_is_halo:new r.cc(h),u_icon_transition:new r.cb(h),u_color_adj_mat:new r.c8(h),u_scale_factor:new r.cb(h),u_ground_shadow_factor:new r.ca(h),u_inv_matrix:new r.c8(h)}),background:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_opacity:new r.cb(h),u_color:new r.di(h)}),backgroundPattern:h=>({u_matrix:new r.c8(h),u_emissive_strength:new r.cb(h),u_opacity:new r.cb(h),u_image:new r.cc(h),u_pattern_tl:new r.c9(h),u_pattern_br:new r.c9(h),u_texsize:new r.c9(h),u_pattern_size:new r.c9(h),u_pixel_coord_upper:new r.c9(h),u_pixel_coord_lower:new r.c9(h),u_pattern_units_to_pixels:new r.c9(h)}),terrainRaster:h=>({u_matrix:new r.c8(h),u_image0:new r.cc(h),u_skirt_height:new r.cb(h),u_ground_shadow_factor:new r.ca(h)}),skybox:h=>({u_matrix:new r.c8(h),u_sun_direction:new r.ca(h),u_cubemap:new r.cc(h),u_opacity:new r.cb(h),u_temporal_offset:new r.cb(h)}),skyboxGradient:h=>({u_matrix:new r.c8(h),u_color_ramp:new r.cc(h),u_center_direction:new r.ca(h),u_radius:new r.cb(h),u_opacity:new r.cb(h),u_temporal_offset:new r.cb(h)}),skyboxCapture:h=>({u_matrix_3f:new r.dj(h),u_sun_direction:new r.ca(h),u_sun_intensity:new r.cb(h),u_color_tint_r:new r.cQ(h),u_color_tint_m:new r.cQ(h),u_luminance:new r.cb(h)}),globeRaster:h=>({u_proj_matrix:new r.c8(h),u_globe_matrix:new r.c8(h),u_normalize_matrix:new r.c8(h),u_merc_matrix:new r.c8(h),u_zoom_transition:new r.cb(h),u_merc_center:new r.c9(h),u_image0:new r.cc(h),u_grid_matrix:new r.dj(h),u_skirt_height:new r.cb(h),u_far_z_cutoff:new r.cb(h),u_frustum_tl:new r.ca(h),u_frustum_tr:new r.ca(h),u_frustum_br:new r.ca(h),u_frustum_bl:new r.ca(h),u_globe_pos:new r.ca(h),u_globe_radius:new r.cb(h),u_viewport:new r.c9(h)}),globeAtmosphere:h=>({u_frustum_tl:new r.ca(h),u_frustum_tr:new r.ca(h),u_frustum_br:new r.ca(h),u_frustum_bl:new r.ca(h),u_horizon:new r.cb(h),u_transition:new r.cb(h),u_fadeout_range:new r.cb(h),u_color:new r.cQ(h),u_high_color:new r.cQ(h),u_space_color:new r.cQ(h),u_temporal_offset:new r.cb(h),u_horizon_angle:new r.cb(h)}),model:h=>({u_matrix:new r.c8(h),u_lighting_matrix:new r.c8(h),u_normal_matrix:new r.c8(h),u_node_matrix:new r.c8(h),u_lightpos:new r.ca(h),u_lightintensity:new r.cb(h),u_lightcolor:new r.ca(h),u_camera_pos:new r.ca(h),u_opacity:new r.cb(h),u_baseColorFactor:new r.cQ(h),u_emissiveFactor:new r.cQ(h),u_metallicFactor:new r.cb(h),u_roughnessFactor:new r.cb(h),u_baseTextureIsAlpha:new r.cc(h),u_alphaMask:new r.cc(h),u_alphaCutoff:new r.cb(h),u_baseColorTexture:new r.cc(h),u_metallicRoughnessTexture:new r.cc(h),u_normalTexture:new r.cc(h),u_occlusionTexture:new r.cc(h),u_emissionTexture:new r.cc(h),u_lutTexture:new r.cc(h),u_color_mix:new r.cQ(h),u_aoIntensity:new r.cb(h),u_emissive_strength:new r.cb(h),u_occlusionTextureTransform:new r.cQ(h)}),modelDepth:h=>({u_matrix:new r.c8(h),u_instance:new r.c8(h),u_node_matrix:new r.c8(h)}),groundShadow:h=>({u_matrix:new r.c8(h),u_ground_shadow_factor:new r.ca(h)}),stars:h=>({u_matrix:new r.c8(h),u_up:new r.ca(h),u_right:new r.ca(h),u_intensity_multiplier:new r.cb(h)}),snowParticle:h=>({u_modelview:new r.c8(h),u_projection:new r.c8(h),u_time:new r.cb(h),u_cam_pos:new r.ca(h),u_velocityConeAperture:new r.cb(h),u_velocity:new r.cb(h),u_horizontalOscillationRadius:new r.cb(h),u_horizontalOscillationRate:new r.cb(h),u_boxSize:new r.cb(h),u_billboardSize:new r.cb(h),u_simpleShapeParameters:new r.c9(h),u_screenSize:new r.c9(h),u_thinningCenterPos:new r.c9(h),u_thinningShape:new r.ca(h),u_thinningAffectedRatio:new r.cb(h),u_thinningParticleOffset:new r.cb(h),u_particleColor:new r.cQ(h),u_direction:new r.ca(h)}),rainParticle:h=>({u_modelview:new r.c8(h),u_projection:new r.c8(h),u_time:new r.cb(h),u_cam_pos:new r.ca(h),u_texScreen:new r.cc(h),u_velocityConeAperture:new r.cb(h),u_velocity:new r.cb(h),u_boxSize:new r.cb(h),u_rainDropletSize:new r.c9(h),u_distortionStrength:new r.cb(h),u_rainDirection:new r.ca(h),u_color:new r.cQ(h),u_screenSize:new r.c9(h),u_thinningCenterPos:new r.c9(h),u_thinningShape:new r.ca(h),u_thinningAffectedRatio:new r.cb(h),u_thinningParticleOffset:new r.cb(h),u_shapeDirectionalPower:new r.cb(h),u_shapeNormalPower:new r.cb(h),u_mode:new r.cb(h)}),vignette:h=>({u_vignetteShape:new r.ca(h),u_vignetteColor:new r.cQ(h)}),occlusion:h=>({u_matrix:new r.c8(h),u_anchorPos:new r.ca(h),u_screenSizePx:new r.c9(h),u_occluderSizePx:new r.c9(h),u_color:new r.cQ(h)})};class Ys{constructor(t,s,f,_){this.id=Ys.uniqueIdxCounter,Ys.uniqueIdxCounter++,this.context=t;const g=t.gl;this.buffer=g.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?g.DYNAMIC_DRAW:g.STATIC_DRAW),this.dynamicDraw||_||s.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=Ys.uniqueIdxCounter,Ys.uniqueIdxCounter++;const s=this.context.gl;this.context.unbindVAO(),this.bind(),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Ys.uniqueIdxCounter=0;const Qx={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Rp{constructor(t,s,f,_,g,b){this.length=s.length,this.attributes=f,this.itemSize=s.bytesPerElement,this.dynamicDraw=_,this.instanceCount=b,this.context=t;const T=t.gl;this.buffer=T.createBuffer(),t.bindVertexBuffer.set(this.buffer),T.bufferData(T.ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?T.DYNAMIC_DRAW:T.STATIC_DRAW),this.dynamicDraw||g||s.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const s=this.context.gl;this.bind(),s.bufferSubData(s.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,s){for(let f=0;f<this.attributes.length;f++){const _=s.attributes[this.attributes[f].name];_!==void 0&&t.enableVertexAttribArray(_)}}setVertexAttribPointers(t,s,f){for(let _=0;_<this.attributes.length;_++){const g=this.attributes[_],b=s.attributes[g.name];b!==void 0&&t.vertexAttribPointer(b,g.components,t[Qx[g.type]],!1,this.itemSize,g.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(t,s,f){for(let _=0;_<this.attributes.length;_++){const g=s.attributes[this.attributes[_].name];g!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(g,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class wf{constructor(t,s,f,_,g){this.context=t,this.width=s,this.height=f;const b=this.framebuffer=t.gl.createFramebuffer();_&&(this.colorAttachment=new Zx(t,b)),g&&(this.depthAttachmentType=g,this.depthAttachment=g==="renderbuffer"?new uf(t,b):new bp(t,b))}destroy(){const t=this.context.gl;if(this.colorAttachment){const s=this.colorAttachment.get();s&&t.deleteTexture(s)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const s=this.depthAttachment.get();s&&t.deleteRenderbuffer(s)}else{const s=this.depthAttachment.get();s&&t.deleteTexture(s)}t.deleteFramebuffer(this.framebuffer)}}class gc{constructor(t,s){this.gl=t,this.clearColor=new Ux(this),this.clearDepth=new jx(this),this.clearStencil=new $x(this),this.colorMask=new hg(this),this.depthMask=new Gx(this),this.stencilMask=new rf(this),this.stencilFunc=new qx(this),this.stencilOp=new fg(this),this.stencilTest=new mp(this),this.depthRange=new of(this),this.depthTest=new _p(this),this.depthFunc=new pl(this),this.blend=new gp(this),this.blendFunc=new dg(this),this.blendColor=new hc(this),this.blendEquation=new Mu(this),this.cullFace=new sf(this),this.cullFaceSide=new af(this),this.frontFace=new fc(this),this.program=new lf(this),this.activeTexture=new yp(this),this.viewport=new pg(this),this.bindFramebuffer=new vp(this),this.bindRenderbuffer=new cf(this),this.bindTexture=new Cu(this),this.bindVertexBuffer=new mg(this),this.bindElementBuffer=new _g(this),this.bindVertexArrayOES=new gg(this),this.pixelStoreUnpack=new dc(this),this.pixelStoreUnpackPremultiplyAlpha=new yg(this),this.pixelStoreUnpackFlipY=new Hx(this),this.options=s?Object.assign({},s):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=s&&!!s.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,s,f){return new Ys(this,t,s,f)}createVertexBuffer(t,s,f,_,g){return new Rp(this,t,s,f,_,g)}createRenderbuffer(t,s,f){const _=this.gl,g=_.createRenderbuffer();return this.bindRenderbuffer.set(g),_.renderbufferStorage(_.RENDERBUFFER,t,s,f),this.bindRenderbuffer.set(null),g}createFramebuffer(t,s,f,_){return new wf(this,t,s,f,_)}clear({color:t,depth:s,stencil:f,colorMask:_}){const g=this.gl;let b=0;t&&(b|=g.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(_||[!0,!0,!0,!0])),s!==void 0&&(b|=g.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(s),this.depthMask.set(!0)),f!==void 0&&(b|=g.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),g.clear(b)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){r.bv(t.blendFunction,In.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let yl;function yc(h,t,s,f,_,g,b){const T=h.context,A=T.gl,z=h.transform,D=h.getOrCreateProgram("collisionBox"),F=[];let O=0,U=0;for(let me=0;me<f.length;me++){const xe=f[me],ye=t.getTile(xe),ve=ye.getBucket(s);if(!ve)continue;const _e=Xh(xe,ve,z);let we=_e;_[0]===0&&_[1]===0||(we=h.translatePosMatrix(_e,ye,_,g));const Te=b?ve.textCollisionBox:ve.iconCollisionBox,Ue=ve.collisionCircleArray;if(Ue.length>0){const Fe=r.bz(),ot=we;r.cB(Fe,ve.placementInvProjMatrix,z.glCoordMatrix),r.cB(Fe,Fe,ve.placementViewportMatrix),F.push({circleArray:Ue,circleOffset:U,transform:ot,invTransform:Fe,projection:ve.getProjection()}),O+=Ue.length/4,U=O}Te&&(h.terrain&&h.terrain.setupElevationDraw(ye,D),D.draw(h,A.LINES,Ut.disabled,sn.disabled,h.colorModeForRenderPass(),an.disabled,Tg(we,z,ye,ve.getProjection()),s.id,Te.layoutVertexBuffer,Te.indexBuffer,Te.segments,null,z.zoom,null,[Te.collisionVertexBuffer,Te.collisionVertexBufferExt]))}if(!b||!F.length)return;const H=h.getOrCreateProgram("collisionCircle"),q=new r.dI;q.resize(4*O),q._trim();let Y=0;for(const me of F)for(let xe=0;xe<me.circleArray.length/4;xe++){const ye=4*xe,ve=me.circleArray[ye+0],_e=me.circleArray[ye+1],we=me.circleArray[ye+2],Te=me.circleArray[ye+3];q.emplace(Y++,ve,_e,we,Te,0),q.emplace(Y++,ve,_e,we,Te,1),q.emplace(Y++,ve,_e,we,Te,2),q.emplace(Y++,ve,_e,we,Te,3)}(!yl||yl.length<2*O)&&(yl=function(me){const xe=2*me,ye=new r.a_;ye.resize(xe),ye._trim();for(let ve=0;ve<xe;ve++){const _e=6*ve;ye.uint16[_e+0]=4*ve+0,ye.uint16[_e+1]=4*ve+1,ye.uint16[_e+2]=4*ve+2,ye.uint16[_e+3]=4*ve+2,ye.uint16[_e+4]=4*ve+3,ye.uint16[_e+5]=4*ve+0}return ye}(O));const Z=T.createIndexBuffer(yl,!0),oe=T.createVertexBuffer(q,r.dJ.members,!0);for(const me of F){const xe={u_matrix:me.transform,u_inv_matrix:me.invTransform,u_camera_to_center_distance:(fe=z).getCameraToCenterDistance(me.projection),u_viewport_size:[fe.width,fe.height]};H.draw(h,A.TRIANGLES,Ut.disabled,sn.disabled,h.colorModeForRenderPass(),an.disabled,xe,s.id,oe,Z,r.bd.simpleSegment(0,2*me.circleOffset,me.circleArray.length,me.circleArray.length/2),null,z.zoom)}var fe;oe.destroy(),Z.destroy()}const Lu=r.bz();function ku(h){const t=h._camera.getWorldToCamera(h.worldSize,1),s=r.az([],t,h.globeMatrix);r.bi(s,s);const f=[0,0,0],_=[0,1,0,0];return r.aA(_,_,s),f[0]=_[0],f[1]=_[1],f[2]=_[2],r.au(f,f),f}function Tf({width:h,height:t,anchor:s,textOffset:f,textScale:_},g){const{horizontalAlign:b,verticalAlign:T}=r.bV(s),A=-(b-.5)*h,z=-(T-.5)*t,D=r.bU(s,f);return new r.P((A/_+D[0])*g,(z/_+D[1])*g)}function Dp(h,t,s,f,_,g,b,T,A,z){const D=h.text.placedSymbolArray,F=h.text.dynamicLayoutVertexArray,O=h.icon.dynamicLayoutVertexArray,U={},H=h.getProjection(),q=vu(b,H,_),Y=_.elevation,Z=H.upVectorScale(b.canonical,_.center.lat,_.worldSize).metersToTile;F.clear();for(let oe=0;oe<D.length;oe++){const fe=D.get(oe),{tileAnchorX:me,tileAnchorY:xe,numGlyphs:ye}=fe,ve=fe.hidden||!fe.crossTileID||h.allowVerticalPlacement&&!fe.placedOrientation?null:f[fe.crossTileID];if(ve){let _e=0,we=0,Te=0;if(Y){const lt=Y?Y.getAtTileOffset(b,me,xe):0,[Ze,dt,st]=H.upVector(b.canonical,me,xe);_e=lt*Ze*Z,we=lt*dt*Z,Te=lt*st*Z}let[Ue,Fe,ot,et]=mo(fe.projectedAnchorX+_e,fe.projectedAnchorY+we,fe.projectedAnchorZ+Te,s?q:g);const xt=_a(_.getCameraToCenterDistance(H),et);let Oe=r.bJ(h.textSizeData,A,fe)*xt/r.bO;s&&(Oe*=h.tilePixelRatio/T);const je=Tf(ve,Oe);s?({x:Ue,y:Fe,z:ot}=H.projectTilePoint(me+je.x,xe+je.y,b.canonical),[Ue,Fe,ot]=mo(Ue+_e,Fe+we,ot+Te,g)):(t&&je._rotate(-_.angle),Ue+=je.x,Fe+=je.y,ot=0);const Le=h.allowVerticalPlacement&&fe.placedOrientation===r.bI.vertical?Math.PI/2:0;for(let lt=0;lt<ye;lt++)r.bL(F,Ue,Fe,ot,Le);z&&fe.associatedIconIndex>=0&&(U[fe.associatedIconIndex]={x:Ue,y:Fe,z:ot,angle:Le})}else Kn(ye,F)}if(z){O.clear();const oe=h.icon.placedSymbolArray;for(let fe=0;fe<oe.length;fe++){const me=oe.get(fe),{numGlyphs:xe}=me,ye=U[fe];if(me.hidden||!ye)Kn(xe,O);else{const{x:ve,y:_e,z:we,angle:Te}=ye;for(let Ue=0;Ue<xe;Ue++)r.bL(O,ve,_e,we,Te)}}h.icon.dynamicLayoutVertexBuffer.updateData(O)}h.text.dynamicLayoutVertexBuffer.updateData(F)}function Sf(h,t,s,f,_,g,b={}){const T=s.paint.get("icon-translate"),A=s.paint.get("text-translate"),z=s.paint.get("icon-translate-anchor"),D=s.paint.get("text-translate-anchor"),F=s.layout.get("icon-rotation-alignment"),O=s.layout.get("text-rotation-alignment"),U=s.layout.get("icon-pitch-alignment"),H=s.layout.get("text-pitch-alignment"),q=s.layout.get("icon-keep-upright"),Y=s.layout.get("text-keep-upright"),Z=s.paint.get("icon-color-saturation"),oe=s.paint.get("icon-color-contrast"),fe=s.paint.get("icon-color-brightness-min"),me=s.paint.get("icon-color-brightness-max"),xe=s.layout.get("symbol-elevation-reference")==="sea",ye=h.context,ve=ye.gl,_e=h.transform,we=F==="map",Te=O==="map",Ue=U==="map",Fe=H==="map",ot=s.layout.get("symbol-sort-key").constantOr(1)!==void 0;let et=!1;const xt=h.depthModeForSublayer(0,Ut.ReadOnly),Oe=new Ut(h.context.gl.LEQUAL,Ut.ReadOnly,h.depthRangeFor3D),je=[r.ay(_e.center.lng),r.aH(_e.center.lat)],Le=s.layout.get("text-variable-anchor"),lt=_e.projection.name==="globe",Ze=[],dt=[0,-1,0];for(const st of f){const pt=t.getTile(st),mt=pt.getBucket(s);if(!mt||mt.projection.name==="mercator"&&lt||mt.fullyClipped)continue;const Vt=mt.projection.name==="globe",Xt=Vt?r.ah(_e.zoom):0,Bt=vu(st,mt.getProjection(),_e),Yt=_e.calculatePixelsToTileUnitsMatrix(pt),jt=Le&&mt.hasTextData(),en=mt.hasIconTextFit()&&jt&&mt.hasIconData(),cn=mt.elevationType==="road"?Oe:xt,Rn=mt.getProjection().createInversionMatrix(_e,st.canonical),ai=h.shadowRenderer,ii=mt.elevationType==="road"&&!!ai&&ai.enabled;let Ln=[0,0,0];if(ii){const Oi=h.style.directionalLight,xn=h.style.ambientLight;Oi&&xn&&(Ln=Es(h.style,Oi,xn))}const Zi=Oi=>{_e.depthOcclusionForSymbolsAndCircles&&(s.hasInitialOcclusionOpacityProperties||h.terrain)&&(Oi.push("DEPTH_D24"),Oi.push("DEPTH_OCCLUSION"))},Ni=()=>{const Oi=we&&s.layout.get("symbol-placement")!=="point",xn=[];Zi(xn);const Pi=Oi||en,Gn=s.paint.get("icon-image-cross-fade");h.terrainRenderModeElevated()&&Ue&&xn.push("PITCH_WITH_MAP_TERRAIN"),Vt&&(xn.push("PROJECTION_GLOBE_VIEW"),Pi&&xn.push("PROJECTED_POS_ON_VIEWPORT")),Gn>0&&xn.push("ICON_TRANSITION"),mt.icon.zOffsetVertexBuffer&&xn.push("Z_OFFSET"),Z===0&&oe===0&&fe===0&&me===1||xn.push("COLOR_ADJUSTMENT"),mt.sdfIcons&&xn.push("RENDER_SDF"),ii&&xn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const zi=mt.icon.programConfigurations.get(s.id),Jn=h.getOrCreateProgram("symbol",{config:zi,defines:xn}),Fi=pt.imageAtlasTexture?pt.imageAtlasTexture.size:[0,0],Tr=mt.iconSizeData,Si=r.bH(Tr,_e.zoom),Cr=Ue||_e.pitch!==0,nr=nc(Bt,pt.tileID.canonical,Ue,we,_e,mt.getProjection(),Yt),Lr=tp(Bt,pt.tileID.canonical,Ue,we,_e,mt.getProjection(),Yt),ds=h.translatePosMatrix(Lr,pt,T,z,!0),ea=h.translatePosMatrix(Bt,pt,T,z),yo=Pi?Lu:nr,Jo=we&&!Ue&&!Oi;let Cs=dt;!lt&&!_e.mercatorFromTransition||we||(Cs=ku(_e));const Ps=Vt?Cs:dt,ps=s.getColorAdjustmentMatrix(Z,oe,fe,me),Pc=vf(Tr.kind,Si,Jo,Ue,h,ea,yo,ds,xe,!1,Fi,[0,0],!0,st,Xt,je,Rn,Ps,mt.getProjection(),Ln,ps,Gn),Ml=pt.imageAtlasTexture?pt.imageAtlasTexture:null,Uf=s.layout.get("icon-size").constantOr(0)!==1||mt.iconsNeedLinear,jf=mt.sdfIcons||h.options.rotating||h.options.zooming||Uf||Cr?ve.LINEAR:ve.NEAREST,$f=mt.sdfIcons&&s.paint.get("icon-halo-width").constantOr(1)!==0,Ku=h.terrain&&Ue&&Oi?r.bi(r.bz(),nr):Lu;if(Oi&&mt.icon){const Ri=_e.elevation,zc=Ri?Ri.getAtTileOffsetFunc(st,_e.center.lat,_e.worldSize,mt.getProjection()):null,im=qh(Bt,pt.tileID.canonical,Ue,we,_e,mt.getProjection(),Yt);ip(mt,Bt,h,!1,im,Lr,Ue,q,zc,st)}return{program:Jn,buffers:mt.icon,uniformValues:Pc,atlasTexture:Ml,atlasTextureIcon:null,atlasInterpolation:jf,atlasInterpolationIcon:null,isSDF:mt.sdfIcons,hasHalo:$f,depthMode:cn,tile:pt,renderWithShadows:ii,labelPlaneMatrixInv:Ku}},pn=()=>{const Oi=Te&&s.layout.get("symbol-placement")!=="point",xn=[],Pi=Oi||Le||en;h.terrainRenderModeElevated()&&Fe&&xn.push("PITCH_WITH_MAP_TERRAIN"),Vt&&(xn.push("PROJECTION_GLOBE_VIEW"),Pi&&xn.push("PROJECTED_POS_ON_VIEWPORT")),mt.text.zOffsetVertexBuffer&&xn.push("Z_OFFSET"),mt.iconsInText&&xn.push("RENDER_TEXT_AND_SYMBOL"),xn.push("RENDER_SDF"),ii&&xn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Zi(xn);const Gn=mt.text.programConfigurations.get(s.id),zi=h.getOrCreateProgram("symbol",{config:Gn,defines:xn});let Jn,Fi=[0,0],Tr=null;const Si=mt.textSizeData;mt.iconsInText&&(Fi=pt.imageAtlasTexture?pt.imageAtlasTexture.size:[0,0],Tr=pt.imageAtlasTexture?pt.imageAtlasTexture:null,Jn=Fe||_e.pitch!==0||h.options.rotating||h.options.zooming||Si.kind==="composite"||Si.kind==="camera"?ve.LINEAR:ve.NEAREST);const Cr=pt.glyphAtlasTexture?pt.glyphAtlasTexture.size:[0,0],nr=s.layout.get("text-size-scale-range"),Lr=r.aD(h.scaleFactor,nr[0],nr[1]),ds=r.bH(Si,_e.zoom,Lr),ea=nc(Bt,pt.tileID.canonical,Fe,Te,_e,mt.getProjection(),Yt),yo=tp(Bt,pt.tileID.canonical,Fe,Te,_e,mt.getProjection(),Yt),Jo=h.translatePosMatrix(yo,pt,A,D,!0),Cs=h.translatePosMatrix(Bt,pt,A,D),Ps=Pi?Lu:ea,ps=Te&&!Fe&&!Oi;let Pc=dt;!lt&&!_e.mercatorFromTransition||Te||(Pc=ku(_e));const Ml=vf(Si.kind,ds,ps,Fe,h,Cs,Ps,Jo,xe,!0,Cr,Fi,!0,st,Xt,je,Rn,Vt?Pc:dt,mt.getProjection(),Ln,null,null,Lr),Uf=pt.glyphAtlasTexture?pt.glyphAtlasTexture:null,jf=ve.LINEAR,$f=s.paint.get("text-halo-width").constantOr(1)!==0,Ku=h.terrain&&Fe&&Oi?r.bi(r.bz(),ea):Lu;if(Oi&&mt.text){const Ri=_e.elevation,zc=Ri?Ri.getAtTileOffsetFunc(st,_e.center.lat,_e.worldSize,mt.getProjection()):null,im=qh(Bt,pt.tileID.canonical,Fe,Te,_e,mt.getProjection(),Yt);ip(mt,Bt,h,!0,im,yo,Fe,Y,zc,st)}return{program:zi,buffers:mt.text,uniformValues:Ml,atlasTexture:Uf,atlasTextureIcon:Tr,atlasInterpolation:jf,atlasInterpolationIcon:Jn,isSDF:!0,hasHalo:$f,depthMode:cn,tile:pt,renderWithShadows:ii,labelPlaneMatrixInv:Ku}},Vn=mt.icon.segments.get().length,Zn=mt.text.segments.get().length,li=Vn&&!b.onlyText?Ni():null,or=Zn&&!b.onlyIcons?pn():null,Yi=s.paint.get("icon-opacity").constantOr(1),rr=s.paint.get("text-opacity").constantOr(1);if(ot&&mt.canOverlap){et=!0;const Oi=Yi&&!b.onlyText?mt.icon.segments.get():[],xn=rr&&!b.onlyIcons?mt.text.segments.get():[];for(const Pi of Oi)Ze.push({segments:new r.bd([Pi]),sortKey:Pi.sortKey,state:li});for(const Pi of xn)Ze.push({segments:new r.bd([Pi]),sortKey:Pi.sortKey,state:or})}else b.onlyText||Ze.push({segments:Yi?mt.icon.segments:new r.bd([]),sortKey:0,state:li}),b.onlyIcons||Ze.push({segments:rr?mt.text.segments:new r.bd([]),sortKey:0,state:or})}et&&Ze.sort((st,pt)=>st.sortKey-pt.sortKey);for(const st of Ze){const pt=st.state;if(pt)if(h.terrain?h.terrain.setupElevationDraw(pt.tile,pt.program,{useDepthForOcclusion:_e.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:pt.labelPlaneMatrixInv}):h.setupDepthForOcclusion(_e.depthOcclusionForSymbolsAndCircles,pt.program),ye.activeTexture.set(ve.TEXTURE0),pt.atlasTexture&&pt.atlasTexture.bind(pt.atlasInterpolation,ve.CLAMP_TO_EDGE,!0),pt.atlasTextureIcon&&(ye.activeTexture.set(ve.TEXTURE1),pt.atlasTextureIcon&&pt.atlasTextureIcon.bind(pt.atlasInterpolationIcon,ve.CLAMP_TO_EDGE,!0)),pt.renderWithShadows&&h.shadowRenderer.setupShadows(pt.tile.tileID.toUnwrapped(),pt.program,"vector-tile",pt.tile.tileID.overscaledZ),h.uploadCommonLightUniforms(h.context,pt.program),pt.hasHalo){const mt=pt.uniformValues;mt.u_is_halo=1,Lp(pt.buffers,st.segments,s,h,pt.program,pt.depthMode,_,g,mt,2),mt.u_is_halo=0}else{if(pt.isSDF){const mt=pt.uniformValues;pt.hasHalo&&(mt.u_is_halo=1,Lp(pt.buffers,st.segments,s,h,pt.program,pt.depthMode,_,g,mt,1)),mt.u_is_halo=0}Lp(pt.buffers,st.segments,s,h,pt.program,pt.depthMode,_,g,pt.uniformValues,1)}}}function Lp(h,t,s,f,_,g,b,T,A,z){const D=[h.dynamicLayoutVertexBuffer,h.opacityVertexBuffer,h.iconTransitioningVertexBuffer,h.globeExtVertexBuffer,h.zOffsetVertexBuffer];_.draw(f,f.context.gl.TRIANGLES,g,b,T,an.disabled,A,s.id,h.layoutVertexBuffer,h.indexBuffer,t,s.paint,f.transform.zoom,h.programConfigurations.get(s.id),D,z)}function vc(h,t){const s=1<<h.canonical.z,f=(t.x*s-h.canonical.x-h.wrap*s)*r.aj,_=(t.y*s-h.canonical.y)*r.aj,g=r.dS(t.z,t.y);return r.cS(f,_,g)}function Ou(h,t,s,f,_){if(!s.layout||s.layout.get("fill-elevation-reference")==="none")return;const g=h.context.gl,b=new Ut(h.context.gl.LEQUAL,Ut.ReadWrite,h.depthRangeFor3D),T=new Ut(h.context.gl.GREATER,Ut.ReadWrite,h.depthRangeFor3D),A=function(U){const H=r.cJ(U.pitch);let q=.01;return U.isOrthographic&&(q=r.ai(1e-4,q,r.cO(H>=xa?1:H/xa))),2*q}(h.transform),z=h.transform.getFreeCameraOptions().position,D="elevatedStructuresDepthReconstruct",F=h.getOrCreateProgram(D,{defines:["DEPTH_RECONSTRUCTION"]}),O=h.getOrCreateProgram(D);for(const U of f){const H=t.getTile(U),q=H.getBucket(s);if(!q)continue;const Y=q.elevatedStructures;if(!Y)continue;const Z=q.elevationBufferData.heightRange,oe=vc(U.toUnwrapped(),z),fe=h.translatePosMatrix(U.projMatrix,H,s.paint.get("fill-translate"),s.paint.get("fill-translate-anchor"));let me,xe,ye,ve;if(_==="initialize"){if(!Z||Z.min>=1||Y.depthSegments.segments[0].primitiveLength===0)continue;me=Du(fe,oe,A,1,0),xe=b,ye=Y.depthSegments,ve=F}else if(_==="reset"){if(!Z||Z.min>=0||Y.maskSegments.segments[0].primitiveLength===0)continue;me=Du(fe,oe,0,0,1),xe=T,ye=Y.maskSegments,ve=F}else if(_==="geometry"){if(Y.depthSegments.segments[0].primitiveLength===0)continue;me=Du(fe,oe,A,1,0),xe=b,ye=Y.depthSegments,ve=O}ve.draw(h,g.TRIANGLES,xe,sn.disabled,In.disabled,an.disabled,me,s.id,Y.vertexBuffer,Y.indexBuffer,ye,s.paint,h.transform.zoom)}}function Ft(h,t,s){const{painter:f,sourceCache:_,layer:g,coords:b,colorMode:T,elevationType:A,terrainEnabled:z,pass:D}=h,F=f.context.gl,O=g.paint.get("fill-pattern"),U=g.paint.get("fill-pattern-cross-fade"),H=O.constantOr(null);let q=A;A!=="road"||t&&!z||(q="none");const Y=q==="road",Z=h.painter.shadowRenderer,oe=Y&&!!Z&&Z.enabled,fe=new Ut(f.context.gl.LEQUAL,Ut.ReadOnly,f.depthRangeFor3D);let me=[0,0,0];if(oe){const ve=f.style.directionalLight,_e=f.style.ambientLight;ve&&_e&&(me=Es(f.style,ve,_e))}const xe=O&&O.constantOr(1),ye=(ve,_e)=>{let we,Te,Ue,Fe,ot;_e?(we=xe&&!g.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Ue=F.LINES):(we=xe?"fillPattern":"fill",Ue=F.TRIANGLES);for(const et of b){const xt=_.getTile(et);if(xe&&!xt.patternsLoaded())continue;const Oe=xt.getBucket(g);if(!Oe)continue;const je=t?Oe.elevationBufferData:Oe.bufferData;if(je.isEmpty())continue;f.prepareDrawTile();const Le=je.programConfigurations.get(g.id),lt=f.isTileAffectedByFog(et),Ze=[],dt=[];Y&&(Ze.push("ELEVATED_ROADS"),dt.push(je.elevatedLayoutVertexBuffer)),oe&&Ze.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),xe&&(f.context.activeTexture.set(F.TEXTURE0),xt.imageAtlasTexture&&xt.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),Le.updatePaintBuffers());let st=!1;if(H&&xt.imageAtlas){const Bt=xt.imageAtlas,Yt=r.dN.from(H),jt=Yt.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),en=Yt.getSecondary(),cn=Bt.patternPositions.get(jt),Rn=en?Bt.patternPositions.get(en.scaleSelf(r.q.devicePixelRatio).toString()):null;st=!!cn&&!!Rn,cn&&Le.setConstantPatternPositions(cn,Rn)}U>0&&(st||Le.getPatternTransitionVertexBuffer("fill-pattern"))&&Ze.push("FILL_PATTERN_TRANSITION");const pt=f.getOrCreateProgram(we,{config:Le,overrideFog:lt,defines:Ze}),mt=f.translatePosMatrix(et.projMatrix,xt,g.paint.get("fill-translate"),g.paint.get("fill-translate-anchor"));oe&&Z.setupShadows(xt.tileID.toUnwrapped(),pt,"vector-tile",xt.tileID.overscaledZ);const Vt=g.paint.get("fill-emissive-strength");if(_e){Fe=je.lineIndexBuffer,ot=je.lineSegments;const Bt=f.terrain&&f.terrain.renderingToTexture?f.terrain.drapeBufferSize:[F.drawingBufferWidth,F.drawingBufferHeight];Te=we==="fillOutlinePattern"&&xe?Kx(mt,Vt,f,xt,Bt,me,U):Yx(mt,Vt,Bt,me)}else Fe=je.indexBuffer,ot=je.triangleSegments,Te=xe?wg(mt,Vt,f,xt,me,U):bg(mt,Vt,me);f.uploadCommonUniforms(f.context,pt,et.toUnwrapped());let Xt=ve;(A==="road"&&!z||A==="offset")&&(Xt=fe),pt.draw(f,Ue,Xt,s||f.stencilModeForClipping(et),T,an.disabled,Te,g.id,je.layoutVertexBuffer,Fe,ot,g.paint,f.transform.zoom,Le,dt)}};f.renderPass===D&&ye(f.depthModeForSublayer(1,f.renderPass==="opaque"?Ut.ReadWrite:Ut.ReadOnly),!1),q==="none"&&f.renderPass==="translucent"&&g.paint.get("fill-antialias")&&ye(f.depthModeForSublayer(g.getPaintProperty("fill-outline-color")?2:0,Ut.ReadOnly),!0)}function Fu(h,t,s,f,_,g,b,T){s.resetLayerRenderingStats(h);const A=h.context,z=A.gl,D=h.transform,F=s.paint.get("fill-extrusion-pattern"),O=s.paint.get("fill-extrusion-pattern-cross-fade"),U=F.constantOr(null),H=F.constantOr(1),q=s.paint.get("fill-extrusion-opacity"),Y=h.style.enable3dLights(),Z=s.paint.get(Y&&!H?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),oe=[s.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z],fe=s.layout.get("fill-extrusion-edge-radius"),me=fe>0&&!s.paint.get("fill-extrusion-rounded-roof"),xe=me?0:fe,ye=D.projection.name==="globe"?r.dT():0,ve=D.projection.name==="globe",_e=ve?r.ah(D.zoom):0,we=[r.ay(D.center.lng),r.aH(D.center.lat)],Te=s.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Ue=s.paint.get("fill-extrusion-flood-light-color").toRenderColor(Te?null:s.lut).toArray01().slice(0,3),Fe=s.paint.get("fill-extrusion-flood-light-intensity"),ot=s.paint.get("fill-extrusion-vertical-scale"),et=s.paint.get("fill-extrusion-line-width").constantOr(1)!==0,xt=s.paint.get("fill-extrusion-height-alignment"),Oe=s.paint.get("fill-extrusion-base-alignment"),je=hl(h,s.paint.get("fill-extrusion-cutoff-fade-range")),Le=[];let lt;ve&&Le.push("PROJECTION_GLOBE_VIEW"),oe[0]>0&&Le.push("FAUX_AO"),me&&Le.push("ZERO_ROOF_RADIUS"),T&&Le.push("HAS_CENTROID"),Fe>0&&Le.push("FLOOD_LIGHT"),je.shouldRenderCutoff&&Le.push("RENDER_CUTOFF"),et&&Le.push("RENDER_WALL_MODE");const Ze=h.renderPass==="shadow",dt=h.shadowRenderer,st=Ze&&!!dt,pt=Ze?an.disabled:an.backCCW;h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!0);let mt=[0,0,0];if(dt){const Bt=h.style.directionalLight,Yt=h.style.ambientLight;Bt&&Yt&&(mt=Es(h.style,Bt,Yt)),Ze||(Le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),dt.useNormalOffset&&Le.push("NORMAL_OFFSET")),lt=Le.concat(["SHADOWS_SINGLE_CASCADE"])}const Vt=st?"fillExtrusionDepth":H?"fillExtrusionPattern":"fillExtrusion",Xt=s.getLayerRenderingStats();for(const Bt of f){const Yt=t.getTile(Bt),jt=Yt.getBucket(s);if(!jt||jt.projection.name!==D.projection.name)continue;let en=!1;dt&&(en=dt.getMaxCascadeForTile(Bt.toUnwrapped())===0);const cn=h.isTileAffectedByFog(Bt),Rn=jt.programConfigurations.get(s.id);let ai=!1;if(U&&Yt.imageAtlas){const Zn=Yt.imageAtlas,li=r.dN.from(U),or=li.getPrimary().scaleSelf(r.q.devicePixelRatio).toString(),Yi=li.getSecondary(),rr=Zn.patternPositions.get(or),Oi=Yi?Zn.patternPositions.get(Yi.scaleSelf(r.q.devicePixelRatio).toString()):null;ai=!!rr&&!!Oi,rr&&Rn.setConstantPatternPositions(rr,Oi)}O>0&&(ai||Rn.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&Le.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ii=h.getOrCreateProgram(Vt,{config:Rn,defines:en?lt:Le,overrideFog:cn});if(h.terrain&&h.terrain.setupElevationDraw(Yt,ii,{useMeterToDem:!0}),!jt.centroidVertexBuffer){const Zn=ii.attributes.a_centroid_pos;Zn!==void 0&&z.vertexAttrib2f(Zn,0,0)}!Ze&&dt&&dt.setupShadows(Yt.tileID.toUnwrapped(),ii,"vector-tile",Yt.tileID.overscaledZ),H&&(h.context.activeTexture.set(z.TEXTURE0),Yt.imageAtlasTexture&&Yt.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),Rn.updatePaintBuffers());const Ln=s.paint.get("fill-extrusion-vertical-gradient"),Zi=1/jt.tileToMeter;let Ni;if(Ze&&dt){if(e1(Yt.tileID,jt,h))continue;const Zn=dt.calculateShadowPassMatrixFromTile(Yt.tileID.toUnwrapped());Ni=Wx(Zn,xe,Zi,ot,xt,Oe)}else{const Zn=h.translatePosMatrix(Bt.expandedProjMatrix,Yt,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),li=D.projection.createInversionMatrix(D,Bt.canonical);Ni=H?Xx(Zn,h,Ln,q,oe,xe,Zi,Bt,Yt,ye,xt,Oe,_e,we,li,Ue,ot,O):ml(Zn,h,Ln,q,oe,xe,Zi,Bt,ye,xt,Oe,_e,we,li,Ue,ot,Fe,mt)}h.uploadCommonUniforms(A,ii,Bt.toUnwrapped(),null,je);let pn=jt.segments;if(D.projection.name==="mercator"&&!Ze&&(pn=jt.getVisibleSegments(Yt.tileID,h.terrain,h.transform.getFrustum(0)),!pn.get().length))continue;if(Xt)if(Ze)for(const Zn of pn.get())Xt.numRenderedVerticesInShadowPass+=Zn.primitiveLength;else for(const Zn of pn.get())Xt.numRenderedVerticesInTransparentPass+=Zn.primitiveLength;const Vn=[];(h.terrain||T)&&Vn.push(jt.centroidVertexBuffer),ve&&Vn.push(jt.layoutVertexExtBuffer),et&&Vn.push(jt.wallVertexBuffer),ii.draw(h,A.gl.TRIANGLES,_,g,b,pt,Ni,s.id,jt.layoutVertexBuffer,jt.indexBuffer,pn,s.paint,h.transform.zoom,Rn,Vn)}h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!1)}function vl(h,t,s,f,_,g,b,T,A,z,D,F,O,U,H,q,Y,Z,oe){const fe=h.context,me=fe.gl,xe=h.transform,ye=h.transform.zoom,ve=[],_e=hl(h,s.paint.get("fill-extrusion-cutoff-fade-range"));z==="clear"?(ve.push("CLEAR_SUBPASS"),oe&&(ve.push("CLEAR_FROM_TEXTURE"),fe.activeTexture.set(me.TEXTURE0),oe.bind(me.LINEAR,me.CLAMP_TO_EDGE))):z==="sdf"&&ve.push("SDF_SUBPASS"),Y&&ve.push("HAS_CENTROID"),_e.shouldRenderCutoff&&ve.push("RENDER_CUTOFF");const we=s.layout.get("fill-extrusion-edge-radius"),Te=(Ue,Fe,ot,et,xt)=>{const Oe=Fe.programConfigurations.get(s.id),je=h.isTileAffectedByFog(Ue),Le=h.getOrCreateProgram("fillExtrusionGroundEffect",{config:Oe,defines:ve,overrideFog:je}),lt=((dt,st,pt,mt,Vt,Xt,Bt,Yt,jt,en,cn)=>({u_matrix:st,u_opacity:pt,u_ao_pass:mt?1:0,u_meter_to_tile:Vt,u_ao:Xt,u_flood_light_intensity:Bt,u_flood_light_color:Yt,u_attenuation:jt,u_edge_radius:en,u_fb:0,u_fb_size:cn,u_dynamic_offset:1}))(0,et,D,A,xt,[F,O*xt],U,H,q,ye>=17?0:we*xt,oe?oe.size[0]:0),Ze=[];Y&&Ze.push(Fe.hiddenByLandmarkVertexBuffer),h.uploadCommonUniforms(fe,Le,Ue.toUnwrapped(),null,_e),Le.draw(h,fe.gl.TRIANGLES,_,g,b,T,lt,s.id,Fe.vertexBuffer,Fe.indexBuffer,ot,s.paint,ye,Oe,Ze)};for(const Ue of f){const Fe=t.getTile(Ue),ot=Fe.getBucket(s);if(!ot||ot.projection.name!==xe.projection.name||!ot.groundEffect||ot.groundEffect&&!ot.groundEffect.hasData())continue;const et=ot.groundEffect,xt=1/ot.tileToMeter;{const Oe=h.translatePosMatrix(Ue.projMatrix,Fe,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),je=et.getDefaultSegment();Te(Ue,et,je,Oe,xt)}if(Z)for(let Oe=0;Oe<4;Oe++){const je=r.dU[Oe](Ue),Le=t.getTile(je);if(!Le)continue;const lt=Le.getBucket(s);if(!lt||lt.projection.name!==xe.projection.name||!lt.groundEffect||lt.groundEffect&&!lt.groundEffect.hasData())continue;const Ze=lt.groundEffect;let dt,st;Oe===0?(dt=[-r.aj,0,0],st=1):Oe===1?(dt=[r.aj,0,0],st=0):Oe===2?(dt=[0,-r.aj,0],st=3):(dt=[0,r.aj,0],st=2);const pt=Ze.regionSegments[st];if(!pt)continue;const mt=new Float32Array(16);r.bo(mt,Ue.projMatrix,dt),Te(Ue,Ze,pt,h.translatePosMatrix(mt,Fe,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),xt)}}}function Ea(h,t,s,f,_,g,b){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();const T=g?g.findDEMTileFor(s):null;if(!(T&&T.dem||b))return;g&&T&&T.dem&&f.selfDEMTileTimestamp!==T.dem._timestamp&&(f.borderDoneWithNeighborZ=[-1,-1,-1,-1],f.selfDEMTileTimestamp=T.dem._timestamp);const A=Z=>new r.P(Math.ceil((Z+r.dX)*r.dY),0),z=Z=>{const oe=t.getSource().minzoom,fe=xe=>{const ye=t.getTileByID(xe);if(ye&&ye.hasData())return ye.getBucket(_)},me=[0,-1,1];for(const xe of me){if(Z.overscaledZ+xe<oe)continue;const ye=fe(Z.calculateScaledKey(Z.overscaledZ+xe));if(ye)return ye}},D=[0,0,0],F=(Z,oe)=>(D[0]=Math.min(Z.min.y,oe.min.y),D[1]=Math.max(Z.max.y,oe.max.y),D[2]=r.aj-oe.min.x>Z.max.x?oe.min.x-r.aj:Z.max.x,D),O=(Z,oe)=>(D[0]=Math.min(Z.min.x,oe.min.x),D[1]=Math.max(Z.max.x,oe.max.x),D[2]=r.aj-oe.min.y>Z.max.y?oe.min.y-r.aj:Z.max.y,D),U=[(Z,oe)=>F(Z,oe),(Z,oe)=>F(oe,Z),(Z,oe)=>O(Z,oe),(Z,oe)=>O(oe,Z)],H=(Z,oe,fe,me,xe,ye,ve)=>{if(!g)return 0;const _e=[[ye?fe:Z,ye?Z:fe,0],[ye?fe:oe,ye?oe:fe,0]],we=ve<0?r.aj+ve:ve,Te=[ye?we:(Z+oe)/2,ye?(Z+oe)/2:we,0];return fe===0&&ve<0||fe!==0&&ve>0?g.getForTilePoints(xe,[Te],!0,me):_e.push(Te),g.getForTilePoints(s,_e,!0,T),Math.max(_e[0][2],_e[1][2],Te[2])/g.exaggeration()};for(let Z=0;Z<4;Z++){const oe=f.borderFeatureIndices[Z];if(oe.length===0)continue;const fe=r.dU[Z](s),me=z(fe);if(!(me&&me instanceof r.dV))continue;const xe=g?g.findDEMTileFor(fe):null;if(!(xe&&xe.dem||b)||(g&&xe&&xe.dem&&f.borderDEMTileTimestamp[Z]!==xe.dem._timestamp&&(f.borderDoneWithNeighborZ[Z]=-1,f.borderDEMTileTimestamp[Z]=xe.dem._timestamp),f.borderDoneWithNeighborZ[Z]===me.canonical.z))continue;me.centroidVertexArray.length===0&&me.createCentroidsBuffer();const ye=(Z<2?1:5)-Z,ve=me.borderDoneWithNeighborZ[ye]!==f.canonical.z,_e=me.borderFeatureIndices[ye];let we=0;if(f.canonical.z!==me.canonical.z){for(const Te of oe)f.showCentroid(f.featuresOnBorder[Te]);if(ve)for(const Te of _e)me.showCentroid(me.featuresOnBorder[Te]);f.borderDoneWithNeighborZ[Z]=me.canonical.z,me.borderDoneWithNeighborZ[ye]=f.canonical.z}for(const Te of oe){const Ue=f.featuresOnBorder[Te],Fe=f.centroidData[Ue.centroidDataIndex],ot=Ue.borders[Z];let et;for(;we<_e.length;){et=me.featuresOnBorder[_e[we]];const xt=et.borders[ye];if(xt[1]>ot[0]+3||xt[0]>ot[0]-3)break;me.showCentroid(et),we++}if(et&&we<_e.length){const xt=we;let Oe=0;for(;!(et.borders[ye][0]>ot[1]-3)&&(Oe++,++we!==_e.length);)et=me.featuresOnBorder[_e[we]];et=me.featuresOnBorder[_e[xt]];let je=!1;if(Oe>=1){const Ze=et.borders[ye];Math.abs(ot[0]-Ze[0])<3&&Math.abs(ot[1]-Ze[1])<3&&(Oe=1,je=!0,we=xt+1)}else if(Oe===0){f.showCentroid(Ue);continue}const Le=me.centroidData[et.centroidDataIndex];b&&je&&(((q=Fe).flags|(Y=Le).flags)&r.dW?(q.flags|=r.dW,Y.flags|=r.dW):(q.flags&=~r.dW,Y.flags&=~r.dW));const lt=Ue.intersectsCount()>1||et.intersectsCount()>1;if(Oe>1)we=xt,Fe.centroidXY=Le.centroidXY=new r.P(0,0);else if(xe&&xe.dem&&!lt){const Ze=U[Z](Fe,Le),dt=Z%2?r.aj-1:0,st=H(Ze[0],Math.min(r.aj-1,Ze[1]),dt,xe,fe,Z<2,Ze[2]);Fe.centroidXY=Le.centroidXY=A(st)}else lt?Fe.centroidXY=Le.centroidXY=new r.P(0,0):(Fe.centroidXY=f.encodeBorderCentroid(Ue),Le.centroidXY=me.encodeBorderCentroid(et));f.writeCentroidToBuffer(Fe),me.writeCentroidToBuffer(Le)}else f.showCentroid(Ue)}f.borderDoneWithNeighborZ[Z]=me.canonical.z,me.borderDoneWithNeighborZ[ye]=f.canonical.z}var q,Y;(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(h)}const Aa=[1,0,0],Qt=[0,1,0],kp=[0,0,1];function e1(h,t,s){const f=s.transform,_=s.shadowRenderer;if(!_)return!0;const g=h.toUnwrapped(),b=f.tileSize*_._cascades[s.currentShadowCascade].scale;let T=t.maxHeight;if(f.elevation){const q=f.elevation.getMinMaxForTile(h);q&&(T+=q.max)}const A=[..._.shadowDirection];A[2]=-A[2];const z=_.computeSimplifiedTileShadowVolume(g,T,b,A);if(!z)return!1;const D=[Aa,Qt,kp,A,[A[0],0,A[2]],[0,A[1],A[2]]],F=f.projection.name==="globe",O=f.scaleZoom(b),U=r.cn.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,O,!F),H=_.getCurrentCascadeFrustum();return U.intersectsPrecise(z.vertices,z.planes,D)===0||H.intersectsPrecise(z.vertices,z.planes,D)===0}function Pg(h){return[h[0]*r.dZ,h[1]*r.dZ,h[2]*r.dZ,0]}function Bu(h,t,s,f,_,g,b,T,A){const z=f.getSource(),D=s.globeSharedBuffers;if(!D)return;let F,O,U;if(t&&(F=f.getTile(t)),z instanceof r.aP?(O=z.texture,U=r.ds(0,0,s.transform)):F&&t&&(O=F.texture,U=r.ds(t.canonical.z,t.canonical.x,s.transform)),!O||!U)return;h||(U=r.cE(r.bz(),U,[1,-1,1]));const H=s.context,q=H.gl,Y=_.paint.get("raster-resampling")==="nearest"?q.NEAREST:q.LINEAR,Z=s.colorModeForDrapableLayerRenderPass(g),oe=b.defines;oe.push("GLOBE_POLES");const fe=new Ut(q.LEQUAL,Ut.ReadWrite,s.depthRangeFor3D),me=Float32Array.from(s.transform.expandedFarZProjMatrix),xe=Float32Array.from(r.bh(r.dr(new r.cp(0,0,0))));s.terrain&&s.terrain.prepareDrawTile(),H.activeTexture.set(q.TEXTURE0),O.bind(Y,q.CLAMP_TO_EDGE),H.activeTexture.set(q.TEXTURE1),O.bind(Y,q.CLAMP_TO_EDGE),"useMipmap"in O&&H.extTextureFilterAnisotropic&&s.transform.pitch>20&&q.texParameterf(q.TEXTURE_2D,H.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,H.extTextureFilterAnisotropicMax);const[ye,ve,_e,we]=t?D.getPoleBuffers(t.canonical.z,!1):D.getPoleBuffers(0,!0),Te=_.paint.get("raster-elevation");let Ue;h?(Ue=ye,s.renderDefaultNorthPole=Te!==0):(Ue=ve,s.renderDefaultSouthPole=Te!==0);const Fe=Pg(b.mix),ot=((xt,Oe,je,Le,lt,Ze,dt,st,pt,mt,Vt,Xt,Bt)=>Sa(xt,Oe,je,new Float32Array(16),new Float32Array(9),[0,0],Le,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ze,[0,0],st,2,mt,Vt,Xt,1,0,Bt))(me,xe,U,r.ah(s.transform.zoom),0,_,0,Te,0,Fe,b.offset,b.range,g),et=s.getOrCreateProgram("raster",{defines:oe});s.uploadCommonUniforms(H,et,null),et.draw(s,q.TRIANGLES,fe,A,Z,T,ot,_.id,Ue,_e,we)}function zg(h){const t=h._nearZ,s=h.projection.farthestPixelDistance(h),f=s-t,_=.2*h.height,g=t+_;return[t,s,(g-_-t)/f,(g-t)/f]}function t1(h,t,s,f){if(h)return t instanceof nl&&h instanceof mu?t.getTextureDescriptor(h,s,!0):{texture:h.texture,mix:Pg(f.mix),offset:f.offset,buffer:0,tileSize:1}}var Rg=r.d_([{name:"a_index",type:"Int16",components:1}]);class n1{constructor(t,s,f,_){const g={width:f[0],height:f[1],data:null},b=t.gl;this.targetColorTexture=new r.T(t,g,b.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new r.T(t,g,b.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(s,_),this.lastInvalidatedAt=0}updateParticleTexture(t,s){if(this.particleTextureDimension===s.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const f=this.context.gl,_=s.width*s.height;this.particleTexture0=new r.T(this.context,s,f.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new r.T(this.context,s,f.RGBA8,{premultiply:!1,useMipmap:!1});const g=new r.d$;g.reserve(_);for(let b=0;b<_;b++)g.emplaceBack(b);this.particleIndexBuffer=this.context.createVertexBuffer(g,Rg.members,!0),this.particleSegment=r.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=s.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=r.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function i1(h,t,s){if(!h)return null;const f=t.getTextureDescriptor(h,s,!0);if(!f)return null;let{texture:_,mix:g,offset:b,tileSize:T,buffer:A,format:z}=f;if(!_||!z)return null;let D=!1;return z==="uint32"&&(D=!0,g[3]=0,g=Cp(r.e0,g,[0,s.paint.get("raster-particle-max-speed")]),b=gf(r.e0,b,[0,s.paint.get("raster-particle-max-speed")])),{texture:_,textureOffset:[A/(T+2*A),T/(T+2*A)],tileSize:T,scalarData:D,scale:g,offset:b,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[z]]}}function Op(h){const t=h._nearZ,s=h.projection.farthestPixelDistance(h),f=s-t,_=.2*h.height,g=t+_;return[t,s,(g-_-t)/f,(g-t)/f]}const Fp=new r.am(1,0,0,1),Bp=new r.am(0,1,0,1),Np=new r.am(0,0,1,1),go=new r.am(1,0,1,1),Ia=new r.am(0,1,1,1);function xl(h,t,s,f,_,g,b){const T=h.context,A=h.transform,z=T.gl,D=A.projection.name==="globe",F=D?["PROJECTION_GLOBE_VIEW"]:[];let O=r.bw(s.projMatrix);if(D&&r.ah(A.zoom)>0){const Fe=r.bg(s.canonical,A),ot=r.e1(Fe);O=r.az(new Float32Array(16),A.globeMatrix,ot),r.az(O,A.projMatrix,O)}const U=r.bz();U[12]+=2*_/(r.q.devicePixelRatio*A.width),U[13]+=2*g/(r.q.devicePixelRatio*A.height),r.az(O,U,O);const H=h.getOrCreateProgram("debug",{defines:F}),q=t.getTileByID(s.key);h.terrain&&h.terrain.setupElevationDraw(q,H);const Y=Ut.disabled,Z=sn.disabled,oe=h.colorModeForRenderPass(),fe="$debug";T.activeTexture.set(z.TEXTURE0),h.emptyTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),D?q._makeGlobeTileDebugBuffers(h.context,A):q._makeDebugTileBoundsBuffers(h.context,A.projection);const me=q._tileDebugBuffer||h.debugBuffer,xe=q._tileDebugIndexBuffer||h.debugIndexBuffer,ye=q._tileDebugSegments||h.debugSegments;if(H.draw(h,z.LINE_STRIP,Y,Z,oe,an.disabled,_l(O,f),fe,me,xe,ye,null,null,null,[q._globeTileDebugBorderBuffer]),b){const Fe=q.latestRawTileData,ot=Math.floor((Fe&&Fe.byteLength||0)/1024);let et=s.canonical.toString();s.overscaledZ!==s.canonical.z&&(et+=` => ${s.overscaledZ}`),et+=` ${q.state}`,et+=` ${ot}kb`,function(xt,Oe){xt.initDebugOverlayCanvas();const je=xt.debugOverlayCanvas,Le=xt.context.gl,lt=xt.debugOverlayCanvas.getContext("2d");lt.clearRect(0,0,je.width,je.height),lt.shadowColor="white",lt.shadowBlur=2,lt.lineWidth=1.5,lt.strokeStyle="white",lt.textBaseline="top",lt.font="bold 36px Open Sans, sans-serif",lt.fillText(Oe,5,5),lt.strokeText(Oe,5,5),xt.debugOverlayTexture.update(je),xt.debugOverlayTexture.bind(Le.LINEAR,Le.CLAMP_TO_EDGE)}(h,et)}const ve=t.getTile(s).tileSize,_e=512/Math.min(ve,512)*(s.overscaledZ/A.zoom)*.5,we=q._tileDebugTextBuffer||h.debugBuffer,Te=q._tileDebugTextIndexBuffer||h.quadTriangleIndexBuffer,Ue=q._tileDebugTextSegments||h.debugSegments;H.draw(h,z.TRIANGLES,Y,Z,In.alphaBlended,an.disabled,_l(O,r.am.transparent,_e),fe,we,Te,Ue,null,null,null,[q._globeTileDebugTextBuffer])}function Ef(h,t,s,f){xc(h,0,t+s/2,h.transform.width,s,f)}function Af(h,t,s,f){xc(h,t-s/2,0,s,h.transform.height,f)}function xc(h,t,s,f,_,g){const b=h.context,T=b.gl;T.enable(T.SCISSOR_TEST),T.scissor(t*r.q.devicePixelRatio,s*r.q.devicePixelRatio,f*r.q.devicePixelRatio,_*r.q.devicePixelRatio),b.clear({color:g}),T.disable(T.SCISSOR_TEST)}const Dg=r.d_([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Yo}=Dg;function si(h,t,s,f){h.emplaceBack(t,s,f)}class Nu{constructor(t){this.vertexArray=new r.e2,this.indices=new r.a_,si(this.vertexArray,-1,-1,1),si(this.vertexArray,1,-1,1),si(this.vertexArray,-1,1,1),si(this.vertexArray,1,1,1),si(this.vertexArray,-1,-1,-1),si(this.vertexArray,1,-1,-1),si(this.vertexArray,-1,1,-1),si(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Yo),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=r.bd.simpleSegment(0,0,36,12)}}function Ma(h,t,s,f,_,g){const b=h.context.gl,T=t.paint.get("sky-atmosphere-color"),A=t.paint.get("sky-atmosphere-halo-color"),z=t.paint.get("sky-atmosphere-sun-intensity"),D=((F,O,U,H,q)=>({u_matrix_3f:F,u_sun_direction:O,u_sun_intensity:U,u_color_tint_r:[H.r,H.g,H.b,H.a],u_color_tint_m:[q.r,q.g,q.b,q.a],u_luminance:5e-5}))(r.e4(r.dx(),f),_,z,T,A);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+g,t.skyboxTexture,0),s.draw(h,b.TRIANGLES,Ut.disabled,sn.disabled,In.unblended,an.frontCW,D,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Lg=r.d_([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class kg{constructor(t){const s=new r.e5;s.emplaceBack(-1,1,1,0,0),s.emplaceBack(1,1,1,1,0),s.emplaceBack(1,-1,1,1,1),s.emplaceBack(-1,-1,1,0,1);const f=new r.a_;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(s,Lg.members),this.indexBuffer=t.createIndexBuffer(f),this.segments=r.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Og=r.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class r1{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class bc{constructor(t){this.colorModeAlphaBlendedWriteRGB=new In([1,Kr,1,Kr],r.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new In([1,0,1,0],r.am.transparent,[!1,!1,!1,!0]),this.params=new r1,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const s=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new kg(s);const f=this.params.sizeRange,_=this.params.intensityRange,g=function(D){const F=r.ea(30),O=[];for(let U=0;U<D;++U){const H=2*Math.PI*F(),q=Math.acos(1-2*F())-.5*Math.PI;O.push(r.cS(Math.cos(q)*Math.cos(H),Math.cos(q)*Math.sin(H),Math.sin(q)))}return O}(this.params.starsCount),b=r.ea(300),T=new r.e6,A=new r.a_;let z=0;for(let D=0;D<g.length;++D){const F=r.b$([],g[D],200),O=Math.max(0,1+.01*f*(1*b()-.5)),U=Math.max(0,1+.01*_*(1*b()-.5));T.emplaceBack(F[0],F[1],F[2],-1,-1,O,U),T.emplaceBack(F[0],F[1],F[2],1,-1,O,U),T.emplaceBack(F[0],F[1],F[2],1,1,O,U),T.emplaceBack(F[0],F[1],F[2],-1,1,O,U),A.emplaceBack(z+0,z+1,z+2),A.emplaceBack(z+0,z+2,z+3),z+=4}this.starsVx=s.createVertexBuffer(T,Og.members),this.starsIdx=s.createIndexBuffer(A),this.starsSegments=r.bd.simpleSegment(0,0,T.length,A.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,s){const f=t.context,_=f.gl,g=t.transform,b=new Ut(_.LEQUAL,Ut.ReadOnly,[0,1]),T=r.ah(g.zoom),A=t.style.getLut(s.scope),z=s.properties.get("color-use-theme")==="none",D=s.properties.get("color").toRenderColor(z?null:A).toArray01(),F=s.properties.get("high-color-use-theme")==="none",O=s.properties.get("high-color").toRenderColor(F?null:A).toArray01(),U=s.properties.get("space-color-use-theme")==="none",H=s.properties.get("space-color").toRenderColor(U?null:A).toArray01PremultipliedAlpha(),q=5e-4,Y=r.e7(s.properties.get("horizon-blend"),0,1,q,.25),Z=r.dl(t,f,g)&&Y===q?g.worldSize/(2*Math.PI*1.025)-1:g.globeRadius,oe=t.frameCounter/1e3%1,fe=r.ae(g.globeCenterInViewSpace),me=Math.sqrt(Math.pow(fe,2)-Math.pow(Z,2)),xe=Math.acos(me/fe),ye=ve=>{const _e=g.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ve&&_e.push("ALPHA_PASS");const we=t.getOrCreateProgram("globeAtmosphere",{defines:_e}),Te=((Fe,ot,et,xt,Oe,je,Le,lt,Ze,dt,st,pt)=>({u_frustum_tl:Fe,u_frustum_tr:ot,u_frustum_br:et,u_frustum_bl:xt,u_horizon:Oe,u_transition:je,u_fadeout_range:Le,u_color:lt,u_high_color:Ze,u_space_color:dt,u_temporal_offset:st,u_horizon_angle:pt}))(g.frustumCorners.TL,g.frustumCorners.TR,g.frustumCorners.BR,g.frustumCorners.BL,g.frustumCorners.horizon,T,Y,D,O,H,oe,xe);t.uploadCommonUniforms(f,we);const Ue=this.atmosphereBuffer;Ue&&we.draw(t,_.TRIANGLES,b,sn.disabled,ve?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,an.backCW,Te,ve?"atmosphere_glow_alpha":"atmosphere_glow",Ue.vertexBuffer,Ue.indexBuffer,Ue.segments)};ye(!1),ye(!0)}drawStars(t,s){const f=r.aD(s.properties.get("star-intensity"),0,1);if(f===0)return;const _=t.context,g=_.gl,b=t.transform,T=t.getOrCreateProgram("stars"),A=r.bY([]);r.b_(A,A,-b._pitch),r.bZ(A,A,-b.angle),r.b_(A,A,r.al(b._center.lat)),r.e8(A,A,-r.al(b._center.lng));const z=r.c3(new Float32Array(16),A),D=r.az([],b.starsProjMatrix,z),F=r.e4([],z),O=r.e9([],F),U=[0,1,0];r.dz(U,U,O),r.b$(U,U,this.params.sizeMultiplier);const H=[1,0,0];r.dz(H,H,O),r.b$(H,H,this.params.sizeMultiplier);const q=(Y=U,Z=H,oe=f,{u_matrix:Float32Array.from(D),u_up:Y,u_right:Z,u_intensity_multiplier:oe});var Y,Z,oe;t.uploadCommonUniforms(_,T),this.starsVx&&this.starsIdx&&T.draw(t,g.TRIANGLES,Ut.disabled,sn.disabled,this.colorModeAlphaBlendedWriteRGB,an.disabled,q,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function bl(h,t){const s=[...h],f=t.cameraWorldSizeForFog/t.worldSize,_=r.bx([]);return r.cE(_,_,[f,f,1]),r.az(s,_,s),r.az(s,t.worldToFogMatrix,s),s}function wt(h,t,s,f,_){const g=s.material,b=f.context,{baseColorTexture:T,metallicRoughnessTexture:A}=g.pbrMetallicRoughness,{normalTexture:z,occlusionTexture:D,emissionTexture:F}=g;function O(H,q,Y){if(H&&(h.push(q),b.activeTexture.set(b.gl.TEXTURE0+Y),H.gfxTexture)){const{minFilter:Z,magFilter:oe,wrapS:fe,wrapT:me}=H.sampler;H.gfxTexture.bindExtraParam(Z,oe,fe,me)}}O(T,"HAS_TEXTURE_u_baseColorTexture",Jr.BaseColor),O(A,"HAS_TEXTURE_u_metallicRoughnessTexture",Jr.MetallicRoughness),O(z,"HAS_TEXTURE_u_normalTexture",Jr.Normal),O(D,"HAS_TEXTURE_u_occlusionTexture",Jr.Occlusion),O(F,"HAS_TEXTURE_u_emissionTexture",Jr.Emission),_&&(_.texture||(_.texture=new r.ed(f.context,_.image,[_.image.height,_.image.height,_.image.height],b.gl.RGBA8)),b.activeTexture.set(b.gl.TEXTURE0+Jr.LUT),_.texture&&_.texture.bind(b.gl.LINEAR,b.gl.CLAMP_TO_EDGE),h.push("APPLY_LUT_ON_GPU")),s.texcoordBuffer&&(h.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(s.texcoordBuffer)),s.colorBuffer&&(h.push(s.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(s.colorBuffer)),s.normalBuffer&&(h.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(s.normalBuffer)),s.pbrBuffer&&(h.push("HAS_ATTRIBUTE_a_pbr"),h.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(s.pbrBuffer)),g.alphaMode!=="OPAQUE"&&g.alphaMode!=="MASK"||h.push("UNPREMULT_TEXTURE_IN_SHADER"),g.defined||h.push("DIFFUSE_SHADED");const U=f.shadowRenderer;U&&(h.push("RENDER_SHADOWS","DEPTH_TEXTURE"),U.useNormalOffset&&h.push("NORMAL_OFFSET"))}function Ot(h,t,s,f,_,g){const b=s.paint.get("model-opacity").constantOr(1),T=t.context,A=new Ut(t.context.gl.LEQUAL,Ut.ReadWrite,t.depthRangeFor3D),z=t.transform,D=h.mesh,F=D.material,O=F.pbrMetallicRoughness,U=t.style.fog;let H;H=t.transform.projection.zAxisUnit==="pixels"?[...h.nodeModelMatrix]:r.az([],f.zScaleMatrix,h.nodeModelMatrix),r.az(H,f.negCameraPosMatrix,H);const q=r.bi([],H);r.ee(q,q);const Y=s.paint.get("model-color-use-theme").constantOr("default")==="none",Z=s.paint.get("model-emissive-strength").constantOr(0),oe=gl(new Float32Array(h.worldViewProjection),new Float32Array(H),new Float32Array(q),null,t,b,O.baseColorFactor.toRenderColor(null),F.emissiveFactor,O.metallicFactor,O.roughnessFactor,F,Z,s),fe={defines:[]},me=[],xe=t.shadowRenderer;xe&&(xe.useNormalOffset=!1),wt(fe.defines,me,D,t,Y?null:s.lut);let ye=null;if(U){const we=bl(h.nodeModelMatrix,t.transform);if(ye=new Float32Array(we),z.projection.name!=="globe"){const Te=D.aabb.min,Ue=D.aabb.max,[Fe,ot]=U.getOpacityForBounds(we,Te[0],Te[1],Ue[0],Ue[1]);fe.overrideFog=Fe>=kt||ot>=kt}}const ve=hl(t,s.paint.get("model-cutoff-fade-range"));ve.shouldRenderCutoff&&fe.defines.push("RENDER_CUTOFF");const _e=t.getOrCreateProgram("model",fe);t.uploadCommonUniforms(T,_e,null,ye,ve),t.renderPass!=="shadow"&&xe&&xe.setupShadowsFromMatrix(h.nodeModelMatrix,_e),_e.draw(t,T.gl.TRIANGLES,A,_,g,D.material.doubleSided?an.disabled:an.backCCW,oe,s.id,D.vertexBuffer,D.indexBuffer,D.segments,s.paint,t.transform.zoom,void 0,me)}function wl(h,t,s,f,_,g,b){let T;T=h.projection.name==="globe"?r.ef(s,h):[...s],r.az(T,T,t.matrix);const A=r.az([],f,T);if(t.meshes)for(const z of t.meshes){if(z.material.alphaMode!=="BLEND"){b.push({mesh:z,depth:0,modelIndex:_,worldViewProjection:A,nodeModelMatrix:T});continue}const D=r.ad([],z.centroid,A);!h.isOrthographic&&D[2]<=0||g.push({mesh:z,depth:D[2],modelIndex:_,worldViewProjection:A,nodeModelMatrix:T})}if(t.children)for(const z of t.children)wl(h,z,s,f,_,g,b)}function Xi(h,t,s,f){const _=s.shadowRenderer;if(!_)return;const g=_.getShadowPassDepthMode(),b=_.getShadowPassColorMode(),T=_.calculateShadowPassMatrixFromMatrix(t),A=Cg(T);s.getOrCreateProgram("modelDepth",{defines:s._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(s,s.context.gl.TRIANGLES,g,sn.disabled,b,an.backCCW,A,f.id,h.vertexBuffer,h.indexBuffer,h.segments,f.paint,s.transform.zoom,void 0,void 0)}function Ne(h,t,s){const f=t.updateZoomBasedPaintProperties(),_=function(g,b,T){let A,z,D,F=g.terrain?g.terrain.exaggeration():0;if(g.terrain&&F>0){const O=g.terrain,U=O.findDEMTileFor(T);U&&U.dem?A=r.el.create(O,T,U):F=0}if(F===0&&(b.terrainElevationMin=0,b.terrainElevationMax=0),F===b.validForExaggeration&&(F===0||A&&A._demTile&&A._demTile.tileID===b.validForDEMTile.id&&A._dem._timestamp===b.validForDEMTile.timestamp))return!1;for(const O in b.instancesPerModel){const U=b.instancesPerModel[O];for(let H=0;H<U.instancedDataArray.length;++H){const q=(A?F*A.getElevationAt(0|U.instancedDataArray.float32[16*H],0|U.instancedDataArray.float32[16*H+1],!0,!0):0)+U.instancesEvaluatedElevation[H];U.instancedDataArray.float32[16*H+6]=q,z=z?Math.min(b.terrainElevationMin,q):q,D=D?Math.max(b.terrainElevationMax,q):q}}return b.terrainElevationMin=z||0,b.terrainElevationMax=D||0,b.validForExaggeration=F,b.validForDEMTile=A&&A._demTile?{id:A._demTile.tileID,timestamp:A._dem._timestamp}:{id:void 0,timestamp:0},!0}(h,t,s);(f||_)&&(t.uploaded=!1,t.upload(h.context))}const cs={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new r.cV([0,0,0],[r.aj,r.aj,0])};function If(h,t){const s=1<<h.canonical.z,f=t.getFreeCameraOptions().position,_=t.elevation,g=h.canonical.x/s,b=(h.canonical.x+1)/s,T=h.canonical.y/s,A=(h.canonical.y+1)/s;let z=t._centerAltitude;if(_){const U=_.getMinMaxForTile(h);U&&U.max>z&&(z=U.max)}const D=r.aD(f.x,g,b)-f.x,F=r.aD(f.y,T,A)-f.y,O=r.c6(z,t.center.lat)-f.z;return t._zoomFromMercatorZ(Math.sqrt(D*D+F*F+O*O))}function Mf(h,t,s,f,_,g,b){const T=h.context,A=h.renderPass==="shadow",z=h.shadowRenderer,D=A&&z?z.getShadowPassDepthMode():new Ut(T.gl.LEQUAL,Ut.ReadWrite,h.depthRangeFor3D),F=h.isTileAffectedByFog(g);if(s.meshes)for(const O of s.meshes){const U=["MODEL_POSITION_ON_GPU"],H=[];let q,Y,Z;f.instancedDataArray.length>20&&U.push("INSTANCED_ARRAYS");const oe=hl(h,t.paint.get("model-cutoff-fade-range"));if(oe.shouldRenderCutoff&&U.push("RENDER_CUTOFF"),A&&z)q=h.getOrCreateProgram("modelDepth",{defines:U}),Y=Cg(b.shadowTileMatrix,b.shadowTileMatrix,Float32Array.from(s.matrix)),Z=z.getShadowPassColorMode();else{wt(U,H,O,h,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),q=h.getOrCreateProgram("model",{defines:U,overrideFog:F});const me=O.material,xe=me.pbrMetallicRoughness,ye=t.paint.get("model-opacity").constantOr(1),ve=t.paint.get("model-emissive-strength").constantOr(0);Y=gl(g.expandedProjMatrix,Float32Array.from(s.matrix),new Float32Array(16),null,h,ye,xe.baseColorFactor.toRenderColor(null),me.emissiveFactor,xe.metallicFactor,xe.roughnessFactor,me,ve,t,_),z&&(b.shadowUniformsInitialized?q.setShadowUniformValues(T,z.getShadowUniformValues()):(z.setupShadows(g.toUnwrapped(),q,"model-tile",g.overscaledZ),b.shadowUniformsInitialized=!0)),Z=oe.shouldRenderCutoff||ye<1||me.alphaMode!=="OPAQUE"?In.alphaBlended:In.unblended}h.uploadCommonUniforms(T,q,g.toUnwrapped(),null,oe);const fe=O.material.doubleSided?an.disabled:an.backCCW;if(f.instancedDataArray.length>20)H.push(f.instancedDataBuffer),q.draw(h,T.gl.TRIANGLES,D,sn.disabled,Z,fe,Y,t.id,O.vertexBuffer,O.indexBuffer,O.segments,t.paint,h.transform.zoom,void 0,H,f.instancedDataArray.length);else{const me=A?"u_instance":"u_normal_matrix";for(let xe=0;xe<f.instancedDataArray.length;++xe)Y[me]=new Float32Array(f.instancedDataArray.arrayBuffer,64*xe,16),q.draw(h,T.gl.TRIANGLES,D,sn.disabled,Z,fe,Y,t.id,O.vertexBuffer,O.indexBuffer,O.segments,t.paint,h.transform.zoom,void 0,H)}}if(s.children)for(const O of s.children)Mf(h,t,O,f,_,g,b)}const Vp=[1,-1,1];function Fg(h,t,s,f){if(!s.modelManager)return!0;const _=s.modelManager;if(!s.shadowRenderer)return!0;const g=s.shadowRenderer,b=t.aabb;let T=!0,A=h.maxHeight;if(A===0){let D=0;for(const F in h.instancesPerModel){const O=_.getModel(F,f);O?D=Math.max(D,Math.max(Math.max(O.aabb.max[0],O.aabb.max[1]),O.aabb.max[2])):T=!1}A=h.maxScale*D*1.41+h.maxVerticalOffset,T&&(h.maxHeight=A)}b.max[2]=A,b.min[2]+=h.terrainElevationMin,b.max[2]+=h.terrainElevationMax,r.ad(b.min,b.min,t.tileMatrix),r.ad(b.max,b.max,t.tileMatrix);const z=b.intersects(g.getCurrentCascadeFrustum());return s.currentShadowCascade===0&&(h.isInsideFirstShadowMapFrustum=z===2),z===0}function Bg(h,t){const s=h.uniformValues.u_cutoff_params[0],f=h.uniformValues.u_cutoff_params[1],_=h.uniformValues.u_cutoff_params[2],g=h.uniformValues.u_cutoff_params[3];return f===s||g===_?1:r.aD(((t-s)/(f-s)-_)/(g-_),0,1)}function wc(h,t,s,f){if(t.pitch<20)return 1;const _=t.getWorldToCameraMatrix();r.az(_,_,h);const g=r.ei(s.min[0],s.min[1],s.min[2],1);let b=r.aA(r.ej(),g,_),T=b,A=b;g[1]=s.max[1],b=r.aA(r.ej(),g,_),T=b[1]<T[1]?b:T,A=b[1]>A[1]?b:A,g[0]=s.max[0],b=r.aA(r.ej(),g,_),T=b[1]<T[1]?b:T,A=b[1]>A[1]?b:A,g[1]=s.min[1],b=r.aA(r.ej(),g,_),T=b[1]<T[1]?b:T,A=b[1]>A[1]?b:A;const z=r.aD(f[0],0,1),D=100*t.pixelsPerMeter*r.aD(f[1],0,1),F=r.aD(f[2],0,1),O=r.ek(r.ej(),T,A,z),U=Math.tan(.5*t.fovX),H=-O[2]*U;if(D===0)return O[1]<-Math.abs(H)?F:1;const q=(-Math.abs(H)-O[1])/D,Y=(oe,fe,me)=>(1-me)*oe+me*fe,Z=r.aD(Y(1,F,q),F,1);return Y(1,Z,r.aD((t.pitch-20)/20,0,1))}class o1{}class s1{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,s,f){{const F=this._storage.get(s.id);if(F)return F.lastUsedFrameIdx=t,F.buf}const _=f.gl,g=_.getBufferParameter(_.ELEMENT_ARRAY_BUFFER,_.BUFFER_SIZE),b=new ArrayBuffer(g),T=new Int16Array(b);_.getBufferSubData(_.ELEMENT_ARRAY_BUFFER,0,new Int16Array(b));const A=new r.en;for(let F=0;F<g/2;F+=3){const O=T[F],U=T[F+1],H=T[F+2];A.emplaceBack(O,U),A.emplaceBack(U,H),A.emplaceBack(H,O)}const z=f.bindVertexArrayOES.current,D=new o1;return D.buf=new Ys(f,A),D.lastUsedFrameIdx=t,this._storage.set(s.id,D),f.bindVertexArrayOES.set(z),D.buf}update(t){for(const[s,f]of this._storage)t-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(s))}destroy(){for(const[t,s]of this._storage)s.buf.destroy(),this._storage.delete(t)}}class Ng{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Cf=r.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Up{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class jp{constructor(t,s){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...s,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...s,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const Vg=r.d_([{type:"Float32",name:"a_pos_2f",components:2}]);class Pf{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,s){const f=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const b=new r.eo,T=new r.a_;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(1,1),b.emplaceBack(-1,1),T.emplaceBack(0,1,2),T.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(b,Vg.members),this.vignetteIdx=t.context.createIndexBuffer(T)}const _=r.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,f);const b={u_vignetteShape:(g={vignetteShape:[s.start,s.range,Math.pow(10,s.fadePower)],vignetteColor:[s.color.r,s.color.g,s.color.b,s.color.a*s.strength]}).vignetteShape,u_vignetteColor:g.vignetteColor};f.draw(t,t.context.gl.TRIANGLES,Ut.disabled,sn.disabled,In.alphaBlended,an.disabled,b,"vignette",this.vignetteVx,this.vignetteIdx,_)}var g}}class Vu{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,s){const f=t.getFreeCameraOptions().position,_=f.toAltitude(),g=f.toLngLat(),b=r.al(g.lng),T=r.al(g.lat),A=t.pixelsPerMeter/s,z=b*r.eq,D=r.eq*Math.log(Math.tan(Math.PI/4+T/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const F=-this._offsetYPrev+D,O=-this._elevationPrev+_;this._accumulatedOffsetX+=(-this._offsetXPrev+z)*A,this._accumulatedOffsetY+=F*A,this._accumulatedElevation+=O*A,this._offsetXPrev=z,this._offsetYPrev=D,this._elevationPrev=_}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Tl(h,t){return[-(h[0]-Math.floor(h[0]/t)*t),-(h[1]-Math.floor(h[1]/t)*t),-(h[2]-Math.floor(h[2]/t)*t)]}function $p(h){const t=r.ea(1323123451230),s=[];for(let f=0;f<h;++f){const _=2*t()-1,g=2*t()-1,b=2*t()-1;s.push(r.cS(_,g,b))}return s}function Ca(h,t,s,f,_){const g=r.aD((_-s)/(f-s),0,1);return(1-g)*h+g*t}class eo{constructor(t){this._movement=new Vu,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Pf,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,s){const f=t.transform;this._movement.update(f,this._ppmScaleFactor);const _=f.starsProjMatrix,g=r.bY([]);r.b_(g,g,r.al(90)-f._pitch),r.bZ(g,g,-f.angle);const b=r.c3(new Float32Array(16),g),T=r.ep(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),A=r.ee([],T),z=r.az([],A,b),D=Date.now()/1e3;return this._accumulatedTimeFromStart+=(D-this._prevTime)*s,this._prevTime=D,{projectionMatrix:_,modelviewMatrix:z}}}class a1 extends eo{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new jp(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const s=t.context;if(!this.particlesVx){const f=$p(this.particlesCount),_=new r.er,g=new r.a_;let b=0;const T=r.ea(1323123451230);for(let A=0;A<f.length;++A){const z=f[A],D=[2*T()-1,T(),T(),T()];_.emplaceBack(z[0],z[1],z[2],-1,-1,...D),_.emplaceBack(z[0],z[1],z[2],1,-1,...D),_.emplaceBack(z[0],z[1],z[2],1,1,...D),_.emplaceBack(z[0],z[1],z[2],-1,1,...D),g.emplaceBack(b+0,b+1,b+2),g.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=s.createVertexBuffer(_,Cf.members),this.particlesIdx=s.createIndexBuffer(g)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const s=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},f=t.transform.zoom;if(s.revealStart>f)return;const _=Ca(0,1,s.revealStart,s.revealStart+s.revealRange,f);if(!this.particlesVx||!this.particlesIdx)return;const g=structuredClone(this._params);let b=[-g.direction.x,g.direction.y,-100];r.au(b,b);const T=structuredClone(this._vignetteParams);T.strength*=_,g.overrideStyleParameters||(g.intensity=t.style.rain.state.density,g.timeFactor=t.style.rain.state.intensity,g.color=structuredClone(t.style.rain.state.color),b=structuredClone(t.style.rain.state.direction),g.screenThinning.intensity=t.style.rain.state.centerThinning,g.dropletSizeX=t.style.rain.state.dropletSize[0],g.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],g.distortionStrength=100*t.style.rain.state.distortionStrength,T.strength=1,T.color=structuredClone(t.style.rain.state.vignetteColor));const A=this.updateOnRender(t,g.timeFactor),z=t.context,D=z.gl,F=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new r.T(z,{width:t.width,height:t.height,data:null},D.RGBA8)),g.distortionStrength>0&&(z.activeTexture.set(D.TEXTURE0),this.screenTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),D.copyTexSubImage2D(D.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const O=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(z,O),z.activeTexture.set(D.TEXTURE0),this.screenTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE);const U=[g.color.r,g.color.g,g.color.b,g.color.a],H=(q,Y)=>{const Z=Tl(this._movement.getPosition(),q),oe=g.dropletSizeX,fe=g.dropletSizeX*g.dropletSizeYScale,me=t.width/2,xe=t.height/2,ye=Ca(0,g.screenThinning.start,0,1,g.screenThinning.intensity),ve=Ca(.001,g.screenThinning.range,0,1,g.screenThinning.intensity),_e=Ca(0,g.screenThinning.particleOffset,0,1,g.screenThinning.intensity),we=(Te={modelview:A.modelviewMatrix,projection:A.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Z,velocityConeAperture:g.velocityConeAperture,velocity:g.velocity,boxSize:q,rainDropletSize:[oe,fe],distortionStrength:g.distortionStrength,rainDirection:b,color:U,screenSize:[F.width,F.height],thinningCenterPos:[me,xe],thinningShape:[ye,ve,Math.pow(10,g.screenThinning.fadePower)],thinningAffectedRatio:g.screenThinning.affectedRatio,thinningParticleOffset:_e,shapeDirectionalPower:g.shapeDirPower,shapeNormalPower:g.shapeNormalPower,mode:Y?0:1},{u_modelview:Float32Array.from(Te.modelview),u_projection:Float32Array.from(Te.projection),u_time:Te.time,u_cam_pos:Te.camPos,u_texScreen:0,u_velocityConeAperture:Te.velocityConeAperture,u_velocity:Te.velocity,u_boxSize:Te.boxSize,u_rainDropletSize:Te.rainDropletSize,u_distortionStrength:Te.distortionStrength,u_rainDirection:Te.rainDirection,u_color:Te.color,u_screenSize:Te.screenSize,u_thinningCenterPos:Te.thinningCenterPos,u_thinningShape:Te.thinningShape,u_thinningAffectedRatio:Te.thinningAffectedRatio,u_thinningParticleOffset:Te.thinningParticleOffset,u_shapeDirectionalPower:Te.shapeDirectionalPower,u_shapeNormalPower:Te.shapeNormalPower,u_mode:Te.mode});var Te;const Ue=Math.round(g.intensity*this.particlesCount),Fe=r.bd.simpleSegment(0,0,4*Ue,2*Ue);O.draw(t,D.TRIANGLES,Ut.disabled,sn.disabled,In.alphaBlended,an.disabled,we,"rain_particles",this.particlesVx,this.particlesIdx,Fe)};g.distortionStrength>0&&H(g.boxSize,!0),H(g.boxSize,!1),this._vignette.draw(t,T)}}const Uu=r.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class ki extends eo{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new jp(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const s=t.context;if(!this.particlesVx){const f=$p(this.particlesCount),_=new r.es,g=new r.a_;let b=0;const T=r.ea(1323123451230);for(let A=0;A<f.length;++A){const z=f[A],D=T(),F=T(),O=T(),U=[A/f.length,D,F,O],H=[T(),T()];_.emplaceBack(z[0],z[1],z[2],-1,-1,...U,...H),_.emplaceBack(z[0],z[1],z[2],1,-1,...U,...H),_.emplaceBack(z[0],z[1],z[2],1,1,...U,...H),_.emplaceBack(z[0],z[1],z[2],-1,1,...U,...H),g.emplaceBack(b+0,b+1,b+2),g.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=s.createVertexBuffer(_,Uu.members),this.particlesIdx=s.createIndexBuffer(g)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const s=structuredClone(this._params);let f=[-s.direction.x,s.direction.y,-100];r.au(f,f);const _=structuredClone(this._vignetteParams),g=s.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},b=t.transform.zoom;if(g.revealStart>b)return;const T=Ca(0,1,g.revealStart,g.revealStart+g.revealRange,b);_.strength*=T,s.overrideStyleParameters||(s.intensity=t.style.snow.state.density,s.timeFactor=t.style.snow.state.intensity,s.color=structuredClone(t.style.snow.state.color),f=structuredClone(t.style.snow.state.direction),s.screenThinning.intensity=t.style.snow.state.centerThinning,s.billboardSize=2.79*t.style.snow.state.flakeSize,_.strength=1,_.color=structuredClone(t.style.snow.state.vignetteColor));const A=this.updateOnRender(t,s.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const z=t.context,D=z.gl,F=t.transform,O=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(z,O),((U,H,q)=>{const Y=Tl(this._movement.getPosition(),U),Z=F.width/2,oe=F.height/2,fe=Ca(0,q.screenThinning.start,0,1,q.screenThinning.intensity),me=Ca(.001,q.screenThinning.range,0,1,q.screenThinning.intensity),xe=Ca(0,q.screenThinning.particleOffset,0,1,q.screenThinning.intensity),ye=(ve={modelview:A.modelviewMatrix,projection:A.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Y,velocityConeAperture:q.velocityConeAperture,velocity:q.velocity,horizontalOscillationRadius:q.horizontalOscillationRadius,horizontalOscillationRate:q.horizontalOscillationRate,boxSize:U,billboardSize:1*q.billboardSize,simpleShapeParameters:[q.shapeFadeStart,q.shapeFadePower],screenSize:[F.width,F.height],thinningCenterPos:[Z,oe],thinningShape:[fe,me,Math.pow(10,q.screenThinning.fadePower)],thinningAffectedRatio:q.screenThinning.affectedRatio,thinningParticleOffset:xe,color:[q.color.r,q.color.g,q.color.b,q.color.a],direction:f},{u_modelview:Float32Array.from(ve.modelview),u_projection:Float32Array.from(ve.projection),u_time:ve.time,u_cam_pos:ve.camPos,u_velocityConeAperture:ve.velocityConeAperture,u_velocity:ve.velocity,u_horizontalOscillationRadius:ve.horizontalOscillationRadius,u_horizontalOscillationRate:ve.horizontalOscillationRate,u_boxSize:ve.boxSize,u_billboardSize:ve.billboardSize,u_simpleShapeParameters:ve.simpleShapeParameters,u_screenSize:ve.screenSize,u_thinningCenterPos:ve.thinningCenterPos,u_thinningShape:ve.thinningShape,u_thinningAffectedRatio:ve.thinningAffectedRatio,u_thinningParticleOffset:ve.thinningParticleOffset,u_particleColor:ve.color,u_direction:ve.direction});var ve;const _e=Math.round(q.intensity*this.particlesCount),we=r.bd.simpleSegment(0,0,4*_e,2*_e);this.particlesVx&&this.particlesIdx&&O.draw(t,D.TRIANGLES,Ut.disabled,sn.disabled,In.alphaBlended,an.disabled,ye,"snow_particles",this.particlesVx,this.particlesIdx,we)})(s.boxSize,0,s),this._vignette.draw(t,_)}}const Yn={symbol:function(h,t,s,f,_){if(h.renderPass!=="translucent")return;const g=sn.disabled,b=h.colorModeForRenderPass(),T=s.layout.get("text-variable-anchor"),A=s.layout.get("text-size-scale-range"),z=r.aD(h.scaleFactor,A[0],A[1]);T&&function(O,U,H,q,Y,Z,oe,fe){const me=U.transform,xe=Y==="map",ye=Z==="map";for(const ve of O){const _e=q.getTile(ve),we=_e.getBucket(H);if(!we||!we.text||!we.text.segments.get().length)continue;const Te=r.bH(we.textSizeData,me.zoom,fe),Ue=vu(ve,we.getProjection(),me),Fe=me.calculatePixelsToTileUnitsMatrix(_e),ot=nc(Ue,_e.tileID.canonical,ye,xe,me,we.getProjection(),Fe),et=we.hasIconTextFit()&&we.hasIconData();Te&&Dp(we,xe,ye,oe,me,ot,ve,Math.pow(2,me.zoom-_e.tileID.overscaledZ),Te,et)}}(f,h,s,t,s.layout.get("text-rotation-alignment"),s.layout.get("text-pitch-alignment"),_,z);const D=s.paint.get("icon-opacity").constantOr(1)!==0,F=s.paint.get("text-opacity").constantOr(1)!==0;s.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(D||F)?Sf(h,t,s,f,g,b):(D&&Sf(h,t,s,f,g,b,{onlyIcons:!0}),F&&Sf(h,t,s,f,g,b,{onlyText:!0})),t.map.showCollisionBoxes&&(yc(h,t,s,f,s.paint.get("text-translate"),s.paint.get("text-translate-anchor"),!0),yc(h,t,s,f,s.paint.get("icon-translate"),s.paint.get("icon-translate-anchor"),!1))},circle:function(h,t,s,f){if(h.renderPass!=="translucent")return;const _=s.paint.get("circle-opacity"),g=s.paint.get("circle-stroke-width"),b=s.paint.get("circle-stroke-opacity"),T=s.layout.get("circle-sort-key").constantOr(1)!==void 0,A=s.paint.get("circle-emissive-strength");if(_.constantOr(1)===0&&(g.constantOr(1)===0||b.constantOr(1)===0))return;const z=h.context,D=z.gl,F=h.transform,O=h.depthModeForSublayer(0,Ut.ReadOnly),U=sn.disabled,H=h.colorModeForDrapableLayerRenderPass(A),q=F.projection.name==="globe",Y=[r.ay(F.center.lng),r.aH(F.center.lat)],Z=[];for(let fe=0;fe<f.length;fe++){const me=f[fe],xe=t.getTile(me),ye=xe.getBucket(s);if(!ye||ye.projection.name!==F.projection.name)continue;const ve=ye.programConfigurations.get(s.id),_e=r.dK(s),we=h.isTileAffectedByFog(me);q&&_e.push("PROJECTION_GLOBE_VIEW"),_e.push("DEPTH_D24"),h.terrain&&F.depthOcclusionForSymbolsAndCircles&&_e.push("DEPTH_OCCLUSION");const Te=h.getOrCreateProgram("circle",{config:ve,defines:_e,overrideFog:we}),Ue=ye.layoutVertexBuffer,Fe=ye.globeExtVertexBuffer,ot=ye.indexBuffer,et=F.projection.createInversionMatrix(F,me.canonical),xt={programConfiguration:ve,program:Te,layoutVertexBuffer:Ue,globeExtVertexBuffer:Fe,indexBuffer:ot,uniformValues:r.dL(h,me,xe,et,Y,s),tile:xe};if(T){const Oe=ye.segments.get();for(const je of Oe)Z.push({segments:new r.bd([je]),sortKey:je.sortKey,state:xt})}else Z.push({segments:ye.segments,sortKey:0,state:xt})}T&&Z.sort((fe,me)=>fe.sortKey-me.sortKey);const oe={useDepthForOcclusion:F.depthOcclusionForSymbolsAndCircles};for(const fe of Z){const{programConfiguration:me,program:xe,layoutVertexBuffer:ye,globeExtVertexBuffer:ve,indexBuffer:_e,uniformValues:we,tile:Te}=fe.state,Ue=fe.segments;h.terrain&&h.terrain.setupElevationDraw(Te,xe,oe),h.uploadCommonUniforms(z,xe,Te.tileID.toUnwrapped()),xe.draw(h,D.TRIANGLES,O,U,H,an.disabled,we,s.id,ye,_e,Ue,s.paint,F.zoom,me,[ve])}},heatmap:function(h,t,s,f){if(s.paint.get("heatmap-opacity")!==0)if(h.renderPass==="offscreen"){const _=h.context,g=_.gl,b=sn.disabled,T=new In([g.ONE,g.ONE,g.ONE,g.ONE],r.am.transparent,[!0,!0,!0,!0]);(function(U,H,q,Y){const Z=U.gl,oe=H.width*Y,fe=H.height*Y;U.activeTexture.set(Z.TEXTURE1),U.viewport.set([0,0,oe,fe]);let me=q.heatmapFbo;if(!me||me&&(me.width!==oe||me.height!==fe)){me&&me.destroy();const xe=Z.createTexture();Z.bindTexture(Z.TEXTURE_2D,xe),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MIN_FILTER,Z.LINEAR),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MAG_FILTER,Z.LINEAR),me=q.heatmapFbo=U.createFramebuffer(oe,fe,!0,null),function(ye,ve,_e,we,Te,Ue){const Fe=ye.gl;Fe.texImage2D(Fe.TEXTURE_2D,0,ye.extRenderToTextureHalfFloat?Fe.RGBA16F:Fe.RGBA,Te,Ue,0,Fe.RGBA,ye.extRenderToTextureHalfFloat?Fe.HALF_FLOAT:Fe.UNSIGNED_BYTE,null),we.colorAttachment.set(_e)}(U,0,xe,me,oe,fe)}else Z.bindTexture(Z.TEXTURE_2D,me.colorAttachment.get()),U.bindFramebuffer.set(me.framebuffer)})(_,h,s,h.transform.projection.name==="globe"?.5:.25),_.clear({color:r.am.transparent});const A=h.transform,z=A.projection.name==="globe",D=z?["PROJECTION_GLOBE_VIEW"]:[],F=z?an.frontCCW:an.disabled,O=[r.ay(A.center.lng),r.aH(A.center.lat)];for(let U=0;U<f.length;U++){const H=f[U];if(t.hasRenderableParent(H))continue;const q=t.getTile(H),Y=q.getBucket(s);if(!Y||Y.projection.name!==A.projection.name)continue;const Z=h.isTileAffectedByFog(H),oe=Y.programConfigurations.get(s.id),fe=h.getOrCreateProgram("heatmap",{config:oe,defines:D,overrideFog:Z}),{zoom:me}=h.transform;h.terrain&&h.terrain.setupElevationDraw(q,fe),h.uploadCommonUniforms(_,fe,H.toUnwrapped());const xe=A.projection.createInversionMatrix(A,H.canonical);fe.draw(h,g.TRIANGLES,Ut.disabled,b,T,F,Eg(h,H,q,xe,O,me,s.paint.get("heatmap-intensity")),s.id,Y.layoutVertexBuffer,Y.indexBuffer,Y.segments,s.paint,h.transform.zoom,oe,z?[Y.globeExtVertexBuffer]:null)}_.viewport.set([0,0,h.width,h.height])}else h.renderPass==="translucent"&&(h.context.setColorMode(h.colorModeForRenderPass()),function(_,g){const b=_.context,T=b.gl,A=g.heatmapFbo;if(!A)return;b.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,A.colorAttachment.get()),b.activeTexture.set(T.TEXTURE1);let z=g.colorRampTexture;z||(z=g.colorRampTexture=new r.T(b,g.colorRamp,T.RGBA8)),z.bind(T.LINEAR,T.CLAMP_TO_EDGE),_.getOrCreateProgram("heatmapTexture").draw(_,T.TRIANGLES,Ut.disabled,sn.disabled,_.colorModeForRenderPass(),an.disabled,((D,F,O,U)=>({u_image:0,u_color_ramp:1,u_opacity:F.paint.get("heatmap-opacity")}))(0,g),g.id,_.viewportBuffer,_.quadTriangleIndexBuffer,_.viewportSegments,g.paint,_.transform.zoom)}(h,s))},line:function(h,t,s,f){if(h.renderPass!=="translucent")return;const _=s.paint.get("line-opacity"),g=s.paint.get("line-width");if(_.constantOr(1)===0||g.constantOr(1)===0)return;const b=s.paint.get("line-emissive-strength"),T=s.paint.get("line-occlusion-opacity"),A=s.layout.get("line-elevation-reference"),z=s.layout.get("line-width-unit")==="meters",D=A==="sea",F=!(!h.terrain||!h.terrain.enabled),O=h.context,U=O.gl;if(s.hasElevatedBuckets&&h.transform.projection.name==="globe")return;const H=s.layout.get("line-cross-slope"),q=H!==void 0,Y=H<1,Z=h.colorModeForDrapableLayerRenderPass(b),oe=h.terrain&&h.terrain.renderingToTexture,fe=oe?1:r.q.devicePixelRatio,me=s.paint.get("line-dasharray"),xe=me.constantOr(1),ye=s.layout.get("line-cap"),ve=me.constantOr(null),_e=ye.constantOr(null),we=s.paint.get("line-pattern"),Te=we.constantOr(1),Ue=s.paint.get("line-pattern-cross-fade"),Fe=we.constantOr(null),ot=s.paint.get("line-opacity").constantOr(1);let et=!Te&&ot!==1||h.depthOcclusion&&T>0&&T<1;const xt=s.paint.get("line-gradient"),Oe=Te?"linePattern":"line",je=r.dM(s);let Le;if(oe&&h.terrain&&h.terrain.clipOrMaskOverlapStencilType()&&(et=!1),T!==0&&h.depthOcclusion){const st=s.paint._values["line-opacity"];st&&st.value&&st.value.kind==="constant"?Le=st.value:r.w(`Occlusion opacity for layer ${s.id} is supported only when line-opacity isn't data-driven.`)}g.value.kind!=="constant"&&g.value.isLineProgressConstant===!1&&je.push("VARIABLE_LINE_WIDTH");const lt=(st,pt,mt,Vt,Xt,Bt)=>{for(const Yt of st){const jt=t.getTile(Yt);if(Te&&!jt.patternsLoaded())continue;const en=jt.getBucket(s);if(!en||en.elevationType!=="none"&&!Xt||en.elevationType==="none"&&Xt)continue;h.prepareDrawTile();const cn=[...pt],Rn=h.shadowRenderer,ai=en.elevationType==="road"&&!!Rn&&Rn.enabled;let ii=[0,0,0];if(ai){const xn=h.style.directionalLight,Pi=h.style.ambientLight;xn&&Pi&&(ii=Es(h.style,xn,Pi)),cn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const Ln=en.programConfigurations.get(s.id);let Zi=!1;if(Fe&&jt.imageAtlas){const xn=r.dN.from(Fe),Pi=xn.getPrimary().scaleSelf(fe).toString(),Gn=jt.imageAtlas.patternPositions.get(Pi),zi=xn.getSecondary(),Jn=zi?jt.imageAtlas.patternPositions.get(zi.scaleSelf(fe).toString()):null;Zi=!!Gn&&!!Jn,Gn&&Ln.setConstantPatternPositions(Gn,Jn)}Ue>0&&(Zi||Ln.getPatternTransitionVertexBuffer("line-pattern"))&&cn.push("LINE_PATTERN_TRANSITION");const Ni=h.isTileAffectedByFog(Yt),pn=h.getOrCreateProgram(Oe,{config:Ln,defines:cn,overrideFog:Ni,overrideRtt:!Xt&&void 0});if(!Te&&ve&&_e&&jt.lineAtlas){const xn=jt.lineAtlas.getDash(ve,_e);xn&&Ln.setConstantPatternPositions(xn)}ai&&Rn.setupShadows(jt.tileID.toUnwrapped(),pn,"vector-tile",jt.tileID.overscaledZ);let[Vn,Zn]=s.paint.get("line-trim-offset");(_e==="round"||_e==="square")&&Vn!==Zn&&(Vn===0&&(Vn-=1),Zn===1&&(Zn+=1));const li=oe?Yt.projMatrix:null,or=z?1/en.tileToMeter/r.aw(jt,1,h.transform.zoom):1,Yi=z?1/en.tileToMeter/r.aw(jt,1,Math.floor(h.transform.zoom)):1,rr=Te?r.dO(h,jt,s,li,fe,or,Yi,[Vn,Zn],ii,Ue):r.dP(h,jt,s,li,en.lineClipsArray.length,fe,or,Yi,[Vn,Zn],ii);if(xt){const xn=en.gradients[s.id];let Pi=xn.texture;if(s.gradientVersion!==xn.version){let Gn=256;if(s.stepInterpolant){const zi=t.getSource().maxzoom,Jn=Yt.canonical.z===zi?Math.ceil(1<<h.transform.maxZoom-Yt.canonical.z):1;Gn=r.aD(r.dQ(en.maxLineLength/r.aj*1024*Jn),256,O.maxTextureSize)}xn.gradient=r.dR({expression:s.gradientExpression(),evaluationKey:"lineProgress",resolution:Gn,image:xn.gradient||void 0,clips:en.lineClipsArray}),xn.texture?xn.texture.update(xn.gradient):xn.texture=new r.T(O,xn.gradient,U.RGBA8),xn.version=s.gradientVersion,Pi=xn.texture}O.activeTexture.set(U.TEXTURE1),Pi.bind(s.stepInterpolant?U.NEAREST:U.LINEAR,U.CLAMP_TO_EDGE)}xe&&(O.activeTexture.set(U.TEXTURE0),jt.lineAtlasTexture&&jt.lineAtlasTexture.bind(U.LINEAR,U.REPEAT),Ln.updatePaintBuffers()),Te&&(O.activeTexture.set(U.TEXTURE0),jt.imageAtlasTexture&&jt.imageAtlasTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),Ln.updatePaintBuffers()),Xt&&!D&&h.terrain.setupElevationDraw(jt,pn),h.uploadCommonUniforms(O,pn,Yt.toUnwrapped());const Oi=xn=>{Le!=null&&(Le.value=ot*T),pn.draw(h,U.TRIANGLES,mt,xn,Z,an.disabled,rr,s.id,en.layoutVertexBuffer,en.indexBuffer,en.segments,s.paint,h.transform.zoom,Ln,[en.layoutVertexBuffer2,en.patternVertexBuffer,en.zOffsetVertexBuffer]),Le!=null&&(Le.value=ot)};if(et&&!Xt){const xn=h.stencilModeForClipping(Yt).ref;xn===0&&oe&&O.clear({stencil:0});const Pi={func:U.EQUAL,mask:255};rr.u_alpha_discard_threshold=.8,Oi(new sn(Pi,xn,255,U.KEEP,U.KEEP,U.INVERT)),rr.u_alpha_discard_threshold=0,Oi(new sn(Pi,xn,255,U.KEEP,U.KEEP,U.KEEP))}else rr.u_alpha_discard_threshold=et&&Xt&&Bt?.8:0,Oi(Xt?Vt:h.stencilModeForClipping(Yt))}};let Ze=h.depthModeForSublayer(0,Ut.ReadOnly);const dt=new Ut(h.depthOcclusion?U.GREATER:U.LEQUAL,Ut.ReadOnly,h.depthRangeFor3D);if(s.hasNonElevatedBuckets){const st=!oe&&h.terrain;T!==0&&st?r.w(`Occlusion opacity for layer ${s.id} is supported on terrain only if the layer has line-z-offset enabled.`):st?r.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${s.id}.`):lt(f,je,Ze,sn.disabled,!1,!0)}if(s.hasElevatedBuckets){A==="hd-road-markup"?F||(Ze=dt,je.push("ELEVATED_ROADS")):(je.push("ELEVATED"),Ze=dt,q&&je.push(Y?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),D&&je.push("ELEVATION_REFERENCE_SEA"));const st=et?h.stencilModeFor3D():sn.disabled;h.forceTerrainMode=!0,lt(f,je,Ze,st,!0,!0),et&&lt(f,je,Ze,st,!0,!1),h.forceTerrainMode=!1}et&&(h.resetStencilClippingMasks(),oe&&O.clear({stencil:0})),T===0||h.depthOcclusion||oe||h.layersWithOcclusionOpacity.push(h.currentLayer)},fill:function(h,t,s,f){const _=s.paint.get("fill-color"),g=s.paint.get("fill-opacity");if(g.constantOr(1)===0)return;const b=s.paint.get("fill-emissive-strength"),T=h.colorModeForDrapableLayerRenderPass(b),A=s.paint.get("fill-pattern"),z=h.opaquePassEnabledForLayer()&&!A.constantOr(1)&&_.constantOr(r.am.transparent).a===1&&g.constantOr(0)===1?"opaque":"translucent";let D="none";s.layout.get("fill-elevation-reference")!=="none"?D="road":s.paint.get("fill-z-offset").constantOr(1)!==0&&(D="offset");const F=!(!h.terrain||!h.terrain.enabled),O={painter:h,sourceCache:t,layer:s,coords:f,colorMode:T,elevationType:D,terrainEnabled:F,pass:z};if(h.renderPass!=="shadow")if(D!=="offset"){if(Ft(O,!1),D==="road"){const U=!F&&h.renderPass==="translucent";U&&Ou(h,t,s,f,"geometry"),Ft(O,!0,sn.disabled),U&&function(H){const{painter:q,sourceCache:Y,layer:Z,coords:oe,colorMode:fe}=H,me=q.context.gl,xe=H.painter.shadowRenderer,ye=!!xe&&xe.enabled,ve=new Ut(q.context.gl.LEQUAL,Ut.ReadOnly,q.depthRangeFor3D);let _e=[0,0,0];if(ye){const we=q.style.directionalLight,Te=q.style.ambientLight;we&&Te&&(_e=Es(q.style,we,Te))}for(const we of oe){const Te=Y.getTile(we),Ue=Te.getBucket(Z);if(!Ue)continue;const Fe=Ue.elevatedStructures;if(!Fe||!Fe.renderableSegments||Fe.renderableSegments.segments[0].primitiveLength===0)continue;q.prepareDrawTile();const ot=Ue.bufferData.programConfigurations.get(Z.id),et=q.isTileAffectedByFog(we),xt=[];ye&&xt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Oe=q.getOrCreateProgram("elevatedStructures",{config:ot,overrideFog:et,defines:xt}),je=q.translatePosMatrix(we.projMatrix,Te,Z.paint.get("fill-translate"),Z.paint.get("fill-translate-anchor"));ye&&xe.setupShadows(Te.tileID.toUnwrapped(),Oe,"vector-tile",Te.tileID.overscaledZ);const Le=Mp(je,_e);q.uploadCommonUniforms(q.context,Oe,we.toUnwrapped()),Oe.draw(q,me.TRIANGLES,ve,sn.disabled,fe,an.backCCW,Le,Z.id,Fe.vertexBuffer,Fe.indexBuffer,Fe.renderableSegments,Z.paint,q.transform.zoom,ot,[Fe.vertexBufferNormal])}}(O)}}else Ft(O,!1,h.stencilModeFor3D());else h.shadowRenderer&&D==="road"&&!F&&function(U){const{painter:H,sourceCache:q,layer:Y,coords:Z}=U,oe=H.context.gl,fe=U.painter.shadowRenderer;for(const me of Z){const xe=q.getTile(me),ye=xe.getBucket(Y);if(!ye)continue;const ve=ye.elevatedStructures;if(!ve||!ve.shadowCasterSegments||ve.shadowCasterSegments.segments[0].primitiveLength===0)continue;H.prepareDrawTile();const _e=ye.bufferData.programConfigurations.get(Y.id),we=H.isTileAffectedByFog(me),Te=H.getOrCreateProgram("elevatedStructuresDepth",{config:_e,overrideFog:we}),Ue=fe.calculateShadowPassMatrixFromTile(xe.tileID.toUnwrapped());H.uploadCommonUniforms(H.context,Te,me.toUnwrapped());const Fe={u_matrix:Ue,u_depth_bias:.001};Te.draw(H,oe.TRIANGLES,fe.getShadowPassDepthMode(),sn.disabled,fe.getShadowPassColorMode(),an.disabled,Fe,Y.id,ve.vertexBuffer,ve.indexBuffer,ve.shadowCasterSegments,Y.paint,H.transform.zoom,_e)}}(O)},"fill-extrusion":function(h,t,s,f){const _=s.paint.get("fill-extrusion-opacity"),g=h.context,b=g.gl,T=h.terrain,A=T&&T.renderingToTexture;if(_===0)return;const z=h.conflationActive&&h.style.isLayerClipped(s,t.getSource()),D=h.style.order.indexOf(s.fqid);if(z&&function(F,O,U,H,q){for(const Y of H){const Z=O.getTile(Y).getBucket(U);Z&&(Z.updateReplacement(Y,F.replacementSource,q),Z.uploadCentroid(F.context))}}(h,t,s,f,D),T||z)for(const F of f){const O=t.getTile(F).getBucket(s);O&&Ea(h.context,t,F,O,s,T,z)}if(h.renderPass==="shadow"&&h.shadowRenderer){const F=h.shadowRenderer;if(T&&_<.65&&s._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof r.ab)return;const O=F.getShadowPassDepthMode(),U=F.getShadowPassColorMode();Fu(h,t,s,f,O,sn.disabled,U,z)}else if(h.renderPass==="translucent"){const F=!s.paint.get("fill-extrusion-pattern").constantOr(1),O=s.paint.get("fill-extrusion-color").constantOr(r.am.white);if(!A&&O.a!==0){const U=new Ut(h.context.gl.LEQUAL,Ut.ReadWrite,h.depthRangeFor3D);_===1&&F?Fu(h,t,s,f,U,sn.disabled,In.unblended,z):(Fu(h,t,s,f,U,sn.disabled,In.disabled,z),Fu(h,t,s,f,U,h.stencilModeFor3D(),h.colorModeForRenderPass(),z),h.resetStencilClippingMasks())}if(h.style.enable3dLights()&&F&&(!T&&h.transform.projection.name!=="globe"||A)){const U=s.paint.get("fill-extrusion-opacity"),H=s.paint.get("fill-extrusion-ambient-occlusion-intensity"),q=s.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Y=s.paint.get("fill-extrusion-flood-light-intensity"),Z=s.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",oe=s.paint.get("fill-extrusion-flood-light-color").toRenderColor(Z?null:s.lut).toArray01().slice(0,3),fe=H>0&&q>0,me=Y>0,xe=(ve,_e,we)=>(1-we)*ve+we*_e,ye=ve=>{const _e=h.depthModeForSublayer(1,Ut.ReadOnly,b.LEQUAL,!0),we=s.paint.get(ve?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Te=xe(.1,3,we),Ue=h._showOverdrawInspector;if(!Ue){const Fe=new sn({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),ot=new In([b.ONE,b.ONE,b.ONE,b.ONE],r.am.transparent,[!1,!1,!1,!0],b.MIN);vl(h,t,s,f,_e,Fe,ot,an.disabled,ve,"sdf",U,H,q,Y,oe,Te,z,!1)}{const Fe=Ue?sn.disabled:new sn({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),ot=Ue?h.colorModeForRenderPass():new In([b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE,b.ONE],r.am.transparent,[!0,!0,!0,!0]);vl(h,t,s,f,_e,Fe,ot,an.disabled,ve,"color",U,H,q,Y,oe,Te,z,!1)}};if(A){const ve=(_e,we,Te)=>{const Ue=h.depthModeForSublayer(1,Ut.ReadOnly,b.LEQUAL,!1),Fe=s.paint.get(_e?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ot=xe(.1,3,Fe);{const et=new In([b.ONE,b.ONE,b.ONE,b.ONE],r.am.transparent,[!1,!1,!1,!0]);vl(h,t,s,f,Ue,sn.disabled,et,an.disabled,_e,"clear",U,H,q,Y,oe,ot,z,we)}{const et=new sn({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),xt=new In([b.ONE,b.ONE,b.ONE,b.ONE],r.am.transparent,[!1,!1,!1,!0],b.MIN);vl(h,t,s,f,Ue,et,xt,an.disabled,_e,"sdf",U,H,q,Y,oe,ot,z,we)}{const et=_e?b.ZERO:b.ONE_MINUS_DST_ALPHA,xt=new sn({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),Oe=new In([et,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ZERO],r.am.transparent,[!0,!0,!0,!0]);vl(h,t,s,f,Ue,xt,Oe,an.disabled,_e,"color",U,H,q,Y,oe,ot,z,we)}{const et=new In([b.ONE,b.ONE,b.ONE,_e?b.ZERO:b.ONE],r.am.transparent,[!1,!1,!1,!0],_e?b.FUNC_ADD:b.MAX);vl(h,t,s,f,Ue,sn.disabled,et,an.disabled,_e,"clear",U,H,q,Y,oe,ot,z,we,Te)}};if(fe||me){let _e;if(h.prepareDrawTile(),T){const we=T.drapeBufferSize[0],Te=T.drapeBufferSize[1];_e=T.framebufferCopyTexture,_e&&(!_e||_e.size[0]===we&&_e.size[1]===Te)||(_e&&_e.destroy(),_e=T.framebufferCopyTexture=new r.T(g,new r.r({width:we,height:Te}),b.RGBA8)),_e.bind(b.LINEAR,b.CLAMP_TO_EDGE),b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,0,0,we,Te)}fe&&ve(!0,!1,_e),me&&ve(!1,!0,_e)}}else fe&&ye(!0),me&&ye(!1),(fe||me)&&h.resetStencilClippingMasks()}}},hillshade:function(h,t,s,f){if(h.renderPass!=="offscreen"&&h.renderPass!=="translucent"||h.style.disableElevatedTerrain)return;const _=h.context,g=h.terrain&&h.terrain.renderingToTexture,[b,T]=h.renderPass!=="translucent"||g?[{},f]:h.stencilConfigForOverlap(f);for(const A of T){const z=t.getTile(A);if(z.needsHillshadePrepare&&h.renderPass==="offscreen")pp(h,z,s);else if(h.renderPass==="translucent"){const D=h.depthModeForSublayer(0,Ut.ReadOnly),F=s.paint.get("hillshade-emissive-strength"),O=h.colorModeForDrapableLayerRenderPass(F),U=g&&h.terrain?h.terrain.stencilModeForRTTOverlap(A):b[A.overscaledZ];ug(h,A,z,s,D,U,O)}}_.viewport.set([0,0,h.width,h.height]),h.resetStencilClippingMasks()},raster:function(h,t,s,f,_,g){if(h.renderPass!=="translucent"||s.paint.get("raster-opacity")===0)return;const b=h.transform.projection.name==="globe",T=s.paint.get("raster-elevation")!==0,A=T&&b;if(h.renderElevatedRasterBackface&&!A)return;const z=h.context,D=z.gl,F=t.getSource(),O=function(ye,ve,_e,we){const Te=ve.paint.get("raster-color"),Ue=ye.type==="raster-array",Fe=[],ot=ve.paint.get("raster-resampling"),et=ve.paint.get("raster-color-mix");let xt=ve.paint.get("raster-color-range");const Oe=[et[0],et[1],et[2],0],je=et[3];let Le=ot==="nearest"?we.NEAREST:we.LINEAR;if(Ue&&(Fe.push("RASTER_ARRAY"),Te||Fe.push("RASTER_COLOR"),ot==="linear"&&Fe.push("RASTER_ARRAY_LINEAR"),Le=we.NEAREST,!xt&&ye.rasterLayers)){const lt=ye.rasterLayers.find(({id:Ze})=>Ze===ve.sourceLayer);lt&&lt.fields&&lt.fields.range&&(xt=lt.fields.range)}if(xt=xt||[0,1],Te){Fe.push("RASTER_COLOR"),_e.activeTexture.set(we.TEXTURE2),ve.updateColorRamp(xt);let lt=ve.colorRampTexture;lt||(lt=ve.colorRampTexture=new r.T(_e,ve.colorRamp,we.RGBA8)),lt.bind(we.LINEAR,we.CLAMP_TO_EDGE)}return{mix:Oe,range:xt,offset:je,defines:Fe,resampling:Le}}(F,s,z,D);if(F instanceof r.aP&&!f.length&&!b)return;const U=s.paint.get("raster-emissive-strength"),H=h.colorModeForDrapableLayerRenderPass(U),q=h.terrain&&h.terrain.renderingToTexture,Y=!h.options.moving,Z=s.paint.get("raster-resampling")==="nearest"?D.NEAREST:D.LINEAR;if(F instanceof r.aP&&!f.length&&(F.onNorthPole||F.onSouthPole)){const ye=T?h.stencilModeFor3D():sn.disabled;return void Bu(!!F.onNorthPole,null,h,t,s,U,O,an.disabled,ye)}if(!f.length)return;const[oe,fe]=F instanceof r.aP||q?[{},f]:h.stencilConfigForOverlap(f),me=fe[fe.length-1].overscaledZ;A&&O.defines.push("PROJECTION_GLOBE_VIEW"),T&&O.defines.push("RENDER_CUTOFF");const xe=(ye,ve,_e)=>{for(const we of ye){const Te=we.toUnwrapped(),Ue=t.getTile(we);if(q&&(!Ue||!Ue.hasData()))continue;z.activeTexture.set(D.TEXTURE0);const Fe=t1(Ue,F,s,O);if(!Fe||!Fe.texture)continue;const{texture:ot,mix:et,offset:xt,tileSize:Oe,buffer:je}=Fe;let Le,lt;q?(Le=Ut.disabled,lt=we.projMatrix):T?(Le=new Ut(D.LEQUAL,Ut.ReadWrite,h.depthRangeFor3D),lt=b?Float32Array.from(h.transform.expandedFarZProjMatrix):h.transform.calculateProjMatrix(Te,Y)):(Le=h.depthModeForSublayer(we.overscaledZ-me,s.paint.get("raster-opacity")===1?Ut.ReadWrite:Ut.ReadOnly,D.LESS),lt=h.transform.calculateProjMatrix(Te,Y));const Ze=h.terrain&&q?h.terrain.stencilModeForRTTOverlap(we):oe[we.overscaledZ],dt=g?0:s.paint.get("raster-fade-duration");Ue.registerFadeDuration(dt);const st=t.findLoadedParent(we,0),pt=Pu(Ue,st,t,h.transform,dt);let mt,Vt;h.terrain&&h.terrain.prepareDrawTile(),z.activeTexture.set(D.TEXTURE0),ot.bind(Z,D.CLAMP_TO_EDGE),z.activeTexture.set(D.TEXTURE1),st?(st.texture&&st.texture.bind(Z,D.CLAMP_TO_EDGE),mt=Math.pow(2,st.tileID.overscaledZ-Ue.tileID.overscaledZ),Vt=[Ue.tileID.canonical.x*mt%1,Ue.tileID.canonical.y*mt%1]):ot.bind(Z,D.CLAMP_TO_EDGE),"useMipmap"in ot&&z.extTextureFilterAnisotropic&&h.transform.pitch>20&&D.texParameterf(D.TEXTURE_2D,z.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,z.extTextureFilterAnisotropicMax);const Xt=h.transform;let Bt;const Yt=T?zg(Xt):[0,0,0,0];let jt,en,cn,Rn,ai,ii=0;if(A&&F instanceof r.aP&&F.coordinates.length>3)jt=Float32Array.from(r.bh(r.dr(new r.cp(0,0,0)))),en=Float32Array.from(Xt.globeMatrix),cn=Float32Array.from(r.dm(Xt)),Rn=[r.ay(Xt.center.lng),r.aH(Xt.center.lat)],Bt=F.elevatedGlobePerspectiveTransform,ai=F.elevatedGlobeGridMatrix||new Float32Array(9);else if(A){const pn=r.dn(we.canonical);ii=r.dp(pn.getCenter().lat),jt=Float32Array.from(r.bh(r.dr(we.canonical))),en=Float32Array.from(Xt.globeMatrix),cn=Float32Array.from(r.dm(Xt)),Rn=[r.ay(Xt.center.lng),r.aH(Xt.center.lat)],Bt=[0,0],ai=Float32Array.from(r.dq(we.canonical,pn,ii,Xt.worldSize/Xt._pixelsPerMercatorPixel))}else Bt=F instanceof r.aP?F.perspectiveTransform:[0,0],jt=new Float32Array(16),en=new Float32Array(9),cn=new Float32Array(16),Rn=[0,0],ai=new Float32Array(9);const Ln=Sa(lt,jt,en,cn,ai,Vt||[0,0],r.ah(h.transform.zoom),Rn,Yt,mt||1,pt,s,Bt,T?s.paint.get("raster-elevation"):0,2,et,xt,O.range,Oe,je,U),Zi=h.isTileAffectedByFog(we),Ni=h.getOrCreateProgram("raster",{defines:O.defines,overrideFog:Zi});if(h.uploadCommonUniforms(z,Ni,Te),F instanceof r.aP){const pn=F.elevatedGlobeVertexBuffer,Vn=F.elevatedGlobeIndexBuffer;if(q||!b)F.boundsBuffer&&F.boundsSegments&&Ni.draw(h,D.TRIANGLES,Le,sn.disabled,H,an.disabled,Ln,s.id,F.boundsBuffer,h.quadTriangleIndexBuffer,F.boundsSegments);else if(pn&&Vn){const Zn=Xt.zoom<=r.cL?F.elevatedGlobeSegments:F.getSegmentsForLongitude(Xt.center.lng);Zn&&Ni.draw(h,D.TRIANGLES,Le,sn.disabled,H,ve,Ln,s.id,pn,Vn,Zn)}}else if(A){Le=new Ut(D.LEQUAL,Ut.ReadOnly,h.depthRangeFor3D);const pn=h.globeSharedBuffers;if(pn){const[Vn,Zn,li]=pn.getGridBuffers(ii,!1);Ni.draw(h,D.TRIANGLES,Le,_e||Ze,h.colorModeForRenderPass(),ve,Ln,s.id,Vn,Zn,li)}}else{const{tileBoundsBuffer:pn,tileBoundsIndexBuffer:Vn,tileBoundsSegments:Zn}=h.getTileBoundsBuffers(Ue);Ni.draw(h,D.TRIANGLES,Le,Ze,H,an.disabled,Ln,s.id,pn,Vn,Zn)}}if(!(F instanceof r.aP)&&A)for(const we of ye){const Te=we.canonical.y===(1<<we.canonical.z)-1;we.canonical.y===0&&Bu(!0,we,h,t,s,U,O,ve,_e||sn.disabled),Te&&Bu(!1,we,h,t,s,U,O,ve===an.frontCW?an.backCW:an.frontCW,_e||sn.disabled)}};A?xe(fe,h.renderElevatedRasterBackface?an.backCW:an.frontCW,h.stencilModeFor3D()):xe(fe,an.disabled,void 0),h.resetStencilClippingMasks()},"raster-particle":function(h,t,s,f,_,g){h.renderPass==="offscreen"&&function(b,T,A,z){if(!z.length)return;const D=b.context,F=D.gl,O=T.getSource();if(!(O instanceof nl))return;const U=Math.ceil(Math.sqrt(A.paint.get("raster-particle-count")));let H=A.particlePositionRGBAImage;if(!H||H.width!==U){const fe=function(me){const xe=me*me,ye=new Uint8Array(4*xe),ve=function(we){return we|=0,we=Math.imul(2747636419^we,2654435769),we=Math.imul(we^we>>>16,2654435769),((we=Math.imul(we^we>>>16,2654435769))>>>0)/4294967296},_e=1/1.1;for(let we=0;we<xe;we++){const Te=_e*(ve(2*we+0)+Co),Ue=_e*(ve(2*we+1)+Co),Fe=255*Te%1,ot=255*Ue%1,et=Fe,xt=Ue-ot/255,Oe=ot;ye[4*we+0]=255*(Te-Fe/255),ye[4*we+1]=255*et,ye[4*we+2]=255*xt,ye[4*we+3]=255*Oe}return ye}(U);H=A.particlePositionRGBAImage=new r.r({width:U,height:U},fe)}let q=A.particleFramebuffer;q?q.width!==U&&(q.destroy(),q=A.particleFramebuffer=D.createFramebuffer(U,U,!0,null)):q=A.particleFramebuffer=D.createFramebuffer(U,U,!0,null);const Y=[];for(const fe of z){const me=T.getTile(fe);if(!(me instanceof mu))continue;const xe=i1(me,O,A);if(!xe)continue;const ye=[me.tileSize,me.tileSize];let ve=A.tileFramebuffer;ve||(ve=A.tileFramebuffer=D.createFramebuffer(ye[0],ye[1],!0,null));let _e=me.rasterParticleState;_e||(_e=me.rasterParticleState=new n1(D,fe,ye,H));const we=_e.update(A.lastInvalidatedAt);_e.particleTextureDimension!==U&&_e.updateParticleTexture(fe,H);const Te=_e.targetColorTexture;_e.targetColorTexture=_e.backgroundColorTexture,_e.backgroundColorTexture=Te;const Ue=_e.particleTexture0;_e.particleTexture0=_e.particleTexture1,_e.particleTexture1=Ue,Y.push([fe,xe,_e,we])}if(Y.length===0)return;const Z=r.q.now(),oe=A.previousDrawTimestamp?.001*(Z-A.previousDrawTimestamp):.0167;if(A.previousDrawTimestamp=Z,A.hasColorMap()){D.activeTexture.set(F.TEXTURE0+2);let fe=A.colorRampTexture;fe||(fe=A.colorRampTexture=new r.T(D,A.colorRamp,F.RGBA8)),fe.bind(F.LINEAR,F.CLAMP_TO_EDGE)}D.bindFramebuffer.set(A.tileFramebuffer.framebuffer),function(fe,me,xe){const ye=fe.context,ve=ye.gl,_e=me.tileFramebuffer;ye.activeTexture.set(ve.TEXTURE0);const we={u_texture:0,u_opacity:1.05*(Ue=me.paint.get("raster-particle-fade-opacity-factor"))/(Ue+.05)},Te=fe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ue;for(const Fe of xe){const[,,ot,et]=Fe;_e.colorAttachment.set(ot.targetColorTexture.texture),ye.viewport.set([0,0,_e.width,_e.height]),ye.clear({color:r.am.transparent}),et&&(ot.backgroundColorTexture.bind(ve.NEAREST,ve.CLAMP_TO_EDGE),Te.draw(fe,ve.TRIANGLES,Ut.disabled,sn.disabled,In.alphaBlended,an.disabled,we,me.id,fe.viewportBuffer,fe.quadTriangleIndexBuffer,fe.viewportSegments))}}(b,A,Y),function(fe,me,xe,ye){const ve=fe.context,_e=ve.gl,we=xe.tileFramebuffer,Te=fe.transform.projection.name==="globe",Ue=xe.paint.get("raster-particle-max-speed");for(const Fe of ye){const[ot,et,xt]=Fe;ve.activeTexture.set(_e.TEXTURE0+0),et.texture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE),we.colorAttachment.set(xt.targetColorTexture.texture);const Oe=fe.getOrCreateProgram("rasterParticleDraw",{defines:et.defines,overrideFog:!1});ve.activeTexture.set(_e.TEXTURE0+1);const je=et.scalarData?[]:[0,1,2,3].map(Ze=>r.dU[Ze](ot));je.push(ot);const Le=ot.canonical.x,lt=ot.canonical.y;for(const Ze of je){const dt=me.getTile(Te?Ze.wrapped():Ze);if(!dt)continue;const st=dt.rasterParticleState;if(!st)continue;const pt=Ze.canonical.x+(1<<Ze.canonical.z)*(Ze.wrap-ot.wrap),mt=Ze.canonical.y;st.particleTexture0.bind(_e.NEAREST,_e.CLAMP_TO_EDGE);const Vt=yf(1,st.particleTexture0.size[0],[pt-Le,mt-lt],0,et.texture.size,2,Ue,et.textureOffset,et.scale,et.offset);Oe.draw(fe,_e.POINTS,Ut.disabled,sn.disabled,In.alphaBlended,an.disabled,Vt,xe.id,st.particleIndexBuffer,void 0,st.particleSegment)}}}(b,T,A,Y),D.bindFramebuffer.set(A.particleFramebuffer.framebuffer),function(fe,me,xe,ye){const ve=fe.context,_e=ve.gl,we=me.paint.get("raster-particle-max-speed"),Te=ye*me.paint.get("raster-particle-speed-factor")*.15,Ue=function(ot){return Math.pow(ot,6)}(.01+1*me.paint.get("raster-particle-reset-rate-factor")),Fe=me.particleFramebuffer;ve.viewport.set([0,0,Fe.width,Fe.height]);for(const ot of xe){const[,et,xt]=ot;ve.activeTexture.set(_e.TEXTURE0+0),et.texture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE),ve.activeTexture.set(_e.TEXTURE0+1);const Oe=xt.particleTexture0;Oe.bind(_e.NEAREST,_e.CLAMP_TO_EDGE);const je=Ig(1,Oe.size[0],0,et.texture.size,we,Te,Ue,et.textureOffset,et.scale,et.offset);Fe.colorAttachment.set(xt.particleTexture1.texture),ve.clear({color:r.am.transparent}),fe.getOrCreateProgram("rasterParticleUpdate",{defines:et.defines}).draw(fe,_e.TRIANGLES,Ut.disabled,sn.disabled,In.unblended,an.disabled,je,me.id,fe.viewportBuffer,fe.quadTriangleIndexBuffer,fe.viewportSegments)}}(b,A,Y,oe)}(h,t,s,f),h.renderPass==="translucent"&&(function(b,T,A,z,D){const F=b.context,O=F.gl,U=T.getSource().tileSize,H=5*(1-r.af(r.cx,r.cx+1,b.transform.zoom))*U+A.paint.get("raster-particle-elevation"),q=!b.options.moving,Y=b.transform.projection.name==="globe";if(!z.length)return;const[Z,oe]=b.stencilConfigForOverlap(z),fe=[];Y&&fe.push("PROJECTION_GLOBE_VIEW");const me=b.stencilModeFor3D();for(const xe of oe){const ye=xe.toUnwrapped(),ve=T.getTile(xe);if(!ve.rasterParticleState)continue;const _e=ve.rasterParticleState,we=100;ve.registerFadeDuration(we);const Te=T.findLoadedParent(xe,0),Ue=Pu(ve,Te,T,b.transform,we);let Fe,ot;b.terrain&&b.terrain.prepareDrawTile(),F.activeTexture.set(O.TEXTURE0),_e.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),F.activeTexture.set(O.TEXTURE1),Te&&Te.rasterParticleState?(Te.rasterParticleState.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),Fe=Math.pow(2,Te.tileID.overscaledZ-ve.tileID.overscaledZ),ot=[ve.tileID.canonical.x*Fe%1,ve.tileID.canonical.y*Fe%1]):_e.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const et=Y?Float32Array.from(b.transform.expandedFarZProjMatrix):b.transform.calculateProjMatrix(ye,q),xt=b.transform,Oe=Op(xt),je=r.dn(xe.canonical),Le=r.dp(je.getCenter().lat);let lt,Ze,dt,st,pt;Y?(lt=Float32Array.from(r.bh(r.dr(xe.canonical))),Ze=Float32Array.from(xt.globeMatrix),dt=Float32Array.from(r.dm(xt)),st=[r.ay(xt.center.lng),r.aH(xt.center.lat)],pt=Float32Array.from(r.dq(xe.canonical,je,Le,xt.worldSize/xt._pixelsPerMercatorPixel))):(lt=new Float32Array(16),Ze=new Float32Array(9),dt=new Float32Array(16),st=[0,0],pt=new Float32Array(9));const mt=Pp(et,lt,Ze,dt,pt,ot||[0,0],r.ah(b.transform.zoom),st,Oe,Fe||1,Ue,H),Vt=b.isTileAffectedByFog(xe),Xt=b.getOrCreateProgram("rasterParticle",{defines:fe,overrideFog:Vt});if(b.uploadCommonUniforms(F,Xt,ye),Y){const Bt=new Ut(O.LEQUAL,Ut.ReadOnly,b.depthRangeFor3D),Yt=0,jt=b.globeSharedBuffers;if(jt){const[en,cn,Rn]=jt.getGridBuffers(Le,Yt!==0);Xt.draw(b,O.TRIANGLES,Bt,me,In.alphaBlended,b.renderElevatedRasterBackface?an.frontCCW:an.backCCW,mt,A.id,en,cn,Rn)}}else{const Bt=b.depthModeForSublayer(0,Ut.ReadOnly),Yt=Z[xe.overscaledZ],{tileBoundsBuffer:jt,tileBoundsIndexBuffer:en,tileBoundsSegments:cn}=b.getTileBoundsBuffers(ve);Xt.draw(b,O.TRIANGLES,Bt,Yt,In.alphaBlended,an.disabled,mt,A.id,jt,en,cn)}}b.resetStencilClippingMasks()}(h,t,s,f),h.style.map.triggerRepaint())},background:function(h,t,s,f){const _=s.paint.get("background-color"),g=s.paint.get("background-color-use-theme").constantOr("default")==="none",b=s.paint.get("background-opacity"),T=s.paint.get("background-emissive-strength"),A=s.paint.get("background-pitch-alignment")==="viewport";if(b===0)return;const z=h.context,D=z.gl,F=h.transform,O=F.tileSize,U=s.paint.get("background-pattern");let H;if(U!==void 0&&(U===null||(H=h.imageManager.getPattern(r.I.from(U.toString()),s.scope,h.style.getLut(s.scope)),!H)))return;const q=!U&&_.a===1&&b===1&&h.opaquePassEnabledForLayer()?"opaque":"translucent";if(h.renderPass!==q)return;const Y=sn.disabled,Z=h.depthModeForSublayer(0,q==="opaque"?Ut.ReadWrite:Ut.ReadOnly),oe=h.colorModeForDrapableLayerRenderPass(T),fe=U?"backgroundPattern":"background";let me,xe=f;if(xe||(me=h.getBackgroundTiles(),xe=Object.values(me).map(ye=>ye.tileID)),U&&(z.activeTexture.set(D.TEXTURE0),h.imageManager.bind(h.context,s.scope)),A){const ye=h.getOrCreateProgram(fe,{overrideFog:!1,overrideRtt:!0}),ve=new Float32Array(r.bx([])),_e=new r.aM(0,0,0,0,0),we=U?Mg(ve,T,b,h,0,s.scope,H,A,{tileID:_e,tileSize:O}):xf(ve,T,b,_.toRenderColor(g?null:s.lut));ye.draw(h,D.TRIANGLES,Z,Y,oe,an.disabled,we,s.id,h.viewportBuffer,h.quadTriangleIndexBuffer,h.viewportSegments)}else for(const ye of xe){const ve=h.isTileAffectedByFog(ye),_e=h.getOrCreateProgram(fe,{overrideFog:ve}),we=ye.toUnwrapped(),Te=f?ye.projMatrix:h.transform.calculateProjMatrix(we);h.prepareDrawTile();const Ue=t?t.getTile(ye):me?me[ye.key]:new Zs(ye,O,F.zoom,h),Fe=U?Mg(Te,T,b,h,0,s.scope,H,A,{tileID:ye,tileSize:O}):xf(Te,T,b,_.toRenderColor(g?null:s.lut));h.uploadCommonUniforms(z,_e,we);const{tileBoundsBuffer:ot,tileBoundsIndexBuffer:et,tileBoundsSegments:xt}=h.getTileBoundsBuffers(Ue);_e.draw(h,D.TRIANGLES,Z,Y,oe,an.disabled,Fe,s.id,ot,et,xt)}},sky:function(h,t,s){const f=h._atmosphere?r.ah(h.transform.zoom):1,_=s.paint.get("sky-opacity")*f;if(_===0)return;const g=h.context,b=s.paint.get("sky-type"),T=new Ut(g.gl.LEQUAL,Ut.ReadOnly,[0,1]),A=h.frameCounter/1e3%1;b==="atmosphere"?h.renderPass==="offscreen"?s.needsSkyboxCapture(h)&&(function(z,D,F,O){const U=z.context,H=U.gl;let q=D.skyboxFbo;if(!q){q=D.skyboxFbo=U.createFramebuffer(32,32,!0,null),D.skyboxGeometry=new Nu(U),D.skyboxTexture=U.gl.createTexture(),H.bindTexture(H.TEXTURE_CUBE_MAP,D.skyboxTexture),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR);for(let fe=0;fe<6;++fe)H.texImage2D(H.TEXTURE_CUBE_MAP_POSITIVE_X+fe,0,H.RGBA,32,32,0,H.RGBA,H.UNSIGNED_BYTE,null)}U.bindFramebuffer.set(q.framebuffer),U.viewport.set([0,0,32,32]);const Y=D.getCenter(z,!0),Z=z.getOrCreateProgram("skyboxCapture"),oe=new Float64Array(16);r.bx(oe),r.e3(oe,oe,.5*-Math.PI),Ma(z,D,Z,oe,Y,0),r.bx(oe),r.e3(oe,oe,.5*Math.PI),Ma(z,D,Z,oe,Y,1),r.bx(oe),r.cG(oe,oe,.5*-Math.PI),Ma(z,D,Z,oe,Y,2),r.bx(oe),r.cG(oe,oe,.5*Math.PI),Ma(z,D,Z,oe,Y,3),r.bx(oe),Ma(z,D,Z,oe,Y,4),r.bx(oe),r.e3(oe,oe,Math.PI),Ma(z,D,Z,oe,Y,5),U.viewport.set([0,0,z.width,z.height])}(h,s),s.markSkyboxValid(h)):h.renderPass==="sky"&&function(z,D,F,O,U){const H=z.context,q=H.gl,Y=z.transform,Z=z.getOrCreateProgram("skybox");H.activeTexture.set(q.TEXTURE0),q.bindTexture(q.TEXTURE_CUBE_MAP,D.skyboxTexture);const oe=((fe,me,xe,ye,ve)=>({u_matrix:fe,u_sun_direction:me,u_cubemap:0,u_opacity:ye,u_temporal_offset:ve}))(Y.skyboxMatrix,D.getCenter(z,!1),0,O,U);z.uploadCommonUniforms(H,Z),Z.draw(z,q.TRIANGLES,F,sn.disabled,z.colorModeForRenderPass(),an.backCW,oe,"skybox",D.skyboxGeometry.vertexBuffer,D.skyboxGeometry.indexBuffer,D.skyboxGeometry.segment)}(h,s,T,_,A):b==="gradient"&&h.renderPass==="sky"&&function(z,D,F,O,U){const H=z.context,q=H.gl,Y=z.transform,Z=z.getOrCreateProgram("skyboxGradient");D.skyboxGeometry||(D.skyboxGeometry=new Nu(H)),H.activeTexture.set(q.TEXTURE0);let oe=D.colorRampTexture;oe||(oe=D.colorRampTexture=new r.T(H,D.colorRamp,q.RGBA8)),oe.bind(q.LINEAR,q.CLAMP_TO_EDGE);const fe=((me,xe,ye,ve,_e)=>({u_matrix:me,u_color_ramp:0,u_center_direction:xe,u_radius:r.al(ye),u_opacity:ve,u_temporal_offset:_e}))(Y.skyboxMatrix,D.getCenter(z,!1),D.paint.get("sky-gradient-radius"),O,U);z.uploadCommonUniforms(H,Z),Z.draw(z,q.TRIANGLES,F,sn.disabled,z.colorModeForRenderPass(),an.backCW,fe,"skyboxGradient",D.skyboxGeometry.vertexBuffer,D.skyboxGeometry.indexBuffer,D.skyboxGeometry.segment)}(h,s,T,_,A)},debug:function(h,t,s,f,_,g){for(let b=0;b<s.length;b++)if(_){const z=new r.am(f.r*.8,f.g*.8,f.b*.8,1);xl(h,t,s[b],f,-1,-1,g),xl(h,t,s[b],f,-1,1,g),xl(h,t,s[b],f,1,1,g),xl(h,t,s[b],f,1,-1,g),xl(h,t,s[b],z,0,0,g)}else xl(h,t,s[b],f,0,0,g)},custom:function(h,t,s,f){const _=h.context,g=s.implementation;if(!h.transform.projection.unsupportedLayers||!h.transform.projection.unsupportedLayers.includes("custom")||h.terrain&&(h.terrain.renderingToTexture||h.renderPass==="offscreen")&&s.isDraped(t)){if(h.renderPass==="offscreen"){const b=g.prerender;if(b){if(h.setCustomLayerDefaults(),_.setColorMode(h.colorModeForRenderPass()),h.transform.projection.name==="globe"){const T=h.transform.pointMerc;b.call(g,_.gl,h.transform.customLayerMatrix(),h.transform.getProjection(),h.transform.globeToMercatorMatrix(),r.ah(h.transform.zoom),[T.x,T.y],h.transform.pixelsPerMeterRatio)}else b.call(g,_.gl,h.transform.customLayerMatrix());_.setDirty(),h.setBaseState()}}else if(h.renderPass==="translucent"){if(h.terrain&&h.terrain.renderingToTexture){const T=g.renderToTile;if(T){const A=f[0].canonical,z={x:A.x+f[0].wrap*(g.wrapTileId?0:1<<A.z),y:A.y,z:A.z};_.setDepthMode(Ut.disabled),_.setStencilMode(sn.disabled),_.setColorMode(h.colorModeForRenderPass()),h.setCustomLayerDefaults(),T.call(g,_.gl,z),_.setDirty(),h.setBaseState()}return}h.setCustomLayerDefaults(),_.setColorMode(h.colorModeForRenderPass()),_.setStencilMode(sn.disabled);const b=g.renderingMode==="3d"?new Ut(h.context.gl.LEQUAL,Ut.ReadWrite,h.depthRangeFor3D):h.depthModeForSublayer(0,Ut.ReadOnly);if(_.setDepthMode(b),h.transform.projection.name==="globe"){const T=h.transform.pointMerc;g.render(_.gl,h.transform.customLayerMatrix(),h.transform.getProjection(),h.transform.globeToMercatorMatrix(),r.ah(h.transform.zoom),[T.x,T.y],h.transform.pixelsPerMeterRatio)}else g.render(_.gl,h.transform.customLayerMatrix());_.setDirty(),h.setBaseState(),_.bindFramebuffer.set(null)}}else r.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(h,t,s,f){if(h.renderPass==="opaque")return;const _=s.paint.get("model-opacity").constantOr(1);if(_===0)return;const g=s.paint.get("model-cast-shadows");if(h.renderPass==="shadow"&&(!g||h.terrain&&_<.65&&s._transitionablePaint._values["model-opacity"].value.expression instanceof r.ab))return;const b=h.shadowRenderer,T=s.paint.get("model-receive-shadows");b&&(b.useNormalOffset=!0,T||(b.enabled=!1));const A=()=>{b&&(b.useNormalOffset=!0,T||(b.enabled=!0))},z=t.getSource();if(h.renderPass==="light-beam"&&z.type!=="batched-model")return;if(z.type==="vector"||z.type==="geojson")return function(Z,oe,fe,me,xe){const ye=Z.transform;if(ye.projection.name!=="mercator")return void r.w(`Drawing 3D models for ${ye.projection.name} projection is not yet implemented`);const ve=ye.getFreeCameraOptions().position;if(!Z.modelManager)return;const _e=Z.modelManager;fe.modelManager=_e;const we=Z.shadowRenderer;if(!fe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Te=fe._unevaluatedLayout._values["model-id"],Ue=Object.assign({},fe.layout.get("model-id").parameters),Fe=Z.style.order.indexOf(fe.fqid);for(const ot of me){const et=oe.getTile(ot).getBucket(fe);if(!et||et.projection.name!==ye.projection.name)continue;const xt=et.getModelUris();xt&&!et.modelsRequested&&(_e.addModelsFromBucket(xt,xe),et.modelsRequested=!0);const Oe=If(ot,ye);Ue.zoom=Oe;const je=Te.possiblyEvaluate(Ue);if(Ne(Z,et,ot),cs.shadowUniformsInitialized=!1,cs.useSingleShadowCascade=!!we&&we.getMaxCascadeForTile(ot.toUnwrapped())===0,Z.renderPass==="shadow"&&we){if(Z.currentShadowCascade===1&&et.isInsideFirstShadowMapFrustum)continue;const Ze=ye.calculatePosMatrix(ot.toUnwrapped(),ye.worldSize);if(cs.tileMatrix.set(Ze),cs.shadowTileMatrix=Float32Array.from(we.calculateShadowPassMatrixFromMatrix(Ze)),cs.aabb.min.fill(0),cs.aabb.max[0]=cs.aabb.max[1]=r.aj,cs.aabb.max[2]=0,Fg(et,cs,Z,fe.scope))continue}const Le=1<<ot.canonical.z,lt=[((ve.x-ot.wrap)*Le-ot.canonical.x)*r.aj,(ve.y*Le-ot.canonical.y)*r.aj,ve.z*Le*r.aj];Z.conflationActive&&Object.keys(et.instancesPerModel).length>0&&Z.style.isLayerClipped(fe,oe.getSource())&&et.updateReplacement(ot,Z.replacementSource,Fe,xe)&&(et.uploaded=!1,et.upload(Z.context));for(let Ze in et.instancesPerModel){const dt=et.instancesPerModel[Ze];dt.features.length>0&&(Ze=je.evaluate(dt.features[0].feature,{}));const st=_e.getModel(Ze,xe);if(st||_e.hasURLBeenRequested(Ze)||et.modelUris.includes(Ze)||(et.modelUris.push(Ze),et.modelsRequested=!1),st&&st.uploaded)for(const pt of st.nodes)Mf(Z,fe,pt,dt,lt,ot,cs)}}}(h,t,s,f,z.type==="vector"?s.scope:""),void A();if(!z.loaded())return;if(z.type==="batched-model")return function(Z,oe,fe,me){fe.resetLayerRenderingStats(Z);const xe=Z.context,ye=Z.transform,ve=Z.style.fog,_e=Z.shadowRenderer;if(ye.projection.name!=="mercator")return void r.w(`Drawing 3D landmark models for ${ye.projection.name} projection is not yet implemented`);const we=Z.transform.getFreeCameraOptions().position,Te=r.b$([],[we.x,we.y,we.z],Z.transform.worldSize),Ue=r.eb([],Te),Fe=r.bx([]),ot=r.ec(ye.center.lat,ye.zoom),et=r.bn([],[1,1,1/ot]);r.bo(Fe,Fe,Ue);const xt=fe.paint.get("model-opacity").constantOr(1),Oe=new Ut(xe.gl.LEQUAL,Ut.ReadWrite,Z.depthRangeFor3D),je=new Ut(xe.gl.LEQUAL,Ut.ReadOnly,Z.depthRangeFor3D),Le=new r.cV([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),lt=Z.renderPass==="shadow",Ze=lt&&_e?_e.getCurrentCascadeFrustum():ye.getFrustum(ye.scaleZoom(ye.worldSize)),dt=fe.paint.get("model-front-cutoff"),st=dt[2]<1,pt=hl(Z,fe.paint.get("model-cutoff-fade-range")),mt=fe.getLayerRenderingStats();(function(Vt,Xt,Bt,Yt){const jt=Vt.terrain?Vt.terrain.exaggeration():0,en=Vt.transform.zoom;for(const cn of Yt){const Rn=Xt.getTile(cn).getBucket(Bt);Rn&&(Rn.setFilter(Bt.filter),Vt.conflationActive&&Rn.updateReplacement(cn,Vt.replacementSource),Rn.evaluateScale(Vt,Bt),Vt.terrain&&jt>0&&Rn.elevationUpdate(Vt.terrain,jt,cn,Bt.source),Rn.needsReEvaluation(Vt,en,Bt)&&Rn.evaluate(Bt))}})(Z,oe,fe,me),function(){let Vt,Xt,Bt;st?(Vt=me.length-1,Xt=-1,Bt=-1):(Vt=0,Xt=me.length,Bt=1);const Yt=new Float64Array(16),jt=r.eg(),en=new r.P(0,0);for(let cn=Vt;cn!==Xt;cn+=Bt){const Rn=me[cn],ai=oe.getTile(Rn).getBucket(fe);if(!ai||!ai.uploaded)continue;let ii=!1;_e&&(ii=_e.getMaxCascadeForTile(Rn.toUnwrapped())===0);const Ln=ye.calculatePosMatrix(Rn.toUnwrapped(),ye.worldSize),Zi=ai.modelTraits;!lt&&st&&(r.bi(Yt,Ln),r.ad(jt,Te,Yt),en.x=jt[0],en.y=jt[1]);const Ni=[];ai.setFilter(fe.filter);for(const pn of ai.getNodesInfo()){if(pn.hiddenByReplacement||!pn.node.meshes)continue;const Vn=pn.node;let Zn=0;Z.terrain&&Vn.elevation&&(Zn=Vn.elevation*Z.terrain.exaggeration());const li=(()=>{const Fi=pn.aabb;return Le.min=[...Fi.min],Le.max=[...Fi.max],Le.min[2]+=Zn,Le.max[2]+=Zn,r.ad(Le.min,Le.min,Ln),r.ad(Le.max,Le.max,Ln),Le})(),or=pn.evaluatedScale;if(or[0]<=1&&or[1]<=1&&or[2]<=1&&li.intersects(Ze)===0)continue;if(!lt&&st){const Fi=.16666666666666666;pn.cameraCollisionOpacity=Te[0]>li.min[0]&&Te[0]<li.max[0]&&Te[1]>li.min[1]&&Te[1]<li.max[1]&&Te[2]*ot<li.max[2]&&Vn.footprint&&r.bS(en,Vn.footprint)?Math.max(pn.cameraCollisionOpacity-Fi,0):Math.min(1,pn.cameraCollisionOpacity+Fi)}const Yi=[...Ln],rr=Vn.anchor?Vn.anchor[0]:0,Oi=Vn.anchor?Vn.anchor[1]:0;r.bo(Yi,Yi,[rr*(or[0]-1),Oi*(or[1]-1),Zn]),r.ci(or,r.eh)||r.cE(Yi,Yi,or);const xn=r.az([],Yi,Vn.matrix),Pi=r.az([],ye.expandedFarZProjMatrix,xn),Gn=r.az([],ye.expandedFarZProjMatrix,Yi),zi=r.aA([],[rr,Oi,Zn,1],Pi)[2];Vn.hidden=!1;let Jn=xt;lt||(st&&(Jn*=pn.cameraCollisionOpacity,Jn*=wc(Yi,ye,pn.aabb,dt)),Jn*=Bg(pt,zi)),Jn!==0?Ni.push({nodeInfo:pn,depth:zi,opacity:Jn,wvpForNode:Pi,wvpForTile:Gn,nodeModelMatrix:xn,tileModelMatrix:Yi}):Vn.hidden=!0}lt||Ni.sort((pn,Vn)=>!st||pn.opacity===1&&Vn.opacity===1?pn.depth<Vn.depth?-1:1:pn.opacity===1?-1:Vn.opacity===1?1:pn.depth>Vn.depth?-1:1);for(const pn of Ni){const Vn=pn.nodeInfo,Zn=Vn.node;let li=r.az([],et,pn.tileModelMatrix);r.az(li,Fe,li);const or=r.bi([],li);r.ee(or,or),r.cE(or,or,Vp),li=r.az(li,li,Zn.matrix);const Yi=Z.renderPass==="light-beam",rr=fe.paint.get("model-color-use-theme").constantOr("default")==="none",Oi=Zi&r.em.HasMapboxMeshFeatures,xn=Oi?0:Vn.evaluatedRMEA[0][2];for(let Pi=0;Pi<Zn.meshes.length;++Pi){const Gn=Zn.meshes[Pi],zi=Pi===Zn.lightMeshIndex;let Jn=pn.wvpForNode;if(zi){if(!Yi&&!Z.terrain&&Z.shadowRenderer){Z.currentLayer<Z.firstLightBeamLayer&&(Z.firstLightBeamLayer=Z.currentLayer);continue}Jn=pn.wvpForTile}else if(Yi)continue;const Fi={defines:[]},Tr=[];if(!lt&&_e&&(_e.useNormalOffset=!!Gn.normalBuffer),wt(Fi.defines,Tr,Gn,Z,rr?null:fe.lut),Oi||Fi.defines.push("DIFFUSE_SHADED"),ii&&Fi.defines.push("SHADOWS_SINGLE_CASCADE"),mt&&(lt?mt.numRenderedVerticesInShadowPass+=Gn.vertexArray.length:mt.numRenderedVerticesInTransparentPass+=Gn.vertexArray.length),lt){Xi(Gn,pn.nodeModelMatrix,Z,fe);continue}let Si=null;if(ve){const yo=bl(pn.nodeModelMatrix,Z.transform);if(Si=new Float32Array(yo),ye.projection.name!=="globe"){const Jo=Gn.aabb.min,Cs=Gn.aabb.max,[Ps,ps]=ve.getOpacityForBounds(yo,Jo[0],Jo[1],Cs[0],Cs[1]);Fi.overrideFog=Ps>=kt||ps>=kt}}const Cr=Gn.material;let nr;Cr.occlusionTexture&&Cr.occlusionTexture.offsetScale&&(nr=Cr.occlusionTexture.offsetScale,Fi.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Lr=Z.getOrCreateProgram("model",Fi);!lt&&_e&&_e.setupShadowsFromMatrix(pn.tileModelMatrix,Lr,_e.useNormalOffset),Z.uploadCommonUniforms(xe,Lr,null,Si);const ds=Cr.pbrMetallicRoughness;ds.metallicFactor=.9,ds.roughnessFactor=.5;const ea=gl(new Float32Array(Jn),new Float32Array(li),new Float32Array(or),new Float32Array(Zn.matrix),Z,pn.opacity,ds.baseColorFactor.toRenderColor(null),Cr.emissiveFactor,ds.metallicFactor,ds.roughnessFactor,Cr,xn,fe,[0,0,0],nr);!zi&&(Vn.hasTranslucentParts||pn.opacity<1)&&Lr.draw(Z,xe.gl.TRIANGLES,Oe,sn.disabled,In.disabled,an.backCCW,ea,fe.id,Gn.vertexBuffer,Gn.indexBuffer,Gn.segments,fe.paint,Z.transform.zoom,void 0,Tr),Lr.draw(Z,xe.gl.TRIANGLES,zi?je:Oe,sn.disabled,zi||pn.opacity<1||Vn.hasTranslucentParts?In.alphaBlended:In.unblended,an.backCCW,ea,fe.id,Gn.vertexBuffer,Gn.indexBuffer,Gn.segments,fe.paint,Z.transform.zoom,void 0,Tr)}}}}()}(h,t,s,f),void A();if(z.type!=="model")return;const D=z.getModels(),F=[],O=h.transform.getFreeCameraOptions().position,U=r.b$([],[O.x,O.y,O.z],h.transform.worldSize);r.eb(U,U);const H=[],q=[];let Y=0;for(const Z of D){const oe=s.paint.get("model-rotation").constantOr(null),fe=s.paint.get("model-scale").constantOr(null),me=s.paint.get("model-translation").constantOr(null);Z.computeModelMatrix(h,oe,fe,me,!0,!0,!1);const xe=r.bx([]),ye=r.ec(Z.position.lat,h.transform.zoom),ve=r.bn([],[1,1,1/ye]);r.bo(xe,xe,U),F.push({zScaleMatrix:ve,negCameraPosMatrix:xe});for(const _e of Z.nodes)wl(h.transform,_e,Z.matrix,h.transform.expandedFarZProjMatrix,Y,H,q);Y++}if(H.sort((Z,oe)=>oe.depth-Z.depth),h.renderPass!=="shadow"){if(_===1)for(const Z of q)Ot(Z,h,s,F[Z.modelIndex],sn.disabled,h.colorModeForRenderPass());else{for(const Z of q)Ot(Z,h,s,F[Z.modelIndex],sn.disabled,In.disabled);for(const Z of q)Ot(Z,h,s,F[Z.modelIndex],h.stencilModeFor3D(),h.colorModeForRenderPass());h.resetStencilClippingMasks()}for(const Z of H)Ot(Z,h,s,F[Z.modelIndex],sn.disabled,h.colorModeForRenderPass());A()}else{for(const Z of q)Xi(Z.mesh,Z.nodeModelMatrix,h,s);for(const Z of H)Xi(Z.mesh,Z.nodeModelMatrix,h,s);A()}}},Gp={line:function(h,t,s){if(h.hasElevatedBuckets=!1,h.hasNonElevatedBuckets=!1,h._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||h._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const f=t.getVisibleCoordinates();for(const _ of f){const g=t.getTile(_).getBucket(h);if(g&&(g.elevationType!=="none"?h.hasElevatedBuckets=!0:h.hasNonElevatedBuckets=!0,h.hasElevatedBuckets&&h.hasNonElevatedBuckets))break}}}else h.hasNonElevatedBuckets=!0},model:function(h,t,s){const f=t.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson")return void(s.modelManager&&s.modelManager.upload(s,f.type==="vector"?h.scope:""));if(f.type==="batched-model"||f.type!=="model")return;const _=f.getModels();for(const g of _)g.upload(s.context)},raster:function(h,t,s){const f=t.getSource();if(!(f instanceof nl&&f.loaded()))return;const _=h.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const g=h.paint.get("raster-array-band")||f.getInitialBand(_);if(g==null)return;const b=t.getIds().map(T=>t.getTileByID(T));for(const T of b)T.updateNeeded(_,g)&&f.prepareTile(T,_,g)},"raster-particle":function(h,t,s){const f=t.getSource();if(!(f instanceof nl&&f.loaded()))return;const _=h.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const g=h.paint.get("raster-particle-array-band")||f.getInitialBand(_);if(g==null)return;const b=t.getIds().map(T=>t.getTileByID(T));for(const T of b)T.updateNeeded(_,g)&&f.prepareTile(T,_,g)}},Ks={fill:Ou};class zf{constructor(t,s,f,_,g){this.context=new gc(t,s),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=g,this._timeStamp=r.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const b=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const A of b)this._debugParams.enabledLayers[A]=!0;g.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),g.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),g.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),g.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),g.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),g.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const A of b)g.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],A);this.occlusionParams=new Ng(g),this.setup(),this.numSublayers=Wr.maxUnderzooming+Wr.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new r.et,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Ox(this),this._wireframeDebugCache=new s1,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const T=new r.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new r.T(this.context,T,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=_}updateTerrain(t,s){const f=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new pf(this,t));const _=this._terrain;this.transform.elevation=f?_:null,_.update(t,this.transform,s),this.transform.elevation&&!_.enabled&&(this.transform.elevation=null)}_updateFog(t){const s=t.fog;if(!s||this.transform.projection.name==="globe"||s.getOpacity(this.transform.pitch)<1||s.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[f,_]=s.getFovAdjustedRange(this.transform._fov);if(f>_)return void(this.transform.fogCullDistSq=null);const g=f+.78*(_-f);this.transform.fogCullDistSq=g*g}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new pf(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,s){if(this.width=t*r.q.devicePixelRatio,this.height=s*r.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style.order)this.style._mergedLayers[f].resize()}setup(){const t=this.context,s=new r.ba;s.emplaceBack(0,0),s.emplaceBack(r.aj,0),s.emplaceBack(0,r.aj),s.emplaceBack(r.aj,r.aj),this.tileExtentBuffer=t.createVertexBuffer(s,r.bc.members),this.tileExtentSegments=r.bd.simpleSegment(0,0,4,2);const f=new r.ba;f.emplaceBack(0,0),f.emplaceBack(r.aj,0),f.emplaceBack(0,r.aj),f.emplaceBack(r.aj,r.aj),this.debugBuffer=t.createVertexBuffer(f,r.bc.members),this.debugSegments=r.bd.simpleSegment(0,0,4,5);const _=new r.ba;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(-1,1),_.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(_,r.bc.members),this.viewportSegments=r.bd.simpleSegment(0,0,4,2);const g=new r.aZ;g.emplaceBack(0,0,0,0),g.emplaceBack(r.aj,0,r.aj,0),g.emplaceBack(0,r.aj,0,r.aj),g.emplaceBack(r.aj,r.aj,r.aj,r.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(g,r.bf.members),this.mercatorBoundsSegments=r.bd.simpleSegment(0,0,4,2);const b=new r.a_;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(b);const T=new r.bb;for(const z of[0,1,3,2,0])T.emplaceBack(z);this.debugIndexBuffer=t.createIndexBuffer(T),this.emptyTexture=new r.T(t,new r.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=r.bz();const A=this.context.gl;this.stencilClearMode=new sn({func:A.ALWAYS,mask:0},0,255,A.ZERO,A.ZERO,A.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Ut.disabled,this.stencilClearMode,In.disabled,an.disabled,uo(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,s,f){if(!s||this.currentStencilSource===s.id||!t.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let T=!1;for(const A of f)if(this._tileClippingMaskIDs[A.key]===void 0){T=!0;break}if(!T)return}this.currentStencilSource=s.id;const _=this.context,g=_.gl;this.nextStencilID+f.length>256&&this.clearStencil(),_.setColorMode(In.disabled),_.setDepthMode(Ut.disabled);const b=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const T of f){const A=s.getTile(T),z=this._tileClippingMaskIDs[T.key]=this.nextStencilID++,{tileBoundsBuffer:D,tileBoundsIndexBuffer:F,tileBoundsSegments:O}=this.getTileBoundsBuffers(A);b.draw(this,g.TRIANGLES,Ut.disabled,new sn({func:g.ALWAYS,mask:0},z,255,g.KEEP,g.KEEP,g.REPLACE),In.disabled,an.disabled,uo(T.projMatrix),"$clipping",D,F,O)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,s=this.context.gl;return new sn({func:s.NOTEQUAL,mask:255},t,255,s.KEEP,s.KEEP,s.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const s=this.context.gl;return new sn({func:s.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,s.KEEP,s.KEEP,s.REPLACE)}stencilConfigForOverlap(t){const s=this.context.gl,f=t.sort((b,T)=>T.overscaledZ-b.overscaledZ),_=f[f.length-1].overscaledZ,g=f[0].overscaledZ-_+1;if(g>1){this.currentStencilSource=void 0,this.nextStencilID+g>256&&this.clearStencil();const b={};for(let T=0;T<g;T++)b[T+_]=new sn({func:s.GEQUAL,mask:255},T+this.nextStencilID,255,s.KEEP,s.KEEP,s.REPLACE);return this.nextStencilID+=g,[b,f]}return[{[_]:sn.disabled},f]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new In([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new r.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?In.unblended:In.alphaBlended}colorModeForDrapableLayerRenderPass(t){const s=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new In([s.ONE,s.ONE_MINUS_SRC_ALPHA,s.CONSTANT_ALPHA,s.ONE_MINUS_SRC_ALPHA],new r.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,s,f,_=!1){if(this.depthOcclusion)return new Ut(this.context.gl.GREATER,Ut.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!_)return Ut.disabled;const g=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Ut(f||this.context.gl.LEQUAL,s,[g,g])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,s=Math.ceil(this.width),f=Math.ceil(this.height),_=this.context.bindFramebuffer.get(),g=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===s&&this.depthFBO.height===f||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),s!==0&&f!==0&&(this.depthFBO=new wf(this.context,s,f,!1,"texture"),this.depthTexture=new r.T(this.context,{width:s,height:f,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(_),t.bindTexture(t.TEXTURE_2D,g),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,s,f,0,0,s,f,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,s)=>t+s/this._fpsHistory.length,0))}render(t,s){const f=r.q.now();this._dt=f-this._timeStamp,this._timeStamp=f,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=s;const _=this.style._mergedLayers,g=!(!this.terrain||!this.terrain.enabled),b=()=>this.style._getOrder(g).filter(Oe=>{const je=_[Oe];return!(je.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[je.type]});let T=b(),A=!1,z=!1;for(const Oe of T){const je=_[Oe];je.type==="circle"&&(A=!0),je.type==="symbol"&&(je.hasInitialOcclusionOpacityProperties?z=!0:A=!0)}let D=T.map(Oe=>_[Oe]);const F=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(r.q.now()),this.imageManager.beginFrame();let O=0,U=!1;for(const Oe in F){const je=F[Oe];je.used&&(je.prepare(this.context),je.getSource().usedInConflation&&++O)}let H=!1;for(const Oe of D)Oe.isHidden(this.transform.zoom)||(Oe.type==="clip"&&(H=!0),this.prepareLayer(Oe));const q={},Y={},Z={},oe={},fe={};for(const Oe in F){const je=F[Oe];q[Oe]=je.getVisibleCoordinates(),Y[Oe]=q[Oe].slice().reverse(),Z[Oe]=je.getVisibleCoordinates(!0).reverse(),oe[Oe]=je.getShadowCasterCoordinates(),fe[Oe]=je.sortCoordinatesByDistance(q[Oe])}const me=Oe=>{const je=this.style.getLayerSourceCache(Oe);return je&&je.used?je.getSource():null};if(O||H||this._clippingActiveLastFrame){const Oe=[],je=[];let Le=0;for(const lt of D)this.isSourceForClippingOrConflation(lt,me(lt))&&(Oe.push(lt),je.push(Le)),Le++;if(Oe&&(H||Oe.length>1)||this._clippingActiveLastFrame){H=!1;const lt=[];for(let Ze=0;Ze<Oe.length;Ze++){const dt=Oe[Ze],st=je[Ze],pt=this.style.getLayerSourceCache(dt);if(!pt||!pt.used||!pt.getSource().usedInConflation&&dt.type!=="clip")continue;let mt=r.ev,Vt=r.bQ.None;const Xt=[];let Bt=!0;if(dt.type==="clip"){mt=st;for(const Yt of dt.layout.get("clip-layer-types"))Vt|=Yt==="model"?r.bQ.Model:Yt==="symbol"?r.bQ.Symbol:r.bQ.FillExtrusion;for(const Yt of dt.layout.get("clip-layer-scope"))Xt.push(Yt);dt.isHidden(this.transform.zoom)?Bt=!1:H=!0}Bt&&lt.push({layer:dt.fqid,cache:pt,order:mt,clipMask:Vt,clipScope:Xt})}this.replacementSource.setSources(lt),U=!0}}this._clippingActiveLastFrame=H,U||this.replacementSource.clear(),this.conflationActive=U,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Oe=0;Oe<D.length;Oe++){const je=D[Oe],Le=je.cutoffRange();if(this.longestCutoffRange=Math.max(Le,this.longestCutoffRange),Le>0){const lt=me(je);lt&&(this.minCutoffZoom=Math.max(lt.minzoom,this.minCutoffZoom)),je.minzoom&&(this.minCutoffZoom=Math.max(je.minzoom,this.minCutoffZoom))}je.is3D(g)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Oe),this._lastOcclusionLayer=Oe)}const xe=this.style&&this.style.fog;xe?(this._fogVisible=xe.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=xe.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,T=b(),D=T.map(Oe=>_[Oe]));const ye=this._shadowRenderer;if(ye){ye.updateShadowParameters(this.transform,this.style.directionalLight);for(const Oe in F)for(const je of q[Oe]){let Le={min:0,max:0};this.terrain&&(Le=this.terrain.getMinMaxForTile(je)||Le),ye.addShadowReceiver(je.toUnwrapped(),Le.min,Le.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new r.eu(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new bc(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ve=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),_e=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ve&&!this._snow&&(this._snow=new ki(this)),!ve&&this._snow&&(this._snow.destroy(),delete this._snow),_e&&!this._rain&&(this._rain=new a1(this)),!_e&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!Tn.has(this.context.gl))return;this.renderPass="offscreen";for(const Oe of D){const je=t.getLayerSourceCache(Oe);if(!Oe.hasOffscreenPass()||Oe.isHidden(this.transform.zoom))continue;const Le=je?Y[je.id]:void 0;(Oe.type==="custom"||Oe.type==="raster"||Oe.type==="raster-particle"||Oe.isSky()||Le&&Le.length)&&this.renderLayer(this,je,Oe,Le)}this.depthRangeFor3D=[0,1-(D.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,oe)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const we=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Te=(()=>{if(s.showOverdrawInspector)return r.am.black;const Oe=this.style.fog;if(Oe&&this.transform.projection.supportsFog){const je=this.style.getLut(Oe.scope);if(!we){const Le=Oe.properties.get("color-use-theme")==="none",lt=Oe.properties.get("color").toRenderColor(Le?null:je).toArray01();return new r.am(...lt)}if(we){const Le=Oe.properties.get("space-color-use-theme")==="none",lt=Oe.properties.get("space-color").toRenderColor(Le?null:je).toArray01();return new r.am(...lt)}}return r.am.transparent})();if(this.context.clear({color:Te,depth:1}),this.clearStencil(),this._showOverdrawInspector=s.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&we&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=T.length-1;this.currentLayer>=0;this.currentLayer--){const Oe=D[this.currentLayer],je=t.getLayerSourceCache(Oe);if(Oe.isSky())continue;const Le=je?(Oe.is3D(g)?fe:Y)[je.id]:void 0;this._renderTileClippingMasks(Oe,je,Le),this.renderLayer(this,je,Oe,Le)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&we&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||r.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<T.length;this.currentLayer++){const Oe=D[this.currentLayer],je=t.getLayerSourceCache(Oe);Oe.isSky()&&this.renderLayer(this,je,Oe,je?Y[je.id]:void 0)}function Ue(Oe,je){let Le;return je&&(Le=(Oe.type==="symbol"?Z:Oe.is3D(g)?fe:Y)[je.id]),Le}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<T.length;){const Oe=D[this.currentLayer];if(Oe.type==="raster"||Oe.type==="raster-particle"){const je=t.getLayerSourceCache(Oe);this.renderLayer(this,je,Oe,Ue(Oe,je))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Fe=0;ye&&(Fe=ye.getShadowCastingLayerCount());let ot=!1,et=-1;for(let Oe=0;Oe<T.length;++Oe){const je=D[Oe];je.isHidden(this.transform.zoom)||je.is3D(g)&&(et=Oe)}z&&et===-1&&(A=!0);let xt=!1;for(;this.currentLayer<T.length;){const Oe=D[this.currentLayer],je=t.getLayerSourceCache(Oe);if(Oe.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Oe)){if(Oe.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!xt&&Oe.is3D(g)&&!g){const Le=this.currentLayer,lt=Ze=>{for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const dt=D[this.currentLayer];if(Ks[dt.type]){const st=this.style.getLayerSourceCache(dt);Ks[dt.type](this,st,dt,Ue(dt,st),Ze)}}};lt("initialize"),lt("reset"),this.currentLayer=Le,xt=!0}if(A&&!ot&&this.terrain&&!this.transform.isOrthographic&&(ot=!0,this.blitDepth()),z&&et!==-1&&this.currentLayer===et+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Oe,je,je?q[je.id]:void 0),this.renderLayer(this,je,Oe,Ue(Oe,je)),!this.terrain&&ye&&Fe>0&&Oe.hasShadowPass()&&--Fe==0&&(ye.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const Le=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Le;this.currentLayer++){const lt=D[this.currentLayer];if(!lt.hasLightBeamPass())continue;const Ze=t.getLayerSourceCache(lt);this.renderLayer(this,Ze,lt,Ze?Y[Ze.id]:void 0)}this.currentLayer=Le,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Le=this.currentLayer;this.depthOcclusion=!0;for(const lt of this.layersWithOcclusionOpacity){this.currentLayer=lt;const Ze=D[this.currentLayer],dt=t.getLayerSourceCache(Ze),st=dt?Y[dt.id]:void 0;this.terrain||this._renderTileClippingMasks(Ze,dt,dt?q[dt.id]:void 0),this.renderLayer(this,dt,Ze,st)}this.depthOcclusion=!1,this.currentLayer=Le,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Oe=null;D.forEach(je=>{const Le=t.getLayerSourceCache(je);Le&&!je.isHidden(this.transform.zoom)&&Le.getVisibleCoordinates().length&&(!Oe||Oe.getSource().maxzoom<Le.getSource().maxzoom)&&(Oe=Le)}),Oe&&this.options.showTileBoundaries&&Yn.debug(this,Oe,Oe.getVisibleCoordinates(),r.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Yn.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new r.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Oe){const je=Oe.transform.padding;Ef(Oe,Oe.transform.height-(je.top||0),3,Fp),Ef(Oe,je.bottom||0,3,Bp),Af(Oe,je.left||0,3,Np),Af(Oe,Oe.transform.width-(je.right||0),3,go);const Le=Oe.transform.centerPoint;(function(lt,Ze,dt,st){xc(lt,Ze-1,dt-10,2,20,st),xc(lt,Ze-10,dt-1,20,2,st)})(Oe,Le.x,Oe.transform.height-Le.y,Ia)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),U||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:s}=this.transform.projection,f=!s||!s.includes(t.type);if(Gp[t.type]&&(f||this.terrain&&t.type==="custom")){const _=this.style.getLayerSourceCache(t);Gp[t.type](t,_,this)}this.gpuTimingEnd()}renderLayer(t,s,f,_){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||_&&_.length)&&(this.id=f.id,this.gpuTimingStart(f),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(f.type)&&(!t.terrain||f.type!=="custom")||f.type==="clip"||Yn[f.type](t,s,f,_,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const s=this.context.extTimerQuery,f=this.context.gl;let _=this.gpuTimers[t.id];_||(_=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:f.createQuery()}),_.calls++,f.beginQuery(s.TIME_ELAPSED_EXT,_.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,s=this.context.gl,f=s.createQuery();this.deferredRenderGpuTimeQueries.push(f),s.beginQuery(t.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const s={};for(const f in t){const _=t[f],g=this.context.extTimerQuery,b=g.getQueryParameter(_.query,this.context.gl.QUERY_RESULT)/1e6;g.deleteQueryEXT(_.query),s[f]=b}return s}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const s=this.context.gl;let f=0;for(const _ of t)f+=s.getQueryParameter(_,s.QUERY_RESULT)/1e6,s.deleteQuery(_);return f}translatePosMatrix(t,s,f,_,g){if(!f[0]&&!f[1])return t;const b=g?_==="map"?this.transform.angle:0:_==="viewport"?-this.transform.angle:0;if(b){const z=Math.sin(b),D=Math.cos(b);f=[f[0]*D-f[1]*z,f[0]*z+f[1]*D]}const T=[g?f[0]:r.aw(s,f[0],this.transform.zoom),g?f[1]:r.aw(s,f[1],this.transform.zoom),0],A=new Float32Array(16);return r.bo(A,t,T),A}saveTileTexture(t){const s=t.size[0],f=this._tileTextures[s];f?f.push(t):this._tileTextures[s]=[t]}getTileTexture(t){const s=this._tileTextures[t];return s&&s.length>0?s.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,s,f){const _=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,g=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(g.push("LIGHTING_3D_MODE"),g.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):_||g.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||g.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(g.push("TERRAIN"),this.linearFloatFilteringSupported()&&g.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&g.push("GLOBE"),!this._fogVisible||_||s!==void 0&&!s||g.push("FOG","FOG_DITHERING"),_&&g.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&g.push("OVERDRAW_INSPECTOR"),g}getOrCreateProgram(t,s){this.cache=this.cache||{};const f=s&&s.defines||[],_=s&&s.config,g=this.currentGlobalDefines(t,s&&s.overrideFog,s&&s.overrideRtt).concat(f),b=_f.cacheKey(dl[t],t,g,_);return this.cache[b]||(this.cache[b]=new _f(this.context,t,dl[t],_,Jx[t],g)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new r.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,s){if(this.style.enable3dLights()){const f=this.style.directionalLight,_=this.style.ambientLight;if(f&&_){const g=((b,T,A)=>{const z=b.properties.get("direction"),D=b.properties.get("color-use-theme")==="none",F=b.properties.get("color").toRenderColor(D?null:A.getLut(b.scope)).toArray01(),O=b.properties.get("intensity"),U=T.properties.get("color-use-theme")==="none",H=T.properties.get("color").toRenderColor(U?null:A.getLut(T.scope)).toArray01(),q=T.properties.get("intensity"),Y=[z.x,z.y,z.z],Z=r.dw(H,q),oe=r.dw(F,O);return{u_lighting_ambient_color:Z,u_lighting_directional_dir:Y,u_lighting_directional_color:oe,u_ground_radiance:Ap(Y,oe,Z)}})(f,_,this.style);s.setLightsUniformValues(t,g)}}}uploadCommonUniforms(t,s,f,_,g){if(this.uploadCommonLightUniforms(t,s),this.terrain&&this.terrain.renderingToTexture)return;const b=this.style.fog;if(b){const T=b.getOpacity(this.transform.pitch),A=((z,D,F,O,U,H,q,Y,Z,oe,fe,me)=>{const xe=z.transform,ye=D.properties.get("color-use-theme")==="none",ve=D.properties.get("color").toRenderColor(ye?null:z.style.getLut(D.scope)).toArray01();ve[3]=O;const _e=z.frameCounter/1e3%1,[we,Te]=D.properties.get("vertical-range");return{u_fog_matrix:F?xe.calculateFogTileMatrix(F):me||z.identityMat,u_fog_range:D.getFovAdjustedRange(xe._fov),u_fog_color:ve,u_fog_horizon_blend:D.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(we,Te),Te],u_fog_temporal_offset:_e,u_frustum_tl:U,u_frustum_tr:H,u_frustum_br:q,u_frustum_bl:Y,u_globe_pos:Z,u_globe_radius:oe,u_viewport:fe,u_globe_transition:r.ah(xe.zoom),u_is_globe:+(xe.projection.name==="globe")}})(this,b,f,T,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*r.q.devicePixelRatio,this.transform.height*r.q.devicePixelRatio],_);s.setFogUniformValues(t,A)}g&&s.setCutoffUniformValues(t,g.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),s}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,s=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(const _ of f)s[_.key]=t[_.key]||new Zs(_,512,this.transform.tileZoom,this);return s}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,s){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building")&&(!s||s.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let s=this._cachedTileFogOpacities[t.key];return s||(this._cachedTileFogOpacities[t.key]=s=this.style.fog.getOpacityForTile(t)),s[0]>=kt||s[1]>=kt}setupDepthForOcclusion(t,s,f){const _=this.context,g=_.gl,b=!!f;var T;f||(f={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),_.activeTexture.set(g.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE),f.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],f.u_depth_range_unpack=[2/((T=this.depthRangeFor3D)[1]-T[0]),-1-2*T[0]/(T[1]-T[0])],f.u_occluder_half_size=.5*this.occlusionParams.occluderSize,f.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE),_.activeTexture.set(g.TEXTURE0),b||s.setTerrainUniformValues(_,f)}}function Sl(h,t){let s=!1,f=null;const _=()=>{f=null,s&&(h(),f=setTimeout(_,t),s=!1)};return()=>(s=!0,f||_(),f)}class Tc{constructor(t){this._hashName=t&&encodeURIComponent(t),r.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Sl(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const s=Rf(t);if(this._hashName){const f=this._hashName;let _=!1;const g=location.hash.slice(1).split("&").map(b=>{const T=b.split("=")[0];return T===f?(_=!0,`${T}=${s}`):b}).filter(b=>b);return _||g.push(`${f}=${s}`),`#${g.join("&")}`}return`#${s}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let s;return t.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(s=f)}),(s&&s[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const s=this._getCurrentHash();if(s.length>=3&&!s.some(f=>isNaN(Number(f)))){const f=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(s[3]||0):t.getBearing();return t.jumpTo({center:[+s[2],+s[1]],zoom:+s[0],bearing:f,pitch:+(s[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Rf(h,t){const s=h.getCenter(),f=Math.round(100*h.getZoom())/100,_=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),g=Math.pow(10,_),b=Math.round(s.lng*g)/g,T=Math.round(s.lat*g)/g,A=h.getBearing(),z=h.getPitch();let D=t?`/${b}/${T}/${f}`:`${f}/${T}/${b}`;return(A||z)&&(D+="/"+Math.round(10*A)/10),z&&(D+=`/${Math.round(z)}`),D}const Sc={linearity:.3,easing:r.ew(0,0,.3,1)},qp=r.l({deceleration:2500,maxSpeed:1400},Sc),Hp=r.l({deceleration:20,maxSpeed:1400},Sc),As=r.l({deceleration:1e3,maxSpeed:360},Sc),Js=r.l({deceleration:1e3,maxSpeed:90},Sc);class Df{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:r.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,s=r.q.now();for(;t.length>0&&s-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const s={zoom:0,bearing:0,pitch:0,pan:new r.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:g}of this._inertiaBuffer)s.zoom+=g.zoomDelta||0,s.bearing+=g.bearingDelta||0,s.pitch+=g.pitchDelta||0,g.panDelta&&s.pan._add(g.panDelta),g.around&&(s.around=g.around),g.pinchAround&&(s.pinchAround=g.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,_={};if(s.pan.mag()){const g=Ec(s.pan.mag(),f,r.l({},qp,t||{}));_.offset=s.pan.mult(g.amount/s.pan.mag()),_.center=this._map.transform.center,El(_,g)}if(s.zoom){const g=Ec(s.zoom,f,Hp);_.zoom=this._map.transform.zoom+g.amount,El(_,g)}if(s.bearing){const g=Ec(s.bearing,f,As);_.bearing=this._map.transform.bearing+r.aD(g.amount,-179,179),El(_,g)}if(s.pitch){const g=Ec(s.pitch,f,Js);_.pitch=this._map.transform.pitch+g.amount,El(_,g)}if(_.zoom||_.bearing){const g=s.pinchAround===void 0?s.around:s.pinchAround;_.around=g?this._map.unproject(g):this._map.getCenter()}return this.clear(),_.noMoveStart=!0,_}}function El(h,t){(!h.duration||h.duration<t.duration)&&(h.duration=t.duration,h.easing=t.easing)}function Ec(h,t,s){const{maxSpeed:f,linearity:_,deceleration:g}=s,b=r.aD(h*_/(t/1e3),-f,f),T=Math.abs(b)/(g*_);return{easing:s.easing,duration:1e3*T,amount:b*(T/2)}}class ho extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s,f,_={}){const g=nt(s.getCanvasContainer(),f),b=s.unproject(g);super(t,r.l({point:g,lngLat:b,originalEvent:f},_)),this._defaultPrevented=!1,this.target=s}}class Is extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s,f){const _=t==="touchend"?f.changedTouches:f.touches,g=rt(s.getCanvasContainer(),_),b=g.map(A=>s.unproject(A)),T=g.reduce((A,z,D,F)=>A.add(z.div(F.length)),new r.P(0,0));super(t,{points:g,point:T,lngLats:b,lngLat:s.unproject(T),originalEvent:f}),this._defaultPrevented=!1}}class Zp extends r.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s){super("wheel",{originalEvent:s}),this._defaultPrevented=!1}}class Pa{constructor(t,s){this._map=t,this._clickTolerance=s.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Zp(this._map,t))}mousedown(t,s){return this._mousedownPos=s,this._firePreventable(new ho(t.type,this._map,t))}mouseup(t){this._map.fire(new ho(t.type,this._map,t))}preclick(t){const s=r.l({},t);s.type="preclick",this._map.fire(new ho(s.type,this._map,s))}click(t,s){this._mousedownPos&&this._mousedownPos.dist(s)>=this._clickTolerance||(this.preclick(t),this._map.fire(new ho(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new ho(t.type,this._map,t))}mouseover(t){this._map.fire(new ho(t.type,this._map,t))}mouseout(t){this._map.fire(new ho(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Is(t.type,this._map,t))}touchmove(t){this._map.fire(new Is(t.type,this._map,t))}touchend(t){this._map.fire(new Is(t.type,this._map,t))}touchcancel(t){this._map.fire(new Is(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Wp{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new ho(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ho("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new ho(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Lf{constructor(t,s){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=s.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,s){this.isEnabled()&&t.shiftKey&&t.button===0&&(se(),this._startPos=this._lastPos=s,this._active=!0)}mousemoveWindow(t,s){if(!this._active)return;const f=s,_=this._startPos,g=this._lastPos;if(!_||!g||g.equals(f)||!this._box&&f.dist(_)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=J("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const b=Math.min(_.x,f.x),T=Math.max(_.x,f.x),A=Math.min(_.y,f.y),z=Math.max(_.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${b}px,${A}px)`,this._box.style.width=T-b+"px",this._box.style.height=z-A+"px")})}mouseupWindow(t,s){if(!this._active)return;const f=this._startPos,_=s;if(f&&t.button===0){if(this.reset(),Qe(),f.x!==_.x||f.y!==_.y)return this._map.fire(new r.A("boxzoomend",{originalEvent:t})),{cameraAnimation:g=>g.fitScreenCoordinates(f,_,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Ae(),delete this._startPos,delete this._lastPos}_fireEvent(t,s){return this._map.fire(new r.A(t,{originalEvent:s}))}}function ju(h,t){const s={};for(let f=0;f<h.length;f++)s[h[f].identifier]=t[f];return s}class Xp{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,s,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),f.length===this.numTouches&&(this.centroid=function(_){const g=new r.P(0,0);for(const b of _)g._add(b);return g.div(_.length)}(s),this.touches=ju(f,s)))}touchmove(t,s,f){if(this.aborted||!this.centroid)return;const _=ju(f,s);for(const g in this.touches){const b=_[g];(!b||b.dist(this.touches[g])>30)&&(this.aborted=!0)}}touchend(t,s,f){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const _=!this.aborted&&this.centroid;if(this.reset(),_)return _}}}class wr{constructor(t){this.singleTap=new Xp(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,s,f){this.singleTap.touchstart(t,s,f)}touchmove(t,s,f){this.singleTap.touchmove(t,s,f)}touchend(t,s,f){const _=this.singleTap.touchend(t,s,f);if(_){const g=t.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(_)<30;if(g&&b||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=_,this.count===this.numTaps)return this.reset(),_}}}class Yp{constructor(){this._zoomIn=new wr({numTouches:1,numTaps:2}),this._zoomOut=new wr({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,s,f){this._zoomIn.touchstart(t,s,f),this._zoomOut.touchstart(t,s,f)}touchmove(t,s,f){this._zoomIn.touchmove(t,s,f),this._zoomOut.touchmove(t,s,f)}touchend(t,s,f){const _=this._zoomIn.touchend(t,s,f),g=this._zoomOut.touchend(t,s,f);return _?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(_)},{originalEvent:t})}):g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(g)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Kp={0:1,2:2},za={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class $u{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,s){return!1}_move(t,s){return{}}mousedown(t,s){if(this._lastPoint)return;const f=tt(t);this._correctButton(t,f)&&(this._lastPoint=s,this._eventButton=f)}mousemoveWindow(t,s){const f=this._lastPoint;if(f){if(t.preventDefault(),this._eventButton!=null&&function(_,g){const b=Kp[g];return _.buttons===void 0||(_.buttons&b)!==b}(t,this._eventButton))this.reset();else if(this._moved||!(s.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=s,this._move(f,s)}}mouseupWindow(t){this._lastPoint&&tt(t)===this._eventButton&&(this._moved&&Qe(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jp extends $u{mousedown(t,s){super.mousedown(t,s),this._lastPoint&&(this._active=!0)}_correctButton(t,s){return s===0&&!t.ctrlKey}_move(t,s){return{around:s,panDelta:s.sub(t)}}}class kf extends $u{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?za[t.pitchRotateKey]:void 0}_correctButton(t,s){return this._pitchRotateKey?s===0&&t[this._pitchRotateKey]:s===0&&t.ctrlKey||s===2}_move(t,s){const f=.8*(s.x-t.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Al extends $u{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?za[t.pitchRotateKey]:void 0}_correctButton(t,s){return this._pitchRotateKey?s===0&&t[this._pitchRotateKey]:s===0&&t.ctrlKey||s===2}_move(t,s){const f=-.5*(s.y-t.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Qp{constructor(t,s){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=s.clickTolerance||1,this.reset(),r.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new r.P(0,0)}touchstart(t,s,f){return this._calculateTransform(t,s,f)}touchmove(t,s,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!r.ex())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,s,f)}}touchend(t,s,f){this._calculateTransform(t,s,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,s,f){f.length>0&&(this._active=!0);const _=ju(f,s),g=new r.P(0,0),b=new r.P(0,0);let T=0;for(const z in _){const D=_[z],F=this._touches[z];F&&(g._add(D),b._add(D.sub(F)),T++,_[z]=D)}if(this._touches=_,T<this._minTouches||!b.mag())return;const A=b.div(T);return this._sum._add(A),this._sum.mag()<this._clickTolerance?void 0:{around:g.div(T),panDelta:A}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=J("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Gu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,s,f){return{}}touchstart(t,s,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([s[0],s[1]]))}touchmove(t,s,f){const _=this._firstTwoTouches;if(!_)return;t.preventDefault();const[g,b]=_,T=Ac(f,s,g),A=Ac(f,s,b);if(!T||!A)return;const z=this._aroundCenter?null:T.add(A).div(2);return this._move([T,A],z,t)}touchend(t,s,f){if(!this._firstTwoTouches)return;const[_,g]=this._firstTwoTouches,b=Ac(f,s,_),T=Ac(f,s,g);b&&T||(this._active&&Qe(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ac(h,t,s){for(let f=0;f<h.length;f++)if(h[f].identifier===s)return t[f]}function qu(h,t){return Math.log(h/t)/Math.LN2}class em extends Gu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,s){const f=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(qu(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:qu(this._distance,f),pinchAround:s}}}function Of(h,t){return 180*h.angleWith(t)/Math.PI}class Ug extends Gu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,s){const f=this._vector;if(this._vector=t[0].sub(t[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Of(this._vector,f),pinchAround:s}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const s=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;const _=Of(t,f);return Math.abs(_)<s}}function Ff(h){return Math.abs(h.y)>Math.abs(h.x)}class jg extends Gu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Ff(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,s,f){const _=this._lastPoints;if(!_)return;const g=t[0].sub(_[0]),b=t[1].sub(_[1]);return this._map._cooperativeGestures&&!r.ex()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(g,b,f.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(g.y+b.y)/2*-.5})}gestureBeginsVertically(t,s,f){if(this._valid!==void 0)return this._valid;const _=t.mag()>=2,g=s.mag()>=2;if(!_&&!g)return;if(!_||!g)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;const b=t.y>0==s.y>0;return Ff(t)&&Ff(s)&&b}}const $g={panStep:100,bearingStep:15,pitchStep:10};class Gg{constructor(){const t=$g;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let s=0,f=0,_=0,g=0,b=0;switch(t.keyCode){case 61:case 107:case 171:case 187:s=1;break;case 189:case 109:case 173:s=-1;break;case 37:t.shiftKey?f=-1:(t.preventDefault(),g=-1);break;case 39:t.shiftKey?f=1:(t.preventDefault(),g=1);break;case 38:t.shiftKey?_=1:(t.preventDefault(),b=-1);break;case 40:t.shiftKey?_=-1:(t.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(f=0,_=0),{cameraAnimation:T=>{const A=T.getZoom();T.easeTo({duration:300,easeId:"keyboardHandler",easing:qg,zoom:s?Math.round(A)+s*(t.shiftKey?2:1):A,bearing:T.getBearing()+f*this._bearingStep,pitch:T.getPitch()+_*this._pitchStep,offset:[-g*this._panStep,-b*this._panStep],center:T.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function qg(h){return h*(2-h)}const tm=4.000244140625,Hg=1/450;class Zg{constructor(t,s){this._map=t,this._el=t.getCanvasContainer(),this._handler=s,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Hg,r.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||r.ex()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let s=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const f=r.q.now(),_=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,s!==0&&s%tm==0?this._type="wheel":s!==0&&Math.abs(s)<4?this._type="trackpad":_>400?(this._type=null,this._lastValue=s,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(_*s)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,s+=this._lastValue)),t.shiftKey&&s&&(s/=4),this._type&&(this._lastWheelEvent=t,this._delta-=s,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const s=nt(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:s,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const s=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const z=this._type==="wheel"&&Math.abs(this._delta)>tm?this._wheelZoomRate:this._defaultZoomRate;let D=2/(1+Math.exp(-Math.abs(this._delta*z)));this._delta<0&&D!==0&&(D=1/D);const F=s(),O=Math.pow(2,F),U=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):O;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(U*D))),this._type==="wheel"&&(this._startZoom=F,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const f=typeof this._targetZoom=="number"?this._targetZoom:s(),_=this._startZoom,g=this._easing;let b,T=!1;if(this._type==="wheel"&&_&&g){const z=Math.min((r.q.now()-this._lastWheelEventTime)/200,1),D=g(z);b=r.ai(_,f,D),z<1?this._frameId||(this._frameId=!0):T=!0}else b=f,T=!0;this._active=!0,T&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let A=b-s();return A*this._lastDelta<0&&(A=0),{noInertia:!0,needsRenderFrame:!T,zoomDelta:A,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let s=r.ey;if(this._prevEase){const f=this._prevEase,_=(r.q.now()-f.start)/f.duration,g=f.easing(_+.01)-f.easing(_),b=.27/Math.sqrt(g*g+1e-4)*.01,T=Math.sqrt(.0729-b*b);s=r.ew(b,T,.25,1)}return this._prevEase={start:r.q.now(),duration:t,easing:s},s}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=J("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Wg{constructor(t,s){this._clickZoom=t,this._tapZoom=s}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Xg{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,s){return t.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(t.shiftKey?-1:1),around:f.unproject(s)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Yg{constructor(){this._tap=new wr({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,s,f){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=s[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(t,s,f))}touchmove(t,s,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const _=s[0],g=_.y-this._swipePoint.y;return this._swipePoint=_,t.preventDefault(),this._active=!0,{zoomDelta:g/128}}}else this._tap.touchmove(t,s,f)}touchend(t,s,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(t,s,f)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Kg{constructor(t,s,f){this._el=t,this._mousePan=s,this._touchPan=f}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class l1{constructor(t,s,f){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=s,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class c1{constructor(t,s,f,_){this._el=t,this._touchZoom=s,this._touchRotate=f,this._tapDragZoom=_,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Ui=h=>h.zoom||h.drag||h.pitch||h.rotate;class Jg extends r.A{}class u1{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,s){const f=r.at([],s,t);this.radius=r.ae(f[2]<0?r.eA([],f,this.constants):[f[0],f[1],0])}projectRay(t){r.eA(t,t,this.constants),r.au(t,t),r.eB(t,t,this.constants);const s=r.b$([],t,this.radius);if(s[2]>0){const f=r.b$([],[0,0,1],r.bE(s,[0,0,1])),_=r.b$([],r.au([],[s[0],s[1],0]),this.radius),g=r.cU([],s,r.b$([],r.at([],r.cU([],_,f),s),2));s[0]=g[0],s[1]=g[1]}return s}}function Ic(h){return h.panDelta&&h.panDelta.mag()||h.zoomDelta||h.bearingDelta||h.pitchDelta}class h1{constructor(t,s){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Df(t),this._bearingSnap=s.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new u1,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(s),r.aV(["handleEvent","handleWindowEvent"],this);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[_,g,b]of this._listeners){const T=_===document?this.handleWindowEvent:this.handleEvent;_.addEventListener(g,T,b)}}destroy(){for(const[t,s,f]of this._listeners){const _=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(s,_,f)}}_addDefaultHandlers(t){const s=this._map,f=s.getCanvasContainer();this._add("mapEvent",new Pa(s,t));const _=s.boxZoom=new Lf(s,t);this._add("boxZoom",_);const g=new Yp,b=new Xg;s.doubleClickZoom=new Wg(b,g),this._add("tapZoom",g),this._add("clickZoom",b);const T=new Yg;this._add("tapDragZoom",T);const A=s.touchPitch=new jg(s);this._add("touchPitch",A);const z=new kf(t),D=new Al(t);s.dragRotate=new l1(t,z,D),this._add("mouseRotate",z,["mousePitch"]),this._add("mousePitch",D,["mouseRotate"]);const F=new Jp(t),O=new Qp(s,t);s.dragPan=new Kg(f,F,O),this._add("mousePan",F),this._add("touchPan",O,["touchZoom","touchRotate"]);const U=new Ug,H=new em;s.touchZoomRotate=new c1(f,H,U,T),this._add("touchRotate",U,["touchPan","touchZoom"]),this._add("touchZoom",H,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Wp(s));const q=s.scrollZoom=new Zg(s,this);this._add("scrollZoom",q,["mousePan"]);const Y=s.keyboard=new Gg;this._add("keyboard",Y);for(const Z of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[Z]&&s[Z].enable(t[Z])}_add(t,s,f){this._handlers.push({handlerName:t,handler:s,allowed:f}),this._handlersById[t]=s}stop(t){if(!this._updatingCamera){for(const{handler:s}of this._handlers)s.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ui(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,s,f){for(const _ in t)if(_!==f&&(!s||s.indexOf(_)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const s=[];for(const f of t)this._el.contains(f.target)&&s.push(f);return s}handleEvent(t,s){this._updatingCamera=!0;const f=t.type==="renderFrame",_=f?void 0:t,g={needsRenderFrame:!1},b={},T={},A=t.touches?this._getMapTouches(t.touches):void 0,z=A?rt(this._el,A):f?void 0:nt(this._el,t);for(const{handlerName:O,handler:U,allowed:H}of this._handlers){if(!U.isEnabled())continue;let q;this._blockedByActive(T,H,O)?U.reset():U[s||t.type]&&(q=U[s||t.type](t,z,A),this.mergeHandlerResult(g,b,q,O,_),q&&q.needsRenderFrame&&this._triggerRenderFrame()),(q||U.isActive())&&(T[O]=U)}const D={};for(const O in this._previousActiveHandlers)T[O]||(D[O]=_);this._previousActiveHandlers=T,(Object.keys(D).length||Ic(g))&&(this._changes.push([g,b,D]),this._triggerRenderFrame()),(Object.keys(T).length||Ic(g))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:F}=g;F&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],F(this._map))}mergeHandlerResult(t,s,f,_,g){if(!f)return;r.l(t,f);const b={handlerName:_,originalEvent:f.originalEvent||g};f.zoomDelta!==void 0&&(s.zoom=b),f.panDelta!==void 0&&(s.drag=b),f.pitchDelta!==void 0&&(s.pitch=b),f.bearingDelta!==void 0&&(s.rotate=b)}_applyChanges(){const t={},s={},f={};for(const[_,g,b]of this._changes)_.panDelta&&(t.panDelta=(t.panDelta||new r.P(0,0))._add(_.panDelta)),_.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+_.zoomDelta),_.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+_.bearingDelta),_.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+_.pitchDelta),_.around!==void 0&&(t.around=_.around),_.aroundCoord!==void 0&&(t.aroundCoord=_.aroundCoord),_.pinchAround!==void 0&&(t.pinchAround=_.pinchAround),_.noInertia&&(t.noInertia=_.noInertia),r.l(s,g),r.l(f,b);this._updateMapTransform(t,s,f),this._changes=[]}_updateMapTransform(t,s,f){const _=this._map,g=_.transform,b=oe=>[oe.x,oe.y,oe.z];if((oe=>{const fe=this._eventsInProgress.drag;return fe&&!this._handlersById[fe.handlerName].isActive()})()&&!Ic(t)){const oe=g.zoom;g.cameraElevationReference="sea",this._originalZoom!=null&&g._orthographicProjectionAtLowPitch&&g.projection.name!=="globe"&&g.pitch===0?(g.cameraElevationReference="ground",g.zoom=this._originalZoom):(g.recenterOnTerrain(),g.cameraElevationReference="ground"),oe!==g.zoom&&this._map._update(!0)}if(g._isCameraConstrained&&_._stop(!0),!Ic(t))return void this._fireEvents(s,f,!0);let{panDelta:T,zoomDelta:A,bearingDelta:z,pitchDelta:D,around:F,aroundCoord:O,pinchAround:U}=t;g._isCameraConstrained&&(A>0&&(A=0),g._isCameraConstrained=!1),U!==void 0&&(F=U),(A||(oe=>s[oe]&&!this._eventsInProgress[oe])("drag"))&&F&&(this._dragOrigin=b(g.pointCoordinate3D(F)),this._originalZoom=g.zoom,this._trackingEllipsoid.setup(g._camera.position,this._dragOrigin)),g.cameraElevationReference="sea",_._stop(!0),F=F||_.transform.centerPoint,z&&(g.bearing+=z),D&&(g.pitch+=D),g._updateCameraState();const H=[0,0,0];if(T)if(g.projection.name==="mercator"){const oe=this._trackingEllipsoid.projectRay(g.screenPointToMercatorRay(F).dir),fe=this._trackingEllipsoid.projectRay(g.screenPointToMercatorRay(F.sub(T)).dir);H[0]=fe[0]-oe[0],H[1]=fe[1]-oe[1]}else{const oe=g.pointCoordinate(F);if(g.projection.name==="globe"){T=T.rotate(-g.angle);const fe=g._pixelsPerMercatorPixel/g.worldSize;H[0]=-T.x*r.ez(r.aY(oe.y))*fe,H[1]=-T.y*r.ez(g.center.lat)*fe}else{const fe=g.pointCoordinate(F.sub(T));oe&&fe&&(H[0]=fe.x-oe.x,H[1]=fe.y-oe.y)}}const q=g.zoom,Y=[0,0,0];if(A){const oe=b(O||g.pointCoordinate3D(F)),fe={dir:r.au([],r.at([],oe,g._camera.position))};if(fe.dir[2]<0){const me=g.zoomDeltaToMovement(oe,A);r.b$(Y,fe.dir,me)}}const Z=r.cU(H,H,Y);g._translateCameraConstrained(Z),A&&Math.abs(g.zoom-q)>1e-4&&g.recenterOnTerrain(),g.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(s,f,!0)}_fireEvents(t,s,f){const _=Ui(this._eventsInProgress),g=Ui(t),b={};for(const D in t){const{originalEvent:F}=t[D];this._eventsInProgress[D]||(b[`${D}start`]=F),this._eventsInProgress[D]=t[D]}!_&&g&&this._fireEvent("movestart",g.originalEvent);for(const D in b)this._fireEvent(D,b[D]);g&&this._fireEvent("move",g.originalEvent);for(const D in t){const{originalEvent:F}=t[D];this._fireEvent(D,F)}const T={};let A;for(const D in this._eventsInProgress){const{handlerName:F,originalEvent:O}=this._eventsInProgress[D];this._handlersById[F].isActive()||(delete this._eventsInProgress[D],A=s[F]||O,T[`${D}end`]=A)}for(const D in T)this._fireEvent(D,T[D]);const z=Ui(this._eventsInProgress);if(f&&(_||g)&&!z){this._updatingCamera=!0;const D=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),F=O=>O!==0&&-this._bearingSnap<O&&O<this._bearingSnap;D?(F(D.bearing||this._map.getBearing())&&(D.bearing=0),this._map.easeTo(D,{originalEvent:A})):(this._map.fire(new r.A("moveend",{originalEvent:A})),F(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,s){this._map.fire(new r.A(t,s?{originalEvent:s}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Jg("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Mc="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Qg extends r.E{constructor(t,s){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=s.bearingSnap,this._respectPrefersReducedMotion=s.respectPrefersReducedMotion!==!1,r.aV(["_renderFrameCallback"],this)}getCenter(){return new r.cd(this.transform.center.lng,this.transform.center.lat)}setCenter(t,s){return this.jumpTo({center:t},s)}panBy(t,s,f){return t=r.P.convert(t).mult(-1),this.panTo(this.transform.center,r.l({offset:t},s),f)}panTo(t,s,f){return this.easeTo(r.l({center:t},s),f)}getZoom(){return this.transform.zoom}setZoom(t,s){return this.jumpTo({zoom:t},s),this}zoomTo(t,s,f){return this.easeTo(r.l({zoom:t},s),f)}zoomIn(t,s){return this.zoomTo(this.getZoom()+1,t,s),this}zoomOut(t,s){return this.zoomTo(this.getZoom()-1,t,s),this}getBearing(){return this.transform.bearing}setBearing(t,s){return this.jumpTo({bearing:t},s),this}getPadding(){return this.transform.padding}setPadding(t,s){return this.jumpTo({padding:t},s),this}rotateTo(t,s,f){return this.easeTo(r.l({bearing:t},s),f)}resetNorth(t,s){return this.rotateTo(0,r.l({duration:1e3},t),s),this}resetNorthPitch(t,s){return this.easeTo(r.l({bearing:0,pitch:0,duration:1e3},t),s),this}snapToNorth(t,s){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,s):this}getPitch(){return this.transform.pitch}setPitch(t,s){return this.jumpTo({pitch:t},s),this}cameraForBounds(t,s){t=r.aG.convert(t);const f=s&&s.bearing||0,_=s&&s.pitch||0,g=t.getNorthWest(),b=t.getSouthEast();return this._cameraForBounds(this.transform,g,b,f,_,s)}_extendPadding(t){const s={top:0,right:0,bottom:0,left:0};return t==null?r.l({},s,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:r.l({},s,t)}_extendCameraOptions(t){return(t=r.l({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,s){const f=s.max[0]-s.min[0],_=s.max[1]-s.min[1];return f/_>t.aspect?f/(2*Math.tan(.5*t.fovX)*t.aspect):_/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,s,f,_,g,b){const T=t.clone(),A=this._extendCameraOptions(b);T.bearing=_,T.pitch=g;const z=r.cd.convert(s),D=r.cd.convert(f),F=.5*(z.lat+D.lat),O=.5*(z.lng+D.lng),U=r.eC(F,O),H=r.au([],U),q=r.au([],r.bG([],H,[0,1,0])),Y=r.bG([],q,H),Z=[q[0],q[1],q[2],0,Y[0],Y[1],Y[2],0,H[0],H[1],H[2],0,0,0,0,1],oe=[U,r.eC(z.lat,z.lng),r.eC(D.lat,z.lng),r.eC(D.lat,D.lng),r.eC(z.lat,D.lng),r.eC(F,z.lng),r.eC(F,D.lng),r.eC(z.lat,O),r.eC(D.lat,O)];let fe=r.cV.fromPoints(oe.map(Ze=>[r.bE(q,Ze),r.bE(Y,Ze),r.bE(H,Ze)]));const me=r.ad([],fe.center,Z);r.eD(me)===0&&r.eE(me,0,0,1),r.au(me,me),r.b$(me,me,r.aE),T.center=r.eF(me);const xe=T.getWorldToCameraMatrix(),ye=r.bi(new Float64Array(16),xe);fe=r.cV.applyTransform(fe,r.az([],xe,Z));const ve=this._extendAABB(fe,T,A,_);if(!ve)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");fe=ve,r.ad(me,me,xe);const _e=.5*(fe.max[2]-fe.min[2]),we=this._minimumAABBFrustumDistance(T,fe),Te=r.b$([],[0,0,1],_e),Ue=r.cU(Te,me,Te),Fe=we+(T.pitch===0?0:r.bD(me,Ue)),ot=T.globeCenterInViewSpace,et=r.at([],me,[ot[0],ot[1],ot[2]]);r.au(et,et),r.b$(et,et,Fe);const xt=r.cU([],me,et);r.ad(xt,xt,ye);const Oe=r.eq/r.aE,je=r.ae(xt),Le=r.c6(Math.max(je*Oe-r.eq,Number.EPSILON),0),lt=Math.min(T.zoomFromMercatorZAdjusted(Le),A.maxZoom);return lt>.5*(r.cL+r.cx)?(T.setProjection({name:"mercator"}),T.zoom=lt,this._cameraForBounds(T,s,f,_,g,b)):{center:T.center,zoom:lt,bearing:_,pitch:g}}_extendAABB(t,s,f,_){const g=.5*((f.padding.left||0)+(f.padding.right||0)),b=.5*((f.padding.top||0)+(f.padding.bottom||0)),T=b,A=g,z=g,D=b,F=s.width-(A+z),O=s.height-(T+D),U=r.at([],t.max,t.min),H=Math.min(F/U[0],O/U[1]),q=Math.min(s.scaleZoom(s.scale*H),f.maxZoom);if(isNaN(q))return null;const Y=s.scale/s.zoomScale(q),Z=new r.cV([t.min[0]-A*Y,t.min[1]-D*Y,t.min[2]],[t.max[0]+z*Y,t.max[1]+T*Y,t.max[2]]),oe=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new r.P(f.offset.x,f.offset.y):r.P.convert(f.offset)).rotate(-r.al(_));return Z.center[0]-=oe.x*Y,Z.center[1]+=oe.y*Y,Z}queryTerrainElevation(t,s){const f=this.transform.elevation;return f?(s=r.l({},{exaggerated:!0},s),f.getAtPoint(r.ac.fromLngLat(t),null,s.exaggerated)):null}_cameraForBounds(t,s,f,_,g,b){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,s,f,_,g,b);const T=t.clone(),A=this._extendCameraOptions(b);T.bearing=_,T.pitch=g;const z=r.cd.convert(s),D=r.cd.convert(f),F=new r.cd(z.lng,D.lat),O=new r.cd(D.lng,z.lat),U=T.project(z),H=T.project(D),q=this.queryTerrainElevation(z),Y=this.queryTerrainElevation(D),Z=this.queryTerrainElevation(F),oe=this.queryTerrainElevation(O),fe=[[U.x,U.y,Math.min(q||0,Y||0,Z||0,oe||0)],[H.x,H.y,Math.max(q||0,Y||0,Z||0,oe||0)]];let me=r.cV.fromPoints(fe);const xe=T.getWorldToCameraMatrix(),ye=r.bi(new Float64Array(16),xe);me=r.cV.applyTransform(me,xe);const ve=this._extendAABB(me,T,A,_);if(!ve)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");me=ve;const _e=.5*r.at([],me.max,me.min)[2],we=this._minimumAABBFrustumDistance(T,me),Te=[0,0,1,0];r.aA(Te,Te,xe),r.eG(Te,Te);const Ue=r.b$([],Te,we+_e),Fe=r.cU([],me.center,Ue);r.ad(me.center,me.center,ye),r.ad(Fe,Fe,ye);const ot=T.unproject(new r.P(me.center[0],me.center[1])),et=r.eH(T.projection,ot),xt=Math.pow(2,et),Oe=Math.min(T._zoomFromMercatorZ(Fe[2]*T.pixelsPerMeter*xt/T.worldSize),A.maxZoom);return T.mercatorFromTransition&&Oe<.5*(r.cL+r.cx)?(T.setProjection({name:"globe"}),T.zoom=Oe,this._cameraForBounds(T,s,f,_,g,b)):{center:ot,zoom:Oe,bearing:_,pitch:g}}fitBounds(t,s,f){const _=this.cameraForBounds(t,s);return this._fitInternal(_,s,f)}fitScreenCoordinates(t,s,f,_,g){const b=r.P.convert(t),T=r.P.convert(s),A=new r.P(Math.min(b.x,T.x),Math.min(b.y,T.y)),z=new r.P(Math.max(b.x,T.x),Math.max(b.y,T.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(b,T))return this;const D=this.transform.pointLocation3D(A),F=this.transform.pointLocation3D(z),O=this.transform.pointLocation3D(new r.P(A.x,z.y)),U=this.transform.pointLocation3D(new r.P(z.x,A.y)),H=[Math.min(D.lng,F.lng,O.lng,U.lng),Math.min(D.lat,F.lat,O.lat,U.lat)],q=[Math.max(D.lng,F.lng,O.lng,U.lng),Math.max(D.lat,F.lat,O.lat,U.lat)],Y=_&&_.pitch?_.pitch:this.getPitch(),Z=this._cameraForBounds(this.transform,H,q,f,Y,_);return this._fitInternal(Z,_,g)}_fitInternal(t,s,f){return t?(s=r.l(t,s)).linear?this.easeTo(s,f):this.flyTo(s,f):this}jumpTo(t,s){this.stop();const f=t.preloadOnly?this.transform.clone():this.transform;let _=!1,g=!1,b=!1;"zoom"in t&&f.zoom!==+t.zoom&&(_=!0,f.zoom=+t.zoom),t.center!==void 0&&(f.center=r.cd.convert(t.center)),"bearing"in t&&f.bearing!==+t.bearing&&(g=!0,f.bearing=+t.bearing),"pitch"in t&&f.pitch!==+t.pitch&&(b=!0,f.pitch=+t.pitch);const T=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!f.isPaddingEqual(T))if(t.retainPadding===!1){const A=f.clone();A.padding=T,f.setLocationAtPoint(f.center,A.centerPoint)}else f.padding=T;return t.preloadOnly?(this._preloadTiles(f),this):(this.fire(new r.A("movestart",s)).fire(new r.A("move",s)),_&&this.fire(new r.A("zoomstart",s)).fire(new r.A("zoom",s)).fire(new r.A("zoomend",s)),g&&this.fire(new r.A("rotatestart",s)).fire(new r.A("rotate",s)).fire(new r.A("rotateend",s)),b&&this.fire(new r.A("pitchstart",s)).fire(new r.A("pitch",s)).fire(new r.A("pitchend",s)),this.fire(new r.A("moveend",s)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||r.w(Mc),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,s){const f=this.transform;if(!f.projection.supportsFreeCamera)return r.w(Mc),this;this.stop();const _=f.zoom,g=f.pitch,b=f.bearing;f.setFreeCameraOptions(t);const T=_!==f.zoom,A=g!==f.pitch,z=b!==f.bearing;return this.fire(new r.A("movestart",s)).fire(new r.A("move",s)),T&&this.fire(new r.A("zoomstart",s)).fire(new r.A("zoom",s)).fire(new r.A("zoomend",s)),z&&this.fire(new r.A("rotatestart",s)).fire(new r.A("rotate",s)).fire(new r.A("rotateend",s)),A&&this.fire(new r.A("pitchstart",s)).fire(new r.A("pitch",s)).fire(new r.A("pitchend",s)),this.fire(new r.A("moveend",s)),this}easeTo(t,s){this._stop(!1,t.easeId),((t=r.l({offset:[0,0],duration:500,easing:r.ey},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const f=this.transform,_=this.getZoom(),g=this.getBearing(),b=this.getPitch(),T=this.getPadding(),A="zoom"in t?+t.zoom:_,z="bearing"in t?this._normalizeBearing(t.bearing,g):g,D="pitch"in t?+t.pitch:b,F=this._extendPadding(t.padding),O=r.P.convert(t.offset);let U,H,q;if(f.projection.name==="globe"){const Te=r.ac.fromLngLat(f.center),Ue=O.rotate(-f.angle);Te.x+=Ue.x/f.worldSize,Te.y+=Ue.y/f.worldSize;const Fe=Te.toLngLat(),ot=r.cd.convert(t.center||Fe);this._normalizeCenter(ot),U=f.centerPoint.add(Ue),H=new r.P(Te.x,Te.y).mult(f.worldSize),q=new r.P(r.ay(ot.lng),r.aH(ot.lat)).mult(f.worldSize).sub(H)}else{U=f.centerPoint.add(O);const Te=f.pointLocation(U),Ue=r.cd.convert(t.center||Te);this._normalizeCenter(Ue),H=f.project(Te),q=f.project(Ue).sub(H)}const Y=f.zoomScale(A-_);let Z,oe;t.around&&(Z=r.cd.convert(t.around),oe=f.locationPoint(Z));const fe=this._zooming||A!==_,me=this._rotating||g!==z,xe=this._pitching||D!==b,ye=!f.isPaddingEqual(F),ve=t.retainPadding===!1?f.clone():f,_e=Te=>Ue=>{if(fe&&(Te.zoom=r.ai(_,A,Ue)),me&&(Te.bearing=r.ai(g,z,Ue)),xe&&(Te.pitch=r.ai(b,D,Ue)),ye&&(ve.interpolatePadding(T,F,Ue),U=ve.centerPoint.add(O)),Z)Te.setLocationAtPoint(Z,oe);else{const Fe=Te.zoomScale(Te.zoom-_),ot=A>_?Math.min(2,Y):Math.max(.5,Y),et=Math.pow(ot,1-Ue),xt=Te.unproject(H.add(q.mult(Ue*et)).mult(Fe));Te.setLocationAtPoint(Te.renderWorldCopies?xt.wrap():xt,U)}return t.preloadOnly||this._fireMoveEvents(s),Te};if(t.preloadOnly){const Te=this._emulate(_e,t.duration,f);return this._preloadTiles(Te),this}const we={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=fe,this._rotating=me,this._pitching=xe,this._padding=ye,this._easeId=t.easeId,this._prepareEase(s,t.noMoveStart,we),this._ease(_e(f),Te=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(s,Te)},t),this}_prepareEase(t,s,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),s||f.moving||this.fire(new r.A("movestart",t)),this._zooming&&!f.zooming&&this.fire(new r.A("zoomstart",t)),this._rotating&&!f.rotating&&this.fire(new r.A("rotatestart",t)),this._pitching&&!f.pitching&&this.fire(new r.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new r.A("move",t)),this._zooming&&this.fire(new r.A("zoom",t)),this._rotating&&this.fire(new r.A("rotate",t)),this._pitching&&this.fire(new r.A("pitch",t))}_afterEase(t,s){if(this._easeId&&s&&this._easeId===s)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const f=this._zooming,_=this._rotating,g=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new r.A("zoomend",t)),_&&this.fire(new r.A("rotateend",t)),g&&this.fire(new r.A("pitchend",t)),this.fire(new r.A("moveend",t))}flyTo(t,s){if(this._prefersReducedMotion(t)){const Ze=r.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ze,s)}this.stop(),t=r.l({offset:[0,0],speed:1.2,curve:1.42,easing:r.ey},t);const f=this.transform,_=this.getZoom(),g=this.getBearing(),b=this.getPitch(),T=this.getPadding(),A="zoom"in t?r.aD(+t.zoom,f.minZoom,f.maxZoom):_,z="bearing"in t?this._normalizeBearing(t.bearing,g):g,D="pitch"in t?+t.pitch:b,F=this._extendPadding(t.padding),O=f.zoomScale(A-_),U=r.P.convert(t.offset);let H=f.centerPoint.add(U);const q=f.pointLocation(H),Y=r.cd.convert(t.center||q);this._normalizeCenter(Y);const Z=f.project(q),oe=f.project(Y).sub(Z);let fe=t.curve;const me=Math.max(f.width,f.height),xe=me/O,ye=oe.mag();if("minZoom"in t){const Ze=r.aD(Math.min(t.minZoom,_,A),f.minZoom,f.maxZoom),dt=me/f.zoomScale(Ze-_);fe=Math.sqrt(dt/ye*2)}const ve=fe*fe;function _e(Ze){const dt=(xe*xe-me*me+(Ze?-1:1)*ve*ve*ye*ye)/(2*(Ze?xe:me)*ve*ye);return Math.log(Math.sqrt(dt*dt+1)-dt)}function we(Ze){return(Math.exp(Ze)-Math.exp(-Ze))/2}function Te(Ze){return(Math.exp(Ze)+Math.exp(-Ze))/2}const Ue=_e(0);let Fe=function(Ze){return Te(Ue)/Te(Ue+fe*Ze)},ot=function(Ze){return me*((Te(Ue)*(we(dt=Ue+fe*Ze)/Te(dt))-we(Ue))/ve)/ye;var dt},et=(_e(1)-Ue)/fe;if(Math.abs(ye)<1e-6||!isFinite(et)){if(Math.abs(me-xe)<1e-6)return this.easeTo(t,s);const Ze=xe<me?-1:1;et=Math.abs(Math.log(xe/me))/fe,ot=function(){return 0},Fe=function(dt){return Math.exp(Ze*fe*dt)}}t.duration="duration"in t?+t.duration:1e3*et/("screenSpeed"in t?+t.screenSpeed/fe:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const xt=g!==z,Oe=D!==b,je=!f.isPaddingEqual(F),Le=t.retainPadding===!1?f.clone():f,lt=Ze=>dt=>{const st=dt*et,pt=1/Fe(st);Ze.zoom=dt===1?A:_+Ze.scaleZoom(pt),xt&&(Ze.bearing=r.ai(g,z,dt)),Oe&&(Ze.pitch=r.ai(b,D,dt)),je&&(Le.interpolatePadding(T,F,dt),H=Le.centerPoint.add(U));const mt=dt===1?Y:Ze.unproject(Z.add(oe.mult(ot(st))).mult(pt));return Ze.setLocationAtPoint(Ze.renderWorldCopies?mt.wrap():mt,H),Ze._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(s),Ze};if(t.preloadOnly){const Ze=this._emulate(lt,t.duration,f);return this._preloadTiles(Ze),this}return this._zooming=!0,this._rotating=xt,this._pitching=Oe,this._padding=je,this._prepareEase(s,!1),this._ease(lt(f),()=>this._afterEase(s),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,s){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,s)}if(!t){const f=this.handlers;f&&f.stop(!1)}return this}_ease(t,s,f){f.animate===!1||f.duration===0?(t(1),s()):(this._easeStart=r.q.now(),this._easeOptions=f,this._onEaseFrame=t,this._onEaseEnd=s,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((r.q.now()-this._easeStart)/this._easeOptions.duration,1),s=this._onEaseFrame;s&&s(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,s){t=r.bX(t,-180,180);const f=Math.abs(t-s);return Math.abs(t-360-s)<f&&(t-=360),Math.abs(t+360-s)<f&&(t+=360),t}_normalizeCenter(t){const s=this.transform;if(s.maxBounds||s.projection.name!=="globe"&&!s.renderWorldCopies)return;const f=t.lng-s.center.lng;t.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&r.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,s,f){const _=Math.ceil(15*s/1e3),g=[],b=t(f.clone());for(let T=0;T<=_;T++){const A=b(T/_);g.push(A.clone())}return g}_preloadTiles(t,s){}}class Bf{constructor(t={}){this.options=t,r.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const s=this.options&&this.options.compact,f=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=J("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=J("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",f);const _=J("span","mapboxgl-ctrl-icon",this._compactButton);return _.setAttribute("aria-hidden","true"),_.setAttribute("title",f),this._innerContainer=J("div","mapboxgl-ctrl-attrib-inner",this._container),s&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),s===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const s=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||r.e.ACCESS_TOKEN}];if(t){const f=s.reduce((_,g,b)=>(g.value&&(_+=`${g.key}=${g.value}${b<s.length-1?"&":""}`),_),"?");t.href=`${r.e.FEEDBACK_URL}/${f}#${Rf(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const _=this._map.style.stylesheet;this.styleOwner=_.owner,this.styleId=_.id}const s=this._map.style._mergedSourceCaches;for(const _ in s){const g=s[_];if(g.used){const b=g.getSource();b.attribution&&t.indexOf(b.attribution)<0&&t.push(b.attribution)}}t.sort((_,g)=>_.length-g.length),t=t.filter((_,g)=>{for(let b=g+1;b<t.length;b++)if(t[b].indexOf(_)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const f=t.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,t.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Hu{constructor(){r.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=J("div","mapboxgl-ctrl");const s=J("a","mapboxgl-ctrl-logo");return s.target="_blank",s.rel="noopener nofollow",s.href="https://www.mapbox.com/",s.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),s.setAttribute("rel","noopener nofollow"),this._container.appendChild(s),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const s in t){const f=t[s].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const s=t[0];this._map.getCanvasContainer().offsetWidth<250?s.classList.add("mapboxgl-compact"):s.classList.remove("mapboxgl-compact")}}}class Ms{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const s=++this._id;return this._queue.push({callback:t,id:s,cancelled:!1}),s}remove(t){const s=this._currentlyRunning,f=s?this._queue.concat(s):this._queue;for(const _ of f)if(_.id===t)return void(_.cancelled=!0)}run(t=0){const s=this._currentlyRunning=this._queue;this._queue=[];for(const f of s)if(!f.cancelled&&(f.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Nf{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const s=r.dk((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-s)+this._end*s}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,s,f){this._start=this.getValue(s),this._end=t,this._startTime=s,this._endTime=s+f}}const ir={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use â + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class us extends r.A{constructor(t,s,f,_){const{point:g,lngLat:b,originalEvent:T,target:A}=t;super(t.type,{point:g,lngLat:b,originalEvent:T,target:A}),this.preventDefault=()=>{t.preventDefault()},this.id=s,this.interaction=f,this.feature=_}}class Zu{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,s){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const f=s.filter;let _=s.type;f&&this.filters.set(t,r.b3(f)),_==="mouseover"&&(_="mouseenter"),_==="mouseout"&&(_="mouseleave");const g=this.interactionsByType.get(_)||new Map;_==="mouseenter"||_==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,s)):g.size===0&&this.map.on(_,this.handleType),g.size===0&&this.interactionsByType.set(_,g),g.set(t,s),this.typeById.set(t,_)}get(t){const s=this.typeById.get(t);if(!s)return;const f=this.interactionsByType.get(s);return f?f.get(t):void 0}remove(t){const s=this.typeById.get(t);if(!s)return;this.typeById.delete(t),this.filters.delete(t);const f=this.interactionsByType.get(s);f&&(f.delete(t),s==="mouseenter"||s==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):f.size===0&&this.map.off(s,this.handleType))}queryTargets(t,s){const f=[];for(const[_,g]of s)g.target&&f.push({targetId:_,target:g.target,filter:this.filters.get(_)});return this.map.style.queryRenderedTargets(t,f,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const s=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());s.length&&(t.type="mouseenter",this.handleType(t,s));const f=new Map;for(const[_,{feature:g}]of this.prevHoveredFeatures)this.hoveredFeatures.has(_)||f.set(g.id,g);f.size&&(t.type="mouseleave",this.handleType(t,Array.from(f.values())))}handleOut(t){const s=Array.from(this.hoveredFeatures.values()).map(({feature:f})=>f);s.length&&(t.type="mouseleave",this.handleType(t,s)),this.hoveredFeatures.clear()}handleType(t,s){const f=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!s;s=s||this.queryTargets(t.point,f);const g=t.type==="mouseenter";let b=!1;const T=new Set;for(const A of s){for(const[z,D]of f){if(!D.target)continue;const F=A.variants?A.variants[z]:null;if(F){for(const O of F){if(fu(O,A,T,z))continue;const U=new r.df(A,O),H=Vh(O,A,z);_&&(U.state=this.map.getFeatureState(U));const q=g?this.prevHoveredFeatures.get(H):null,Y=new us(t,z,D,U),Z=q?q.stop:D.handler(Y);if(g&&this.hoveredFeatures.set(H,{feature:A,stop:Z}),Z!==!1){b=!0;break}}if(b)break}}if(b)break}if(!b)for(const[A,z]of f){const{handler:D,target:F}=z;if(!F&&D(new us(t,A,z,null))!==!1)break}}}function Vf(h,t){if(Array.isArray(h)&&Array.isArray(t)){const s=new Set(h),f=new Set(t);return s.size===f.size&&h.every(_=>f.has(_))}return r.bv(h,t)}const e0={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},f1={showCompass:!0,showZoom:!0,visualizePitch:!1};class Wu{constructor(t,s,f=!1){this._clickTolerance=10,this.element=s,this.mouseRotate=new kf({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,f&&(this.mousePitch=new Al({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),r.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),s.addEventListener("mousedown",this.mousedown),s.addEventListener("touchstart",this.touchstart,{passive:!1}),s.addEventListener("touchmove",this.touchmove),s.addEventListener("touchend",this.touchend),s.addEventListener("touchcancel",this.reset)}down(t,s){this.mouseRotate.mousedown(t,s),this.mousePitch&&this.mousePitch.mousedown(t,s),se()}move(t,s){const f=this.map,_=this.mouseRotate.mousemoveWindow(t,s),g=_&&_.bearingDelta;if(g&&f.setBearing(f.getBearing()+g),this.mousePitch){const b=this.mousePitch.mousemoveWindow(t,s),T=b&&b.pitchDelta;T&&f.setPitch(f.getPitch()+T)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Ae(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(r.l({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),nt(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,nt(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=rt(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=rt(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function t0(h,t,s){if(h=new r.cd(h.lng,h.lat),t){const f=new r.cd(h.lng-360,h.lat),_=new r.cd(h.lng+360,h.lat),g=360*Math.ceil(Math.abs(h.lng-s.center.lng)/360),b=s.locationPoint3D(h).distSqr(t),T=t.x<0||t.y<0||t.x>s.width||t.y>s.height;s.locationPoint3D(f).distSqr(t)<b&&(T||Math.abs(f.lng-s.center.lng)<g)?h=f:s.locationPoint3D(_).distSqr(t)<b&&(T||Math.abs(_.lng-s.center.lng)<g)&&(h=_)}for(;Math.abs(h.lng-s.center.lng)>180;){const f=s.locationPoint3D(h);if(f.x>=0&&f.y>=0&&f.x<=s.width&&f.y<=s.height)break;h.lng>s.center.lng?h.lng-=360:h.lng+=360}return h}const nm={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Ko={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Xu extends r.E{constructor(t,s){super(),(t instanceof HTMLElement||s)&&(t=r.l({element:t},s)),r.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:f="center",color:_="#3FB1CE",scale:g=1,draggable:b=!1,clickTolerance:T=0,rotation:A=Ko.rotation,rotationAlignment:z=Ko.rotationAlignment,pitchAlignment:D=Ko.pitchAlignment,occludedOpacity:F=Ko.occludedOpacity,altitude:O=Ko.altitude}=t||{};this._anchor=f,this._color=_,this._scale=g,this._draggable=b,this._clickTolerance=T,this._rotation=A,this._rotationAlignment=z,this._pitchAlignment=D,this._occludedOpacity=F,this._altitude=O,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=r.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=r.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",q=>{q.preventDefault()}),this._element.addEventListener("mousedown",q=>{q.preventDefault()});const U=this._element.classList;for(const q in nm)U.remove(`mapboxgl-marker-anchor-${q}`);U.add(`mapboxgl-marker-anchor-${this._anchor}`);const H=t&&t.className?t.className.trim().split(/\s+/):[];U.add(...H),this._popup=null}_createDefaultMarker(){const t=J("div"),s=Q("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const f=Q("radialGradient",{id:"shadowGradient"},Q("defs",{},s));Q("stop",{offset:"10%","stop-opacity":.4},f),Q("stop",{offset:"100%","stop-opacity":.05},f),Q("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},s)}return Q("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},s),Q("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},s),Q("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},s),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=r.cd.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Ko.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const _=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[_,-1*(38.1-13.5+_)],"bottom-right":[-_,-1*(38.1-13.5+_)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const s=t.code,f=t.charCode||t.keyCode;s!=="Space"&&s!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(t){const s=t.originalEvent.target,f=this._element;this._popup&&(s===f||f.contains(s))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,s=this._pos;if(!t||!s)return!1;const f=t.unproject(s,this._altitude),_=t.getFreeCameraOptions();if(!_.position)return!1;const g=_.position.toLngLat();return g.distanceTo(f)<.9*g.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const s=this._pos;if(!s||s.x<0||s.x>t.transform.width||s.y<0||s.y>t.transform.height)return void this._clearFadeTimer();const f=t.unproject(s,this._altitude);let _;t._showingGlobe()&&r.eK(t.transform,this._lngLat)?_=0:(_=1-t._queryFogOpacity(f),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(_*=this._occludedOpacity)),this._element.style.opacity=`${_}`,this._element.style.pointerEvents=_>0?"auto":"none",this._popup&&this._popup._setOpacity(_),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const s=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${nm[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${s.x}px,${s.y}px)
        `}_calculateXYTransform(){const t=this._pos,s=this._map,f=this.getPitchAlignment();if(!s||!t||f!=="map")return"";if(!s._showingGlobe()){const A=s.getPitch();return A?`rotateX(${A}deg)`:""}const _=r.cJ(r.eL(s.transform,this._lngLat)),g=t.sub(r.eM(s.transform)),b=Math.abs(g.x)+Math.abs(g.y);if(b===0)return"";const T=_/b;return`rotateX(${-g.y*T}deg) rotateY(${g.x*T}deg)`}_calculateZTransform(){const t=this._pos,s=this._map;if(!s||!t)return"";let f=0;const _=this.getRotationAlignment();if(_==="map")if(s._showingGlobe()){const g=s.project(new r.cd(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),b=s.project(new r.cd(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(g);f=r.cJ(Math.atan2(b.y,b.x))-90}else f=-s.getBearing();else if(_==="horizon"){const g=r.af(4,6,s.getZoom()),b=r.eM(s.transform);b.y+=g*s.transform.height;const T=t.sub(b),A=r.cJ(Math.atan2(T.y,T.x));f=(A>90?A-270:A+90)*(1-g)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const s=this._map;s&&(s.transform.renderWorldCopies&&(this._lngLat=t0(this._lngLat,this._pos,s.transform)),this._pos=s.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),s._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(s._showingGlobe()||s.getTerrain()||s.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=r.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const s=this._map;if(!s)return;const f=this._pointerdownPos,_=this._positionDelta;if(f&&_){if(!this._isDragging){const g=this._clickTolerance||s._clickTolerance;if(t.point.dist(f)<g)return;this._isDragging=!0}this._pos=t.point.sub(_),this._lngLat=s.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new r.A("dragstart"))),this.fire(new r.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new r.A("dragend")),this._state="inactive"}_addDragHandler(t){const s=this._map,f=this._pos;s&&f&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(f),this._pointerdownPos=t.point,this._state="pending",s.on("mousemove",this._onMove),s.on("touchmove",this._onMove),s.once("mouseup",this._onUp),s.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const s=this._map;return s&&(t?(s.on("mousedown",this._addDragHandler),s.on("touchstart",this._addDragHandler)):(s.off("mousedown",this._addDragHandler),s.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Ko.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Ko.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Ko.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Ko.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Yu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Cc={maxWidth:100,unit:"metric"},Qs={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},hs={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},fs=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Ra(h=new r.P(0,0),t="bottom"){if(typeof h=="number"){const s=Math.round(Math.sqrt(.5*Math.pow(h,2)));switch(t){case"top":return new r.P(0,h);case"top-left":return new r.P(s,s);case"top-right":return new r.P(-s,s);case"bottom":return new r.P(0,-h);case"bottom-left":return new r.P(s,-s);case"bottom-right":return new r.P(-s,-s);case"left":return new r.P(h,0);case"right":return new r.P(-h,0)}return new r.P(0,0)}return h instanceof r.P||Array.isArray(h)?r.P.convert(h):r.P.convert(h[t]||[0,0])}return{version:P,supported:te.supported,setRTLTextPlugin:r.eN,getRTLTextPluginStatus:r.eO,Map:class extends Qg{constructor(h){L.mark(M.create);const t=h;if((h=r.l({},e0,h)).minZoom!=null&&h.maxZoom!=null&&h.minZoom>h.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(h.minPitch!=null&&h.maxPitch!=null&&h.minPitch>h.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(h.minPitch!=null&&h.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(h.maxPitch!=null&&h.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(h.antialias&&r.eI(window)&&(h.antialias=!1,r.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new ul(h.minZoom,h.maxZoom,h.minPitch,h.maxPitch,h.renderWorldCopies,null,null),h),this._repaint=!!h.repaint,this._interactive=h.interactive,this._minTileCacheSize=h.minTileCacheSize,this._maxTileCacheSize=h.maxTileCacheSize,this._failIfMajorPerformanceCaveat=h.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=h.preserveDrawingBuffer,this._antialias=h.antialias,this._trackResize=h.trackResize,this._bearingSnap=h.bearingSnap,this._refreshExpiredTiles=h.refreshExpiredTiles,this._fadeDuration=h.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=h.crossSourceCollisions,this._collectResourceTiming=h.collectResourceTiming,this._language=this._parseLanguage(h.language),this._worldview=h.worldview,this._renderTaskQueue=new Ms,this._domRenderTaskQueue=new Ms,this._controls=[],this._markers=[],this._popups=[],this._mapId=r.a$(),this._locale=r.l({},ir,h.locale),this._clickTolerance=h.clickTolerance,this._cooperativeGestures=h.cooperativeGestures,this._performanceMetricsCollection=h.performanceMetricsCollection,this._tessellationStep=h.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=h.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Nf(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=h.scaleFactor,this._requestManager=new Pe(h.transformRequest,h.accessToken,h.testMode),this._silenceAuthErrors=!!h.testMode,this._contextCreateOptions=h.contextCreateOptions?Object.assign({},h.contextCreateOptions):{},typeof h.container=="string"){const s=document.getElementById(h.container);if(!s)throw new Error(`Container '${h.container.toString()}' not found.`);this._container=s}else{if(!(h.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=h.container}if(this._container.childNodes.length>0&&r.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),h.maxBounds&&this.setMaxBounds(h.maxBounds),this._spriteFormat=h.spriteFormat,r.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Up),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new h1(this,h),this._localFontFamily=h.localFontFamily,this._localIdeographFontFamily=h.localIdeographFontFamily,(h.style||!h.testMode)&&this.setStyle(h.style||r.e.DEFAULT_STYLE,{config:h.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),h.projection&&this.setProjection(h.projection),this.indoor=new sg(this),h.hash&&(this._hash=new Tc(typeof h.hash=="string"&&h.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:h.center,zoom:h.zoom,bearing:h.bearing,pitch:h.pitch});const s=h.bounds;s&&(this.resize(),this.fitBounds(s,r.l({},h.fitBoundsOptions,{duration:0})))}this.resize(),h.attributionControl&&this.addControl(new Bf({customAttribution:h.customAttribution})),this._logoControl=new Hu,this.addControl(this._logoControl,h.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",s=>{this._update(s.dataType==="style"),this.fire(new r.A(`${s.dataType}data`,s))}),this.on("dataloading",s=>{this.fire(new r.A(`${s.dataType}dataloading`,s))}),this._interactions=new Zu(this)}_getMapId(){return this._mapId}addControl(h,t){if(t===void 0&&(t=h.getDefaultPosition?h.getDefaultPosition():"top-right"),!h||!h.onAdd)return this.fire(new r.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const s=h.onAdd(this);this._controls.push(h);const f=this._controlPositions[t];return t.indexOf("bottom")!==-1?f.insertBefore(s,f.firstChild):f.appendChild(s),this}removeControl(h){if(!h||!h.onRemove)return this.fire(new r.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(h);return t>-1&&this._controls.splice(t,1),h.onRemove(this),this}hasControl(h){return this._controls.indexOf(h)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(h){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new r.A("movestart",h)).fire(new r.A("move",h)),this.fire(new r.A("resize",h)),t&&this.fire(new r.A("moveend",h)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(h){return this.transform.setMaxBounds(r.aG.convert(h)),this._update()}setMinZoom(h){if((h=h??-2)>=-2&&h<=this.transform.maxZoom)return this.transform.minZoom=h,this._update(),this.getZoom()<h?this.setZoom(h):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(h){if((h=h??22)>=this.transform.minZoom)return this.transform.maxZoom=h,this._update(),this.getZoom()>h?this.setZoom(h):this.fire(new r.A("zoomstart")).fire(new r.A("zoom")).fire(new r.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(h){if((h=h??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(h>=0&&h<=this.transform.maxPitch)return this.transform.minPitch=h,this._update(),this.getPitch()<h?this.setPitch(h):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(h){if((h=h??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(h>=this.transform.minPitch)return this.transform.maxPitch=h,this._update(),this.getPitch()>h?this.setPitch(h):this.fire(new r.A("pitchstart")).fire(new r.A("pitch")).fire(new r.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(h){return this._scaleFactor=h,this.painter.scaleFactor=h,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(h){return this.transform.renderWorldCopies=h,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(h){return h==="auto"?navigator.language:Array.isArray(h)?h.length===0?void 0:h.map(t=>t==="auto"?navigator.language:t):h}setLanguage(h){const t=this._parseLanguage(h);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const s of this._controls)s._setLanguage&&s._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(h){return this.style&&h!==this._worldview?(this._worldview=h,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(h){return this._lazyInitEmptyStyle(),h?typeof h=="string"&&(h={name:h}):h=null,this._useExplicitProjection=!!h,this._prioritizeAndUpdateProjection(h,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const h=this.transform,t=h.projection.name;let s;t==="globe"&&h.zoom>=r.cx?(h.setMercatorFromTransition(),s=!0):t==="mercator"&&h.zoom<r.cx&&(h.setProjection({name:"globe"}),s=!0),s&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(h,t){return this._updateProjection(h||t||{name:"mercator"})}_updateProjection(h){let t;return t=h.name==="globe"&&this.transform.zoom>=r.cx?this.transform.setMercatorFromTransition():this.transform.setProjection(h),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(h,t){return this.transform.locationPoint3D(r.cd.convert(h),t)}unproject(h,t){return this.transform.pointLocation3D(r.P.convert(h),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(h,t,s){const f=_=>{let g=[];if(Array.isArray(t)){const b=t.filter(T=>this.getLayer(T));g=b.length?this.queryRenderedFeatures(_,{layers:b}):[]}else g=this.queryRenderedFeatures(_,{target:t});return g};if(h==="mouseenter"||h==="mouseover"){let _=!1;return{listener:s,targets:t,delegates:{mousemove:b=>{const T=f(b.point);T.length?_||(_=!0,s.call(this,new ho(h,this,b.originalEvent,{features:T}))):_=!1},mouseout:()=>{_=!1}}}}if(h==="mouseleave"||h==="mouseout"){let _=!1;return{listener:s,targets:t,delegates:{mousemove:T=>{f(T.point).length?_=!0:_&&(_=!1,s.call(this,new ho(h,this,T.originalEvent)))},mouseout:T=>{_&&(_=!1,s.call(this,new ho(h,this,T.originalEvent)))}}}}{const _=g=>{const b=f(g.point);b.length&&(g.features=b,s.call(this,g),delete g.features)};return{listener:s,targets:t,delegates:{[h]:_}}}}on(h,t,s){if(typeof t=="function"||s===void 0)return super.on(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const f=this._createDelegatedListener(h,t,s);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[h]=this._delegatedListeners[h]||[],this._delegatedListeners[h].push(f);for(const _ in f.delegates)this.on(_,f.delegates[_]);return this}once(h,t,s){if(typeof t=="function"||s===void 0)return super.once(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const f=this._createDelegatedListener(h,t,s);for(const _ in f.delegates)this.once(_,f.delegates[_]);return this}off(h,t,s){if(typeof t=="function"||s===void 0)return super.off(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const f=this._delegatedListeners?this._delegatedListeners[h]:void 0;return f&&(_=>{for(let g=0;g<_.length;g++){const b=_[g];if(b.listener===s&&Vf(b.targets,t)){for(const T in b.delegates)this.off(T,b.delegates[T]);return _.splice(g,1),this}}})(f),this}queryRenderedFeatures(h,t){if(!this.style)return[];if(h===void 0||h instanceof r.P||Array.isArray(h)||t!==void 0||(t=h,h=void 0),h=h||[[0,0],[this.transform.width,this.transform.height]],!t){const g=this.style.queryRenderedFeatures(h,void 0,this.transform),b=this.style.queryRenderedFeatureset(h,void 0,this.transform);return g.concat(b)}let s=!0;if(t.target&&(s=this._isTargetValid(t.target),s&&!t.layers))return this.style.queryRenderedFeatureset(h,t,this.transform);let f=!0;if(t.layers&&Array.isArray(t.layers)){for(const g of t.layers)if(!this._isValidId(g)){f=!1;break}if(f&&!t.target)return this.style.queryRenderedFeatures(h,t,this.transform)}let _=[];return f&&(_=_.concat(this.style.queryRenderedFeatures(h,t,this.transform))),s&&(_=_.concat(this.style.queryRenderedFeatureset(h,t,this.transform))),_}querySourceFeatures(h,t){return!h||typeof h=="string"&&!this._isValidId(h)?[]:this.style.querySourceFeatures(h,t)}isPointOnSurface(h){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&r.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(r.P.convert(h))}addInteraction(h,t){return this._interactions.add(h,t),this}removeInteraction(h){return this._interactions.remove(h),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(h){return this._cooperativeGestures=h,this}setStyle(h,t){return t=r.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&h&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(h,(s,f)=>{if(s){const _=typeof s=="string"?s:s instanceof Error?s.message:s.error;r.w(`Unable to perform style diff: ${_}. Rebuilding the style from scratch.`),this._updateStyle(h,t)}else f&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(h,t))}_getUIString(h){const t=this._locale[h];if(t==null)throw new Error(`Missing UI string '${h}'`);return t}_updateStyle(h,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),h){const s=r.l({},t);t&&t.config&&(s.initialConfig=t.config,delete s.config),this.style=new Wo(this,s).load(h),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Wo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(r.w("There is no style added to the map."),!1)}_isValidId(h){return h==null?(this.fire(new r.z(new Error("IDs can't be empty."))),!1):!r.d9(h)||(this.fire(new r.z(new Error(`IDs can't contain special symbols: "${h}".`))),!1)}_isTargetValid(h){return"featuresetId"in h?this._isValidId("importId"in h?h.importId:h.featuresetId):"layerId"in h&&this._isValidId(h.layerId)}_areTargetsValid(h){if(Array.isArray(h)){for(const t of h)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(h)}addSource(h,t){return this._isValidId(h)?(this._lazyInitEmptyStyle(),this.style.addSource(h,t),this._update(!0)):this}isSourceLoaded(h){return!!this._isValidId(h)&&!!this.style&&this.style._isSourceCacheLoaded(h)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(h,t,s){this._lazyInitEmptyStyle(),this.style.addSourceType(h,t,s)}removeSource(h){return this._isValidId(h)?(this.style.removeSource(h),this._updateTerrain(),this._update(!0)):this}getSource(h){return this._isValidId(h)?this.style.getOwnSource(h):null}addImage(h,t,{pixelRatio:s=1,sdf:f=!1,stretchX:_,stretchY:g,content:b}={}){this._lazyInitEmptyStyle();const T=r.I.from(h);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:A,height:z,data:D}=r.q.getImageData(t);this.style.addImage(T,{data:new r.r({width:A,height:z},D),pixelRatio:s,stretchX:_,stretchY:g,content:b,sdf:f,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new r.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:A,height:z}=t,D=t;this.style.addImage(T,{data:new r.r({width:A,height:z},new Uint8Array(D.data)),pixelRatio:s,stretchX:_,stretchY:g,content:b,sdf:f,usvg:!1,version:0,userImage:D}),D.onAdd&&D.onAdd(this,h)}}updateImage(h,t){this._lazyInitEmptyStyle();const s=r.I.from(h),f=this.style.getImage(s);if(!f)return void this.fire(new r.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const _=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?r.q.getImageData(t):t,{width:g,height:b,data:T}=_;if(g===void 0||b===void 0)return void this.fire(new r.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(g!==(f.usvg?f.icon.usvg_tree.width:f.data.width)||b!==(f.usvg?f.icon.usvg_tree.height:f.data.height))return void this.fire(new r.z(new Error(`The width and height of the updated image (${g}, ${b})
                must be that same as the previous version of the image
                (${f.data.width}, ${f.data.height})`)));const A=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let z=!1;f.usvg?(f.data=new r.r({width:g,height:b},new Uint8Array(T)),f.usvg=!1,f.icon=void 0,z=!0):f.data.replace(T,A),this.style.updateImage(s,f,z)}hasImage(h){return h?!!this.style&&!!this.style.getImage(r.I.from(h)):(this.fire(new r.z(new Error("Missing required image id"))),!1)}removeImage(h){this.style.removeImage(r.I.from(h))}loadImage(h,t){r.o(this._requestManager.transformRequest(h,r.R.Image),(s,f)=>{t(s,f instanceof HTMLImageElement?r.q.getImageData(f):f)})}listImages(){return this.style.listImages().map(h=>h.name)}addModel(h,t){this._lazyInitEmptyStyle(),this.style.addModel(h,t)}hasModel(h){return h?this.style.hasModel(h):(this.fire(new r.z(new Error("Missing required model id"))),!1)}removeModel(h){this.style.removeModel(h)}listModels(){return this.style.listModels()}addLayer(h,t){return this._isValidId(h.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(h,t),this._update(!0)):this}getSlot(h){const t=this.getLayer(h);return t&&t.slot||null}setSlot(h,t){return this.style.setSlot(h,t),this.style.mergeLayers(),this._update(!0)}addImport(h,t){return this.style.addImport(h,t).catch(s=>this.fire(new r.z(new Error("Failed to add import",s)))),this}updateImport(h,t){return typeof t!="string"&&t.id!==h?(this.removeImport(h),this.addImport(t)):(this.style.updateImport(h,t),this._update(!0))}removeImport(h){return this.style.removeImport(h),this}moveImport(h,t){return this.style.moveImport(h,t),this._update(!0)}moveLayer(h,t){return this._isValidId(h)?(this.style.moveLayer(h,t),this._update(!0)):this}removeLayer(h){return this._isValidId(h)?(this.style.removeLayer(h),this._update(!0)):this}getLayer(h){if(!this._isValidId(h))return null;const t=this.style.getOwnLayer(h);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(h,t,s){return this._isValidId(h)?(this.style.setLayerZoomRange(h,t,s),this._update(!0)):this}setFilter(h,t,s={}){return this._isValidId(h)?(this.style.setFilter(h,t,s),this._update(!0)):this}getFilter(h){return this._isValidId(h)?this.style.getFilter(h):null}setPaintProperty(h,t,s,f={}){return this._isValidId(h)?(this.style.setPaintProperty(h,t,s,f),this._update(!0)):this}getPaintProperty(h,t){return this._isValidId(h)?this.style.getPaintProperty(h,t):null}setLayoutProperty(h,t,s,f={}){return this._isValidId(h)?(this.style.setLayoutProperty(h,t,s,f),this._update(!0)):this}getLayoutProperty(h,t){return this._isValidId(h)?this.style.getLayoutProperty(h,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(h){return this.style.setGlyphsUrl(h),this._update(!0)}getSchema(h){return this.style.getSchema(h)}setSchema(h,t){return this.style.setSchema(h,t),this._update(!0)}getConfig(h){return this.style.getConfig(h)}setConfig(h,t){return this.style.setConfig(h,t),this._update(!0)}getConfigProperty(h,t){return this.style.getConfigProperty(h,t)}setConfigProperty(h,t,s){return this.style.setConfigProperty(h,t,s),this._update(!0)}getFeaturesetDescriptors(h){return this.style.getFeaturesetDescriptors(h)}setLights(h){if(this._lazyInitEmptyStyle(),h&&h.length===1&&h[0].type==="flat"){const t=h[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(h),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const h=this.style.getLights()||[];return h.length===0&&h.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),h}setLight(h,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:h}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(h){return this._lazyInitEmptyStyle(),!h&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(h),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(h){return this._lazyInitEmptyStyle(),this.style.setFog(h),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(h){return this._lazyInitEmptyStyle(),this.style.setSnow(h),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(h){return this._lazyInitEmptyStyle(),this.style.setRain(h),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(h){return this._lazyInitEmptyStyle(),this.style.setColorTheme(h),this._update(!0)}setImportColorTheme(h,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(h,t),this._update(!0)}setCamera(h){return this.style.setCamera(h),this._triggerCameraUpdate(h)}_triggerCameraUpdate(h){return this._update(this.transform.setOrthographicProjectionAtLowPitch(h["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(h){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(r.cd.convert(h),this.transform):0}setFeatureState(h,t){return h.source&&!this._isValidId(h.source)?this:(this.style.setFeatureState(h,t),this._update())}removeFeatureState(h,t){return h.source&&!this._isValidId(h.source)?this:(this.style.removeFeatureState(h,t),this._update())}getFeatureState(h){return h.source&&!this._isValidId(h.source)?null:this.style.getFeatureState(h)}_updateContainerDimensions(){if(!this._container)return;const h=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let s,f,_,g=this._container;for(;g&&(!f||!_);){const b=window.getComputedStyle(g).transform;b&&b!=="none"&&(s=b.match(/matrix.*\((.+)\)/)[1].split(", "),s[0]&&s[0]!=="0"&&s[0]!=="1"&&(f=s[0]),s[3]&&s[3]!=="0"&&s[3]!=="1"&&(_=s[3])),g=g.parentElement}this._containerWidth=f?Math.abs(h/f):h,this._containerHeight=_?Math.abs(t/_):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&r.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const h=this._container;h.classList.add("mapboxgl-map"),(this._missingCSSCanary=J("div","mapboxgl-canary",h)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=J("div","mapboxgl-canvas-container",h);this._canvas=J("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const s=this._controlContainer=J("div","mapboxgl-control-container",h),f=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(_=>{f[_]=J("div",`mapboxgl-ctrl-${_}`,s)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(h,t){const s=r.q.devicePixelRatio||1;this._canvas.width=s*Math.ceil(h),this._canvas.height=s*Math.ceil(t),this._canvas.style.width=`${h}px`,this._canvas.style.height=`${t}px`}_addMarker(h){this._markers.push(h)}_removeMarker(h){const t=this._markers.indexOf(h);t!==-1&&this._markers.splice(t,1)}_addPopup(h){this._popups.push(h)}_removePopup(h){const t=this._popups.indexOf(h);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const h=r.l({},te.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",h);t?(It(t,!0),this.painter=new zf(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",s=>{s.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),r.m.testSupport(t)):this.fire(new r.z(new Error("Failed to initialize WebGL")))}_contextLost(h){h.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new r.A("webglcontextlost",{originalEvent:h}))}_contextRestored(h){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new r.A("webglcontextrestored",{originalEvent:h}))}_onMapScroll(h){if(h.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(h){return this.style?(this._styleDirty=this._styleDirty||h,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(h){return this._update(),this._renderTaskQueue.add(h)}_cancelRenderFrame(h){this._renderTaskQueue.remove(h)}_requestDomTask(h){!this.loaded()||this.loaded()&&!this.isMoving()?h():this._domRenderTaskQueue.add(h)}_render(h){let t;this.fire(new r.A("renderstart")),++this._frameId;const s=this.painter.context.extTimerQuery,f=r.q.now(),_=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=_.createQuery(),_.beginQuery(s.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(h),this._domRenderTaskQueue.run(h),this._removed)return;this._updateProjectionTransition();const g=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const z=this.transform.zoom,D=this.transform.pitch,F=r.q.now(),O=new r.aa(z,{now:F,fadeDuration:g,pitch:D,transition:this.style.transition});this.style.update(O)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let b=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),b=this._updateAverageElevation(f),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):b=this._updateAverageElevation(f);const T=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,g,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),T&&(this._placementDirty=T.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:g,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new r.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,L.mark(M.load),this.fire(new r.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const z=r.q.now()-f;_.endQuery(s.TIME_ELAPSED_EXT),setTimeout(()=>{const D=_.getQueryParameter(t,_.QUERY_RESULT)/1e6;_.deleteQuery(t),this.fire(new r.A("gpu-timing-frame",{cpuTime:z,gpuTime:D}))},50)}if(this.listens("gpu-timing-layer")){const z=this.painter.collectGpuTimers();setTimeout(()=>{const D=this.painter.queryGpuTimers(z);this.fire(new r.A("gpu-timing-layer",{layerTimes:D}))},50)}if(this.listens("gpu-timing-deferred-render")){const z=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const D=this.painter.queryGpuTimeDeferredRender(z);this.fire(new r.A("gpu-timing-deferred-render",{gpuTime:D}))},50)}const A=this._sourcesDirty||this._styleDirty||this._placementDirty||b;if(A||this._repaint)this.triggerRepaint();else{const z=this.idle();if(z&&(b=this._updateAverageElevation(f,!0)),b)this.triggerRepaint();else if(this._triggerFrame(!1),z&&(this.fire(new r.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const D=this._calculateSpeedIndex();this.fire(new r.A("speedindexcompleted",{speedIndex:D})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||A||(this._fullyLoaded=!0,L.mark(M.fullLoad),this._performanceMetricsCollection&&Gi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(h){for(const t of this._markers)h&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!h||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(h,t=!1){const s=_=>(this.transform.averageElevation=_,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&s(0);const f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(t||h-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(h)){const _=this.transform.averageElevation;let g=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(g)?g=0:this._averageElevationLastSampledAt=h;const b=Math.abs(_-g);if(b>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(g),s(g);this._averageElevation.easeTo(g,h,300)}else if(b>1e-4)return this._averageElevation.jumpTo(g),s(g)}return!!this._averageElevation.isEasing(h)&&s(this._averageElevation.getValue(h))}_authenticate(){fn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,h=>{if(h&&(h.message===ut||h.status===401)){const t=this.painter.context.gl;It(t,!1),this._logoControl instanceof Hu&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new r.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ti(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Nn(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const h=this._isDragging();this.painter.updateTerrain(this.style,h)}_calculateSpeedIndex(){const h=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const s=this.painter.context.gl,f=s.createFramebuffer();function _(g){s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,g,0);const b=new Uint8Array(s.drawingBufferWidth*s.drawingBufferHeight*4);return s.readPixels(0,0,s.drawingBufferWidth,s.drawingBufferHeight,s.RGBA,s.UNSIGNED_BYTE,b),b}return s.bindFramebuffer(s.FRAMEBUFFER,f),this._canvasPixelComparison(_(h),t.canvasCopies.map(_),t.timeStamps)}_canvasPixelComparison(h,t,s){let f=s[1]-s[0];const _=h.length/4;for(let g=0;g<t.length;g++){const b=t[g];let T=0;for(let A=0;A<b.length;A+=4)b[A]===h[A]&&b[A+1]===h[A+1]&&b[A+2]===h[A+2]&&b[A+3]===h[A+3]&&(T+=1);f+=(s[g+2]-s[g+1])*(1-T/_)}return f}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const h=this.painter.context.gl.getExtension("WEBGL_lose_context");h&&h.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Tn.delete(this.painter.context.gl),Ct.remove(),pi.remove(),this._removed=!0,this.fire(new r.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(h){this._renderNextFrame=this._renderNextFrame||h,this.style&&!this._frame&&(this._frame=r.q.frame(t=>{const s=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,s&&this._render(t)}))}_preloadTiles(h){const t=this.style?this.style.getSourceCaches():[];return r.bt(t,(s,f)=>s._preloadTiles(h,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(h){this._trackResize&&this.resize({originalEvent:h})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(h){this._showTileBoundaries!==h&&(this._showTileBoundaries=h,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(h){this._showParseStatus!==h&&(this._showParseStatus=h,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(h){this._showTerrainWireframe!==h&&(this._showTerrainWireframe=h,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(h){this._showLayers2DWireframe!==h&&(this._showLayers2DWireframe=h,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(h){this._showLayers3DWireframe!==h&&(this._showLayers3DWireframe=h,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(h){this._speedIndexTiming!==h&&(this._speedIndexTiming=h,this._update())}get showPadding(){return!!this._showPadding}set showPadding(h){this._showPadding!==h&&(this._showPadding=h,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(h){this._showCollisionBoxes!==h&&(this._showCollisionBoxes=h,this._tp.refreshUI(),h?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(h){this._showOverdrawInspector!==h&&(this._showOverdrawInspector=h,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(h){this._repaint!==h&&(this._repaint=h,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(h){this._vertices=h,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(h){this._showTileAABBs!==h&&(this._showTileAABBs=h,this._tp.refreshUI(),h&&this._update())}_setCacheLimits(h,t){r.eJ(h,t)}get version(){return P}},NavigationControl:class{constructor(h={}){this.options=r.l({},f1,h),this._container=J("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(r.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),J("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),J("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(r.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const s=this._map;s&&(this.options.visualizePitch?s.resetNorthPitch({},{originalEvent:t}):s.resetNorth({},{originalEvent:t}))}),this._compassIcon=J("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const h=this._map;if(!h)return;const t=h.getZoom(),s=t===h.getMaxZoom(),f=t===h.getMinZoom();this._zoomInButton.disabled=s,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",s.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){const h=this._map;if(!h)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(h.transform.pitch*(Math.PI/180)),.5)}) rotateX(${h.transform.pitch}deg) rotateZ(${h.transform.angle*(180/Math.PI)}deg)`:`rotate(${h.transform.angle*(180/Math.PI)}deg)`;h._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(h){return this._map=h,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),h.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&h.on("pitch",this._rotateCompassArrow),h.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Wu(h,this._compass,this.options.visualizePitch)),this._container}onRemove(){const h=this._map;h&&(this._container.remove(),this.options.showZoom&&h.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&h.off("pitch",this._rotateCompassArrow),h.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(h,t){const s=J("button",h,this._container);return s.type="button",s.addEventListener("click",t),s}_setButtonTitle(h,t){if(!this._map)return;const s=this._map._getUIString(`NavigationControl.${t}`);h.setAttribute("aria-label",s),h.firstElementChild&&h.firstElementChild.setAttribute("title",s)}},GeolocateControl:class extends r.E{constructor(h={}){super();const t=navigator.geolocation;this.options=r.l({geolocation:t},Yu,h),r.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Sl(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(h){return this._map=h,this._container=J("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(h){const t=(s=!!this.options.geolocation)=>{this._supportsGeolocation=s,h(s)};this._supportsGeolocation!==void 0?h(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(s=>t(s.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(h){const t=this._map.getMaxBounds(),s=h.coords;return!!t&&(s.longitude<t.getWest()||s.longitude>t.getEast()||s.latitude<t.getSouth()||s.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(h){if(this._map){if(this._isOutOfMapMaxBounds(h))return this._setErrorState(),this.fire(new r.A("outofmaxbounds",h)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=h,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(h),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(h),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("geolocate",h)),this._finish()}}_updateCamera(h){const t=new r.cd(h.coords.longitude,h.coords.latitude),s=h.coords.accuracy,f=this._map.getBearing(),_=r.l({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(s),_,{geolocateSource:!0})}_updateMarker(h){if(h){const t=new r.cd(h.coords.longitude,h.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=h.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const h=this._map.transform,t=r.c6(1,h._center.lat)*h.worldSize,s=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${s}px`,this._circleElement.style.height=`${s}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(h){if(this._map){if(this.options.trackUserLocation)if(h.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(h.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.A("error",h)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(h){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=J("button","mapboxgl-ctrl-geolocate",this._container),J("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",h===!1){r.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=J("div","mapboxgl-user-location"),this._dotElement.appendChild(J("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(J("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Xu({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=J("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Xu({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new r.A("trackuserlocationend")))})}}_onDeviceOrientation(h){this._userLocationDotMarker&&(h.webkitCompassHeading?this._heading=h.webkitCompassHeading:h.absolute===!0&&(this._heading=-1*h.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return r.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new r.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new r.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new r.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let h;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(h={maximumAge:6e5,timeout:0},this._noTimeout=!0):(h=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,h),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const h=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&h()}).catch(console.error):h()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Bf,ScaleControl:class{constructor(h={}){this.options=r.l({},Cc,h),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),r.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const h=this.options.maxWidth||100,t=this._map,s=t._containerHeight/2,f=t._containerWidth/2-h/2,_=t.unproject([f,s]),g=t.unproject([f+h,s]),b=_.distanceTo(g);if(this.options.unit==="imperial"){const T=3.2808*b;T>5280?this._setScale(h,T/5280,"mile"):this._setScale(h,T,"foot")}else this.options.unit==="nautical"?this._setScale(h,b/1852,"nautical-mile"):b>=1e3?this._setScale(h,b/1e3,"kilometer"):this._setScale(h,b,"meter")}_setScale(h,t,s){this._map._requestDomTask(()=>{const f=function(g){const b=Math.pow(10,`${Math.floor(g)}`.length-1);let T=g/b;return T=T>=10?10:T>=5?5:T>=3?3:T>=2?2:T>=1?1:function(A){const z=Math.pow(10,Math.ceil(-Math.log(A)/Math.LN10));return Math.round(A*z)/z}(T),b*T}(t),_=f/t;this._container.innerHTML=this._isNumberFormatSupported&&s!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:s}).format(f):`${f}&nbsp;${Qs[s]}`,this._container.style.width=h*_+"px"})}onAdd(h){return this._map=h,this._language=h.getLanguage(),this._container=J("div","mapboxgl-ctrl mapboxgl-ctrl-scale",h.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(h){this._language=h,this._update()}setUnit(h){this.options.unit=h,this._update()}},FullscreenControl:class{constructor(h={}){this._fullscreen=!1,h&&h.container&&(h.container instanceof HTMLElement?this._container=h.container:r.w("Full screen control 'container' must be a DOM element.")),r.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(h){return this._map=h,this._container||(this._container=this._map.getContainer()),this._controlContainer=J("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",r.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const h=this._fullscreenButton=J("button","mapboxgl-ctrl-fullscreen",this._controlContainer);J("span","mapboxgl-ctrl-icon",h).setAttribute("aria-hidden","true"),h.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const h=this._getTitle();this._fullscreenButton.setAttribute("aria-label",h),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",h)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends r.E{constructor(h){super(),this.options=r.l(Object.create(hs),h),this._altitude=this.options.altitude,r.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(h&&h.className?h.className.trim().split(/\s+/):[])}addTo(h){return this._map&&this.remove(),this._map=h,this.options.closeOnClick&&h.on("preclick",this._onClose),this.options.closeOnMove&&h.on("move",this._onClose),h.on("remove",this.remove),this._update(),h._addPopup(this),this._focusFirstElement(),this._trackPointer?(h.on("mousemove",this._onMouseEvent),h.on("mouseup",this._onMouseEvent),h._canvasContainer.classList.add("mapboxgl-track-pointer")):h.on("move",this._update),this.fire(new r.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const h=this._map;return h&&(h.off("move",this._update),h.off("move",this._onClose),h.off("preclick",this._onClose),h.off("click",this._onClose),h.off("remove",this.remove),h.off("mousemove",this._onMouseEvent),h.off("mouseup",this._onMouseEvent),h.off("drag",this._onMouseEvent),h._canvasContainer&&h._canvasContainer.classList.remove("mapboxgl-track-pointer"),h._removePopup(this),this._map=void 0),this.fire(new r.A("close")),this}getLngLat(){return this._lngLat}setLngLat(h){this._lngLat=r.cd.convert(h),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(h){return this._altitude=h,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const h=this._map;return h&&(h.off("move",this._update),h.on("mousemove",this._onMouseEvent),h.on("drag",this._onMouseEvent),h._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(h){return this.setDOMContent(document.createTextNode(h))}setHTML(h){const t=document.createDocumentFragment(),s=document.createElement("body");let f;for(s.innerHTML=h;f=s.firstChild,f;)t.appendChild(f);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(h){return this.options.maxWidth=h,this._update(),this}setDOMContent(h){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=J("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(h),this.options.closeButton){const s=this._closeButton=J("button","mapboxgl-popup-close-button",t);s.type="button",s.setAttribute("aria-label","Close popup"),s.innerHTML='<span aria-hidden="true">&#215;</span>',s.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(h){return this._classList.add(h),this._updateClassList(),this}removeClassName(h){return this._classList.delete(h),this._updateClassList(),this}setOffset(h){return this.options.offset=h,this._update(),this}toggleClassName(h){let t;return this._classList.delete(h)?t=!1:(this._classList.add(h),t=!0),this._updateClassList(),t}_onMouseEvent(h){this._update(h.point)}_getAnchor(h){if(this.options.anchor)return this.options.anchor;const t=this._map,s=this._container,f=this._pos;if(!t||!s||!f)return"bottom";const _=s.offsetWidth,g=s.offsetHeight,b=f.x<_/2,T=f.x>t.transform.width-_/2;if(f.y+h<g)return b?"top-left":T?"top-right":"top";if(f.y>t.transform.height-g){if(b)return"bottom-left";if(T)return"bottom-right"}return b?"left":T?"right":"bottom"}_updateClassList(){const h=this._container;if(!h)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),h.className=t.join(" ")}_update(h){const t=this._map,s=this._content;if(!t||!this._lngLat&&!this._trackPointer||!s)return;let f=this._container;if(f||(f=this._container=J("div","mapboxgl-popup",t.getContainer()),this._tip=J("div","mapboxgl-popup-tip",f),f.appendChild(s)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=t0(this._lngLat,this._pos,t.transform)),!this._trackPointer||h){const _=this._pos=this._trackPointer&&h instanceof r.P?h:t.project(this._lngLat,this._altitude),g=Ra(this.options.offset),b=this._anchor=this._getAnchor(g.y),T=Ra(this.options.offset,b),A=_.add(T).round();t._requestDomTask(()=>{this._container&&b&&(this._container.style.transform=`${nm[b]} translate(${A.x}px,${A.y}px)`)})}if(!this._marker&&t._showingGlobe()){const _=r.eK(t.transform,this._lngLat)?0:1;this._setOpacity(_)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const h=this._container.querySelector(fs);h&&h.focus()}_onClose(){this.remove()}_setOpacity(h){this._container&&(this._container.style.opacity=`${h}`),this._content&&(this._content.style.pointerEvents=h?"auto":"none")}},Marker:Xu,Style:Wo,LngLat:r.cd,LngLatBounds:r.aG,Point:r.P,MercatorCoordinate:r.ac,FreeCameraOptions:Kh,Evented:r.E,config:r.e,prewarm:r.eP,clearPrewarmedResources:r.eQ,get accessToken(){return r.e.ACCESS_TOKEN},set accessToken(h){r.e.ACCESS_TOKEN=h},get baseApiUrl(){return r.e.API_URL},set baseApiUrl(h){r.e.API_URL=h},get workerCount(){return r.eR.workerCount},set workerCount(h){r.eR.workerCount=h},get maxParallelImageRequests(){return r.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(h){r.e.MAX_PARALLEL_IMAGE_REQUESTS=h},clearStorage(h){r.eS(h)},get workerUrl(){return r.eT.workerUrl},set workerUrl(h){r.eT.workerUrl=h},get workerClass(){return r.eT.workerClass},set workerClass(h){r.eT.workerClass=h},get workerParams(){return r.eT.workerParams},set workerParams(h){r.eT.workerParams=h},get dracoUrl(){return r.eU()},set dracoUrl(h){r.eV(h)},get meshoptUrl(){return r.eW()},set meshoptUrl(h){r.eX(h)},setNow:r.q.setNow,restoreNow:r.q.restoreNow}});var E=y;return E})}(Ly)),Ly.exports}var XZ=WZ();const YZ=HZ(XZ);var bw=uF(()=>YZ),KZ=rP('<div class="overlay svelte-kbozhg"><button class="remove-overlay svelte-kbozhg">Click to Explore</button></div>'),JZ=qO('<path fill="white" opacity="0.2" stroke="white"></path>'),QZ=rP(`<main class="svelte-kbozhg"><h1 class="svelte-kbozhg">Bridging the Distance:<br> New Insights on Geography in Conflict Mediation</h1> <h2 style="font-size: 22px;" class="svelte-kbozhg"><a href="https://www.elisadamico.net/" target="_blank" class="svelte-kbozhg">Elisa D'Amico</a></h2> <div class="blog_text svelte-kbozhg"><p>Until recently, we havenât been able to answer basic questions about the
      logistics of conflict mediation and how they shape outcomes, largely due
      to a lack of systematic data. As a result, factors like where mediation
      takes place have remained understudied. With <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/PYRHS6" target="_blank" class="svelte-kbozhg">new data</a> now available, researchers are beginning to examine these overlooked dimensions,
      including recent work on the role of location in the mediation process.</p> <p>A recent study, <a href="https://github.com/elisadamico/The-Geography-of-Conflict-Mediation/blob/main/DAmico_TheGeographyofConflictMediation.pdf" target="_blank" class="svelte-kbozhg">âThe Geography of Conflict Mediation: Proximity and Success in Armed
        Conflict Resolutions,â</a> looks at how the distance between conflict zones and mediation sites affects
      the chances of reaching a peaceful outcome. Drawing on newly available geospatial
      data, the study finds that location plays a meaningful role in shaping mediation
      success.</p> <h2 class="svelte-kbozhg">The Paradox of Distance: Agreements vs. De-escalation</h2> <p>The research highlights a fascinating duality in mediation success:</p> <ol><li class="svelte-kbozhg"><strong>Distant Mediation Fosters Agreements</strong>: The study finds
        that the further a mediation event is from a conflict area, the higher
        the likelihood of a formal peace agreement being signed. This suggests
        that a greater geographical distance can confer perceived neutrality,
        reduce immediate local political pressures, and allow parties to
        negotiate without the intense emotional and security concerns that often
        plague discussions held closer to the conflict. The data indicates that
        for every additional âfar awayâ mediation event, the odds of a peace
        agreement being signed increase by approximately 14.2%. This underscores
        the strategic value of neutral ground when aiming for formal
        settlements.</li></ol></div> <div id="buttons" class="svelte-kbozhg"><button>Afghanistan</button> <button>Israel</button> <button>Libya</button> <button>Sudan</button> <button>Syria</button> <button>Yemen</button></div> <div class="map-wrapper svelte-kbozhg"><!> <div id="map" class="svelte-kbozhg"></div></div> <div class="blog_text svelte-kbozhg"><ol start="2"><li class="svelte-kbozhg"><strong>Closer Proximity Reduces Violence</strong>: Conversely, the
        research demonstrates that closer proximity between a mediation event
        and the conflict zone is directly linked to a greater reduction in
        violent events and fatalities. This is because localized mediation can
        foster trust, directly engage local actors, address specific grievances,
        and enable quicker responses to escalating violence on the ground. Such
        immediacy, driven by close proximity, acts as a powerful catalyst for
        de-escalation. Specifically, for every additional âclose byâ mediation
        event, the expected number of battle deaths in the following month
        decreases by approximately 4.7%.</li></ol></div> <div id="chart1" class="svelte-kbozhg"><svg></svg></div> <div class="blog_text svelte-kbozhg"><h2 class="svelte-kbozhg">Implications for Peacemakers</h2> <p>This groundbreaking work signals a vital redefinition of âconflict
      resolutionâ for peacemakers. It suggests that success isnât a singular
      metric. Formal agreements may indeed require the neutral, removed spaces
      offered by distant mediation, but the necessary work of reducing violence
      on the ground often happens closer to the epicenter of conflict through
      local engagement and direct intervention.</p> <p>For policymakers and peace practitioners, these findings prompt a deeper
      reflection on priorities and strategies:</p> <ul><li class="svelte-kbozhg"><strong>Tailor the Approach to the Goal</strong>: If the primary
        objective is a formal peace agreement, seeking geographically distant
        and neutral mediation venues appears to be a more effective strategy.</li> <li class="svelte-kbozhg"><strong>Invest in Localized Efforts</strong>: For immediate
        de-escalation and mitigation of fatalities, greater investment in and
        support for localized mediation efforts are essential. These efforts
        leverage intimate knowledge of the conflict context and facilitate
        trust-building among directly affected parties.</li> <li class="svelte-kbozhg"><strong>A Holistic Strategy</strong>: True conflict resolution requires
        a holistic strategy that values both formal peace agreements and
        on-the-ground violence reduction. This may necessitate a multi-layered
        approach, combining distant high-level negotiations with embedded,
        proximate mediation initiatives.</li></ul></div> <h2 style="font-size: 18px;" class="svelte-kbozhg">Visualization: Tomas Vancisin</h2></main>`);function eW(n,a){DC(a,!1);const u=oa(),m=oa();let y=oa(400),x=oa(400),E=oa(!0),r=oa(!1),P=oa("Afghanistan");function M(){Vr(E,!1),Vr(r,!0)}let L=vy([67.709953,33.93911],1500),V=vy([67.709953,33.93911],5e3),k=oa();bw(bw().accessToken="pk.eyJ1Ijoic2FzaGFnYXJpYmFsZHkiLCJhIjoiY2xyajRlczBlMDhqMTJpcXF3dHJhdTVsNyJ9.P_6mX_qbcbxLDS1o_SxpFg");let j,te,J,Q,ee=["./elisa_map.csv","./final_month.csv"],ue,ce=oa();NZ(ee).then(Ct=>{j=Ct[0],ue=Gy(j,It=>It.conflict_country),te=Ct[1];const fn=new Map;let Tn=1;Vr(ce,te.map(It=>{if(It.dist_mediation_conflict==="NA"||It.fatalities_best==="NA"||It.latitude_con==="NA"||It.longitude_con==="NA"||It.iso3c==="NA")return null;const dn=+It.dist_mediation_conflict,$n=+It.fatalities_best;if(!isFinite(dn)||dn<=0)return null;const Qi=It.YYYYMM.slice(0,4),vn=`${It.YYYYMM.slice(4,6)}-${Qi}`,wi=`${It.conflict_country}-${dn}`;let tr;return fn.has(wi)?tr=fn.get(wi):(tr=Tn++,fn.set(wi,tr)),{...It,distance:dn,date:vn,deaths:isFinite($n)?$n:0,id:tr}}).filter(Boolean)),console.log(xi(ce))}),UZ(["geojson.json"]).then(Ct=>{J=Ct[0]}),hF(()=>(Q=new(bw()).Map({container:xi(k),style:"mapbox://styles/sashagaribaldy/cm6ktkpxn00m901s2fo0bh1e4",projection:"naturalEarth",center:[10,10],zoom:1.2}),Q.on("load",()=>{var Ct;if(ue[0][1]&&J){const fn=SC(ue[0][1]),Tn=TC(ue[0][1]);console.log(J),Q.addSource("countries",{type:"geojson",data:J,generateId:!0});const It=(Ct=Q.getStyle().layers.find(dn=>{var $n;return dn.type==="symbol"&&(($n=dn.layout)==null?void 0:$n["text-field"])}))==null?void 0:Ct.id;Q.addLayer({id:"countries_fill",type:"fill",source:"countries",paint:{"fill-color":"steelblue","fill-opacity":.8},filter:["in","ADMIN","Afghanistan"]},It),Q.addSource("polygon",{type:"geojson",data:L}),Q.addLayer({id:"polygon",type:"fill",source:"polygon",paint:{"fill-color":"steelblue","fill-opacity":.2}}),Q.addSource("polygon3",{type:"geojson",data:V}),Q.addLayer({id:"polygon3",type:"fill",source:"polygon3",paint:{"fill-color":"steelblue","fill-opacity":.2}}),Q.addSource("curved-line",{type:"geojson",data:fn}),Q.addLayer({id:"curved-line",type:"line",source:"curved-line",paint:{"line-color":"white","line-width":1,"line-opacity":.5}}),Q.addSource("points",{type:"geojson",data:Tn}),Q.addLayer({id:"point-layer",type:"circle",source:"points",paint:{"circle-radius":["interpolate",["linear"],["get","agreements_sum"],0,0,1,5,5,10,10,20],"circle-color":"#FF5722","circle-opacity":.5,"circle-stroke-width":1,"circle-stroke-color":"#ffffff"}})}}),()=>Q.remove()));function Ae(Ct){Vr(P,Ct);let Tn=ue.find(([yr])=>yr===Ct)[1];if(!Q||!Q.isStyleLoaded())return;const It=SC(Tn),dn=TC(Tn);let $n=vy([+Tn[0].longitude_con,+Tn[0].latitude_con],1500),Qi=vy([+Tn[0].longitude_con,+Tn[0].latitude_con],5e3);const bi=Q.getSource("curved-line"),vn=Q.getSource("points"),wi=Q.getSource("polygon"),tr=Q.getSource("polygon3");bi&&vn&&wi?(Q.setFilter("countries_fill",["==","ADMIN",Ct]),bi.setData(It),vn.setData(dn),wi.setData($n),tr.setData(Qi)):console.warn("Map sources not found.")}const De=400,Qe=20;let nt=oa([]);Y0(()=>xi(y),()=>{Vr(u,Pv().domain([0,17e6]).range([80,xi(y)-20]))}),Y0(()=>xi(x),()=>{Vr(m,Pv().domain([0,12e3]).range([xi(x)-50,10]))}),Y0(()=>(xi(u),xi(m)),()=>{}),Y0(()=>(xi(ce),FZ),()=>{if(xi(ce)){const Ct=Gy(xi(ce),fn=>fn.id);Vr(nt,Ct.map(([fn,Tn])=>{const It=Tn.map(($n,Qi)=>{const bi=Qi*Qe,vn=De-+$n.fatalities_best*.015;return{x:bi,y:vn}});if(It.length<2)return null;let dn=`M ${It[0].x},${De} `;return dn+=It.map($n=>`L ${$n.x},${$n.y}`).join(" "),dn+=` L ${It.at(-1).x},${De} Z`,{id:fn,path:dn}}).filter(Boolean))}}),AO(),cF();var rt=QZ(),tt=Rl(Vm(rt),6),Be=Vm(tt);let Rt;var ut=Rl(Be,2);let Pe;var Ve=Rl(ut,2);let qe;var bt=Rl(Ve,2);let Ht;var Dt=Rl(bt,2);let Lt;var rn=Rl(Dt,2);let yn;var pi=Rl(tt,2),ti=Vm(pi);{var hn=Ct=>{var fn=KZ(),Tn=Vm(fn);ch("click",Tn,M),kb(Ct,fn)};XO(ti,Ct=>{xi(E)&&Ct(hn)})}var Nn=Rl(ti,2);lF(Nn,Ct=>Vr(k,Ct),()=>xi(k));var Pn=Rl(pi,4),Gi=Vm(Pn);JO(Gi,5,()=>xi(nt),YO,(Ct,fn,Tn,It)=>{let dn=()=>xi(fn).path;var $n=JZ();KI(()=>Ob($n,"d",dn())),kb(Ct,$n)}),KI((Ct,fn,Tn,It,dn,$n)=>{Be.disabled=!xi(r),Rt=rd(Be,1,"svelte-kbozhg",null,Rt,Ct),ut.disabled=!xi(r),Pe=rd(ut,1,"svelte-kbozhg",null,Pe,fn),Ve.disabled=!xi(r),qe=rd(Ve,1,"svelte-kbozhg",null,qe,Tn),bt.disabled=!xi(r),Ht=rd(bt,1,"svelte-kbozhg",null,Ht,It),Dt.disabled=!xi(r),Lt=rd(Dt,1,"svelte-kbozhg",null,Lt,dn),rn.disabled=!xi(r),yn=rd(rn,1,"svelte-kbozhg",null,yn,$n),Ob(Gi,"width",xi(y)),Ob(Gi,"height",xi(x))},[()=>({selected:xi(P)==="Afghanistan"}),()=>({selected:xi(P)==="Israel"}),()=>({selected:xi(P)==="Libya"}),()=>({selected:xi(P)==="Sudan"}),()=>({selected:xi(P)==="Syria"}),()=>({selected:xi(P)==="Yemen"})],kC),ch("click",Be,()=>Ae("Afghanistan")),ch("click",ut,()=>Ae("Israel")),ch("click",Ve,()=>Ae("Libya")),ch("click",bt,()=>Ae("Sudan")),ch("click",Dt,()=>Ae("Syria")),ch("click",rn,()=>Ae("Yemen")),rM(Pn,"clientWidth",Ct=>Vr(y,Ct)),rM(Pn,"clientHeight",Ct=>Vr(x,Ct)),kb(n,rt),LC()}HO(eW,{target:document.getElementById("app")});
